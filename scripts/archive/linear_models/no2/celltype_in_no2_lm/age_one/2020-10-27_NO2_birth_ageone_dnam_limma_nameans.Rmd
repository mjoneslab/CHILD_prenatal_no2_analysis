---
title: "Age one linear regression using limma with complete cases"
author: "SL"
date: "12/09/2020"
output: html_document
---

*Purpose*: The purpose of this script is to DNAm changes in year one PBMCs associated with year one air pollution exposure (proxied by no2). This script uses a subtraction method to "cancel" out effects of prenatal exposure, allowing the investigation of year one specific changes. 


Load required libraries.
```{r libraries}
library(tidyverse)
library(limma)
library(here)
```


Load covariate data
```{r covariates}
load(file=here("output_data", "covariates", "2020-11-12_CHILD_covariates_na_with_means.Rdata"))
```


Load DNAm data and pdata. Subset out cord blood samples and age one blood samples.
```{r pdata}
load(file=here("output_data", "preprocessed_data", "2020-11_10_CHILD_preprocessed_mvals_pdata_annotation.Rdata"))

#check ranges to confirm DNAm data is in m-value format
dim(mval_batchcorr)
max(mval_batchcorr)
min(mval_batchcorr)

#subset pData into CBMCs (cord blood)
#these children have data at both time points
cb_pdata <- subset(pdata_nodups, Tissue == "C")
dim(cb_pdata)

#subset out age one pdata
y1_pdata <- subset(pdata_nodups, Tissue == "P")
dim(y1_pdata)

#subset cordblood and age one DNAM samples
cb_mval_batchcorr <- mval_batchcorr[ ,colnames(mval_batchcorr) %in% rownames(cb_pdata)]
y1_mval_batchcorr <- mval_batchcorr[ ,colnames(mval_batchcorr) %in% rownames(y1_pdata)]

#subset y1_pdata
y1_pdata_sub <- y1_pdata[y1_pdata$Sample_Label %in% cb_pdata$Sample_Label, ]
identical(y1_pdata_sub$Sample_Label, cb_pdata$Sample_Label) #true

#check size for correct sample num
dim(cb_mval_batchcorr) #144
dim(y1_mval_batchcorr) #145

#change colnames of mvals to subject id
#create new column in pdata to represent sentrix id + position
cb_pdata$sentrix_id_position <- paste(cb_pdata$Sentrix_ID, cb_pdata$Sentrix_Position, sep="_")
identical(colnames(cb_mval_batchcorr), as.character(cb_pdata$sentrix_id_position)) #true
colnames(cb_mval_batchcorr) <- cb_pdata$Sample_Label

y1_pdata$sentrix_id_position <- paste(y1_pdata$Sentrix_ID, y1_pdata$Sentrix_Position, sep="_")
identical(colnames(y1_mval_batchcorr), as.character(y1_pdata$sentrix_id_position)) #true
colnames(y1_mval_batchcorr) <- y1_pdata$Sample_Label

#convert mvals to beta values 
#beta values will be used in linear regression because of substraction used on year one data (which has to be done on beta values). using the same format will make the data more comparable.
cb_beta_batchcorr <- lumi::m2beta(cb_mval_batchcorr)
y1_beta_batchcorr <- lumi::m2beta(y1_mval_batchcorr)

#check max min
max(cb_beta_batchcorr)
min(cb_beta_batchcorr)

max(y1_beta_batchcorr)
min(y1_beta_batchcorr)

#subset yr betas for cb betas
y1_beta_batchcorr_sub <- y1_beta_batchcorr[,colnames(y1_beta_batchcorr) %in% colnames(cb_beta_batchcorr)]
dim(y1_beta_batchcorr_sub)

#check if in same order
identical(colnames(y1_beta_batchcorr_sub), colnames(cb_beta_batchcorr))#true

#create difference matrix
beta_batchcorr_diff <- y1_beta_batchcorr_sub - cb_beta_batchcorr
dim(beta_batchcorr_diff) #144
min(beta_batchcorr_diff)
max(beta_batchcorr_diff)
```

Subset covariates and pdata for samples in beta_batchcorr_diff
```{r sub_covariates_pdata}
#subset covariates
covariates_sub <- covariates_nameans[as.character(covariates_nameans$sampleid) %in% colnames(beta_batchcorr_diff), ]
identical(as.character(covariates_sub$sampleid), colnames(beta_batchcorr_diff)) #true
dim(covariates_sub) #144

#subset cb_pdata
cb_pdata_sub <- cb_pdata[as.character(cb_pdata$Sample_Label) %in% colnames(beta_batchcorr_diff), ]
identical(as.character(cb_pdata_sub$Sample_Label), colnames(beta_batchcorr_diff)) #true
dim(cb_pdata_sub) #144

#subset y1_pdata
y1_pdata_sub <- y1_pdata[as.character(y1_pdata$Sample_Label) %in% colnames(beta_batchcorr_diff), ]
identical(as.character(y1_pdata_sub$Sample_Label), colnames(beta_batchcorr_diff)) #true
dim(y1_pdata_sub) #144
```


Load CBMC PCs. Combine with covariates
```{r load_PC_correctedbetas}
load(here("output_data", "deconvolution", "2020-11-10_CBMC_PBMC_PCs.Rdata"))

#check size
dim(all_pcs) #144 11

#rename columns for clarity
colnames(all_pcs) <- paste("celltype.", colnames(all_pcs), sep="")

#check that cell type pcs and covariates are in the same order
identical(as.character(covariates_sub$sampleid), rownames(all_pcs)) #true

#combine cell type pcs and covariates
covariates_ctpcs <- cbind(covariates_sub, all_pcs)
dim(covariates_ctpcs)
```


Load genotyping PCs and subset out REEGLE PCs (genotyping data contains PCs for a few thousand participants).
```{r genotypingPCS}
genotyping <- read.csv("R:/Jones/People/Samantha Lee/Computational/CHILD/input_data/CHILD_subjects_Qced_first10PCS_Duan.csv")

#make rownames sample names then rmove this row
rownames(genotyping) <- genotyping$FID
genotyping <- subset(genotyping, select=-c(FID, IID))

genosub <- genotyping[rownames(genotyping) %in% cb_pdata$Sample_Label,]
#missing genotyping data for 14 REEGLE children?

#rename columns of genotyping data for clarity
colnames(genosub) <- paste("genotyping.", colnames(genosub), sep="")

#put rows in numerical order according to sample id
genosub_order <- genosub[order(rownames(genosub)), ]
```


Subset covariates, betas, cb_pdata, and y1_pdata for samples that also have genotyping.
```{r sub_on_geno}
#subset cb_pdata
cb_pdata_geno <- cb_pdata_sub[as.character(cb_pdata_sub$Sample_Label) %in% rownames(genosub_order), ]
dim(cb_pdata_geno) #131
identical(as.character(cb_pdata_geno$Sample_Label), rownames(genosub_order)) #true

#subset y1_pdata
y1_pdata_geno <- y1_pdata_sub[as.character(y1_pdata_sub$Sample_Label) %in% rownames(genosub_order), ]
dim(y1_pdata_geno) #131
identical(as.character(y1_pdata_geno$Sample_Label), rownames(genosub_order)) #true

#subset covariates
covariates_ctpcs_sub <- covariates_ctpcs[as.character(covariates_ctpcs$sampleid) %in% rownames(genosub_order), ]
dim(covariates_ctpcs_sub) #131
identical(as.character(covariates_ctpcs_sub$sampleid), rownames(genosub_order)) #true

#combine covariates with genotyping data
covariates_ctpcs_geno <- cbind(covariates_ctpcs_sub, genosub_order)

#subset betas
beta_batchcorr_diff_geno <- beta_batchcorr_diff[,colnames(beta_batchcorr_diff) %in% rownames(genosub_order)]
dim(beta_batchcorr_diff_geno) #131
identical(colnames(beta_batchcorr_diff_geno), rownames(genosub_order)) #true
```



Linear regression using limma and complete cases
```{r limma}
#how many complete cases now?
sum(complete.cases(covariates_ctpcs_geno %>% dplyr::select(no2_y1_entire, sex, birth_month,  
                                                   maternal_smoking_y1,  
                                                   maternal_education_length, 
                                                   pss_6mos, 
                                                    celltype.PC1, celltype.PC2,
                                                    celltype.PC3, celltype.PC4, celltype.PC5,
                                                    celltype.PC6, celltype.PC7, celltype.PC8,
                                                    celltype.PC9, genotyping.PC1, genotyping.PC2,
                                                    genotyping.PC3))) #125 complete cases now


#create model matrix
diff_design <- model.matrix(~no2_y1_entire + sex + birth_month +
                              maternal_smoking_y1 + 
                              maternal_education_length +
                              pss_6mos + 
                              celltype.PC1 + celltype.PC2 + celltype.PC3 + celltype.PC4 + 
                              celltype.PC5 + celltype.PC6 + celltype.PC7 + celltype.PC8 +
                              celltype.PC9 + genotyping.PC1 + genotyping.PC2 + genotyping.PC3,
                            data=covariates_ctpcs_geno)

#check size
dim(diff_design) #125

#further subset covariates and beta values for complete cases
#subset covariates
covariates_ctpcs_geno_cc <- covariates_ctpcs_geno[complete.cases(covariates_ctpcs_geno %>% 
                                                                   dplyr::select(no2_y1_entire, sex, birth_month,
                                                                          maternal_smoking_y1,
                                                                          maternal_education_length,
                                                                          pss_6mos,
                                                                          celltype.PC1, celltype.PC2,
                                                                          celltype.PC3, celltype.PC4, celltype.PC5,
                                                                          celltype.PC6, celltype.PC7, celltype.PC8,
                                                                          celltype.PC9, genotyping.PC1, genotyping.PC2,
                                                                          genotyping.PC3)), ] 
#check size
dim(covariates_ctpcs_geno_cc) #125

#subset betas
beta_batchcorr_diff_geno_cc <- beta_batchcorr_diff_geno[,colnames(beta_batchcorr_diff_geno) %in%
                                                          covariates_ctpcs_geno_cc$sampleid]
#check size
dim(beta_batchcorr_diff_geno_cc) #125


###############
#### LIMMA ####
###############


#fit methylation to no2
diff_fit <-  lmFit(beta_batchcorr_diff_geno_cc, diff_design)
diff_ebayes <- eBayes(diff_fit)

#add annotation to cb_ebayes
diff_ebayes$annotation <- annotation[rownames(annotation) %in% rownames(diff_ebayes),]

#pull out pval, coefficients and annotation
diff_pvals <- cbind(as.data.frame(diff_ebayes$p.value), 
                  as.data.frame(diff_ebayes$coefficients),
                  as.data.frame(diff_ebayes$annotation))

#rename columns to indicate pvalues vs coefficients 
colnames(diff_pvals) <- c(paste("pval", colnames(diff_pvals)[1:29], sep = "_"), 
                         paste("coeff", colnames(diff_pvals)[30:58], sep = "_"),
                         colnames(diff_pvals)[59:91])


diff_pvals$adj_pval_no2_y1_entire <- p.adjust(diff_pvals$pval_no2_y1_entire, method="BH")
```


Examine qqplot and pvalue histogram.
```{r qqplot_pval_histo}
#qqplot
qqplot <- qplot(sample = -log10(pval_no2_y1_entire), data = diff_pvals) + 
  stat_qq(col = "#75A2D9") +
  stat_qq_line() +
  theme_bw() +
  labs(x="Expected -log10(p)", y="Observed -log10(p)") + 
  theme(panel.border = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        axis.text=element_text(size=16),
        axis.title=element_text(size=20))
        
#histogram
pval_histo <- ggplot( data =diff_pvals, aes(x=pval_no2_y1_entire)) +
  geom_histogram(bins=100, fill = "#75A2D9") +
  labs(y="Count", x="Unadjusted p-value") +
  theme_bw() +
  theme(panel.border = element_blank(),
        axis.text=element_text(size=18),
        axis.title=element_text(size=20))


qqplot
pval_histo

```





Volcano plot
```{r volcano}
#make new column called probe name for labelling
diff_pvals$probe_name <- rownames(diff_pvals)



volcano <- ggplot(diff_pvals, aes(x=coeff_no2_y1_entire, y=-log10(pval_no2_y1_entire))) +
  geom_point(alpha=0.8, col = "#75A2D9", size=2) +
  geom_point(data=subset(diff_pvals, (pval_no2_y1_entire < 0.05 & coeff_no2_y1_entire > 0.01) | 
                          (pval_no2_y1_entire < 0.05 & coeff_no2_y1_entire < -0.01)), 
    alpha=0.8, col = "red") + 
  geom_vline(xintercept = c(0.01, -0.01), linetype = "dashed") +
  geom_hline(yintercept = -log10(0.05), linetype="dashed") + 
  theme_bw() +
  theme(panel.border = element_blank(),
        axis.text=element_text(size=18),
        axis.title=element_text(size=20)) +
  labs(y="-log10(unadjusted p-value)", x = "% Methylation change") +
  scale_x_continuous(breaks = c(-0.01, -0.005, 0 , 0.005, 0.01), labels = c("-1.0", "-0.5", "0", "-0.5", "1.0")) +
  ggrepel::geom_text_repel(data=subset(diff_pvals, (pval_no2_y1_entire < 0.05 & coeff_no2_y1_entire > 0.01) | 
                                (pval_no2_y1_entire < 0.05 & coeff_no2_y1_entire < -0.01)),
                  aes(x=coeff_no2_y1_entire, y=-log10(pval_no2_y1_entire), 
                      label = probe_name),
                  point.padding = 1) 

volcano


```