---
title: "Covariate correlations between age one cell type proportions"
author: "SL"
date: "11/06/2020"
output: html_document
---

Read libraries in.
```{r libraries, warnings=FALSE, message=FALSE}
library(tidyverse)
library(plyr)
library(pheatmap)
library(ggpubr)
library(here)
```

Load in CHILD covariate data.
```{r covariates}
load(here("output_data", "covariates", "2020-11-03_CHILD_all_covariates.Rdata"))
```

Read in cell type estimates.  
```{r load_deconvolution}
load(file=here("output_data", "deconvolution", "2020-11-10_CBMC_PBMC_deconvolution.Rdata"))
```

Load pData.  
```{r load_pData}
#this pdata has bad samples removed and sample mix-up corrected
load(file = here("output_data", "preprocessed_data", "2020-11_10_CHILD_preprocessed_mvals_pdata_annotation.Rdata"))

#subset pData into PBMCs (year 1)
y1_pdata <- subset(pdata_nodups, Tissue == "P")
dim(y1_pdata)
```


Read in genotyping PCS
```{r genotyping}
genotyping <- read.csv("R:/Jones/People/Samantha Lee/Computational/CHILD/input_data/CHILD_subjects_Qced_first10PCS_Duan.csv")

#make rownames sample names then rmove this row
rownames(genotyping) <- genotyping$FID
genotyping <- subset(genotyping, select=-c(FID))

#subset genotyping for REEGLE children
genosub <- genotyping[rownames(genotyping) %in% covariates$sampleid,]

#rename columns of genotyping data for clarity
colnames(genosub) <- paste("genotyping.", colnames(genosub), sep="")
```


Convert deconvolution estimates to dataframes.
```{r convert_deconvo_to_df}
#convert to dataframe
child_fscbc_ecc2_y1_df <- as.data.frame(child_fscbc_ecc2_y1$counts)

#check if rownames in same order
identical(rownames(child_fscbc_ecc2_y1_df), rownames(y1_pdata))
#YES

#reformat rownames to be in sample id format (5 digits)
rownames(child_fscbc_ecc2_y1_df) <- y1_pdata$Sample_Label
rownames(child_fscbc_ecc2_y1_df)
```

Subset covariate data for year one. Then combined with cell type estimates and genotyping data.
```{r subset_covariates_y1}
#subset covariate data according to age and then combined with predicted cell proportions
covariates_y1 <- covariates[as.character(covariates$sampleid) %in% as.character(y1_pdata$Sample_Label),]
dim(covariates_y1) #145 113

#combine covaraite master data and cell estimates 
#check if they are identical 
identical(as.character(covariates_y1$sampleid), rownames(child_fscbc_ecc2_y1_df)) #true
covariates_y1 <- cbind(covariates_y1, child_fscbc_ecc2_y1_df)

#combine covariate data with genotyping data
rownames(covariates_y1)  <- covariates_y1$sampleid
covariates_y1 <- merge(covariates_y1, genosub[,2:4], by = "row.names", all.x = TRUE)
```


## Check PBMC distributions.

Are cell types normally distributed?
```{r cbmc_distribution}
#cd4t
ggplot(covariates_y1, aes(x=CD4T)) + 
  geom_histogram() +
  theme_bw() +
  theme(panel.border=element_blank())

shapiro.test(covariates_y1$CD4T)


#cd8t
ggplot(covariates_y1, aes(x=CD8T)) + 
  geom_histogram() +
  theme_bw() +
  theme(panel.border=element_blank())

shapiro.test(covariates_y1$CD8T)

#bcell
ggplot(covariates_y1, aes(x=Bcell)) + 
  geom_histogram() +
  theme_bw() +
  theme(panel.border=element_blank())

shapiro.test(covariates_y1$Bcell)


#are monocytes normally distribyted
ggplot(covariates_y1, aes(x=Mono)) + 
  geom_histogram() +
  theme_bw() +
  theme(panel.border=element_blank())

shapiro.test(covariates_y1$Mono)

#NK
ggplot(covariates_y1, aes(x=NK)) + 
  geom_histogram() +
  theme_bw() +
  theme(panel.border=element_blank())

shapiro.test(covariates_y1$NK)
```




## Correlation heatmap between all covariates and cell types 

### Create heatmap of cell types vs covariates.

Load covariate correlation matrix code.

```{r calc_correlations_function}

cor2 = function(df){
  
  print("checking dataframe clases")
  stopifnot(inherits(df, "data.frame"))
  stopifnot(sapply(df, class) %in% c("integer"
                                     , "numeric"
                                     , "factor"
                                     , "character"))
  
  print("calculating correlation matrix")
  cor_fun <- function(pos_1, pos_2){

    # both are numeric
    if(class(df[[pos_1]]) %in% c("integer", "numeric") &&
       class(df[[pos_2]]) %in% c("integer", "numeric")){
      print("both are numeric")
      print(paste(colnames(df)[[pos_1]], colnames(df)[[pos_2]]))
      r <- stats::cor(df[[pos_1]], df[[pos_2]], use = "pairwise.complete.obs") #pairwise.complete.obs
      p <- unname((summary(lm(df[[pos_1]] ~ df[[pos_2]]))$coefficients[,4])[2])

    }
    
    #one is numberic the other is factor/character
    #must use sum of squares type 3 because groups are not of the same size
    #calculates ANOVA
    #then calcualtes eta-squared: measures the proportion of the total variance in a      dependent variable that
    #is associated with the membership of different groups defined by an independent      variable.
    #takes square root to get correlation
    if(class(df[[pos_1]]) %in% c("integer", "numeric") &&
       class(df[[pos_2]]) %in% c("factor", "character")){
      
      #print statements for debugging
      print("first is numeric, second is factor")
      print(paste(colnames(df)[[pos_1]], colnames(df)[[pos_2]]))
      
      #check factor levels of complete cases
      print("checking levels of pos_2 factor")
      tmp <- data.frame(df[[pos_1]], df[[pos_2]], row.names = NULL)
      complete <- complete.cases(tmp)
      tmp2 <- tmp[complete,]
      tmp2[,2] <- as.factor(tmp2[,2])
      
      #if statement to catch cases where dropped values result in a factor with
      #one or fewer levels
      if(is.factor(tmp2[,2]) & (nlevels(droplevels(tmp2[,2]))<2)){
        r <- 999
      } else {
        #anova for correlation
        r <- stats::aov(df[[pos_1]] ~ as.factor(df[[pos_2]])) %>%
          lsr::etaSquared(type=3) %>% `[`(1) %>% sqrt()
        
        #anova for p-pval
        lm_p <- lm(df[[pos_1]] ~ as.factor(df[[pos_2]]))
        p <- (anova(lm_p))$`Pr(>F)`[1]
        
      }
      rm(tmp,tmp2)
    }
    
    
    
    if(class(df[[pos_2]]) %in% c("integer", "numeric") &&
       class(df[[pos_1]]) %in% c("factor", "character")){
      
      #print statements for debugging
      print("first is factor, second is numeric")
      print(paste(colnames(df)[[pos_1]], colnames(df)[[pos_2]]))
      
      #check factor levels of complete cases
      print("checking levels of pos_1 factor")
      tmp <- data.frame(df[[pos_1]], df[[pos_2]], row.names = NULL)
      complete <- complete.cases(tmp)
      tmp2 <- tmp[complete,]
      tmp2[,1] <- as.factor(tmp2[,1])
      
      #if statement to catch cases where dropped values result in a factor with
      #one or fewer levels
      if(is.factor(tmp2[,1]) && (nlevels(droplevels(tmp2[,1]))<2)){
        r <- 999
      } else {
        r <- stats::aov(df[[pos_2]] ~ as.factor(df[[pos_1]])) %>%
          lsr::etaSquared(type=3) %>% `[`(1) %>% sqrt()
        
        #anova for p-pval
        lm_p <- lm(df[[pos_2]] ~ as.factor(df[[pos_1]]))
        p <- (anova(lm_p))$`Pr(>F)`[1]
        
      }
      rm(tmp,tmp2)
    }
    
    
  
    #both are factor/character
    if(class(df[[pos_1]]) %in% c("factor", "character") &&
       class(df[[pos_2]]) %in% c("factor", "character")){
      
      #print statement for debugging
      print("both are characters")
      print(paste(colnames(df)[[pos_1]], colnames(df)[[pos_2]]))
      
       #check factor levels of complete cases
      print("checking levels of of both positions")
      tmp <- data.frame(df[[pos_1]], df[[pos_2]], row.names = NULL)
      complete <- complete.cases(tmp)
      tmp2 <- tmp[complete,]
      tmp2[,1] <- as.factor(tmp2[,1])
      tmp2[,2] <- as.factor(tmp2[,2])
      
      #if statement to catch cases where dropped values result in a factor with
      #one or fewer levels
      if(is.factor(tmp2[,1]) && (nlevels(droplevels(tmp2[,1]))<2)){
        r <- 999
      } else {
        if(is.factor(tmp2[,2]) && (nlevels(droplevels(tmp2[,2]))<2)){
          r <-999
        } else { 
          r <- lsr::cramersV(df[[pos_1]], df[[pos_2]], simulate.p.value = TRUE)
          #get p value
          fish_table <- table(df[[pos_1]], df[[pos_2]])
          p <- fisher.test(fish_table, simulate.p.value=T)$p.value
        }
      }
      rm(tmp,tmp2)
    }
    
    return(r)
  } 
  
  cor_fun <- Vectorize(cor_fun)
  
  # now compute corr matrix
  corrmat <- outer(1:ncol(df)
                   , 1:ncol(df)
                   , function(x, y) cor_fun(x, y)
  )
  
  rownames(corrmat) <- colnames(df)
  colnames(corrmat) <- colnames(df)
  return(corrmat)
}

```

Function to calculate pvalues
```{r pval2}

pval2 = function(df){
  
  print("checking dataframe clases")
  stopifnot(inherits(df, "data.frame"))
  stopifnot(sapply(df, class) %in% c("integer"
                                     , "numeric"
                                     , "factor"
                                     , "character"))
  
  print("calculating correlation matrix")
  pval_fun <- function(pos_1, pos_2){
    
    # both are numeric
    if(class(df[[pos_1]]) %in% c("integer", "numeric") &&
       class(df[[pos_2]]) %in% c("integer", "numeric")){
        
      print("both are numeric")
      
      if(colnames(df)[[pos_1]] == colnames(df)[[pos_2]]){
        #dont want to star comparisons of something against itsself
        p <- 1
      } else {
        print(paste(colnames(df)[[pos_1]], colnames(df)[[pos_2]]))
        p <- unname((summary(lm(df[[pos_1]] ~ df[[pos_2]]))$coefficients[,4])[2])
      }
    }
  
    
    #one is numberic the other is factor/character
    if(class(df[[pos_1]]) %in% c("integer", "numeric") &&
       class(df[[pos_2]]) %in% c("factor", "character")){
      
      #print statements for debugging
      print("first is numeric, second is factor")
      print(paste(colnames(df)[[pos_1]], colnames(df)[[pos_2]]))
      
      #check factor levels of complete cases
      print("checking levels of pos_2 factor")
      tmp <- data.frame(df[[pos_1]], df[[pos_2]], row.names = NULL)
      complete <- complete.cases(tmp)
      tmp2 <- tmp[complete,]
      tmp2[,2] <- as.factor(tmp2[,2])
      
      #if statement to catch cases where dropped values result in a factor with
      #one or fewer levels
      if(is.factor(tmp2[,2]) & (nlevels(droplevels(tmp2[,2]))<2)){
        p <- 999
      } else {
       if(nlevels(droplevels(tmp2[,2]))>2){
          #anova for p-pval with 3 or  more factors
          lm_p <- lm(df[[pos_1]] ~ as.factor(df[[pos_2]]))
          p <- (anova(lm_p))$`Pr(>F)`[1]
        } else{
          #ttest for 2 factors
          p <- t.test(df[[pos_1]] ~ as.factor(df[[pos_2]]),
                  alternative = "two.sided")$p.value
        }
      }
      rm(tmp,tmp2)
    }
    
    
    
    if(class(df[[pos_2]]) %in% c("integer", "numeric") &&
       class(df[[pos_1]]) %in% c("factor", "character")){
      
      #print statements for debugging
      print("first is factor, second is numeric")
      print(paste(colnames(df)[[pos_1]], colnames(df)[[pos_2]]))
      
      #check factor levels of complete cases
      print("checking levels of pos_1 factor")
      tmp <- data.frame(df[[pos_1]], df[[pos_2]], row.names = NULL)
      complete <- complete.cases(tmp)
      tmp2 <- tmp[complete,]
      tmp2[,1] <- as.factor(tmp2[,1])
      
      #if statement to catch cases where dropped values result in a factor with
      #one or fewer levels
      if(is.factor(tmp2[,1]) && (nlevels(droplevels(tmp2[,1]))<2)){
        p <- 999
      } else {
        if(nlevels(droplevels(tmp2[,1]))>2){
          #anova for p-pval with 3 or  more factors
          lm_p <- lm(df[[pos_2]] ~ as.factor(df[[pos_1]]))
          p <- (anova(lm_p))$`Pr(>F)`[1]
        } else{
          #ttest for 2 factors
          p <- t.test(df[[pos_2]] ~ as.factor(df[[pos_1]]),
                  alternative = "two.sided")$p.value
        }
      }
      rm(tmp,tmp2)
    }
    
    
  
    #both are factor/character
    if(class(df[[pos_1]]) %in% c("factor", "character") &&
       class(df[[pos_2]]) %in% c("factor", "character")){
      
      #print statement for debugging
      print("both are characters")
      print(paste(colnames(df)[[pos_1]], colnames(df)[[pos_2]]))
      
       #check factor levels of complete cases
      print("checking levels of of both positions")
      tmp <- data.frame(df[[pos_1]], df[[pos_2]], row.names = NULL)
      complete <- complete.cases(tmp)
      tmp2 <- tmp[complete,]
      tmp2[,1] <- as.factor(tmp2[,1])
      tmp2[,2] <- as.factor(tmp2[,2])
      
      
      #if statement to catch cases where dropped values result in a factor with
      #one or fewer levels
      if(is.factor(tmp2[,1]) && (nlevels(droplevels(tmp2[,1]))<2)){
        p <- 999
      } else {
        if(is.factor(tmp2[,2]) && (nlevels(droplevels(tmp2[,2]))<2)){
          p <- 999
        } else {
          if(( na.omit(as.character(tmp[,1])) == na.omit(as.character(tmp[,2])))) {
            p = 1
          } else {
          #get p value
          fish_table <- table(df[[pos_1]], df[[pos_2]])
          p <- fisher.test(fish_table, simulate.p.value = T)$p.value
          }
        }
      }
      rm(tmp,tmp2)
    }
    
    return(p)
  } 
  
  pval_fun <- Vectorize(pval_fun)
  
  # now compute corr matrix
  pvalmat <- outer(1:ncol(df)
                   , 1:ncol(df)
                   , function(x, y) pval_fun(x, y)
  )
  
  rownames(pvalmat) <- colnames(df)
  colnames(pvalmat) <- colnames(df)
  return(pvalmat)
}


```


Get pvalues for correlations on a subset of covariates of interest.
```{r get-pvals}
#subset y1 covariates to those of interest
covariates_y1_sub <- subset(covariates_y1, select=c(CD4T,  CD8T, Bcell, Mono, NK,
                                                    sex, 
                                                    no2_y1_entire,  PM25DALYY_01, PM25DALbYY_01,
                                                    pss_6mos, pss_12mos,
                                                    csed_6mos, csed_12mos,
                                                    maternal_education_length, paternal_education_length,
                                                    ses_community_rank, ses_canada_rank, total_income,
                                                    clinician_asthma_dx_5y,
                                                    maternal_asthma,  maternal_smoking_y1,
                                                    genotyping.PC1, genotyping.PC2, genotyping.PC3,
                                                    studycentre))

#set missing values ot na
covariates_y1_sub$PM25DALYY_01  <- ifelse(covariates_y1_sub$PM25DALYY_01 < 0, NA, covariates_y1_sub$PM25DALYY_01)

#correlation calcs
covariates_y1_pval <- pval2(covariates_y1_sub)

#make the matrix a dataframe
covariates_y1_pval <- as.data.frame(covariates_y1_pval)

#function to get lower triangle of the correlation matrix
get_lower_tri<-function(cormat){
    cormat[upper.tri(cormat)] <- NA
    return(cormat)
  }

#get the upper triangle of the covariate correlation matrix
lower_tri_pval <- get_lower_tri(covariates_y1_pval)

#make a new column for covariate names - this is needed for putting data in long format
lower_tri_pval$covariates1 <- rownames(lower_tri_pval)

#melt the matrix to long format
melted_pmat <- reshape2::melt(lower_tri_pval, 
                                na.rm = TRUE,
                                id.vars="covariates1",
                                variable.name="covariates2",
                              value.name="pval")

#set covariates as a factor and put in desired order
melted_pmat$covariates1 <- as.factor(melted_pmat$covariates1)
melted_pmat$covariates1 <- factor(melted_pmat$covariates1,
                                  levels=c("CD4T",  "CD8T", "Bcell", "Mono", "NK",
                                           "sex",  
                                           "no2_y1_entire",  "PM25DALYY_01", "PM25DALbYY_01",
                                           "pss_6mos", "pss_12mos",
                                           "csed_6mos", "csed_12mos",
                                           "maternal_education_length", "paternal_education_length",
                                           "ses_community_rank", "ses_canada_rank", "total_income",
                                           "clinician_asthma_dx_5y",
                                           "maternal_asthma",  "maternal_smoking_y1",
                                           "genotyping.PC1", "genotyping.PC2", "genotyping.PC3",
                                           "studycentre"))

#set covariates as a factor and put in desired order
melted_pmat$covariates2 <- as.factor(melted_pmat$covariates2)
melted_pmat$covariates2 <- factor(melted_pmat$covariates2,
                                  levels=c("CD4T",  "CD8T", "Bcell", "Mono", "NK",
                                           "sex", 
                                           "no2_y1_entire",  "PM25DALYY_01", "PM25DALbYY_01",
                                           "pss_6mos", "pss_12mos",
                                           "csed_6mos", "csed_12mos",
                                           "maternal_education_length", "paternal_education_length",
                                           "ses_community_rank", "ses_canada_rank", "total_income",
                                           "clinician_asthma_dx_5y",
                                           "maternal_asthma", "maternal_smoking_y1",
                                           "genotyping.PC1", "genotyping.PC2", "genotyping.PC3",
                                           "studycentre"))

#add star annotation for significant p values
melted_pmat$pstars <- ifelse(melted_pmat$pval < 0.05, "*", " ")

```


Calculate correlations between metadata variables using cor2 function above.  
```{r calc_covariate_corr}
#correlation calcs
covariates_y1_sub_corr <- cor2(covariates_y1_sub)
  
#set missing values (999) to NA - could have probably done this in the cor2 function
covariates_y1_sub_corr[covariates_y1_sub_corr == 999] <- NA
#make the matrix a dataframe
covariates_y1_sub_corr <- as.data.frame(covariates_y1_sub_corr)

#get the upper triangle of the covariate correlation matrix
lower_tri <- get_lower_tri(covariates_y1_sub_corr)

#make a new column for covariate names - this is needed for putting data in long format
lower_tri$covariates1 <- rownames(lower_tri)

#melt the matrix to long format
melted_cormat <- reshape2::melt(lower_tri, 
                                na.rm = TRUE,
                                id.vars="covariates1",
                                variable.name="covariates2",
                                value.name="correlation")

#set covariates to factor and put in desired order
melted_cormat$covariates1 <- as.factor(melted_cormat$covariates1)
melted_cormat$covariates1 <- factor(melted_cormat$covariates1,
                                    levels=c("CD4T",  "CD8T", "Bcell", "Mono", "NK",
                                           "sex",  
                                           "no2_y1_entire",  "PM25DALYY_01", "PM25DALbYY_01",
                                           "pss_6mos", "pss_12mos",
                                           "csed_6mos", "csed_12mos",
                                           "maternal_education_length", "paternal_education_length",
                                           "ses_community_rank", "ses_canada_rank", "total_income",
                                           "clinician_asthma_dx_5y",
                                           "maternal_asthma", "maternal_smoking_y1", 
                                           "genotyping.PC1", "genotyping.PC2", "genotyping.PC3",
                                           "studycentre"))

#set covariates to factor and put in desired order
melted_cormat$covariates2 <- as.factor(melted_cormat$covariates2)
melted_cormat$covariates2 <- factor(melted_cormat$covariates2,
                                    levels=c("CD4T",  "CD8T", "Bcell", "Mono", "NK",
                                           "sex", 
                                           "no2_y1_entire",  "PM25DALYY_01", "PM25DALbYY_01",
                                           "pss_6mos", "pss_12mos",
                                           "csed_6mos", "csed_12mos",
                                           "maternal_education_length", "paternal_education_length",
                                           "ses_community_rank", "ses_canada_rank", "total_income",
                                           "clinician_asthma_dx_5y",
                                           "maternal_asthma", "maternal_smoking_y1",
                                           "genotyping.PC1", "genotyping.PC2", "genotyping.PC3",
                                           "studycentre"))

#add pstar labels to melted cormat
melted_cormat$pstars <- melted_pmat$pstars

#custom breaks for heatmap colour scale  
breaksList = seq(-1, 1, by = 0.1)

#create heatmap with custom colours using ggplot and geom_tile
ggplot(data = melted_cormat, aes(x = covariates1, y = covariates2, fill = correlation)) +
  geom_tile() +
  geom_text(aes(label=pstars), col="grey40", nudge_y = -0.4, size=8) +
  scale_fill_gradient2(low = "blue", mid = "white", high = "red", midpoint = 0, 
                       space = "Lab", 
                       na.value = "grey50",
                       #guide = "colourbar",
                       aesthetics = "fill",
                       breaks = breaksList,
                       guide = guide_legend(keywidth=0.5, keyheight=0.5, 
                                            reverse=TRUE, label.position = "left")) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust=1, vjust=0.1, size =10),
        axis.text.y = element_text(size=10),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        panel.border = element_blank(),
        panel.grid = element_blank(),
        legend.position = "left") +
  scale_x_discrete(labels=c("CD4T",  "CD8T", "Bcell", "Mono", "NK",
                            "Sex",  
                            "Year one NO2",  "PM2.5 A", "PM2.5 B",
                            "Maternal stress 6 months", "Maternal stress 12 months",
                            "Maternal depression 6 months", "Maternal depression 12months",
                            "Maternal education length", "Paternal education length",
                            "SES community rank", "SES Canada rank", "Total income",
                            "Asthma diagnosis age 5",
                            "Maternal asthma", "Year one maternal smoking",
                            "Genotyping PC1", "Genotyping PC2", "Genotyping PC3",
                            "Study centre")) +
  scale_y_discrete(position = "right", 
                   labels=c("CD4T",  "CD8T", "Bcell", "Mono", "NK",
                            "Sex",  
                            "Year one NO2",  "PM2.5 A", "PM2.5 B",
                            "Maternal stress 6 months", "Maternal stress 12 months",
                            "Maternal depression 6 months", "Maternal depression 12months",
                            "Maternal education length", "Paternal education length",
                            "SES community rank", "SES Canada rank", "Total income",
                            "Asthma diagnosis age 5",
                            "Maternal asthma", "Year one maternal smoking",
                            "Genotyping PC1", "Genotyping PC2", "Genotyping PC3",
                            "Study centre")) +


ggsave("2020-11-12_CHILD_ageone_covariate_heatplot.png",
       device="png",
       path=here("figures"),
       width=8,
       height=6,
       units="in")
```


























## Linear regressions of covariates on cell type proportions at birth

Predict PBMC cell types on no2yr1_birth
```{r pmbc_celltypes_no2yr1_birth}

#cd4t cells
ggplot(covariates_y1, aes(x=no2_preg_entire, y=CD4T)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Prenatal no2 ") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

#cd8t cells
ggplot(covariates_y1, aes(x=no2_preg_entire, y=CD8T*100)) +
  geom_point(col="#75A2D9", size=3, alpha=0.7) +
  geom_smooth(method='lm', se=FALSE, col="black") +
  stat_cor(method = "pearson", size=8, label.y = 38) +
  labs(x="Average prenatal NO2 exposure (ug/m3)", y="% CD8T") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank(),
        axis.text=element_text(size=18))

#mononuclear cells
ggplot(covariates_y1, aes(x=no2_preg_entire, y=Mono)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson",  size=10) +
  labs(x="Prenatal no2 ") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

#Bcells
ggplot(covariates_y1, aes(x=no2_preg_entire, y=Bcell)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson",  size=10) +
  labs(x="Prenatal no2 ") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

#natural killer cells
ggplot(covariates_y1, aes(x=no2_preg_entire, y=NK)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson",  size=10) +
  labs(x="Prenatal no2 ") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())
```

### Year one NO2

Predict PBMC cell types on year one NO2
```{r pmbc.celltypes.no2yr1_adj}

#cd4t cells
ggplot(covariates_y1, aes(x=no2_y1_entire, y=CD4T)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Year one no2") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

#cd8t cells
ggplot(covariates_y1, aes(x=no2_y1_entire, y=CD8T*100)) +
  geom_point(col="#75A2D9", size=3, alpha=0.7) +
  geom_smooth(method='lm', se=FALSE, col="black") +
  stat_cor(method = "pearson", size=8, label.y = 38) +
  labs(x="Average year one NO2 exposure (ug/m3)", y="% CD8T") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank(),
        axis.text=element_text(size=18))


#mononuclear cells
ggplot(covariates_y1, aes(x=no2_y1_entire, y=Mono*100)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE, col="#75A2D9") +
  stat_cor(method = "pearson", size=8) +
  labs(y="Monocytes (%)", x=bquote('Average year one'~ NO[2] ~(μg/m^3)))+
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

#Bcells
ggplot(covariates_y1, aes(x=no2_y1_entire, y=Bcell*100)) +
  geom_point(col="#75A2D9", size=3, alpha=0.7) +
  geom_smooth(method='lm', se=FALSE, col="black") +
  stat_cor(method = "pearson", size=8, label.y = 55) +
  labs(x="Average year one NO2 exposure (ug/m3)", y="% Bcell") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank(),
        axis.text=element_text(size=18))

#natural killer cells
ggplot(covariates_y1, aes(x=no2_y1_entire, y=NK)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Year one no2") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())
```


Predict PBMC cell types on PM2.5B
```{r pmbc_pm2.5b}

#cd4t cells
ggplot(covariates_y1, aes(x=PM25DALbYY_01, y=CD4T)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Year one no2") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

#cd8t cells
ggplot(covariates_y1, aes(x=PM25DALbYY_01, y=CD8T*100)) +
  geom_point(col="#75A2D9", size=3, alpha=0.7) +
  geom_smooth(method='lm', se=FALSE, col="black") +
  stat_cor(method = "pearson", size=8, label.y = 38) +
  labs(x="Average year one NO2 exposure (ug/m3)", y="% CD8T") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank(),
        axis.text=element_text(size=18))


#mononuclear cells
ggplot(covariates_y1, aes(x=PM25DALbYY_01, y=Mono*100)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE, col="#75A2D9") +
  stat_cor(method = "pearson", size=8) +
  labs(y="Monocytes (%)", x=bquote('Average year one'~ NO[2] ~(μg/m^3)))+
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

#Bcells
ggplot(covariates_y1, aes(x=PM25DALbYY_01, y=Bcell*100)) +
  geom_point(col="#75A2D9", size=3, alpha=0.7) +
  geom_smooth(method='lm', se=FALSE, col="black") +
  stat_cor(method = "pearson", size=8, label.y = 55) +
  labs(x="Three year PM2.5 A exposure (ug/m3)", y="% Bcell") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank(),
        axis.text=element_text(size=18))

#natural killer cells
ggplot(covariates_y1, aes(x=PM25DALbYY_01, y=NK)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Year one no2") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())
```

PBMC vs PM2.5 A
```{r pmbc_pm2.5a}

#cd4t cells
ggplot(covariates_y1, aes(x=PM25DALYY_01, y=CD4T)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Year one no2") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

#cd8t cells
ggplot(covariates_y1, aes(x=PM25DALYY_01, y=CD8T*100)) +
  geom_point(col="#75A2D9", size=3, alpha=0.7) +
  geom_smooth(method='lm', se=FALSE, col="black") +
  stat_cor(method = "pearson", size=8, label.y = 38) +
  labs(x="Average year one NO2 exposure (ug/m3)", y="% CD8T") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank(),
        axis.text=element_text(size=18))


#mononuclear cells
ggplot(covariates_y1 %>% subset(PM25DALYY_01 >= 0), aes(x=PM25DALYY_01, y=Mono*100)) +
  geom_point(col="#75A2D9", size=3, alpha=0.7) +
  geom_smooth(method='lm', se=FALSE, col="black") +
  stat_cor(method = "pearson", size=8, label.y = 38) +
  labs(x="Average PM2.5 A exposure (ug/m3)", y="% Monocytes") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank(),
        axis.text=element_text(size=18))


#Bcells
ggplot(covariates_y1 %>% subset(PM25DALYY_01 > -1), aes(x=PM25DALYY_01, y=Bcell*100)) +
  geom_point(col="#75A2D9", size=3, alpha=0.7) +
  geom_smooth(method='lm', se=FALSE, col="black") +
  stat_cor(method = "pearson", size=8, label.y = 50) +
  labs(x="Three year PM2.5 A exposure (ug/m3)", y="% Bcell") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank(),
        axis.text=element_text(size=18))

#natural killer cells
ggplot(covariates_y1, aes(x=PM25DALYY_01, y=NK)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Year one no2") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())
```




Predict age one PBMC cell types based on sex  
```{r pbmc.celltypes.sex}

#cd4t cells
ggplot(covariates_y1 %>% select(CD4T, sex) %>% na.omit(), aes(x=sex, y=CD4T)) +
  geom_point() +
  labs(x="Sex") +
  scale_x_discrete(labels=c("Female", "Male")) + 
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank()) +
    geom_signif(comparisons = list(c("F", "M")), 
              map_signif_level=F, col="black", 
              annotation = c("t = -0.58283, p = 0.5611"),
              textsize = 5)

ttest.sexcd4t <- t.test(covariates_y1 %>% subset(sex=="F") %>% select(CD4T), 
                  covariates_y1 %>% subset(sex=="M") %>% select(CD4T),
                  paired=FALSE,
                  alternative = "two.sided")

ttest.sexcd4t



#cd8t cells
ggplot(covariates_y1 %>% select(CD8T, sex) %>% na.omit(), aes(x=sex, y=CD8T)) +
  geom_point() +
  labs(x="Sex") +
  scale_x_discrete(labels=c("Female", "Male")) +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank()) +
    geom_signif(comparisons = list(c("F", "M")), 
              map_signif_level=F, col="black", 
              annotation = c("t = -0.43427, p-value = 0.6648"),
              textsize = 5)


ttest.sexcd8t <- t.test(covariates_y1 %>% subset(sex=="F") %>% select(CD8T), 
                  covariates_y1 %>% subset(sex=="M") %>% select(CD8T),
                  paired=FALSE,
                  alternative = "two.sided")

ttest.sexcd8t


#mononuclear cells
ggplot(covariates_y1 %>% select(Mono, sex) %>% na.omit(), aes(x=sex, y=Mono)) +
  geom_point() +
  labs(x="Sex") +
  scale_x_discrete(labels=c("Female", "Male")) +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())+
    geom_signif(comparisons = list(c("F", "M")), 
              map_signif_level=F, col="black", 
              annotation = c("t = 0.39084, p-value = 0.6966"),
              textsize = 5)


ttest.sexmono <- t.test(covariates_y1 %>% subset(sex=="F") %>% select(Mono), 
                  covariates_y1 %>% subset(sex=="M") %>% select(Mono),
                  paired=FALSE,
                  alternative = "two.sided")

ttest.sexmono


#Bcells
ggplot(covariates_y1 %>% select(Bcell, sex) %>% na.omit(), aes(x=sex, y=Bcell)) +
  geom_point() +
  labs(x="Sex") +
  scale_x_discrete(labels=c("Female", "Male")) + 
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())+
    geom_signif(comparisons = list(c("F", "M")), 
              map_signif_level=F, col="black", 
              annotation = c("t = 0.38179, p-value = 0.7032"),
              textsize = 5)


ttest.sexbcell <- t.test(covariates_y1 %>% subset(sex=="F") %>% select(Bcell), 
                  covariates_y1 %>% subset(sex=="M") %>% select(Bcell),
                  paired=FALSE,
                  alternative = "two.sided")

ttest.sexbcell


#natural killer cells
ggplot(covariates_y1 %>% select(NK, sex) %>% na.omit(), aes(x=sex, y=NK)) +
  geom_point() +
  labs(x="Sex") +
  scale_x_discrete(labels=c("Female", "Male")) + 
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())+
    geom_signif(comparisons = list(c("F", "M")), 
              map_signif_level=F, col="black", 
              annotation = c("t = 0.73615, p-value = 0.4631"),
              textsize = 5)


ttest.sexnk <- t.test(covariates_y1 %>% subset(sex=="F") %>% select(NK), 
                  covariates_y1 %>% subset(sex=="M") %>% select(NK),
                  paired=FALSE,
                  alternative = "two.sided")

ttest.sexnk
```


Predict PBMC cell types based on method of delivery.  
```{r pbmc.celltypes.mod}

#cd4t cells
ggplot(covariates_y1 %>% select(mod_cv, CD4T) %>% na.omit(), aes(x=mod_cv, y=CD4T)) +
  geom_point() +
  labs(x="Method of delivery") +
  #scale_x_discrete(labels=c("Caesarean", "Vaginal")) +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank()) +
    geom_signif(comparisons = list(c("caesarean", "vaginal")), 
              map_signif_level=F, col="black", 
              annotation = c("t = 1.2308, p-value = 0.222"), 
              textsize = 5)


modcd4t <- t.test(covariates_y1 %>% subset(mod_cv=="caesarean") %>% select(CD4T), 
                  covariates_y1 %>% subset(mod_cv=="vaginal") %>% select(CD4T),
                  paired=FALSE,
                  alternative = "two.sided")

modcd4t



#cd8t cells
ggplot(covariates_y1 %>% select(mod_cv, CD8T) %>% na.omit(), aes(x=mod_cv, y=CD8T)) +
  geom_point() +
  labs(x="Method of delivery") +
  #scale_x_discrete(labels=c("Caesarean", "Vaginal")) +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank()) +
    geom_signif(comparisons = list(c("caesarean", "vaginal")), 
              map_signif_level=F, col="black", 
              annotation = c("t = -3.8832, p-value = 0.000184"),
               textsize = 5)


modcd8t <- t.test(covariates_y1 %>% subset(mod_cv=="caesarean") %>% select(CD8T), 
                  covariates_y1 %>% subset(mod_cv=="vaginal") %>% select(CD8T),
                  paired=FALSE,
                  alternative = "two.sided")

modcd8t


#mononuclear cells
ggplot(covariates_y1 %>% select(mod_cv, Mono) %>% na.omit(), aes(x=mod_cv, y=Mono)) +
  geom_point() +
  labs(x="Method of delivery") +
  #scale_x_discrete(labels=c("Caesarean", "Vaginal")) +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank()) +
    geom_signif(comparisons = list(c("caesarean", "vaginal")), 
              map_signif_level=F, col="black", 
              annotation = c("t = 0.87844, p-value = 0.3826"),
               textsize = 5)


modmono <- t.test(covariates_y1 %>% subset(mod_cv=="caesarean") %>% select(Mono), 
                  covariates_y1 %>% subset(mod_cv=="vaginal") %>% select(Mono),
                  paired=FALSE,
                  alternative = "two.sided")

modmono


#Bcells
ggplot(covariates_y1 %>% select(mod_cv, Bcell) %>% na.omit(), aes(x=mod_cv, y=Bcell)) +
  geom_point() +
  labs(x="Method of delivery") +
  #scale_x_discrete(labels=c("Caesarean", "Vaginal")) +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank()) +
    geom_signif(comparisons = list(c("caesarean", "vaginal")), 
              map_signif_level=F, col="black", 
              annotation = c("t = 0.54951, p-value = 0.5843"),
               textsize = 5)


modbcell <- t.test(covariates_y1 %>% subset(mod_cv=="caesarean") %>% select(Bcell), 
                  covariates_y1 %>% subset(mod_cv=="vaginal") %>% select(Bcell),
                  paired=FALSE,
                  alternative = "two.sided")
modbcell


#natural killer cells
ggplot(covariates_y1 %>% select(mod_cv, NK) %>% na.omit(), aes(x=mod_cv, y=NK)) +
  geom_point() +
  labs(x="Method of delivery") +
 # scale_x_discrete(labels=c("Caesarean", "Vaginal")) +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank()) +
    geom_signif(comparisons = list(c("caesarean", "vaginal")), 
              map_signif_level=F, col="black", 
              annotation = c("t = 1.0083, p-value = 0.3163"),
               textsize = 5)


modNK <- t.test(covariates_y1 %>% subset(mod_cv=="caesarean") %>% select(NK), 
                  covariates_y1 %>% subset(mod_cv=="vaginal") %>% select(NK),
                  paired=FALSE,
                  alternative = "two.sided")
modNK

```


Predict PBMC cell types based on gestational age (in days).  
```{r pbmc.celltypes.gestationalage}

#cd4t cells
ggplot(covariates_y1, aes(x=gestational_days, y=CD4T)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Gestational age (days)") + 
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())


#cd8t cells
ggplot(covariates_y1, aes(x=gestational_days, y=CD8T)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Gestational age (days)") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

#mononuclear cells
ggplot(covariates_y1, aes(x=gestational_days, y=Mono)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Gestational age (days)") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

#Bcells
ggplot(covariates_y1, aes(x=gestational_days, y=Bcell)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE)  +
  stat_cor(method = "pearson", size=10) +
  labs(x="Gestational age (days)") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

#natural killer cells
ggplot(covariates_y1, aes(x=gestational_days, y=NK)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Gestational age (days)") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

```


Predict PBMC cell types based on birth weight.
```{r pbmc.celltypes.birthweight}

#cd4t cells
ggplot(covariates_y1, aes(x=weight_birth, y=CD4T)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Birth weight") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

#cd8t cells
ggplot(covariates_y1, aes(x=weight_birth, y=CD8T)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Birth weight") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

#mononuclear cells
ggplot(covariates_y1, aes(x=weight_birth, y=Mono)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Birth weight") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

#Bcells
ggplot(covariates_y1, aes(x=weight_birth, y=Bcell)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Birth weight") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

#natural killer cells
ggplot(covariates_y1, aes(x=weight_birth, y=NK)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Birth weight") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())


```



Predict PBMC cell types based on mom asthma. 
```{r pbmc.celltypes.momasthma}

#cd4t cells
ggplot(covariates_y1 %>% subset(maternal_asthma == 0 | maternal_asthma ==1 ), aes(x=as.factor(maternal_asthma), y=CD4T)) +
  geom_point() +
  labs(x="Matneral asthma") +
  theme_bw() +
  theme(panel.border = element_blank(),
        text=element_text(size=20)) +
  geom_signif(comparisons = list(c("0", "1")), 
              map_signif_level=F, col="black", 
              annotation = c("t = -0.70254, p-value = 0.4842"),
              textsize=5)

ttest.momasthma.cd4t <- t.test(covariates_y1 %>% subset(maternal_asthma==0) %>% select(CD4T), 
                               covariates_y1 %>% subset(maternal_asthma==1) %>% select(CD4T),
                               paired=FALSE,
                               alternative = "two.sided")

ttest.momasthma.cd4t


#cd8t cells
ggplot(covariates_y1 %>% subset(maternal_asthma == 0 | maternal_asthma ==1 ), aes(x=as.factor(maternal_asthma), y=CD8T)) +
  geom_point() +
  labs(x="Matneral asthma") +
  theme_bw() +
  theme(panel.border = element_blank(),
        text=element_text(size=20)) +
  geom_signif(comparisons = list(c("0", "1")), 
              map_signif_level=F, col="black", 
              annotation = c("t = -1.7162, p-value = 0.09039"),
              textsize=5)

ttest.momasthma.cd8t <- t.test(covariates_y1 %>% subset(maternal_asthma==0) %>% select(CD8T), 
                               covariates_y1 %>% subset(maternal_asthma==1) %>% select(CD8T),
                               paired=FALSE,
                               alternative = "two.sided")

ttest.momasthma.cd8t


#mononuclear cells
ggplot(covariates_y1 %>% subset(maternal_asthma == 0 | maternal_asthma ==1 ), aes(x=as.factor(maternal_asthma), y=Mono)) +
  geom_point() +
  labs(x="Matneral asthma") +
  theme_bw() +
  theme(panel.border = element_blank(),
        text=element_text(size=20)) +
  geom_signif(comparisons = list(c("0", "1")), 
              map_signif_level=F, col="black", 
              annotation = c("t = 1.0035, p-value = 0.3182"),
              textsize=5)

ttest.momasthma.mono <- t.test(covariates_y1 %>% subset(maternal_asthma==0) %>% select(Mono), 
                               covariates_y1 %>% subset(maternal_asthma==1) %>% select(Mono),
                               paired=FALSE,
                               alternative = "two.sided")

ttest.momasthma.mono


#Bcells
ggplot(covariates_y1 %>% subset(maternal_asthma == 0 | maternal_asthma ==1 ), aes(x=as.factor(maternal_asthma), y=Bcell)) +
  geom_point() +
  labs(x="Matneral asthma") +
  theme_bw() +
  theme(panel.border = element_blank(),
        text=element_text(size=20)) +
  geom_signif(comparisons = list(c("0", "1")), 
              map_signif_level=F, col="black", 
              annotation = c("t = 0.59003, p-value = 0.5564"),
              textsize=5)

ttest.momasthma.bcells <- t.test(covariates_y1 %>% subset(maternal_asthma==0) %>% select(Bcell), 
                               covariates_y1 %>% subset(maternal_asthma==1) %>% select(Bcell),
                               paired=FALSE,
                               alternative = "two.sided") 

ttest.momasthma.bcells 

#natural killer cells
ggplot(covariates_y1 %>% subset(maternal_asthma == 0 | maternal_asthma ==1 ), aes(x=as.factor(maternal_asthma), y=NK)) +
  geom_point() +
  labs(x="Matneral asthma") +
  theme_bw() +
  theme(panel.border = element_blank(),
        text=element_text(size=20)) +
  geom_signif(comparisons = list(c("0", "1")), 
              map_signif_level=F, col="black", 
              annotation = c("t = 1.3193, p-value = 0.1905"),
              textsize=5)

ttest.momasthma.NK <- t.test(covariates_y1 %>% subset(maternal_asthma==0) %>% select(NK), 
                               covariates_y1 %>% subset(maternal_asthma==1) %>% select(NK),
                               paired=FALSE,
                               alternative = "two.sided")

ttest.momasthma.NK

```



PBMCs vs maternal depression
```{r pbmcs_depression}

#cd4t cells
ggplot(covariates_y1, aes(x=csed_y1, y=CD4T)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Year one maternal depression (z-score)") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

#cd8t cells
ggplot(covariates_y1, aes(x=csed_y1, y=CD8T)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Year one maternal depression (z-score)") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

#mononuclear cells
ggplot(covariates_y1, aes(x=csed_y1, y=Mono)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Year one maternal depression (z-score)") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

#Bcells
ggplot(covariates_y1, aes(x=csed_y1, y=Bcell)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Year one maternal depression (z-score)") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

#natural killer cells
ggplot(covariates_y1, aes(x=csed_y1, y=NK)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Year one maternal depression (z-score)") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())



```

PBMC vs Maternal stress
```{r celltype_stress}
#cd4t cells
ggplot(covariates_y1, aes(x=pss_y1, y=CD4T)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Year one maternal stress (z-score)") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

#cd8t cells
ggplot(covariates_y1, aes(x=pss_y1, y=CD8T)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Year one maternal stress (z-score)") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

#mononuclear cells
ggplot(covariates_y1, aes(x=pss_y1, y=Mono)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Year one maternal stress (z-score)") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

#Bcells
ggplot(covariates_y1, aes(x=pss_y1, y=Bcell)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Year one maternal stress (z-score)") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

#natural killer cells
ggplot(covariates_y1, aes(x=pss_y1, y=NK)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Year one maternal stress (z-score)") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())



```

PBMCs vs year one ses
```{r pbmc_ses}
#cd4t cells
ggplot(covariates_y1, aes(x=composite_ses, y=CD4T)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Composite SES (z-score)") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

#cd8t cells
ggplot(covariates_y1, aes(x=composite_ses, y=CD8T)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Composite SES (z-score)") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

#mononuclear cells
ggplot(covariates_y1, aes(x=composite_ses, y=Mono)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Composite SES (z-score)") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

#Bcells
ggplot(covariates_y1, aes(x=composite_ses, y=Bcell)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Composite SES (z-score)") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

#natural killer cells
ggplot(covariates_y1, aes(x=composite_ses, y=NK)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Composite SES (z-score)") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())


```

Year one depression vs year one stress
```{r depression_stress}
ggplot(covariates_y1, aes(x=csed_y1, y=pss_y1)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Year one maternal depression (z-score)", y="Year one maternal stress (z-score)") +
  theme_bw() + 
  theme(text=element_text(size=15),
        panel.border = element_blank())

```

Maternal depression vs ses
```{r depression_ses}
ggplot(covariates_y1, aes(x=composite_ses, y=csed_y1)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Composite SES (z-score)", y="Year one maternal depression (z-score)") +
  theme_bw() + 
  theme(text=element_text(size=15),
        panel.border = element_blank())

```

Maternal stress vs ses
```{r stress_ses}
ggplot(covariates_y1, aes(x=composite_ses, y=pss_y1)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Composite SES (z-score)", y="Year one maternal stress (z-score)") +
  theme_bw() + 
  theme(text=element_text(size=15),
        panel.border = element_blank())

```


Pbmcs vs age 5 asthma
```{r pbmc_age5_asthma}
#cd4t cells
ggplot(covariates_y1 %>% subset(clinician_asthma_dx_5y == 0 | clinician_asthma_dx_5y == 1 |
                                  clinician_asthma_dx_5y == 2), aes(x=clinician_asthma_dx_5y, y=CD4T)) +
  geom_point() +
  labs(x="Clinician diagnosed asthma (age 5)") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

cd4t.asthma5 <- lm(CD4T ~ clinician_asthma_dx_5y, covariates_y1)
anova(cd4t.asthma5)


#cd8t cells
ggplot(covariates_y1 %>% subset(clinician_asthma_dx_5y == 0 | clinician_asthma_dx_5y == 1 |
                                  clinician_asthma_dx_5y == 2), aes(x=clinician_asthma_dx_5y, y=CD8T)) +
  geom_point() +
  labs(x="Clinician diagnosed asthma (age 5)") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

cd8t.asthma5 <- lm(CD8T ~ clinician_asthma_dx_5y, covariates_y1)
anova(cd8t.asthma5)

#mononuclear cells
ggplot(covariates_y1 %>% subset(clinician_asthma_dx_5y == 0 | clinician_asthma_dx_5y == 1 |
                                  clinician_asthma_dx_5y == 2), aes(x=clinician_asthma_dx_5y, y=Mono)) +
  geom_point() +
  labs(x="Clinician diagnosed asthma (age 5)") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

mono.asthma5 <- lm(Mono ~ clinician_asthma_dx_5y, covariates_y1)
anova(mono.asthma5)


#Bcells
ggplot(covariates_y1 %>% subset(clinician_asthma_dx_5y == 0 | clinician_asthma_dx_5y == 1 |
                                  clinician_asthma_dx_5y == 2), aes(x=clinician_asthma_dx_5y, y=Bcell)) +
  geom_point() +
  labs(x="Clinician diagnosed asthma (age 5)") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

bcell.asthma5 <- lm(Bcell ~ clinician_asthma_dx_5y, covariates_y1)
anova(bcell.asthma5)


#natural killer cells
ggplot(covariates_y1 %>% subset(clinician_asthma_dx_5y == 0 | clinician_asthma_dx_5y == 1 |
                                  clinician_asthma_dx_5y == 2), aes(x=clinician_asthma_dx_5y, y=NK)) +
  geom_point() +
  labs(x="Clinician diagnosed asthma (age 5)") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

nk.asthma5 <- lm(NK ~ clinician_asthma_dx_5y, covariates_y1)
anova(nk.asthma5)
```




No2 and ses
```{r no2_ses}
ggplot(covariates_y1, aes(x=composite_ses, y=no2_y1_entire)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE, col="#75A2D9") +
  stat_cor(method = "pearson", size=8) +
  labs(x="Composite SES (z-score)", y = bquote('Average year one'~ NO[2] ~(μg/m^3))) +
  theme_bw() + 
  #scale_x_discrete(labels = c("No", "Yes", "Probable")) +
  theme(text=element_text(size=18),
        panel.border = element_blank())


ggplot(covariates_y1, aes(x=composite_ses, y=no2_y1_entire, col=studycentre)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=5) +
  labs(x="Composite SES (z-score)", y=bquote('Average year one'~ NO[2] ~(μg/m^3))) +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

#no2 by study centre

ggplot(covariates_y1, aes(x=as.factor(studycentre), y=no2_y1_entire, fill=studycentre)) +
  geom_boxplot() + 
  geom_jitter(height=0, width=0.3) +
  labs(x="Study Centre", y=bquote('Average year one'~ NO[2] ~(μg/m^3))) +
  scale_fill_manual(values=c("#EEF0FF", "#BCD6FB", "#75A2D9", "#27497F"))+
  theme_bw() + 
  theme(text=element_text(size=18),
        panel.border = element_blank(),
        legend.position = "none")


#anova for effects
no2.studycentre <- lm(no2_y1_entire ~ studycentre, covariates_y1)
anova(no2.studycentre)
no2.studycentre.aov <- aov(no2_y1_entire ~ studycentre, covariates_y1)
no2.studycentre.tukey <- TukeyHSD(no2.studycentre.aov)
no2.studycentre.tukey
```



Maternal smoking year one vs pbmcs
```{r pbmc_mat_smoking}

#cd4t cells
ggplot(covariates_y1 %>% select(CD4T, maternal_smoking_y1) %>% na.omit(), aes(x=maternal_smoking_y1, y=CD4T)) +
  geom_point() +
  labs(x="Sex") +
  labs(x="Year one maternal smoking") +
  scale_x_discrete(labels=c("No", "Yes")) +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank()) +
    geom_signif(comparisons = list(c("0", "1")), 
              map_signif_level=F, col="black", 
              annotation = c("t = -0.38256, p-value = 0.7127"),
              textsize = 5)

smoking_cd4t <- t.test(covariates_y1 %>% subset(maternal_smoking_y1=="0") %>% select(CD4T), 
                  covariates_y1 %>% subset(maternal_smoking_y1=="1") %>% select(CD4T),
                  paired=FALSE,
                  alternative = "two.sided")



#cd8t cells
ggplot(covariates_y1 %>% select(CD8T, maternal_smoking_y1) %>% na.omit(), aes(x=maternal_smoking_y1, y=CD8T)) +
  geom_point() +
  labs(x="Year one maternal smoking") +
  scale_x_discrete(labels=c("No", "Yes")) +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank()) +
    geom_signif(comparisons = list(c("0", "1")), 
              map_signif_level=F, col="black", 
              annotation = c("t = -1.5739, p-value = 0.1556"),
              textsize = 5)


smoking_cd8t <- t.test(covariates_y1 %>% subset(maternal_smoking_y1=="0") %>% select(CD8T), 
                  covariates_y1 %>% subset(maternal_smoking_y1=="1") %>% select(CD8T),
                  paired=FALSE,
                  alternative = "two.sided")

#mononuclear cells
ggplot(covariates_y1 %>% select(Mono, maternal_smoking_y1) %>% na.omit(), 
       aes(x=maternal_smoking_y1, y=Mono, fill=maternal_smoking_y1)) +
  geom_boxplot()+
  geom_jitter(height=0, width=0.3) +
  labs(x="Year one maternal smoking") +
  scale_fill_manual(values=c("#EEF0FF", "#75A2D9")) +
  scale_x_discrete(labels=c("No", "Yes")) +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank(),
        legend.position = "none") +
  ylim(0, 0.45) +
    geom_signif(comparisons = list(c("0", "1")), 
              map_signif_level=F, col="black", 
              annotation = c("***"),
              textsize = 10)


smoking_mono <- t.test(covariates_y1 %>% subset(maternal_smoking_y1=="0") %>% select(Mono), 
                  covariates_y1 %>% subset(maternal_smoking_y1=="1") %>% select(Mono),
                  paired=FALSE,
                  alternative = "two.sided")



#Bcells
ggplot(covariates_y1 %>% select(Bcell, maternal_smoking_y1) %>% na.omit(), aes(x=maternal_smoking_y1, y=Bcell)) +
  geom_point() +
  labs(x="Year one maternal smoking") +
  scale_x_discrete(labels=c("No", "Yes")) +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())+
    geom_signif(comparisons = list(c("0", "1")), 
              map_signif_level=F, col="black", 
              annotation = c("t = 0.51268, p-value = 0.6229"),
              textsize = 5)


smoking_bcell <- t.test(covariates_y1 %>% subset(maternal_smoking_y1=="0") %>% select(Bcell), 
                  covariates_y1 %>% subset(maternal_smoking_y1=="1") %>% select(Bcell),
                  paired=FALSE,
                  alternative = "two.sided")


#natural killer cells
ggplot(covariates_y1 %>% select(NK, maternal_smoking_y1) %>% na.omit(), aes(x=maternal_smoking_y1, y=NK)) +
  geom_point() +
  labs(x="Year one maternal smoking") +
  scale_x_discrete(labels=c("No", "Yes")) + 
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())+
    geom_signif(comparisons = list(c("0", "1")), 
              map_signif_level=F, col="black", 
              annotation = c("t = 0.17188, p-value = 0.8681"),
              textsize = 5)


smoking_nk <- t.test(covariates_y1 %>% subset(maternal_smoking_y1=="0") %>% select(NK), 
                  covariates_y1 %>% subset(maternal_smoking_y1=="1") %>% select(NK),
                  paired=FALSE,
                  alternative = "two.sided")
```



Year one maternal smoking vs age 5 asthma diagnosis
```{r smoking_asthma}
ggplot(covariates_y1 %>% select(clinician_asthma_dx_5y, maternal_smoking_y1) %>% na.omit(), aes(x=clinician_asthma_dx_5y, y=maternal_smoking_y1)) +
  geom_jitter(width=0.3, height=0.3) +
  labs(x="Age 5 asthma diagnosis", y = "Year one maternal smoking") +
  scale_x_discrete(labels=c("No", "Yes", "Probable")) + 
  scale_y_discrete(labels=c("No", "Yes")) +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

matsmokey1.asthma5 <- table(covariates_y1$maternal_smoking_y1, covariates_y1$clinician_asthma_dx_5y)
matsmokey1.asthma5.fisher <- fisher.test(matsmokey1.asthma5)
matsmokey1.asthma5.fisher
```

Urine cotinine at 3 months vs pbmcs
```{r pbmc_cotinine}
#cd4t cells
ggplot(covariates_y1 %>% subset(urine_cotinine_3m < 60), aes(x=urine_cotinine_3m, y=CD4T)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Urine cotinine at 3 months") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

#cd8t cells
ggplot(covariates_y1 %>% subset(urine_cotinine_3m < 60), aes(x=urine_cotinine_3m, y=CD8T)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Urine cotinine at 3 months") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

#mononuclear cells
ggplot(covariates_y1 %>% subset(urine_cotinine_3m < 60), aes(x=urine_cotinine_3m, y=Mono)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Urine cotinine at 3 months") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

#Bcells
ggplot(covariates_y1 %>% subset(urine_cotinine_3m < 60), aes(x=urine_cotinine_3m, y=Bcell)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Urine cotinine at 3 months") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

#natural killer cells
ggplot(covariates_y1 %>% subset(urine_cotinine_3m < 60), aes(x=urine_cotinine_3m, y=NK)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Urine cotinine at 3 months") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())


```

Urine cotinine at 3 months vs age 5 asthma diagnosis
```{r cotinine_age5_asthma}
ggplot(covariates_y1 %>% subset(clinician_asthma_dx_5y == 0 | clinician_asthma_dx_5y == 1 |
                                  clinician_asthma_dx_5y == 2) %>% subset(urine_cotinine_3m <60), aes(x=clinician_asthma_dx_5y, y=urine_cotinine_3m)) +
  geom_point() +
  labs(x="Clinician diagnosed asthma (age 5)", y = "Urine cotinine at 3 months") +
  theme_bw() + 
  scale_x_discrete(labels = c("No", "Yes", "Probable")) +
  theme(text=element_text(size=20),
        panel.border = element_blank())

```

Urine cotinine at 3 months vs maternal smoking at 1 year
```{r urine_cotinine_mat_smoking}
ggplot(covariates_y1 %>% subset(maternal_smoking_y1 == 0 | maternal_smoking_y1 == 1) %>% subset(urine_cotinine_3m <60), aes(x=maternal_smoking_y1, y=urine_cotinine_3m)) +
  geom_point() +
  labs(x="Year one maternal smoking ", y = "Urine cotinine at 3 months") +
  theme_bw() + 
  scale_x_discrete(labels = c("No", "Yes")) +
  theme(text=element_text(size=20),
        panel.border = element_blank()) +
    geom_signif(comparisons = list(c("0", "1")), 
              map_signif_level=F, col="black", 
              annotation = c("t = -1.0549, p-value = 0.3321"),
              textsize = 5)


cotinine_smoke <- t.test(covariates_y1 %>% subset(maternal_smoking_y1=="0") %>% select(urine_cotinine_3m), 
                  covariates_y1 %>% subset(maternal_smoking_y1=="1") %>% select(urine_cotinine_3m),
                  paired=FALSE,
                  alternative = "two.sided")

```


Maternal smoking vs SES
```{r smoking_ses}
ggplot(covariates_y1 %>% subset(maternal_smoking_y1 == 0 | maternal_smoking_y1 == 1), aes(x=maternal_smoking_y1, y=composite_ses)) +
  geom_point() +
  labs(x="Year one maternal smoking ", y = "Composite SES (z-score)") +
  theme_bw() + 
  scale_x_discrete(labels = c("No", "Yes")) +
  theme(text=element_text(size=20),
        panel.border = element_blank()) +
    geom_signif(comparisons = list(c("0", "1")), 
              map_signif_level=F, col="black", 
              annotation = c("t = 2.3227, p-value = 0.06382"),
              textsize = 5)


smoke_ses <- t.test(covariates_y1 %>% subset(maternal_smoking_y1=="0") %>% select(composite_ses), 
                  covariates_y1 %>% subset(maternal_smoking_y1=="1") %>% select(composite_ses),
                  paired=FALSE,
                  alternative = "two.sided")
```

Urine cotinine vs ses
```{r cotinine_ses}
ggplot(covariates_y1 %>% subset(urine_cotinine_3m <60), aes(x=composite_ses, y=urine_cotinine_3m)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Composite SES (z-score)", y = "Urine cotinine at 3 months") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank()) 
```



### Create heatmap of cell types vs covariates to condense data down.





Year one maternal stress and depression vs composite ses
```{r csed_pss_ses}
ggplot(covariates_y1, aes(x=composite_ses, y=pss_csed_y1)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Composite SES (z-score)", y = "Year one maternal stress and depression (z-score)") +
  theme_bw() + 
  #scale_x_discrete(labels = c("No", "Yes", "Probable")) +
  theme(text=element_text(size=15),
        panel.border = element_blank())

```


Prenatal maternal stress and depression sv year one maternal stress and depression
```{r csed_pss_prenatal_y1}
ggplot(covariates_y1, aes(x=pss_csed_prenatal, y=pss_csed_y1)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE, col="#75A2D9") +
  stat_cor(method = "pearson", size=8) +
  labs(x="Prenatal stress and depression (z-score)", y = "Year one stress and depression (z-score)") +
  theme_bw() + 
  #scale_x_discrete(labels = c("No", "Yes", "Probable")) +
  theme(text=element_text(size=15),
        panel.border = element_blank())




```



Prenatal maternal smoking vs year one stress and depression
```{r prenatalsmoking_y1_csed_pss}

ggplot(covariates_y1 %>% subset(prenatal_maternal_smoking==1 | prenatal_maternal_smoking==0), aes(x=prenatal_maternal_smoking, y=pss_csed_y1, fill=prenatal_maternal_smoking)) +
  geom_boxplot() +
  geom_jitter(height = 0, width = 0.3) + 
  scale_fill_manual(values=c("#EEF0FF", "#75A2D9")) +
  labs(x="Prenatal maternal smoking", y = "Year one stress and depression (z-score)") +
  theme_bw() + 
  scale_x_discrete(labels = c("No", "Yes")) +
  ylim(-1.5,4) +
  theme(text=element_text(size=15),
        panel.border = element_blank(),
        legend.position = "none") +
  geom_signif(comparisons = list(c("0", "1")), 
              map_signif_level=F, col="black", 
              annotation = c("*"),
              textsize = 10)


prenatalsmoke.psscsedy1 <- t.test(covariates_y1 %>% subset(prenatal_maternal_smoking=="0") %>%
                                    select(pss_csed_y1), 
                                  covariates_y1 %>% subset(prenatal_maternal_smoking=="1") %>%
                                    select(pss_csed_y1),
                                  paired=FALSE,
                                  alternative = "two.sided")
prenatalsmoke.psscsedy1

```


PBMC Cell type vs study centre
```{r pbmcs_studysite}

#cd4t cells
ggplot(covariates_y1 , aes(x=studycentre, y=CD4T * 100, fill=studycentre)) +
  geom_boxplot() + 
  geom_jitter(height = 0, width = 0.3) +
  labs(x="Study centre", y="CD4T (%)") +
  scale_fill_manual(values=c("#EEF0FF", "#BCD6FB", "#75A2D9", "#27497F")) +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank(),
        legend.position="none") 

#anova for effects
cd4t.studycentre <- lm(CD4T ~ studycentre, covariates_y1)
anova(cd4t.studycentre)
cd4t.studycentre.aov <- aov(CD4T ~ studycentre, covariates_y1)
cd4t.studycentre.tukey <- TukeyHSD(cd4t.studycentre.aov)
cd4t.studycentre.tukey


#cd8t
ggplot(covariates_y1 , aes(x=studycentre, y=CD8T*100, fill=studycentre)) +
  geom_boxplot() + 
  geom_jitter(height = 0, width = 0.3) +
  labs(x="Study centre", y="CD8T (%)") +
  scale_fill_manual(values=c("#EEF0FF", "#BCD6FB", "#75A2D9", "#27497F")) +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank(),
        legend.position="none") 

#anova for effects
cd8t.studycentre <- lm(CD8T ~ studycentre, covariates_y1)
anova(cd8t.studycentre)
cd8t.studycentre.aov <- aov(CD8T ~ studycentre, covariates_y1)
cd8t.studycentre.tukey <- TukeyHSD(cd8t.studycentre.aov)
cd8t.studycentre.tukey


#mono
ggplot(covariates_y1 , aes(x=studycentre, y=Mono*100, fill=studycentre)) +
  geom_boxplot() + 
  geom_jitter(height = 0, width = 0.3) +
  labs(x="Study centre", y="Mono (%)") +
  scale_fill_manual(values=c("#EEF0FF", "#BCD6FB", "#75A2D9", "#27497F")) +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank(),
        legend.position="none") +
    geom_signif(comparisons = list(c("Winnipeg", "Toronto")), 
              map_signif_level=F, col="black", 
              annotation = c("*"),
              textsize = 10) +
  ylim(5, 45)

#anova for effects
mono.studycentre <- lm(Mono ~ studycentre, covariates_y1)
anova(mono.studycentre)
mono.studycentre.aov <- aov(Mono ~ studycentre, covariates_y1)
mono.studycentre.tukey <- TukeyHSD(mono.studycentre.aov)
mono.studycentre.tukey


#bcell
ggplot(covariates_y1 , aes(x=studycentre, y=Bcell*100, fill=studycentre)) +
  geom_boxplot() + 
  geom_jitter(height = 0, width = 0.3) +
  labs(x="Study centre", y="Bcell (%)") +
  scale_fill_manual(values=c("#EEF0FF", "#BCD6FB", "#75A2D9", "#27497F")) +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank(),
        legend.position="none") +
      geom_signif(comparisons = list(c("Edmonton", "Toronto")), 
              map_signif_level=F, col="black", 
              y_position = 45,
              annotation = c("*"),
              textsize = 10) +
    geom_signif(comparisons = list(c("Edmonton", "Vancouver")), 
              map_signif_level=F, col="black", 
              y_position = 53,
              annotation = c("*"),
              textsize = 10) +
      geom_signif(comparisons = list(c("Winnipeg", "Vancouver")), 
              map_signif_level=F, col="black", 
              y_position = 58,
              annotation = c("**"),
              textsize = 10) +
  
        geom_signif(comparisons = list(c("Winnipeg", "Toronto")), 
              map_signif_level=F, col="black", 
              y_position = 66,
              annotation = c("**"),
              textsize = 10) +
  ylim(10,70)

#anova for effects
bcell.studycentre <- lm(Bcell ~ studycentre, covariates_y1)
anova(bcell.studycentre)
bcell.studycentre.aov <- aov(Bcell ~ studycentre, covariates_y1)
bcell.studycentre.tukey <- TukeyHSD(bcell.studycentre.aov)
bcell.studycentre.tukey
 
#nk
ggplot(covariates_y1 , aes(x=studycentre, y=NK*100, fill=studycentre)) +
  geom_boxplot() + 
  geom_jitter(height = 0, width = 0.3) +
  labs(x="Study centre", y="NK (%)") +
  scale_fill_manual(values=c("#EEF0FF", "#BCD6FB", "#75A2D9", "#27497F")) +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank(),
        legend.position="none") 

#anova for effects
nk.studycentre <- lm(NK ~ studycentre, covariates_y1)
anova(nk.studycentre)
nk.studycentre.aov <- aov(NK ~ studycentre, covariates_y1)
nk.studycentre.tukey <- TukeyHSD(nk.studycentre.aov)
nk.studycentre.tukey
```

Year one maternal smoking and prenatal smoking 
```{r prenatal_yearone_smoking}
ggplot(covariates_y1 %>% select(prenatal_maternal_smoking, maternal_smoking_y1) %>% na.omit(),
       aes(x=prenatal_maternal_smoking, y=maternal_smoking_y1)) +
  geom_jitter(height=0.2, width=0.2) +
  labs(x="Prenatal maternal smoking", y = "Maternal smoking year one") +
  theme_bw() + 
  scale_x_discrete(labels = c("No", "Yes")) +
  scale_y_discrete(labels = c("No", "Yes")) +
  theme(text=element_text(size=15),
        panel.border = element_blank()) +
      geom_signif(comparisons = list(c("0", "1")), 
              map_signif_level=F, col="black", 
              annotation = c("***"),
              textsize = 10) 
  ylim(5, 45)

smoking.table <- table(covariates_y1$prenatal_maternal_smoking,covariates_y1$maternal_smoking_y1)
smoking.fishers <- fisher.test(smoking.table)
smoking.fishers
```


Prenatal no2 vs postnatal no2
```{r prenatal_yearone_no2}
ggplot(covariates_y1, aes(x=no2_preg_entire, y=no2_y1_entire)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE, col="#75A2D9") +
  stat_cor(method = "pearson", size=8) +
  labs(x=bquote('Average prenatal'~ NO[2] ~(μg/m^3)), y = bquote('Average year one'~ NO[2] ~(μg/m^3))) +
  theme_bw() + 
  #scale_x_discrete(labels = c("No", "Yes", "Probable")) +
  theme(text=element_text(size=18),
        panel.border = element_blank())



```

Maternal age vs study site
```{r maternalage_studysite}
ggplot(covariates_y1 , aes(x=studycentre, y=maternal_age, fill=studycentre)) +
  geom_boxplot() + 
  geom_jitter(height = 0, width = 0.3) +
  labs(x="Study centre", y="Maternal age (years)") +
  scale_fill_manual(values=c("#EEF0FF", "#BCD6FB", "#75A2D9", "#27497F")) +
  theme_bw() + 
  ylim(20,50) +
  theme(text=element_text(size=20),
        panel.border = element_blank(),
        legend.position="none") +
      geom_signif(comparisons = list(c("Winnipeg", "Toronto")), 
              map_signif_level=F, col="black", 
              annotation = c("**"),
              textsize = 10) 

#anova for effects
age.studycentre <- lm(maternal_age ~ studycentre, covariates_y1)
anova(age.studycentre)
age.studycentre.aov <- aov(maternal_age ~ studycentre, covariates_y1)
age.studycentre.tukey <- TukeyHSD(age.studycentre.aov)
age.studycentre.tukey


```