---
title: "Table one NO2"
author: "SL"
date: "27/10/2020"
output: html_document
---

*Purpose*: The purpose of this script is to create "Table 1" for the CHILD NO2 analysis. 

Load libraries.
```{r libraries}
library(tidyverse)
library(table1)
library(here)
library(VennDiagram)
```


Load betas
```{r betas}
load(file=here("output_data", "preprocessed_data",
               "2020-11_19_CHILD_preprocessed_betas_pdata_annotation.Rdata"))

#subset out cord blood and year one pData
#cord blood pdata
cb_pdata <- subset(pdata_nodups, Tissue == "C")
dim(cb_pdata) # 144  17

#year one pdatga
y1_pdata <- subset(pdata_nodups, Tissue == "P")
dim(y1_pdata) # 145  17

#year one data has one individual that is missing birth data
#remove this individual
y1_pdata_sub <- y1_pdata[y1_pdata$Sample_Label %in% cb_pdata$Sample_Label, ]
dim(y1_pdata_sub) # 144  17
```

Subset out cord blood and age one betas
```{r sub_betas}
#subset pData into CBMCs (cord blood)
#these children have data at both time points
cb_betas <- betas[,colnames(betas) %in% rownames(cb_pdata)]
#check size of cord blood data
dim(cb_betas) # 424644    144
min(cb_betas) # 0.002973941
max(cb_betas) # 0.9980669

#check if cord blood DNAm samples are in same order in cord blood pdata
identical(colnames(cb_betas), rownames(cb_pdata)) #true
#rename columns of cb_betas
colnames(cb_betas) <- cb_pdata$Sample_Label


#subset out cordblood samples from beta matrix
y1_betas <- betas[,colnames(betas) %in% rownames(y1_pdata_sub)]
#check size of year one data
dim(y1_betas) # 424644    144
min(y1_betas) #0.002650193
max(y1_betas) #0.9983506

#check if cord blood DNAm samples are in same order in cord blood pdata
identical(colnames(y1_betas), rownames(y1_pdata_sub)) #true
#rename columns of cb_betas
colnames(y1_betas) <- y1_pdata_sub$Sample_Label

#check if cord blood samples and year one samples are in same order
identical(colnames(cb_betas), colnames(y1_betas))
```

Load covariate data
```{r covariates}
load(file=here("output_data", "covariates", "2020-11-12_CHILD_covariates_na_with_means.Rdata"))

#subset covariates
covariates_sub <- 
  covariates_nameans[as.character(covariates_nameans$sampleid) %in% colnames(y1_betas), ]

#check order
identical(as.character(covariates_sub$sampleid), colnames(y1_betas)) #true
dim(covariates_sub) #144

#check order
identical(as.character(cb_pdata$Sample_Label), colnames(y1_betas)) #true
dim(cb_pdata) #144

#check order
identical(as.character(y1_pdata_sub$Sample_Label), colnames(y1_betas)) #true
dim(y1_pdata_sub) #144

```

Load list of probes used in deconvolution. This will be used later to remove these probes before linear regression
```{r deconvo_probe_list}
load("R:/Jones/People/Samantha Lee/Projects/CHILD/CHILD_air_pollution/output_data/deconvolution/2021-01-07_CBMC_PBMC_deconvolution.Rdata")
```


Load combined cell type PCs (CBMC and PBMC together).
```{r load_celltype_PCs}
load(here("output_data", "celltype_PCS", "2021-01-08_CHILD_CBMC_PBMC_PCs.Rdata"))

#check size
dim(ccc_pcs) #144 11

#rename columns for clarity
colnames(ccc_pcs) <- paste("celltype.", colnames(ccc_pcs), sep="")

#check that cell type pcs and covariates are in the same order
identical(as.character(covariates_sub$sampleid), rownames(ccc_pcs)) #true

#combine cell type pcs and covariates
covariates_ctpcs <- cbind(covariates_sub, ccc_pcs)
dim(covariates_ctpcs)
```


Load genotyping PCs and subset out REEGLE PCs (genotyping data contains PCs for a few thousand participants).
```{r genotypingPCS}
genotyping <- read.csv("R:/Jones/People/Samantha Lee/Computational/CHILD/input_data/CHILD_subjects_Qced_first10PCS_Duan.csv")

#make rownames sample names then rmove this row
rownames(genotyping) <- genotyping$FID
genotyping <- subset(genotyping, select=-c(FID, IID))

genosub <- genotyping[rownames(genotyping) %in% cb_pdata$Sample_Label,]
#missing genotyping data for 14 REEGLE children?

#rename columns of genotyping data for clarity
colnames(genosub) <- paste("genotyping.", colnames(genosub), sep="")

#put rows in numerical order according to sample id
genosub_order <- genosub[order(rownames(genosub)), ]
```


```{r sub}
#subset cb_pdata
cb_pdata_geno <- cb_pdata[as.character(cb_pdata$Sample_Label) %in% rownames(genosub_order), ]
#check size
dim(cb_pdata_geno) #131
#check order
identical(as.character(cb_pdata_geno$Sample_Label), rownames(genosub_order)) #true

#subset y1_pdata
y1_pdata_geno <- y1_pdata_sub[as.character(y1_pdata_sub$Sample_Label) %in% rownames(genosub_order), ]
#check size
dim(y1_pdata_geno) #131
#check order
identical(as.character(y1_pdata_geno$Sample_Label), rownames(genosub_order)) #true

#subset covariates
covariates_sub_geno <- covariates_sub[as.character(covariates_sub$sampleid) %in% rownames(genosub_order), ]
#check size
dim(covariates_sub_geno) #131
#check order
identical(as.character(covariates_sub_geno$sampleid), rownames(genosub_order)) #true

```




Combine covariate data (subset) and genotyping data into one dataframe. 
```{r combine}
#subset for genosub
all_vars <- cbind(covariates_sub_geno, genosub_order)

#get sampleids with complete cases for prenatal models
all_vars$prenatal_cc <- complete.cases(all_vars %>% 
                                dplyr::select(no2_preg_entire, sex,  
                                              gestational_days,
                                              prenatal_maternal_smoking,  
                                              maternal_education_length, 
                                              pss_18wk,csed_18wk))

#get rows with complete cases for year one models
all_vars$yearone_cc <- complete.cases(all_vars %>% 
                                dplyr::select(no2_y1_entire, sex,  
                                              maternal_smoking_y1,  
                                              maternal_education_length, 
                                              pss_6mos,
                                              csed_6mos))

yearone_ids <- all_vars[complete.cases(all_vars %>% 
                                dplyr::select(no2_y1_entire, sex,  
                                              maternal_smoking_y1,  
                                              maternal_education_length, 
                                              pss_6mos,
                                              csed_6mos)), "sampleid"]

prenatal_ids <- all_vars[complete.cases(all_vars %>% 
                                dplyr::select(no2_preg_entire, sex,  
                                              gestational_days,
                                              prenatal_maternal_smoking,  
                                              maternal_education_length, 
                                              pss_18wk,csed_18wk)), "sampleid"]


timing <- sapply(all_vars$sampleid, function(x){
  ifelse(((x %in% prenatal_ids) & (x %in% yearone_ids)), "both",
         ifelse(((x %in% prenatal_ids) & (!x %in% yearone_ids)), "prenatal",
                ifelse(((!x %in% prenatal_ids) & (x %in% yearone_ids)), "y1",
                       NA)))})

all_vars$timing <- timing

strata <- c(list("Prenatal"=subset(all_vars, timing=="prenatal" | timing=="both")),
            list("Year one"=subset(all_vars, timing=="y1" | timing=="both")))

bquote(paste('NO'['2']*' (ppb)'))


labels <- list(
  variables=list(no2_preg_entire = "NO2 (ppb)",
                 no2_y1_entire = "NO2 (ppb)",
                 sex="Sex",
                 gestational_days="Age (years)",
                 prenatal_maternal_smoking= "Maternal smoking",
                 maternal_smoking_y1= "Maternal smoking",
                 maternal_education_length = "Maternal education length (years)",
                 pss_18wk= "Maternal stress",
                 pss_6mo= "Maternal stress",
                 csed_18wk= "Maternal depression",
                 csed_6mo= "Maternal depression"),
  groups=list("Prenatal", "Yearone"))


my.render.cont <- function(x) {
    with(stats.apply.rounding(stats.default(x), digits=2), c("",
        "Mean (SD)"=sprintf("%s (&plusmn; %s)", MEAN, SD)))
}
my.render.cat <- function(x) {
    c("", sapply(stats.default(x), function(y) with(y,
        sprintf("%d (%0.0f %%)", FREQ, PCT))))
}

table1(strata, labels, 
              render.continuous = my.render.cont,
       render.categorical = my.render.cat)






```

Create table one.
```{r tableone}
#change labels for covariates

label(test2$no2_preg_entire) <- "Average prenatal NO2 exposure"
units(test2$no2_preg_entire) <- "µg/m3" 

label(test2$PM25DALbYY_01) <- "Three year average PM2.5 B exposure"
units(test2$PM25DALbYY_01) <- "µg/m3"

label(test2$sex) <- "Sex"
levels(test2$sex) <- c("Female", "Male")

label(test2$gestational_days) <- "Gestational age"
units(test2$gestational_days) <- "days"

label(test2$birth_month) <- "Birth month"
levels(test2$birth_month) <- c("January", "February", "March", "April", "May",
                         "June", "July", "August", "September", 
                         "October", "November", "December")

label(test2$maternal_education_length) <- "Maternal education length"
units(test2$maternal_education_length) <- "years"


label(test2$maternal_smoking_18wk) <- "Prenatal maternal smoking"
levels(test2$maternal_smoking_18wk) <- c("No", "Yes")

label(test2$maternal_smoking_y1) <- "First year maternal smoking"
levels(test2$maternal_smoking_y1) <- c("No", "Yes")

label(test2$pss_18wk) <- "Prenatal maternal stress"
label(test2$pss_6mos) <- "First year maternal stress"
label(test2$csed_6mos) <- "First year maternal depression"

my.render.cont <- function(x) {
    with(stats.apply.rounding(stats.default(x), digits=2), c("",
        "Mean (SD)"=sprintf("%s (&plusmn; %s)", MEAN, SD)))
}
my.render.cat <- function(x) {
    c("", sapply(stats.default(x), function(y) with(y,
        sprintf("%d (%0.0f %%)", FREQ, PCT))))
}


strata1 <- c(split(all_vars, list(all_vars$timing),
            list("Prenatal" = subset(all_vars, timing!="yearone" )),
            list("Year one" = subset(all_vars, timing !="prenatal")),
            list()))
                 
                 
                 tersrt <- list(
    variables=list(sex=render.varlabel(dat$sex),
                   age=render.varlabel(dat$age),
                   wt=render.varlabel(dat$wt)),
    groups=list("", "Treated", ""))re))


labels <- list(
    variables=list(sex=test2$sex,
                   age=test2$gestational_days,
                   edu=test2$maternal_education_length),
    groups=list("Prenatal", "Yearone"))

strata1 <- c(split(test2, list(test2$time)),
            list("Prenatal" = subset(test2, (time == "prenatal") & !is.na(pss_18wk) & !is.na(csed_18wk) & !is.na(prenatal_maternal_smoking) & !is.na(maternal_education_length))),
            list("Yearone" = test2$time))


table1(~ sex + gestational_days + 
         maternal_education_length + maternal_smoking_18wk + maternal_smoking_y1 +
         pss_18wk + pss_6mos + csed_6mos | time, 
       data=test2)

table1(strata1)



```



Prenatal covariates
```{r prenatal_covariates}
#change labels for covariates

label(covariates_nameans$no2_preg_entire) <- "Average prenatal NO2 exposure"
units(covariates_nameans$no2_preg_entire) <- "µg/m3" 

label(covariates_nameans$PM25DALbYY_01) <- "Three year average PM2.5 B exposure"
units(covariates_nameans$PM25DALbYY_01) <- "µg/m3"

label(covariates_nameans$sex) <- "Sex"
levels(covariates_nameans$sex) <- c("Female", "Male")

label(covariates_nameans$gestational_days) <- "Gestational age"
units(covariates_nameans$gestational_days) <- "days"

label(covariates_nameans$birth_month) <- "Birth month"
levels(covariates_nameans$birth_month) <- c("January", "February", "March", "April", "May",
                         "June", "July", "August", "September", 
                         "October", "November", "December")

label(covariates_nameans$maternal_education_length) <- "Maternal education length"
units(covariates_nameans$maternal_education_length) <- "years"

label(covariates_nameans$paternal_education_length) <- "Paternal education length"
units(covariates_nameans$paternal_education_length) <- "years"

label(covariates_nameans$total_income) <- "Total income"
units(covariates_nameans$total_income) <- "Dollars"

label(covariates_nameans$pss_18wk) <- "Prenatal maternal stress at 18 weeks"
label(covariates_nameans$pss_36wk) <- "Prenatal maternal stress at 36 weeks"

label(covariates_nameans$csed_18wk) <- "Prenatal maternal depression at 18 weeks"
label(covariates_nameans$csed_36wk) <- "Prenatal maternal depression at 36 weeks"


label(covariates_nameans$maternal_smoking_18wk) <- "Prenatal maternal smoking"
levels(covariates_nameans$maternal_smoking_18wk) <- c("No", "Yes")

my.render.cont <- function(x) {
    with(stats.apply.rounding(stats.default(x), digits=2), c("",
        "Mean (SD)"=sprintf("%s (&plusmn; %s)", MEAN, SD)))
}
my.render.cat <- function(x) {
    c("", sapply(stats.default(x), function(y) with(y,
        sprintf("%d (%0.0f %%)", FREQ, PCT))))
}

table1(~ maternal_education_length + paternal_education_length + 
           total_income +
           ses_community_rank + ses_canada_rank +
         pss_18wk + pss_36wk + csed_18wk + csed_36wk, 
       data=covariates_nameans,
       render.continuous = my.render.cont,
       render.categorical = my.render.cat)
```



Prenatal covariates
```{r prenatal_covariates_all}
#change labels for covariates

label(covariates$no2_preg_entire) <- "Average prenatal NO2 exposure"
units(covariates$no2_preg_entire) <- "µg/m3" 

label(covariates$PM25DALbYY_01) <- "Three year average PM2.5 B exposure"
units(covariates$PM25DALbYY_01) <- "µg/m3"

label(covariates$sex) <- "Sex"
levels(covariates$sex) <- c("Female", "Male")

label(covariates$gestational_days) <- "Gestational age"
units(covariates$gestational_days) <- "days"

label(covariates$birth_month) <- "Birth month"
levels(covariates$birth_month) <- c("January", "February", "March", "April", "May",
                         "June", "July", "August", "September", 
                         "October", "November", "December")

label(covariates$maternal_education_length) <- "Maternal education length"
units(covariates$maternal_education_length) <- "years"

label(covariates$paternal_education_length) <- "Paternal education length"
units(covariates$paternal_education_length) <- "years"


label(covariates$ses_community_rank) <- "SES community rank"
label(covariates$ses_canada_rank) <- "SES Canada rank"

label(covariates$total_income) <- "Total income"
units(covariates$total_income) <- "dollars"

label(covariates$pss_18wk) <- "Prenatal maternal stress at 18 weeks"
label(covariates$pss_36wk) <- "Prenatal maternal stress at 36 weeks"

label(covariates$csed_18wk) <- "Prenatal maternal depression at 18 weeks"
label(covariates$csed_36wk) <- "Prenatal maternal depression at 36 weeks"


label(covariates$maternal_smoking_18wk) <- "Prenatal maternal smoking"
levels(covariates$maternal_smoking_18wk) <- c("No", "Yes")

my.render.cont <- function(x) {
    with(stats.apply.rounding(stats.default(x), digits=2), c("",
        "Mean (SD)"=sprintf("%s (&plusmn; %s)", MEAN, SD)))
}
my.render.cat <- function(x) {
    c("", sapply(stats.default(x), function(y) with(y,
        sprintf("%d (%0.0f %%)", FREQ, PCT))))
}

table1(~maternal_education_length + paternal_education_length + total_income +
           ses_community_rank + ses_canada_rank +
         pss_18wk + pss_36wk + csed_18wk + csed_36wk,
       data=covariates,
       render.continuous = my.render.cont,
       render.categorical = my.render.cat)

```

Year one covariates
```{r yearone_covariates}
#change labels for covariates

label(covariates_nameans$no2_y1_entire) <- "Average year one NO2 exposure"
units(covariates_nameans$no2_y1_entire) <- "µg/m3" 

label(covariates_nameans$PM25DALYY_01) <- "Average PM2.5 A exposure"
units(covariates_nameans$PM25DALYY_01) <- "µg/m3"

label(covariates_nameans$PM25DALbYY_01) <- "Average PM2.5 B exposure"
units(covariates_nameans$PM25DALbYY_01) <- "µg/m3"

label(covariates_nameans$sex) <- "Sex"
levels(covariates_nameans$sex) <- c("Female", "Male")

label(covariates_nameans$birth_month) <- "Birth month"
levels(covariates_nameans$birth_month) <- c("January", "February", "March", "April", "May",
                         "June", "July", "August", "September", 
                         "October", "November", "December")

label(covariates_nameans$maternal_education_length) <- "Maternal education length"
units(covariates_nameans$maternal_education_length) <- "years"

label(covariates_nameans$paternal_education_length) <- "Paternal education length"
units(covariates_nameans$paternal_education_length) <- "years"

label(covariates_nameans$ses_community_rank) <- "SES community rank"
label(covariates_nameans$ses_canada_rank) <- "SES Canada rank"


label(covariates_nameans$pss_6mos) <- "Maternal stress at 6 months"
label(covariates_nameans$pss_12mos) <- "Maternal stress at 12 months"

label(covariates_nameans$csed_6mos) <- "Maternal depression at 6 months"
label(covariates_nameans$csed_12mos) <- "Maternal depression at 12 months"



label(covariates_nameans$maternal_smoking_y1) <- "Year one maternal smoking"
levels(covariates_nameans$maternal_smoking_y1) <- c("No", "Yes")

my.render.cont <- function(x) {
    with(stats.apply.rounding(stats.default(x), digits=2), c("",
        "Mean (SD)"=sprintf("%s (&plusmn; %s)", MEAN, SD)))
}
my.render.cat <- function(x) {
    c("", sapply(stats.default(x), function(y) with(y,
        sprintf("%d (%0.0f %%)", FREQ, PCT))))
}

table1(~ maternal_education_length + paternal_education_length + 
           ses_community_rank + ses_canada_rank +
         pss_6mos + pss_12mos + csed_6mos + csed_12mos, 
       data=covariates_nameans,
       render.continuous = my.render.cont,
       render.categorical = my.render.cat)
```