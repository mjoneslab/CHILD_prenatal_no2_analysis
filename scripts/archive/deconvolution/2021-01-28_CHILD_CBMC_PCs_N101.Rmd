---
title: "CHILD cord blood cell cell type PC generation"
author: "SL"
date: "2020-10-27"
output: html_document
---

*Purpose*: This script generates cell type PCs from CBMCs. CBMC PCs can be used in linear models to correct for cell type.

## Cell type correction

Correct cordblood for cell type using linear regression. 

Based on "Adjusting for cell type composition in DNA methylation data using a regression-based approach" by Jones et al (2017).  

The data is composite data and cell types are not independent of one another:  

Two ways of dealing with this:  

1. Do a PCA  
* variables are not independent -PCA will give all the same data but in independent vectors  
* But cant do PCA on composite data - this is composite data  
* Do a centred log ratio before PCA to get around this  

2. Leave out one cell type  
* More simple way  
* Usually leave cell type that is largest proportion  
* For whole blood/cord blood - drop granulocytes  
* For PMBCs and CBMCs - drop CD4T cells  


## Principle Component (PC) generation

Load required libraries.
```{r libraries, message=FALSE, warning=FALSE}
library(tidyverse)
library(minfi)
library(rgr) #for log centred ratio transfromation
library(factoextra)
library(GGally)
library(here)
```

Load preprocessed CHILD data.  
```{r load_CHILD_data, message=FALSE, warning=FALSE}
load(here("output_data", "preprocessed_data", "2020-11_19_CHILD_preprocessed_betas_pdata_annotation.Rdata"))

#subset out cord blood pdata
cb_pdata <- subset(pdata_nodups, Tissue == "C")
dim(cb_pdata) # 144  17
```

Load deconvolution data.
```{r load_CHILD_data, message=FALSE, warning=FALSE}
load(here("output_data", "deconvolution", "2021-01-07_CBMC_PBMC_deconvolution.Rdata"))

#only want to keep child_fscbc_ecc2_cb
rm(child_fscbc_ecc2_y1)
```

Load covariate data
```{r covariates}
load(file=here("output_data", "covariates", "2020-11-12_CHILD_covariates_na_with_means.Rdata"))
```


Load genotyping PCs and subset out REEGLE PCs (genotyping data contains PCs for a few thousand participants).
```{r genotypingPCS}
genotyping <- read.csv("R:/Jones/People/Samantha Lee/Computational/CHILD/input_data/CHILD_subjects_Qced_first10PCS_Duan.csv")

#make rownames sample names then rmove this row
rownames(genotyping) <- genotyping$FID
genotyping <- subset(genotyping, select=-c(FID, IID))

genosub <- genotyping[rownames(genotyping) %in% cb_pdata$Sample_Label,]
#missing genotyping data for 14 REEGLE children?

#rename columns of genotyping data for clarity
colnames(genosub) <- paste("genotyping.", colnames(genosub), sep="")

#put rows in numerical order according to sample id
genosub_order <- genosub[order(rownames(genosub)), ]
```


Remove duplicates from cord blood deconvolution data.  
```{r remove_dups_from_deconvo}
#convert deconvolution data to dataframe
child_fscbc_ecc2_cb_df <- as.data.frame(child_fscbc_ecc2_cb$counts)

#make list of samples to remove from beta and pData
dups_rm <-c("9298768102_R06C01", "9341679111_R05C02", "9298768023_R03C02",
            "9341679076_R06C02", "9297962089_R06C02", "9298768023_R02C02",
            "9341679097_R02C02", "9341679114_R01C02", "9298768023_R06C01")

#remove replicates from cell type estimates                      
child_fscbc_ecc2_cb_df_nodups <-
  child_fscbc_ecc2_cb_df[!rownames(child_fscbc_ecc2_cb_df) %in% dups_rm, ]

#check that 9 samples were removed
dim(child_fscbc_ecc2_cb_df_nodups)
dim(child_fscbc_ecc2_cb_df)

#rename rows to sample label
identical(rownames(child_fscbc_ecc2_cb_df_nodups), rownames(cb_pdata)) # TRUE
rownames(child_fscbc_ecc2_cb_df_nodups) <- cb_pdata$Sample_Label
```


Subset covariates for genosub.
```{r covariates_sub}
#sub 
covariates_nameans_geno <- 
  covariates_nameans[covariates_nameans$sampleid %in% rownames(genosub_order),]

#size
dim(covariates_nameans_geno) #131

#complete cases
covariates_nameans_geno_cc <-
  covariates_nameans_geno[complete.cases(covariates_nameans_geno[,c("prenatal_maternal_smoking",
                                                                    "maternal_education_length",
                                                                    "gestational_days",
                                                                    "pss_18wk",
                                                                    "csed_18wk",
                                                                    "no2_preg_entire")]), ]

dim(covariates_nameans_geno_cc) #101
```


Subset cell counts for complete cases
```{r cellcount_cc}
child_fscbc_ecc2_cb_df_nodups_cc <-
  child_fscbc_ecc2_cb_df_nodups[rownames(child_fscbc_ecc2_cb_df_nodups) %in%
                                  covariates_nameans_geno_cc$sampleid, ]

dim(child_fscbc_ecc2_cb_df_nodups_cc) #101
```


Centred log ratio wont accept negative values. Additionally, centred log ratio will accept zeros however rows with 0s will return NA for 0 instance and infinity for all othe values. Therefore check for any negative values as well as 0s. If there are zeroes or negatives need to investigate why.
```{r remove_neg_values}
#check how many negatives
sum(child_fscbc_ecc2_cb_df_nodups_cc <= 0) #0
```

Centred log ratio of estimated cell type proportions.
```{r clr}
cb_celltypes_clr <- clr(as.matrix(child_fscbc_ecc2_cb_df_nodups_cc))

#check for NAs or inf
#these will occur if zeroes or negatives existed in cell tyoe estimates
sum(is.na(cb_celltypes_clr)) #0
sum(is.infinite(cb_celltypes_clr)) #0
```

Run PCA analysis on CLR transformed cell type estimates
```{r celltype_pca}
#pca
cb_pca <- prcomp(cb_celltypes_clr, scale. = TRUE)

#scree plot
factoextra::fviz_eig(cb_pca)

#convert to dataframe
cb_pcs <- as.data.frame(cb_pca$x)
#correct based on first 5 PCs

#examine grouping of pcs
ggpairs(cb_pcs, columns=1:6, progress=FALSE)  
```

Save CBMC PCs. 
```{r save_adjusted_betas}
save(cb_pcs, cb_allprobes, cb_deconvolutionprobes,  
     file=here("output_data", "deconvolution", "2021-01-28_CBMC_PCs_N101.RData"))
```
 







