---
title: "Age one blood cell cell type PC generation"
author: "SL"
date: "2020-10-27"
output: html_document
---

*Purpose*: This script generates cell type PCs from PBMCs. PBMC PCs can be used in linear models to correct for cell type.

## Cell type correction

Correct cordblood for cell type using linear regression. 

Based on "Adjusting for cell type composition in DNA methylation data using a regression-based approach" by Jones et al (2017).  

The data is composite data and cell types are not independent of one another:  

Two ways of dealing with this:  

1. Do a PCA  
* variables are not independent -PCA will give all the same data but in independent vectors  
* But cant do PCA on composite data - this is composite data  
* Do a centred log ratio before PCA to get around this  

2. Leave out one cell type  
* More simple way  
* Usually leave cell type that is largest proportion  
* For whole blood/cord blood - drop granulocytes  
* For PMBCs and y1MCs - drop CD4T cells  


## Principle Component (PC) generation

Load required libraries.
```{r libraries, message=FALSE, warning=FALSE}
library(tidyverse)
library(minfi)
library(rgr) #for log centred ratio transfromation
library(factoextra)
library(GGally)
library(here)
```

Load CHILD145 deconvolution data. This deconvolution does not include granulocytes as granulocytes are not expected.
```{r load_CHILD_data, message=FALSE, warning=FALSE}
load(here("output_data", "deconvolution", "2021-09-24_cbmc_pbmc_deconvolution.Rdata"))

#only want to keep y1 data
rm(child_fscbc_ecc2_cb, cb_allprobes, cb_deconvolutionprobes)

#convert deconvolution data to dataframe
child_fscbc_ecc2_y1_df <- as.data.frame(child_fscbc_ecc2_y1$counts)
```


Centred log ratio wont accept negative values. Additionally, centred log ratio will accept zeros however rows with 0s will return NA for 0 instance and infinity for all othe values. Therefore check for any negative values as well as 0s. If there are zeroes or negatives need to investigate why.
```{r remove_neg_values}
#check how many negatives
sum(child_fscbc_ecc2_y1_df_nodups <= 0) #0
```

Centred log ratio of estimated cell type proportions.
```{r clr}
y1_celltypes_clr <- clr(as.matrix(child_fscbc_ecc2_y1_df))

#check for NAs or inf
#these will occur if zeroes or negatives existed in cell tyoe estimates
sum(is.na(y1_celltypes_clr)) #0
sum(is.infinite(y1_celltypes_clr)) #0
```

Run PCA analysis on CLR transformed cell type estimates
```{r celltype_pca}
#pca
y1_pca <- prcomp(y1_celltypes_clr, scale. = TRUE)

#scree plot
factoextra::fviz_eig(y1_pca)

#convert to dataframe
y1_pcs <- as.data.frame(y1_pca$x)
#correct based on first 5 PCs

#examine grouping of pcs
ggpairs(y1_pcs, columns=1:5, progress=FALSE)  
```

Save y1MC PCs. 
```{r save_adjusted_betas}
save(y1_pcs, 
     y1_allprobes,
     y1_deconvolutionprobes,
     child_fscbc_ecc2_y1_df,
     file=here("output_data", "deconvolution", "2021-02-04_PBMC_PCs.RData"))
```
 







