---
title: "CHILD145 covariate matrices"
author: "SL"
date: "30/01/2020"
output: html_document
---

*Purpose*: The purpose of this script is to examine the correlation between prenatal covariates. This will help in building linear models to examine prenatal specific changes. 

Read libraries in.
```{r libraries, warnings=FALSE, message=FALSE}
library(tidyverse)
library(plyr)
library(ggpubr)
library(here)
```

Load in CHILD covariate data.
```{r covariates}
load(here("output_data", "covariates", "2020-11-03_CHILD_all_covariates.Rdata"))
```

Read in cell type estimates.  
```{r load_deconvolution}
load(here("output_data", "deconvolution", "2021-01-07_CBMC_PBMC_deconvolution.Rdata"))
```

Load pData.  
```{r load_pData}
#this pdata has bad samples removed and sample mix-up corrected
load(file = here("output_data", "preprocessed_data", "2021-01_14_CHILD_preprocessed_betas_pdata_annotation.Rdata"))
  
#subset pData into CBMCs (cord blood)
cb_pdata <- subset(pdata_nodups, Tissue == "C")
dim(cb_pdata) #144 18
```


Read in genotyping PCs
```{r genotyping}
genotyping <- read.csv("R:/Jones/People/Samantha Lee/Computational/CHILD/input_data/CHILD_subjects_Qced_first10PCS_Duan.csv")

#make rownames sample names then rmove this row
rownames(genotyping) <- genotyping$FID
genotyping <- subset(genotyping, select=-c(FID))

#subset genotyping for REEGLE children
genosub <- genotyping[rownames(genotyping) %in% cb_pdata$Sample_Label,]

#rename columns of genotyping data for clarity
colnames(genosub) <- paste("genotyping.", colnames(genosub), sep="")
```


Convert deconvolution estimates to dataframes.
```{r convert_deconvo_to_df}
#cordblood cbmc deconvo
child_fscbc_ecc2_cb_df <- as.data.frame(child_fscbc_ecc2_cb$counts)

#subset out samples to be used for analysis (no duplicates)
child_fscbc_ecc2_cb_df <- child_fscbc_ecc2_cb_df[rownames(cb_pdata),]

#check if rownames in same order
identical(rownames(child_fscbc_ecc2_cb_df), rownames(cb_pdata)) #true

#rename cell count rownames to sample id
rownames(child_fscbc_ecc2_cb_df) <- cb_pdata$Sample_Label
```

Subset covariate data for cord blood since one sample was removed
```{r subset_covariates_cb}
#subset covariate data according to age and then combined with predicted cell proportions
covariates_cb <- covariates[covariates$sampleid %in% as.character(cb_pdata$Sample_Label),]
dim(covariates_cb) #144 113

#combine covaraite master data and cell estimates 
#check if they are identical 
identical(as.character(covariates_cb$sampleid), rownames(child_fscbc_ecc2_cb_df)) #true
covariates_cbmc <- cbind(covariates_cb, child_fscbc_ecc2_cb_df)

#combine covariate data with genotyping data
rownames(covariates_cbmc)  <- covariates_cbmc$sampleid
covariates_cbmc_geno <- merge(covariates_cbmc, genosub[,2:4], by = "row.names", all.x = TRUE)

#check size
dim(covariates_cbmc_geno) #144

#repopulate rownames
rownames(covariates_cbmc_geno) <- as.character(covariates_cbmc$sampleid)
```


## Correlation heatmap between all covariates and cell types 


Create function to calculate correlation coefficients berween covariates. 
```{r cor2.function}

cor2 = function(df){
  
  print("checking dataframe clases")
  stopifnot(inherits(df, "data.frame"))
  stopifnot(sapply(df, class) %in% c("integer"
                                     , "numeric"
                                     , "factor"
                                     , "character"))
  
  print("calculating correlation matrix")
  cor_fun <- function(pos_1, pos_2){
    
    # both are numeric
    if(class(df[[pos_1]]) %in% c("integer", "numeric") &&
       class(df[[pos_2]]) %in% c("integer", "numeric")){
      print("both are numeric")
      print(paste(colnames(df)[[pos_1]], colnames(df)[[pos_2]]))
      r <- stats::cor(df[[pos_1]], df[[pos_2]], use = "pairwise.complete.obs") #pairwise.complete.obs
      p <- unname((summary(lm(df[[pos_1]] ~ df[[pos_2]]))$coefficients[,4])[2])
      
    }
    
    #one is numberic the other is factor/character
    #must use sum of squares type 3 because groups are not of the same size
    #calculates ANOVA
    #then calcualtes eta-squared: measures the proportion of the total variance in a      dependent variable that
    #is associated with the membership of different groups defined by an independent      variable.
    #takes square root to get correlation
    if(class(df[[pos_1]]) %in% c("integer", "numeric") &&
       class(df[[pos_2]]) %in% c("factor", "character")){
      
      #print statements for debugging
      print("first is numeric, second is factor")
      print(paste(colnames(df)[[pos_1]], colnames(df)[[pos_2]]))
      
      #check factor levels of complete cases
      print("checking levels of pos_2 factor")
      tmp <- data.frame(df[[pos_1]], df[[pos_2]], row.names = NULL)
      complete <- complete.cases(tmp)
      tmp2 <- tmp[complete,]
      tmp2[,2] <- as.factor(tmp2[,2])
      
      #if statement to catch cases where dropped values result in a factor with
      #one or fewer levels
      if(is.factor(tmp2[,2]) & (nlevels(droplevels(tmp2[,2]))<2)){
        r <- 999
      } else {
        #anova for correlation
        r <- stats::aov(df[[pos_1]] ~ as.factor(df[[pos_2]])) %>%
          lsr::etaSquared(type=3) %>% `[`(1) %>% sqrt()
        
        #anova for p-pval
        lm_p <- lm(df[[pos_1]] ~ as.factor(df[[pos_2]]))
        p <- (anova(lm_p))$`Pr(>F)`[1]
        
      }
      rm(tmp,tmp2)
    }
    
    
    
    if(class(df[[pos_2]]) %in% c("integer", "numeric") &&
       class(df[[pos_1]]) %in% c("factor", "character")){
      
      #print statements for debugging
      print("first is factor, second is numeric")
      print(paste(colnames(df)[[pos_1]], colnames(df)[[pos_2]]))
      
      #check factor levels of complete cases
      print("checking levels of pos_1 factor")
      tmp <- data.frame(df[[pos_1]], df[[pos_2]], row.names = NULL)
      complete <- complete.cases(tmp)
      tmp2 <- tmp[complete,]
      tmp2[,1] <- as.factor(tmp2[,1])
      
      #if statement to catch cases where dropped values result in a factor with
      #one or fewer levels
      if(is.factor(tmp2[,1]) && (nlevels(droplevels(tmp2[,1]))<2)){
        r <- 999
      } else {
        r <- stats::aov(df[[pos_2]] ~ as.factor(df[[pos_1]])) %>%
          lsr::etaSquared(type=3) %>% `[`(1) %>% sqrt()
        
        #anova for p-pval
        lm_p <- lm(df[[pos_2]] ~ as.factor(df[[pos_1]]))
        p <- (anova(lm_p))$`Pr(>F)`[1]
        
      }
      rm(tmp,tmp2)
    }
    
    
  
    #both are factor/character
    if(class(df[[pos_1]]) %in% c("factor", "character") &&
       class(df[[pos_2]]) %in% c("factor", "character")){
      
      #print statement for debugging
      print("both are characters")
      print(paste(colnames(df)[[pos_1]], colnames(df)[[pos_2]]))
      
       #check factor levels of complete cases
      print("checking levels of of both positions")
      tmp <- data.frame(df[[pos_1]], df[[pos_2]], row.names = NULL)
      complete <- complete.cases(tmp)
      tmp2 <- tmp[complete,]
      tmp2[,1] <- as.factor(tmp2[,1])
      tmp2[,2] <- as.factor(tmp2[,2])
      
      #if statement to catch cases where dropped values result in a factor with
      #one or fewer levels
      if(is.factor(tmp2[,1]) && (nlevels(droplevels(tmp2[,1]))<2)){
        r <- 999
      } else {
        if(is.factor(tmp2[,2]) && (nlevels(droplevels(tmp2[,2]))<2)){
          r <-999
        } else { 
          r <- lsr::cramersV(df[[pos_1]], df[[pos_2]], simulate.p.value = TRUE)
          #get p value
          fish_table <- table(df[[pos_1]], df[[pos_2]])
          p <- fisher.test(fish_table, simulate.p.value=T)$p.value
        }
      }
      rm(tmp,tmp2)
    }
    
    return(r)
  } 
  
  cor_fun <- Vectorize(cor_fun)
  
  # now compute corr matrix
  corrmat <- outer(1:ncol(df)
                   , 1:ncol(df)
                   , function(x, y) cor_fun(x, y)
  )
  
  rownames(corrmat) <- colnames(df)
  colnames(corrmat) <- colnames(df)
  return(corrmat)
}
```

Create function to calcualte pvalues of correlations between coefficients. 
```{r pval2.function}

pval2 = function(df){
  
  #check that classes are appropriate
  print("checking dataframe clases")
  stopifnot(inherits(df, "data.frame"))
  stopifnot(sapply(df, class) %in% c("integer"
                                     , "numeric"
                                     , "factor"
                                     , "character"))
  
  print("calculating correlation matrix")
  
  ##################################
  #function for calculating pvalues#
  ##################################
  
  pval_fun <- function(pos_1, pos_2){
    

    ##################
    #both are numeric#
    ##################
    
    if(class(df[[pos_1]]) %in% c("integer", "numeric") &&
       class(df[[pos_2]]) %in% c("integer", "numeric")){
        
      print("both are numeric")
      
      if(colnames(df)[[pos_1]] == colnames(df)[[pos_2]]){
        #dont want to star comparisons of something against itsself
        p <- 1
      } else {
        print(paste(colnames(df)[[pos_1]], colnames(df)[[pos_2]]))
        p <- unname((summary(lm(df[[pos_1]] ~ df[[pos_2]]))$coefficients[,4])[2])
      }
    }
  
    ########################################
    #first is integer and second is numeric#
    ########################################
    
    if(class(df[[pos_1]]) %in% c("integer", "numeric") &&
       class(df[[pos_2]]) %in% c("factor", "character")){
      
      #print statements for debugging
      print("first is numeric, second is factor")
      print(paste(colnames(df)[[pos_1]], colnames(df)[[pos_2]]))
      
      #check factor levels of complete cases
      print("checking levels of pos_2 factor")
      tmp <- data.frame(df[[pos_1]], df[[pos_2]], row.names = NULL)
      complete <- complete.cases(tmp)
      tmp2 <- tmp[complete,]
      tmp2[,2] <- as.factor(tmp2[,2])
      
      #if statement to catch cases where dropped values result in a factor with
      #one or fewer levels
      if(is.factor(tmp2[,2]) & (nlevels(droplevels(tmp2[,2]))<2)){
        p <- 999
      } else {
       if(nlevels(droplevels(tmp2[,2]))>2){
          #anova for p-pval with 3 or  more factors
          lm_p <- lm(df[[pos_1]] ~ as.factor(df[[pos_2]]))
          p <- (anova(lm_p))$`Pr(>F)`[1]
        } else{
          #ttest for 2 factors
          p <- t.test(df[[pos_1]] ~ as.factor(df[[pos_2]]),
                  alternative = "two.sided")$p.value
        }
      }
      rm(tmp,tmp2)
    }
    
    
    ########################################
    #second is integer and first is numeric#
    ########################################
    
    if(class(df[[pos_2]]) %in% c("integer", "numeric") &&
       class(df[[pos_1]]) %in% c("factor", "character")){
      
      #print statements for debugging
      print("first is factor, second is numeric")
      print(paste(colnames(df)[[pos_1]], colnames(df)[[pos_2]]))
      
      #check factor levels of complete cases
      print("checking levels of pos_1 factor")
      tmp <- data.frame(df[[pos_1]], df[[pos_2]], row.names = NULL)
      complete <- complete.cases(tmp)
      tmp2 <- tmp[complete,]
      tmp2[,1] <- as.factor(tmp2[,1])
      
      #if statement to catch cases where dropped values result in a factor with
      #one or fewer levels
      if(is.factor(tmp2[,1]) && (nlevels(droplevels(tmp2[,1]))<2)){
        p <- 999
      } else {
        if(nlevels(droplevels(tmp2[,1]))>2){
          #anova for p-pval with 3 or  more factors
          lm_p <- lm(df[[pos_2]] ~ as.factor(df[[pos_1]]))
          p <- (anova(lm_p))$`Pr(>F)`[1]
        } else{
          #ttest for 2 factors
          p <- t.test(df[[pos_2]] ~ as.factor(df[[pos_1]]),
                  alternative = "two.sided")$p.value
        }
      }
      rm(tmp,tmp2)
    }
    
    
    ###########################
    #both are factor/character#
    ###########################
    
    if(class(df[[pos_1]]) %in% c("factor", "character") &&
       class(df[[pos_2]]) %in% c("factor", "character")){
      
      #print statement for debugging
      print("both are characters")
      print(paste(colnames(df)[[pos_1]], colnames(df)[[pos_2]]))
      
       #check factor levels of complete cases
      print("checking levels of of both positions")
      tmp <- data.frame(df[[pos_1]], df[[pos_2]], row.names = NULL)
      complete <- complete.cases(tmp)
      tmp2 <- tmp[complete,]
      tmp2[,1] <- as.factor(tmp2[,1])
      tmp2[,2] <- as.factor(tmp2[,2])
      
      
      #if statement to catch cases where dropped values result in a factor with
      #one or fewer levels
      if(colnames(df)[[pos_1]] == colnames(df)[[pos_2]]){
        p <- 1
      } else {
        if(is.factor(tmp2[,1]) && (nlevels(droplevels(tmp2[,1]))<2)){
          p <- 999
        } else {
          if(is.factor(tmp2[,2]) && (nlevels(droplevels(tmp2[,2]))<2)){
            p <- 999
          } else {
            #get p value
            fish_table <- table(df[[pos_1]], df[[pos_2]])
            p <- fisher.test(fish_table, simulate.p.value = T)$p.value
          }
        }
      }
      rm(tmp,tmp2)
    }
    return(p)
  } 
  
  pval_fun <- Vectorize(pval_fun)
  
  # now compute corr matrix
  pvalmat <- outer(1:ncol(df)
                   , 1:ncol(df)
                   , function(x, y) pval_fun(x, y)
  )
  
  rownames(pvalmat) <- colnames(df)
  colnames(pvalmat) <- colnames(df)
  return(pvalmat)
}
```


Modify ggcorrplot function to not blank out insignificant values
```{r func_mod}

#+++++++++++++++++++++++
# Helper Functions
#+++++++++++++++++++++++

# Get lower triangle of the correlation matrix
.get_lower_tri <- function(cormat, show.diag = FALSE) {
  if (is.null(cormat)) {
    return(cormat)
  }
  cormat[upper.tri(cormat)] <- NA
  if (!show.diag) {
    diag(cormat) <- NA
  }
  return(cormat)
}

# Get upper triangle of the correlation matrix
.get_upper_tri <- function(cormat, show.diag = FALSE) {
  if (is.null(cormat)) {
    return(cormat)
  }
  cormat[lower.tri(cormat)] <- NA
  if (!show.diag) {
    diag(cormat) <- NA
  }
  return(cormat)
}

.remove_diag <- function(cormat){
  if (is.null(cormat)) {
    return(cormat)
  }
  diag(cormat) <- NA
  cormat
}
# hc.order correlation matrix
.hc_cormat_order <- function(cormat, hc.method = "complete") {
  dd <- stats::as.dist((1 - cormat) / 2)
  hc <- stats::hclust(dd, method = hc.method)
  hc$order
}

.no_panel <- function() {
  ggplot2::theme(
    axis.title.x = ggplot2::element_blank(),
    axis.title.y = ggplot2::element_blank()
  )
}


# Convert a tbl to matrix
.tibble_to_matrix <- function(x){
  x <-  as.data.frame(x)
  rownames(x) <- x[, 1]
  x <- x[, -1]
  as.matrix(x)
}



corrplot <-
  
function (corr, method = c("square", "circle"), type = c("full", 
    "lower", "upper"), ggtheme = ggplot2::theme_minimal, 
    title = "", show.legend = TRUE, legend.title = "Corr", 
    show.diag = FALSE, colors = c("blue", "white", 
        "red"), outline.color = "gray", hc.order = FALSE, 
    hc.method = "complete", lab = FALSE, lab_col = "black", 
    lab_size = 4, p.mat = NULL, sig.level = 0.05, insig = c("pch", 
        "blank"), pch = 4, pch.col = "black", pch.cex = 5, 
    tl.cex = 12, tl.col = "black", tl.srt = 45, digits = 2) {
  
    type <- match.arg(type)
    method <- match.arg(method)
    insig <- match.arg(insig)
    if (inherits(corr, "cor_mat")) {
        cor.mat <- corr
        corr <- .tibble_to_matrix(cor.mat)
        p.mat <- .tibble_to_matrix(attr(cor.mat, "pvalue"))
    }
    if (!is.matrix(corr) & !is.data.frame(corr)) {
        stop("Need a matrix or data frame!")
    }
    corr <- as.matrix(corr)
    corr <- base::round(x = corr, digits = digits)
    if (hc.order) {
        ord <- .hc_cormat_order(corr)
        corr <- corr[ord, ord]
        if (!is.null(p.mat)) {
            p.mat <- p.mat[ord, ord]
            p.mat <- base::round(x = p.mat, digits = digits)
        }
    }
    if (type == "lower") {
        corr <- .get_lower_tri(corr, show.diag)
        p.mat <- .get_lower_tri(p.mat, show.diag)
    }
    else if (type == "upper") {
        corr <- .get_upper_tri(corr, show.diag)
        p.mat <- .get_upper_tri(p.mat, show.diag)
    }
    
    corr <- reshape2::melt(corr, na.rm = TRUE)
    colnames(corr) <- c("Var1", "Var2", "value")
    corr$pvalue <- rep(NA, nrow(corr))
    corr$signif <- rep(NA, nrow(corr))
    
    
    if (!is.null(p.mat)) {
        p.mat <- reshape2::melt(p.mat, na.rm = TRUE)
        corr$coef <- corr$value
        corr$pvalue <- p.mat$value
        corr$signif <- as.numeric(p.mat$value <= sig.level)
        
        #DONT GET RID OF STUFF BASED ON PVALUE
        #p.mat <- subset(p.mat, p.mat$value > sig.level)
        #if (insig == "blank") {
        #    corr$value <- corr$value * corr$signif
        }
    
    

    corr$abs_corr <- abs(corr$value) * 10
    p <- ggplot2::ggplot(data = corr, 
                         mapping = ggplot2::aes_string(x = "Var1",
                                                       y = "Var2", 
                                                       fill = "value"))
    
    if (method == "square") {
        p <- p + ggplot2::geom_tile(color = outline.color)
    } else if (method == "circle") {
      p <- p + ggplot2::geom_point(color = outline.color, shape = 21, 
                                   ggplot2::aes_string(size = "abs_corr")) + 
        ggplot2::scale_size(range = c(4,10)) + 
        ggplot2::guides(size = FALSE)
    }
    
    
    p <- p + ggplot2::scale_fill_gradient2(low = colors[1],
                                           high = colors[3],
                                           mid = colors[2], 
                                           midpoint = 0, 
                                           limit = c(-1, 1), 
                                           space = "Lab", 
                                           name = "Correlation coefficient")
    
    
    if (class(ggtheme)[[1]] == "function") {
        p <- p + ggtheme()
    } else if (class(ggtheme)[[1]] == "theme") {
        p <- p + ggtheme
    }
    
    p <- p + ggplot2::theme(axis.text.x = ggplot2::element_text(angle = tl.srt,
                                                                vjust = 1,
                                                                size = tl.cex,
                                                                hjust = 1), 
                            axis.text.y = ggplot2::element_text(size = tl.cex)) + 
      ggplot2::coord_fixed()
    
    
    #LABEL WITH PVALUE NOT CORRELATION COEFFICIENT
    label <- round(x = corr[, "signif"], digits = digits)
    
    
    if (!is.null(p.mat) & insig == "blank") {
        ns <- corr$pvalue > sig.level
        if (sum(ns) > 0) 
            label[ns] <- " "
    }
    
    if (lab) {
        #p <- p + ggplot2::geom_text(mapping = ggplot2::aes_string(x = "Var1", 
        #    y = "Var2"), label = label , color = lab_col, 
        #    size = lab_size)
        
        p <- p + ggplot2::geom_point(data = corr %>% subset(signif==1),
                                     mapping = ggplot2::aes_string(x = "Var1", y = "Var2"), 
                                     shape = pch, size = pch.cex, color = pch.col)
        
    }
    
    if (!is.null(p.mat) & insig == "pch") {
        p <- p + ggplot2::geom_point(data = p.mat,
                                     mapping = ggplot2::aes_string(x = "Var1", y = "Var2"), 
                                     shape = pch, size = pch.cex, color = pch.col)
    }
    if (title != "") {
        p <- p + ggplot2::ggtitle(title)
    }
    if (!show.legend) {
        p <- p + ggplot2::theme(legend.position = "none")
    }
    p <- p + .no_panel()
    corr_plot <<- p
    p
  }
```
  
Get pvalues for covariates of interest
```{r pvals_cb144}
#sub for covariates of interested
covariates_cbmc_geno_sub <- subset(covariates_cbmc_geno, 
                                   select=c(NK, nRBC, Bcell, Mono, CD8T, CD4T,
                                            no2_preg_entire, 
                                            prenatal_maternal_smoking, 
                                            sex, gestational_days, 
                                            pss_18wk,
                                            csed_18wk, 
                                            maternal_education_length,
                                            genotyping.PC1, genotyping.PC2,
                                            genotyping.PC3,
                                            studycentre))

#pvals calcs
covariates_cbmc_geno_sub_pval <- pval2(covariates_cbmc_geno_sub)
```


Calculate correlations between metadata variables using cor2 function above.  
```{r corr_cb144}
#correlation calcs
covariates_cbmc_geno_sub_corr <- cor2(covariates_cbmc_geno_sub)

#set missing values (999) to NA - could have probably done this in the cor2 function
covariates_cbmc_geno_sub_corr[covariates_cbmc_geno_sub_corr == 999] <- NA
```  


```{r corrplot}
corrplot(covariates_cbmc_geno_sub_corr,
         pch = 8,
         pch.cex = 1.5,
         type = "lower", 
         p.mat = covariates_cbmc_geno_sub_pval,
         insig = "blank",
         lab=TRUE,
         tl.cex =6, 
         colors = c("#6D9EC1", "white", "#E46726")) +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        legend.key.height = unit(0.5, 'cm'),
        legend.key.width = unit(0.2, 'cm'),
        legend.text = element_text(size=5),
        legend.title = element_text(size=7),
        legend.position="left") +
  scale_y_discrete(labels = c("NK", "nRBC", "Bcell", "Mono", "CD8T", "CD4T",
                              "Prenatal NO2", "Maternal smoking", "Sex", 
                              "Gestational age", "Maternal stress", "Maternal depression",
                              "Maternal education length", 
                              "Genotyping PC1", "Genotyping PC2", "Genotyping PC3"),
                   position = "right") +
  scale_x_discrete(labels = c("nRBC", "Bcell", "Mono", "CD8T", "CD4T",
                              "Prenatal NO2", "Maternal smoking", "Sex", 
                              "Gestational age", "Maternal stress", "Maternal depression",
                              "Maternal education length", 
                              "Genotyping PC1", "Genotyping PC2", "Genotyping PC3",
                              "Study centre")) 


ggsave("R:/Jones/People/Samantha Lee/Projects/CHILD/CHILD_air_pollution/figures/2021-01-27_CHILD_cb144_corrplot.tiff",
       device="tiff",
       height=3,
       width=6,
       units="in")
```


##### Examine significant covariate correlations in 144 cord blood participants

CBMC proportions vs prenatal NO2 exposure
```{r cbmc_no2}

#cd4t cells
ggplot(covariates_cb, aes(x=no2_preg_entire, y=CD4T)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Adjusted pregnancy No2 ") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

#cd8t cells
ggplot(covariates_cb, aes(x=no2_preg_entire, y=CD8T)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Adjusted pregnancy No2 ") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank(),
        axis.text = element_text(size=15))

#mononuclear cells
ggplot(covariates_cb, aes(x=no2_preg_entire, y=Mono*100)) +
  geom_point(col="#75A2D9", size=3, alpha=0.7) +
  geom_smooth(method='lm', se=FALSE, col="black") +
  stat_cor(method = "pearson", size=8, label.y = 55) +
  labs(x="Average prenatal NO2 exposure (ug/m3)", y="% Monocytes") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank(),
        axis.text=element_text(size=18))

#Bcells
ggplot(covariates_cb, aes(x=no2_preg_entire, y=Bcell)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10, label.y = 20) +
  labs(x="Adjusted pregnancy No2 ") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

#natural killer cells
ggplot(covariates_cb, aes(x=no2_preg_entire, y=NK)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Adjusted pregnancy No2 ") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

#nuclear RBCs
ggplot(covariates_cb, aes(x=no2_preg_entire, y=nRBC)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Adjusted pregnancy No2 ") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())
```



CBMC proportions vs prenatal PM2.5 A exposure
```{r cbmc_pm2.5}

#cd4t cells
ggplot(covariates_cb %>% subset(PM25DALYY_01 >= 0), aes(x=PM25DALYY_01, y=CD4T)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="PM2.5 A exposure") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

#cd8t cells
ggplot(covariates_cb %>% subset(PM25DALYY_01 >= 0), aes(x=PM25DALYY_01, y=CD8T)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="PM2.5 A exposure") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

#mononuclear cells
ggplot(covariates_cb %>% subset(PM25DALYY_01 >= 0), aes(x=PM25DALYY_01, y=Mono)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="PM2.5 A exposure") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

#Bcells
ggplot(covariates_cb %>% subset(PM25DALYY_01 >= 0), aes(x=PM25DALYY_01, y=Bcell)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="PM2.5 A exposure") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

#natural killer cells
ggplot(covariates_cb %>% subset(PM25DALYY_01 >= 0), aes(x=PM25DALYY_01, y=NK)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="PM2.5 A exposure") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

#nuclear RBCs
ggplot(covariates_cb %>% subset(PM25DALYY_01 >= 0), aes(x=PM25DALYY_01, y=nRBC)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="PM2.5 A exposure") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())
```


CBMC proportions vs prenatal PM2.5 B exposure
```{r cbmc_pm2.5_B}

#cd4t cells
ggplot(covariates_cb, aes(x=PM25DALbYY_01, y=CD4T)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="PM2.5 exposure B") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

#cd8t cells
ggplot(covariates_cb, aes(x=PM25DALbYY_01, y=CD8T)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="PM2.5 exposure B") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

#mononuclear cells
ggplot(covariates_cb, aes(x=PM25DALbYY_01, y=Mono*100)) +
  geom_point(col="#75A2D9", size=3, alpha=0.7) +
  geom_smooth(method='lm', se=FALSE, col="black") +
  stat_cor(method = "pearson", size=8, label.y = 55) +
  labs(x="Average prenatal PM2.5 B exposure (ug/m3)", y="% Monocytes") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank(),
        axis.text=element_text(size=18))

#Bcells
ggplot(covariates_cb, aes(x=PM25DALbYY_01, y=Bcell)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="PM2.5 exposure B") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

#natural killer cells
ggplot(covariates_cb, aes(x=PM25DALbYY_01, y=NK)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="PM2.5 exposure B") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

#nuclear RBCs
ggplot(covariates_cb, aes(x=PM25DALbYY_01, y=nRBC)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="PM2.5 exposure B") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())
```

NO2 vs PM2.5 A.
```{r no2_pm2.5A}
#cd4t cells
ggplot(covariates_cb %>% subset(PM25DALYY_01 >= 0), aes(x=PM25DALYY_01, y=no2_preg_entire)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="PM2.5 A exposure",
       y="Prenatal NO2 exposure") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())
```

NO2 vs PM2.5 B.
```{r no2_pm2.5B}
#cd4t cells
ggplot(covariates_cb, aes(x=PM25DALbYY_01, y=no2_preg_entire)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="PM2.5 B exposure",
       y="Prenatal NO2 exposure") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())
```


Prenatal NO2 vs study site.
```{r no2_studysite}
ggplot(covariates_cb, aes(x=as.factor(studycentre), y=no2_preg_entire, fill=studycentre)) +
  geom_boxplot() +
  scale_fill_manual(values=c("#EEF0FF", "#BCD6FB", "#75A2D9", "#27497F")) +
  geom_jitter(height=0, width=0.3) +
  #geom_smooth(method='lm', se=FALSE) +
  #stat_cor(method = "pearson", size=5) +
  labs(x="Study site", y=bquote('Average prenatal'~ NO[2] ~(μg/m^3)))+
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank(),
        legend.position="none") +
      geom_signif(comparisons = list(c("Winnipeg", "Vancouver")), 
              map_signif_level=F, col="black",
              y_position= 26,
              annotation = c("***"),
              textsize = 10) +
      geom_signif(comparisons = list(c("Winnipeg", "Toronto")), 
              map_signif_level=F, col="black",
              y_position = 31,
              annotation = c("***"),
              textsize = 10) +
      geom_signif(comparisons = list(c("Winnipeg", "Edmonton")), 
              map_signif_level=F, col="black", 
              y_position=36,
              annotation = c("***"),
              textsize = 10) +
  ylim(0,40)
  

#anova for effects
no2.studycentre <- lm(no2_preg_entire ~ studycentre, covariates_cb)
anova(no2.studycentre)
no2.studycentre.aov <- aov(no2_preg_entire ~ studycentre, covariates_cb)
no2.studycentre.tukey <- TukeyHSD(no2.studycentre.aov)
no2.studycentre.tukey
```



PM2.5 A vs study site.
```{r no2_studysite}
ggplot(covariates_cb %>% subset(PM25DALYY_01 >= 0), 
       aes(x=as.factor(studycentre), y=PM25DALYY_01, fill=studycentre)) +
  geom_boxplot() +
  scale_fill_manual(values=c("#EEF0FF", "#BCD6FB", "#75A2D9", "#27497F")) +
  geom_jitter(height=0, width=0.3) +
  #geom_smooth(method='lm', se=FALSE) +
  #stat_cor(method = "pearson", size=5) +
  labs(x="Study site", y="PM2.5 A")+
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank(),
        legend.position="none") +
      geom_signif(comparisons = list(c("Winnipeg", "Toronto")), 
              map_signif_level=F, col="black",
              y_position = 10,
              annotation = c("***"),
              textsize = 10) +
      geom_signif(comparisons = list(c("Winnipeg", "Edmonton")), 
              map_signif_level=F, col="black", 
              y_position=13,
              annotation = c("***"),
              textsize = 10) +
  ylim(0,15)
  

#anova for effects
pm2.5a.studycentre <- lm(PM25DALYY_01 ~ studycentre, covariates_cb %>% subset(PM25DALYY_01 >= 0))
anova(pm2.5a.studycentre)
pm2.5a.studycentre.aov <- aov(PM25DALYY_01 ~ studycentre, covariates_cb %>% subset(PM25DALYY_01 >= 0))
pm2.5a.studycentre.tukey <- TukeyHSD(pm2.5a.studycentre.aov)
pm2.5a.studycentre.tukey
```



PM2.5 B vs study site.
```{r no2_studysite}
ggplot(covariates_cb, 
       aes(x=as.factor(studycentre), y=PM25DALbYY_01, fill=studycentre)) +
  geom_boxplot() +
  scale_fill_manual(values=c("#EEF0FF", "#BCD6FB", "#75A2D9", "#27497F")) +
  geom_jitter(height=0, width=0.3) +
  #geom_smooth(method='lm', se=FALSE) +
  #stat_cor(method = "pearson", size=5) +
  labs(x="Study site", y="PM2.5 B")+
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank(),
        legend.position="none") +
      geom_signif(comparisons = list(c("Winnipeg", "Toronto")), 
              map_signif_level=F, col="black",
              y_position = 13,
              annotation = c("**"),
              textsize = 10) +
      geom_signif(comparisons = list(c("Winnipeg", "Edmonton")), 
              map_signif_level=F, col="black", 
              y_position=22,
              annotation = c("***"),
              textsize = 10) +
    geom_signif(comparisons = list(c("Toronto", "Edmonton")), 
              map_signif_level=F, col="black", 
              y_position=16,
              annotation = c("***"),
              textsize = 10) +
      geom_signif(comparisons = list(c("Vancouver", "Edmonton")), 
              map_signif_level=F, col="black", 
              y_position=19,
              annotation = c("***"),
              textsize = 10) +
        geom_signif(comparisons = list(c("Vancouver", "Toronto")), 
              map_signif_level=F, col="black", 
              y_position=10,
              annotation = c("***"),
              textsize = 10) +
  ylim(2.5,25)
  

#anova for effects
pm2.5b.studycentre <- lm(PM25DALbYY_01 ~ studycentre, covariates_cb)
anova(pm2.5b.studycentre)
pm2.5b.studycentre.aov <- aov(PM25DALbYY_01 ~ studycentre, covariates_cb)
pm2.5b.studycentre.tukey <- TukeyHSD(pm2.5b.studycentre.aov)
pm2.5b.studycentre.tukey
```

Monocytes vs prenatal NO2 exposure
```{r mono_no2}

#mononuclear cells
ggplot(covariates_cb, aes(x=no2_preg_entire, y=Mono)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Adjusted pregnancy No2 ") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())
```

Monocytes vs pm2.5 B exposure
```{r mono_pm2.5b}

#mononuclear cells
ggplot(covariates_cb, aes(x=PM25DALbYY_01, y=Mono)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="PM2.5 B exposure") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())
```

Birth weight vs pm2.5 B exposure
```{r birthweight_pm2.5b}
ggplot(covariates_cb, aes(x=PM25DALbYY_01, y=weight_birth*1000)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="PM2.5 B exposure", y= "Birth weight (g)") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

#coloured by birth weight
ggplot(covariates_cb, aes(x=PM25DALbYY_01, y=weight_birth*1000)) +
  geom_point(aes(col=studycentre)) +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="PM2.5 B exposure", y= "Birth weight (g)") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

#coloured by mod
#coloured by birth weight
ggplot(covariates_cb, aes(x=PM25DALbYY_01, y=weight_birth*1000)) +
  geom_point(aes(col=mod_cv)) +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="PM2.5 B exposure", y= "Birth weight (g)") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())
```

Depression 36 weeks vs pm2.5 B exposure
```{r csed36wk_pm2.5b}
ggplot(covariates_cb, aes(x=PM25DALbYY_01, y=csed_36wk)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="PM2.5 B exposure", y= "CSED") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

#coloured by study centre
ggplot(covariates_cb, aes(x=PM25DALbYY_01, y=csed_36wk)) +
  geom_point(aes(col=studycentre)) +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="PM2.5 B exposure", y= "CSED") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

#coloured by total income
ggplot(covariates_cb, aes(x=PM25DALbYY_01, y=csed_36wk)) +
  geom_point(aes(col=total_income)) +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="PM2.5 B exposure", y= "CSED") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())
```


Maternal smoking at 18 wk vs pm2.5 B exposure
```{r smoking18wk_pm2.5b}
ggplot(covariates_cb, aes(y=PM25DALbYY_01, x=maternal_smoking_18wk)) +
  geom_point() +
  #geom_smooth(method='lm', se=FALSE) +
  #stat_cor(method = "pearson", size=10) +
  labs(y="PM2.5 B exposure", x= "Maternal_smoking") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

```

CD4t vs gestational age
```{r cd4t_ga}
ggplot(covariates_cb, aes(x=gestational_days, y=CD4T)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Gestational days", y= "CD4T") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())
```

CD4T vs birth weight
```{r cd4t_birthweight}
ggplot(covariates_cb, aes(x=weight_birth*1000, y=CD4T)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Birth weight (g)", y= "CD4T") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

#colour by mod
ggplot(covariates_cb, aes(x=weight_birth*1000, y=CD4T)) +
  geom_point(aes(col=mod_cv)) +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Birth weight (g)", y= "CD4T") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())
```

CD4t vs MOD
```{r cd4t_mod}
ggplot(covariates_cb, aes(y=gestational_days, x=mod_cv)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Method of delivery", y= "CD4T") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank()) +
    geom_signif(comparisons = list(c("vaginal", "caesarean")), 
              map_signif_level=F, col="black", 
              annotation = c("t = -4.0594, p-value = 0.0001314"),
              textsize = 5)


ttest.sexcd4t <- t.test(covariates_cb %>% subset(mod_cv=="vaginal") %>% select(CD4T), 
                  covariates_cb %>% subset(mod_cv=="caesarean") %>% select(CD4T),
                  paired=FALSE,
                  alternative = "two.sided")
```

Monocytes vs birth weight
```{r mono_birthweight}
ggplot(covariates_cb, aes(x=weight_birth*1000, y=Mono)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Birth weight (g)", y= "Mono") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

#colour by mod
ggplot(covariates_cb, aes(x=weight_birth*1000, y=Mono)) +
  geom_point(aes(col=mod_cv)) +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Birth weight (g)", y= "Mono") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

#colour by study centre
ggplot(covariates_cb, aes(x=weight_birth*1000, y=Mono)) +
  geom_point(aes(col=studycentre)) +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Birth weight (g)", y= "Mono") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())
```


Monocytes vs studycentre
```{r studycentre_mod}
ggplot(covariates_cb, aes(y=Mono, x=studycentre)) +
  geom_boxplot(aes(fill=studycentre)) +
  scale_fill_manual(values=c("#EEF0FF", "#BCD6FB", "#75A2D9", "#27497F")) +
  geom_jitter(height=0, width=0.3) +
  #geom_smooth(method='lm', se=FALSE) +
  #stat_cor(method = "pearson", size=5) +
  labs(x="Study site", y="Monocytes")+
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank(),
        legend.position="none") +
      geom_signif(comparisons = list(c("Winnipeg", "Vancouver")), 
              map_signif_level=F, col="black",
              y_position= 0.65,
              annotation = c("*"),
              textsize = 10) +
      geom_signif(comparisons = list(c("Winnipeg", "Toronto")), 
              map_signif_level=F, col="black",
              y_position = 0.8,
              annotation = c("*"),
              textsize = 10) +
      geom_signif(comparisons = list(c("Winnipeg", "Edmonton")), 
              map_signif_level=F, col="black", 
              y_position=0.95,
              annotation = c("***"),
              textsize = 10) +
  ylim(0,1)

mono.studycentre <- lm(Mono ~ studycentre, covariates_cb)
anova(mono.studycentre)
mono.studycentre.aov <- aov(Mono ~ studycentre, covariates_cb)
mono.studycentre.tukey <- TukeyHSD(mono.studycentre.aov)
mono.studycentre.tukey
```

Monocytes vs total income
```{r mono_income}
ggplot(covariates_cb, aes(y=Mono, x=total_income)) +
  geom_boxplot() +
  geom_jitter(height=0, width=0.3) +
  #geom_smooth(method='lm', se=FALSE) +
  #stat_cor(method = "pearson", size=5) +
  labs(x="total_income", y="Monocytes")+
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank(),
        legend.position="none",
        axis.text.x = element_text(angle=90)) 

```


Bcell vs ses canada rank
```{r mono_income}
ggplot(covariates_cb, aes(y=Bcell, x=ses_canada_rank)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="SES canada rank", y="Monocytes")+
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank(),
        legend.position="none",
        axis.text.x = element_text(angle=90)) 
```

nRBC vs MOD
```{r nRBC_mod}
ggplot(covariates_cb, aes(y=nRBC, x=mod_cv)) +
  geom_boxplot(aes(fill=mod_cv)) +
  geom_jitter(height=0, width=0.3) +
  scale_fill_manual(values=c("#EEF0FF", "#75A2D9")) +
  labs(x="Method of delivery", y= "nRBC") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank(),
        legend.position = "none") +
    geom_signif(comparisons = list(c("vaginal", "caesarean")), 
              map_signif_level=F, col="black", 
              annotation = c("t = 2.0563, p-value = 0.04178"),
              textsize = 5)


ttest.modnrbc <- t.test(covariates_cb %>% subset(mod_cv=="vaginal") %>% select(nRBC), 
                  covariates_cb %>% subset(mod_cv=="caesarean") %>% select(nRBC),
                  paired=FALSE,
                  alternative = "two.sided")
```


NK vs MOD
```{r NK_mod}
ggplot(covariates_cb, aes(y=NK, x=mod_cv)) +
  geom_boxplot(aes(fill=mod_cv)) +
  geom_jitter(height=0, width=0.3) +
  scale_fill_manual(values=c("#EEF0FF", "#75A2D9")) +
  labs(x="Method of delivery", y= "NK") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank(),
        legend.position = "none") +
    geom_signif(comparisons = list(c("vaginal", "caesarean")), 
              map_signif_level=F, col="black", 
              annotation = c("t = 3.457, p-value = 0.000881"),
              textsize = 5)


ttest.modNK <- t.test(covariates_cb %>% subset(mod_cv=="vaginal") %>% select(NK), 
                  covariates_cb %>% subset(mod_cv=="caesarean") %>% select(NK),
                  paired=FALSE,
                  alternative = "two.sided")
```


NK vs gestational age
```{r nk_ga}
ggplot(covariates_cb, aes(x=gestational_days, y=NK)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Gestational days", y= "NK") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

```


NK vs secondhand smoke
```{r nk_ga}
ggplot(covariates_cb %>% subset(prenatal_shs == 0 | prenatal_shs == 1), aes(x=prenatal_shs, y=NK)) +
  geom_boxplot(aes(fill=prenatal_shs)) +
  geom_jitter(height=0, width=0.3) +
  scale_fill_manual(values=c("#EEF0FF", "#75A2D9")) +
  labs(x="Secondhand smoke", y= "NK") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank(),
        legend.position = "none") +
    geom_signif(comparisons = list(c("0", "1")), 
              map_signif_level=F, col="black", 
              annotation = c("t = 3.6745, p-value = 0.001575"),
              textsize = 5)


ttest.shsNK <- t.test(covariates_cb %>% subset(prenatal_shs==0) %>% select(NK), 
                  covariates_cb %>% subset(prenatal_shs==1) %>% select(NK),
                  paired=FALSE,
                  alternative = "two.sided")

```

Genotyping pc 3 vs pm2.5b
```{r genotypingpc2_pm2.5b}
ggplot(covariates_cb, aes(x=genotyping.PC3, y=PM25DALbYY_01)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Genotyping PC3", y= "PM2.5 B exposure") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())


```














### Correlation matrix for participants in the prenatal time point (and with missing values filled in with means)


Load cell type PCs
```{r cb_celltype_PCs}
load(here("output_data", "deconvolution", "2020-11-10_CBMC_PCs.RData"))

#rename rows of pcs
identical(rownames(cb_pcs), rownames(cb_pdata)) #True
rownames(cb_pcs) <- cb_pdata$Sample_Label


#subset pcs for genosub
cb_pcs_geno <- cb_pcs[rownames(genosub), ]
dim(cb_pcs_geno) #131


#rename colums
colnames(cb_pcs_geno) <- paste("cbmc.", colnames(cb_pcs_geno), sep="")

#check if rownames are identical to genosub
identical(rownames(cb_pcs_geno), rownames(genosub)) #TRUE

```


Now only include children used in linear regressions with nameans data.
```{r cb_pvals_101}
#load covariates with na means
load(here("output_data", "covariates", "2020-11-12_CHILD_covariates_na_with_means.Rdata"))

#population row names with sample ids
rownames(covariates_nameans) <- covariates_nameans$sampleid

#sub covariates according to geno data
covariates_nameans_geno <- covariates_nameans[rownames(genosub),]

#check order
identical(rownames(covariates_nameans_geno), rownames(genosub)) #True

#sub cell counts according to genotyping
child_fscbc_ecc2_cb_df_sub <- child_fscbc_ecc2_cb_df[rownames(genosub), ]

#check order
identical(rownames(child_fscbc_ecc2_cb_df_sub), rownames(genosub)) #True

#subset pdata
cb_pdata$same_names <- rownames(cb_pdata)
rownames(cb_pdata) <- cb_pdata$Sample_Label
cb_pdata_geno <- cb_pdata[rownames(genosub), ]

#check size and order
dim(cb_pdata_geno)
identical(rownames(cb_pdata_geno), rownames(genosub)) #TRUE

#rename row and run columns
cb_pdata_geno$run <- as.factor(cb_pdata_geno$Run)
cb_pdata_geno$row <- as.numeric(as.factor(substr(cb_pdata_geno$Sentrix_Position, 1, 3)))

#cbind
covariates_nameans_geno_ctpc_tech <- cbind(covariates_nameans_geno, 
                                           genosub,
                                           child_fscbc_ecc2_cb_df_sub, 
                                           cb_pcs_geno,
                                           cb_pdata_geno[,c("run", "row")])

covariates_nameans_geno_ctpc_tech_cc <- covariates_nameans_geno_ctpc_tech[
  complete.cases(covariates_nameans_geno_ctpc_tech[,c( "no2_preg_entire", 
                                             "prenatal_maternal_smoking", 
                                             "sex", "gestational_days", 
                                             "pss_18wk",
                                             "csed_18wk", 
                                             "maternal_education_length")]), ]

dim(covariates_nameans_geno_ctpc_tech_cc) #101 126
```


Get pvalues for covariates_cb101 
```{r get-pvals}
#sub for covariates of interested
covariates_nameans_geno_ctpc_tech_cc_sub <- 
  subset(covariates_nameans_geno_ctpc_tech_cc, 
         select=c(no2_preg_entire, 
                  prenatal_maternal_smoking, 
                  sex, gestational_days, 
                  pss_18wk,csed_18wk, 
                  maternal_education_length,
                  cbmc.PC1, cbmc.PC2, cbmc.PC3,
                  cbmc.PC4, cbmc.PC5,
                  genotyping.PC1, genotyping.PC2,
                  genotyping.PC3,
                  run, row,studycentre))

#pvals calcs
covariates_nameans_geno_ctpc_tech_cc_sub_pval <- pval2(covariates_nameans_geno_ctpc_tech_cc_sub)
```


Calculate correlations between metadata variables using cor2 function above.  
```{r calc_covariate_corr}
#correlation calcs
covariates_nameans_geno_ctpc_tech_cc_sub_corr <- cor2(covariates_nameans_geno_ctpc_tech_cc_sub)

#set missing values (999) to NA - could have probably done this in the cor2 function
covariates_nameans_geno_ctpc_tech_cc_sub_corr[covariates_nameans_geno_ctpc_tech_cc_sub_corr == 999] <- NA
``` 



```{r corrplot_cb101}
corrplot(covariates_nameans_geno_ctpc_tech_cc_sub_corr,
         pch = 8,
         pch.cex = 1.5,
         type = "lower", 
         p.mat = covariates_nameans_geno_ctpc_tech_cc_sub_pval,
         insig = "blank",
         lab=TRUE,
         tl.cex =6, 
         colors = c("#6D9EC1", "white", "#E46726")) +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        legend.key.height = unit(0.5, 'cm'),
        legend.key.width = unit(0.2, 'cm'),
        legend.text = element_text(size=5),
        legend.title = element_text(size=7),
        legend.position="left") +
  scale_y_discrete(labels = c("Prenatal NO2", "Maternal smoking", "Sex", 
                              "Gestational age", "Maternal stress", "Maternal depression",
                              "Maternal education length", 
                              "Cell type PC1", "Cell type PC2", "Cell type PC3",
                              "Cell type PC4", "Cell type PC5",
                              "Genotyping PC1", "Genotyping PC2", "Genotyping PC3",
                              "Run", "Row"),
                   position = "right") +
  scale_x_discrete(labels = c("Maternal smoking", "Sex", 
                              "Gestational age", "Maternal stress", "Maternal depression",
                              "Maternal education length", 
                              "Cell type PC1", "Cell type PC2", "Cell type PC3",
                              "Cell type PC4", "Cell type PC5",
                              "Genotyping PC1", "Genotyping PC2", "Genotyping PC3",
                              "Run", "Row", "Study centre")) 


ggsave("R:/Jones/People/Samantha Lee/Projects/CHILD/CHILD_air_pollution/figures/2021-01-27_CHILD_cb101_ctpc_corrplot.tiff",
       device="tiff",
       height=3,
       width=6,
       units="in")
```


##### Examine specific covariate relationship in prenatal 101

Monocytes vs prenatal NO2 exposure
```{r mono_no2_cb101}

#mononuclear cells
ggplot(covariates_nameans_geno_cc_sub, aes(x=no2_preg_entire, y=Mono*100)) +
  geom_point(col="#254A90", size=1) + 
  geom_smooth(method='lm', se=FALSE, size=0.25, col="red") +
  stat_cor(method = "pearson", size=3,
           label.x=20, label.y=45) +
  labs(x=bquote("Prenatal" ~NO[2]~ "(ppb)"), 
       y="Monocytes (%)") +
  theme_bw() + 
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.text.y = element_text(size=6),
        axis.text.x = element_text(size=6),
        axis.title.x = element_text(size=8),
        axis.title.y = element_text(size=8)) 

    ggsave( filename="2021-01-21_CHILD_cb101_monovsno2.tiff",
          device = "tiff",
          path =  here("figures", "covariates" ),
          width = 2,
          height = 2,
          units = "in",
          limitsize = TRUE)

```


NK cells vs maternal smoking
```{r nk_smoke_cb101}
#reorder and rename factor levels for plotting
covariates_nameans_geno_cc$prenatal_maternal_smoking <-
  factor(covariates_nameans_geno_cc$prenatal_maternal_smoking,
         levels = c("1", "0"))
levels(covariates_nameans_geno_cc$prenatal_maternal_smoking) <- c("Yes", "No")


ggplot(covariates_nameans_geno_cc, aes(y=NK*100, x=prenatal_maternal_smoking, 
                                       fill=prenatal_maternal_smoking)) +
  geom_boxplot() + 
  geom_jitter(height=0, width=0.3, size=1) +
  scale_fill_manual(values=c("#254A90", "#92C5EB")) +
  labs(x="Prenatal maternal smoking", y= "NK cells (%)") +
    theme_bw() + 
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.text.y = element_text(size=6),
        axis.text.x = element_text(size=6),
        axis.title.x = element_text(size=8),
        axis.title.y = element_text(size=8),
        legend.position = "none") +
    geom_signif(comparisons = list(c("Yes", "No")), 
              map_signif_level=F, col="black", 
              annotation = c("p-value = 0.048, r = 0.16"),
              textsize = 2) +
  ylim(0, 30)


 ggsave( filename="2021-01-21_CHILD_cb101_nkvssmoke.tiff",
          device = "tiff",
          path =  here("figures", "covariates" ),
          width = 2,
          height = 2,
          units = "in",
          limitsize = TRUE)

```


NK cells vs gestational age
```{r nk_gAge_cb101}
ggplot(covariates_nameans_geno_cc_sub, aes(x=gestational_days, y=NK*100)) +
  geom_point(col="#254A90", size=1) + 
  geom_smooth(method='lm', se=FALSE, size=0.25, col="red") +
  stat_cor(method = "pearson", size=3) +
  labs(x=bquote("Gestational age (days)"), 
       y="NK cells (%)") +
  theme_bw() + 
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.text.y = element_text(size=6),
        axis.text.x = element_text(size=6),
        axis.title.x = element_text(size=8),
        axis.title.y = element_text(size=8)) 

    ggsave( filename="2021-01-21_CHILD_cb101_nkvsgestage.tiff",
          device = "tiff",
          path =  here("figures", "covariates" ),
          width = 2,
          height = 2,
          units = "in",
          limitsize = TRUE)
```


CD4T vs gestational age
```{r cd4t_gAge_cb101}
ggplot(covariates_nameans_geno_cc_sub, aes(x=gestational_days, y=CD4T*100)) +
  geom_point(col="#254A90", size=1) + 
  geom_smooth(method='lm', se=FALSE, size=0.25, col="red") +
  stat_cor(method = "pearson", size=3) +
  labs(x=bquote("Gestational age (days)"), 
       y="CD4T cells (%)") +
  theme_bw() + 
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.text.y = element_text(size=6),
        axis.text.x = element_text(size=6),
        axis.title.x = element_text(size=8),
        axis.title.y = element_text(size=8)) 

    ggsave( filename="2021-01-21_CHILD_cb101_cd4tvsgestage.tiff",
          device = "tiff",
          path =  here("figures", "covariates" ),
          width = 2,
          height = 2,
          units = "in",
          limitsize = TRUE)
```

nRBC vs stress
```{r nrbc_stress_cb101}
ggplot(covariates_nameans_geno_cc_sub, aes(x=pss_18wk, y=nRBC*100)) +
  geom_point(col="#254A90", size=1) + 
  geom_smooth(method='lm', se=FALSE, size=0.25, col="red") +
  stat_cor(method = "pearson", size=3) +
  labs(x=bquote("Maternal stress at 18 weeks gestation"), 
       y="nucleated RBCs (%)") +
  theme_bw() + 
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.text.y = element_text(size=6),
        axis.text.x = element_text(size=6),
        axis.title.x = element_text(size=8),
        axis.title.y = element_text(size=8)) 

    ggsave( filename="2021-01-21_CHILD_cb101_nrbcvsstress.tiff",
          device = "tiff",
          path =  here("figures", "covariates" ),
          width = 2,
          height = 2,
          units = "in",
          limitsize = TRUE)
```


CD8T vs stress
```{r cd8t_stress_cb101}
ggplot(covariates_nameans_geno_cc_sub, aes(x=pss_18wk, y=CD8T*100)) +
  geom_point(col="#254A90", size=1) + 
  geom_smooth(method='lm', se=FALSE, size=0.25, col="red") +
  stat_cor(method = "pearson", size=3) +
  labs(x=bquote("Maternal stress at 18 weeks gestation"), 
       y="CD8T cells(%)") +
  theme_bw() + 
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.text.y = element_text(size=6),
        axis.text.x = element_text(size=6),
        axis.title.x = element_text(size=8),
        axis.title.y = element_text(size=8)) 

    ggsave( filename="2021-01-21_CHILD_cb101_cd8tvsstress.tiff",
          device = "tiff",
          path =  here("figures", "covariates" ),
          width = 2,
          height = 2,
          units = "in",
          limitsize = TRUE)
```