---
title: "CHILD145 covariate matrices"
author: "SL"
date: "30/01/2020"
output: html_document
---

*Purpose*: The purpose of this script is to examine the correlation between prenatal covariates. This will help in building linear models to examine prenatal specific changes. 

Read libraries in.
```{r libraries, warnings=FALSE, message=FALSE}
library(tidyverse)
library(plyr)
library(ggpubr)
library(here)
```

Load in CHILD covariate data.
```{r covariates}
load(file=here("output_data", "covariates", "2020-11-03_CHILD_all_covariates.Rdata"))
```

Read in cell type estimates.  
```{r load_deconvolution}
#load deconvolution
load(file=here("output_data", "deconvolution", "2021-01-07_CBMC_PBMC_deconvolution.Rdata"))
```

Read in genotyping PCs
```{r genotyping}
genotyping <- read.csv("R:/Jones/People/Samantha Lee/Computational/CHILD/input_data/CHILD_subjects_Qced_first10PCS_Duan.csv")

#make rownames sample names then rmove this row
rownames(genotyping) <- genotyping$FID
genotyping <- subset(genotyping, select=-c(FID))

#subset genotyping for REEGLE children
genosub <- genotyping[rownames(genotyping) %in% covariates$sampleid,]

#rename columns of genotyping data for clarity
colnames(genosub) <- paste("genotyping.", colnames(genosub), sep="")
```

Load pData.  
```{r load_pData}
#this pdata has bad samples removed and sample mix-up corrected
load(file = here("output_data", "preprocessed_data", "2021-01_14_CHILD_preprocessed_betas_pdata_annotation.Rdata"))
  
#subset pData into CBMCs (cord blood)
cb_pdata <- subset(pdata_nodups, Tissue == "C")
dim(cb_pdata) #144 18
```


Convert deconvolution estimates to dataframes.
```{r convert_deconvo_to_df}
#cordblood cbmc deconvo
child_fscbc_ecc2_cb_df <- as.data.frame(child_fscbc_ecc2_cb$counts)

#subset out samples to be used for analysis (no duplicates)
child_fscbc_ecc2_cb_df <- child_fscbc_ecc2_cb_df[rownames(child_fscbc_ecc2_cb_df) %in% rownames(cb_pdata),]

#check if rownames in same order
identical(rownames(child_fscbc_ecc2_cb_df), rownames(cb_pdata)) #true

#rename cell cunt rownames to sample id
rownames(child_fscbc_ecc2_cb_df) <- cb_pdata$Sample_Label

#check names
rownames(child_fscbc_ecc2_cb_df) #144 7 
```

Subset covariate data for cord blood since one sample was removed
```{r subset_covariates_cb}
#subset covariate data according to age and then combined with predicted cell proportions
covariates_cb <- covariates[covariates$sampleid %in% as.character(cb_pdata$Sample_Label),]
dim(covariates_cb) #144 113

#combine covaraite master data and cell estimates 
#check if they are identical 
identical(as.character(covariates_cb$sampleid), rownames(child_fscbc_ecc2_cb_df)) #true
covariates_cb <- cbind(covariates_cb, child_fscbc_ecc2_cb_df)

#combine covariate data with genotyping data
rownames(covariates_cb)  <- covariates_cb$sampleid
covariates_cb <- merge(covariates_cb, genosub[,2:4], by = "row.names", all.x = TRUE)

#check size
dim(covariates_cb) #144

#repopulate rownames
rownames(covariates_cb) <- as.character(covariates_cb$sampleid)
```



## Correlation heatmap between all covariates and cell types 


### Create heatmap of cell types vs covariates.

Load covariate correlation matrix code.

```{r calc_correlations_function}

cor2 = function(df){
  
  print("checking dataframe clases")
  stopifnot(inherits(df, "data.frame"))
  stopifnot(sapply(df, class) %in% c("integer"
                                     , "numeric"
                                     , "factor"
                                     , "character"))
  
  print("calculating correlation matrix")
  cor_fun <- function(pos_1, pos_2){

    # both are numeric
    if(class(df[[pos_1]]) %in% c("integer", "numeric") &&
       class(df[[pos_2]]) %in% c("integer", "numeric")){
      print("both are numeric")
      print(paste(colnames(df)[[pos_1]], colnames(df)[[pos_2]]))
      r <- stats::cor(df[[pos_1]], df[[pos_2]], use = "pairwise.complete.obs") #pairwise.complete.obs
      p <- unname((summary(lm(df[[pos_1]] ~ df[[pos_2]]))$coefficients[,4])[2])

    }
    
    #one is numberic the other is factor/character
    #must use sum of squares type 3 because groups are not of the same size
    #calculates ANOVA
    #then calcualtes eta-squared: measures the proportion of the total variance in a      dependent variable that
    #is associated with the membership of different groups defined by an independent      variable.
    #takes square root to get correlation
    if(class(df[[pos_1]]) %in% c("integer", "numeric") &&
       class(df[[pos_2]]) %in% c("factor", "character")){
      
      #print statements for debugging
      print("first is numeric, second is factor")
      print(paste(colnames(df)[[pos_1]], colnames(df)[[pos_2]]))
      
      #check factor levels of complete cases
      print("checking levels of pos_2 factor")
      tmp <- data.frame(df[[pos_1]], df[[pos_2]], row.names = NULL)
      complete <- complete.cases(tmp)
      tmp2 <- tmp[complete,]
      tmp2[,2] <- as.factor(tmp2[,2])
      
      #if statement to catch cases where dropped values result in a factor with
      #one or fewer levels
      if(is.factor(tmp2[,2]) & (nlevels(droplevels(tmp2[,2]))<2)){
        r <- 999
      } else {
        #anova for correlation
        r <- stats::aov(df[[pos_1]] ~ as.factor(df[[pos_2]])) %>%
          lsr::etaSquared(type=3) %>% `[`(1) %>% sqrt()
        
        #anova for p-pval
        lm_p <- lm(df[[pos_1]] ~ as.factor(df[[pos_2]]))
        p <- (anova(lm_p))$`Pr(>F)`[1]
        
      }
      rm(tmp,tmp2)
    }
    
    
    
    if(class(df[[pos_2]]) %in% c("integer", "numeric") &&
       class(df[[pos_1]]) %in% c("factor", "character")){
      
      #print statements for debugging
      print("first is factor, second is numeric")
      print(paste(colnames(df)[[pos_1]], colnames(df)[[pos_2]]))
      
      #check factor levels of complete cases
      print("checking levels of pos_1 factor")
      tmp <- data.frame(df[[pos_1]], df[[pos_2]], row.names = NULL)
      complete <- complete.cases(tmp)
      tmp2 <- tmp[complete,]
      tmp2[,1] <- as.factor(tmp2[,1])
      
      #if statement to catch cases where dropped values result in a factor with
      #one or fewer levels
      if(is.factor(tmp2[,1]) && (nlevels(droplevels(tmp2[,1]))<2)){
        r <- 999
      } else {
        r <- stats::aov(df[[pos_2]] ~ as.factor(df[[pos_1]])) %>%
          lsr::etaSquared(type=3) %>% `[`(1) %>% sqrt()
        
        #anova for p-pval
        lm_p <- lm(df[[pos_2]] ~ as.factor(df[[pos_1]]))
        p <- (anova(lm_p))$`Pr(>F)`[1]
        
      }
      rm(tmp,tmp2)
    }
    
    
  
    #both are factor/character
    if(class(df[[pos_1]]) %in% c("factor", "character") &&
       class(df[[pos_2]]) %in% c("factor", "character")){
      
      #print statement for debugging
      print("both are characters")
      print(paste(colnames(df)[[pos_1]], colnames(df)[[pos_2]]))
      
       #check factor levels of complete cases
      print("checking levels of of both positions")
      tmp <- data.frame(df[[pos_1]], df[[pos_2]], row.names = NULL)
      complete <- complete.cases(tmp)
      tmp2 <- tmp[complete,]
      tmp2[,1] <- as.factor(tmp2[,1])
      tmp2[,2] <- as.factor(tmp2[,2])
      
      #if statement to catch cases where dropped values result in a factor with
      #one or fewer levels
      if(is.factor(tmp2[,1]) && (nlevels(droplevels(tmp2[,1]))<2)){
        r <- 999
      } else {
        if(is.factor(tmp2[,2]) && (nlevels(droplevels(tmp2[,2]))<2)){
          r <-999
        } else { 
          r <- lsr::cramersV(df[[pos_1]], df[[pos_2]], simulate.p.value = TRUE)
          #get p value
          fish_table <- table(df[[pos_1]], df[[pos_2]])
          p <- fisher.test(fish_table, simulate.p.value=T)$p.value
        }
      }
      rm(tmp,tmp2)
    }
    
    return(r)
  } 
  
  cor_fun <- Vectorize(cor_fun)
  
  # now compute corr matrix
  corrmat <- outer(1:ncol(df)
                   , 1:ncol(df)
                   , function(x, y) cor_fun(x, y)
  )
  
  rownames(corrmat) <- colnames(df)
  colnames(corrmat) <- colnames(df)
  return(corrmat)
}

```

Function to calculate pvalues
```{r pval2}

pval2 = function(df){
  
  print("checking dataframe clases")
  stopifnot(inherits(df, "data.frame"))
  stopifnot(sapply(df, class) %in% c("integer"
                                     , "numeric"
                                     , "factor"
                                     , "character"))
  
  print("calculating correlation matrix")
  pval_fun <- function(pos_1, pos_2){
    
    # both are numeric
    if(class(df[[pos_1]]) %in% c("integer", "numeric") &&
       class(df[[pos_2]]) %in% c("integer", "numeric")){
        
      print("both are numeric")
      
      if(colnames(df)[[pos_1]] == colnames(df)[[pos_2]]){
        #dont want to star comparisons of something against itsself
        p <- 1
      } else {
        print(paste(colnames(df)[[pos_1]], colnames(df)[[pos_2]]))
        p <- unname((summary(lm(df[[pos_1]] ~ df[[pos_2]]))$coefficients[,4])[2])
      }
    }
  
    
    #one is numberic the other is factor/character
    if(class(df[[pos_1]]) %in% c("integer", "numeric") &&
       class(df[[pos_2]]) %in% c("factor", "character")){
      
      #print statements for debugging
      print("first is numeric, second is factor")
      print(paste(colnames(df)[[pos_1]], colnames(df)[[pos_2]]))
      
      #check factor levels of complete cases
      print("checking levels of pos_2 factor")
      tmp <- data.frame(df[[pos_1]], df[[pos_2]], row.names = NULL)
      complete <- complete.cases(tmp)
      tmp2 <- tmp[complete,]
      tmp2[,2] <- as.factor(tmp2[,2])
      
      #if statement to catch cases where dropped values result in a factor with
      #one or fewer levels
      if(is.factor(tmp2[,2]) & (nlevels(droplevels(tmp2[,2]))<2)){
        p <- 999
      } else {
       if(nlevels(droplevels(tmp2[,2]))>2){
          #anova for p-pval with 3 or  more factors
          lm_p <- lm(df[[pos_1]] ~ as.factor(df[[pos_2]]))
          p <- (anova(lm_p))$`Pr(>F)`[1]
        } else{
          #ttest for 2 factors
          p <- t.test(df[[pos_1]] ~ as.factor(df[[pos_2]]),
                  alternative = "two.sided")$p.value
        }
      }
      rm(tmp,tmp2)
    }
    
    
    
    if(class(df[[pos_2]]) %in% c("integer", "numeric") &&
       class(df[[pos_1]]) %in% c("factor", "character")){
      
      #print statements for debugging
      print("first is factor, second is numeric")
      print(paste(colnames(df)[[pos_1]], colnames(df)[[pos_2]]))
      
      #check factor levels of complete cases
      print("checking levels of pos_1 factor")
      tmp <- data.frame(df[[pos_1]], df[[pos_2]], row.names = NULL)
      complete <- complete.cases(tmp)
      tmp2 <- tmp[complete,]
      tmp2[,1] <- as.factor(tmp2[,1])
      
      #if statement to catch cases where dropped values result in a factor with
      #one or fewer levels
      if(is.factor(tmp2[,1]) && (nlevels(droplevels(tmp2[,1]))<2)){
        p <- 999
      } else {
        if(nlevels(droplevels(tmp2[,1]))>2){
          #anova for p-pval with 3 or  more factors
          lm_p <- lm(df[[pos_2]] ~ as.factor(df[[pos_1]]))
          p <- (anova(lm_p))$`Pr(>F)`[1]
        } else{
          #ttest for 2 factors
          p <- t.test(df[[pos_2]] ~ as.factor(df[[pos_1]]),
                  alternative = "two.sided")$p.value
        }
      }
      rm(tmp,tmp2)
    }
    
    
  
    #both are factor/character
    if(class(df[[pos_1]]) %in% c("factor", "character") &&
       class(df[[pos_2]]) %in% c("factor", "character")){
      
      #print statement for debugging
      print("both are characters")
      print(paste(colnames(df)[[pos_1]], colnames(df)[[pos_2]]))
      
       #check factor levels of complete cases
      print("checking levels of of both positions")
      tmp <- data.frame(df[[pos_1]], df[[pos_2]], row.names = NULL)
      complete <- complete.cases(tmp)
      tmp2 <- tmp[complete,]
      tmp2[,1] <- as.factor(tmp2[,1])
      tmp2[,2] <- as.factor(tmp2[,2])
      
      
      #if statement to catch cases where dropped values result in a factor with
      #one or fewer levels
      if(is.factor(tmp2[,1]) && (nlevels(droplevels(tmp2[,1]))<2)){
        p <- 999
      } else {
        if(is.factor(tmp2[,2]) && (nlevels(droplevels(tmp2[,2]))<2)){
          p <- 999
        } else {
          if(( na.omit(as.character(tmp[,1])) == na.omit(as.character(tmp[,2])))) {
            p = 1
          } else {
          #get p value
          fish_table <- table(df[[pos_1]], df[[pos_2]])
          p <- fisher.test(fish_table, simulate.p.value = T)$p.value
          }
        }
      }
      rm(tmp,tmp2)
    }
    
    return(p)
  } 
  
  pval_fun <- Vectorize(pval_fun)
  
  # now compute corr matrix
  pvalmat <- outer(1:ncol(df)
                   , 1:ncol(df)
                   , function(x, y) pval_fun(x, y)
  )
  
  rownames(pvalmat) <- colnames(df)
  colnames(pvalmat) <- colnames(df)
  return(pvalmat)
}


```

Get pvalues for covariates of interest
```{r get-pvals}


covariates_cb_sub <- subset(covariates_cb, select=c(NK, nRBC, Bcell, Mono, CD8T, CD4T,
                                                    no2_preg_entire, PM25DALYY_01, PM25DALbYY_01,
                                                    maternal_smoking_18wk, prenatal_shs,
                                                    sex, gestational_days, mod_cv, weight_birth,
                                                    pss_18wk, pss_36wk, 
                                                    csed_18wk, csed_36wk, 
                                                    maternal_education_length, paternal_education_length,
                                                    ses_community_rank, ses_canada_rank, total_income,
                                                    maternal_asthma, clinician_asthma_dx_5y, 
                                                    genotyping.PC1, genotyping.PC2, genotyping.PC3,
                                                    studycentre))

#set missing pm2.5 a values to na
covariates_cb_sub$PM25DALYY_01  <- ifelse(covariates_cb_sub$PM25DALYY_01 < 0, NA, covariates_cb_sub$PM25DALYY_01)


#correlation calcs
covariates_cb_pval <- pval2(covariates_cb_sub)

#make the matrix a dataframe
covariates_cb_pval <- as.data.frame(covariates_cb_pval)

#set all nonsig values to NA
#covariates_cb_pval[covariates_cb_pval > 0.05] <- NA


#function to get lower triangle of the correlation matrix
get_lower_tri<-function(cormat){
    cormat[upper.tri(cormat)] <- NA
    return(cormat)
  }

#get the upper triangle of the covariate correlation matrix
lower_tri_pval <- get_lower_tri(covariates_cb_pval)

#make a new column for covariate names - this is needed for putting data in long format
lower_tri_pval$covariates1 <- rownames(lower_tri_pval)

#melt the matrix to long format
melted_pmat <- reshape2::melt(lower_tri_pval, 
                                na.rm = TRUE,
                                id.vars="covariates1",
                                variable.name="covariates2",
                                value.name="pval")

melted_pmat$covariates1 <- as.factor(melted_pmat$covariates1)
melted_pmat$covariates1 <- factor(melted_pmat$covariates1,
                                  levels=c("NK", "nRBC", "Bcell", "Mono", "CD8T", "CD4T",
                                           "no2_preg_entire", "PM25DALYY_01", "PM25DALbYY_01",
                                           "maternal_smoking_18wk", "prenatal_shs",
                                           "sex", "gestational_days", "mod_cv", "weight_birth",
                                           "pss_18wk", "pss_36wk", 
                                           "csed_18wk", "csed_36wk", 
                                           "maternal_education_length", "paternal_education_length",
                                           "ses_community_rank", "ses_canada_rank", "total_income",
                                           "maternal_asthma", "clinician_asthma_dx_5y", 
                                           "genotyping.PC1", "genotyping.PC2", "genotyping.PC3",
                                           "studycentre"))


melted_pmat$covariates2 <- as.factor(melted_pmat$covariates2)
#sort
melted_pmat$covariates2 <- factor(melted_pmat$covariates2,
                                  levels=c("NK", "nRBC", "Bcell", "Mono", "CD8T", "CD4T",
                                           "no2_preg_entire", "PM25DALYY_01", "PM25DALbYY_01",
                                           "maternal_smoking_18wk", "prenatal_shs",
                                           "sex", "gestational_days", "mod_cv", "weight_birth",
                                           "pss_18wk", "pss_36wk", 
                                           "csed_18wk", "csed_36wk", 
                                           "maternal_education_length", "paternal_education_length",
                                           "ses_community_rank", "ses_canada_rank", "total_income",
                                           "maternal_asthma", "clinician_asthma_dx_5y", 
                                           "genotyping.PC1", "genotyping.PC2", "genotyping.PC3",
                                           "studycentre"))

#add star annotation
melted_pmat$pstars <- ifelse(melted_pmat$pval < 0.05, "*", " ")
```


Calculate correlations between metadata variables using cor2 function above.  
```{r calc_covariate_corr}
#correlation calcs
covariates_cb_corr <- cor2(covariates_cb_sub)

  
#custom breaks for heatmap colour scale  
breaksList = seq(-1, 1, by = 0.1)

#set missing values (999) to NA - could have probably done this in the cor2 function
covariates_cb_corr[covariates_cb_corr == 999] <- NA
#make the matrix a dataframe
covariates_cb_corr <- as.data.frame(covariates_cb_corr)




# function to get upper triangle of the correlation matrix
get_upper_tri <- function(cormat){
  cormat[lower.tri(cormat)]<- NA
  return(cormat)
}

#function to get lower triangle of the correlation matrix
get_lower_tri<-function(cormat){
    cormat[upper.tri(cormat)] <- NA
    return(cormat)
  }

#get the upper triangle of the covariate correlation matrix
lower_tri <- get_lower_tri(covariates_cb_corr)
lower_tri

#make a new column for covariate names - this is needed for putting data in long format
lower_tri$covariates1 <- rownames(lower_tri)


#melt the matrix to long format
melted_cormat <- reshape2::melt(lower_tri, 
                                na.rm = TRUE,
                                id.vars="covariates1",
                                variable.name="covariates2",
                                value.name="correlation")

melted_cormat$covariates1 <- as.factor(melted_cormat$covariates1)
melted_cormat$covariates1 <- factor(melted_cormat$covariates1,
                                    levels=c("NK", "nRBC", "Bcell", "Mono", "CD8T", "CD4T",
                                             "no2_preg_entire", "PM25DALYY_01", "PM25DALbYY_01",
                                             "maternal_smoking_18wk", "prenatal_shs",
                                             "sex", "gestational_days", "mod_cv", "weight_birth",
                                             "pss_18wk", "pss_36wk",
                                             "csed_18wk", "csed_36wk", 
                                             "maternal_education_length", "paternal_education_length",
                                             "ses_community_rank", "ses_canada_rank", "total_income",
                                             "maternal_asthma", "clinician_asthma_dx_5y", 
                                             "genotyping.PC1", "genotyping.PC2", "genotyping.PC3",
                                             "studycentre"))


melted_cormat$covariates2 <- as.factor(melted_cormat$covariates2)
#sort
melted_cormat$covariates2 <- factor(melted_cormat$covariates2,
                                    levels=c("NK", "nRBC", "Bcell", "Mono", "CD8T", "CD4T",
                                             "no2_preg_entire", "PM25DALYY_01", "PM25DALbYY_01",
                                             "maternal_smoking_18wk", "prenatal_shs",
                                             "sex", "gestational_days", "mod_cv", "weight_birth",
                                             "pss_18wk", "pss_36wk", 
                                             "csed_18wk", "csed_36wk", 
                                             "maternal_education_length", "paternal_education_length",
                                             "ses_community_rank", "ses_canada_rank", "total_income",
                                             "maternal_asthma", "clinician_asthma_dx_5y", 
                                             "genotyping.PC1", "genotyping.PC2", "genotyping.PC3",
                                             "studycentre"))


#add pstar labels to melted cormat
melted_cormat$pstars <- melted_pmat$pstars

#create heatmap with custom colours using ggplot and geom_tile
ggplot(data = melted_cormat, aes(x = covariates1, y = covariates2, fill = correlation)) +
  geom_tile() +
  geom_text(aes(label=pstars), col="grey40", nudge_y = -0.4, size=8) +
  scale_fill_gradient2(low = "blue", mid = "white", high = "red", midpoint = 0, 
                       space = "Lab", 
                       na.value = "grey50",
                       #guide = "colourbar",
                       aesthetics = "fill",
                       breaks = breaksList,
                       guide = guide_legend(keywidth=0.5, keyheight=0.5, 
                                            reverse=TRUE, label.position = "left")) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust=1, vjust=0.1, size =10),
        axis.text.y = element_text(size=10),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        panel.border = element_blank(),
        panel.grid = element_blank(),
        legend.position = "left") +
  scale_x_discrete(labels=c("NK", "nRBC", "Bcell", "Mono", "CD8T", "CD4T",
                            "NO2", "PM2.5 A", "PM2.5 B",
                            "Maternal smoking", "Secondhand smoke",
                            "Sex", "Gestational age", "Method of delivery", "Birth weight",
                            "Stress 18wk", "Stress 36wk",
                            "Depression 18wk", "Depression 36wk",
                            "Maternal education length", "Paternal education length",
                            "SES community rank", "SES Canada rank", "Total income",
                            "Maternal asthma", "Asthma dx 5 years", 
                            "Genotyping PC1", "Genotyping PC2", "Genotyping PC3",
                            "Study centre")) +
  scale_y_discrete(position = "right", 
                   labels=c("NK", "nRBC", "Bcell", "Mono", "CD8T", "CD4T",
                            "NO2", "PM2.5 A", "PM2.5 B",
                            "Maternal smoking", "Secondhand smoke",
                            "Sex", "Gestational age", "Method of delivery", "Birth weight",
                            "Stress 18wk", "Stress 36wk",
                            "Depression 18wk", "Depression 36wk",
                            "Maternal education length", "Paternal education length",
                            "SES community rank", "SES Canada rank", "Total income",
                            "Maternal asthma", "Asthma dx 5 years", 
                            "Genotyping PC1", "Genotyping PC2", "Genotyping PC3",
                            "Study centre"))
  
  ggsave("2020-11-03_CHILD_prenatal_covariate_heatplot.png",
       device="png",
       path=here("figures"),
       width=8,
       height=6,
       units="in")

  

```

## Examine specific relationships identified as significant in heat plot

CBMC proportions vs prenatal NO2 exposure
```{r cbmc_no2}

#cd4t cells
ggplot(covariates_cb, aes(x=no2_preg_entire, y=CD4T)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Adjusted pregnancy No2 ") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

#cd8t cells
ggplot(covariates_cb, aes(x=no2_preg_entire, y=CD8T)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Adjusted pregnancy No2 ") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank(),
        axis.text = element_text(size=15))

#mononuclear cells
ggplot(covariates_cb, aes(x=no2_preg_entire, y=Mono*100)) +
  geom_point(col="#75A2D9", size=3, alpha=0.7) +
  geom_smooth(method='lm', se=FALSE, col="black") +
  stat_cor(method = "pearson", size=8, label.y = 55) +
  labs(x="Average prenatal NO2 exposure (ug/m3)", y="% Monocytes") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank(),
        axis.text=element_text(size=18))

#Bcells
ggplot(covariates_cb, aes(x=no2_preg_entire, y=Bcell)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10, label.y = 20) +
  labs(x="Adjusted pregnancy No2 ") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

#natural killer cells
ggplot(covariates_cb, aes(x=no2_preg_entire, y=NK)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Adjusted pregnancy No2 ") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

#nuclear RBCs
ggplot(covariates_cb, aes(x=no2_preg_entire, y=nRBC)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Adjusted pregnancy No2 ") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())
```



CBMC proportions vs prenatal PM2.5 A exposure
```{r cbmc_pm2.5}

#cd4t cells
ggplot(covariates_cb %>% subset(PM25DALYY_01 >= 0), aes(x=PM25DALYY_01, y=CD4T)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="PM2.5 A exposure") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

#cd8t cells
ggplot(covariates_cb %>% subset(PM25DALYY_01 >= 0), aes(x=PM25DALYY_01, y=CD8T)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="PM2.5 A exposure") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

#mononuclear cells
ggplot(covariates_cb %>% subset(PM25DALYY_01 >= 0), aes(x=PM25DALYY_01, y=Mono)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="PM2.5 A exposure") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

#Bcells
ggplot(covariates_cb %>% subset(PM25DALYY_01 >= 0), aes(x=PM25DALYY_01, y=Bcell)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="PM2.5 A exposure") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

#natural killer cells
ggplot(covariates_cb %>% subset(PM25DALYY_01 >= 0), aes(x=PM25DALYY_01, y=NK)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="PM2.5 A exposure") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

#nuclear RBCs
ggplot(covariates_cb %>% subset(PM25DALYY_01 >= 0), aes(x=PM25DALYY_01, y=nRBC)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="PM2.5 A exposure") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())
```


CBMC proportions vs prenatal PM2.5 B exposure
```{r cbmc_pm2.5_B}

#cd4t cells
ggplot(covariates_cb, aes(x=PM25DALbYY_01, y=CD4T)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="PM2.5 exposure B") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

#cd8t cells
ggplot(covariates_cb, aes(x=PM25DALbYY_01, y=CD8T)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="PM2.5 exposure B") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

#mononuclear cells
ggplot(covariates_cb, aes(x=PM25DALbYY_01, y=Mono*100)) +
  geom_point(col="#75A2D9", size=3, alpha=0.7) +
  geom_smooth(method='lm', se=FALSE, col="black") +
  stat_cor(method = "pearson", size=8, label.y = 55) +
  labs(x="Average prenatal PM2.5 B exposure (ug/m3)", y="% Monocytes") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank(),
        axis.text=element_text(size=18))

#Bcells
ggplot(covariates_cb, aes(x=PM25DALbYY_01, y=Bcell)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="PM2.5 exposure B") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

#natural killer cells
ggplot(covariates_cb, aes(x=PM25DALbYY_01, y=NK)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="PM2.5 exposure B") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

#nuclear RBCs
ggplot(covariates_cb, aes(x=PM25DALbYY_01, y=nRBC)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="PM2.5 exposure B") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())
```

NO2 vs PM2.5 A.
```{r no2_pm2.5A}
#cd4t cells
ggplot(covariates_cb %>% subset(PM25DALYY_01 >= 0), aes(x=PM25DALYY_01, y=no2_preg_entire)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="PM2.5 A exposure",
       y="Prenatal NO2 exposure") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())
```

NO2 vs PM2.5 B.
```{r no2_pm2.5B}
#cd4t cells
ggplot(covariates_cb, aes(x=PM25DALbYY_01, y=no2_preg_entire)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="PM2.5 B exposure",
       y="Prenatal NO2 exposure") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())
```


Prenatal NO2 vs study site.
```{r no2_studysite}
ggplot(covariates_cb, aes(x=as.factor(studycentre), y=no2_preg_entire, fill=studycentre)) +
  geom_boxplot() +
  scale_fill_manual(values=c("#EEF0FF", "#BCD6FB", "#75A2D9", "#27497F")) +
  geom_jitter(height=0, width=0.3) +
  #geom_smooth(method='lm', se=FALSE) +
  #stat_cor(method = "pearson", size=5) +
  labs(x="Study site", y=bquote('Average prenatal'~ NO[2] ~(Î¼g/m^3)))+
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank(),
        legend.position="none") +
      geom_signif(comparisons = list(c("Winnipeg", "Vancouver")), 
              map_signif_level=F, col="black",
              y_position= 26,
              annotation = c("***"),
              textsize = 10) +
      geom_signif(comparisons = list(c("Winnipeg", "Toronto")), 
              map_signif_level=F, col="black",
              y_position = 31,
              annotation = c("***"),
              textsize = 10) +
      geom_signif(comparisons = list(c("Winnipeg", "Edmonton")), 
              map_signif_level=F, col="black", 
              y_position=36,
              annotation = c("***"),
              textsize = 10) +
  ylim(0,40)
  

#anova for effects
no2.studycentre <- lm(no2_preg_entire ~ studycentre, covariates_cb)
anova(no2.studycentre)
no2.studycentre.aov <- aov(no2_preg_entire ~ studycentre, covariates_cb)
no2.studycentre.tukey <- TukeyHSD(no2.studycentre.aov)
no2.studycentre.tukey
```



PM2.5 A vs study site.
```{r no2_studysite}
ggplot(covariates_cb %>% subset(PM25DALYY_01 >= 0), 
       aes(x=as.factor(studycentre), y=PM25DALYY_01, fill=studycentre)) +
  geom_boxplot() +
  scale_fill_manual(values=c("#EEF0FF", "#BCD6FB", "#75A2D9", "#27497F")) +
  geom_jitter(height=0, width=0.3) +
  #geom_smooth(method='lm', se=FALSE) +
  #stat_cor(method = "pearson", size=5) +
  labs(x="Study site", y="PM2.5 A")+
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank(),
        legend.position="none") +
      geom_signif(comparisons = list(c("Winnipeg", "Toronto")), 
              map_signif_level=F, col="black",
              y_position = 10,
              annotation = c("***"),
              textsize = 10) +
      geom_signif(comparisons = list(c("Winnipeg", "Edmonton")), 
              map_signif_level=F, col="black", 
              y_position=13,
              annotation = c("***"),
              textsize = 10) +
  ylim(0,15)
  

#anova for effects
pm2.5a.studycentre <- lm(PM25DALYY_01 ~ studycentre, covariates_cb %>% subset(PM25DALYY_01 >= 0))
anova(pm2.5a.studycentre)
pm2.5a.studycentre.aov <- aov(PM25DALYY_01 ~ studycentre, covariates_cb %>% subset(PM25DALYY_01 >= 0))
pm2.5a.studycentre.tukey <- TukeyHSD(pm2.5a.studycentre.aov)
pm2.5a.studycentre.tukey
```



PM2.5 B vs study site.
```{r no2_studysite}
ggplot(covariates_cb, 
       aes(x=as.factor(studycentre), y=PM25DALbYY_01, fill=studycentre)) +
  geom_boxplot() +
  scale_fill_manual(values=c("#EEF0FF", "#BCD6FB", "#75A2D9", "#27497F")) +
  geom_jitter(height=0, width=0.3) +
  #geom_smooth(method='lm', se=FALSE) +
  #stat_cor(method = "pearson", size=5) +
  labs(x="Study site", y="PM2.5 B")+
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank(),
        legend.position="none") +
      geom_signif(comparisons = list(c("Winnipeg", "Toronto")), 
              map_signif_level=F, col="black",
              y_position = 13,
              annotation = c("**"),
              textsize = 10) +
      geom_signif(comparisons = list(c("Winnipeg", "Edmonton")), 
              map_signif_level=F, col="black", 
              y_position=22,
              annotation = c("***"),
              textsize = 10) +
    geom_signif(comparisons = list(c("Toronto", "Edmonton")), 
              map_signif_level=F, col="black", 
              y_position=16,
              annotation = c("***"),
              textsize = 10) +
      geom_signif(comparisons = list(c("Vancouver", "Edmonton")), 
              map_signif_level=F, col="black", 
              y_position=19,
              annotation = c("***"),
              textsize = 10) +
        geom_signif(comparisons = list(c("Vancouver", "Toronto")), 
              map_signif_level=F, col="black", 
              y_position=10,
              annotation = c("***"),
              textsize = 10) +
  ylim(2.5,25)
  

#anova for effects
pm2.5b.studycentre <- lm(PM25DALbYY_01 ~ studycentre, covariates_cb)
anova(pm2.5b.studycentre)
pm2.5b.studycentre.aov <- aov(PM25DALbYY_01 ~ studycentre, covariates_cb)
pm2.5b.studycentre.tukey <- TukeyHSD(pm2.5b.studycentre.aov)
pm2.5b.studycentre.tukey
```

Monocytes vs prenatal NO2 exposure
```{r mono_no2}

#mononuclear cells
ggplot(covariates_cb, aes(x=no2_preg_entire, y=Mono)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Adjusted pregnancy No2 ") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())
```

Monocytes vs pm2.5 B exposure
```{r mono_pm2.5b}

#mononuclear cells
ggplot(covariates_cb, aes(x=PM25DALbYY_01, y=Mono)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="PM2.5 B exposure") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())
```

Birth weight vs pm2.5 B exposure
```{r birthweight_pm2.5b}
ggplot(covariates_cb, aes(x=PM25DALbYY_01, y=weight_birth*1000)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="PM2.5 B exposure", y= "Birth weight (g)") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

#coloured by birth weight
ggplot(covariates_cb, aes(x=PM25DALbYY_01, y=weight_birth*1000)) +
  geom_point(aes(col=studycentre)) +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="PM2.5 B exposure", y= "Birth weight (g)") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

#coloured by mod
#coloured by birth weight
ggplot(covariates_cb, aes(x=PM25DALbYY_01, y=weight_birth*1000)) +
  geom_point(aes(col=mod_cv)) +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="PM2.5 B exposure", y= "Birth weight (g)") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())
```

Depression 36 weeks vs pm2.5 B exposure
```{r csed36wk_pm2.5b}
ggplot(covariates_cb, aes(x=PM25DALbYY_01, y=csed_36wk)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="PM2.5 B exposure", y= "CSED") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

#coloured by study centre
ggplot(covariates_cb, aes(x=PM25DALbYY_01, y=csed_36wk)) +
  geom_point(aes(col=studycentre)) +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="PM2.5 B exposure", y= "CSED") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

#coloured by total income
ggplot(covariates_cb, aes(x=PM25DALbYY_01, y=csed_36wk)) +
  geom_point(aes(col=total_income)) +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="PM2.5 B exposure", y= "CSED") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())
```


Maternal smoking at 18 wk vs pm2.5 B exposure
```{r smoking18wk_pm2.5b}
ggplot(covariates_cb, aes(y=PM25DALbYY_01, x=maternal_smoking_18wk)) +
  geom_point() +
  #geom_smooth(method='lm', se=FALSE) +
  #stat_cor(method = "pearson", size=10) +
  labs(y="PM2.5 B exposure", x= "Maternal_smoking") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

```

CD4t vs gestational age
```{r cd4t_ga}
ggplot(covariates_cb, aes(x=gestational_days, y=CD4T)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Gestational days", y= "CD4T") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())
```

CD4T vs birth weight
```{r cd4t_birthweight}
ggplot(covariates_cb, aes(x=weight_birth*1000, y=CD4T)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Birth weight (g)", y= "CD4T") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

#colour by mod
ggplot(covariates_cb, aes(x=weight_birth*1000, y=CD4T)) +
  geom_point(aes(col=mod_cv)) +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Birth weight (g)", y= "CD4T") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())
```

CD4t vs MOD
```{r cd4t_mod}
ggplot(covariates_cb, aes(y=gestational_days, x=mod_cv)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Method of delivery", y= "CD4T") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank()) +
    geom_signif(comparisons = list(c("vaginal", "caesarean")), 
              map_signif_level=F, col="black", 
              annotation = c("t = -4.0594, p-value = 0.0001314"),
              textsize = 5)


ttest.sexcd4t <- t.test(covariates_cb %>% subset(mod_cv=="vaginal") %>% select(CD4T), 
                  covariates_cb %>% subset(mod_cv=="caesarean") %>% select(CD4T),
                  paired=FALSE,
                  alternative = "two.sided")
```

Monocytes vs birth weight
```{r mono_birthweight}
ggplot(covariates_cb, aes(x=weight_birth*1000, y=Mono)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Birth weight (g)", y= "Mono") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

#colour by mod
ggplot(covariates_cb, aes(x=weight_birth*1000, y=Mono)) +
  geom_point(aes(col=mod_cv)) +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Birth weight (g)", y= "Mono") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

#colour by study centre
ggplot(covariates_cb, aes(x=weight_birth*1000, y=Mono)) +
  geom_point(aes(col=studycentre)) +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Birth weight (g)", y= "Mono") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())
```


Monocytes vs studycentre
```{r studycentre_mod}
ggplot(covariates_cb, aes(y=Mono, x=studycentre)) +
  geom_boxplot(aes(fill=studycentre)) +
  scale_fill_manual(values=c("#EEF0FF", "#BCD6FB", "#75A2D9", "#27497F")) +
  geom_jitter(height=0, width=0.3) +
  #geom_smooth(method='lm', se=FALSE) +
  #stat_cor(method = "pearson", size=5) +
  labs(x="Study site", y="Monocytes")+
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank(),
        legend.position="none") +
      geom_signif(comparisons = list(c("Winnipeg", "Vancouver")), 
              map_signif_level=F, col="black",
              y_position= 0.65,
              annotation = c("*"),
              textsize = 10) +
      geom_signif(comparisons = list(c("Winnipeg", "Toronto")), 
              map_signif_level=F, col="black",
              y_position = 0.8,
              annotation = c("*"),
              textsize = 10) +
      geom_signif(comparisons = list(c("Winnipeg", "Edmonton")), 
              map_signif_level=F, col="black", 
              y_position=0.95,
              annotation = c("***"),
              textsize = 10) +
  ylim(0,1)

mono.studycentre <- lm(Mono ~ studycentre, covariates_cb)
anova(mono.studycentre)
mono.studycentre.aov <- aov(Mono ~ studycentre, covariates_cb)
mono.studycentre.tukey <- TukeyHSD(mono.studycentre.aov)
mono.studycentre.tukey
```

Monocytes vs total income
```{r mono_income}
ggplot(covariates_cb, aes(y=Mono, x=total_income)) +
  geom_boxplot() +
  geom_jitter(height=0, width=0.3) +
  #geom_smooth(method='lm', se=FALSE) +
  #stat_cor(method = "pearson", size=5) +
  labs(x="total_income", y="Monocytes")+
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank(),
        legend.position="none",
        axis.text.x = element_text(angle=90)) 

```


Bcell vs ses canada rank
```{r mono_income}
ggplot(covariates_cb, aes(y=Bcell, x=ses_canada_rank)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="SES canada rank", y="Monocytes")+
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank(),
        legend.position="none",
        axis.text.x = element_text(angle=90)) 
```

nRBC vs MOD
```{r nRBC_mod}
ggplot(covariates_cb, aes(y=nRBC, x=mod_cv)) +
  geom_boxplot(aes(fill=mod_cv)) +
  geom_jitter(height=0, width=0.3) +
  scale_fill_manual(values=c("#EEF0FF", "#75A2D9")) +
  labs(x="Method of delivery", y= "nRBC") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank(),
        legend.position = "none") +
    geom_signif(comparisons = list(c("vaginal", "caesarean")), 
              map_signif_level=F, col="black", 
              annotation = c("t = 2.0563, p-value = 0.04178"),
              textsize = 5)


ttest.modnrbc <- t.test(covariates_cb %>% subset(mod_cv=="vaginal") %>% select(nRBC), 
                  covariates_cb %>% subset(mod_cv=="caesarean") %>% select(nRBC),
                  paired=FALSE,
                  alternative = "two.sided")
```


NK vs MOD
```{r NK_mod}
ggplot(covariates_cb, aes(y=NK, x=mod_cv)) +
  geom_boxplot(aes(fill=mod_cv)) +
  geom_jitter(height=0, width=0.3) +
  scale_fill_manual(values=c("#EEF0FF", "#75A2D9")) +
  labs(x="Method of delivery", y= "NK") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank(),
        legend.position = "none") +
    geom_signif(comparisons = list(c("vaginal", "caesarean")), 
              map_signif_level=F, col="black", 
              annotation = c("t = 3.457, p-value = 0.000881"),
              textsize = 5)


ttest.modNK <- t.test(covariates_cb %>% subset(mod_cv=="vaginal") %>% select(NK), 
                  covariates_cb %>% subset(mod_cv=="caesarean") %>% select(NK),
                  paired=FALSE,
                  alternative = "two.sided")
```


NK vs gestational age
```{r nk_ga}
ggplot(covariates_cb, aes(x=gestational_days, y=NK)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Gestational days", y= "NK") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

```


NK vs secondhand smoke
```{r nk_ga}
ggplot(covariates_cb %>% subset(prenatal_shs == 0 | prenatal_shs == 1), aes(x=prenatal_shs, y=NK)) +
  geom_boxplot(aes(fill=prenatal_shs)) +
  geom_jitter(height=0, width=0.3) +
  scale_fill_manual(values=c("#EEF0FF", "#75A2D9")) +
  labs(x="Secondhand smoke", y= "NK") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank(),
        legend.position = "none") +
    geom_signif(comparisons = list(c("0", "1")), 
              map_signif_level=F, col="black", 
              annotation = c("t = 3.6745, p-value = 0.001575"),
              textsize = 5)


ttest.shsNK <- t.test(covariates_cb %>% subset(prenatal_shs==0) %>% select(NK), 
                  covariates_cb %>% subset(prenatal_shs==1) %>% select(NK),
                  paired=FALSE,
                  alternative = "two.sided")

```

Genotyping pc 3 vs pm2.5b
```{r genotypingpc2_pm2.5b}
ggplot(covariates_cb, aes(x=genotyping.PC3, y=PM25DALbYY_01)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Genotyping PC3", y= "PM2.5 B exposure") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())


```