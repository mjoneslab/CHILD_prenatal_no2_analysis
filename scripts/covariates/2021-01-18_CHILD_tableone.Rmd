---
title: "Table one NO2"
author: "SL"
date: "27/10/2020"
output: html_document
---

*Purpose*: The purpose of this script is to create "Table 1" for the CHILD NO2 analysis. 

Load libraries.
```{r libraries}
library(tidyverse)
library(table1)
library(here)
library(VennDiagram)
```


Load betas
```{r betas}
load(file=here("output_data", "preprocessed_data",
               "2020-11_19_CHILD_preprocessed_betas_pdata_annotation.Rdata"))

#subset out cord blood and year one pData
#cord blood pdata
cb_pdata <- subset(pdata_nodups, Tissue == "C")
dim(cb_pdata) # 144  17

#year one pdatga
y1_pdata <- subset(pdata_nodups, Tissue == "P")
dim(y1_pdata) # 145  17

#year one data has one individual that is missing birth data
#remove this individual
y1_pdata_sub <- y1_pdata[y1_pdata$Sample_Label %in% cb_pdata$Sample_Label, ]
dim(y1_pdata_sub) # 144  17
```

Subset out cord blood and age one betas
```{r sub_betas}
#subset pData into CBMCs (cord blood)
#these children have data at both time points
cb_betas <- betas[,colnames(betas) %in% rownames(cb_pdata)]
#check size of cord blood data
dim(cb_betas) # 424644    144
min(cb_betas) # 0.002973941
max(cb_betas) # 0.9980669

#check if cord blood DNAm samples are in same order in cord blood pdata
identical(colnames(cb_betas), rownames(cb_pdata)) #true
#rename columns of cb_betas
colnames(cb_betas) <- cb_pdata$Sample_Label


#subset out cordblood samples from beta matrix
y1_betas <- betas[,colnames(betas) %in% rownames(y1_pdata_sub)]
#check size of year one data
dim(y1_betas) # 424644    144
min(y1_betas) #0.002650193
max(y1_betas) #0.9983506

#check if cord blood DNAm samples are in same order in cord blood pdata
identical(colnames(y1_betas), rownames(y1_pdata_sub)) #true
#rename columns of cb_betas
colnames(y1_betas) <- y1_pdata_sub$Sample_Label

#check if cord blood samples and year one samples are in same order
identical(colnames(cb_betas), colnames(y1_betas))
```

Load covariate data
```{r covariates}
load(file=here("output_data", "covariates", "2020-11-12_CHILD_covariates_na_with_means.Rdata"))

#subset covariates
covariates_sub <- 
  covariates_nameans[as.character(covariates_nameans$sampleid) %in% colnames(y1_betas), ]

#check order
identical(as.character(covariates_sub$sampleid), colnames(y1_betas)) #true
dim(covariates_sub) #144

#check order
identical(as.character(cb_pdata$Sample_Label), colnames(y1_betas)) #true
dim(cb_pdata) #144

#check order
identical(as.character(y1_pdata_sub$Sample_Label), colnames(y1_betas)) #true
dim(y1_pdata_sub) #144

```

Load list of probes used in deconvolution. This will be used later to remove these probes before linear regression
```{r deconvo_probe_list}
load("R:/Jones/People/Samantha Lee/Projects/CHILD/CHILD_air_pollution/output_data/deconvolution/2021-01-07_CBMC_PBMC_deconvolution.Rdata")
```


Load genotyping PCs and subset out REEGLE PCs (genotyping data contains PCs for a few thousand participants).
```{r genotypingPCS}
genotyping <- read.csv("R:/Jones/People/Samantha Lee/Computational/CHILD/input_data/CHILD_subjects_Qced_first10PCS_Duan.csv")

#make rownames sample names then rmove this row
rownames(genotyping) <- genotyping$FID
genotyping <- subset(genotyping, select=-c(FID, IID))

genosub <- genotyping[rownames(genotyping) %in% cb_pdata$Sample_Label,]
#missing genotyping data for 14 REEGLE children?

#rename columns of genotyping data for clarity
colnames(genosub) <- paste("genotyping.", colnames(genosub), sep="")

#put rows in numerical order according to sample id
genosub_order <- genosub[order(rownames(genosub)), ]
```


```{r sub}
#subset cb_pdata
cb_pdata_geno <- cb_pdata[as.character(cb_pdata$Sample_Label) %in% rownames(genosub_order), ]
#check size
dim(cb_pdata_geno) #131
#check order
identical(as.character(cb_pdata_geno$Sample_Label), rownames(genosub_order)) #true

#subset y1_pdata
y1_pdata_geno <- y1_pdata_sub[as.character(y1_pdata_sub$Sample_Label) %in% rownames(genosub_order), ]
#check size
dim(y1_pdata_geno) #131
#check order
identical(as.character(y1_pdata_geno$Sample_Label), rownames(genosub_order)) #true

#subset covariates
covariates_sub_geno <- covariates_sub[as.character(covariates_sub$sampleid) %in% rownames(genosub_order), ]
#check size
dim(covariates_sub_geno) #131
#check order
identical(as.character(covariates_sub_geno$sampleid), rownames(genosub_order)) #true
```


Subset CBMC and PBMC cell counts for samples with genotyping data.
```{r sub_cellcounts}
############
#cord blood#
############

#convert to dataframe
child_fscbc_ecc2_cb_df <- as.data.frame(child_fscbc_ecc2_cb$counts)

#subset and order cell counts to match cb_pdata_geno
child_fscbc_ecc2_cb_df_order <- child_fscbc_ecc2_cb_df[rownames(cb_pdata_geno), ]

#order
identical(rownames(child_fscbc_ecc2_cb_df_order), rownames(cb_pdata_geno)) # TRUE

#rename using sample label
rownames(child_fscbc_ecc2_cb_df_order) <- cb_pdata_geno$Sample_Label

#rename columns 
colnames(child_fscbc_ecc2_cb_df_order) <- paste("cbmc", colnames(child_fscbc_ecc2_cb_df_order),
                                                sep=".")

############
#age1 blood#
############

#convert to dataframe
child_fscbc_ecc2_y1_df <- as.data.frame(child_fscbc_ecc2_y1$counts)

#subset and order cell counts to match cb_pdata_geno
child_fscbc_ecc2_y1_df_order <- child_fscbc_ecc2_y1_df[rownames(y1_pdata_geno), ]

#order
identical(rownames(child_fscbc_ecc2_y1_df_order), rownames(y1_pdata_geno)) # TRUE

#rename using sample label
rownames(child_fscbc_ecc2_y1_df_order) <- y1_pdata_geno$Sample_Label

#rename columns 
colnames(child_fscbc_ecc2_y1_df_order) <- paste("pbmc", colnames(child_fscbc_ecc2_y1_df_order),
                                                sep=".")
```




Combine covariate data (subset) and genotyping data into one dataframe. 
```{r combine}
identical(rownames(child_fscbc_ecc2_cb_df_order), rownames(genosub_order)) # TRUE
identical(rownames(child_fscbc_ecc2_y1_df_order), rownames(genosub_order)) # TRUE
identical(as.character(covariates_sub_geno$sampleid), rownames(genosub_order)) # TRUE

#subset for genosub
all_vars <- cbind(covariates_sub_geno, genosub_order, 
                  child_fscbc_ecc2_cb_df_order, child_fscbc_ecc2_y1_df_order)
```




Make table one
```{r table1}
#get sampleids with complete cases for prenatal models
all_vars$prenatal_cc <- complete.cases(all_vars %>% 
                                dplyr::select(no2_preg_entire, sex,  
                                              gestational_days,
                                              prenatal_maternal_smoking,  
                                              maternal_education_length, 
                                              pss_18wk,csed_18wk))

#get rows with complete cases for year one models
all_vars$yearone_cc <- complete.cases(all_vars %>% 
                                dplyr::select(no2_y1_entire, sex,  
                                              maternal_smoking_y1,  
                                              maternal_education_length, 
                                              pss_6mos,
                                              csed_6mos))

#get rows with complete cases for age one models
all_vars$ageone_cc <- complete.cases(all_vars %>% 
                                dplyr::select(no2_preg_entire, sex,  
                                              maternal_smoking_y1, 
                                              prenatal_maternal_smoking,
                                              maternal_education_length, 
                                              pss_6mos,
                                              csed_6mos, 
                                              pss_18wk,csed_18wk))


#get list of ids of participants in birth data
prenatal_ids <- all_vars[all_vars$prenatal_cc, "sampleid"]

#get list of ids of participants in year one data
yearone_ids <- all_vars[all_vars$yearone_cc, "sampleid"]

#get list of ids of participants in age one data
ageone_ids <- all_vars[all_vars$ageone_cc, "sampleid"]




timing <- sapply(all_vars$sampleid, function(x){
  ifelse(((x %in% prenatal_ids) & (x %in% yearone_ids)), "both",
         ifelse(((x %in% prenatal_ids) & (!x %in% yearone_ids)), "prenatal",
                ifelse(((!x %in% prenatal_ids) & (x %in% yearone_ids)), "y1",
                       NA)))})

all_vars$timing <- timing


#relevel factors
all_vars$sex <- as.factor(all_vars$sex)
levels(all_vars$sex) <- c("Female", "Male")

all_vars$prenatal_maternal_smoking <- as.factor(all_vars$prenatal_maternal_smoking)
levels(all_vars$prenatal_maternal_smoking) <- c("No", "Yes")

all_vars$maternal_smoking_y1 <- as.factor(all_vars$maternal_smoking_y1)
levels(all_vars$maternal_smoking_y1) <- c("No", "Yes")

strata <- c(list("Prenatal"= all_vars %>% 
                   filter(timing=="prenatal" | timing=="both") %>%
                   dplyr::select(no2_preg_entire, sex, gestational_days,
                          maternal_education_length,
                          prenatal_maternal_smoking,
                          pss_18wk, csed_18wk, 
                          cbmc.CD4T, cbmc.CD8T, cbmc.Mono,
                          cbmc.Bcell, cbmc.NK, cbmc.nRBC)),
            list("Year one"= all_vars %>%  
                   filter(timing=="y1" | timing=="both") %>%
                   dplyr::select(no2_y1_entire, sex, 
                          maternal_education_length,
                          maternal_smoking_y1,
                          pss_6mos, csed_6mos,
                          pbmc.CD4T, pbmc.NK, pbmc.Bcell,
                          pbmc.Mono, pbmc.CD8T)))


labels <- list(
  variables=list(no2_preg_entire = "Prenatal NO2 (ppb)",
                 no2_y1_entire = "Year one NO2 (ppb)",
                 sex="Sex",
                 gestational_days = "Gestational age (days)",
                 maternal_education_length = "Maternal education length (years)",
                 prenatal_maternal_smoking = "Prenatal maternal smoking",
                 maternal_smoking_y1 = "Year one maternal smoking",
                 pss_18wk = "Maternal stress (18 weeks)",
                 pss_6mos = "Maternal stress (6 months)",
                 csed_18wk = "Maternal depression (18 weeks)",
                 csed_6mos = "Maternal depression (6 months)",
                 cbmc.CD4T = "cbmc.CD4T",
                 cbmc.CD8T = "cbmc.CD8T",
                 cbmc.Mono = "cbmc.Mono",
                 cbmc.NK = "cbmc.NK",
                 cbmc.Bcell = "cbmc.Bcell",
                 cbmc.nRBC = "cbmc.nRBC",
                 pbmc.CD4T = "pbmc.CD4T",
                 pbmc.CD8T = "pbmc.CD8T",
                 pbmc.Mono = "pbmc.Mono",
                 pbmc.NK = "pbmc.NK",
                 pbmc.Bcell = "pbmc.Bcell"),
  groups=list("Prenatal", "Yearone"))


my.render.cont <- function(x) {
    with(stats.apply.rounding(stats.default(x), digits=2), c("",
        "Mean (SD)"=sprintf("%s (&plusmn; %s)", MEAN, SD)))
}
my.render.cat <- function(x) {
    c("", sapply(stats.default(x), function(y) with(y,
        sprintf("%d (%0.0f %%)", FREQ, PCT))))
}


#year one and prenatal data
table1(strata, labels, 
              render.continuous = my.render.cont,
       render.categorical = my.render.cat)


#age one data
table1(~ no2_preg_entire + sex + maternal_smoking_y1 +
         prenatal_maternal_smoking + maternal_education_length +
         pss_6mos + csed_6mos + pss_18wk + csed_18wk +
         pbmc.CD4T + pbmc.NK + pbmc.Bcell + pbmc.Mono + pbmc.CD8T,
       data=all_vars[all_vars$ageone_cc, ], 
       render.continuous = my.render.cont,
       render.categorical = my.render.cat)
```



