---
title: "Covariate correlations between age one cell type proportions"
author: "SL"
date: "11/06/2020"
output: html_document
---

Read libraries in.
```{r libraries, warnings=FALSE, message=FALSE}
library(tidyverse)
library(plyr)
library(pheatmap)
library(ggpubr)
library(here)
```


Load in CHILD covariate data.
```{r covariates}
load(here("output_data", "covariates", "2020-11-03_CHILD_all_covariates.Rdata"))
```


Read in cell type estimates.  
```{r load_deconvolution}
load(file=here("output_data", "deconvolution", "2021-01-07_CBMC_PBMC_deconvolution.Rdata"))
```


Load pData.  
```{r load_pData}
#this pdata has bad samples removed and sample mix-up corrected
load(file = here("output_data", "preprocessed_data", "2021-01_14_CHILD_preprocessed_betas_pdata_annotation.Rdata"))

#subset pData into PBMCs (year 1)
y1_pdata <- subset(pdata_nodups, Tissue == "P")
dim(y1_pdata)
```


Read in genotyping PCS
```{r genotyping}
genotyping <- read.csv("R:/Jones/People/Samantha Lee/Computational/CHILD/input_data/CHILD_subjects_Qced_first10PCS_Duan.csv")

#make rownames sample names then rmove this row
rownames(genotyping) <- genotyping$FID
genotyping <- subset(genotyping, select=-c(FID))

#subset genotyping for REEGLE children
genosub <- genotyping[rownames(genotyping) %in% y1_pdata$Sample_Label,]

#rename columns of genotyping data for clarity
colnames(genosub) <- paste("genotyping.", colnames(genosub), sep="")
```


Convert deconvolution estimates to dataframes.
```{r convert_deconvo_to_df}
#convert to dataframe
child_fscbc_ecc2_y1_df <- as.data.frame(child_fscbc_ecc2_y1$counts)

#check if rownames in same order
identical(rownames(child_fscbc_ecc2_y1_df), rownames(y1_pdata))
#YES

#reformat rownames to be in sample id format (5 digits)
rownames(child_fscbc_ecc2_y1_df) <- y1_pdata$Sample_Label
rownames(child_fscbc_ecc2_y1_df)
```


Subset covariate data for year one. Combine with cell type estimates and genotyping data.
```{r subset_covariates_y1}
#subset covariate data according to age and then combined with predicted cell proportions
covariates_y1 <- covariates[as.character(covariates$sampleid) %in% as.character(y1_pdata$Sample_Label),]
dim(covariates_y1) #145 113

#combine covaraite master data and cell estimates 
#check if they are identical 
identical(as.character(covariates_y1$sampleid), rownames(child_fscbc_ecc2_y1_df)) #true
covariates_y1 <- cbind(covariates_y1, child_fscbc_ecc2_y1_df)

#combine covariate data with genotyping data
rownames(covariates_y1)  <- covariates_y1$sampleid
covariates_y1 <- merge(covariates_y1, genosub[,2:4], by = "row.names", all.x = TRUE)
```



## Correlation heatmap between age1_145 

Create function to calculate correlation coefficient between covariates. 
```{r cor2.function}

cor2 = function(df){
  
  print("checking dataframe clases")
  stopifnot(inherits(df, "data.frame"))
  stopifnot(sapply(df, class) %in% c("integer"
                                     , "numeric"
                                     , "factor"
                                     , "character"))
  
  print("calculating correlation matrix")
  cor_fun <- function(pos_1, pos_2){
    
    # both are numeric
    if(class(df[[pos_1]]) %in% c("integer", "numeric") &&
       class(df[[pos_2]]) %in% c("integer", "numeric")){
      print("both are numeric")
      print(paste(colnames(df)[[pos_1]], colnames(df)[[pos_2]]))
      r <- stats::cor(df[[pos_1]], df[[pos_2]], use = "pairwise.complete.obs") #pairwise.complete.obs
      p <- unname((summary(lm(df[[pos_1]] ~ df[[pos_2]]))$coefficients[,4])[2])
      
    }
    
    #one is numberic the other is factor/character
    #must use sum of squares type 3 because groups are not of the same size
    #calculates ANOVA
    #then calcualtes eta-squared: measures the proportion of the total variance in a      dependent variable that
    #is associated with the membership of different groups defined by an independent      variable.
    #takes square root to get correlation
    if(class(df[[pos_1]]) %in% c("integer", "numeric") &&
       class(df[[pos_2]]) %in% c("factor", "character")){
      
      #print statements for debugging
      print("first is numeric, second is factor")
      print(paste(colnames(df)[[pos_1]], colnames(df)[[pos_2]]))
      
      #check factor levels of complete cases
      print("checking levels of pos_2 factor")
      tmp <- data.frame(df[[pos_1]], df[[pos_2]], row.names = NULL)
      complete <- complete.cases(tmp)
      tmp2 <- tmp[complete,]
      tmp2[,2] <- as.factor(tmp2[,2])
      
      #if statement to catch cases where dropped values result in a factor with
      #one or fewer levels
      if(is.factor(tmp2[,2]) & (nlevels(droplevels(tmp2[,2]))<2)){
        r <- 999
      } else {
        #anova for correlation
        r <- stats::aov(df[[pos_1]] ~ as.factor(df[[pos_2]])) %>%
          lsr::etaSquared(type=3) %>% `[`(1) %>% sqrt()
        
        #anova for p-pval
        lm_p <- lm(df[[pos_1]] ~ as.factor(df[[pos_2]]))
        p <- (anova(lm_p))$`Pr(>F)`[1]
        
      }
      rm(tmp,tmp2)
    }
    
    
    
    if(class(df[[pos_2]]) %in% c("integer", "numeric") &&
       class(df[[pos_1]]) %in% c("factor", "character")){
      
      #print statements for debugging
      print("first is factor, second is numeric")
      print(paste(colnames(df)[[pos_1]], colnames(df)[[pos_2]]))
      
      #check factor levels of complete cases
      print("checking levels of pos_1 factor")
      tmp <- data.frame(df[[pos_1]], df[[pos_2]], row.names = NULL)
      complete <- complete.cases(tmp)
      tmp2 <- tmp[complete,]
      tmp2[,1] <- as.factor(tmp2[,1])
      
      #if statement to catch cases where dropped values result in a factor with
      #one or fewer levels
      if(is.factor(tmp2[,1]) && (nlevels(droplevels(tmp2[,1]))<2)){
        r <- 999
      } else {
        r <- stats::aov(df[[pos_2]] ~ as.factor(df[[pos_1]])) %>%
          lsr::etaSquared(type=3) %>% `[`(1) %>% sqrt()
        
        #anova for p-pval
        lm_p <- lm(df[[pos_2]] ~ as.factor(df[[pos_1]]))
        p <- (anova(lm_p))$`Pr(>F)`[1]
        
      }
      rm(tmp,tmp2)
    }
    
    
  
    #both are factor/character
    if(class(df[[pos_1]]) %in% c("factor", "character") &&
       class(df[[pos_2]]) %in% c("factor", "character")){
      
      #print statement for debugging
      print("both are characters")
      print(paste(colnames(df)[[pos_1]], colnames(df)[[pos_2]]))
      
       #check factor levels of complete cases
      print("checking levels of of both positions")
      tmp <- data.frame(df[[pos_1]], df[[pos_2]], row.names = NULL)
      complete <- complete.cases(tmp)
      tmp2 <- tmp[complete,]
      tmp2[,1] <- as.factor(tmp2[,1])
      tmp2[,2] <- as.factor(tmp2[,2])
      
      #if statement to catch cases where dropped values result in a factor with
      #one or fewer levels
      if(is.factor(tmp2[,1]) && (nlevels(droplevels(tmp2[,1]))<2)){
        r <- 999
      } else {
        if(is.factor(tmp2[,2]) && (nlevels(droplevels(tmp2[,2]))<2)){
          r <-999
        } else { 
          r <- lsr::cramersV(df[[pos_1]], df[[pos_2]], simulate.p.value = TRUE)
          #get p value
          fish_table <- table(df[[pos_1]], df[[pos_2]])
          p <- fisher.test(fish_table, simulate.p.value=T)$p.value
        }
      }
      rm(tmp,tmp2)
    }
    
    return(r)
  } 
  
  cor_fun <- Vectorize(cor_fun)
  
  # now compute corr matrix
  corrmat <- outer(1:ncol(df)
                   , 1:ncol(df)
                   , function(x, y) cor_fun(x, y)
  )
  
  rownames(corrmat) <- colnames(df)
  colnames(corrmat) <- colnames(df)
  return(corrmat)
}
```


Function to calculate pvalues of correlations between covariates.
```{r pval2.function}

pval2 = function(df){
  
  #check that classes are appropriate
  print("checking dataframe clases")
  stopifnot(inherits(df, "data.frame"))
  stopifnot(sapply(df, class) %in% c("integer"
                                     , "numeric"
                                     , "factor"
                                     , "character"))
  
  print("calculating correlation matrix")
  
  ##################################
  #function for calculating pvalues#
  ##################################
  
  pval_fun <- function(pos_1, pos_2){
    

    ##################
    #both are numeric#
    ##################
    
    if(class(df[[pos_1]]) %in% c("integer", "numeric") &&
       class(df[[pos_2]]) %in% c("integer", "numeric")){
        
      print("both are numeric")
      
      if(colnames(df)[[pos_1]] == colnames(df)[[pos_2]]){
        #dont want to star comparisons of something against itsself
        p <- 1
      } else {
        print(paste(colnames(df)[[pos_1]], colnames(df)[[pos_2]]))
        p <- unname((summary(lm(df[[pos_1]] ~ df[[pos_2]]))$coefficients[,4])[2])
      }
    }
  
    ########################################
    #first is integer and second is numeric#
    ########################################
    
    if(class(df[[pos_1]]) %in% c("integer", "numeric") &&
       class(df[[pos_2]]) %in% c("factor", "character")){
      
      #print statements for debugging
      print("first is numeric, second is factor")
      print(paste(colnames(df)[[pos_1]], colnames(df)[[pos_2]]))
      
      #check factor levels of complete cases
      print("checking levels of pos_2 factor")
      tmp <- data.frame(df[[pos_1]], df[[pos_2]], row.names = NULL)
      complete <- complete.cases(tmp)
      tmp2 <- tmp[complete,]
      tmp2[,2] <- as.factor(tmp2[,2])
      
      #if statement to catch cases where dropped values result in a factor with
      #one or fewer levels
      if(is.factor(tmp2[,2]) & (nlevels(droplevels(tmp2[,2]))<2)){
        p <- 999
      } else {
       if(nlevels(droplevels(tmp2[,2]))>2){
          #anova for p-pval with 3 or  more factors
          lm_p <- lm(df[[pos_1]] ~ as.factor(df[[pos_2]]))
          p <- (anova(lm_p))$`Pr(>F)`[1]
        } else{
          #ttest for 2 factors
          p <- t.test(df[[pos_1]] ~ as.factor(df[[pos_2]]),
                  alternative = "two.sided")$p.value
        }
      }
      rm(tmp,tmp2)
    }
    
    
    ########################################
    #second is integer and first is numeric#
    ########################################
    
    if(class(df[[pos_2]]) %in% c("integer", "numeric") &&
       class(df[[pos_1]]) %in% c("factor", "character")){
      
      #print statements for debugging
      print("first is factor, second is numeric")
      print(paste(colnames(df)[[pos_1]], colnames(df)[[pos_2]]))
      
      #check factor levels of complete cases
      print("checking levels of pos_1 factor")
      tmp <- data.frame(df[[pos_1]], df[[pos_2]], row.names = NULL)
      complete <- complete.cases(tmp)
      tmp2 <- tmp[complete,]
      tmp2[,1] <- as.factor(tmp2[,1])
      
      #if statement to catch cases where dropped values result in a factor with
      #one or fewer levels
      if(is.factor(tmp2[,1]) && (nlevels(droplevels(tmp2[,1]))<2)){
        p <- 999
      } else {
        if(nlevels(droplevels(tmp2[,1]))>2){
          #anova for p-pval with 3 or  more factors
          lm_p <- lm(df[[pos_2]] ~ as.factor(df[[pos_1]]))
          p <- (anova(lm_p))$`Pr(>F)`[1]
        } else{
          #ttest for 2 factors
          p <- t.test(df[[pos_2]] ~ as.factor(df[[pos_1]]),
                  alternative = "two.sided")$p.value
        }
      }
      rm(tmp,tmp2)
    }
    
    
    ###########################
    #both are factor/character#
    ###########################
    
    if(class(df[[pos_1]]) %in% c("factor", "character") &&
       class(df[[pos_2]]) %in% c("factor", "character")){
      
      #print statement for debugging
      print("both are characters")
      print(paste(colnames(df)[[pos_1]], colnames(df)[[pos_2]]))
      
       #check factor levels of complete cases
      print("checking levels of of both positions")
      tmp <- data.frame(df[[pos_1]], df[[pos_2]], row.names = NULL)
      complete <- complete.cases(tmp)
      tmp2 <- tmp[complete,]
      tmp2[,1] <- as.factor(tmp2[,1])
      tmp2[,2] <- as.factor(tmp2[,2])
      
      
      #if statement to catch cases where dropped values result in a factor with
      #one or fewer levels
      if(colnames(df)[[pos_1]] == colnames(df)[[pos_2]]){
        p <- 1
      } else {
        if(is.factor(tmp2[,1]) && (nlevels(droplevels(tmp2[,1]))<2)){
          p <- 999
        } else {
          if(is.factor(tmp2[,2]) && (nlevels(droplevels(tmp2[,2]))<2)){
            p <- 999
          } else {
            #get p value
            fish_table <- table(df[[pos_1]], df[[pos_2]])
            p <- fisher.test(fish_table, simulate.p.value = T)$p.value
          }
        }
      }
      rm(tmp,tmp2)
    }
    return(p)
  } 
  
  pval_fun <- Vectorize(pval_fun)
  
  # now compute corr matrix
  pvalmat <- outer(1:ncol(df)
                   , 1:ncol(df)
                   , function(x, y) pval_fun(x, y)
  )
  
  rownames(pvalmat) <- colnames(df)
  colnames(pvalmat) <- colnames(df)
  return(pvalmat)
}
```


Get pvalues for correlations on a subset of covariates of interest.
```{r get-pvals}
covariates_y1_sub <- subset(covariates_y1, 
                                   select=c(NK, Bcell, Mono, CD8T, CD4T,
                                            no2_y1_entire, 
                                            maternal_smoking_y1, 
                                            sex, 
                                            pss_6mos,
                                            csed_6mos, 
                                            maternal_education_length,
                                            genotyping.PC1, genotyping.PC2,
                                            genotyping.PC3,
                                            studycentre))

#pvals calcs
covariates_y1_sub_pval <- pval2(covariates_y1_sub)
```


Calculate correlations between metadata variables using cor2 function above.  
```{r calc_covariate_corr}
#correlation calcs
covariates_y1_sub_corr <- cor2(covariates_y1_sub)

#set missing values (999) to NA - could have probably done this in the cor2 function
covariates_y1_sub_corr[covariates_y1_sub_corr == 999] <- NA
```



Modify ggcorrplot function to not blank out insignificant values
```{r func_mod}

#+++++++++++++++++++++++
# Helper Functions
#+++++++++++++++++++++++

# Get lower triangle of the correlation matrix
.get_lower_tri <- function(cormat, show.diag = FALSE) {
  if (is.null(cormat)) {
    return(cormat)
  }
  cormat[upper.tri(cormat)] <- NA
  if (!show.diag) {
    diag(cormat) <- NA
  }
  return(cormat)
}

# Get upper triangle of the correlation matrix
.get_upper_tri <- function(cormat, show.diag = FALSE) {
  if (is.null(cormat)) {
    return(cormat)
  }
  cormat[lower.tri(cormat)] <- NA
  if (!show.diag) {
    diag(cormat) <- NA
  }
  return(cormat)
}

.remove_diag <- function(cormat){
  if (is.null(cormat)) {
    return(cormat)
  }
  diag(cormat) <- NA
  cormat
}
# hc.order correlation matrix
.hc_cormat_order <- function(cormat, hc.method = "complete") {
  dd <- stats::as.dist((1 - cormat) / 2)
  hc <- stats::hclust(dd, method = hc.method)
  hc$order
}

.no_panel <- function() {
  ggplot2::theme(
    axis.title.x = ggplot2::element_blank(),
    axis.title.y = ggplot2::element_blank()
  )
}


# Convert a tbl to matrix
.tibble_to_matrix <- function(x){
  x <-  as.data.frame(x)
  rownames(x) <- x[, 1]
  x <- x[, -1]
  as.matrix(x)
}



corrplot <-
  
function (corr, method = c("square", "circle"), type = c("full", 
    "lower", "upper"), ggtheme = ggplot2::theme_minimal, 
    title = "", show.legend = TRUE, legend.title = "Corr", 
    show.diag = FALSE, colors = c("blue", "white", 
        "red"), outline.color = "gray", hc.order = FALSE, 
    hc.method = "complete", lab = FALSE, lab_col = "black", 
    lab_size = 4, p.mat = NULL, sig.level = 0.05, insig = c("pch", 
        "blank"), pch = 4, pch.col = "black", pch.cex = 5, 
    tl.cex = 12, tl.col = "black", tl.srt = 45, digits = 2) {
  
    type <- match.arg(type)
    method <- match.arg(method)
    insig <- match.arg(insig)
    if (inherits(corr, "cor_mat")) {
        cor.mat <- corr
        corr <- .tibble_to_matrix(cor.mat)
        p.mat <- .tibble_to_matrix(attr(cor.mat, "pvalue"))
    }
    if (!is.matrix(corr) & !is.data.frame(corr)) {
        stop("Need a matrix or data frame!")
    }
    corr <- as.matrix(corr)
    corr <- base::round(x = corr, digits = digits)
    if (hc.order) {
        ord <- .hc_cormat_order(corr)
        corr <- corr[ord, ord]
        if (!is.null(p.mat)) {
            p.mat <- p.mat[ord, ord]
            p.mat <- base::round(x = p.mat, digits = digits)
        }
    }
    if (type == "lower") {
        corr <- .get_lower_tri(corr, show.diag)
        p.mat <- .get_lower_tri(p.mat, show.diag)
    }
    else if (type == "upper") {
        corr <- .get_upper_tri(corr, show.diag)
        p.mat <- .get_upper_tri(p.mat, show.diag)
    }
    
    corr <- reshape2::melt(corr, na.rm = TRUE)
    colnames(corr) <- c("Var1", "Var2", "value")
    corr$pvalue <- rep(NA, nrow(corr))
    corr$signif <- rep(NA, nrow(corr))
    
    
    if (!is.null(p.mat)) {
        p.mat <- reshape2::melt(p.mat, na.rm = TRUE)
        corr$coef <- corr$value
        corr$pvalue <- p.mat$value
        corr$signif <- as.numeric(p.mat$value <= sig.level)
        
        #DONT GET RID OF STUFF BASED ON PVALUE
        #p.mat <- subset(p.mat, p.mat$value > sig.level)
        #if (insig == "blank") {
        #    corr$value <- corr$value * corr$signif
        }
    
    

    corr$abs_corr <- abs(corr$value) * 10
    p <- ggplot2::ggplot(data = corr, 
                         mapping = ggplot2::aes_string(x = "Var1",
                                                       y = "Var2", 
                                                       fill = "value"))
    
    if (method == "square") {
        p <- p + ggplot2::geom_tile(color = outline.color)
    } else if (method == "circle") {
      p <- p + ggplot2::geom_point(color = outline.color, shape = 21, 
                                   ggplot2::aes_string(size = "abs_corr")) + 
        ggplot2::scale_size(range = c(4,10)) + 
        ggplot2::guides(size = FALSE)
    }
    
    
    p <- p + ggplot2::scale_fill_gradient2(low = colors[1],
                                           high = colors[3],
                                           mid = colors[2], 
                                           midpoint = 0, 
                                           limit = c(-1, 1), 
                                           space = "Lab", 
                                           name = "Correlation coefficient")
    
    
    if (class(ggtheme)[[1]] == "function") {
        p <- p + ggtheme()
    } else if (class(ggtheme)[[1]] == "theme") {
        p <- p + ggtheme
    }
    
    p <- p + ggplot2::theme(axis.text.x = ggplot2::element_text(angle = tl.srt,
                                                                vjust = 1,
                                                                size = tl.cex,
                                                                hjust = 1), 
                            axis.text.y = ggplot2::element_text(size = tl.cex)) + 
      ggplot2::coord_fixed()
    
    
    #LABEL WITH PVALUE NOT CORRELATION COEFFICIENT
    label <- round(x = corr[, "signif"], digits = digits)
    
    
    if (!is.null(p.mat) & insig == "blank") {
        ns <- corr$pvalue > sig.level
        if (sum(ns) > 0) 
            label[ns] <- " "
    }
    
    if (lab) {
        #p <- p + ggplot2::geom_text(mapping = ggplot2::aes_string(x = "Var1", 
        #    y = "Var2"), label = label , color = lab_col, 
        #    size = lab_size)
        
        p <- p + ggplot2::geom_point(data = corr %>% subset(signif==1),
                                     mapping = ggplot2::aes_string(x = "Var1", y = "Var2"), 
                                     shape = pch, size = pch.cex, color = pch.col)
        
    }
    
    if (!is.null(p.mat) & insig == "pch") {
        p <- p + ggplot2::geom_point(data = p.mat,
                                     mapping = ggplot2::aes_string(x = "Var1", y = "Var2"), 
                                     shape = pch, size = pch.cex, color = pch.col)
    }
    if (title != "") {
        p <- p + ggplot2::ggtitle(title)
    }
    if (!show.legend) {
        p <- p + ggplot2::theme(legend.position = "none")
    }
    p <- p + .no_panel()
    corr_plot <<- p
    p
  }
```
  
  
```{r corrplot}
corrplot(covariates_y1_sub_corr,
         pch = 8,
         pch.cex = 1.5,
         type = "lower", 
         p.mat = covariates_y1_sub_pval,
         insig = "blank",
         lab=TRUE,
         tl.cex =6, 
         colors = c("#6D9EC1", "white", "#E46726")) +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        legend.key.height = unit(0.5, 'cm'),
        legend.key.width = unit(0.2, 'cm'),
        legend.text = element_text(size=5),
        legend.title = element_text(size=7),
        legend.position="left") +
  scale_y_discrete(labels = c("NK", "Bcell", "Mono", "CD8T", "CD4T",
                              "Year one NO2", "Maternal smoking", "Sex", 
                              "Maternal stress", "Maternal depression",
                              "Maternal education length", 
                              "Genotyping PC1", "Genotyping PC2", "Genotyping PC3"),
                   position = "right") +
  scale_x_discrete(labels = c("Bcell", "Mono", "CD8T", "CD4T",
                              "Year one NO2", "Maternal smoking", "Sex", 
                              "Maternal stress", "Maternal depression",
                              "Maternal education length", 
                              "Genotyping PC1", "Genotyping PC2", "Genotyping PC3",
                              "Study centre")) 


ggsave("R:/Jones/People/Samantha Lee/Projects/CHILD/CHILD_air_pollution/figures/2021-01-27_CHILD_yearone145_corrplot.tiff",
       device="tiff",
       height=3,
       width=6,
       units="in")
```


#### Linear regressions of covariates on cell type proportions at birth

Predict PBMC cell types on no2yr1_birth
```{r pmbc_celltypes_no2yr1_birth}

#cd4t cells
ggplot(covariates_y1, aes(x=no2_preg_entire, y=CD4T)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Prenatal no2 ") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

#cd8t cells
ggplot(covariates_y1, aes(x=no2_preg_entire, y=CD8T*100)) +
  geom_point(col="#75A2D9", size=3, alpha=0.7) +
  geom_smooth(method='lm', se=FALSE, col="black") +
  stat_cor(method = "pearson", size=8, label.y = 38) +
  labs(x="Average prenatal NO2 exposure (ug/m3)", y="% CD8T") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank(),
        axis.text=element_text(size=18))

#mononuclear cells
ggplot(covariates_y1, aes(x=no2_preg_entire, y=Mono)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson",  size=10) +
  labs(x="Prenatal no2 ") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

#Bcells
ggplot(covariates_y1, aes(x=no2_preg_entire, y=Bcell)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson",  size=10) +
  labs(x="Prenatal no2 ") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

#natural killer cells
ggplot(covariates_y1, aes(x=no2_preg_entire, y=NK)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson",  size=10) +
  labs(x="Prenatal no2 ") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())
```

### Year one NO2

Predict PBMC cell types on year one NO2
```{r pmbc.celltypes.no2yr1_adj}

#cd4t cells
ggplot(covariates_y1, aes(x=no2_y1_entire, y=CD4T)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Year one no2") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

#cd8t cells
ggplot(covariates_y1, aes(x=no2_y1_entire, y=CD8T*100)) +
  geom_point(col="#75A2D9", size=3, alpha=0.7) +
  geom_smooth(method='lm', se=FALSE, col="black") +
  stat_cor(method = "pearson", size=8, label.y = 38) +
  labs(x="Average year one NO2 exposure (ug/m3)", y="% CD8T") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank(),
        axis.text=element_text(size=18))


#mononuclear cells
ggplot(covariates_y1, aes(x=no2_y1_entire, y=Mono*100)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE, col="#75A2D9") +
  stat_cor(method = "pearson", size=8) +
  labs(y="Monocytes (%)", x=bquote('Average year one'~ NO[2] ~(μg/m^3)))+
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

#Bcells
ggplot(covariates_y1, aes(x=no2_y1_entire, y=Bcell*100)) +
  geom_point(col="#75A2D9", size=3, alpha=0.7) +
  geom_smooth(method='lm', se=FALSE, col="black") +
  stat_cor(method = "pearson", size=8, label.y = 55) +
  labs(x="Average year one NO2 exposure (ug/m3)", y="% Bcell") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank(),
        axis.text=element_text(size=18))

#natural killer cells
ggplot(covariates_y1, aes(x=no2_y1_entire, y=NK)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Year one no2") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())
```


Predict PBMC cell types on PM2.5B
```{r pmbc_pm2.5b}

#cd4t cells
ggplot(covariates_y1, aes(x=PM25DALbYY_01, y=CD4T)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Year one no2") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

#cd8t cells
ggplot(covariates_y1, aes(x=PM25DALbYY_01, y=CD8T*100)) +
  geom_point(col="#75A2D9", size=3, alpha=0.7) +
  geom_smooth(method='lm', se=FALSE, col="black") +
  stat_cor(method = "pearson", size=8, label.y = 38) +
  labs(x="Average year one NO2 exposure (ug/m3)", y="% CD8T") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank(),
        axis.text=element_text(size=18))


#mononuclear cells
ggplot(covariates_y1, aes(x=PM25DALbYY_01, y=Mono*100)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE, col="#75A2D9") +
  stat_cor(method = "pearson", size=8) +
  labs(y="Monocytes (%)", x=bquote('Average year one'~ NO[2] ~(μg/m^3)))+
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

#Bcells
ggplot(covariates_y1, aes(x=PM25DALbYY_01, y=Bcell*100)) +
  geom_point(col="#75A2D9", size=3, alpha=0.7) +
  geom_smooth(method='lm', se=FALSE, col="black") +
  stat_cor(method = "pearson", size=8, label.y = 55) +
  labs(x="Three year PM2.5 A exposure (ug/m3)", y="% Bcell") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank(),
        axis.text=element_text(size=18))

#natural killer cells
ggplot(covariates_y1, aes(x=PM25DALbYY_01, y=NK)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Year one no2") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())
```

PBMC vs PM2.5 A
```{r pmbc_pm2.5a}

#cd4t cells
ggplot(covariates_y1, aes(x=PM25DALYY_01, y=CD4T)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Year one no2") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

#cd8t cells
ggplot(covariates_y1, aes(x=PM25DALYY_01, y=CD8T*100)) +
  geom_point(col="#75A2D9", size=3, alpha=0.7) +
  geom_smooth(method='lm', se=FALSE, col="black") +
  stat_cor(method = "pearson", size=8, label.y = 38) +
  labs(x="Average year one NO2 exposure (ug/m3)", y="% CD8T") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank(),
        axis.text=element_text(size=18))


#mononuclear cells
ggplot(covariates_y1 %>% subset(PM25DALYY_01 >= 0), aes(x=PM25DALYY_01, y=Mono*100)) +
  geom_point(col="#75A2D9", size=3, alpha=0.7) +
  geom_smooth(method='lm', se=FALSE, col="black") +
  stat_cor(method = "pearson", size=8, label.y = 38) +
  labs(x="Average PM2.5 A exposure (ug/m3)", y="% Monocytes") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank(),
        axis.text=element_text(size=18))


#Bcells
ggplot(covariates_y1 %>% subset(PM25DALYY_01 > -1), aes(x=PM25DALYY_01, y=Bcell*100)) +
  geom_point(col="#75A2D9", size=3, alpha=0.7) +
  geom_smooth(method='lm', se=FALSE, col="black") +
  stat_cor(method = "pearson", size=8, label.y = 50) +
  labs(x="Three year PM2.5 A exposure (ug/m3)", y="% Bcell") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank(),
        axis.text=element_text(size=18))

#natural killer cells
ggplot(covariates_y1, aes(x=PM25DALYY_01, y=NK)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Year one no2") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())
```




Predict age one PBMC cell types based on sex  
```{r pbmc.celltypes.sex}

#cd4t cells
ggplot(covariates_y1 %>% select(CD4T, sex) %>% na.omit(), aes(x=sex, y=CD4T)) +
  geom_point() +
  labs(x="Sex") +
  scale_x_discrete(labels=c("Female", "Male")) + 
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank()) +
    geom_signif(comparisons = list(c("F", "M")), 
              map_signif_level=F, col="black", 
              annotation = c("t = -0.58283, p = 0.5611"),
              textsize = 5)

ttest.sexcd4t <- t.test(covariates_y1 %>% subset(sex=="F") %>% select(CD4T), 
                  covariates_y1 %>% subset(sex=="M") %>% select(CD4T),
                  paired=FALSE,
                  alternative = "two.sided")

ttest.sexcd4t



#cd8t cells
ggplot(covariates_y1 %>% select(CD8T, sex) %>% na.omit(), aes(x=sex, y=CD8T)) +
  geom_point() +
  labs(x="Sex") +
  scale_x_discrete(labels=c("Female", "Male")) +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank()) +
    geom_signif(comparisons = list(c("F", "M")), 
              map_signif_level=F, col="black", 
              annotation = c("t = -0.43427, p-value = 0.6648"),
              textsize = 5)


ttest.sexcd8t <- t.test(covariates_y1 %>% subset(sex=="F") %>% select(CD8T), 
                  covariates_y1 %>% subset(sex=="M") %>% select(CD8T),
                  paired=FALSE,
                  alternative = "two.sided")

ttest.sexcd8t


#mononuclear cells
ggplot(covariates_y1 %>% select(Mono, sex) %>% na.omit(), aes(x=sex, y=Mono)) +
  geom_point() +
  labs(x="Sex") +
  scale_x_discrete(labels=c("Female", "Male")) +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())+
    geom_signif(comparisons = list(c("F", "M")), 
              map_signif_level=F, col="black", 
              annotation = c("t = 0.39084, p-value = 0.6966"),
              textsize = 5)


ttest.sexmono <- t.test(covariates_y1 %>% subset(sex=="F") %>% select(Mono), 
                  covariates_y1 %>% subset(sex=="M") %>% select(Mono),
                  paired=FALSE,
                  alternative = "two.sided")

ttest.sexmono


#Bcells
ggplot(covariates_y1 %>% select(Bcell, sex) %>% na.omit(), aes(x=sex, y=Bcell)) +
  geom_point() +
  labs(x="Sex") +
  scale_x_discrete(labels=c("Female", "Male")) + 
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())+
    geom_signif(comparisons = list(c("F", "M")), 
              map_signif_level=F, col="black", 
              annotation = c("t = 0.38179, p-value = 0.7032"),
              textsize = 5)


ttest.sexbcell <- t.test(covariates_y1 %>% subset(sex=="F") %>% select(Bcell), 
                  covariates_y1 %>% subset(sex=="M") %>% select(Bcell),
                  paired=FALSE,
                  alternative = "two.sided")

ttest.sexbcell


#natural killer cells
ggplot(covariates_y1 %>% select(NK, sex) %>% na.omit(), aes(x=sex, y=NK)) +
  geom_point() +
  labs(x="Sex") +
  scale_x_discrete(labels=c("Female", "Male")) + 
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())+
    geom_signif(comparisons = list(c("F", "M")), 
              map_signif_level=F, col="black", 
              annotation = c("t = 0.73615, p-value = 0.4631"),
              textsize = 5)


ttest.sexnk <- t.test(covariates_y1 %>% subset(sex=="F") %>% select(NK), 
                  covariates_y1 %>% subset(sex=="M") %>% select(NK),
                  paired=FALSE,
                  alternative = "two.sided")

ttest.sexnk
```


Predict PBMC cell types based on method of delivery.  
```{r pbmc.celltypes.mod}

#cd4t cells
ggplot(covariates_y1 %>% select(mod_cv, CD4T) %>% na.omit(), aes(x=mod_cv, y=CD4T)) +
  geom_point() +
  labs(x="Method of delivery") +
  #scale_x_discrete(labels=c("Caesarean", "Vaginal")) +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank()) +
    geom_signif(comparisons = list(c("caesarean", "vaginal")), 
              map_signif_level=F, col="black", 
              annotation = c("t = 1.2308, p-value = 0.222"), 
              textsize = 5)


modcd4t <- t.test(covariates_y1 %>% subset(mod_cv=="caesarean") %>% select(CD4T), 
                  covariates_y1 %>% subset(mod_cv=="vaginal") %>% select(CD4T),
                  paired=FALSE,
                  alternative = "two.sided")

modcd4t



#cd8t cells
ggplot(covariates_y1 %>% select(mod_cv, CD8T) %>% na.omit(), aes(x=mod_cv, y=CD8T)) +
  geom_point() +
  labs(x="Method of delivery") +
  #scale_x_discrete(labels=c("Caesarean", "Vaginal")) +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank()) +
    geom_signif(comparisons = list(c("caesarean", "vaginal")), 
              map_signif_level=F, col="black", 
              annotation = c("t = -3.8832, p-value = 0.000184"),
               textsize = 5)


modcd8t <- t.test(covariates_y1 %>% subset(mod_cv=="caesarean") %>% select(CD8T), 
                  covariates_y1 %>% subset(mod_cv=="vaginal") %>% select(CD8T),
                  paired=FALSE,
                  alternative = "two.sided")

modcd8t


#mononuclear cells
ggplot(covariates_y1 %>% select(mod_cv, Mono) %>% na.omit(), aes(x=mod_cv, y=Mono)) +
  geom_point() +
  labs(x="Method of delivery") +
  #scale_x_discrete(labels=c("Caesarean", "Vaginal")) +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank()) +
    geom_signif(comparisons = list(c("caesarean", "vaginal")), 
              map_signif_level=F, col="black", 
              annotation = c("t = 0.87844, p-value = 0.3826"),
               textsize = 5)


modmono <- t.test(covariates_y1 %>% subset(mod_cv=="caesarean") %>% select(Mono), 
                  covariates_y1 %>% subset(mod_cv=="vaginal") %>% select(Mono),
                  paired=FALSE,
                  alternative = "two.sided")

modmono


#Bcells
ggplot(covariates_y1 %>% select(mod_cv, Bcell) %>% na.omit(), aes(x=mod_cv, y=Bcell)) +
  geom_point() +
  labs(x="Method of delivery") +
  #scale_x_discrete(labels=c("Caesarean", "Vaginal")) +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank()) +
    geom_signif(comparisons = list(c("caesarean", "vaginal")), 
              map_signif_level=F, col="black", 
              annotation = c("t = 0.54951, p-value = 0.5843"),
               textsize = 5)


modbcell <- t.test(covariates_y1 %>% subset(mod_cv=="caesarean") %>% select(Bcell), 
                  covariates_y1 %>% subset(mod_cv=="vaginal") %>% select(Bcell),
                  paired=FALSE,
                  alternative = "two.sided")
modbcell


#natural killer cells
ggplot(covariates_y1 %>% select(mod_cv, NK) %>% na.omit(), aes(x=mod_cv, y=NK)) +
  geom_point() +
  labs(x="Method of delivery") +
 # scale_x_discrete(labels=c("Caesarean", "Vaginal")) +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank()) +
    geom_signif(comparisons = list(c("caesarean", "vaginal")), 
              map_signif_level=F, col="black", 
              annotation = c("t = 1.0083, p-value = 0.3163"),
               textsize = 5)


modNK <- t.test(covariates_y1 %>% subset(mod_cv=="caesarean") %>% select(NK), 
                  covariates_y1 %>% subset(mod_cv=="vaginal") %>% select(NK),
                  paired=FALSE,
                  alternative = "two.sided")
modNK

```


Predict PBMC cell types based on gestational age (in days).  
```{r pbmc.celltypes.gestationalage}

#cd4t cells
ggplot(covariates_y1, aes(x=gestational_days, y=CD4T)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Gestational age (days)") + 
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())


#cd8t cells
ggplot(covariates_y1, aes(x=gestational_days, y=CD8T)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Gestational age (days)") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

#mononuclear cells
ggplot(covariates_y1, aes(x=gestational_days, y=Mono)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Gestational age (days)") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

#Bcells
ggplot(covariates_y1, aes(x=gestational_days, y=Bcell)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE)  +
  stat_cor(method = "pearson", size=10) +
  labs(x="Gestational age (days)") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

#natural killer cells
ggplot(covariates_y1, aes(x=gestational_days, y=NK)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Gestational age (days)") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

```


Predict PBMC cell types based on birth weight.
```{r pbmc.celltypes.birthweight}

#cd4t cells
ggplot(covariates_y1, aes(x=weight_birth, y=CD4T)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Birth weight") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

#cd8t cells
ggplot(covariates_y1, aes(x=weight_birth, y=CD8T)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Birth weight") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

#mononuclear cells
ggplot(covariates_y1, aes(x=weight_birth, y=Mono)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Birth weight") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

#Bcells
ggplot(covariates_y1, aes(x=weight_birth, y=Bcell)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Birth weight") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

#natural killer cells
ggplot(covariates_y1, aes(x=weight_birth, y=NK)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Birth weight") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())


```



Predict PBMC cell types based on mom asthma. 
```{r pbmc.celltypes.momasthma}

#cd4t cells
ggplot(covariates_y1 %>% subset(maternal_asthma == 0 | maternal_asthma ==1 ), aes(x=as.factor(maternal_asthma), y=CD4T)) +
  geom_point() +
  labs(x="Matneral asthma") +
  theme_bw() +
  theme(panel.border = element_blank(),
        text=element_text(size=20)) +
  geom_signif(comparisons = list(c("0", "1")), 
              map_signif_level=F, col="black", 
              annotation = c("t = -0.70254, p-value = 0.4842"),
              textsize=5)

ttest.momasthma.cd4t <- t.test(covariates_y1 %>% subset(maternal_asthma==0) %>% select(CD4T), 
                               covariates_y1 %>% subset(maternal_asthma==1) %>% select(CD4T),
                               paired=FALSE,
                               alternative = "two.sided")

ttest.momasthma.cd4t


#cd8t cells
ggplot(covariates_y1 %>% subset(maternal_asthma == 0 | maternal_asthma ==1 ), aes(x=as.factor(maternal_asthma), y=CD8T)) +
  geom_point() +
  labs(x="Matneral asthma") +
  theme_bw() +
  theme(panel.border = element_blank(),
        text=element_text(size=20)) +
  geom_signif(comparisons = list(c("0", "1")), 
              map_signif_level=F, col="black", 
              annotation = c("t = -1.7162, p-value = 0.09039"),
              textsize=5)

ttest.momasthma.cd8t <- t.test(covariates_y1 %>% subset(maternal_asthma==0) %>% select(CD8T), 
                               covariates_y1 %>% subset(maternal_asthma==1) %>% select(CD8T),
                               paired=FALSE,
                               alternative = "two.sided")

ttest.momasthma.cd8t


#mononuclear cells
ggplot(covariates_y1 %>% subset(maternal_asthma == 0 | maternal_asthma ==1 ), aes(x=as.factor(maternal_asthma), y=Mono)) +
  geom_point() +
  labs(x="Matneral asthma") +
  theme_bw() +
  theme(panel.border = element_blank(),
        text=element_text(size=20)) +
  geom_signif(comparisons = list(c("0", "1")), 
              map_signif_level=F, col="black", 
              annotation = c("t = 1.0035, p-value = 0.3182"),
              textsize=5)

ttest.momasthma.mono <- t.test(covariates_y1 %>% subset(maternal_asthma==0) %>% select(Mono), 
                               covariates_y1 %>% subset(maternal_asthma==1) %>% select(Mono),
                               paired=FALSE,
                               alternative = "two.sided")

ttest.momasthma.mono


#Bcells
ggplot(covariates_y1 %>% subset(maternal_asthma == 0 | maternal_asthma ==1 ), aes(x=as.factor(maternal_asthma), y=Bcell)) +
  geom_point() +
  labs(x="Matneral asthma") +
  theme_bw() +
  theme(panel.border = element_blank(),
        text=element_text(size=20)) +
  geom_signif(comparisons = list(c("0", "1")), 
              map_signif_level=F, col="black", 
              annotation = c("t = 0.59003, p-value = 0.5564"),
              textsize=5)

ttest.momasthma.bcells <- t.test(covariates_y1 %>% subset(maternal_asthma==0) %>% select(Bcell), 
                               covariates_y1 %>% subset(maternal_asthma==1) %>% select(Bcell),
                               paired=FALSE,
                               alternative = "two.sided") 

ttest.momasthma.bcells 

#natural killer cells
ggplot(covariates_y1 %>% subset(maternal_asthma == 0 | maternal_asthma ==1 ), aes(x=as.factor(maternal_asthma), y=NK)) +
  geom_point() +
  labs(x="Matneral asthma") +
  theme_bw() +
  theme(panel.border = element_blank(),
        text=element_text(size=20)) +
  geom_signif(comparisons = list(c("0", "1")), 
              map_signif_level=F, col="black", 
              annotation = c("t = 1.3193, p-value = 0.1905"),
              textsize=5)

ttest.momasthma.NK <- t.test(covariates_y1 %>% subset(maternal_asthma==0) %>% select(NK), 
                               covariates_y1 %>% subset(maternal_asthma==1) %>% select(NK),
                               paired=FALSE,
                               alternative = "two.sided")

ttest.momasthma.NK

```



PBMCs vs maternal depression
```{r pbmcs_depression}

#cd4t cells
ggplot(covariates_y1, aes(x=csed_y1, y=CD4T)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Year one maternal depression (z-score)") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

#cd8t cells
ggplot(covariates_y1, aes(x=csed_y1, y=CD8T)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Year one maternal depression (z-score)") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

#mononuclear cells
ggplot(covariates_y1, aes(x=csed_y1, y=Mono)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Year one maternal depression (z-score)") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

#Bcells
ggplot(covariates_y1, aes(x=csed_y1, y=Bcell)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Year one maternal depression (z-score)") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

#natural killer cells
ggplot(covariates_y1, aes(x=csed_y1, y=NK)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Year one maternal depression (z-score)") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())



```

PBMC vs Maternal stress
```{r celltype_stress}
#cd4t cells
ggplot(covariates_y1, aes(x=pss_y1, y=CD4T)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Year one maternal stress (z-score)") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

#cd8t cells
ggplot(covariates_y1, aes(x=pss_y1, y=CD8T)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Year one maternal stress (z-score)") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

#mononuclear cells
ggplot(covariates_y1, aes(x=pss_y1, y=Mono)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Year one maternal stress (z-score)") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

#Bcells
ggplot(covariates_y1, aes(x=pss_y1, y=Bcell)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Year one maternal stress (z-score)") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

#natural killer cells
ggplot(covariates_y1, aes(x=pss_y1, y=NK)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Year one maternal stress (z-score)") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())



```

PBMCs vs year one ses
```{r pbmc_ses}
#cd4t cells
ggplot(covariates_y1, aes(x=composite_ses, y=CD4T)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Composite SES (z-score)") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

#cd8t cells
ggplot(covariates_y1, aes(x=composite_ses, y=CD8T)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Composite SES (z-score)") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

#mononuclear cells
ggplot(covariates_y1, aes(x=composite_ses, y=Mono)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Composite SES (z-score)") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

#Bcells
ggplot(covariates_y1, aes(x=composite_ses, y=Bcell)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Composite SES (z-score)") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

#natural killer cells
ggplot(covariates_y1, aes(x=composite_ses, y=NK)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Composite SES (z-score)") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())


```

Year one depression vs year one stress
```{r depression_stress}
ggplot(covariates_y1, aes(x=csed_y1, y=pss_y1)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Year one maternal depression (z-score)", y="Year one maternal stress (z-score)") +
  theme_bw() + 
  theme(text=element_text(size=15),
        panel.border = element_blank())

```

Maternal depression vs ses
```{r depression_ses}
ggplot(covariates_y1, aes(x=composite_ses, y=csed_y1)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Composite SES (z-score)", y="Year one maternal depression (z-score)") +
  theme_bw() + 
  theme(text=element_text(size=15),
        panel.border = element_blank())

```

Maternal stress vs ses
```{r stress_ses}
ggplot(covariates_y1, aes(x=composite_ses, y=pss_y1)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Composite SES (z-score)", y="Year one maternal stress (z-score)") +
  theme_bw() + 
  theme(text=element_text(size=15),
        panel.border = element_blank())

```


Pbmcs vs age 5 asthma
```{r pbmc_age5_asthma}
#cd4t cells
ggplot(covariates_y1 %>% subset(clinician_asthma_dx_5y == 0 | clinician_asthma_dx_5y == 1 |
                                  clinician_asthma_dx_5y == 2), aes(x=clinician_asthma_dx_5y, y=CD4T)) +
  geom_point() +
  labs(x="Clinician diagnosed asthma (age 5)") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

cd4t.asthma5 <- lm(CD4T ~ clinician_asthma_dx_5y, covariates_y1)
anova(cd4t.asthma5)


#cd8t cells
ggplot(covariates_y1 %>% subset(clinician_asthma_dx_5y == 0 | clinician_asthma_dx_5y == 1 |
                                  clinician_asthma_dx_5y == 2), aes(x=clinician_asthma_dx_5y, y=CD8T)) +
  geom_point() +
  labs(x="Clinician diagnosed asthma (age 5)") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

cd8t.asthma5 <- lm(CD8T ~ clinician_asthma_dx_5y, covariates_y1)
anova(cd8t.asthma5)

#mononuclear cells
ggplot(covariates_y1 %>% subset(clinician_asthma_dx_5y == 0 | clinician_asthma_dx_5y == 1 |
                                  clinician_asthma_dx_5y == 2), aes(x=clinician_asthma_dx_5y, y=Mono)) +
  geom_point() +
  labs(x="Clinician diagnosed asthma (age 5)") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

mono.asthma5 <- lm(Mono ~ clinician_asthma_dx_5y, covariates_y1)
anova(mono.asthma5)


#Bcells
ggplot(covariates_y1 %>% subset(clinician_asthma_dx_5y == 0 | clinician_asthma_dx_5y == 1 |
                                  clinician_asthma_dx_5y == 2), aes(x=clinician_asthma_dx_5y, y=Bcell)) +
  geom_point() +
  labs(x="Clinician diagnosed asthma (age 5)") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

bcell.asthma5 <- lm(Bcell ~ clinician_asthma_dx_5y, covariates_y1)
anova(bcell.asthma5)


#natural killer cells
ggplot(covariates_y1 %>% subset(clinician_asthma_dx_5y == 0 | clinician_asthma_dx_5y == 1 |
                                  clinician_asthma_dx_5y == 2), aes(x=clinician_asthma_dx_5y, y=NK)) +
  geom_point() +
  labs(x="Clinician diagnosed asthma (age 5)") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

nk.asthma5 <- lm(NK ~ clinician_asthma_dx_5y, covariates_y1)
anova(nk.asthma5)
```




No2 and ses
```{r no2_ses}
ggplot(covariates_y1, aes(x=composite_ses, y=no2_y1_entire)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE, col="#75A2D9") +
  stat_cor(method = "pearson", size=8) +
  labs(x="Composite SES (z-score)", y = bquote('Average year one'~ NO[2] ~(μg/m^3))) +
  theme_bw() + 
  #scale_x_discrete(labels = c("No", "Yes", "Probable")) +
  theme(text=element_text(size=18),
        panel.border = element_blank())


ggplot(covariates_y1, aes(x=composite_ses, y=no2_y1_entire, col=studycentre)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=5) +
  labs(x="Composite SES (z-score)", y=bquote('Average year one'~ NO[2] ~(μg/m^3))) +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

#no2 by study centre

ggplot(covariates_y1, aes(x=as.factor(studycentre), y=no2_y1_entire, fill=studycentre)) +
  geom_boxplot() + 
  geom_jitter(height=0, width=0.3) +
  labs(x="Study Centre", y=bquote('Average year one'~ NO[2] ~(μg/m^3))) +
  scale_fill_manual(values=c("#EEF0FF", "#BCD6FB", "#75A2D9", "#27497F"))+
  theme_bw() + 
  theme(text=element_text(size=18),
        panel.border = element_blank(),
        legend.position = "none")


#anova for effects
no2.studycentre <- lm(no2_y1_entire ~ studycentre, covariates_y1)
anova(no2.studycentre)
no2.studycentre.aov <- aov(no2_y1_entire ~ studycentre, covariates_y1)
no2.studycentre.tukey <- TukeyHSD(no2.studycentre.aov)
no2.studycentre.tukey
```



Maternal smoking year one vs pbmcs
```{r pbmc_mat_smoking}

#cd4t cells
ggplot(covariates_y1 %>% select(CD4T, maternal_smoking_y1) %>% na.omit(), aes(x=maternal_smoking_y1, y=CD4T)) +
  geom_point() +
  labs(x="Sex") +
  labs(x="Year one maternal smoking") +
  scale_x_discrete(labels=c("No", "Yes")) +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank()) +
    geom_signif(comparisons = list(c("0", "1")), 
              map_signif_level=F, col="black", 
              annotation = c("t = -0.38256, p-value = 0.7127"),
              textsize = 5)

smoking_cd4t <- t.test(covariates_y1 %>% subset(maternal_smoking_y1=="0") %>% select(CD4T), 
                  covariates_y1 %>% subset(maternal_smoking_y1=="1") %>% select(CD4T),
                  paired=FALSE,
                  alternative = "two.sided")



#cd8t cells
ggplot(covariates_y1 %>% select(CD8T, maternal_smoking_y1) %>% na.omit(), aes(x=maternal_smoking_y1, y=CD8T)) +
  geom_point() +
  labs(x="Year one maternal smoking") +
  scale_x_discrete(labels=c("No", "Yes")) +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank()) +
    geom_signif(comparisons = list(c("0", "1")), 
              map_signif_level=F, col="black", 
              annotation = c("t = -1.5739, p-value = 0.1556"),
              textsize = 5)


smoking_cd8t <- t.test(covariates_y1 %>% subset(maternal_smoking_y1=="0") %>% select(CD8T), 
                  covariates_y1 %>% subset(maternal_smoking_y1=="1") %>% select(CD8T),
                  paired=FALSE,
                  alternative = "two.sided")

#mononuclear cells
ggplot(covariates_y1 %>% select(Mono, maternal_smoking_y1) %>% na.omit(), 
       aes(x=maternal_smoking_y1, y=Mono, fill=maternal_smoking_y1)) +
  geom_boxplot()+
  geom_jitter(height=0, width=0.3) +
  labs(x="Year one maternal smoking") +
  scale_fill_manual(values=c("#EEF0FF", "#75A2D9")) +
  scale_x_discrete(labels=c("No", "Yes")) +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank(),
        legend.position = "none") +
  ylim(0, 0.45) +
    geom_signif(comparisons = list(c("0", "1")), 
              map_signif_level=F, col="black", 
              annotation = c("***"),
              textsize = 10)


smoking_mono <- t.test(covariates_y1 %>% subset(maternal_smoking_y1=="0") %>% select(Mono), 
                  covariates_y1 %>% subset(maternal_smoking_y1=="1") %>% select(Mono),
                  paired=FALSE,
                  alternative = "two.sided")



#Bcells
ggplot(covariates_y1 %>% select(Bcell, maternal_smoking_y1) %>% na.omit(), aes(x=maternal_smoking_y1, y=Bcell)) +
  geom_point() +
  labs(x="Year one maternal smoking") +
  scale_x_discrete(labels=c("No", "Yes")) +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())+
    geom_signif(comparisons = list(c("0", "1")), 
              map_signif_level=F, col="black", 
              annotation = c("t = 0.51268, p-value = 0.6229"),
              textsize = 5)


smoking_bcell <- t.test(covariates_y1 %>% subset(maternal_smoking_y1=="0") %>% select(Bcell), 
                  covariates_y1 %>% subset(maternal_smoking_y1=="1") %>% select(Bcell),
                  paired=FALSE,
                  alternative = "two.sided")


#natural killer cells
ggplot(covariates_y1 %>% select(NK, maternal_smoking_y1) %>% na.omit(), aes(x=maternal_smoking_y1, y=NK)) +
  geom_point() +
  labs(x="Year one maternal smoking") +
  scale_x_discrete(labels=c("No", "Yes")) + 
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())+
    geom_signif(comparisons = list(c("0", "1")), 
              map_signif_level=F, col="black", 
              annotation = c("t = 0.17188, p-value = 0.8681"),
              textsize = 5)


smoking_nk <- t.test(covariates_y1 %>% subset(maternal_smoking_y1=="0") %>% select(NK), 
                  covariates_y1 %>% subset(maternal_smoking_y1=="1") %>% select(NK),
                  paired=FALSE,
                  alternative = "two.sided")
```



Year one maternal smoking vs age 5 asthma diagnosis
```{r smoking_asthma}
ggplot(covariates_y1 %>% select(clinician_asthma_dx_5y, maternal_smoking_y1) %>% na.omit(), aes(x=clinician_asthma_dx_5y, y=maternal_smoking_y1)) +
  geom_jitter(width=0.3, height=0.3) +
  labs(x="Age 5 asthma diagnosis", y = "Year one maternal smoking") +
  scale_x_discrete(labels=c("No", "Yes", "Probable")) + 
  scale_y_discrete(labels=c("No", "Yes")) +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

matsmokey1.asthma5 <- table(covariates_y1$maternal_smoking_y1, covariates_y1$clinician_asthma_dx_5y)
matsmokey1.asthma5.fisher <- fisher.test(matsmokey1.asthma5)
matsmokey1.asthma5.fisher
```

Urine cotinine at 3 months vs pbmcs
```{r pbmc_cotinine}
#cd4t cells
ggplot(covariates_y1 %>% subset(urine_cotinine_3m < 60), aes(x=urine_cotinine_3m, y=CD4T)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Urine cotinine at 3 months") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

#cd8t cells
ggplot(covariates_y1 %>% subset(urine_cotinine_3m < 60), aes(x=urine_cotinine_3m, y=CD8T)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Urine cotinine at 3 months") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

#mononuclear cells
ggplot(covariates_y1 %>% subset(urine_cotinine_3m < 60), aes(x=urine_cotinine_3m, y=Mono)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Urine cotinine at 3 months") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

#Bcells
ggplot(covariates_y1 %>% subset(urine_cotinine_3m < 60), aes(x=urine_cotinine_3m, y=Bcell)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Urine cotinine at 3 months") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())

#natural killer cells
ggplot(covariates_y1 %>% subset(urine_cotinine_3m < 60), aes(x=urine_cotinine_3m, y=NK)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Urine cotinine at 3 months") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank())


```

Urine cotinine at 3 months vs age 5 asthma diagnosis
```{r cotinine_age5_asthma}
ggplot(covariates_y1 %>% subset(clinician_asthma_dx_5y == 0 | clinician_asthma_dx_5y == 1 |
                                  clinician_asthma_dx_5y == 2) %>% subset(urine_cotinine_3m <60), aes(x=clinician_asthma_dx_5y, y=urine_cotinine_3m)) +
  geom_point() +
  labs(x="Clinician diagnosed asthma (age 5)", y = "Urine cotinine at 3 months") +
  theme_bw() + 
  scale_x_discrete(labels = c("No", "Yes", "Probable")) +
  theme(text=element_text(size=20),
        panel.border = element_blank())

```

Urine cotinine at 3 months vs maternal smoking at 1 year
```{r urine_cotinine_mat_smoking}
ggplot(covariates_y1 %>% subset(maternal_smoking_y1 == 0 | maternal_smoking_y1 == 1) %>% subset(urine_cotinine_3m <60), aes(x=maternal_smoking_y1, y=urine_cotinine_3m)) +
  geom_point() +
  labs(x="Year one maternal smoking ", y = "Urine cotinine at 3 months") +
  theme_bw() + 
  scale_x_discrete(labels = c("No", "Yes")) +
  theme(text=element_text(size=20),
        panel.border = element_blank()) +
    geom_signif(comparisons = list(c("0", "1")), 
              map_signif_level=F, col="black", 
              annotation = c("t = -1.0549, p-value = 0.3321"),
              textsize = 5)


cotinine_smoke <- t.test(covariates_y1 %>% subset(maternal_smoking_y1=="0") %>% select(urine_cotinine_3m), 
                  covariates_y1 %>% subset(maternal_smoking_y1=="1") %>% select(urine_cotinine_3m),
                  paired=FALSE,
                  alternative = "two.sided")

```


Maternal smoking vs SES
```{r smoking_ses}
ggplot(covariates_y1 %>% subset(maternal_smoking_y1 == 0 | maternal_smoking_y1 == 1), aes(x=maternal_smoking_y1, y=composite_ses)) +
  geom_point() +
  labs(x="Year one maternal smoking ", y = "Composite SES (z-score)") +
  theme_bw() + 
  scale_x_discrete(labels = c("No", "Yes")) +
  theme(text=element_text(size=20),
        panel.border = element_blank()) +
    geom_signif(comparisons = list(c("0", "1")), 
              map_signif_level=F, col="black", 
              annotation = c("t = 2.3227, p-value = 0.06382"),
              textsize = 5)


smoke_ses <- t.test(covariates_y1 %>% subset(maternal_smoking_y1=="0") %>% select(composite_ses), 
                  covariates_y1 %>% subset(maternal_smoking_y1=="1") %>% select(composite_ses),
                  paired=FALSE,
                  alternative = "two.sided")
```

Urine cotinine vs ses
```{r cotinine_ses}
ggplot(covariates_y1 %>% subset(urine_cotinine_3m <60), aes(x=composite_ses, y=urine_cotinine_3m)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Composite SES (z-score)", y = "Urine cotinine at 3 months") +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank()) 
```



### Create heatmap of cell types vs covariates to condense data down.





Year one maternal stress and depression vs composite ses
```{r csed_pss_ses}
ggplot(covariates_y1, aes(x=composite_ses, y=pss_csed_y1)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE) +
  stat_cor(method = "pearson", size=10) +
  labs(x="Composite SES (z-score)", y = "Year one maternal stress and depression (z-score)") +
  theme_bw() + 
  #scale_x_discrete(labels = c("No", "Yes", "Probable")) +
  theme(text=element_text(size=15),
        panel.border = element_blank())

```


Prenatal maternal stress and depression sv year one maternal stress and depression
```{r csed_pss_prenatal_y1}
ggplot(covariates_y1, aes(x=pss_csed_prenatal, y=pss_csed_y1)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE, col="#75A2D9") +
  stat_cor(method = "pearson", size=8) +
  labs(x="Prenatal stress and depression (z-score)", y = "Year one stress and depression (z-score)") +
  theme_bw() + 
  #scale_x_discrete(labels = c("No", "Yes", "Probable")) +
  theme(text=element_text(size=15),
        panel.border = element_blank())




```



Prenatal maternal smoking vs year one stress and depression
```{r prenatalsmoking_y1_csed_pss}

ggplot(covariates_y1 %>% subset(prenatal_maternal_smoking==1 | prenatal_maternal_smoking==0), aes(x=prenatal_maternal_smoking, y=pss_csed_y1, fill=prenatal_maternal_smoking)) +
  geom_boxplot() +
  geom_jitter(height = 0, width = 0.3) + 
  scale_fill_manual(values=c("#EEF0FF", "#75A2D9")) +
  labs(x="Prenatal maternal smoking", y = "Year one stress and depression (z-score)") +
  theme_bw() + 
  scale_x_discrete(labels = c("No", "Yes")) +
  ylim(-1.5,4) +
  theme(text=element_text(size=15),
        panel.border = element_blank(),
        legend.position = "none") +
  geom_signif(comparisons = list(c("0", "1")), 
              map_signif_level=F, col="black", 
              annotation = c("*"),
              textsize = 10)


prenatalsmoke.psscsedy1 <- t.test(covariates_y1 %>% subset(prenatal_maternal_smoking=="0") %>%
                                    select(pss_csed_y1), 
                                  covariates_y1 %>% subset(prenatal_maternal_smoking=="1") %>%
                                    select(pss_csed_y1),
                                  paired=FALSE,
                                  alternative = "two.sided")
prenatalsmoke.psscsedy1

```


PBMC Cell type vs study centre
```{r pbmcs_studysite}

#cd4t cells
ggplot(covariates_y1 , aes(x=studycentre, y=CD4T * 100, fill=studycentre)) +
  geom_boxplot() + 
  geom_jitter(height = 0, width = 0.3) +
  labs(x="Study centre", y="CD4T (%)") +
  scale_fill_manual(values=c("#EEF0FF", "#BCD6FB", "#75A2D9", "#27497F")) +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank(),
        legend.position="none") 

#anova for effects
cd4t.studycentre <- lm(CD4T ~ studycentre, covariates_y1)
anova(cd4t.studycentre)
cd4t.studycentre.aov <- aov(CD4T ~ studycentre, covariates_y1)
cd4t.studycentre.tukey <- TukeyHSD(cd4t.studycentre.aov)
cd4t.studycentre.tukey


#cd8t
ggplot(covariates_y1 , aes(x=studycentre, y=CD8T*100, fill=studycentre)) +
  geom_boxplot() + 
  geom_jitter(height = 0, width = 0.3) +
  labs(x="Study centre", y="CD8T (%)") +
  scale_fill_manual(values=c("#EEF0FF", "#BCD6FB", "#75A2D9", "#27497F")) +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank(),
        legend.position="none") 

#anova for effects
cd8t.studycentre <- lm(CD8T ~ studycentre, covariates_y1)
anova(cd8t.studycentre)
cd8t.studycentre.aov <- aov(CD8T ~ studycentre, covariates_y1)
cd8t.studycentre.tukey <- TukeyHSD(cd8t.studycentre.aov)
cd8t.studycentre.tukey


#mono
ggplot(covariates_y1 , aes(x=studycentre, y=Mono*100, fill=studycentre)) +
  geom_boxplot() + 
  geom_jitter(height = 0, width = 0.3) +
  labs(x="Study centre", y="Mono (%)") +
  scale_fill_manual(values=c("#EEF0FF", "#BCD6FB", "#75A2D9", "#27497F")) +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank(),
        legend.position="none") +
    geom_signif(comparisons = list(c("Winnipeg", "Toronto")), 
              map_signif_level=F, col="black", 
              annotation = c("*"),
              textsize = 10) +
  ylim(5, 45)

#anova for effects
mono.studycentre <- lm(Mono ~ studycentre, covariates_y1)
anova(mono.studycentre)
mono.studycentre.aov <- aov(Mono ~ studycentre, covariates_y1)
mono.studycentre.tukey <- TukeyHSD(mono.studycentre.aov)
mono.studycentre.tukey


#bcell
ggplot(covariates_y1 , aes(x=studycentre, y=Bcell*100, fill=studycentre)) +
  geom_boxplot() + 
  geom_jitter(height = 0, width = 0.3) +
  labs(x="Study centre", y="Bcell (%)") +
  scale_fill_manual(values=c("#EEF0FF", "#BCD6FB", "#75A2D9", "#27497F")) +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank(),
        legend.position="none") +
      geom_signif(comparisons = list(c("Edmonton", "Toronto")), 
              map_signif_level=F, col="black", 
              y_position = 45,
              annotation = c("*"),
              textsize = 10) +
    geom_signif(comparisons = list(c("Edmonton", "Vancouver")), 
              map_signif_level=F, col="black", 
              y_position = 53,
              annotation = c("*"),
              textsize = 10) +
      geom_signif(comparisons = list(c("Winnipeg", "Vancouver")), 
              map_signif_level=F, col="black", 
              y_position = 58,
              annotation = c("**"),
              textsize = 10) +
  
        geom_signif(comparisons = list(c("Winnipeg", "Toronto")), 
              map_signif_level=F, col="black", 
              y_position = 66,
              annotation = c("**"),
              textsize = 10) +
  ylim(10,70)

#anova for effects
bcell.studycentre <- lm(Bcell ~ studycentre, covariates_y1)
anova(bcell.studycentre)
bcell.studycentre.aov <- aov(Bcell ~ studycentre, covariates_y1)
bcell.studycentre.tukey <- TukeyHSD(bcell.studycentre.aov)
bcell.studycentre.tukey
 
#nk
ggplot(covariates_y1 , aes(x=studycentre, y=NK*100, fill=studycentre)) +
  geom_boxplot() + 
  geom_jitter(height = 0, width = 0.3) +
  labs(x="Study centre", y="NK (%)") +
  scale_fill_manual(values=c("#EEF0FF", "#BCD6FB", "#75A2D9", "#27497F")) +
  theme_bw() + 
  theme(text=element_text(size=20),
        panel.border = element_blank(),
        legend.position="none") 

#anova for effects
nk.studycentre <- lm(NK ~ studycentre, covariates_y1)
anova(nk.studycentre)
nk.studycentre.aov <- aov(NK ~ studycentre, covariates_y1)
nk.studycentre.tukey <- TukeyHSD(nk.studycentre.aov)
nk.studycentre.tukey
```

Year one maternal smoking and prenatal smoking 
```{r prenatal_yearone_smoking}
ggplot(covariates_y1 %>% select(prenatal_maternal_smoking, maternal_smoking_y1) %>% na.omit(),
       aes(x=prenatal_maternal_smoking, y=maternal_smoking_y1)) +
  geom_jitter(height=0.2, width=0.2) +
  labs(x="Prenatal maternal smoking", y = "Maternal smoking year one") +
  theme_bw() + 
  scale_x_discrete(labels = c("No", "Yes")) +
  scale_y_discrete(labels = c("No", "Yes")) +
  theme(text=element_text(size=15),
        panel.border = element_blank()) +
      geom_signif(comparisons = list(c("0", "1")), 
              map_signif_level=F, col="black", 
              annotation = c("***"),
              textsize = 10) 
  ylim(5, 45)

smoking.table <- table(covariates_y1$prenatal_maternal_smoking,covariates_y1$maternal_smoking_y1)
smoking.fishers <- fisher.test(smoking.table)
smoking.fishers
```


Prenatal no2 vs postnatal no2
```{r prenatal_yearone_no2}
ggplot(covariates_y1, aes(x=no2_preg_entire, y=no2_y1_entire)) +
  geom_point() +
  geom_smooth(method='lm', se=FALSE, col="#75A2D9") +
  stat_cor(method = "pearson", size=8) +
  labs(x=bquote('Average prenatal'~ NO[2] ~(μg/m^3)), y = bquote('Average year one'~ NO[2] ~(μg/m^3))) +
  theme_bw() + 
  #scale_x_discrete(labels = c("No", "Yes", "Probable")) +
  theme(text=element_text(size=18),
        panel.border = element_blank())



```

Maternal age vs study site
```{r maternalage_studysite}
ggplot(covariates_y1 , aes(x=studycentre, y=maternal_age, fill=studycentre)) +
  geom_boxplot() + 
  geom_jitter(height = 0, width = 0.3) +
  labs(x="Study centre", y="Maternal age (years)") +
  scale_fill_manual(values=c("#EEF0FF", "#BCD6FB", "#75A2D9", "#27497F")) +
  theme_bw() + 
  ylim(20,50) +
  theme(text=element_text(size=20),
        panel.border = element_blank(),
        legend.position="none") +
      geom_signif(comparisons = list(c("Winnipeg", "Toronto")), 
              map_signif_level=F, col="black", 
              annotation = c("**"),
              textsize = 10) 

#anova for effects
age.studycentre <- lm(maternal_age ~ studycentre, covariates_y1)
anova(age.studycentre)
age.studycentre.aov <- aov(maternal_age ~ studycentre, covariates_y1)
age.studycentre.tukey <- TukeyHSD(age.studycentre.aov)
age.studycentre.tukey
```







### Correlation matrix for participants in the year one time point (and with missing values filled in with means)

Subset year one pdata, cell counts, and genosub for samples that have DNAm at both birth and age one.
```{r sub_y1pdata}
#sub pdata
y1_pdata_sub <- 
  y1_pdata[y1_pdata$Sample_Label %in% pdata_nodups[pdata_nodups$Tissue=="C","Sample_Label"],]

#check size
dim(y1_pdata_sub) #144 14

#populate rownames with sample label
rownames(y1_pdata_sub) <- y1_pdata_sub$Sample_Label

#rename run and row of y1_pdata
y1_pdata_sub$row_y1 <- substr(y1_pdata_sub$Sentrix_Position,1,3)
y1_pdata_sub$row_y1 <- as.numeric(as.factor(y1_pdata_sub$row_y1))
y1_pdata_sub$run_y1 <- as.factor(y1_pdata_sub$Run) 

#Add cord blood technical variables run and row to y1 pdata
y1_pdata_sub$run_cb <- as.factor(pdata_nodups[pdata_nodups$Tissue=="C","Run"]) 
y1_pdata_sub$row_cb <- substr(pdata_nodups[pdata_nodups$Tissue=="C","Sentrix_Position"],1,3) 
y1_pdata_sub$row_cb <- as.numeric(as.factor(y1_pdata_sub$row_cb ))


#sub genosub for samples in y1 pdata
genosub_y1 <- genotyping[rownames(genotyping) %in% rownames(y1_pdata_sub), ]

#check size
dim(genosub_y1) #144 11

#sub y1 pdata for genosub_y1
y1_pdata_sub_geno <- y1_pdata_sub[rownames(genosub_y1), ]

#check size
dim(y1_pdata_sub_geno) #131 14

#cell counts
child_fscbc_ecc2_y1_df_sub <- child_fscbc_ecc2_y1_df[rownames(y1_pdata_sub_geno),]

#check size
dim(child_fscbc_ecc2_y1_df_sub) #131 5

#check order
identical(rownames(genosub_y1), rownames(y1_pdata_sub_geno)) # True
identical(rownames(child_fscbc_ecc2_y1_df_sub), rownames(y1_pdata_sub_geno)) # True
```


Load cell type PCs
```{r y1_celltype_PCs}
load(here("output_data", "deconvolution", "2021-01-25_CHILD_CBMC_PBMC_PCs.Rdata"))

#rename cols
colnames(ccc_pcs) <- paste("y1.celltype.", colnames(ccc_pcs), sep="")

#susbet pcs for smaples 
ccc_pcs_sub <- ccc_pcs[rownames(y1_pdata_sub_geno), ]

#check size
dim(ccc_pcs_sub) #131 11

#check order
identical(rownames(ccc_pcs_sub), rownames(y1_pdata_sub_geno)) #True
```


Now only include children used in linear regressions with nameans data.
```{r y1_125}
#load covariates with na means
load(here("output_data", "covariates", "2020-11-12_CHILD_covariates_na_with_means.Rdata"))

#population row names with sample ids
rownames(covariates_nameans) <- covariates_nameans$sampleid

#sub covariates according to y1_pdata_sub_geno
covariates_nameans_geno <- covariates_nameans[rownames(y1_pdata_sub_geno),]

#check size
dim(covariates_nameans_geno) #131 

#check order
identical(rownames(covariates_nameans_geno), rownames(y1_pdata_sub_geno)) #True

#cbind covariates, cell counts, combined cell count PCs, tech vars, and genoting together
covariates_nameans_geno <- cbind(covariates_nameans_geno, 
                                 genosub_y1,
                                 child_fscbc_ecc2_y1_df_sub,
                                 ccc_pcs_sub,
                                 y1_pdata_sub_geno[,c("run_y1", "row_y1",
                                                      "run_cb", "row_cb")])

covariates_nameans_geno_cc <- covariates_nameans_geno[
  complete.cases(covariates_nameans_geno[,c( "no2_y1_entire","maternal_smoking_y1", 
                                             "sex","pss_6mos","csed_6mos", 
                                             "maternal_education_length")]), ]

dim(covariates_nameans_geno_cc) #125 144
```


Get pvalues for covariates_cb101 
```{r get-pvals}
#sub for covariates of interested
covariates_nameans_geno_cc_sub <- subset(covariates_nameans_geno_cc, 
                                     select=c(no2_y1_entire, maternal_smoking_y1, 
                                              sex,pss_6mos,csed_6mos, 
                                              maternal_education_length,
                                              y1.celltype.PC1, y1.celltype.PC2,
                                              y1.celltype.PC3, y1.celltype.PC4,
                                              y1.celltype.PC5, y1.celltype.PC6,
                                              y1.celltype.PC7, y1.celltype.PC8,
                                              y1.celltype.PC9, 
                                              PC1, PC2, PC3,
                                              run_cb, row_cb,
                                              run_y1, row_y1,
                                              studycentre))

#pvals calcs
covariates_nameans_geno_cc_sub_pval <- pval2(covariates_nameans_geno_cc_sub)
```


Calculate correlations between metadata variables using cor2 function above.  
```{r calc_covariate_corr}
#correlation calcs
covariates_nameans_geno_cc_sub_corr <- cor2(covariates_nameans_geno_cc_sub)


#set missing values (999) to NA - could have probably done this in the cor2 function
covariates_nameans_geno_cc_sub_corr[covariates_nameans_geno_cc_sub_corr == 999] <- NA
``` 



```{r corrplot_cb101}
corrplot(covariates_nameans_geno_cc_sub_corr,
         pch = 8,
         pch.cex = 1,
         type = "lower", 
         p.mat = covariates_nameans_geno_cc_sub_pval,
         insig = "blank",
         lab=TRUE,
         tl.cex = 5, 
         colors = c("#6D9EC1", "white", "#E46726")) +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        legend.key.height = unit(0.5, 'cm'),
        legend.key.width = unit(0.2, 'cm'),
        legend.text = element_text(size=5),
        legend.title = element_text(size=6),
        legend.position="left") +
 scale_y_discrete(labels = c("Year one NO2", "Maternal smoking", "Sex", 
                              "Maternal stress", "Maternal depression",
                              "Maternal education length", 
                             "Cell type PC1", "Cell type PC2",  "Cell type PC3",
                             "Cell type PC4", "Cell type PC5",  "Cell type PC6",
                             "Cell type PC7", "Cell type PC8 ",  "Cell type PC9",
                              "Genotyping PC1", "Genotyping PC2", "Genotyping PC3",
                             "Cord blood run", "Cord blood row",
                             "Periperhal blood run", "Peripheral blood row"),
                   position = "right") +
  scale_x_discrete(labels = c("Maternal smoking", "Sex", 
                              "Maternal stress", "Maternal depression",
                              "Maternal education length", 
                             "Cell type PC1", "Cell type PC2",  "Cell type PC3",
                             "Cell type PC4", "Cell type PC5",  "Cell type PC6",
                             "Cell type PC7", "Cell type PC8 ",  "Cell type PC9",
                              "Genotyping PC1", "Genotyping PC2", "Genotyping PC3",
                             "Cord blood run", "Cord blood row",
                             "Periperhal blood run", "Peripheral blood row",
                              "Study centre")) 


ggsave(here("figures", "covariates", "2021-01-27_CHILD_yearone125_ctpcs_tech_corrplot.tiff"),
       device="tiff",
       height=3,
       width=6,
       units="in")
```