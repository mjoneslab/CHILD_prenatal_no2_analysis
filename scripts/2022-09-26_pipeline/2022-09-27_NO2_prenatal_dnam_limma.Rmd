---
title: "CHILD cord blood linear regression using limma with covariate missing values filled in with means"
author: "Samantha LEE"
date: "2021-09-24"
output: html_document
---

*Purpose*: The purpose of this script is to examine DNAm changes in cord blood associated with prenatal air pollution exposure (proxied by no2).


Set global chunk options. 
```{r setup, include=FALSE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### Libraries used in analysis

Load required libraries.
```{r libraries}
library(tidyverse) # be tidy
library(limma) # for DNAm differences
library(here) # file calling
library(pbapply) # for running lm for each cpg
library(ggeffects) # for estimating marginal effects
library(broom) # tidy function for summarizing lm
library(sva) # for calculating SVs
library(ggcorrplot) # correlation matrix
library(ggsignif) # for significance comparison bars
library(GenomicRanges) # for data formatting prior to DMR analysis
library(IRanges) # for data formatting prior to DMR analysis
library(ENmix) # for DMR identification using comb-p
library(missMethyl) # gene set enrichment of DMRs
library(lme4) # linear mixed models
library(lmerTest) # get pvalues for linear mixed models
library(Gviz) # plot gene annotations and ChromHMM data
library(org.Hs.eg.db) # get gene annotation from GVIZ figs
```


## Analysis of prenatal air pollution exposure

### Load data

Load betas
```{r betas}
load(file=here("output_data", 
               "preprocessed_data",
               "2022-09-27_CHILD_preprocessed_betas_pdata_annotation.Rdata"))
```

Subset out cord blood betas
```{r nocombat_betas}
# check ranges to confirm DNAm data is in beta value format
dim(betas)
max(betas)
min(betas)

# subset pData into CBMCs (cord blood)
# these children have data at both time points
cb_pdata <- subset(pdata_nodups, Tissue == "C")
# check size of cord blood pdata
dim(cb_pdata)

# subset cordb lood DNAm samples for those included in cord blood pdata
cb_betas <- betas[ ,colnames(betas) %in% rownames(cb_pdata)]

# check size for correct sample number
dim(cb_betas) #144

# check that CBMC betas and pdata are in same order
identical(colnames(cb_betas), rownames(cb_pdata)) # TRUE

# relabel CBMC beta columns with sample label (5 digit identifier)
colnames(cb_betas) <- cb_pdata$Sample_Label
```

Load covariate data. Missing values in covariates of interest have been filled with the mean of that variable. 
```{r covariates}
load(here("output_data", 
          "covariates", 
          "2022-09-27_CHILD_covariates_na_with_means.Rdata"))

dim(covariates_nameans)
```

Subset covariates for individuals with CBMC DNAm.
```{r sub_covariates}
# subset covariates based on samples with DNAm data
covariates_sub <- covariates_nameans[as.character(covariates_nameans$sample_id) 
                                     %in% colnames(cb_betas), ]

# check size
dim(covariates_sub) # 144 120  

# check if subset of covariates and betas are in the same order 
identical(as.character(covariates_sub$sample_id), 
          colnames(cb_betas)) # TRUE
```

Add sample name to cord blood covariate data
```{r add_cb_sample_name}
identical(as.numeric(covariates_sub$sample_id),
          as.numeric(cb_pdata$Sample_Label)) # TRUE

covariates_sub$cb_sample_name <- rownames(cb_pdata)
```


Load CBMC PCs.
```{r load_PC_correctedbetas}
# load the cell type PCs
load(here("output_data", 
          "deconvolution", 
          "2022-09-28_CBMC_PCs.RData"))

# load deconvolution for later use - remove probes 
load(here("output_data",
          "deconvolution", 
          "2022-09-28_cbmc_pbmc_deconvolution.Rdata"))

# check size
dim(cb_ilr$scores) #144 6

# pull out pcs
cb_pcs <- cb_ilr$scores

# check if rownames of cell PCs are same as pdata
identical(rownames(cb_pcs), 
          rownames(cb_pdata)) # FALSE
# cb pcs do not have rownames

# rename rows using sample label (5 digit number)
rownames(cb_pcs) <- cb_pdata$Sample_Label
```

Load genotyping PCs and subset out REEGLE PCs. Genotyping data contains PCs for all CHILD participants that were genotyped.
```{r genotyping_PCS}
# read in genotyping data for CHILD cohort
genotyping <- read.csv(here("input_data", 
                            "genotyping", 
                            "CHILD_subjects_Qced_first10PCS_Duan.csv"))

# make rownames sample names (5 digit number)
rownames(genotyping) <- genotyping$FID
# removing sample naming columns - no longer needed now they are rownames 
genotyping <- subset(genotyping, select=-c(FID, IID))

# susbet genotyping data for REEGLE subset 
genosub <- genotyping[rownames(genotyping) %in% cb_pdata$Sample_Label,]

# check size
dim(genosub) # 131 of 144 children have genotyping

# rename columns of genotyping data for clarity
colnames(genosub) <- paste("genotyping.", colnames(genosub), sep="")

#put rows in numerical order according to sample id
genosub_order <- genosub[order(rownames(genosub)), ]
```

Examine genetic ancestry groups of participants based on genotyping PCs. Want to confirm that three PCs are required for genetic ancestry.
```{r genotyping_pc_groups, eval=FALSE}
# load genotyping info from Amirtha/Qingling 
# this info is for all CHILD participants that were genotyped
pca_info <- readxl::read_excel(here("input_data",
                                    "genotyping", 
                                    "PCA_ethnicity_child_comparison_duan_lab07102020.xlsx"))

# sub for individuals in this study (REEGLE subset)
pca_sub <- pca_info[as.character(pca_info$FID) %in% rownames(genosub),]

# plot and colour according to race specified on questionnaires
geno_pc1_pc2 <- ggplot(pca_sub, aes(x=PC1, y=PC2, 
                                    col=as.factor(race_mom), 
                                    shape=as.factor(`PCA ethnicity`))) +
  geom_point(alpha=0.7, size=2) +
  scale_color_manual(labels = c("First Nations", "Mixed","South East Asian",
                                "East Asian","South Asian","Middle Eastern",
                                "Hispanic","Caucasian White"),
                     values=c("grey55","#4E2A7A" , "#B20D30","#C17817",
                              "#3F784C", "black", "#6DB1BF","#254A90"),
                     name ="Maternal race")  +
  scale_shape_manual(values=c(21,22,23,24),
                     labels=c("Admixed","Central European" , 
                              "East Asian","South Asian"),
                     name ="PCA Genetic Ancestry") +
  theme_bw() +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.text.x = element_text(size=9),
        axis.text.y = element_text(size=9),
        axis.title.x = element_text(size=12),
        axis.title.y = element_text(size=12),
        legend.text=element_text(size=9),
        legend.title=element_text(size=9),
        legend.key.size = unit(1, 'cm'), #change legend key size
        legend.key.height = unit(0.5, 'cm'), #change legend key height
        legend.key.width = unit(1, 'cm'),
        legend.position = "none") +
  labs(x="Genotyping PC1", y = "Genotyping PC2")

ggsave(plot = geno_pc1_pc2, 
       filename="2022-11-19_CHILD_genopcs_race_ancestry_PC1_PC2.png",
       device = "png",
       path =  here("figures", "genotyping"),
       width = 6,
       height = 6,
       units = "cm")


# plot and colour according to race specified on questionnaires
geno_pc1_pc3 <- ggplot(pca_sub, aes(x=PC1, y=PC3, 
                                    col=as.factor(race_mom), 
                                    shape=as.factor(`PCA ethnicity`))) +
  geom_point(alpha=0.7, size=2) +
  scale_color_manual(labels = c("First Nations", "Mixed","South East Asian",
                                "East Asian","South Asian","Middle Eastern",
                                "Hispanic","Caucasian White"),
                     values=c("grey55","#4E2A7A" , "#B20D30","#C17817",
                              "#3F784C", "black", "#6DB1BF","#254A90"),
                     name ="Maternal race")  +
  scale_shape_manual(values=c(21,22,23,24),
                     labels=c("Admixed","Central European" , 
                              "East Asian","South Asian"),
                     name ="PCA Genetic Ancestry") +
  theme_bw() +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.text.x = element_text(size=9),
        axis.text.y = element_text(size=9),
        axis.title.x = element_text(size=12),
        axis.title.y = element_text(size=12),
        legend.text=element_text(size=9),
        legend.title=element_text(size=9),
        legend.key.size = unit(1, 'cm'), #change legend key size
        legend.key.height = unit(0.5, 'cm'), #change legend key height
        legend.key.width = unit(1, 'cm'), 
        legend.position = "right") +
  labs(x="Genotyping PC1", y = "Genotyping PC3")

ggsave(plot = geno_pc1_pc3, 
       filename="2022-11-17_CHILD_genopcs_race_ancestry_PC1_PC3_legend.png",
       device = "png",
       path =  here("figures", "genotyping"),
       width = 6,
       height = 12,
       units = "cm")
```

Subset betas, pdata, covariates, and cell type PCS for participants with genotyping data (the limiting factor).
```{r subset}
# subset betas
cb_betas_geno <- cb_betas[, rownames(genosub_order)]
# check size of subbed betas
dim(cb_betas_geno) # 424644    131

# subset pdata
cb_pdata_geno <- cb_pdata[cb_pdata$Sample_Label %in% rownames(genosub_order), ]
# check size of subbed pdata
dim(cb_pdata_geno) # 131 17

# subset covariates
covariates_sub_geno <- covariates_sub[covariates_sub$sample_id %in% 
                                        rownames(genosub_order), ]
# check size of subbed covariates 
dim(covariates_sub_geno) # 131 120

# subset cell type PCs
cb_pcs_geno <- cb_pcs[rownames(genosub_order), ]
# check size of subbed cell type PCs
dim(cb_pcs_geno) # 131 5
```


Check that betas, pdata, covariates, cell type PCs are in same order as genotyping data for REEGLE participants.
```{r cb_batchcorr_order}
# pdata and genosub_order
identical(as.character(cb_pdata_geno$Sample_Label),
          rownames(genosub_order)) # TRUE

# betas and genosub_order
identical(colnames(cb_betas_geno), 
          rownames(genosub_order)) # TRUE

# covariates and genosub_order
identical(as.character(covariates_sub_geno$sample_id), 
          rownames(genosub_order)) # TRUE

# cell type PCs and genosub_order
identical(rownames(genosub_order), 
          rownames(cb_pcs_geno)) # TRUE
```


Combined covariates, genotyping, cell type PCs, and pData together.
```{r combine_cell_pcs_covariates}

###################################
# clean up pdata before combining #
###################################

# create new column for batch row variable in pdata
cb_pdata_geno$row <- as.numeric(as.factor(substr(cb_pdata_geno$Sentrix_Position,
                                                 1, 3)))
# examine
head(cb_pdata_geno$row)

# rename pdata sentrix Id column to chip
colnames(cb_pdata_geno)[8] <- "chip"

# rename pdata sentrix Id column to chip
colnames(cb_pdata_geno)[11] <- "run"

################################
# combine data frames together #
################################

# for pdata, only include batch variables
covariates_geno_ctpc_tech <- cbind(covariates_sub_geno, 
                                   cb_pcs_geno,
                                   genosub_order,
                                   cb_pdata_geno[,c("run", "row", "chip")])

dim(covariates_geno_ctpc_tech) # 131 138

# check classes to make sure they are what we expect before running linear model
lapply(covariates_geno_ctpc_tech, class)

# reclass run 
covariates_geno_ctpc_tech$run <- factor(covariates_geno_ctpc_tech$run, 
                                        ordered=F)
# reclass chip
covariates_geno_ctpc_tech$chip <- factor(covariates_geno_ctpc_tech$chip,
                                         ordered=F)
# reclass sex
covariates_geno_ctpc_tech$sex <- factor(covariates_geno_ctpc_tech$sex, 
                                        ordered=F)
```

There should be no zeroes in NO2 data - double check
```{r no_zeroes_in_no2}
# newest no2 variable
sum(na.omit(covariates_geno_ctpc_tech$no2_prenatal_avg_2019v)==0)
# old no2 variable
sum(na.omit(covariates_geno_ctpc_tech$no2_prenatal_avg_2015v)==0) # 6
```


### Subset for complete cases

Subset complete cases in covariate data and betas in preparation for DNAm analysis.
```{r complete_cases}
# subset complete cases
covariates_geno_ctpc_tech_cc <- covariates_geno_ctpc_tech %>%
  subset(complete.cases(no2_prenatal_avg_2019v, sex, gestational_age,
                        prenatal_maternal_smoke, maternal_education_length,
                        Comp.1, Comp.2, Comp.3, Comp.4, 
                        genotyping.PC1, genotyping.PC2, genotyping.PC3))

# check number of complete cases
dim(covariates_geno_ctpc_tech_cc) # 128 139

# subset beta values for complete cases
cb_betas_geno_cc <- cb_betas_geno[,colnames(cb_betas_geno) %in% 
                                    covariates_geno_ctpc_tech_cc$sample_id]

# check size of complete case betas
dim(cb_betas_geno_cc) # 424644 128

# remove probes from betas that were used to predict cell type
cb_betas_geno_cc_clean <- 
  cb_betas_geno_cc[!rownames(cb_betas_geno_cc) %in%
                     (child_fscbc_ecc2_cb$probelist_all %>% unlist() %>% unname() %>% unique()), ]

# check size
dim(cb_betas_geno_cc_clean) # 424079 128; 565 probes removed
```

### Model matrix

Create model matrix for DNAm analysis. This model matrix does not contain batch variables as we are going to let surrogate variables capture their variance within the DNAm data. 
```{r model_matrix}
# create model matrix
mod <- model.matrix(~ no2_prenatal_avg_2019v + sex + gestational_age +
                      prenatal_maternal_smoke + maternal_education_length + 
                      Comp.1 + Comp.2 + Comp.3 + Comp.4 +
                      genotyping.PC1 + genotyping.PC2 + genotyping.PC3,
                    data=covariates_geno_ctpc_tech_cc)

# check size
dim(mod) # 128 15
```

### Surrogate variable analysis (SVA) to account for technical variation

Surrogate variable analysis using the sva packages. This will allow us to capture variance due to batch effects, as well as variance due to unkown biological variables. 
```{r sva}

###############
# null matrix #
###############

# create null matrix
# this matrix does not include any of our covariates 
# this means that our covariates are "protected" and SVs will not capture them
mod0 <- model.matrix(~ sex + gestational_age + prenatal_maternal_smoke + 
                       maternal_education_length + 
                       Comp.1 + Comp.2 + Comp.3 + Comp.4 +
                       genotyping.PC1 + genotyping.PC2 + genotyping.PC3,  
                     data=covariates_geno_ctpc_tech_cc)

################
# sva analysis #
################

# to get SVs in a way that allows calculation of their variance
# we need to pull the code out of sva and run it line-by-line
# we are using the "Be" method for calculating SVs

######################################
# irwsva required internal functions #
######################################

# edge.lfdr function is internal to irwsva function below
# mono function is internal to edge.lfdr
# they have to be initialized before we can run the rest of the code

set.seed(1234)

mono <- function(lfdr){
  .Call("monotone", as.numeric(lfdr), PACKAGE="sva")
}

edge.lfdr <- function(p, trunc=TRUE, monotone=TRUE, transf=c("probit", "logit"), adj=1.5, eps=10^-8, lambda=0.8, ...) {
  pi0 <- mean(p >= lambda)/(1 - lambda)
  pi0 <- min(pi0, 1)
  n <- length(p)
  transf <- match.arg(transf)
  if(transf=="probit") {
    p <- pmax(p, eps)
    p <- pmin(p, 1-eps)
    x <- qnorm(p)
    myd <- density(x, adjust=adj)
    mys <- smooth.spline(x=myd$x, y=myd$y)
    y <- predict(mys, x)$y
    lfdr <- pi0*dnorm(x)/y
  }
  if(transf=="logit") {
    x <- log((p+eps)/(1-p+eps))
    myd <- density(x, adjust=adj)
    mys <- smooth.spline(x=myd$x, y=myd$y)
    y <- predict(mys, x)$y
    dx <- exp(x) / (1+exp(x))^2
    lfdr <- pi0 * dx/y
  }
  if(trunc) {
    lfdr[lfdr > 1] <- 1
  }
  if(monotone) {	
    lfdr <- lfdr[order(p)]
    lfdr <- mono(lfdr)
    lfdr <- lfdr[rank(p)]
  }
  return(lfdr)
}



##################################
# numsv function internal to sva #
##################################

#determine the number of required SVs
#this is numsv function code pulled out

#this is what is fed into this function from the sva function
dat = as.matrix(cb_betas_geno_cc_clean)
mod = mod
#method="be" # this is the default and what is called by numsv
#vfilter=NULL # we dont apply a filter and its not used for be method
B=20
set.seed(1234)

# initialize some stuff
# get the residual matrix (the remaining variance)
n <- ncol(dat)
m <- nrow(dat)
H <- mod %*% solve(t(mod) %*% mod) %*% t(mod)
res <- dat - t(H %*% t(dat))

# run svd and get some eigenvalues
uu <- svd(res)
# get the num of "sig" eigenvalues
ndf <- min(m, n) - ceiling(sum(diag(H)))
# get percent variance explained by each eigenvalue
dstat <- uu$d[1:ndf]^2/sum(uu$d[1:ndf]^2)
# initialize null distribution matrix
dstat0 <- matrix(0, nrow = B, ncol = ndf)

# set seed here since we are calling sample
# create the null distribution
for (i in 1:B) {
  # this part of the code removes all relationships in the 
  res0 <- t(apply(res, 1, sample, replace = FALSE))
  res0 <- res0 - t(H %*% t(res0))
  # calculate svs on this
  uu0 <- svd(res0)
  # bind their explained variance in null matrix
  dstat0[i, ] <- uu0$d[1:ndf]^2/sum(uu0$d[1:ndf]^2)
  print(i) # print out the iteration we are on
}

# determine the number of svs required here based on pvalues
psv <- rep(1, n)
for (i in 1:ndf) {
  psv[i] <- mean(dstat0[, i] >= dstat[i])
}
for (i in 2:ndf) {
  psv[i] <- max(psv[(i - 1)], psv[i])
}

# this is the variable holding the number of SVs required 
# number is each to all the svs with a pval less than/equal to 0.1
nsv <- sum(psv <= 0.1)


####################################
# code from the main SVA function  #
####################################

n.sv = nsv # from code above (run internally when sva called)
B = 5 # number of iterations

# dat =  betas # already initialized
# mod = mod  # already initialized
# mod0 = mod0  # already initialized 
# controls = NULL # we dont include controls - only for supervised method
# method = "irw" # this isnt actually used but would be called by sva
# vfilter = NULL # we dont set this when running sva
# numSVmethod = "be" # this is the default called by sva (code above)


###################################
# irwsva function internal to sva #
###################################

# this code is really want does all the work in sva
# we use the irw method so this is the code for that method
# there are also supervised and two step methods (not used by us)

# irw function takes input from sva, so we have already defined below vars
# dat = dat 
# mod = mod
# mod0 = mod0
# n.sv = n.sv
# B = B

# intialize variables again
n <- ncol(dat)
m <- nrow(dat)
Id <- diag(n)
resid <- dat %*% (Id - mod %*% solve(t(mod) %*% mod) %*% t(mod))
uu <- eigen(t(resid) %*% resid)
vv <- uu$vectors
ndf <- n - dim(mod)[2]
pprob <- rep(1, m)
one <- rep(1, n)
Id <- diag(n)
df1 <- dim(mod)[2] + n.sv
df0 <- dim(mod0)[2] + n.sv
rm(resid)

cat(paste("Iteration (out of", B, "):"))
for (i in 1:B) {
  mod.b <- cbind(mod, uu$vectors[, 1:n.sv])
  mod0.b <- cbind(mod0, uu$vectors[, 1:n.sv])
  ptmp <- f.pvalue(dat, mod.b, mod0.b)
  pprob.b <- (1 - edge.lfdr(ptmp))
  mod.gam <- cbind(mod0, uu$vectors[, 1:n.sv])
  mod0.gam <- cbind(mod0)
  ptmp <- f.pvalue(dat, mod.gam, mod0.gam)
  pprob.gam <- (1 - edge.lfdr(ptmp))
  pprob <- pprob.gam * (1 - pprob.b)
  dats <- dat * pprob
  dats <- dats - rowMeans(dats)
  uu <- eigen(t(dats) %*% dats)
  cat(paste(i, " "))
}

# this is what is normally returned by sva
# problem is that it doesnt include the diagonal matrix we want
sv_cb = svd(dats)$v[, 1:n.sv, drop = FALSE] 
svobj <- list(sv = sv_cb, pprob.gam = pprob.gam, pprob.b = pprob.b, 
              n.sv = n.sv)

# to get all info (including diagonal)
svobj_all <- svd(dats)

svs_cb <- as.data.frame(svobj$sv)

# save 
save(sv_cb, file = here("output_data", 
                        "linear_regression", 
                        "2022-10-05_prenatal_svs_without_pss18wk.RData"))

###############
#scree of SVs #
###############

# from elodie portales-casamar

# heat scree prepartion
vars <- svobj_all[['d']]^2
vars <- vars/sum(vars)
names(vars) <- paste0('SV', 1:length(vars))
xp <- 1:svobj$n.sv
varsdf <- as.data.frame(vars)
varsdf$svnum <- rep(1:length(vars))

# heat scree ggplot!! 
cb_sv_scree <- ggplot(varsdf[1:20,], aes(x=svnum, y=vars*100)) +
  geom_col() +
  theme_bw() +
  labs(x="Surrogate variable", y = "Variance (%)")

cb_sv_scree

ggsave(plot = cb_sv_scree, 
       filename = here("figures", 
                       "linear_regression", 
                       "prenatal", 
                       "2022-10-05_cb_sv_heat_scree.png"),
       height = 5, width = 15, units = "cm")

# it looks like the first two svs are most important, but SVA suggests 14
# examine a correlation matrix between all svs and covariates to see
# what variance they are capturing

######################
# correlation matrix #
######################

# add svs to covariates
covariates_geno_ctpc_tech_cc <- cbind(covariates_geno_ctpc_tech_cc, sv_cb)

# rename columns with svs
colnames(covariates_geno_ctpc_tech_cc)[141:157]  <-
  paste("sv",colnames(covariates_geno_ctpc_tech_cc)[141:157], sep="")

source(here("scripts", "2021-08-30_corr_mat_funs.R"))

# early exp and pn_18 are the same thing. 
# exclude early_exp from correlation matrices
corr <- corr.mat(covariates_geno_ctpc_tech_cc %>% 
                   dplyr::select(no2_prenatal_avg_2019v, sex, gestational_age,
                                 prenatal_maternal_smoke, maternal_education_length,
                                 Comp.1, Comp.2, Comp.3, Comp.4, 
                                 genotyping.PC1, genotyping.PC2, genotyping.PC3,
                                 chip, run, row, 
                                 sv1, sv2, sv3, sv4, sv5, sv6, sv7, sv8, sv9,
                                 sv10, sv11, sv12, sv13, sv14, sv15, sv16, sv17) %>%
                   rename("Prenatal NO2" = no2_prenatal_avg_2019v,
                          "Biological sex" = sex,
                          "Gestational age (days)" = gestational_age,
                          "Prenatal maternal cigarette smoking" = prenatal_maternal_smoke,
                          "Maternal education (years)" = maternal_education_length,
                          #"Prenatal maternal stress" = pss_pre18wk,
                          "Cell type PC1" = Comp.1, "Cell type PC2" = Comp.2,
                          "Cell type PC3" = Comp.3, "Cell type PC4" = Comp.4,
                          "Genetic ancestry PC1" = genotyping.PC1, 
                          "Genetic ancestry PC2" = genotyping.PC2, 
                          "Genetic ancestry PC3" = genotyping.PC3, 
                          "Chip" = chip, "Run" = run, "Row" = row,
                          "SV1" = sv1, "SV2" = sv2, "SV3" = sv3, "SV4" = sv4,
                          "SV5" = sv5, "SV6" = sv6, "SV7" = sv7, "SV8" = sv8,
                          "SV9" = sv9, "SV10" = sv10, "SV11" = sv11, 
                          "SV12" = sv12,"SV13" = sv13, "SV14" = sv14, 
                          "SV15" = sv15, "SV16" = sv16, "SV17" = sv17))

pval <- pval.mat(covariates_geno_ctpc_tech_cc %>% 
                   dplyr::select(no2_prenatal_avg_2019v, sex, gestational_age,
                                 prenatal_maternal_smoke, maternal_education_length,
                                 Comp.1, Comp.2, Comp.3, Comp.4, 
                                 genotyping.PC1, genotyping.PC2, genotyping.PC3,
                                 chip, run, row, 
                                 sv1, sv2, sv3, sv4, sv5, sv6, sv7, sv8, sv9,
                                 sv10, sv11, sv12, sv13, sv14, sv15, sv16,sv17) %>%
                   rename("Prenatal NO2" = no2_prenatal_avg_2019v,
                          "Biological sex" = sex,
                          "Gestational age (days)" = gestational_age,
                          "Prenatal maternal cigarette smoking" = prenatal_maternal_smoke,
                          "Maternal education (years)" = maternal_education_length,
                          #"Prenatal maternal stress" = pss_pre18wk,
                          "Cell type PC1" = Comp.1, "Cell type PC2" = Comp.2,
                          "Cell type PC3" = Comp.3, "Cell type PC4" = Comp.4,
                          "Genetic ancestry PC1" = genotyping.PC1, 
                          "Genetic ancestry PC2" = genotyping.PC2, 
                          "Genetic ancestry PC3" = genotyping.PC3, 
                          "Chip" = chip, "Run" = run, "Row" = row,
                          "SV1" = sv1, "SV2" = sv2, "SV3" = sv3, "SV4" = sv4,
                          "SV5" = sv5, "SV6" = sv6, "SV7" = sv7, "SV8" = sv8,
                          "SV9" = sv9, "SV10" = sv10, "SV11" = sv11, 
                          "SV12" = sv12,"SV13" = sv13, "SV14" = sv14, 
                          "SV15" = sv15, "SV16" = sv16,"SV17" = sv17))

svcorr <- corr.plot(pval = pval, 
                    corr = corr, 
                    label.sig = T,
                    shape = 8,shape.size = 1,
                    axis.text.size = 8, x.axis.text.angle = 90) +
  scale_y_discrete(position = "right") +
  theme(legend.position = "none",
        panel.grid = element_blank())

ggsave(plot = svcorr,
       filename = here("figures",
                       "linear_regression",
                       "prenatal", 
                       "2022-10-05_sv_correlations.png"),
       height = 15, width = 15, units = "cm")

###########################
# add SVs to model matrix #
###########################

colnames(sv_cb) <- c(1:17)

# use 6 SVs 
modSv = cbind(mod,sv_cb)
```

### EWAS examining the effects of prenatal NO2 exposure 

Run Limma for DNAm analysis.
```{r limma}
set.seed(1234)

# fit methylation to no2
cb_fit <-  lmFit(cb_betas_geno_cc_clean, modSv)
cb_ebayes <- eBayes(cb_fit)

# subset annotation file for cpgs used in limma
annotation_cpgs <- annotation[rownames(annotation) %in% rownames(cb_ebayes),]

# check that annotation file and limma cpgs are in the same order
identical(rownames(annotation_cpgs), rownames(cb_ebayes)) # false

# reorder annotation file to match limma output
annotation_cpgs_order <- annotation_cpgs[rownames(cb_ebayes), ]

# recheck order of annotation file against limma cpgs
identical(rownames(annotation_cpgs_order), rownames(cb_ebayes)) #true

# pull out pval, coefficients from limma and combine with annotation
cb_pvals_tech <- cbind(as.data.frame(cb_ebayes$p.value), 
                       as.data.frame(cb_ebayes$coefficients),
                       as.data.frame(annotation_cpgs_order))

# rename columns to indicate pvalues vs coeffcients 
colnames(cb_pvals_tech) <- c(paste("pval", 
                                   colnames(cb_pvals_tech)[1:30], 
                                   sep = "_"), 
                             paste("coeff", 
                                   colnames(cb_pvals_tech)[31:60], 
                                   sep = "_"),
                             colnames(cb_pvals_tech)[61:93])

cb_pvals_tech$pval_no2_prenatal_avg_2019v_adj  <-
  p.adjust(cb_pvals_tech$pval_no2_prenatal_avg_2019v , method="BH")

# write.csv(cb_pvals_tech, 
#           file=here("tables", 
#                     "prenatal",
#                     "2022-11-17_prenatal_no2_epigenome_wide_analysis.csv"))
```

Examine the qqplot.
```{r qqplot_pval_histo}

pvector <- cb_pvals_tech$pval_no2_prenatal_avg_2019v

pvector2 <- pvector[!is.na(pvector) & !is.nan(pvector) & !is.null(pvector) & 
                      is.finite(pvector) & pvector < 1 & pvector > 0]

pval_qq <- as.data.frame(cbind(o = -log10(sort(pvector2, decreasing = FALSE)),
                               e = -log10(ppoints(length(pvector2)))))

# calculate lambda
z = qnorm(pvector2/2)
lambda = round(median(z^2) / 0.454, 3)


# qqplot of bacon corrected pvalues for main paper figure
qqplot <-  ggplot(pval_qq, aes(x=e, y=o)) + 
  geom_point(col="#254A90", size=1) + 
  geom_abline(slope = 1, intercept = 0, 
              col = "red", size=0.25, linetype="dashed") +
  labs(x = "Expected -log10(p-value)",
       y = "Observed -log10(p-value)") +
  annotate("text", x=3, y=1.5, 
           label = paste("Inflation = ", signif(lambda, 2)), 
           size=3, hjust=0) +
  theme_bw() +
  theme(axis.text.x = element_text(size=9),
        axis.text.y = element_text(size=9),
        axis.title = element_blank(),
        panel.grid = element_blank(),
        panel.border = element_blank(),
        axis.line = element_line(color ="black")) 
qqplot

ggsave(plot = qqplot, 
       filename= here("figures", 
                      "linear_regression", 
                      "prenatal", 
                      "2022-11-18_prenatal_no2_qqplot.png"),
       width = 7.5, height = 6, units = "cm")
```

Effect size
```{r effect_size}
range = max(covariates_geno_ctpc_tech_cc$no2_prenatal_avg_2019v) -
  min(covariates_geno_ctpc_tech_cc$no2_prenatal_avg_2019v)

cb_pvals_tech$effect_size <- cb_pvals_tech$coeff_no2_prenatal_avg_2019v * range
```

Volcano plot
```{r volcano}

persist_points <- cb_pvals_tech %>% 
  subset(effect_size > 0.025 | effect_size < -0.025) %>%
  arrange(pval_no2_prenatal_avg_2019v) %>%
  slice_head(n=100) %>% 
  rownames()

cb_volcano <- ggplot(cb_pvals_tech %>%
                       subset(!rownames(.) %in% persist_points), 
                     aes(x=as.numeric(effect_size) , 
                         y=-log10(as.numeric(pval_no2_prenatal_avg_2019v)))) +
  geom_point(alpha=0.75, col = "#254A90", size=1) +
  # colour significant cpgs; 2.5% effect size cut off and FDR < 0.25
  geom_point(data = cb_pvals_tech %>% 
               subset(rownames(.) %in% persist_points), 
             alpha=0.75, col = "#254A90", size=1, shape = 25, fill = "#254A90") +  #"#254A90", "#508FC2", "#92C5EB"
  scale_x_continuous(breaks = seq(-0.50, 0.50, by = 0.10)) +
  
  labs(y="-log10(unadjusted p-value)", x = "Effect size (% DNAm)") +
  theme_bw() +
  theme(panel.grid = element_blank(),
        panel.border = element_blank(),
        axis.line = element_line(color ="black"),
        axis.text.x = element_text(size=9),
        axis.text.y = element_text(size=9),
        axis.title = element_blank()) 
cb_volcano

ggsave(plot = cb_volcano,
       filename = here("figures", 
                       "linear_regression", 
                       "prenatal", 
                       "2022-10-18_cb_volcanoplot.png"),
       width = 7.5, height = 6, units = "cm")
```

### Gene specific changes

These genes are related to the proposed pathway of air pollution action or have previously been shown to exhibit DNA methylation changes associated with prenatal air pollution exposure. 

```{r gene_specific}
#FHC is FTH1 (ferritin heavy chain 1)
#nothing maps to FOXP3
#TNFA is TNF
goi <- annotation[grep("^RNF39|^CYP2E1|^LONP1|^SLC25A28|^PLVAP|^CAT$|^CAT;|^TPO|^NFKB1|^NOX2|^SOD1|^SOD2|^TRX1|^TRX2|^GSTP1|^MT3|^NQO1|^HMOX1|^TGPX1|^DDH1|^NOS2|^CYP2C11|^CYP7B|^ALOX12$|^ALOX5;|^ALOX5$|^NRF2$|^NRF2;|^KEAP1|^AHR$|^AHR;|^ARNT;|^ARNT$|^GCLC|^GCLM|^GSR1|^SLC7A11|^GSTA1|^GSTA2|^GSTA3|^GSTA5|^GSTM1|^GSTM2|^GSTM3|^TXN$|^TXN;|^TXNRD1$|^TXNRD1;|^SRXN1|^G6PD|^CYP1A1|^IL1A|^IL2$|^IL2;|^IL3$|^IL3;|^IL4;|^IL4$|^IL5$|^IL5;|^IL6$|^IL6;|^IL9$|^IL9;|^IL10$|^IL10;|^IL12A|^IL13|^IL15$|^IL15;|^IL17A|^IL18$|^IL18;|^IL19|^IL21$|^IL21;|^IL22$|^IL22;|^IL23A$|^IL23A;|^IL25$|^IL25;|^IL27$|^IL27;|^IL31$|^IL31;|^IL33$|^IL33;|^IFNG$|^IFNG;|^TNF$|^TNF;|^TGFB1$|^TGFB1;|^FOXP3|^FTH1", annotation$UCSC_RefGene_Name), ] %>% as.data.frame()

unique(goi$UCSC_RefGene_Name)
# only first annotate gene
unique(gsub(";.*$", "", unique(goi$UCSC_RefGene_Name))) # 59

# transpose for lm function
cb_betas_geno_cc_clean_t <- t(cb_betas_geno_cc_clean)

#apply function for calculating significance of associations using mice and imputed covariate data
prenatal_goi_list <- 
  pbapply(cb_betas_geno_cc_clean_t[,colnames(cb_betas_geno_cc_clean_t ) %in% rownames(goi)], 2, function(x) {
    
    combined <- cbind(covariates_geno_ctpc_tech_cc, x)
    
    #run the linear regression on this cpg using all 5 imputed covariate data sets
    fit <- lm(x ~ no2_prenatal_avg_2019v + sex + gestational_age  + 
                prenatal_maternal_smoke + maternal_education_length + 
                Comp.1 + Comp.2 + Comp.3 + Comp.4 +
                genotyping.PC1 + genotyping.PC2 + genotyping.PC3 + 
                sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + sv7 + sv8 + sv9 + sv10 +
                sv11 + sv12 + sv13 + sv14 + sv15 + sv16 + sv17, 
              data=combined)
    
    #get summary of lm fit
    #this includes coefficients and pvalues
    #coerce into df for manipulation
    #add in terms (rownames) as column for annotation
    fit_sum <- summary(fit)
    fit_sum_coeff <- as.data.frame(fit_sum$coefficients)
    fit_sum_coeff$term <- rownames(fit_sum_coeff)
    
    #this data frame has rows for each linear regression variable, and columns for statistics
    #want a dataframe of 1 row and many columns (one for each variable with each statistic type)
    #do this by using the spread function for each statistic
    #add cpg id onto dataframe for pvalues (to keep track of information)
    #then cbind dataframes together
    
    #coefficient
    estimate <- spread(fit_sum_coeff[,c("term", "Estimate")], term, Estimate)
    colnames(estimate) <- paste("estimate", colnames(estimate), sep="_")
    
    #std error
    std.error <- spread(fit_sum_coeff[,c("term", "Std. Error")], term, 'Std. Error')
    colnames(std.error) <- paste("std_error", colnames(std.error), sep="_")
    
    #t statistics
    statistic <- spread(fit_sum_coeff[,c("term", "t value")], term, 't value')
    colnames(statistic) <- paste("t_val", colnames(statistic), sep="_")
    
    #pvalue
    p.value <- spread(fit_sum_coeff[,c("term", "Pr(>|t|)")], term, 'Pr(>|t|)')
    colnames(p.value) <- paste("p_value", colnames(p.value), sep="_")
    
    #add in cpgid for annotation 
    p.value$cpg <- colnames(x)
    
    #cbind into wide dataframe
    widepool <- cbind(estimate, std.error, statistic, p.value)
    
    #return the wide dataframe
    #these will be do.call(rbind()) together after
    return(widepool)
    
  })


prenatal_goi <- do.call(rbind, prenatal_goi_list)

prenatal_goi$p_value_no2_prenatal_avg_2019v_adj <- 
  p.adjust(prenatal_goi$p_value_no2_prenatal_avg_2019v, method="BH")

#reorder according ot unadjusted no2 pvalue
prenatal_goi_order <- prenatal_goi[order(prenatal_goi$p_value_no2_prenatal_avg_2019v),]

# caclculate effect size
range = max(covariates_geno_ctpc_tech_cc$no2_prenatal_avg_2019v) -
  min(covariates_geno_ctpc_tech_cc$no2_prenatal_avg_2019v)

prenatal_goi_order$prenatal_no2_effect_size <- prenatal_goi_order$estimate_no2_prenatal_avg_2019v * range

# write out table for all GOIs
write.csv(prenatal_goi_order, 
          file=here("tables", 
                    "prenatal",
                    "2022-11-17_prenatal_no2_candidate_gene_analysis.csv"))


#check cpgs from gruvieva 2017 paper

##################
#LONP1 cg12283362#
##################

covariates_geno_ctpc_tech_cc$cg12283362 <- 
  cb_betas_geno_cc_clean[rownames(cb_betas_geno_cc_clean)=="cg12283362", ] 

cg12283362_lm <- lm(cg12283362 ~ no2_prenatal_avg_2019v + sex + gestational_age  + 
                      prenatal_maternal_smoke + maternal_education_length + 
                      Comp.1 + Comp.2 + Comp.3 + Comp.4 +
                      genotyping.PC1 + genotyping.PC2 + genotyping.PC3 + 
                      sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + sv7 + sv8 + sv9 + sv10 +
                      sv11 + sv12 + sv13 + sv14 + sv15 + sv16 + sv17, 
                    data=covariates_geno_ctpc_tech_cc)

# get lm info
summary(cg12283362_lm)

# estimate marginal effects of prenatal NO2 exposure on DNAm
cg12283362_no2_me <- ggpredict(cg12283362_lm, terms = "no2_prenatal_avg_2019v") %>%
  as.data.frame() %>% 
  rename("cg12283362" = predicted,
         "no2_prenatal_avg_2019v" = x)

# plot 
cb_cg12283362_dnam_plot <- ggplot(covariates_geno_ctpc_tech_cc,
                                  aes(x = no2_prenatal_avg_2019v, 
                                      y= cg12283362)) + 
  geom_line(data = cg12283362_no2_me, 
            aes(x=no2_prenatal_avg_2019v, y = cg12283362),
            col="red", size=0.5, linetype="solid") +
  geom_ribbon(data = cg12283362_no2_me, 
              aes(x = no2_prenatal_avg_2019v, 
                  ymin = conf.low, ymax = conf.high), 
              alpha = .2) + 
  geom_point(alpha=0.6, col = "#254A90", size=1) + 
  scale_y_continuous(breaks = seq(0.6,0.9,by=0.1), 
                     limits = c(0.6,0.9),
                     labels = scales::number_format(accuracy = 0.01)) +
  
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text = element_text(size=9),
        panel.border = element_blank(),
        axis.line = element_line(color ="black"),
        axis.title = element_blank()) 

ggsave(plot = cb_cg12283362_dnam_plot, 
       filename = here("figures", 
                       "linear_regression", 
                       "prenatal",
                       "2022-11-10_cb_cg12283362_dnam.png"),
       width = 4.0, height = 3.2, units = "cm")

# correlation 
cor(covariates_geno_ctpc_tech_cc$cg12283362, 
    covariates_geno_ctpc_tech_cc$no2_prenatal_avg_2019v,
    method="pearson") # 0.00301464

# effect size
range_cb = max(covariates_geno_ctpc_tech_cc$no2_prenatal_avg_2019v) -
  min(covariates_geno_ctpc_tech_cc$no2_prenatal_avg_2019v)

summary(cg12283362_lm)$coefficients["no2_prenatal_avg_2019v", "Estimate"]*range_cb # 0.0004828846


#####################
#SLC25A28 cg08973675#
#####################

covariates_geno_ctpc_tech_cc$cg08973675 <- 
  cb_betas_geno_cc_clean[rownames(cb_betas_geno_cc_clean)=="cg08973675", ] 

cg08973675_lm <- lm(cg08973675~ no2_prenatal_avg_2019v + sex + gestational_age  + 
                      prenatal_maternal_smoke + maternal_education_length + 
                      Comp.1 + Comp.2 + Comp.3 + Comp.4 +
                      genotyping.PC1 + genotyping.PC2 + genotyping.PC3 + 
                      sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + sv7 + sv8 + sv9 + sv10 +
                      sv11 + sv12 + sv13 + sv14 + sv15 + sv16 + sv17, 
                    data=covariates_geno_ctpc_tech_cc)

summary(cg08973675_lm)

# estimate marginal effects of prenatal NO2 exposure on DNAm
cg08973675_no2_me <- ggpredict(cg08973675_lm, terms = "no2_prenatal_avg_2019v") %>%
  as.data.frame() %>% 
  rename("cg08973675" = predicted,
         "no2_prenatal_avg_2019v" = x)

# plot 
cb_cg08973675_dnam_plot <- ggplot(covariates_geno_ctpc_tech_cc,
                                  aes(x = no2_prenatal_avg_2019v, 
                                      y= cg08973675)) + 
  geom_line(data = cg08973675_no2_me, 
            aes(x=no2_prenatal_avg_2019v, y = cg08973675),
            col="red", size=0.5, linetype="solid") +
  geom_ribbon(data = cg08973675_no2_me, 
              aes(x = no2_prenatal_avg_2019v, 
                  ymin = conf.low, ymax = conf.high), 
              alpha = .2) + 
  geom_point(alpha=0.6, col = "#254A90", size=1) + 
  scale_y_continuous(breaks = seq(0,0.16,by=0.04), limits = c(0,0.16)) +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text = element_text(size=9),
        panel.border = element_blank(),
        axis.line = element_line(color ="black"),
        axis.title = element_blank()) 

ggsave(plot = cb_cg08973675_dnam_plot, 
       filename = here("figures", 
                       "linear_regression", 
                       "prenatal",
                       "2022-11-10_cb_cg08973675_dnam.png"),
       width = 4.0, height = 3.2, units = "cm")


# correlation 
cor(covariates_geno_ctpc_tech_cc$cg08973675, 
    covariates_geno_ctpc_tech_cc$no2_prenatal_avg_2019v,
    method="pearson") # 0.1007488

# effect size
range_cb = max(covariates_geno_ctpc_tech_cc$no2_prenatal_avg_2019v) -
  min(covariates_geno_ctpc_tech_cc$no2_prenatal_avg_2019v)

summary(cg08973675_lm)$coefficients["no2_prenatal_avg_2019v", "Estimate"]*range_cb # 0.005189266
```


### Identification of differentially methylated regions (DMRs)


```{r dmr}
comb_dat <- cb_pvals_tech %>%
  select(pval_no2_prenatal_avg_2019v, chr, pos, Name) %>%
  mutate(chr = str_sub(chr, 4,5),
         end = pos + 1) %>%
  dplyr::rename("p" = pval_no2_prenatal_avg_2019v,
                "start" = pos,
                "probe" = Name)

# need to run in "console" portion of RStudio
# results stored in home directory (~/CANDLE/)
# rename files, move to correct directory before loading 
combp(comb_dat, 
      seed = 0.01,
      verbose = T)

# read in csv of dmrs
resu_combp <- read_csv(here("output_data",
                            "linear_regression",
                            "2022-10-05_prenatal_no2_resu_combp.csv"))

# get annotation for DMRs in combp results
combp_anno <- apply(resu_combp, 1, function(x){
  annotation_cpgs_order %>%
    as.data.frame() %>%
    subset(chr == paste("chr", x["chr"], sep = "")) %>%
    subset(pos >= x["start"] & pos <= x["end"]-1) %>%
    mutate(dmr = x["dmr"],
           analysis = x["analysis"])
})

# conver to data frame
combp_anno_df <- do.call(rbind, combp_anno)

# create new columns to specify DMR and analysis
resu_combp$dmr <- 1:nrow(resu_combp)
resu_combp$analysis <- "prenatal_no2"

# specify which DMR the annotation belongs to
combp_anno_df$dmr <- sapply(1:nrow(resu_combp), function(i) 
  rep(i, resu_combp[i,"nprobe"]), simplify = "vector") %>%
  unlist()

combp_anno_df$analysis <- "prenatal_no2"

# merge with rlm data to get effect size at each cpg
combp_anno_df_es <- merge(combp_anno_df, 
                          cb_pvals_tech %>%
                            subset(rownames(.) %in% rownames(combp_anno_df)) %>%
                            dplyr::select(effect_size, coeff_no2_prenatal_avg_2019v),
                          by = "row.names")

# subset for dmrs with  more than 1 cpg
resu_combp_sub <- resu_combp %>%
  subset(nprobe >1 ) %>%
  mutate(dmr2 = 1:nrow(.))

# subset DMR annotation for those with more than 1 CpG
combp_anno_df_es_sub <- combp_anno_df_es %>%
  subset(dmr %in% resu_combp_sub$dmr)

# check mean effect sizes
combp_anno_df_es_sub %>%
  group_by(dmr) %>%
  summarise(mean(effect_size)) 

# omit dmr 22 as effect size < 0.025
combp_anno_df_es_sub_escutoff <- combp_anno_df_es_sub %>%
  subset(!dmr %in% c(22))

resu_combp_sub_escutoff <- resu_combp_sub %>%
  subset(!dmr %in% c(22))

# write out annotation for dmrs
write.csv(combp_anno_df_es_sub_escutoff,
          here("output_data",
               "linear_regression",
               "2022-10-05_prenatal_no2_combp_annotation_sigDMRs.csv"))

# write out annotation for dmrs
write.csv(resu_combp_sub_escutoff,
          here("output_data",
               "linear_regression",
               "2022-10-05_prenatal_no2_resu_combp_sub_escutoff_sigDMRs.csv"))
```


Manhattan plot of CpGs in DMRS
```{r dmr_manhattan}
# Prepare data for manhattan plot.  
# nonsig pvals arent very informative and hae lots of overlap
# reduce number of nonsig pvals for plotting to improve/speed up performance
# randomly select subset of nonsig pvals for plotting
# if you dont subset, the plot will take a very long time to generate

sig.dmr.dat <- cb_pvals_tech %>% 
  subset(rownames(.) %in% combp_anno_df_es_sub_escutoff$Name) %>%
  mutate(group = "dmr")

notsig.dat <- cb_pvals_tech %>% 
  subset(!rownames(.) %in% rownames(sig.dmr.dat)) %>%
  subset(pval_no2_prenatal_avg_2019v_adj > 0.05) %>%
  mutate(group = "notsig")

# set seed before random sampling to ensure consistent results 
#set.seed(1234)
#notsig.dat.red <- notsig.dat[(sample(nrow(notsig.dat), nrow(notsig.dat) / 10)),]
mqtls.red <- rbind(sig.dmr.dat, notsig.dat)

mqtls.red$chr <- factor(mqtls.red$chr,
                        levels = c("chr1", "chr2", "chr3", "chr4", "chr5", 
                                   "chr6", "chr7", "chr8", "chr9", "chr10",
                                   "chr11", "chr12", "chr13", "chr14", "chr15",
                                   "chr16", "chr17", "chr18", "chr19", "chr20",
                                   "chr21", "chr22"))

# get max positions
chrsizes <- aggregate(pos ~ chr, data = mqtls.red, max) 

# get cumulative sizes of chrs
chrsizes$cumsum <- cumsum(as.numeric(chrsizes[, 2]))
# start cumsum at 0
chrsizes$cumsum <- chrsizes$cumsum - chrsizes$cumsum[1]

# Add this info to the initial dataset
mqtls.red2 <- left_join(mqtls.red, chrsizes[,c("chr", "cumsum")], by=c("chr"="chr"))

# Add a cumulative position of each mqtl
mqtls.red2$bpcum <- mqtls.red2$pos + mqtls.red2$cumsum

# Add a cumulative position of each SNP
# get chromosome center positions for x-axis
axisdf <- aggregate(mqtls.red2$bpcum, by = list(mqtls.red2$chr), function(x) {
  centre = (max(x) + min(x))/2
})
# add centres to cumsum
axisdf$cumsumcentre <- axisdf$x + chrsizes$cumsum

# custom colours
# shades of blue
colour_vals <- rep_len(c("#254A90", "#508FC2", "#92C5EB"), length.out=22)

# plot manhattan 
manhat <- ggplot(mqtls.red2 %>%
                   subset(group == "notsig"), 
                 aes(x=bpcum, y=effect_size)) +
  geom_point(aes(color=as.factor(chr)), alpha=0.6, size=1) + 
  scale_color_manual(values = colour_vals) +
  # dmrs
  geom_point(data = mqtls.red2 %>%
               subset(group == "dmr"),
             aes(x=bpcum, y=effect_size),
             color = "red2", size = 1, alpha = 0.8) +
  scale_x_continuous(label = c(1:22)[c(TRUE, FALSE)], 
                     breaks= axisdf$x[c(TRUE, FALSE)], 
                     name = "Chromosome") +
  # scale_y_continuous(expand = c(0, 0), limits= c(0, -log10(1e-8))) +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5),
        legend.position="none",
        panel.border = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        axis.text.x = element_text(size = 9),
        axis.text.y = element_text(size = 9)) +
  labs(x=element_blank(), y="Effect size (%DNAm)")

ggsave(plot = manhat,
       filename = here("figures",
                       "linear_regression",
                       "prenatal",
                       "2022-11-10_no2_manhattan_es.png"),
       height = 5, width = 15, units = "cm")
```



```{r dmr_gene_set_enrichment}
# create GRanges object from combp output
combp_gr <- GRanges(
  seqnames = Rle(resu_combp_sub_escutoff$chr, c(rep(1, int = nrow(resu_combp_sub_escutoff)))),
  ranges = IRanges(start = resu_combp_sub_escutoff$start, end = resu_combp_sub_escutoff$end),
  strand = Rle(combp_anno_df_es_sub_escutoff %>%
                 distinct(dmr, .keep_all = T) %>%
                 pull(strand), rep(1, int = nrow(resu_combp_sub_escutoff))))

# perform enrichment analysis for GO terms
gst.region <-  goregion(regions = combp_gr, 
                        all.cpg = cb_pvals_tech %>%
                          pull(Name),
                        collection ="GO",
                        array.type = "450k",
                        sig.genes = T)
# NS
```

Examine whether DNAm at significant cpgs is associated with reported wheeze at age one. In previous CHILD paper [(PMID: 26424567)](https://www.science.org/doi/10.1126/scitranslmed.aab2271) wheeze was defined using wheeze questionnaires. If the child had wheezed with or without a cold during the first year of life (recorded via questionnaires answered by parents at 3, 6, and 12 months), the child was included in the wheezing group. Children were also included in the wheezing group if the CHILD clinician recorded a wheeze during the 1-year clinical assessment.
```{r ageone_wheeze_atopy_associations}

covariates_geno_ctpc_tech_cc$any_wheeze_y1 <- 
  ifelse(covariates_geno_ctpc_tech_cc$reported_wheezing_y1 ==1 | 
           covariates_geno_ctpc_tech_cc$clinician_wheeze_dx_y1 ==1, 1, 0)

# DMR 1
covariates_geno_ctpc_tech_cc$dmrmean1 <- 
  cb_betas_geno_cc_clean[combp_anno_df_es %>% subset(dmr == 1) %>% pull(Name),] %>% 
  colMeans()

# dmr 1 effect size
combp_anno_df_es_sub_escutoff %>% 
  subset(dmr==1) %>% 
  pull(effect_size) # increases

ggplot(covariates_geno_ctpc_tech_cc %>% subset(!is.na(any_wheeze_y1)),
       aes(x=as.factor(any_wheeze_y1), y=dmrmean1)) +
  geom_boxplot()

# https://stats.stackexchange.com/questions/124694/how-to-do-mancova-in-r
# mancova
# Y <- cbind(VAR1, VAR2, VAR3)
# fit <- manova(Y ~ GRP+age+gender)
# summary(fit, test="Pillai")
# 
# Other test options are "Wilks", "Hotelling-Lawley", and "Roy".
# 
# summary.aov(fit) # for univariate statistics.

# subset out dmr 1 cpgs
covariates_geno_ctpc_tech_cc_dmr_cpgs <- 
  cbind(covariates_geno_ctpc_tech_cc, 
        t(cb_betas_geno_cc_clean[combp_anno_df_es_sub_escutoff %>%
                                   subset(dmr == 1) %>%
                                   pull(Name),]))

# wheeze
dmr1_mancova_wheeze <- manova(cbind(cg00969405,cg01323381,cg01370449,cg01748892,cg02005600,
                                    cg02106682,cg02248486,cg02646423,cg02916332,cg03207666,
                                    cg03368099,cg03744763,cg04863892,cg05579037,cg05774699,
                                    cg07049592,cg08070327,cg09549073,cg09880291,cg12015737,
                                    cg12128839,cg13512268,cg13694927,cg14013695,cg14014955,
                                    cg14058329,cg14658493,cg14882265,cg16997642,cg17432857,
                                    cg17569124,cg19196335,cg19643053,cg19759481,cg20517050,
                                    cg20817131,cg23204968,cg23454797,cg23936031,cg24389585,
                                    cg25307665,cg25390165,cg25506432,cg25866143,cg26023912,
                                    cg27151303) ~ any_wheeze_y1 + sex + gestational_age + 
                                prenatal_maternal_smoke + maternal_education_length + 
                                Comp.1 + Comp.2 + Comp.3 + Comp.4 +
                                genotyping.PC1 + genotyping.PC2 + genotyping.PC3 + 
                                sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + sv7 + sv8 + sv9 + sv10 +
                                sv11 + sv12 + sv13 + sv14 + sv15 + sv16 + sv17, 
                              data = covariates_geno_ctpc_tech_cc_dmr_cpgs)

summary(dmr1_mancova_wheeze, test="Pillai") # any wheeze p = 0.0601170

# atopy
dmr1_mancova_atopy <- manova(cbind(cg00969405,cg01323381,cg01370449,cg01748892,cg02005600,
                                   cg02106682,cg02248486,cg02646423,cg02916332,cg03207666,
                                   cg03368099,cg03744763,cg04863892,cg05579037,cg05774699,
                                   cg07049592,cg08070327,cg09549073,cg09880291,cg12015737,
                                   cg12128839,cg13512268,cg13694927,cg14013695,cg14014955,
                                   cg14058329,cg14658493,cg14882265,cg16997642,cg17432857,
                                   cg17569124,cg19196335,cg19643053,cg19759481,cg20517050,
                                   cg20817131,cg23204968,cg23454797,cg23936031,cg24389585,
                                   cg25307665,cg25390165,cg25506432,cg25866143,cg26023912,
                                   cg27151303) ~ clinician_atopy_dx_y1 + sex + gestational_age + 
                               prenatal_maternal_smoke + maternal_education_length + 
                               Comp.1 + Comp.2 + Comp.3 + Comp.4 +
                               genotyping.PC1 + genotyping.PC2 + genotyping.PC3 + 
                               sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + sv7 + sv8 + sv9 + sv10 +
                               sv11 + sv12 + sv13 + sv14 + sv15 + sv16 + sv17, 
                             data = covariates_geno_ctpc_tech_cc_dmr_cpgs)

summary(dmr1_mancova_atopy, test="Pillai") # atopy p = 0.1988312


# check vcov and correlations
dmr1_mancova_wheeze_vcov <- vcov(dmr1_mancova_wheeze) 
colnames(dmr1_mancova_wheeze_vcov) <- rownames(coef(dmr1_mancova_wheeze))
rownames(dmr1_mancova_wheeze_vcov) <- rownames(coef(dmr1_mancova_wheeze))

dmr1_mancova_wheeze_cov2cor <- cov2cor(dmr1_mancova_wheeze_vcov)
colnames(dmr1_mancova_wheeze_cov2cor) <- rownames(coef(dmr1_mancova_wheeze))
rownames(dmr1_mancova_wheeze_cov2cor) <- rownames(coef(dmr1_mancova_wheeze))

# DMR 2
covariates_geno_ctpc_tech_cc$dmrmean2 <- 
  cb_betas_geno_cc_clean[combp_anno_df_es_sub_escutoff %>% subset(dmr == 2) %>% pull(Name),] %>% 
  colMeans()

# dmr 2 effect size
combp_anno_df_es_sub_escutoff %>% 
  subset(dmr==2) %>% 
  pull(effect_size) # increases

ggplot(covariates_geno_ctpc_tech_cc %>% subset(!is.na(any_wheeze_y1)),
       aes(x=as.factor(any_wheeze_y1), y=dmrmean2)) +
  geom_boxplot()

# subset out dmr2 cpgs
covariates_geno_ctpc_tech_cc_dmr_cpgs <- 
  cbind(covariates_geno_ctpc_tech_cc, 
        t(cb_betas_geno_cc_clean[combp_anno_df_es_sub_escutoff %>%
                                   subset(dmr == 2) %>%
                                   pull(Name),]))

# wheeze
dmr2_mancova_wheeze <- manova(cbind(cg03529432, cg04265576, cg05928186, cg06237983, 
                                    cg09936824, cg12110087, cg12810523, cg14044640, 
                                    cg17994139, cg22469274) ~ any_wheeze_y1 + sex + 
                                gestational_age + 
                                prenatal_maternal_smoke + maternal_education_length + 
                                Comp.1 + Comp.2 + Comp.3 + Comp.4 +
                                genotyping.PC1 + genotyping.PC2 + genotyping.PC3 + 
                                sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + sv7 + sv8 + sv9 + sv10 +
                                sv11 + sv12 + sv13 + sv14 + sv15 + sv16 + sv17, 
                              data = covariates_geno_ctpc_tech_cc_dmr_cpgs)

summary(dmr2_mancova_wheeze, test="Pillai") # any wheeze p = 0.1841408 

# atopy
dmr2_mancova_atopy <- manova(cbind(cg03529432, cg04265576, cg05928186, cg06237983, 
                                   cg09936824, cg12110087, cg12810523, cg14044640, 
                                   cg17994139, cg22469274) ~ clinician_atopy_dx_y1 + sex + 
                               gestational_age + prenatal_maternal_smoke + maternal_education_length + 
                               Comp.1 + Comp.2 + Comp.3 + Comp.4 +
                               genotyping.PC1 + genotyping.PC2 + genotyping.PC3 + 
                               sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + sv7 + sv8 + sv9 + sv10 +
                               sv11 + sv12 + sv13 + sv14 + sv15 + sv16 + sv17, 
                             data = covariates_geno_ctpc_tech_cc_dmr_cpgs)

summary(dmr2_mancova_atopy, test="Pillai") # any wheeze p = 0.7162367 


# DMR 3
covariates_geno_ctpc_tech_cc$dmrmean3 <- 
  cb_betas_geno_cc_clean[combp_anno_df_es_sub_escutoff %>% subset(dmr == 3) %>% pull(Name),] %>% 
  colMeans()

# dmr 3 effect size
combp_anno_df_es_sub_escutoff %>% 
  subset(dmr==3) %>% 
  pull(effect_size) # lower DNAm

ggplot(covariates_geno_ctpc_tech_cc %>% subset(!is.na(any_wheeze_y1)),
       aes(x=as.factor(any_wheeze_y1), y=dmrmean3)) +
  geom_boxplot()

# subset out dmr 3 cpgs
covariates_geno_ctpc_tech_cc_dmr_cpgs <- 
  cbind(covariates_geno_ctpc_tech_cc, 
        t(cb_betas_geno_cc_clean[combp_anno_df_es_sub_escutoff %>%
                                   subset(dmr == 3) %>%
                                   pull(Name),]))

# wheeze
dmr3_mancova_wheeze <- manova(cbind(cg02463440, cg02788857, cg07298985, cg09517075, 
                                    cg10137597, cg10298898, cg14487702, cg18135555, 
                                    cg21471580, cg26039829) ~ any_wheeze_y1 + sex + 
                                gestational_age + 
                                prenatal_maternal_smoke + maternal_education_length + 
                                Comp.1 + Comp.2 + Comp.3 + Comp.4 +
                                genotyping.PC1 + genotyping.PC2 + genotyping.PC3 + 
                                sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + sv7 + sv8 + sv9 + sv10 +
                                sv11 + sv12 + sv13 + sv14 + sv15 + sv16 + sv17, 
                              data = covariates_geno_ctpc_tech_cc_dmr_cpgs)

summary(dmr3_mancova_wheeze, test="Pillai") # any wheeze p = 0.1084379 

# atopy
dmr3_mancova_atopy <- manova(cbind(cg02463440, cg02788857, cg07298985, cg09517075, 
                                   cg10137597, cg10298898, cg14487702, cg18135555, 
                                   cg21471580, cg26039829) ~ clinician_atopy_dx_y1 + sex + 
                               gestational_age + 
                               prenatal_maternal_smoke + maternal_education_length + 
                               Comp.1 + Comp.2 + Comp.3 + Comp.4 +
                               genotyping.PC1 + genotyping.PC2 + genotyping.PC3 + 
                               sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + sv7 + sv8 + sv9 + sv10 +
                               sv11 + sv12 + sv13 + sv14 + sv15 + sv16 + sv17, 
                             data = covariates_geno_ctpc_tech_cc_dmr_cpgs)

summary(dmr3_mancova_atopy, test="Pillai") # any atopy p = 0.1024228  

# DMR 4
covariates_geno_ctpc_tech_cc$dmrmean4 <- 
  cb_betas_geno_cc_clean[combp_anno_df_es %>% subset(dmr == 4) %>% pull(Name),] %>% 
  colMeans()

# dmr 4 effect size
combp_anno_df_es_sub_escutoff %>% 
  subset(dmr==4) %>% 
  pull(effect_size) # higher DNAm

ggplot(covariates_geno_ctpc_tech_cc %>% subset(!is.na(any_wheeze_y1)),
       aes(x=as.factor(any_wheeze_y1), y=dmrmean4)) +
  geom_boxplot()

# subset dmr 4 cpgs
covariates_geno_ctpc_tech_cc_dmr_cpgs <- 
  cbind(covariates_geno_ctpc_tech_cc, 
        t(cb_betas_geno_cc_clean[combp_anno_df_es_sub_escutoff %>%
                                   subset(dmr == 4) %>%
                                   pull(Name),]))

# wheeze
dmr4_mancova_wheeze <- manova(cbind(cg01564268, cg04645039, cg24534926) ~ any_wheeze_y1 + sex + 
                                gestational_age + 
                                prenatal_maternal_smoke + maternal_education_length + 
                                Comp.1 + Comp.2 + Comp.3 + Comp.4 +
                                genotyping.PC1 + genotyping.PC2 + genotyping.PC3 + 
                                sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + sv7 + sv8 + sv9 + sv10 +
                                sv11 + sv12 + sv13 + sv14 + sv15 + sv16 + sv17, 
                              data = covariates_geno_ctpc_tech_cc_dmr_cpgs)

summary(dmr4_mancova_wheeze, test="Pillai") # any wheeze p = 0.4767293

# atopy
dmr4_mancova_atopy <- manova(cbind(cg01564268, cg04645039, cg24534926) ~ 
                               clinician_atopy_dx_y1 + sex + gestational_age + 
                               prenatal_maternal_smoke + maternal_education_length + 
                               Comp.1 + Comp.2 + Comp.3 + Comp.4 +
                               genotyping.PC1 + genotyping.PC2 + genotyping.PC3 + 
                               sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + sv7 + sv8 + sv9 + sv10 +
                               sv11 + sv12 + sv13 + sv14 + sv15 + sv16 + sv17, 
                             data = covariates_geno_ctpc_tech_cc_dmr_cpgs)

summary(dmr4_mancova_atopy, test="Pillai") # any wheeze p = 0.2695668    

# DMR 5
covariates_geno_ctpc_tech_cc$dmrmean5 <- 
  cb_betas_geno_cc_clean[combp_anno_df_es %>% subset(dmr == 5) %>% pull(Name),] %>% 
  colMeans()

# dmr 5 effect size
combp_anno_df_es_sub_escutoff %>% 
  subset(dmr==5) %>% 
  pull(effect_size) # lower DNAm

ggplot(covariates_geno_ctpc_tech_cc %>% subset(!is.na(any_wheeze_y1)),
       aes(x=as.factor(any_wheeze_y1), y=dmrmean5)) +
  geom_boxplot()

# subset out dmr 5 cpgs
covariates_geno_ctpc_tech_cc_dmr_cpgs <- 
  cbind(covariates_geno_ctpc_tech_cc, 
        t(cb_betas_geno_cc_clean[combp_anno_df_es_sub_escutoff %>%
                                   subset(dmr == 5) %>%
                                   pull(Name),]))

# wheeze
dmr5_mancova_wheeze <- manova(cbind(cg05016408, cg06953773, cg07499553, cg13790719, 
                                    cg15996534, cg19585597, cg26212163, cg27079680) ~ 
                                any_wheeze_y1 + sex + 
                                gestational_age + 
                                prenatal_maternal_smoke + maternal_education_length + 
                                Comp.1 + Comp.2 + Comp.3 + Comp.4 +
                                genotyping.PC1 + genotyping.PC2 + genotyping.PC3 + 
                                sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + sv7 + sv8 + sv9 + sv10 +
                                sv11 + sv12 + sv13 + sv14 + sv15 + sv16 + sv17, 
                              data = covariates_geno_ctpc_tech_cc_dmr_cpgs)

summary(dmr5_mancova_wheeze, test="Pillai") # any wheeze p = 0.106488 

# atopy
dmr5_mancova_atopy <- manova(cbind(cg05016408, cg06953773, cg07499553, cg13790719, 
                                   cg15996534, cg19585597, cg26212163, cg27079680) ~ 
                               clinician_atopy_dx_y1 + sex + gestational_age + 
                               prenatal_maternal_smoke + maternal_education_length + 
                               Comp.1 + Comp.2 + Comp.3 + Comp.4 +
                               genotyping.PC1 + genotyping.PC2 + genotyping.PC3 + 
                               sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + sv7 + sv8 + sv9 + sv10 +
                               sv11 + sv12 + sv13 + sv14 + sv15 + sv16 + sv17, 
                             data = covariates_geno_ctpc_tech_cc_dmr_cpgs)

summary(dmr5_mancova_atopy, test="Pillai") # any atopy p = 0.554216     

# DMR 6
covariates_geno_ctpc_tech_cc$dmrmean6 <- 
  cb_betas_geno_cc_clean[combp_anno_df_es %>% subset(dmr == 6) %>% pull(Name),] %>% 
  colMeans()

# dmr 6 effect size
combp_anno_df_es_sub_escutoff %>% 
  subset(dmr==6) %>% 
  pull(effect_size) # lower DNAm

ggplot(covariates_geno_ctpc_tech_cc %>% subset(!is.na(any_wheeze_y1)),
       aes(x=as.factor(any_wheeze_y1), y=dmrmean6)) +
  geom_boxplot()

covariates_geno_ctpc_tech_cc_dmr_cpgs <- 
  cbind(covariates_geno_ctpc_tech_cc, 
        t(cb_betas_geno_cc_clean[combp_anno_df_es_sub_escutoff %>%
                                   subset(dmr == 6) %>%
                                   pull(Name),]))

# wheeze
dmr6_mancova_wheeze <- manova(cbind(cg06888209, cg17646392, cg26089165) ~ any_wheeze_y1 + sex + 
                                gestational_age + 
                                prenatal_maternal_smoke + maternal_education_length + 
                                Comp.1 + Comp.2 + Comp.3 + Comp.4 +
                                genotyping.PC1 + genotyping.PC2 + genotyping.PC3 + 
                                sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + sv7 + sv8 + sv9 + sv10 +
                                sv11 + sv12 + sv13 + sv14 + sv15 + sv16 + sv17, 
                              data = covariates_geno_ctpc_tech_cc_dmr_cpgs)

summary(dmr6_mancova_wheeze, test="Pillai") # any wheeze p = 0.8307230   

# atopy
dmr6_mancova_atopy <- manova(cbind(cg06888209, cg17646392, cg26089165) ~ 
                               clinician_atopy_dx_y1 + sex + gestational_age + 
                               prenatal_maternal_smoke + maternal_education_length + 
                               Comp.1 + Comp.2 + Comp.3 + Comp.4 +
                               genotyping.PC1 + genotyping.PC2 + genotyping.PC3 + 
                               sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + sv7 + sv8 + sv9 + sv10 +
                               sv11 + sv12 + sv13 + sv14 + sv15 + sv16 + sv17, 
                             data = covariates_geno_ctpc_tech_cc_dmr_cpgs)

summary(dmr6_mancova_atopy, test="Pillai") # any atopy p = 0.0636551   


# DMR 7
covariates_geno_ctpc_tech_cc$dmrmean7 <- 
  cb_betas_geno_cc_clean[combp_anno_df_es %>% subset(dmr == 7) %>% pull(Name),] %>% 
  colMeans()

# dmr 7 effect size
combp_anno_df_es_sub_escutoff %>% 
  subset(dmr==7) %>% 
  pull(effect_size) # higher DNAm

ggplot(covariates_geno_ctpc_tech_cc %>% subset(!is.na(any_wheeze_y1)),
       aes(x=as.factor(any_wheeze_y1), y=dmrmean7)) +
  geom_boxplot()

# subset dmr 7 cpgs
covariates_geno_ctpc_tech_cc_dmr_cpgs <- 
  cbind(covariates_geno_ctpc_tech_cc, 
        t(cb_betas_geno_cc_clean[combp_anno_df_es_sub_escutoff %>%
                                   subset(dmr == 7) %>%
                                   pull(Name),]))

# wheeze
dmr7_mancova_wheeze <- manova(cbind(cg09426383, cg19216792, cg20747577) ~
                                any_wheeze_y1 + sex + gestational_age + 
                                prenatal_maternal_smoke + maternal_education_length + 
                                Comp.1 + Comp.2 + Comp.3 + Comp.4 +
                                genotyping.PC1 + genotyping.PC2 + genotyping.PC3 + 
                                sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + sv7 + sv8 + sv9 + sv10 +
                                sv11 + sv12 + sv13 + sv14 + sv15 + sv16 + sv17, 
                              data = covariates_geno_ctpc_tech_cc_dmr_cpgs)

summary(dmr7_mancova_wheeze, test="Pillai") # any wheeze p = 0.544303     

# atopy
dmr7_mancova_atopy <- manova(cbind(cg09426383, cg19216792, cg20747577) ~ 
                               clinician_atopy_dx_y1 + sex + gestational_age + 
                               prenatal_maternal_smoke + maternal_education_length + 
                               Comp.1 + Comp.2 + Comp.3 + Comp.4 +
                               genotyping.PC1 + genotyping.PC2 + genotyping.PC3 + 
                               sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + sv7 + sv8 + sv9 + sv10 +
                               sv11 + sv12 + sv13 + sv14 + sv15 + sv16 + sv17, 
                             data = covariates_geno_ctpc_tech_cc_dmr_cpgs)

summary(dmr7_mancova_atopy, test="Pillai") # any atopy p = 0.1109498    


# DMR 8
covariates_geno_ctpc_tech_cc$dmrmean8 <- 
  cb_betas_geno_cc_clean[combp_anno_df_es %>% subset(dmr == 8) %>% pull(Name),] %>% 
  colMeans()

# dmr 8 effect size
combp_anno_df_es_sub_escutoff %>% 
  subset(dmr==8) %>% 
  pull(effect_size) # lower DNAm

ggplot(covariates_geno_ctpc_tech_cc %>% subset(!is.na(any_wheeze_y1)),
       aes(x=as.factor(any_wheeze_y1), y=dmrmean8)) +
  geom_boxplot()

# subset dmr 8 cpgs
covariates_geno_ctpc_tech_cc_dmr_cpgs <- 
  cbind(covariates_geno_ctpc_tech_cc, 
        t(cb_betas_geno_cc_clean[combp_anno_df_es_sub_escutoff %>%
                                   subset(dmr == 8) %>%
                                   pull(Name),]))

# wheeze
dmr8_mancova_wheeze <- manova(cbind(cg00785941, cg03748376, cg04028570, cg08260406, 
                                    cg08944170, cg20434529, cg20507276) ~ any_wheeze_y1 + sex + 
                                gestational_age + 
                                prenatal_maternal_smoke + maternal_education_length + 
                                Comp.1 + Comp.2 + Comp.3 + Comp.4 +
                                genotyping.PC1 + genotyping.PC2 + genotyping.PC3 + 
                                sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + sv7 + sv8 + sv9 + sv10 +
                                sv11 + sv12 + sv13 + sv14 + sv15 + sv16 + sv17, 
                              data = covariates_geno_ctpc_tech_cc_dmr_cpgs)

summary(dmr8_mancova_wheeze, test="Pillai") # any wheeze p = 0.582027    

# atopy
dmr8_mancova_atopy <- manova(cbind(cg00785941, cg03748376, cg04028570, cg08260406, 
                                   cg08944170, cg20434529, cg20507276) ~ 
                               clinician_atopy_dx_y1 + sex + gestational_age + 
                               prenatal_maternal_smoke + maternal_education_length + 
                               Comp.1 + Comp.2 + Comp.3 + Comp.4 +
                               genotyping.PC1 + genotyping.PC2 + genotyping.PC3 + 
                               sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + sv7 + sv8 + sv9 + sv10 +
                               sv11 + sv12 + sv13 + sv14 + sv15 + sv16 + sv17, 
                             data = covariates_geno_ctpc_tech_cc_dmr_cpgs)

summary(dmr8_mancova_atopy, test="Pillai") # any wheeze p = 0.152508    


# DMR 9
covariates_geno_ctpc_tech_cc$dmrmean9 <- 
  cb_betas_geno_cc_clean[combp_anno_df_es %>% subset(dmr == 9) %>% pull(Name),] %>% 
  colMeans()

# dmr 9 effect size
combp_anno_df_es_sub_escutoff %>% 
  subset(dmr==9) %>% 
  pull(effect_size) # higher DNAm

ggplot(covariates_geno_ctpc_tech_cc %>% subset(!is.na(any_wheeze_y1)),
       aes(x=as.factor(any_wheeze_y1), y=dmrmean9)) +
  geom_boxplot()

# subset dmr 9 cpgs
covariates_geno_ctpc_tech_cc_dmr_cpgs <- 
  cbind(covariates_geno_ctpc_tech_cc, 
        t(cb_betas_geno_cc_clean[combp_anno_df_es_sub_escutoff %>%
                                   subset(dmr == 9) %>%
                                   pull(Name),]))

# wheeze
dmr9_mancova_wheeze <- manova(cbind(cg02574073, cg05888755, cg10906729, cg16848873, 
                                    cg18684142, cg19828220) ~ any_wheeze_y1 + sex + 
                                gestational_age + 
                                prenatal_maternal_smoke + maternal_education_length + 
                                Comp.1 + Comp.2 + Comp.3 + Comp.4 +
                                genotyping.PC1 + genotyping.PC2 + genotyping.PC3 + 
                                sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + sv7 + sv8 + sv9 + sv10 +
                                sv11 + sv12 + sv13 + sv14 + sv15 + sv16 + sv17, 
                              data = covariates_geno_ctpc_tech_cc_dmr_cpgs)

summary(dmr9_mancova_wheeze, test="Pillai") # any wheeze p = 0.344249    

# atopy
dmr9_mancova_atopy <- manova(cbind(cg02574073, cg05888755, cg10906729, cg16848873, 
                                   cg18684142, cg19828220) ~ 
                               clinician_atopy_dx_y1 + sex + gestational_age + 
                               prenatal_maternal_smoke + maternal_education_length + 
                               Comp.1 + Comp.2 + Comp.3 + Comp.4 +
                               genotyping.PC1 + genotyping.PC2 + genotyping.PC3 + 
                               sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + sv7 + sv8 + sv9 + sv10 +
                               sv11 + sv12 + sv13 + sv14 + sv15 + sv16 + sv17, 
                             data = covariates_geno_ctpc_tech_cc_dmr_cpgs)

summary(dmr9_mancova_atopy, test="Pillai") # atopy p = 0.0057741 **     


# DMR 10
covariates_geno_ctpc_tech_cc$dmrmean10 <- 
  cb_betas_geno_cc_clean[combp_anno_df_es %>% subset(dmr == 10) %>% pull(Name),] %>% 
  colMeans()

# dmr 10 effect size
combp_anno_df_es_sub_escutoff %>% 
  subset(dmr==10) %>% 
  pull(effect_size) # lower DNAm

ggplot(covariates_geno_ctpc_tech_cc %>% subset(!is.na(any_wheeze_y1)),
       aes(x=as.factor(any_wheeze_y1), y=dmrmean10)) +
  geom_boxplot()

# subset dmr 10 cpgs
covariates_geno_ctpc_tech_cc_dmr_cpgs <- 
  cbind(covariates_geno_ctpc_tech_cc, 
        t(cb_betas_geno_cc_clean[combp_anno_df_es_sub_escutoff %>%
                                   subset(dmr == 10) %>%
                                   pull(Name),]))

# wheeze
dmr10_mancova_wheeze <- manova(cbind(cg03724423, cg04321618, cg06942814, cg08657492, 
                                     cg11015251, cg14359292, cg16651126, cg17457637, 
                                     cg17591595, cg24169822, cg25952581) ~ any_wheeze_y1 + sex + 
                                 gestational_age + 
                                 prenatal_maternal_smoke + maternal_education_length + 
                                 Comp.1 + Comp.2 + Comp.3 + Comp.4 +
                                 genotyping.PC1 + genotyping.PC2 + genotyping.PC3 + 
                                 sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + sv7 + sv8 + sv9 + sv10 +
                                 sv11 + sv12 + sv13 + sv14 + sv15 + sv16 + sv17, 
                               data = covariates_geno_ctpc_tech_cc_dmr_cpgs)

summary(dmr10_mancova_wheeze, test="Pillai") # any wheeze p = 0.1706771

# atopy
dmr10_mancova_atopy <- manova(cbind(cg03724423, cg04321618, cg06942814, cg08657492, 
                                    cg11015251, cg14359292, cg16651126, cg17457637, 
                                    cg17591595, cg24169822, cg25952581) ~ 
                                clinician_atopy_dx_y1 + sex + gestational_age + 
                                prenatal_maternal_smoke + maternal_education_length + 
                                Comp.1 + Comp.2 + Comp.3 + Comp.4 +
                                genotyping.PC1 + genotyping.PC2 + genotyping.PC3 + 
                                sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + sv7 + sv8 + sv9 + sv10 +
                                sv11 + sv12 + sv13 + sv14 + sv15 + sv16 + sv17, 
                              data = covariates_geno_ctpc_tech_cc_dmr_cpgs)

summary(dmr10_mancova_atopy, test="Pillai") # any wheeze p = 0.6550467    


# DMR 11
covariates_geno_ctpc_tech_cc$dmrmean11 <- 
  cb_betas_geno_cc_clean[combp_anno_df_es %>% subset(dmr == 11) %>% pull(Name),] %>% 
  colMeans()

# dmr 11 effect size
combp_anno_df_es_sub_escutoff %>% 
  subset(dmr==11) %>% 
  pull(effect_size) # lower DNAm

ggplot(covariates_geno_ctpc_tech_cc %>% subset(!is.na(any_wheeze_y1)),
       aes(x=as.factor(any_wheeze_y1), y=dmrmean11)) +
  geom_boxplot()

# subset out dmr 11 cpgs
covariates_geno_ctpc_tech_cc_dmr_cpgs <- 
  cbind(covariates_geno_ctpc_tech_cc, 
        t(cb_betas_geno_cc_clean[combp_anno_df_es_sub_escutoff %>%
                                   subset(dmr == 11) %>%
                                   pull(Name),]))

# wheeze
dmr11_mancova_wheeze <- manova(cbind(cg02649248, cg07658809) ~ any_wheeze_y1 + sex + 
                                 gestational_age + 
                                 prenatal_maternal_smoke + maternal_education_length + 
                                 Comp.1 + Comp.2 + Comp.3 + Comp.4 +
                                 genotyping.PC1 + genotyping.PC2 + genotyping.PC3 + 
                                 sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + sv7 + sv8 + sv9 + sv10 +
                                 sv11 + sv12 + sv13 + sv14 + sv15 + sv16 + sv17, 
                               data = covariates_geno_ctpc_tech_cc_dmr_cpgs)

summary(dmr11_mancova_wheeze, test="Pillai") # any wheeze p = 0.762636

# atopy
dmr11_mancova_atopy <- manova(cbind(cg02649248, cg07658809) ~ 
                                clinician_atopy_dx_y1 + sex + gestational_age + 
                                prenatal_maternal_smoke + maternal_education_length + 
                                Comp.1 + Comp.2 + Comp.3 + Comp.4 +
                                genotyping.PC1 + genotyping.PC2 + genotyping.PC3 + 
                                sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + sv7 + sv8 + sv9 + sv10 +
                                sv11 + sv12 + sv13 + sv14 + sv15 + sv16 + sv17, 
                              data = covariates_geno_ctpc_tech_cc_dmr_cpgs)

summary(dmr11_mancova_atopy, test="Pillai") # any atopy p = 0.0251976

# DMR 12
covariates_geno_ctpc_tech_cc$dmrmean12 <- 
  cb_betas_geno_cc_clean[combp_anno_df_es %>% subset(dmr == 12) %>% pull(Name),] %>% 
  colMeans()

# dmr 12 effect size
combp_anno_df_es_sub_escutoff %>% 
  subset(dmr==12) %>% 
  pull(effect_size) # higher DNAm

ggplot(covariates_geno_ctpc_tech_cc %>% subset(!is.na(any_wheeze_y1)),
       aes(x=as.factor(any_wheeze_y1), y=dmrmean12)) +
  geom_boxplot()

# subset dmr 12 cpgs
covariates_geno_ctpc_tech_cc_dmr_cpgs <- 
  cbind(covariates_geno_ctpc_tech_cc, 
        t(cb_betas_geno_cc_clean[combp_anno_df_es_sub_escutoff %>%
                                   subset(dmr == 12) %>%
                                   pull(Name),]))

# wheeze
dmr12_mancova_wheeze <- manova(cbind(cg00701946, cg01876338, cg05414908, cg08611810, 
                                     cg12451530, cg13356253, cg14832904, cg19878627, 
                                     cg19961545) ~ any_wheeze_y1 + sex + 
                                 gestational_age + 
                                 prenatal_maternal_smoke + maternal_education_length + 
                                 Comp.1 + Comp.2 + Comp.3 + Comp.4 +
                                 genotyping.PC1 + genotyping.PC2 + genotyping.PC3 + 
                                 sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + sv7 + sv8 + sv9 + sv10 +
                                 sv11 + sv12 + sv13 + sv14 + sv15 + sv16 + sv17, 
                               data = covariates_geno_ctpc_tech_cc_dmr_cpgs)

summary(dmr12_mancova_wheeze, test="Pillai") # any wheeze p = 0.3110278 

# atopy
dmr12_mancova_atopy <- manova(cbind(cg00701946, cg01876338, cg05414908, cg08611810, 
                                    cg12451530, cg13356253, cg14832904, cg19878627, 
                                    cg19961545) ~ clinician_atopy_dx_y1 + sex + 
                                gestational_age + 
                                prenatal_maternal_smoke + maternal_education_length + 
                                Comp.1 + Comp.2 + Comp.3 + Comp.4 +
                                genotyping.PC1 + genotyping.PC2 + genotyping.PC3 + 
                                sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + sv7 + sv8 + sv9 + sv10 +
                                sv11 + sv12 + sv13 + sv14 + sv15 + sv16 + sv17, 
                              data = covariates_geno_ctpc_tech_cc_dmr_cpgs)

summary(dmr12_mancova_atopy, test="Pillai") # atopy p = 0.0045016  


# DMR 13
covariates_geno_ctpc_tech_cc$dmrmean13 <- 
  cb_betas_geno_cc_clean[combp_anno_df_es %>% subset(dmr == 13) %>% pull(Name),] %>% 
  colMeans()

# dmr 13 effect size
combp_anno_df_es_sub_escutoff %>% 
  subset(dmr==13) %>% 
  pull(effect_size) # higher DNAm

ggplot(covariates_geno_ctpc_tech_cc %>% subset(!is.na(any_wheeze_y1)),
       aes(x=as.factor(any_wheeze_y1), y=dmrmean13)) +
  geom_boxplot()

# subset dmr 13 cpgs
covariates_geno_ctpc_tech_cc_dmr_cpgs <- 
  cbind(covariates_geno_ctpc_tech_cc, 
        t(cb_betas_geno_cc_clean[combp_anno_df_es_sub_escutoff %>%
                                   subset(dmr == 13) %>%
                                   pull(Name),]))

# wheeze
dmr13_mancova_wheeze <- manova(cbind(cg02749105, cg09594291, cg24052338) ~ 
                                 any_wheeze_y1 + sex + gestational_age + 
                                 prenatal_maternal_smoke + maternal_education_length + 
                                 Comp.1 + Comp.2 + Comp.3 + Comp.4 +
                                 genotyping.PC1 + genotyping.PC2 + genotyping.PC3 + 
                                 sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + sv7 + sv8 + sv9 + sv10 +
                                 sv11 + sv12 + sv13 + sv14 + sv15 + sv16 + sv17, 
                               data = covariates_geno_ctpc_tech_cc_dmr_cpgs)

summary(dmr13_mancova_wheeze, test="Pillai") # any wheeze p = 0.254663 

# atopy
dmr13_mancova_atopy <- manova(cbind(cg02749105, cg09594291, cg24052338) ~ 
                                clinician_atopy_dx_y1 + sex + gestational_age + 
                                prenatal_maternal_smoke + maternal_education_length + 
                                Comp.1 + Comp.2 + Comp.3 + Comp.4 +
                                genotyping.PC1 + genotyping.PC2 + genotyping.PC3 + 
                                sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + sv7 + sv8 + sv9 + sv10 +
                                sv11 + sv12 + sv13 + sv14 + sv15 + sv16 + sv17, 
                              data = covariates_geno_ctpc_tech_cc_dmr_cpgs)

summary(dmr13_mancova_atopy, test="Pillai") # atopy p = 5.546e-05 


longdf_dmr13 <- pivot_longer(covariates_geno_ctpc_tech_cc_dmr_cpgs %>% 
                               select(cg02749105, cg09594291, cg24052338, 
                                      sample_id, clinician_atopy_dx_y1, 
                                      no2_prenatal_avg_2019v),
                             cols = -c(sample_id, clinician_atopy_dx_y1, 
                                       no2_prenatal_avg_2019v), 
                             names_to = "cpg", 
                             values_to = "dnam") %>%
  mutate(cpg = factor(cpg, levels = c("cg09594291", "cg02749105", "cg24052338"))) %>%
  mutate(no2_colour = ifelse(no2_prenatal_avg_2019v < 7.32, "first",
                             ifelse(no2_prenatal_avg_2019v >=7.32 & no2_prenatal_avg_2019v < 12.01 , "second", ifelse(no2_prenatal_avg_2019v >= 12.01  & no2_prenatal_avg_2019v < 16.25, "third", "fourth")))) %>%
  mutate(no2_colour = factor(no2_colour, levels = c("first", "second",  "third", "fourth")))

dmr13_atopy_vis <- 
  ggplot(longdf_dmr13, aes(x=cpg, y=dnam, 
                           group = interaction(cpg, clinician_atopy_dx_y1), 
                           shape = as.factor(clinician_atopy_dx_y1),
                           color = no2_colour,
                           fill = as.factor(clinician_atopy_dx_y1))) +
  scale_shape_manual(values = c(20, 17), labels = c("No", "Yes")) +
  scale_color_manual( values = c("#87a8e8", "#4484fc", "#254A90", "#10203d")) +
  scale_fill_manual(values = c("white", "grey"), 
                    name = "Age one atopy",
                    labels = c("No", "Yes")) +
  geom_violin(draw_quantiles = c(0.5), trim = T, alpha =0.6) +
  ggbeeswarm::geom_beeswarm(dodge.width=0.9, cex = 1.6, size = 0.5, groupOnX = T, ) +
  theme_bw() +
  scale_x_discrete(labels = c("cg09594291",
                              "cg02749105",
                              "cg24052338"),
                   name = element_blank()) +
  scale_y_continuous(name = "DNA methylation (%)") +
  theme(legend.position = "none",
        axis.text = element_text(size = 9),
        panel.grid.major.x = element_blank())

ggsave(plot = dmr13_atopy_vis,
       filename  = here("figures",
                        "linear_regression",
                        "prenatal",
                        "2022-11-22_no2_cb_dmr13_atopy.png"), 
       width = 7.5, height = 5, units = "cm")


# DMR 14
covariates_geno_ctpc_tech_cc$dmrmean14 <- 
  cb_betas_geno_cc_clean[combp_anno_df_es %>% subset(dmr == 14) %>% pull(Name),] %>% 
  colMeans()

# dmr 14 effect size
combp_anno_df_es_sub_escutoff %>% 
  subset(dmr==14) %>% 
  pull(effect_size) # lower DNAm

ggplot(covariates_geno_ctpc_tech_cc %>% subset(!is.na(any_wheeze_y1)),
       aes(x=as.factor(any_wheeze_y1), y=dmrmean14)) +
  geom_boxplot()

# MANCOVA
# subset dmr 14 cpgs
covariates_geno_ctpc_tech_cc_dmr_cpgs <- 
  cbind(covariates_geno_ctpc_tech_cc, 
        t(cb_betas_geno_cc_clean[combp_anno_df_es_sub_escutoff %>%
                                   subset(dmr == 14) %>%
                                   pull(Name),]))

# wheeze
dmr14_mancova_wheeze <- manova(cbind(cg04231094, cg05353869, cg06329735) ~ any_wheeze_y1 + sex + 
                                 gestational_age + 
                                 prenatal_maternal_smoke + maternal_education_length + 
                                 Comp.1 + Comp.2 + Comp.3 + Comp.4 +
                                 genotyping.PC1 + genotyping.PC2 + genotyping.PC3 + 
                                 sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + sv7 + sv8 + sv9 + sv10 +
                                 sv11 + sv12 + sv13 + sv14 + sv15 + sv16 + sv17, 
                               data = covariates_geno_ctpc_tech_cc_dmr_cpgs)

summary(dmr14_mancova_wheeze, test="Pillai") # any wheeze p = 0.1621576  

# atopy
dmr14_mancova_atopy <- manova(cbind(cg04231094, cg05353869, cg06329735) ~ 
                                clinician_atopy_dx_y1 + sex + gestational_age + 
                                prenatal_maternal_smoke + maternal_education_length + 
                                Comp.1 + Comp.2 + Comp.3 + Comp.4 +
                                genotyping.PC1 + genotyping.PC2 + genotyping.PC3 + 
                                sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + sv7 + sv8 + sv9 + sv10 +
                                sv11 + sv12 + sv13 + sv14 + sv15 + sv16 + sv17, 
                              data = covariates_geno_ctpc_tech_cc_dmr_cpgs)

summary(dmr14_mancova_atopy, test="Pillai") # any wheeze p = 0.2409701    


# DMR 15
covariates_geno_ctpc_tech_cc$dmrmean15 <- 
  cb_betas_geno_cc_clean[combp_anno_df_es %>% subset(dmr == 15) %>% pull(Name),] %>% 
  colMeans()

# dmr 15 effect size
combp_anno_df_es_sub_escutoff %>% 
  subset(dmr==15) %>% 
  pull(effect_size) # higher DNAm

ggplot(covariates_geno_ctpc_tech_cc %>% subset(!is.na(any_wheeze_y1)),
       aes(x=as.factor(any_wheeze_y1), y=dmrmean15)) +
  geom_boxplot()

# MANCOVA
# subset dmr 15 cpgs
covariates_geno_ctpc_tech_cc_dmr_cpgs <- 
  cbind(covariates_geno_ctpc_tech_cc, 
        t(cb_betas_geno_cc_clean[combp_anno_df_es_sub_escutoff %>%
                                   subset(dmr == 15) %>%
                                   pull(Name),]))

# wheeze
dmr15_mancova_wheeze <- manova(cbind(cg00256046, cg04217177, cg17434154) ~ any_wheeze_y1 + sex + 
                                 gestational_age + 
                                 prenatal_maternal_smoke + maternal_education_length + 
                                 Comp.1 + Comp.2 + Comp.3 + Comp.4 +
                                 genotyping.PC1 + genotyping.PC2 + genotyping.PC3 + 
                                 sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + sv7 + sv8 + sv9 + sv10 +
                                 sv11 + sv12 + sv13 + sv14 + sv15 + sv16 + sv17, 
                               data = covariates_geno_ctpc_tech_cc_dmr_cpgs)

summary(dmr15_mancova_wheeze, test="Pillai") # any wheeze p = 0.4586307 

# atopy
dmr15_mancova_atopy <- manova(cbind(cg00256046, cg04217177, cg17434154) ~ 
                                clinician_atopy_dx_y1 + sex + gestational_age + 
                                prenatal_maternal_smoke + maternal_education_length + 
                                Comp.1 + Comp.2 + Comp.3 + Comp.4 +
                                genotyping.PC1 + genotyping.PC2 + genotyping.PC3 + 
                                sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + sv7 + sv8 + sv9 + sv10 +
                                sv11 + sv12 + sv13 + sv14 + sv15 + sv16 + sv17, 
                              data = covariates_geno_ctpc_tech_cc_dmr_cpgs)

summary(dmr15_mancova_atopy, test="Pillai") # any wheeze p = 0.0180669 


# DMR 16
covariates_geno_ctpc_tech_cc$dmrmean16 <- 
  cb_betas_geno_cc_clean[combp_anno_df_es %>% subset(dmr == 16) %>% pull(Name),] %>% 
  colMeans()

# dmr 16 effect size
combp_anno_df_es_sub_escutoff %>% 
  subset(dmr==16) %>% 
  pull(effect_size) # higher DNAm

ggplot(covariates_geno_ctpc_tech_cc %>% subset(!is.na(any_wheeze_y1)),
       aes(x=as.factor(any_wheeze_y1), y=dmrmean16)) +
  geom_boxplot()

# MANCOVA
# subset dmr 16 cpgs
covariates_geno_ctpc_tech_cc_dmr_cpgs <- 
  cbind(covariates_geno_ctpc_tech_cc, 
        t(cb_betas_geno_cc_clean[combp_anno_df_es_sub_escutoff %>%
                                   subset(dmr == 16) %>%
                                   pull(Name),]))

# wheeze
dmr16_mancova_wheeze <- manova(cbind(cg14583973, cg18352616, cg22655196) ~ any_wheeze_y1 + sex + 
                                 gestational_age + 
                                 prenatal_maternal_smoke + maternal_education_length + 
                                 Comp.1 + Comp.2 + Comp.3 + Comp.4 +
                                 genotyping.PC1 + genotyping.PC2 + genotyping.PC3 + 
                                 sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + sv7 + sv8 + sv9 + sv10 +
                                 sv11 + sv12 + sv13 + sv14 + sv15 + sv16 + sv17, 
                               data = covariates_geno_ctpc_tech_cc_dmr_cpgs)

summary(dmr16_mancova_wheeze, test="Pillai") # any wheeze p = 0.0429344****

# atopy
dmr16_mancova_atopy <- manova(cbind(cg14583973, cg18352616, cg22655196) ~ 
                                clinician_atopy_dx_y1 + sex + gestational_age + 
                                prenatal_maternal_smoke + maternal_education_length + 
                                Comp.1 + Comp.2 + Comp.3 + Comp.4 +
                                genotyping.PC1 + genotyping.PC2 + genotyping.PC3 + 
                                sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + sv7 + sv8 + sv9 + sv10 +
                                sv11 + sv12 + sv13 + sv14 + sv15 + sv16 + sv17, 
                              data = covariates_geno_ctpc_tech_cc_dmr_cpgs)

summary(dmr16_mancova_atopy, test="Pillai") # any wheeze p = 0.0063444

# DMR 18
covariates_geno_ctpc_tech_cc$dmrmean18 <- 
  cb_betas_geno_cc_clean[combp_anno_df_es_sub_escutoff %>% subset(dmr == 18) %>% pull(Name),] %>% 
  colMeans()

# dmr 18 effect size
combp_anno_df_es_sub_escutoff %>% 
  subset(dmr==18) %>% 
  pull(effect_size) # lower DNAm

ggplot(covariates_geno_ctpc_tech_cc %>% subset(!is.na(any_wheeze_y1)),
       aes(x=as.factor(any_wheeze_y1), y=dmrmean18)) +
  geom_boxplot()

# MANCOVA
# subset dmr 18 cpgs
covariates_geno_ctpc_tech_cc_dmr_cpgs <- 
  cbind(covariates_geno_ctpc_tech_cc, 
        t(cb_betas_geno_cc_clean[combp_anno_df_es_sub_escutoff %>%
                                   subset(dmr == 18) %>%
                                   pull(Name),]))

# wheeze
dmr18_mancova_wheeze <- manova(cbind(cg06853455, cg12764003) ~ any_wheeze_y1 + sex + 
                                 gestational_age + 
                                 prenatal_maternal_smoke + maternal_education_length + 
                                 Comp.1 + Comp.2 + Comp.3 + Comp.4 +
                                 genotyping.PC1 + genotyping.PC2 + genotyping.PC3 + 
                                 sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + sv7 + sv8 + sv9 + sv10 +
                                 sv11 + sv12 + sv13 + sv14 + sv15 + sv16 + sv17, 
                               data = covariates_geno_ctpc_tech_cc_dmr_cpgs)

summary(dmr18_mancova_wheeze, test="Pillai") # any wheeze p = 0.35775 

# atopy
dmr18_mancova_atopy <- manova(cbind(cg06853455, cg12764003) ~ 
                                clinician_atopy_dx_y1 + sex + gestational_age + 
                                prenatal_maternal_smoke + maternal_education_length + 
                                Comp.1 + Comp.2 + Comp.3 + Comp.4 +
                                genotyping.PC1 + genotyping.PC2 + genotyping.PC3 + 
                                sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + sv7 + sv8 + sv9 + sv10 +
                                sv11 + sv12 + sv13 + sv14 + sv15 + sv16 + sv17, 
                              data = covariates_geno_ctpc_tech_cc_dmr_cpgs)

summary(dmr18_mancova_atopy, test="Pillai") # atopy p = 0.66060 


# DMR 19
covariates_geno_ctpc_tech_cc$dmrmean19 <- 
  cb_betas_geno_cc_clean[combp_anno_df_es_sub_escutoff %>% subset(dmr == 19) %>% pull(Name),] %>% 
  colMeans()

# dmr 19 effect size
combp_anno_df_es_sub_escutoff %>% 
  subset(dmr==19) %>% 
  pull(effect_size) # higher DNAm

ggplot(covariates_geno_ctpc_tech_cc %>% subset(!is.na(any_wheeze_y1)),
       aes(x=as.factor(any_wheeze_y1), y=dmrmean19)) +
  geom_boxplot()

# MANCOVA
# subset dmr 19 cpgs
covariates_geno_ctpc_tech_cc_dmr_cpgs <- 
  cbind(covariates_geno_ctpc_tech_cc, 
        t(cb_betas_geno_cc_clean[combp_anno_df_es_sub_escutoff %>%
                                   subset(dmr == 19) %>%
                                   pull(Name),]))

# wheeze
dmr19_mancova_wheeze <- manova(cbind(cg09512891, cg25437304) ~ any_wheeze_y1 + sex + 
                                 gestational_age + 
                                 prenatal_maternal_smoke + maternal_education_length + 
                                 Comp.1 + Comp.2 + Comp.3 + Comp.4 +
                                 genotyping.PC1 + genotyping.PC2 + genotyping.PC3 + 
                                 sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + sv7 + sv8 + sv9 + sv10 +
                                 sv11 + sv12 + sv13 + sv14 + sv15 + sv16 + sv17, 
                               data = covariates_geno_ctpc_tech_cc_dmr_cpgs)

summary(dmr19_mancova_wheeze, test="Pillai") # any wheeze p = 0.779689  

# atopy
dmr19_mancova_atopy <- manova(cbind(cg09512891, cg25437304) ~ 
                                clinician_atopy_dx_y1 + sex + gestational_age + 
                                prenatal_maternal_smoke + maternal_education_length + 
                                Comp.1 + Comp.2 + Comp.3 + Comp.4 +
                                genotyping.PC1 + genotyping.PC2 + genotyping.PC3 + 
                                sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + sv7 + sv8 + sv9 + sv10 +
                                sv11 + sv12 + sv13 + sv14 + sv15 + sv16 + sv17, 
                              data = covariates_geno_ctpc_tech_cc_dmr_cpgs)

summary(dmr19_mancova_atopy, test="Pillai") # atopy p = 0.254903 


# DMR 20
covariates_geno_ctpc_tech_cc$dmrmean20 <- 
  cb_betas_geno_cc_clean[combp_anno_df_es_sub_escutoff %>% subset(dmr == 20) %>% pull(Name),] %>% 
  colMeans()

# dmr 20 effect size
combp_anno_df_es_sub_escutoff %>% 
  subset(dmr==20) %>% 
  pull(effect_size) # lower DNAm

ggplot(covariates_geno_ctpc_tech_cc %>% subset(!is.na(any_wheeze_y1)),
       aes(x=as.factor(any_wheeze_y1), y=dmrmean20)) +
  geom_boxplot()

# MANCOVA
# subset dmr 20 cpgs
covariates_geno_ctpc_tech_cc_dmr_cpgs <- 
  cbind(covariates_geno_ctpc_tech_cc, 
        t(cb_betas_geno_cc_clean[combp_anno_df_es_sub_escutoff %>%
                                   subset(dmr == 20) %>%
                                   pull(Name),]))

# wheeze
dmr20_mancova_wheeze <- manova(cbind(cg02105458, cg02614024, cg03829137, cg11179621) ~ 
                                 any_wheeze_y1 + sex + gestational_age + 
                                 prenatal_maternal_smoke + maternal_education_length + 
                                 Comp.1 + Comp.2 + Comp.3 + Comp.4 +
                                 genotyping.PC1 + genotyping.PC2 + genotyping.PC3 + 
                                 sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + sv7 + sv8 + sv9 + sv10 +
                                 sv11 + sv12 + sv13 + sv14 + sv15 + sv16 + sv17, 
                               data = covariates_geno_ctpc_tech_cc_dmr_cpgs)

summary(dmr20_mancova_wheeze, test="Pillai") # any wheeze p = 0.1855319   

# atopy
dmr20_mancova_atopy <- manova(cbind(cg02105458, cg02614024, cg03829137, cg11179621) ~ 
                                clinician_atopy_dx_y1 + sex + gestational_age + 
                                prenatal_maternal_smoke + maternal_education_length + 
                                Comp.1 + Comp.2 + Comp.3 + Comp.4 +
                                genotyping.PC1 + genotyping.PC2 + genotyping.PC3 + 
                                sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + sv7 + sv8 + sv9 + sv10 +
                                sv11 + sv12 + sv13 + sv14 + sv15 + sv16 + sv17, 
                              data = covariates_geno_ctpc_tech_cc_dmr_cpgs)

summary(dmr20_mancova_atopy, test="Pillai") # atopy p = 0.5985048     

# DMR 21
covariates_geno_ctpc_tech_cc$dmrmean21 <- 
  cb_betas_geno_cc_clean[combp_anno_df_es_sub_escutoff %>% subset(dmr == 21) %>% pull(Name),] %>% 
  colMeans()

# dmr 21 effect size
combp_anno_df_es_sub_escutoff %>% 
  subset(dmr==21) %>% 
  pull(effect_size) # higher DNAm

ggplot(covariates_geno_ctpc_tech_cc %>% subset(!is.na(any_wheeze_y1)),
       aes(x=as.factor(any_wheeze_y1), y=dmrmean21)) +
  geom_boxplot()

# MANCOVA
# subset dmr 21 cpgs
covariates_geno_ctpc_tech_cc_dmr_cpgs <- 
  cbind(covariates_geno_ctpc_tech_cc, 
        t(cb_betas_geno_cc_clean[combp_anno_df_es_sub_escutoff %>%
                                   subset(dmr == 21) %>%
                                   pull(Name),]))

# wheeze
dmr21_mancova_wheeze <- manova(cbind(cg04534697, cg05170671, cg12793096, cg26656672) ~ 
                                 any_wheeze_y1 + sex + gestational_age + 
                                 prenatal_maternal_smoke + maternal_education_length + 
                                 Comp.1 + Comp.2 + Comp.3 + Comp.4 +
                                 genotyping.PC1 + genotyping.PC2 + genotyping.PC3 + 
                                 sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + sv7 + sv8 + sv9 + sv10 +
                                 sv11 + sv12 + sv13 + sv14 + sv15 + sv16 + sv17, 
                               data = covariates_geno_ctpc_tech_cc_dmr_cpgs)

summary(dmr21_mancova_wheeze, test="Pillai") # any wheeze p =  0.0240144

# atopy
dmr21_mancova_atopy <- manova(cbind(cg04534697, cg05170671, cg12793096, cg26656672) ~ 
                                clinician_atopy_dx_y1 + sex + gestational_age + 
                                prenatal_maternal_smoke + maternal_education_length + 
                                Comp.1 + Comp.2 + Comp.3 + Comp.4 +
                                genotyping.PC1 + genotyping.PC2 + genotyping.PC3 + 
                                sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + sv7 + sv8 + sv9 + sv10 +
                                sv11 + sv12 + sv13 + sv14 + sv15 + sv16 + sv17, 
                              data = covariates_geno_ctpc_tech_cc_dmr_cpgs)

summary(dmr21_mancova_atopy, test="Pillai") # atopy p = 0.1119310      

# DMR 23
covariates_geno_ctpc_tech_cc$dmrmean23 <- 
  cb_betas_geno_cc_clean[combp_anno_df_es_sub_escutoff %>% subset(dmr == 23) %>% pull(Name),] %>% 
  colMeans()

# dmr 23 effect size
combp_anno_df_es_sub_escutoff %>% 
  subset(dmr==23) %>% 
  pull(effect_size) # higher DNAm

ggplot(covariates_geno_ctpc_tech_cc %>% subset(!is.na(any_wheeze_y1)),
       aes(x=as.factor(any_wheeze_y1), y=dmrmean23)) +
  geom_boxplot()

# subset dmr 23 cpgs
covariates_geno_ctpc_tech_cc_dmr_cpgs <- 
  cbind(covariates_geno_ctpc_tech_cc, 
        t(cb_betas_geno_cc_clean[combp_anno_df_es_sub_escutoff %>%
                                   subset(dmr == 23) %>%
                                   pull(Name),]))

# wheeze
dmr23_mancova_wheeze <- manova(cbind(cg05086567, cg11874331, cg17887478) ~ 
                                 any_wheeze_y1 + sex + gestational_age + 
                                 prenatal_maternal_smoke + maternal_education_length + 
                                 Comp.1 + Comp.2 + Comp.3 + Comp.4 +
                                 genotyping.PC1 + genotyping.PC2 + genotyping.PC3 + 
                                 sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + sv7 + sv8 + sv9 + sv10 +
                                 sv11 + sv12 + sv13 + sv14 + sv15 + sv16 + sv17, 
                               data = covariates_geno_ctpc_tech_cc_dmr_cpgs)

summary(dmr23_mancova_wheeze, test="Pillai") # any wheeze p = 0.001144

# plot wheeze
longdf_dmr23 <- pivot_longer(covariates_geno_ctpc_tech_cc_dmr_cpgs %>% 
                               select(cg05086567 , cg11874331 , cg17887478 , 
                                      sample_id, any_wheeze_y1, no2_prenatal_avg_2019v),
                             cols = -c(sample_id, any_wheeze_y1, no2_prenatal_avg_2019v), 
                             names_to = "cpg", 
                             values_to = "dnam") %>%
  mutate(cpg = factor(cpg, levels = c("cg17887478", "cg11874331", "cg05086567"))) %>%
  na.omit() %>%
  mutate(no2_colour = ifelse(no2_prenatal_avg_2019v < 7.32, "first",
                             ifelse(no2_prenatal_avg_2019v >=7.32 & no2_prenatal_avg_2019v < 12.01 , "second", ifelse(no2_prenatal_avg_2019v >= 12.01  & no2_prenatal_avg_2019v < 16.25, "third", "fourth")))) %>%
  mutate(no2_colour = factor(no2_colour, levels = c("first", "second",  "third", "fourth")))

# violin plots
dmr23_wheeze_vis <-  ggplot(longdf_dmr23, 
                            aes(x=cpg, y=dnam, 
                                group = interaction(cpg, any_wheeze_y1), 
                                shape = as.factor(any_wheeze_y1),
                                color = no2_colour,
                                fill = as.factor(any_wheeze_y1))) +
  scale_shape_manual(values = c(20, 17), labels = c("No", "Yes")) +
  scale_color_manual( values = c("#87a8e8", "#4484fc", "#254A90", "#10203d")) +
  scale_fill_manual(values = c("white", "grey"), 
                    name = "Any wheeze age one",
                    labels = c("No", "Yes")) +
  geom_violin(draw_quantiles = c(0.5), trim = T, alpha =0.6) +
  ggbeeswarm::geom_beeswarm(dodge.width=0.9, cex = 1.6, size = 0.5, groupOnX = T, ) +
  theme_bw() +
  scale_x_discrete(labels = c("cg17887478",
                              "cg11874331",
                              "cg05086567"),
                   name = element_blank()) +
  scale_y_continuous(name = "DNA methylation (%)") +
  theme(legend.position = "none",
        axis.text = element_text(size =9),
        panel.grid.major.x = element_blank())

ggsave(plot = dmr23_wheeze_vis,
       filename  = here("figures",
                        "linear_regression",
                        "prenatal",
                        "2022-11-22_no2_cb_dmr23_wheeze.png"), 
       width = 7.5, height = 5, units = "cm")


# atopy
dmr23_mancova_atopy <- manova(cbind(cg05086567, cg11874331, cg17887478) ~ 
                                clinician_atopy_dx_y1 + sex + gestational_age + 
                                prenatal_maternal_smoke + maternal_education_length + 
                                Comp.1 + Comp.2 + Comp.3 + Comp.4 +
                                genotyping.PC1 + genotyping.PC2 + genotyping.PC3 + 
                                sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + sv7 + sv8 + sv9 + sv10 +
                                sv11 + sv12 + sv13 + sv14 + sv15 + sv16 + sv17, 
                              data = covariates_geno_ctpc_tech_cc_dmr_cpgs)

summary(dmr23_mancova_atopy, test="Pillai") # atopy p = 0.0164543    

# DMR 24
covariates_geno_ctpc_tech_cc$dmrmean24 <- 
  cb_betas_geno_cc_clean[combp_anno_df_es_sub_escutoff %>% subset(dmr == 24) %>% pull(Name),] %>% 
  colMeans()

# dmr 24 effect size
combp_anno_df_es_sub_escutoff %>% 
  subset(dmr==24) %>% 
  pull(effect_size) # less DNAm

# MANCOVA
# subset dmr 24 cpgs
covariates_geno_ctpc_tech_cc_dmr_cpgs <- 
  cbind(covariates_geno_ctpc_tech_cc, 
        t(cb_betas_geno_cc_clean[combp_anno_df_es_sub_escutoff %>%
                                   subset(dmr == 24) %>%
                                   pull(Name),]))

# wheeze
dmr24_mancova_wheeze <- manova(cbind(cg16608407, cg18978493) ~ 
                                 any_wheeze_y1 + sex + gestational_age + 
                                 prenatal_maternal_smoke + maternal_education_length + 
                                 Comp.1 + Comp.2 + Comp.3 + Comp.4 +
                                 genotyping.PC1 + genotyping.PC2 + genotyping.PC3 + 
                                 sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + sv7 + sv8 + sv9 + sv10 +
                                 sv11 + sv12 + sv13 + sv14 + sv15 + sv16 + sv17, 
                               data = covariates_geno_ctpc_tech_cc_dmr_cpgs)

summary(dmr24_mancova_wheeze, test="Pillai") # any wheeze p = 0.27635  

# atopy
dmr24_mancova_atopy <- manova(cbind(cg16608407, cg18978493) ~ 
                                clinician_atopy_dx_y1 + sex + gestational_age + 
                                prenatal_maternal_smoke + maternal_education_length + 
                                Comp.1 + Comp.2 + Comp.3 + Comp.4 +
                                genotyping.PC1 + genotyping.PC2 + genotyping.PC3 + 
                                sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + sv7 + sv8 + sv9 + sv10 +
                                sv11 + sv12 + sv13 + sv14 + sv15 + sv16 + sv17, 
                              data = covariates_geno_ctpc_tech_cc_dmr_cpgs)

summary(dmr24_mancova_atopy, test="Pillai") # atopy p = 0.296082  


# DMR 25
covariates_geno_ctpc_tech_cc$dmrmean25 <- 
  cb_betas_geno_cc_clean[combp_anno_df_es_sub_escutoff %>% subset(dmr == 25) %>% pull(Name),] %>% 
  colMeans()

# dmr 25 effect size
combp_anno_df_es_sub_escutoff %>% 
  subset(dmr==25) %>% 
  pull(effect_size) # higher DNAm

ggplot(covariates_geno_ctpc_tech_cc %>% subset(!is.na(any_wheeze_y1)),
       aes(x=as.factor(any_wheeze_y1), y=dmrmean25)) +
  geom_boxplot()

# MANCOVA
# subset dmr 25 cpgs
covariates_geno_ctpc_tech_cc_dmr_cpgs <- 
  cbind(covariates_geno_ctpc_tech_cc, 
        t(cb_betas_geno_cc_clean[combp_anno_df_es_sub_escutoff %>%
                                   subset(dmr == 25) %>%
                                   pull(Name),]))

# wheeze
dmr25_mancova_wheeze <- manova(cbind(cg08383929, cg15946312) ~ 
                                 any_wheeze_y1 + sex + gestational_age + 
                                 prenatal_maternal_smoke + maternal_education_length + 
                                 Comp.1 + Comp.2 + Comp.3 + Comp.4 +
                                 genotyping.PC1 + genotyping.PC2 + genotyping.PC3 + 
                                 sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + sv7 + sv8 + sv9 + sv10 +
                                 sv11 + sv12 + sv13 + sv14 + sv15 + sv16 + sv17, 
                               data = covariates_geno_ctpc_tech_cc_dmr_cpgs)

summary(dmr25_mancova_wheeze, test="Pillai") # any wheeze p = 0.1170872  

# atopy
dmr25_mancova_atopy <- manova(cbind(cg08383929, cg15946312) ~ 
                                clinician_atopy_dx_y1 + sex + gestational_age + 
                                prenatal_maternal_smoke + maternal_education_length + 
                                Comp.1 + Comp.2 + Comp.3 + Comp.4 +
                                genotyping.PC1 + genotyping.PC2 + genotyping.PC3 + 
                                sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + sv7 + sv8 + sv9 + sv10 +
                                sv11 + sv12 + sv13 + sv14 + sv15 + sv16 + sv17, 
                              data = covariates_geno_ctpc_tech_cc_dmr_cpgs)

summary(dmr25_mancova_atopy, test="Pillai") # atopy p = 0.0045309  


# DMR 27
covariates_geno_ctpc_tech_cc$dmrmean27 <- 
  cb_betas_geno_cc_clean[combp_anno_df_es_sub_escutoff %>% subset(dmr == 27) %>% pull(Name),] %>% 
  colMeans()

# dmr 27 effect size
combp_anno_df_es_sub_escutoff %>% 
  subset(dmr==27) %>% 
  pull(effect_size) # lower DNAm

# MANCOVA
# subset dmr 27 cpgs
covariates_geno_ctpc_tech_cc_dmr_cpgs <- 
  cbind(covariates_geno_ctpc_tech_cc, 
        t(cb_betas_geno_cc_clean[combp_anno_df_es_sub_escutoff %>%
                                   subset(dmr == 27) %>%
                                   pull(Name),]))

# wheeze
dmr27_mancova_wheeze <- manova(cbind(cg10200291, cg18710053) ~ 
                                 any_wheeze_y1 + sex + gestational_age + 
                                 prenatal_maternal_smoke + maternal_education_length + 
                                 Comp.1 + Comp.2 + Comp.3 + Comp.4 +
                                 genotyping.PC1 + genotyping.PC2 + genotyping.PC3 + 
                                 sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + sv7 + sv8 + sv9 + sv10 +
                                 sv11 + sv12 + sv13 + sv14 + sv15 + sv16 + sv17, 
                               data = covariates_geno_ctpc_tech_cc_dmr_cpgs)

summary(dmr27_mancova_wheeze, test="Pillai") # any wheeze p = 9.098e-05  


longdf_dmr27 <- pivot_longer(covariates_geno_ctpc_tech_cc_dmr_cpgs %>% 
                               select(cg10200291 , cg18710053, 
                                      sample_id, any_wheeze_y1, no2_prenatal_avg_2019v),
                             cols = -c(sample_id, any_wheeze_y1, no2_prenatal_avg_2019v), 
                             names_to = "cpg", 
                             values_to = "dnam") %>%
  mutate(cpg = factor(cpg, levels = c("cg10200291", "cg18710053"))) %>%
  na.omit() %>%
  mutate(no2_colour = ifelse(no2_prenatal_avg_2019v < 7.32, "first",
                             ifelse(no2_prenatal_avg_2019v >=7.32 & no2_prenatal_avg_2019v < 12.01 , "second", ifelse(no2_prenatal_avg_2019v >= 12.01  & no2_prenatal_avg_2019v < 16.25, "third", "fourth")))) %>%
  mutate(no2_colour = factor(no2_colour, levels = c("first", "second",  "third", "fourth")))

# violin plots
dmr27_wheeze_quantile <- ggplot(longdf_dmr27, 
                                aes(x=cpg, y=dnam, 
                                    group = interaction(cpg, as.factor(any_wheeze_y1)), 
                                    shape = as.factor(any_wheeze_y1),
                                    color = as.factor(no2_colour),
                                    fill = as.factor(any_wheeze_y1))) +
  scale_shape_manual(values = c(20, 17), labels = c("No", "Yes"), name = "Any wheeze age one") +
  scale_color_manual( values = c("#87a8e8", "#4484fc", "#254A90", "#10203d")) +
  scale_fill_manual(values = c("white", "grey"), 
                    name = "Any wheeze age one",
                    labels = c("No", "Yes")) +
  geom_violin(draw_quantiles = c(0.5), trim = T, alpha =0.6) +
  ggbeeswarm::geom_beeswarm(dodge.width=0.9, cex = 1.6, size = 0.5, groupOnX = T) +
  theme_bw() +
  scale_x_discrete(labels = c("cg10200291", 
                              "cg18710053"),
                   name = element_blank()) +
  scale_y_continuous(name = "DNA methylation (%)") +
  theme(#legend.position = "none",
    legend.direction="horizontal",
    axis.text = element_text(size =9),
    legend.text = element_text(size = 9),
    panel.grid.major.x = element_blank())

ggsave(plot = dmr27_wheeze_quantile,
       filename  = here("figures",
                        "linear_regression",
                        "prenatal",
                        "2022-11-22_no2_cb_dmr27_wheeze_quantile_legend.png"), 
       width = 12, height = 5, units = "cm")

# atopy
dmr27_mancova_atopy <- manova(cbind(cg10200291, cg18710053) ~ 
                                clinician_atopy_dx_y1 + sex + gestational_age + 
                                prenatal_maternal_smoke + maternal_education_length + 
                                Comp.1 + Comp.2 + Comp.3 + Comp.4 +
                                genotyping.PC1 + genotyping.PC2 + genotyping.PC3 + 
                                sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + sv7 + sv8 + sv9 + sv10 +
                                sv11 + sv12 + sv13 + sv14 + sv15 + sv16 + sv17, 
                              data = covariates_geno_ctpc_tech_cc_dmr_cpgs)

summary(dmr27_mancova_atopy, test="Pillai") # atopy p = 0.4054433 
```

"CHARM-style" plots of DMRs
```{r charm_style_plots}

# subset out dmr 1 cpgs
covariates_geno_ctpc_tech_cc_dmr_cpgs <- 
  cbind(covariates_geno_ctpc_tech_cc, 
        t(cb_betas_geno_cc_clean[combp_anno_df_es_sub_escutoff %>%
                                   subset(dmr == 1) %>%
                                   pull(Name),]))

# rename columns with numbers
colnames(covariates_geno_ctpc_tech_cc_dmr_cpgs)[197:242] <-
  combp_anno_df_es_sub_escutoff %>%
  subset(dmr == 1) %>%
  pull(pos)

# pivot to long
longdf_dmr1 <- 
  pivot_longer(covariates_geno_ctpc_tech_cc_dmr_cpgs %>% 
                 dplyr::select("27184441", "27184264", "27183369", "27184667", "27183686", 
                               "27184461", "27183196", "27183794", "27183591", "27183950", "27184521", 
                               "27184737", "27183375", "27184853", "27184316", "27184450", "27184059", 
                               "27183274", "27184109", "27184030", "27183436", "27183973", "27184712", 
                               "27184176", "27183701", "27183946", "27184077", "27184375", "27184159", 
                               "27184438", "27183643", "27184094", "27184271", "27183401", "27183806", 
                               "27184167", "27183816", "27183990", "27183133", "27184125", "27183694", 
                               "27184188", "27184065", "27183262", "27184369", "27184821",
                               sample_id, 
                               no2_prenatal_avg_2019v),
               cols = -c(sample_id, 
                         no2_prenatal_avg_2019v), 
               names_to = "cpg", 
               values_to = "dnam") %>%
  #mutate(cpg = factor(cpg, levels = c("cg09594291", "cg02749105", "cg24052338"))) %>%
  mutate(no2_colour = ifelse(no2_prenatal_avg_2019v < 7.32, "first",
                             ifelse(no2_prenatal_avg_2019v >=7.32 & no2_prenatal_avg_2019v < 12.01 , "second", ifelse(no2_prenatal_avg_2019v >= 12.01  & no2_prenatal_avg_2019v < 16.25, "third", "fourth")))) %>%
  mutate(no2_colour = factor(no2_colour, levels = c("first", "second",  "third", "fourth")))

# create charm-like visualization
dmr1_charm <- 
  ggplot(longdf_dmr1 %>% 
           subset(no2_colour %in% c("first", "fourth")) %>%
           group_by(cpg, no2_colour) %>%
           summarize(mean_dnam = mean(dnam)), 
         aes(x=as.numeric(cpg), y=mean_dnam, col = no2_colour)) +
  scale_color_manual(values = c("#254A90","red"), 
                     labels = c("First", "Third"),
                     name = "Prenatal NO2 quantile") +
  geom_line() + 
  geom_point(longdf_dmr1 %>% 
               subset(no2_colour %in% c("first", "fourth")), 
             mapping = aes(x=as.numeric(cpg), y=dnam, col = no2_colour),
             size = 0.25, alpha = 0.8) +
  theme_bw() +
  scale_x_continuous(name = "Genomic position (Chr2)") +
  scale_y_continuous(name = "DNA methylation (%)") +
  theme(axis.text = element_text(size = 9, family = "sans"),
        axis.title = element_text(size = 9, family = "sans"),
        panel.grid = element_blank(),
        legend.position = "none",
        panel.background = element_rect(fill = '#D3D3D3'))

ggsave(plot = dmr1_charm,
       filename = here("figures",
                       "linear_regression",
                       "prenatal",
                       "2023-01-03_dmr1_charm.png"),
       height = 6, width = 12, units = "cm")

# create genomic region visualization 
dmr1_from <- combp_anno_df_es_sub_escutoff %>%
  subset(dmr == 1) %>%
  pull(pos) %>%
  min()
dmr1_to <- combp_anno_df_es_sub_escutoff %>%
  subset(dmr == 1) %>%
  pull(pos) %>%
  max()
dmr1_refgenes <- UcscTrack(genome = "hg19", chromosome = "chr7", 
                           track = "NCBI RefSeq",
                           table = "refGene", 
                           from = dmr1_from, to = dmr1_to,
                           trackType = "GeneRegionTrack", 
                           rstarts = "exonStarts", rends = "exonEnds", 
                           gene = "name", symbol = "name", 
                           transcript = "name", strand = "strand", 
                           fill = "#254A90", name = "NCBI RefGene")

# add names
dmr1_ranges <- ranges(dmr1_refgenes)

# gene refseq gene symbiks abd add to annotation 
mcols(dmr1_ranges)$symbol <- mapIds(org.Hs.eg.db, 
                                    gsub("\\.[1-9]$", "", mcols(dmr1_ranges)$symbol),
                                    "SYMBOL","REFSEQ")
ranges(dmr1_refgenes) <- dmr1_ranges


# get regulatory info from ucsc
# gm12878 = b cell line
# hep g2 = epithelial like cell line 
# hu-vec = human umbilical cord vein 
# k562 = lymphoblasyt
# nhkf = lung fibroblasts
dmr1_chromHmmGm12878 <- UcscTrack(genome = "hg19", chromosome = "chr7", 
                                  track = "Broad ChromHMM",
                                  table = "wgEncodeBroadHmmGm12878HMM",
                                  trackType = "AnnotationTrack", 
                                  from = 27146628, 
                                  to  =  27195547,
                                  start = "chromStart", end = "chromEnd", 
                                  id = "name", feature = "score", shape = "box", 
                                  stacking = "dense", fill = "itemRgb",
                                  name = "GM12878")

# colour according to hmm table 
dmr1_chromHmmGm12878@dp@pars$fill <- recode(dmr1_chromHmmGm12878@dp@pars$fill, 
                                            "245,245,245" = "#f5f5f5",
                                            "255,105,105" = "#ff6969",
                                            "153,255,102" = "#99ff66",
                                            "255,252,4" = "#fffc04",
                                            "127,127,127" = "#7f7f7f",
                                            "10,190,254" = "#0abefe",
                                            "207,11,198" = "#cf0bc6")

dmr1_chromHmmGmNhlf <- UcscTrack(genome = "hg19", chromosome = "chr7",
                                 track = "Broad ChromHMM",
                                 table = "wgEncodeBroadHmmNhlfHMM",
                                 trackType = "AnnotationTrack",
                                 from = 27146628,
                                 to  =  27195547,
                                 start = "chromStart", end = "chromEnd",
                                 id = "name", feature = "score", shape = "box",
                                 stacking = "dense", fill = "itemRgb",
                                 name = "NHLF")

dmr1_chromHmmGmNhlf@dp@pars$fill <- recode(dmr1_chromHmmGmNhlf@dp@pars$fill, 
                                           "250,202,0" = "#faca00",
                                           "255,0,0" = "#ff0000",
                                           "255,105,105" = "#ff6969",
                                           "255,252,4" = "#fffc04",
                                           "127,127,127" = "#7f7f7f",
                                           "153,255,102" = "#99ff66")

dmr1_chromHmmH1hesc <- UcscTrack(genome = "hg19", chromosome = "chr7", 
                                 track = "Broad ChromHMM",
                                 table = "wgEncodeBroadHmmH1hescHMM",
                                 trackType = "AnnotationTrack", 
                                 from = 27146628, 
                                 to  =  27195547,
                                 start = "chromStart", end = "chromEnd", 
                                 id = "name", feature = "score", shape = "box", 
                                 stacking = "dense", fill = "itemRgb",
                                 name = "HESC")

dmr1_chromHmmH1hesc@dp@pars$fill <- recode(dmr1_chromHmmH1hesc@dp@pars$fill,
                                           "127,127,127" = "#7f7f7f",
                                           "245,245,245" = "#f5f5f5",
                                           "10,190,254"  = "#0abefe",
                                           "207,11,198" = "#cf0bc6")


axTrack <- GenomeAxisTrack()

# check colours to be included
unique(c(dmr1_chromHmmGm12878@dp@pars$fill, 
         dmr1_chromHmmGmNhlf@dp@pars$fill, 
         dmr1_chromHmmH1hesc@dp@pars$fill))


# highlight track for DMR
dmr1_ht <- HighlightTrack(trackList = list(dmr1_refgenes, 
                                           dmr1_chromHmmGm12878, 
                                           dmr1_chromHmmH1hesc,
                                           dmr1_chromHmmGmNhlf,
                                           axTrack),
                          start = dmr1_from,
                          end = dmr1_to, 
                          chromosome = 7, fill = "lightgrey", col = "lightgrey")

png(here("figures",
         "linear_regression",
         "prenatal",
         "2023-01-04_dmr1_gviz.png"),
    height = 6, width = 10.5, units = "cm", res = 300)
plotTracks(list(dmr1_ht),  
           transcriptAnnotation = "symbol",
           geneAnnotation = "gene",
           showTitle = F)
dev.off()


# DMR 2
covariates_geno_ctpc_tech_cc_dmr_cpgs <- 
  cbind(covariates_geno_ctpc_tech_cc, 
        t(cb_betas_geno_cc_clean[combp_anno_df_es_sub_escutoff %>%
                                   subset(dmr == 2) %>%
                                   pull(Name),]))

# rename columns with numbers
colnames(covariates_geno_ctpc_tech_cc_dmr_cpgs)[197:206] <-
  combp_anno_df_es_sub_escutoff %>%
  subset(dmr == 2) %>%
  pull(pos)

# pivot to long
longdf_dmr2 <- 
  pivot_longer(covariates_geno_ctpc_tech_cc_dmr_cpgs %>% 
                 dplyr::select("27187502", "27187372", "27187102", "27187269", "27187670", 
                               "27187691", "27187374", "27187560", "27187556", "27187553",
                               sample_id, 
                               no2_prenatal_avg_2019v),
               cols = -c(sample_id, 
                         no2_prenatal_avg_2019v), 
               names_to = "cpg", 
               values_to = "dnam") %>%
  #mutate(cpg = factor(cpg, levels = c("cg09594291", "cg02749105", "cg24052338"))) %>%
  mutate(no2_colour = ifelse(no2_prenatal_avg_2019v < 7.32, "first",
                             ifelse(no2_prenatal_avg_2019v >=7.32 & no2_prenatal_avg_2019v < 12.01 , "second", ifelse(no2_prenatal_avg_2019v >= 12.01  & no2_prenatal_avg_2019v < 16.25, "third", "fourth")))) %>%
  mutate(no2_colour = factor(no2_colour, levels = c("first", "second",  "third", "fourth")))

# create charm-like visualization
dmr2_charm <- 
  ggplot(longdf_dmr2 %>% 
           subset(no2_colour %in% c("first", "fourth")) %>%
           group_by(cpg, no2_colour) %>%
           summarize(mean_dnam = mean(dnam)), 
         aes(x=as.numeric(cpg), y=mean_dnam, col = no2_colour)) +
  scale_color_manual(values = c("#254A90","red"), 
                     labels = c("First", "Third"),
                     name = "Prenatal NO2 quantile") +
  geom_line() + 
  geom_point(longdf_dmr2 %>% 
               subset(no2_colour %in% c("first", "fourth")), 
             mapping = aes(x=as.numeric(cpg), y=dnam, col = no2_colour),
             size = 0.25, alpha = 0.8) +
  theme_bw() +
  scale_x_continuous(name = "Genomic position (Chr7)", breaks = seq(27187200, 27187600,by=200)) +
  scale_y_continuous(name = "DNA methylation (%)") +
  theme(axis.text = element_text(size = 9, family = "sans"),
        axis.title = element_text(size = 9, family = "sans"),
        panel.grid = element_blank(),
        legend.position = "none",
        panel.background = element_rect(fill = '#D3D3D3'))

ggsave(plot = dmr2_charm,
       filename = here("figures",
                       "linear_regression",
                       "prenatal",
                       "2023-01-04_dmr2_charm.png"),
       height = 6, width = 12, units = "cm")

# create genomic region visualization 
dmr2_from <- combp_anno_df_es_sub_escutoff %>%
  subset(dmr == 2) %>%
  pull(pos) %>% 
  min()
dmr2_to <- combp_anno_df_es_sub_escutoff %>%
  subset(dmr == 2) %>%
  pull(pos) %>% 
  max()

dmr2_refgenes <- UcscTrack(genome = "hg19", chromosome = "chr7", 
                           track = "NCBI RefSeq", 
                           table = "refGene",
                           from = dmr2_from, to = dmr2_to,
                           trackType = "GeneRegionTrack", 
                           rstarts = "exonStarts", rends = "exonEnds", 
                           gene = "name", symbol = "name", 
                           transcript = "name", strand = "strand", 
                           fill = "#254A90", name = "UCSC refGene")

# add names
dmr2_ranges <- ranges(dmr2_refgenes)

# gene refseq gene symbiks abd add to annotation 
mcols(dmr2_ranges)$symbol <- mapIds(org.Hs.eg.db, 
                                    gsub("\\.[1-9]$", "", mcols(dmr2_ranges)$symbol),
                                    "SYMBOL","REFSEQ")
ranges(dmr2_refgenes) <- dmr2_ranges

# get regulatory info from ucsc
dmr2_chromHmmGm12878 <- UcscTrack(genome = "hg19", chromosome = "chr7", 
                                  track = "Broad ChromHMM",
                                  table = "wgEncodeBroadHmmGm12878HMM",
                                  trackType = "AnnotationTrack", 
                                  from = 27146628, 
                                  to  =  27195547,
                                  start = "chromStart", end = "chromEnd", 
                                  id = "name", feature = "score", shape = "box", 
                                  stacking = "dense", fill = "itemRgb",
                                  name = "GM12878")

# colour according to hmm table 
dmr2_chromHmmGm12878@dp@pars$fill <- recode(dmr2_chromHmmGm12878@dp@pars$fill, 
                                            "245,245,245" = "#f5f5f5",
                                            "255,105,105" = "#ff6969",
                                            "153,255,102" = "#99ff66",
                                            "255,252,4" = "#fffc04",
                                            "127,127,127" = "#7f7f7f",
                                            "10,190,254" = "#0abefe",
                                            "207,11,198" = "#cf0bc6",
                                            "250,202,0" = "#faca00")

dmr2_chromHmmGmNhlf <- UcscTrack(genome = "hg19", chromosome = "chr7",
                                 track = "Broad ChromHMM",
                                 table = "wgEncodeBroadHmmNhlfHMM",
                                 trackType = "AnnotationTrack",
                                 from = 27146628,
                                 to  =  27195547,
                                 start = "chromStart", end = "chromEnd",
                                 id = "name", feature = "score", shape = "box",
                                 stacking = "dense", fill = "itemRgb",
                                 name = "NHLF")

dmr2_chromHmmGmNhlf@dp@pars$fill <- recode(dmr2_chromHmmGmNhlf@dp@pars$fill, 
                                           "250,202,0" = "#faca00",
                                           "255,0,0" = "#ff0000",
                                           "255,105,105" = "#ff6969",
                                           "255,252,4" = "#fffc04",
                                           "127,127,127" = "#7f7f7f",
                                           "153,255,102" = "#99ff66")

dmr2_chromHmmH1hesc <- UcscTrack(genome = "hg19", chromosome = "chr7", 
                                 track = "Broad ChromHMM",
                                 table = "wgEncodeBroadHmmH1hescHMM",
                                 trackType = "AnnotationTrack", 
                                 from = 27146628, 
                                 to  =  27195547,
                                 start = "chromStart", end = "chromEnd", 
                                 id = "name", feature = "score", shape = "box", 
                                 stacking = "dense", fill = "itemRgb",
                                 name = "K562")

dmr2_chromHmmH1hesc@dp@pars$fill <- recode(dmr2_chromHmmH1hesc@dp@pars$fill,
                                           "127,127,127" = "#7f7f7f",
                                           "245,245,245" = "#f5f5f5",
                                           "10,190,254"  = "#0abefe",
                                           "207,11,198" = "#cf0bc6",
                                           "250,202,0" = "#faca00")

# check colours to be included
unique(c(dmr2_chromHmmGm12878@dp@pars$fill, 
         dmr2_chromHmmGmNhlf@dp@pars$fill, 
         dmr2_chromHmmH1hesc@dp@pars$fill))

# highlight track for DMR
dmr2_ht <- HighlightTrack(trackList = list(dmr2_refgenes, 
                                           dmr2_chromHmmGm12878, 
                                           dmr2_chromHmmH1hesc,
                                           dmr2_chromHmmGmNhlf,
                                           axTrack),
                          start =dmr2_from,
                          end = dmr2_to, 
                          chromosome = 7, fill = "lightgrey", col = "lightgrey")

png(here("figures",
         "linear_regression",
         "prenatal",
         "2023-01-04_dmr2_gviz.png"),
    height = 6, width = 10.5, units = "cm", res = 300)
plotTracks(list(dmr2_ht),  
           transcriptAnnotation = "symbol",
           geneAnnotation = "gene",
           showTitle = F)
dev.off()


# DMR 3
covariates_geno_ctpc_tech_cc_dmr_cpgs <- 
  cbind(covariates_geno_ctpc_tech_cc, 
        t(cb_betas_geno_cc_clean[combp_anno_df_es_sub_escutoff %>%
                                   subset(dmr == 3) %>%
                                   pull(Name),]))

# rename columns with numbers
colnames(covariates_geno_ctpc_tech_cc_dmr_cpgs)[197:206] <-
  combp_anno_df_es_sub_escutoff %>%
  subset(dmr == 3) %>%
  pull(pos)

# pivot to long
longdf_dmr3 <- 
  pivot_longer(covariates_geno_ctpc_tech_cc_dmr_cpgs %>% 
                 dplyr::select("22132932", "22132959", "22133076", "22133004", 
                               "22132714", "22132678", "22132665", "22132992", 
                               "22132874", "22132926",
                               sample_id, 
                               no2_prenatal_avg_2019v),
               cols = -c(sample_id, 
                         no2_prenatal_avg_2019v), 
               names_to = "cpg", 
               values_to = "dnam") %>%
  #mutate(cpg = factor(cpg, levels = c("cg09594291", "cg02749105", "cg24052338"))) %>%
  mutate(no2_colour = ifelse(no2_prenatal_avg_2019v < 7.32, "first",
                             ifelse(no2_prenatal_avg_2019v >=7.32 & no2_prenatal_avg_2019v < 12.01 , "second", ifelse(no2_prenatal_avg_2019v >= 12.01  & no2_prenatal_avg_2019v < 16.25, "third", "fourth")))) %>%
  mutate(no2_colour = factor(no2_colour, levels = c("first", "second",  "third", "fourth")))

# create charm-like visualization
dmr3_charm <- 
  ggplot(longdf_dmr3 %>% 
           subset(no2_colour %in% c("first", "fourth")) %>%
           group_by(cpg, no2_colour) %>%
           summarize(mean_dnam = mean(dnam)), 
         aes(x=as.numeric(cpg), y=mean_dnam, col = no2_colour)) +
  scale_color_manual(values = c("#254A90","red"), 
                     labels = c("First", "Third"),
                     name = "Prenatal NO2 quantile") +
  geom_line() + 
  geom_point(longdf_dmr3 %>% 
               subset(no2_colour %in% c("first", "fourth")), 
             mapping = aes(x=as.numeric(cpg), y=dnam, col = no2_colour),
             size = 0.25, alpha = 0.8) +
  theme_bw() +
  scale_x_continuous(name = "Genomic position (Chr8)") +
  scale_y_continuous(name = "DNA methylation (%)") +
  theme(axis.text = element_text(size = 9, family = "sans"),
        axis.title = element_text(size = 9, family = "sans"),
        panel.grid = element_blank(),
        legend.position = "none",
        panel.background = element_rect(fill = '#D3D3D3'))

ggsave(plot = dmr3_charm,
       filename = here("figures",
                       "linear_regression",
                       "prenatal",
                       "2023-01-03_dmr3_charm.png"),
       height = 6, width = 12, units = "cm")

# create genomic region visualization 
dmr3_from <- combp_anno_df_es_sub_escutoff %>%
  subset(dmr == 3) %>%
  pull(pos) %>% 
  min()
dmr3_to <- combp_anno_df_es_sub_escutoff %>%
  subset(dmr == 3) %>%
  pull(pos) %>% 
  max()

dmr3_refgenes <- UcscTrack(genome = "hg19", chromosome = "chr8", 
                           track = "NCBI RefSeq", 
                           table = "refGene",
                           from = dmr3_from, to = dmr3_to,
                           trackType = "GeneRegionTrack", 
                           rstarts = "exonStarts", rends = "exonEnds", 
                           gene = "name", symbol = "name", 
                           transcript = "name", strand = "strand", 
                           fill = "#254A90", name = "UCSC refGene")

# add names
dmr3_ranges <- ranges(dmr3_refgenes)

# gene refseq gene symbiks abd add to annotation 
mcols(dmr3_ranges)$symbol <- mapIds(org.Hs.eg.db, 
                                    gsub("\\.[1-9]$", "", mcols(dmr3_ranges)$symbol),
                                    "SYMBOL","REFSEQ")
ranges(dmr3_refgenes) <- dmr3_ranges

# get regulatory info from ucsc
dmr3_chromHmmGm12878 <- UcscTrack(genome = "hg19", chromosome = "chr8", 
                                  track = "Broad ChromHMM",
                                  table = "wgEncodeBroadHmmGm12878HMM",
                                  trackType = "AnnotationTrack", 
                                  from = 22110000, 
                                  to  =  22210000,
                                  start = "chromStart", end = "chromEnd", 
                                  id = "name", feature = "score", shape = "box", 
                                  stacking = "dense", fill = "itemRgb",
                                  name = "GM12878")

# colour according to hmm table 
dmr3_chromHmmGm12878@dp@pars$fill <- recode(dmr3_chromHmmGm12878@dp@pars$fill, 
                                            "245,245,245" = "#f5f5f5",
                                            "255,105,105" = "#ff6969",
                                            "153,255,102" = "#99ff66",
                                            "255,252,4" = "#fffc04",
                                            "127,127,127" = "#7f7f7f",
                                            "10,190,254" = "#0abefe",
                                            "207,11,198" = "#cf0bc6",
                                            "0,176,80" = "#00b050")

dmr3_chromHmmGmNhlf <- UcscTrack(genome = "hg19", chromosome = "chr8",
                                 track = "Broad ChromHMM",
                                 table = "wgEncodeBroadHmmNhlfHMM",
                                 trackType = "AnnotationTrack",
                                 from = 22110000, 
                                 to  =  22210000,
                                 start = "chromStart", end = "chromEnd",
                                 id = "name", feature = "score", shape = "box",
                                 stacking = "dense", fill = "itemRgb",
                                 name = "NHLF")

dmr3_chromHmmGmNhlf@dp@pars$fill <- recode(dmr3_chromHmmGmNhlf@dp@pars$fill, 
                                           "250,202,0" = "#faca00",
                                           "255,0,0" = "#ff0000",
                                           "255,105,105" = "#ff6969",
                                           "245,245,245" = "#f5f5f5",
                                           "255,252,4" = "#fffc04",
                                           "127,127,127" = "#7f7f7f",
                                           "153,255,102" = "#99ff66",
                                           "0,176,80" = "#00b050",
                                           "207,11,198" = "#cf0bc6",
                                           "10,190,254"  = "#0abefe")

dmr3_chromHmmH1hesc <- UcscTrack(genome = "hg19", chromosome = "chr8", 
                                 track = "Broad ChromHMM",
                                 table = "wgEncodeBroadHmmH1hescHMM",
                                 trackType = "AnnotationTrack", 
                                 from = 22110000, 
                                 to  =  22210000,
                                 start = "chromStart", end = "chromEnd", 
                                 id = "name", feature = "score", shape = "box", 
                                 stacking = "dense", fill = "itemRgb",
                                 name = "hesc")

dmr3_chromHmmH1hesc@dp@pars$fill <- recode(dmr3_chromHmmH1hesc@dp@pars$fill,
                                           "127,127,127" = "#7f7f7f",
                                           "245,245,245" = "#f5f5f5",
                                           "10,190,254"  = "#0abefe",
                                           "207,11,198" = "#cf0bc6",
                                           "250,202,0" = "#faca00",
                                           "0,176,80" = "#00b050",
                                           "153,255,102" = "#99ff66",
                                           "255,252,4" = "#fffc04",
                                           "255,105,105" = "#ff6969",)

# highlight track for DMR
dmr3_ht <- HighlightTrack(trackList = list(dmr3_refgenes, 
                                           dmr3_chromHmmGm12878, 
                                           dmr3_chromHmmH1hesc,
                                           dmr3_chromHmmGmNhlf,
                                           axTrack),
                          start = dmr3_from,
                          end = dmr3_to, 
                          chromosome = 8, fill = "lightgrey", col = "lightgrey")

# check colours to be included
unique(c(dmr3_chromHmmGm12878@dp@pars$fill, 
         dmr3_chromHmmGmNhlf@dp@pars$fill, 
         dmr3_chromHmmH1hesc@dp@pars$fill))

png(here("figures",
         "linear_regression",
         "prenatal",
         "2023-01-04_dmr3_gviz.png"),
    height = 6, width = 10.5, units = "cm", res = 300)
plotTracks(list(dmr3_ht),  
           transcriptAnnotation = "symbol",
           geneAnnotation = "gene",
           showTitle = F)
dev.off()


# DMR 4
covariates_geno_ctpc_tech_cc_dmr_cpgs <- 
  cbind(covariates_geno_ctpc_tech_cc, 
        t(cb_betas_geno_cc_clean[combp_anno_df_es_sub_escutoff %>%
                                   subset(dmr == 4) %>%
                                   pull(Name),]))

# rename columns with numbers
colnames(covariates_geno_ctpc_tech_cc_dmr_cpgs)[197:199] <-
  combp_anno_df_es_sub_escutoff %>%
  subset(dmr == 4) %>%
  pull(pos)

# pivot to long
longdf_dmr4 <- 
  pivot_longer(covariates_geno_ctpc_tech_cc_dmr_cpgs %>% 
                 dplyr::select("36666953", "36667233", "36667484",
                               sample_id, 
                               no2_prenatal_avg_2019v),
               cols = -c(sample_id, 
                         no2_prenatal_avg_2019v), 
               names_to = "cpg", 
               values_to = "dnam") %>%
  mutate(no2_colour = ifelse(no2_prenatal_avg_2019v < 7.32, "first",
                             ifelse(no2_prenatal_avg_2019v >=7.32 & no2_prenatal_avg_2019v < 12.01 , "second", ifelse(no2_prenatal_avg_2019v >= 12.01  & no2_prenatal_avg_2019v < 16.25, "third", "fourth")))) %>%
  mutate(no2_colour = factor(no2_colour, levels = c("first", "second",  "third", "fourth")))

# create charm-like visualization
dmr4_charm <- 
  ggplot(longdf_dmr4 %>% 
           subset(no2_colour %in% c("first", "fourth")) %>%
           group_by(cpg, no2_colour) %>%
           summarize(mean_dnam = mean(dnam)), 
         aes(x=as.numeric(cpg), y=mean_dnam, col = no2_colour)) +
  scale_color_manual(values = c("#254A90","red"), 
                     labels = c("First", "Third"),
                     name = "Prenatal NO2 quantile") +
  geom_line() + 
  geom_point(longdf_dmr4 %>% 
               subset(no2_colour %in% c("first", "fourth")), 
             mapping = aes(x=as.numeric(cpg), y=dnam, col = no2_colour),
             size = 0.25, alpha = 0.8) +
  theme_bw() +
  scale_x_continuous(name = "Genomic position (Chr17)", breaks = seq(36667000, 36667400, by = 200)) +
  scale_y_continuous(name = "DNA methylation (%)") +
  theme(axis.text = element_text(size = 9, family = "sans"),
        axis.title = element_text(size = 9, family = "sans"),
        panel.grid = element_blank(),
        legend.position = "none",
        panel.background = element_rect(fill = '#D3D3D3'))

ggsave(plot = dmr4_charm,
       filename = here("figures",
                       "linear_regression",
                       "prenatal",
                       "2023-01-03_dmr4_charm.png"),
       height = 6, width = 12, units = "cm")

# create genomic region visualization 
dmr4_from <- combp_anno_df_es_sub_escutoff %>%
  subset(dmr == 4) %>%
  pull(pos) %>% 
  min()
dmr4_to <- combp_anno_df_es_sub_escutoff %>%
  subset(dmr == 4) %>%
  pull(pos) %>% 
  max()

dmr4_refgenes <- UcscTrack(genome = "hg19", chromosome = "chr17", 
                           track = "NCBI RefSeq", 
                           table = "refGene",
                           from = dmr4_from, to = dmr4_to,
                           trackType = "GeneRegionTrack", 
                           rstarts = "exonStarts", rends = "exonEnds", 
                           gene = "name", symbol = "name", 
                           transcript = "name", strand = "strand", 
                           fill = "#254A90", name = "UCSC refGene")

# add names
dmr4_ranges <- ranges(dmr4_refgenes)

# gene refseq gene symbiks abd add to annotation 
mcols(dmr4_ranges)$symbol <- mapIds(org.Hs.eg.db, 
                                    gsub("\\.[1-9]$", "", mcols(dmr4_ranges)$symbol),
                                    "SYMBOL","REFSEQ")
ranges(dmr4_refgenes) <- dmr4_ranges

# get regulatory info from ucsc
dmr4_chromHmmGm12878 <- UcscTrack(genome = "hg19", chromosome = "chr17", 
                                  track = "Broad ChromHMM",
                                  table = "wgEncodeBroadHmmGm12878HMM",
                                  trackType = "AnnotationTrack", 
                                  from = 36580000, 
                                  to  =  36670000,
                                  start = "chromStart", end = "chromEnd", 
                                  id = "name", feature = "score", shape = "box", 
                                  stacking = "dense", fill = "itemRgb",
                                  name = "GM12878")

# colour according to hmm table 
dmr4_chromHmmGm12878@dp@pars$fill <- recode(dmr4_chromHmmGm12878@dp@pars$fill, 
                                            "245,245,245" = "#f5f5f5",
                                            "255,105,105" = "#ff6969",
                                            "153,255,102" = "#99ff66",
                                            "255,252,4" = "#fffc04",
                                            "127,127,127" = "#7f7f7f",
                                            "10,190,254" = "#0abefe",
                                            "207,11,198" = "#cf0bc6",
                                            "0,176,80" = "#00b050",
                                            "255,0,0" = "#ff0000",
                                            "250,202,0" = "#faca00")

dmr4_chromHmmGmNhlf <- UcscTrack(genome = "hg19", chromosome = "chr17",
                                 track = "Broad ChromHMM",
                                 table = "wgEncodeBroadHmmNhlfHMM",
                                 trackType = "AnnotationTrack",
                                 from = 36580000, 
                                 to  =  36670000,
                                 start = "chromStart", end = "chromEnd",
                                 id = "name", feature = "score", shape = "box",
                                 stacking = "dense", fill = "itemRgb",
                                 name = "NHLF")

dmr4_chromHmmGmNhlf@dp@pars$fill <- recode(dmr4_chromHmmGmNhlf@dp@pars$fill, 
                                           "250,202,0" = "#faca00",
                                           "255,0,0" = "#ff0000",
                                           "255,105,105" = "#ff6969",
                                           "245,245,245" = "#f5f5f5",
                                           "255,252,4" = "#fffc04",
                                           "127,127,127" = "#7f7f7f",
                                           "153,255,102" = "#99ff66",
                                           "0,176,80" = "#00b050",
                                           "207,11,198" = "#cf0bc6",
                                           "10,190,254"  = "#0abefe")

dmr4_chromHmmH1hesc <- UcscTrack(genome = "hg19", chromosome = "chr17", 
                                 track = "Broad ChromHMM",
                                 table = "wgEncodeBroadHmmH1hescHMM",
                                 trackType = "AnnotationTrack", 
                                 from = 36580000, 
                                 to  =  36670000,
                                 start = "chromStart", end = "chromEnd", 
                                 id = "name", feature = "score", shape = "box", 
                                 stacking = "dense", fill = "itemRgb",
                                 name = "hesc")

dmr4_chromHmmH1hesc@dp@pars$fill <- recode(dmr4_chromHmmH1hesc@dp@pars$fill,
                                           "127,127,127" = "#7f7f7f",
                                           "245,245,245" = "#f5f5f5",
                                           "10,190,254"  = "#0abefe",
                                           "207,11,198" = "#cf0bc6",
                                           "250,202,0" = "#faca00",
                                           "0,176,80" = "#00b050",
                                           "255,0,0" = "#ff0000",
                                           "153,255,102" = "#99ff66",
                                           "255,252,4" = "#fffc04",
                                           "255,105,105" = "#ff6969",)

# check colours to be included
unique(c(dmr4_chromHmmGm12878@dp@pars$fill, 
         dmr4_chromHmmGmNhlf@dp@pars$fill, 
         dmr4_chromHmmH1hesc@dp@pars$fill))

# highlight track for DMR
dmr4_ht <- HighlightTrack(trackList = list(dmr4_refgenes, 
                                           dmr4_chromHmmGm12878, 
                                           dmr4_chromHmmH1hesc,
                                           dmr4_chromHmmGmNhlf,
                                           axTrack),
                          start = dmr4_from,
                          end = dmr4_to, 
                          chromosome = 17, fill = "lightgrey", col = "lightgrey")

png(here("figures",
         "linear_regression",
         "prenatal",
         "2023-01-04_dmr4_gviz.png"),
    height = 6, width = 10.5, units = "cm", res = 300)
plotTracks(list(dmr4_ht),  
           transcriptAnnotation = "symbol",
           geneAnnotation = "gene",
           showTitle = F)
dev.off()

# DMR 5
covariates_geno_ctpc_tech_cc_dmr_cpgs <- 
  cbind(covariates_geno_ctpc_tech_cc, 
        t(cb_betas_geno_cc_clean[combp_anno_df_es_sub_escutoff %>%
                                   subset(dmr == 5) %>%
                                   pull(Name),]))

# rename columns with numbers
colnames(covariates_geno_ctpc_tech_cc_dmr_cpgs)[197:204] <-
  combp_anno_df_es_sub_escutoff %>%
  subset(dmr == 5) %>%
  pull(pos)

# pivot to long
longdf_dmr5 <- 
  pivot_longer(covariates_geno_ctpc_tech_cc_dmr_cpgs %>% 
                 dplyr::select("150326174", "150326497", "150326312", 
                               "150326069", "150325954", "150326193", 
                               "150326213", "150326190",
                               sample_id, 
                               no2_prenatal_avg_2019v),
               cols = -c(sample_id, 
                         no2_prenatal_avg_2019v), 
               names_to = "cpg", 
               values_to = "dnam") %>%
  mutate(no2_colour = ifelse(no2_prenatal_avg_2019v < 7.32, "first",
                             ifelse(no2_prenatal_avg_2019v >=7.32 & no2_prenatal_avg_2019v < 12.01 , "second", ifelse(no2_prenatal_avg_2019v >= 12.01  & no2_prenatal_avg_2019v < 16.25, "third", "fourth")))) %>%
  mutate(no2_colour = factor(no2_colour, levels = c("first", "second",  "third", "fourth")))

# create charm-like visualization
dmr5_charm <- 
  ggplot(longdf_dmr5 %>% 
           subset(no2_colour %in% c("first", "fourth")) %>%
           group_by(cpg, no2_colour) %>%
           summarize(mean_dnam = mean(dnam)), 
         aes(x=as.numeric(cpg), y=mean_dnam, col = no2_colour)) +
  scale_color_manual(values = c("#254A90","red"), 
                     labels = c("First", "Third"),
                     name = "Prenatal NO2 quantile") +
  geom_line() + 
  geom_point(longdf_dmr5 %>% 
               subset(no2_colour %in% c("first", "fourth")), 
             mapping = aes(x=as.numeric(cpg), y=dnam, col = no2_colour),
             size = 0.25, alpha = 0.8) +
  theme_bw() +
  scale_x_continuous(name = "Genomic position (Chr5)", breaks = seq(150326050, 150326450, by = 200)) +
  scale_y_continuous(name = "DNA methylation (%)") +
  theme(axis.text = element_text(size = 9, family = "sans"),
        axis.title = element_text(size = 9, family = "sans"),
        panel.grid = element_blank(),
        legend.position = "none",
        panel.background = element_rect(fill = '#D3D3D3'))

ggsave(plot = dmr5_charm,
       filename = here("figures",
                       "linear_regression",
                       "prenatal",
                       "2023-01-03_dmr5_charm.png"),
       height = 6, width = 12, units = "cm")

# create genomic region visualization 
dmr5_from <- combp_anno_df_es_sub_escutoff %>%
  subset(dmr == 5) %>%
  pull(pos) %>% 
  min()
dmr5_to <- combp_anno_df_es_sub_escutoff %>%
  subset(dmr == 5) %>%
  pull(pos) %>% 
  max()

dmr5_refgenes <- UcscTrack(genome = "hg19", chromosome = "chr5", 
                           track = "NCBI RefSeq", 
                           table = "refGene",
                           from = dmr5_from, to = dmr5_to,
                           trackType = "GeneRegionTrack", 
                           rstarts = "exonStarts", rends = "exonEnds", 
                           gene = "name", symbol = "name", 
                           transcript = "name", strand = "strand", 
                           fill = "#254A90", name = "UCSC refGene")

# add names
dmr5_ranges <- ranges(dmr5_refgenes)

# gene refseq gene symbiks abd add to annotation 
mcols(dmr5_ranges)$symbol <- mapIds(org.Hs.eg.db, 
                                    gsub("\\.[1-9]$", "", mcols(dmr5_ranges)$symbol), 
                                    "SYMBOL","REFSEQ")
ranges(dmr5_refgenes) <- dmr5_ranges

# get regulatory info from ucsc
dmr5_chromHmmGm12878 <- UcscTrack(genome = "hg19", chromosome = "chr5", 
                                  track = "Broad ChromHMM",
                                  table = "wgEncodeBroadHmmGm12878HMM",
                                  trackType = "AnnotationTrack", 
                                  from = dmr5_from, 
                                  to  =  dmr5_to,
                                  start = "chromStart", end = "chromEnd", 
                                  id = "name", feature = "score", shape = "box", 
                                  stacking = "dense", fill = "itemRgb",
                                  name = "GM12878")

# colour according to hmm table 
dmr5_chromHmmGm12878@dp@pars$fill <- recode(dmr5_chromHmmGm12878@dp@pars$fill, 
                                            "245,245,245" = "#f5f5f5",
                                            "255,105,105" = "#ff6969",
                                            "153,255,102" = "#99ff66",
                                            "255,252,4" = "#fffc04",
                                            "127,127,127" = "#7f7f7f",
                                            "10,190,254" = "#0abefe",
                                            "207,11,198" = "#cf0bc6",
                                            "0,176,80" = "#00b050",
                                            "255,0,0" = "#ff0000",
                                            "250,202,0" = "#faca00")

dmr5_chromHmmGmNhlf <- UcscTrack(genome = "hg19", chromosome = "chr5",
                                 track = "Broad ChromHMM",
                                 table = "wgEncodeBroadHmmNhlfHMM",
                                 trackType = "AnnotationTrack",
                                 from = 150290000,
                          to = 150360000, 
                                 start = "chromStart", end = "chromEnd",
                                 id = "name", feature = "score", shape = "box",
                                 stacking = "dense", fill = "itemRgb",
                                 name = "NHLF")

dmr5_chromHmmGmNhlf@dp@pars$fill <- recode(dmr5_chromHmmGmNhlf@dp@pars$fill, 
                                           "250,202,0" = "#faca00",
                                           "255,0,0" = "#ff0000",
                                           "255,105,105" = "#ff6969",
                                           "245,245,245" = "#f5f5f5",
                                           "255,252,4" = "#fffc04",
                                           "127,127,127" = "#7f7f7f",
                                           "153,255,102" = "#99ff66",
                                           "0,176,80" = "#00b050",
                                           "207,11,198" = "#cf0bc6",
                                           "10,190,254"  = "#0abefe")

dmr5_chromHmmH1hesc <- UcscTrack(genome = "hg19", chromosome = "chr5", 
                                 track = "Broad ChromHMM",
                                 table = "wgEncodeBroadHmmH1hescHMM",
                                 trackType = "AnnotationTrack", 
                                 from = dmr5_from, 
                                 to  =  dmr5_to,
                                 start = "chromStart", end = "chromEnd", 
                                 id = "name", feature = "score", shape = "box", 
                                 stacking = "dense", fill = "itemRgb",
                                 name = "hesc")

dmr5_chromHmmH1hesc@dp@pars$fill <- recode(dmr5_chromHmmH1hesc@dp@pars$fill,
                                           "127,127,127" = "#7f7f7f",
                                           "245,245,245" = "#f5f5f5",
                                           "10,190,254"  = "#0abefe",
                                           "207,11,198" = "#cf0bc6",
                                           "250,202,0" = "#faca00",
                                           "0,176,80" = "#00b050",
                                           "255,0,0" = "#ff0000",
                                           "153,255,102" = "#99ff66",
                                           "255,252,4" = "#fffc04",
                                           "255,105,105" = "#ff6969",)

# highlight track for DMR
dmr5_ht <- HighlightTrack(trackList = list(dmr5_refgenes, 
                                           dmr5_chromHmmGm12878, 
                                           dmr5_chromHmmH1hesc,
                                           dmr5_chromHmmGmNhlf,
                                           axTrack),
                          start = dmr5_from,
                          end = dmr5_to, 
                          chromosome = 5, fill = "lightgrey", col = "lightgrey")

# check colours to be included
unique(c(dmr5_chromHmmGm12878@dp@pars$fill, 
         dmr5_chromHmmGmNhlf@dp@pars$fill, 
         dmr5_chromHmmH1hesc@dp@pars$fill))


png(here("figures",
         "linear_regression",
         "prenatal",
         "2023-01-05_dmr5_gviz.png"),
    height = 6, width = 10.5, units = "cm", res = 300)
plotTracks(list(dmr5_ht),  
           transcriptAnnotation = "symbol",
           geneAnnotation = "gene",
           showTitle = F)
dev.off()

# DMR 6
covariates_geno_ctpc_tech_cc_dmr_cpgs <- 
  cbind(covariates_geno_ctpc_tech_cc, 
        t(cb_betas_geno_cc_clean[combp_anno_df_es_sub_escutoff %>%
                                   subset(dmr == 6) %>%
                                   pull(Name),]))

# rename columns with numbers
colnames(covariates_geno_ctpc_tech_cc_dmr_cpgs)[197:199] <-
  combp_anno_df_es_sub_escutoff %>%
  subset(dmr == 6) %>%
  pull(pos)

# pivot to long
longdf_dmr6 <- 
  pivot_longer(covariates_geno_ctpc_tech_cc_dmr_cpgs %>% 
                 dplyr::select("237702580", "237702390", "237702420",
                               sample_id, 
                               no2_prenatal_avg_2019v),
               cols = -c(sample_id, 
                         no2_prenatal_avg_2019v), 
               names_to = "cpg", 
               values_to = "dnam") %>%
  mutate(no2_colour = ifelse(no2_prenatal_avg_2019v < 7.32, "first",
                             ifelse(no2_prenatal_avg_2019v >=7.32 & no2_prenatal_avg_2019v < 12.01 , "second", ifelse(no2_prenatal_avg_2019v >= 12.01  & no2_prenatal_avg_2019v < 16.25, "third", "fourth")))) %>%
  mutate(no2_colour = factor(no2_colour, levels = c("first", "second",  "third", "fourth")))

# create charm-like visualization
dmr6_charm <- 
  ggplot(longdf_dmr6 %>% 
           subset(no2_colour %in% c("first", "fourth")) %>%
           group_by(cpg, no2_colour) %>%
           summarize(mean_dnam = mean(dnam)), 
         aes(x=as.numeric(cpg), y=mean_dnam, col = no2_colour)) +
  scale_color_manual(values = c("#254A90","red"), 
                     labels = c("First", "Third"),
                     name = "Prenatal NO2 quantile") +
  geom_line() + 
  geom_point(longdf_dmr6 %>% 
               subset(no2_colour %in% c("first", "fourth")), 
             mapping = aes(x=as.numeric(cpg), y=dnam, col = no2_colour),
             size = 0.25, alpha = 0.8) +
  theme_bw() +
  scale_x_continuous(name = "Genomic position (Chr2)") +
  scale_y_continuous(name = "DNA methylation (%)") +
  theme(axis.text = element_text(size = 9, family = "sans"),
        axis.title = element_text(size = 9, family = "sans"),
        panel.grid = element_blank(),
        legend.position = "none",
        panel.background = element_rect(fill = '#D3D3D3'))

ggsave(plot = dmr6_charm,
       filename = here("figures",
                       "linear_regression",
                       "prenatal",
                       "2023-01-03_dmr6_charm.png"),
       height = 6, width = 12, units = "cm")


# create genomic region visualization 
dmr6_from <- combp_anno_df_es_sub_escutoff %>%
  subset(dmr == 6) %>%
  pull(pos) %>% 
  min()
dmr6_to <- combp_anno_df_es_sub_escutoff %>%
  subset(dmr == 6) %>%
  pull(pos) %>% 
  max()

dmr6_refgenes <- UcscTrack(genome = "hg19", chromosome = "chr2", 
                           track = "NCBI RefSeq", 
                           table = "refGene",
                           from = dmr6_from, to = dmr6_to,
                           trackType = "GeneRegionTrack", 
                           rstarts = "exonStarts", rends = "exonEnds", 
                           gene = "name", symbol = "name", 
                           transcript = "name", strand = "strand", 
                           fill = "#254A90", name = "UCSC refGene")

# add names
dmr6_ranges <- ranges(dmr6_refgenes)

# gene refseq gene symbiks abd add to annotation 
# mcols(dmr6_ranges)$symbol <- mapIds(org.Hs.eg.db, 
#                                     gsub("\\.[1-9]$", "", mcols(dmr6_ranges)$symbol),
#                                     "SYMBOL","REFSEQ")


# get regulatory info from ucsc
dmr6_chromHmmGm12878 <- UcscTrack(genome = "hg19", chromosome = "chr2", 
                                  track = "Broad ChromHMM",
                                  table = "wgEncodeBroadHmmGm12878HMM",
                                  trackType = "AnnotationTrack", 
                                  from = 237680000, 
                                  to  =  dmr6_to,
                                  start = "chromStart", end = "chromEnd", 
                                  id = "name", feature = "score", shape = "box", 
                                  stacking = "dense", fill = "itemRgb",
                                  name = "GM12878")

# colour according to hmm table 
dmr6_chromHmmGm12878@dp@pars$fill <- recode(dmr6_chromHmmGm12878@dp@pars$fill, 
                                            "245,245,245" = "#f5f5f5",
                                            "255,105,105" = "#ff6969",
                                            "153,255,102" = "#99ff66",
                                            "255,252,4" = "#fffc04",
                                            "127,127,127" = "#7f7f7f",
                                            "10,190,254" = "#0abefe",
                                            "207,11,198" = "#cf0bc6",
                                            "0,176,80" = "#00b050",
                                            "255,0,0" = "#ff0000",
                                            "250,202,0" = "#faca00")

dmr6_chromHmmGmNhlf <- UcscTrack(genome = "hg19", chromosome = "chr2",
                                 track = "Broad ChromHMM",
                                 table = "wgEncodeBroadHmmNhlfHMM",
                                 trackType = "AnnotationTrack",
                                 from = 237680000, 
                                 to  =  dmr6_to,
                                 start = "chromStart", end = "chromEnd",
                                 id = "name", feature = "score", shape = "box",
                                 stacking = "dense", fill = "itemRgb",
                                 name = "NHLF")

dmr6_chromHmmGmNhlf@dp@pars$fill <- recode(dmr6_chromHmmGmNhlf@dp@pars$fill, 
                                           "250,202,0" = "#faca00",
                                           "255,0,0" = "#ff0000",
                                           "255,105,105" = "#ff6969",
                                           "245,245,245" = "#f5f5f5",
                                           "255,252,4" = "#fffc04",
                                           "127,127,127" = "#7f7f7f",
                                           "153,255,102" = "#99ff66",
                                           "0,176,80" = "#00b050",
                                           "207,11,198" = "#cf0bc6",
                                           "10,190,254"  = "#0abefe")

dmr6_chromHmmH1hesc <- UcscTrack(genome = "hg19", chromosome = "chr2", 
                                 track = "Broad ChromHMM",
                                 table = "wgEncodeBroadHmmH1hescHMM",
                                 trackType = "AnnotationTrack", 
                                 from = 237680000, 
                                 to  =  237759580,
                                 start = "chromStart", end = "chromEnd", 
                                 id = "name", feature = "score", shape = "box", 
                                 stacking = "dense", fill = "itemRgb",
                                 name = "hesc")

dmr6_chromHmmH1hesc@dp@pars$fill <- recode(dmr6_chromHmmH1hesc@dp@pars$fill,
                                           "127,127,127" = "#7f7f7f",
                                           "245,245,245" = "#f5f5f5",
                                           "10,190,254"  = "#0abefe",
                                           "207,11,198" = "#cf0bc6",
                                           "250,202,0" = "#faca00",
                                           "0,176,80" = "#00b050",
                                           "255,0,0" = "#ff0000",
                                           "153,255,102" = "#99ff66",
                                           "255,252,4" = "#fffc04",
                                           "255,105,105" = "#ff6969",)

# highlight track for DMR
dmr6_ht <- HighlightTrack(trackList = list(dmr6_refgenes, 
                                           dmr6_chromHmmGm12878, 
                                           dmr6_chromHmmH1hesc,
                                           dmr6_chromHmmGmNhlf,
                                           axTrack),
                          start = dmr6_from,
                          end = dmr6_to, 
                          chromosome = 2, fill = "lightgrey", col = "lightgrey")


# check colours to be included
unique(c(dmr6_chromHmmGm12878@dp@pars$fill, 
         dmr6_chromHmmGmNhlf@dp@pars$fill, 
         dmr6_chromHmmH1hesc@dp@pars$fill))


png(here("figures",
         "linear_regression",
         "prenatal",
         "2023-01-04_dmr6_gviz.png"),
    height = 6, width = 10.5, units = "cm", res = 300)
plotTracks(list(dmr6_ht),  
           transcriptAnnotation = "symbol",
           geneAnnotation = "gene",
           showTitle = F)
dev.off()


# DMR 7
covariates_geno_ctpc_tech_cc_dmr_cpgs <- 
  cbind(covariates_geno_ctpc_tech_cc, 
        t(cb_betas_geno_cc_clean[combp_anno_df_es_sub_escutoff %>%
                                   subset(dmr == 7) %>%
                                   pull(Name),]))

# rename columns with numbers
colnames(covariates_geno_ctpc_tech_cc_dmr_cpgs)[197:199] <-
  combp_anno_df_es_sub_escutoff %>%
  subset(dmr == 7) %>%
  pull(pos)

# pivot to long
longdf_dmr7 <- 
  pivot_longer(covariates_geno_ctpc_tech_cc_dmr_cpgs %>% 
                 dplyr::select("26897182", "26897202", "26897253",
                               sample_id, no2_prenatal_avg_2019v),
               cols = -c(sample_id, no2_prenatal_avg_2019v), 
               names_to = "cpg", 
               values_to = "dnam") %>%
  mutate(no2_colour = ifelse(no2_prenatal_avg_2019v < 7.32, "first",
                             ifelse(no2_prenatal_avg_2019v >=7.32 & 
                                      no2_prenatal_avg_2019v < 12.01 , "second",
                                    ifelse(no2_prenatal_avg_2019v >= 12.01  & 
                                             no2_prenatal_avg_2019v < 16.25, "third", "fourth")))) %>%
  mutate(no2_colour = factor(no2_colour, 
                             levels = c("first", "second","third", "fourth")))

# create charm-like visualization
dmr7_charm <- 
  ggplot(longdf_dmr7 %>% 
           subset(no2_colour %in% c("first", "fourth")) %>%
           group_by(cpg, no2_colour) %>%
           summarize(mean_dnam = mean(dnam)), 
         aes(x=as.numeric(cpg), y=mean_dnam, col = no2_colour)) +
  scale_color_manual(values = c("#254A90","red"), 
                     labels = c("First", "Third"),
                     name = "Prenatal NO2 quantile") +
  geom_line() + 
  geom_point(longdf_dmr7 %>% 
               subset(no2_colour %in% c("first", "fourth")), 
             mapping = aes(x=as.numeric(cpg), y=dnam, col = no2_colour),
             size = 0.25, alpha = 0.8) +
  theme_bw() +
  scale_x_continuous(name = "Genomic position (Chr7)") +
  scale_y_continuous(name = "DNA methylation (%)") +
  theme(axis.text = element_text(size = 9, family = "sans"),
        axis.title = element_text(size = 9, family = "sans"),
        panel.grid = element_blank(),
        legend.position = "none",
        panel.background = element_rect(fill = '#D3D3D3'))

ggsave(plot = dmr7_charm,
       filename = here("figures",
                       "linear_regression",
                       "prenatal",
                       "2023-01-03_dmr7_charm.png"),
       height = 6, width = 12, units = "cm")

# create genomic region visualization 
dmr7_from <- combp_anno_df_es_sub_escutoff %>%
  subset(dmr == 7) %>%
  pull(pos) %>% 
  min()
dmr7_to <- combp_anno_df_es_sub_escutoff %>%
  subset(dmr == 7) %>%
  pull(pos) %>% 
  max()

dmr7_refgenes <- UcscTrack(genome = "hg19", chromosome = "chr7", 
                           track = "NCBI RefSeq", 
                           table = "refGene",
                           from = dmr7_from, to = dmr7_to,
                           trackType = "GeneRegionTrack", 
                           rstarts = "exonStarts", rends = "exonEnds", 
                           gene = "name", symbol = "name", 
                           transcript = "name", strand = "strand", 
                           fill = "#254A90", name = "UCSC refGene")

# add names
dmr7_ranges <- ranges(dmr7_refgenes)

# gene refseq gene symbiks abd add to annotation 
mcols(dmr7_ranges)$symbol <- mapIds(org.Hs.eg.db, 
                                    gsub("\\.[1-9]$", "", mcols(dmr7_ranges)$symbol), 
                                    "SYMBOL","REFSEQ")
ranges(dmr7_refgenes) <- dmr7_ranges

# get regulatory info from ucsc
dmr7_chromHmmGm12878 <- UcscTrack(genome = "hg19", chromosome = "chr7", 
                                  track = "Broad ChromHMM",
                                  table = "wgEncodeBroadHmmGm12878HMM",
                                  trackType = "AnnotationTrack", 
                                  from = 26797182,
                                  to = 26950000,
                                  start = "chromStart", end = "chromEnd", 
                                  id = "name", feature = "score", shape = "box", 
                                  stacking = "dense", fill = "itemRgb",
                                  name = "GM12878")

# colour according to hmm table 
dmr7_chromHmmGm12878@dp@pars$fill <- recode(dmr7_chromHmmGm12878@dp@pars$fill, 
                                            "245,245,245" = "#f5f5f5",
                                            "255,105,105" = "#ff6969",
                                            "153,255,102" = "#99ff66",
                                            "255,252,4" = "#fffc04",
                                            "127,127,127" = "#7f7f7f",
                                            "10,190,254" = "#0abefe",
                                            "207,11,198" = "#cf0bc6",
                                            "0,176,80" = "#00b050",
                                            "255,0,0" = "#ff0000",
                                            "250,202,0" = "#faca00")

dmr7_chromHmmGmNhlf <- UcscTrack(genome = "hg19", chromosome = "chr7",
                                 track = "Broad ChromHMM",
                                 table = "wgEncodeBroadHmmNhlfHMM",
                                 trackType = "AnnotationTrack",
                                 from = 26797182,
                                 to = 26950000,
                                 start = "chromStart", end = "chromEnd",
                                 id = "name", feature = "score", shape = "box",
                                 stacking = "dense", fill = "itemRgb",
                                 name = "NHLF")

dmr7_chromHmmGmNhlf@dp@pars$fill <- recode(dmr7_chromHmmGmNhlf@dp@pars$fill, 
                                           "250,202,0" = "#faca00",
                                           "255,0,0" = "#ff0000",
                                           "255,105,105" = "#ff6969",
                                           "245,245,245" = "#f5f5f5",
                                           "255,252,4" = "#fffc04",
                                           "127,127,127" = "#7f7f7f",
                                           "153,255,102" = "#99ff66",
                                           "0,176,80" = "#00b050",
                                           "207,11,198" = "#cf0bc6",
                                           "10,190,254"  = "#0abefe")

dmr7_chromHmmH1hesc <- UcscTrack(genome = "hg19", chromosome = "chr7", 
                                 track = "Broad ChromHMM",
                                 table = "wgEncodeBroadHmmH1hescHMM",
                                 trackType = "AnnotationTrack", 
                                 from = 26797182,
                                 to = 26950000,
                                 start = "chromStart", end = "chromEnd", 
                                 id = "name", feature = "score", shape = "box", 
                                 stacking = "dense", fill = "itemRgb",
                                 name = "hesc")

dmr7_chromHmmH1hesc@dp@pars$fill <- recode(dmr7_chromHmmH1hesc@dp@pars$fill,
                                           "127,127,127" = "#7f7f7f",
                                           "245,245,245" = "#f5f5f5",
                                           "10,190,254"  = "#0abefe",
                                           "207,11,198" = "#cf0bc6",
                                           "250,202,0" = "#faca00",
                                           "0,176,80" = "#00b050",
                                           "255,0,0" = "#ff0000",
                                           "153,255,102" = "#99ff66",
                                           "255,252,4" = "#fffc04",
                                           "255,105,105" = "#ff6969",)

# highlight track for DMR
dmr7_ht <- HighlightTrack(trackList = list(dmr7_refgenes, 
                                           dmr7_chromHmmGm12878, 
                                           dmr7_chromHmmH1hesc,
                                           dmr7_chromHmmGmNhlf,
                                           axTrack),
                          start = dmr7_from,
                          end = dmr7_to, 
                          chromosome = 7, fill = "lightgrey", col = "lightgrey")

# check colours to be included
unique(c(dmr7_chromHmmGm12878@dp@pars$fill, 
         dmr7_chromHmmGmNhlf@dp@pars$fill, 
         dmr7_chromHmmH1hesc@dp@pars$fill))

png(here("figures",
         "linear_regression",
         "prenatal",
         "2023-01-04_dmr7_gviz.png"),
    height = 6, width = 10.5, units = "cm", res = 300)
plotTracks(list(dmr7_ht),  
           transcriptAnnotation = "symbol",
           geneAnnotation = "gene",
           showTitle = F)
dev.off()


# DMR 8
covariates_geno_ctpc_tech_cc_dmr_cpgs <- 
  cbind(covariates_geno_ctpc_tech_cc, 
        t(cb_betas_geno_cc_clean[combp_anno_df_es_sub_escutoff %>%
                                   subset(dmr == 8) %>%
                                   pull(Name),]))

# rename columns with numbers
colnames(covariates_geno_ctpc_tech_cc_dmr_cpgs)[197:203] <-
  combp_anno_df_es_sub_escutoff %>%
  subset(dmr == 8) %>%
  pull(pos)

# pivot to long
longdf_dmr8 <- 
  pivot_longer(covariates_geno_ctpc_tech_cc_dmr_cpgs %>% 
                 dplyr::select("248100591", "248100585", "248100427", 
                               "248100407", "248100614", "248100345", 
                               "248100600",
                               sample_id, 
                               no2_prenatal_avg_2019v),
               cols = -c(sample_id, no2_prenatal_avg_2019v), 
               names_to = "cpg", 
               values_to = "dnam") %>%
  mutate(no2_colour = ifelse(no2_prenatal_avg_2019v < 7.32, "first",
                             ifelse(no2_prenatal_avg_2019v >=7.32 & 
                                      no2_prenatal_avg_2019v < 12.01 , "second",
                                    ifelse(no2_prenatal_avg_2019v >= 12.01  & 
                                             no2_prenatal_avg_2019v < 16.25, "third", "fourth")))) %>%
  mutate(no2_colour = factor(no2_colour, 
                             levels = c("first", "second",  "third", "fourth")))

# create charm-like visualization
dmr8_charm <- 
  ggplot(longdf_dmr8 %>% 
           subset(no2_colour %in% c("first", "fourth")) %>%
           group_by(cpg, no2_colour) %>%
           summarize(mean_dnam = mean(dnam)), 
         aes(x=as.numeric(cpg), y=mean_dnam, col = no2_colour)) +
  scale_color_manual(values = c("#254A90","red"), 
                     labels = c("First", "Third"),
                     name = "Prenatal NO2 quantile") +
  geom_line() + 
  geom_point(longdf_dmr8 %>% 
               subset(no2_colour %in% c("first", "fourth")), 
             mapping = aes(x=as.numeric(cpg), y=dnam, col = no2_colour),
             size = 0.25, alpha = 0.8) +
  theme_bw() +
  scale_x_continuous(name = "Genomic position (Chr1)") +
  scale_y_continuous(name = "DNA methylation (%)") +
  theme(axis.text = element_text(size = 9, family = "sans"),
        axis.title = element_text(size = 9, family = "sans"),
        panel.grid = element_blank(),
        legend.position = "none",
        panel.background = element_rect(fill = '#D3D3D3'))

ggsave(plot = dmr8_charm,
       filename = here("figures",
                       "linear_regression",
                       "prenatal",
                       "2023-01-03_dmr8_charm.png"),
       height = 6, width = 12, units = "cm")

# create genomic region visualization 
dmr8_from <- combp_anno_df_es_sub_escutoff %>%
  subset(dmr == 8) %>%
  pull(pos) %>% 
  min()
dmr8_to <- combp_anno_df_es_sub_escutoff %>%
  subset(dmr == 8) %>%
  pull(pos) %>% 
  max()

dmr8_refgenes <- UcscTrack(genome = "hg19", chromosome = "chr1", 
                           track = "NCBI RefSeq", 
                           table = "refGene",
                           from = dmr8_from, to = dmr8_to,
                           trackType = "GeneRegionTrack", 
                           rstarts = "exonStarts", rends = "exonEnds", 
                           gene = "name", symbol = "name", 
                           transcript = "name", strand = "strand", 
                           fill = "#254A90", name = "UCSC refGene")

# add names
dmr8_ranges <- ranges(dmr8_refgenes)

# gene refseq gene symbiks abd add to annotation 
mcols(dmr8_ranges)$symbol <- mapIds(org.Hs.eg.db, 
                                    gsub("\\.[1-9]$", "", mcols(dmr8_ranges)$symbol), 
                                    "SYMBOL","REFSEQ")
ranges(dmr8_refgenes) <- dmr8_ranges

# get regulatory info from ucsc
dmr8_chromHmmGm12878 <- UcscTrack(genome = "hg19", chromosome = "chr1", 
                                  track = "Broad ChromHMM",
                                  table = "wgEncodeBroadHmmGm12878HMM",
                                  trackType = "AnnotationTrack", 
                                  from = 248099345, 
                                  to  =  248300000,
                                  start = "chromStart", end = "chromEnd", 
                                  id = "name", feature = "score", shape = "box", 
                                  stacking = "dense", fill = "itemRgb",
                                  name = "GM12878")

# colour according to hmm table 
dmr8_chromHmmGm12878@dp@pars$fill <- recode(dmr8_chromHmmGm12878@dp@pars$fill, 
                                            "245,245,245" = "#f5f5f5",
                                            "255,105,105" = "#ff6969",
                                            "153,255,102" = "#99ff66",
                                            "255,252,4" = "#fffc04",
                                            "127,127,127" = "#7f7f7f",
                                            "10,190,254" = "#0abefe",
                                            "207,11,198" = "#cf0bc6",
                                            "0,176,80" = "#00b050",
                                            "255,0,0" = "#ff0000",
                                            "250,202,0" = "#faca00")

dmr8_chromHmmGmNhlf <- UcscTrack(genome = "hg19", chromosome = "chr1",
                                 track = "Broad ChromHMM",
                                 table = "wgEncodeBroadHmmNhlfHMM",
                                 trackType = "AnnotationTrack",
                                 from = 248099345,
                                 to = 248300000,
                                 start = "chromStart", end = "chromEnd",
                                 id = "name", feature = "score", shape = "box",
                                 stacking = "dense", fill = "itemRgb",
                                 name = "NHLF")

dmr8_chromHmmGmNhlf@dp@pars$fill <- recode(dmr8_chromHmmGmNhlf@dp@pars$fill, 
                                           "250,202,0" = "#faca00",
                                           "255,0,0" = "#ff0000",
                                           "255,105,105" = "#ff6969",
                                           "245,245,245" = "#f5f5f5",
                                           "255,252,4" = "#fffc04",
                                           "10,190,254"  = "#0abefe",
                                           "127,127,127" = "#7f7f7f",
                                           "153,255,102" = "#99ff66",
                                           "0,176,80" = "#00b050",
                                           "207,11,198" = "#cf0bc6",
                                           "10,190,254"  = "#0abefe")

dmr8_chromHmmH1hesc <- UcscTrack(genome = "hg19", chromosome = "chr1", 
                                 track = "Broad ChromHMM",
                                 table = "wgEncodeBroadHmmH1hescHMM",
                                 trackType = "AnnotationTrack", 
                                 from = 248099345,
                                 to = 248300000,
                                 start = "chromStart", end = "chromEnd", 
                                 id = "name", feature = "score", shape = "box", 
                                 stacking = "dense", fill = "itemRgb",
                                 name = "hesc")

dmr8_chromHmmH1hesc@dp@pars$fill <- recode(dmr8_chromHmmH1hesc@dp@pars$fill,
                                           "127,127,127" = "#7f7f7f",
                                           "245,245,245" = "#f5f5f5",
                                           "10,190,254"  = "#0abefe",
                                           "207,11,198" = "#cf0bc6",
                                           "250,202,0" = "#faca00",
                                           "0,176,80" = "#00b050",
                                           "255,0,0" = "#ff0000",
                                           "153,255,102" = "#99ff66",
                                           "255,252,4" = "#fffc04",
                                           "255,105,105" = "#ff6969",)

# highlight track for DMR
dmr8_ht <- HighlightTrack(trackList = list(dmr8_refgenes, 
                                           dmr8_chromHmmGm12878, 
                                           dmr8_chromHmmH1hesc,
                                           dmr8_chromHmmGmNhlf,
                                           axTrack),
                          start = dmr8_from,
                          end = dmr8_to, 
                          chromosome = 1, fill = "lightgrey", col = "lightgrey")


# check colours to be included
unique(c(dmr8_chromHmmGm12878@dp@pars$fill, 
         dmr8_chromHmmGmNhlf@dp@pars$fill, 
         dmr8_chromHmmH1hesc@dp@pars$fill))

png(here("figures",
         "linear_regression",
         "prenatal",
         "2023-01-04_dmr8_gviz.png"),
    height = 6, width = 10.5, units = "cm", res = 300)
plotTracks(list(dmr8_ht),  
           transcriptAnnotation = "symbol",
           geneAnnotation = "gene",
           showTitle = F)
dev.off()


# DMR 9
covariates_geno_ctpc_tech_cc_dmr_cpgs <- 
  cbind(covariates_geno_ctpc_tech_cc, 
        t(cb_betas_geno_cc_clean[combp_anno_df_es_sub_escutoff %>%
                                   subset(dmr == 9) %>%
                                   pull(Name),]))

# rename columns with numbers
colnames(covariates_geno_ctpc_tech_cc_dmr_cpgs)[197:202] <-
  combp_anno_df_es_sub_escutoff %>%
  subset(dmr == 9) %>%
  pull(pos)

# pivot to long
longdf_dmr9 <- 
  pivot_longer(covariates_geno_ctpc_tech_cc_dmr_cpgs %>% 
                 dplyr::select("46682398", "46682319", "46682390", 
                               "46682308", "46682394", "46682413",
                               sample_id, 
                               no2_prenatal_avg_2019v),
               cols = -c(sample_id, no2_prenatal_avg_2019v), 
               names_to = "cpg", 
               values_to = "dnam") %>%
  mutate(no2_colour = ifelse(no2_prenatal_avg_2019v < 7.32, "first",
                             ifelse(no2_prenatal_avg_2019v >=7.32 & 
                                      no2_prenatal_avg_2019v < 12.01 , "second",
                                    ifelse(no2_prenatal_avg_2019v >= 12.01  & 
                                             no2_prenatal_avg_2019v < 16.25, "third", "fourth")))) %>%
  mutate(no2_colour = factor(no2_colour, levels = c("first", "second",  "third", "fourth")))

# create charm-like visualization
dmr9_charm <- 
  ggplot(longdf_dmr9 %>% 
           subset(no2_colour %in% c("first", "fourth")) %>%
           group_by(cpg, no2_colour) %>%
           summarize(mean_dnam = mean(dnam)), 
         aes(x=as.numeric(cpg), y=mean_dnam, col = no2_colour)) +
  scale_color_manual(values = c("#254A90","red"), 
                     labels = c("First", "Third"),
                     name = "Prenatal NO2 quantile") +
  geom_line() + 
  geom_point(longdf_dmr9 %>% 
               subset(no2_colour %in% c("first", "fourth")), 
             mapping = aes(x=as.numeric(cpg), y=dnam, col = no2_colour),
             size = 0.25, alpha = 0.8) +
  theme_bw() +
  scale_x_continuous(name = "Genomic position (Chr17)") +
  scale_y_continuous(name = "DNA methylation (%)") +
  theme(axis.text = element_text(size = 9, family = "sans"),
        axis.title = element_text(size = 9, family = "sans"),
        panel.grid = element_blank(),
        legend.position = "none",
        panel.background = element_rect(fill = '#D3D3D3'))

ggsave(plot = dmr9_charm,
       filename = here("figures",
                       "linear_regression",
                       "prenatal",
                       "2023-01-03_dmr9_charm.png"),
       height = 6, width = 12, units = "cm")

# create genomic region visualization 
dmr9_from <- combp_anno_df_es_sub_escutoff %>%
  subset(dmr == 9) %>%
  pull(pos) %>% 
  min()
dmr9_to <- combp_anno_df_es_sub_escutoff %>%
  subset(dmr == 9) %>%
  pull(pos) %>% 
  max()

dmr9_refgenes <- UcscTrack(genome = "hg19", chromosome = "chr17", 
                           track = "NCBI RefSeq", 
                           table = "refGene",
                           from = dmr9_from, to = dmr9_to,
                           trackType = "GeneRegionTrack", 
                           rstarts = "exonStarts", rends = "exonEnds", 
                           gene = "name", symbol = "name", 
                           transcript = "name", strand = "strand", 
                           fill = "#254A90", name = "UCSC refGene")

# add names
dmr9_ranges <- ranges(dmr9_refgenes)

# gene refseq gene symbiks abd add to annotation 
mcols(dmr9_ranges)$symbol <- mapIds(org.Hs.eg.db, 
                                    gsub("\\.[1-9]$", "", mcols(dmr9_ranges)$symbol), 
                                    "SYMBOL","REFSEQ")
ranges(dmr9_refgenes) <- dmr9_ranges

# get regulatory info from ucsc
dmr9_chromHmmGm12878 <- UcscTrack(genome = "hg19", chromosome = "chr17", 
                                  track = "Broad ChromHMM",
                                  table = "wgEncodeBroadHmmGm12878HMM",
                                  trackType = "AnnotationTrack", 
                                  from = 46665500, 
                                  to  =  dmr9_to,
                                  start = "chromStart", end = "chromEnd", 
                                  id = "name", feature = "score", shape = "box", 
                                  stacking = "dense", fill = "itemRgb",
                                  name = "GM12878")

# colour according to hmm table 
dmr9_chromHmmGm12878@dp@pars$fill <- recode(dmr9_chromHmmGm12878@dp@pars$fill, 
                                            "245,245,245" = "#f5f5f5",
                                            "255,105,105" = "#ff6969",
                                            "153,255,102" = "#99ff66",
                                            "255,252,4" = "#fffc04",
                                            "127,127,127" = "#7f7f7f",
                                            "10,190,254" = "#0abefe",
                                            "207,11,198" = "#cf0bc6",
                                            "0,176,80" = "#00b050",
                                            "255,0,0" = "#ff0000",
                                            "250,202,0" = "#faca00")

dmr9_chromHmmGmNhlf <- UcscTrack(genome = "hg19", chromosome = "chr17",
                                 track = "Broad ChromHMM",
                                 table = "wgEncodeBroadHmmNhlfHMM",
                                 trackType = "AnnotationTrack",
                                 from = 46665500,
                                 to = dmr9_to,
                                 start = "chromStart", end = "chromEnd",
                                 id = "name", feature = "score", shape = "box",
                                 stacking = "dense", fill = "itemRgb",
                                 name = "NHLF")

dmr9_chromHmmGmNhlf@dp@pars$fill <- recode(dmr9_chromHmmGmNhlf@dp@pars$fill, 
                                           "250,202,0" = "#faca00",
                                           "255,0,0" = "#ff0000",
                                           "255,105,105" = "#ff6969",
                                           "245,245,245" = "#f5f5f5",
                                           "255,252,4" = "#fffc04",
                                           "10,190,254"  = "#0abefe",
                                           "127,127,127" = "#7f7f7f",
                                           "153,255,102" = "#99ff66",
                                           "0,176,80" = "#00b050",
                                           "207,11,198" = "#cf0bc6",
                                           "10,190,254"  = "#0abefe")

dmr9_chromHmmH1hesc <- UcscTrack(genome = "hg19", chromosome = "chr17", 
                                 track = "Broad ChromHMM",
                                 table = "wgEncodeBroadHmmH1hescHMM",
                                 trackType = "AnnotationTrack", 
                                 from = 46665500,
                                 to = dmr9_to,
                                 start = "chromStart", end = "chromEnd", 
                                 id = "name", feature = "score", shape = "box", 
                                 stacking = "dense", fill = "itemRgb",
                                 name = "hesc")

dmr9_chromHmmH1hesc@dp@pars$fill <- recode(dmr9_chromHmmH1hesc@dp@pars$fill,
                                           "127,127,127" = "#7f7f7f",
                                           "245,245,245" = "#f5f5f5",
                                           "10,190,254"  = "#0abefe",
                                           "207,11,198" = "#cf0bc6",
                                           "250,202,0" = "#faca00",
                                           "0,176,80" = "#00b050",
                                           "255,0,0" = "#ff0000",
                                           "153,255,102" = "#99ff66",
                                           "255,252,4" = "#fffc04",
                                           "255,105,105" = "#ff6969",)

# highlight track for DMR
dmr9_ht <- HighlightTrack(trackList = list(dmr9_refgenes, 
                                           dmr9_chromHmmGm12878, 
                                           dmr9_chromHmmH1hesc,
                                           dmr9_chromHmmGmNhlf,
                                           axTrack),
                          start = dmr9_from,
                          end = dmr9_to, 
                          chromosome = 17, fill = "lightgrey", col = "lightgrey")


# check colours to be included
unique(c(dmr9_chromHmmGm12878@dp@pars$fill, 
         dmr9_chromHmmGmNhlf@dp@pars$fill, 
         dmr9_chromHmmH1hesc@dp@pars$fill))

png(here("figures",
         "linear_regression",
         "prenatal",
         "2023-01-04_dmr9_gviz.png"),
    height = 6, width = 10.5, units = "cm", res = 300)
plotTracks(list(dmr9_ht),  
           transcriptAnnotation = "symbol",
           geneAnnotation = "gene",
           showTitle = F)
dev.off()


# DMR 10
covariates_geno_ctpc_tech_cc_dmr_cpgs <- 
  cbind(covariates_geno_ctpc_tech_cc, 
        t(cb_betas_geno_cc_clean[combp_anno_df_es_sub_escutoff %>%
                                   subset(dmr == 10) %>%
                                   pull(Name),]))

# rename columns with numbers
colnames(covariates_geno_ctpc_tech_cc_dmr_cpgs)[197:207] <-
  combp_anno_df_es_sub_escutoff %>%
  subset(dmr == 10) %>%
  pull(pos)

# pivot to long
longdf_dmr10 <- 
  pivot_longer(covariates_geno_ctpc_tech_cc_dmr_cpgs %>% 
                 dplyr::select("27170755", "27170880", "27170819", "27170832",
                               "27170554", "27170892", "27170552", "27170717", 
                               "27171051", "27170994", "27170961",
                               sample_id, 
                               no2_prenatal_avg_2019v),
               cols = -c(sample_id, no2_prenatal_avg_2019v), 
               names_to = "cpg", 
               values_to = "dnam") %>%
  mutate(no2_colour = ifelse(no2_prenatal_avg_2019v < 7.32, "first",
                             ifelse(no2_prenatal_avg_2019v >=7.32 & 
                                      no2_prenatal_avg_2019v < 12.01 , "second",
                                    ifelse(no2_prenatal_avg_2019v >= 12.01  & 
                                             no2_prenatal_avg_2019v < 16.25, "third", "fourth")))) %>%
  mutate(no2_colour = factor(no2_colour, levels = c("first", "second",  "third", "fourth")))

# create charm-like visualization
dmr10_charm <- 
  ggplot(longdf_dmr10 %>% 
           subset(no2_colour %in% c("first", "fourth")) %>%
           group_by(cpg, no2_colour) %>%
           summarize(mean_dnam = mean(dnam)), 
         aes(x=as.numeric(cpg), y=mean_dnam, col = no2_colour)) +
  scale_color_manual(values = c("#254A90","red"), 
                     labels = c("First", "Third"),
                     name = "Prenatal NO2 quantile") +
  geom_line() + 
  geom_point(longdf_dmr10 %>% 
               subset(no2_colour %in% c("first", "fourth")), 
             mapping = aes(x=as.numeric(cpg), y=dnam, col = no2_colour),
             size = 0.25, alpha = 0.8) +
  theme_bw() +
  scale_x_continuous(name = "Genomic position (Chr7)") +
  scale_y_continuous(name = "DNA methylation (%)") +
  theme(axis.text = element_text(size = 9, family = "sans"),
        axis.title = element_text(size = 9, family = "sans"),
        panel.grid = element_blank(),
        legend.position = "none",
        panel.background = element_rect(fill = '#D3D3D3'))

ggsave(plot = dmr10_charm,
       filename = here("figures",
                       "linear_regression",
                       "prenatal",
                       "2023-01-03_dmr10_charm.png"),
       height = 6, width = 12, units = "cm")


# create genomic region visualization 
dmr10_from <- combp_anno_df_es_sub_escutoff %>%
  subset(dmr == 10) %>%
  pull(pos) %>% 
  min()
dmr10_to <- combp_anno_df_es_sub_escutoff %>%
  subset(dmr == 10) %>%
  pull(pos) %>% 
  max()

dmr10_refgenes <- UcscTrack(genome = "hg19", chromosome = "chr7", 
                            track = "NCBI RefSeq", 
                            table = "refGene",
                            from = 27168000, to = dmr10_to,
                            trackType = "GeneRegionTrack", 
                            rstarts = "exonStarts", rends = "exonEnds", 
                            gene = "name", symbol = "name", 
                            transcript = "name", strand = "strand", 
                            fill = "#254A90", name = "UCSC refGene")

# add names
dmr10_ranges <- ranges(dmr10_refgenes)

# gene refseq gene symbiks abd add to annotation 
mcols(dmr10_ranges)$symbol <- mapIds(org.Hs.eg.db, 
                                     gsub("\\.[1-9]$", "", mcols(dmr10_ranges)$symbol), 
                                     "SYMBOL","REFSEQ")
ranges(dmr10_refgenes) <- dmr10_ranges

# get regulatory info from ucsc
dmr10_chromHmmGm12878 <- UcscTrack(genome = "hg19", chromosome = "chr7", 
                                   track = "Broad ChromHMM",
                                   table = "wgEncodeBroadHmmGm12878HMM",
                                   trackType = "AnnotationTrack", 
                                   from = 27150552,
                                   to = 27191051,
                                   start = "chromStart", end = "chromEnd", 
                                   id = "name", feature = "score", shape = "box", 
                                   stacking = "dense", fill = "itemRgb",
                                   name = "GM12878")

# colour according to hmm table 
dmr10_chromHmmGm12878@dp@pars$fill <- recode(dmr10_chromHmmGm12878@dp@pars$fill, 
                                             "245,245,245" = "#f5f5f5",
                                             "255,105,105" = "#ff6969",
                                             "153,255,102" = "#99ff66",
                                             "255,252,4" = "#fffc04",
                                             "127,127,127" = "#7f7f7f",
                                             "10,190,254" = "#0abefe",
                                             "207,11,198" = "#cf0bc6",
                                             "0,176,80" = "#00b050",
                                             "255,0,0" = "#ff0000",
                                             "250,202,0" = "#faca00")

dmr10_chromHmmGmNhlf <- UcscTrack(genome = "hg19", chromosome = "chr7",
                                  track = "Broad ChromHMM",
                                  table = "wgEncodeBroadHmmNhlfHMM",
                                  trackType = "AnnotationTrack",
                                  from = 27150552,
                                  to = 27191051,
                                  start = "chromStart", end = "chromEnd",
                                  id = "name", feature = "score", shape = "box",
                                  stacking = "dense", fill = "itemRgb",
                                  name = "NHLF")

dmr10_chromHmmGmNhlf@dp@pars$fill <- recode(dmr10_chromHmmGmNhlf@dp@pars$fill, 
                                            "250,202,0" = "#faca00",
                                            "255,0,0" = "#ff0000",
                                            "255,105,105" = "#ff6969",
                                            "245,245,245" = "#f5f5f5",
                                            "255,252,4" = "#fffc04",
                                            "10,190,254"  = "#0abefe",
                                            "127,127,127" = "#7f7f7f",
                                            "153,255,102" = "#99ff66",
                                            "0,176,80" = "#00b050",
                                            "207,11,198" = "#cf0bc6",
                                            "10,190,254"  = "#0abefe")

dmr10_chromHmmH1hesc <- UcscTrack(genome = "hg19", chromosome = "chr7", 
                                  track = "Broad ChromHMM",
                                  table = "wgEncodeBroadHmmH1hescHMM",
                                  trackType = "AnnotationTrack", 
                                  from = 27150552,
                                  to = 27191051,
                                  start = "chromStart", end = "chromEnd", 
                                  id = "name", feature = "score", shape = "box", 
                                  stacking = "dense", fill = "itemRgb",
                                  name = "hesc")

dmr10_chromHmmH1hesc@dp@pars$fill <- recode(dmr10_chromHmmH1hesc@dp@pars$fill,
                                            "127,127,127" = "#7f7f7f",
                                            "245,245,245" = "#f5f5f5",
                                            "10,190,254"  = "#0abefe",
                                            "207,11,198" = "#cf0bc6",
                                            "250,202,0" = "#faca00",
                                            "0,176,80" = "#00b050",
                                            "255,0,0" = "#ff0000",
                                            "153,255,102" = "#99ff66",
                                            "255,252,4" = "#fffc04",
                                            "255,105,105" = "#ff6969",)

# highlight track for DMR
dmr10_ht <- HighlightTrack(trackList = list(dmr10_refgenes, 
                                            dmr10_chromHmmGm12878, 
                                            dmr10_chromHmmH1hesc,
                                            dmr10_chromHmmGmNhlf,
                                            axTrack),
                           start = dmr10_from,
                           end = dmr10_to, 
                           chromosome = 7, fill = "lightgrey", col = "lightgrey")

# check colours to be included
unique(c(dmr10_chromHmmGm12878@dp@pars$fill, 
         dmr10_chromHmmGmNhlf@dp@pars$fill, 
         dmr10_chromHmmH1hesc@dp@pars$fill))

png(here("figures",
         "linear_regression",
         "prenatal",
         "2023-01-04_dmr10_gviz.png"),
    height = 6, width = 10.5, units = "cm", res = 300)
plotTracks(list(dmr10_ht),  
           transcriptAnnotation = "symbol",
           geneAnnotation = "gene",
           showTitle = F)
dev.off()


# DMR 11
covariates_geno_ctpc_tech_cc_dmr_cpgs <- 
  cbind(covariates_geno_ctpc_tech_cc, 
        t(cb_betas_geno_cc_clean[combp_anno_df_es_sub_escutoff %>%
                                   subset(dmr == 11) %>%
                                   pull(Name),]))

# rename columns with numbers
colnames(covariates_geno_ctpc_tech_cc_dmr_cpgs)[197:198] <-
  combp_anno_df_es_sub_escutoff %>%
  subset(dmr == 11) %>%
  pull(pos)

# pivot to long
longdf_dmr11 <- 
  pivot_longer(covariates_geno_ctpc_tech_cc_dmr_cpgs %>% 
                 dplyr::select("134914613", "134914910",
                               sample_id, 
                               no2_prenatal_avg_2019v),
               cols = -c(sample_id, no2_prenatal_avg_2019v), 
               names_to = "cpg", 
               values_to = "dnam") %>%
  mutate(no2_colour = ifelse(no2_prenatal_avg_2019v < 7.32, "first",
                             ifelse(no2_prenatal_avg_2019v >=7.32 & 
                                      no2_prenatal_avg_2019v < 12.01 , "second",
                                    ifelse(no2_prenatal_avg_2019v >= 12.01  & 
                                             no2_prenatal_avg_2019v < 16.25, "third", "fourth")))) %>%
  mutate(no2_colour = factor(no2_colour, levels = c("first", "second",  "third", "fourth")))

# create charm-like visualization
dmr11_charm <- 
  ggplot(longdf_dmr11 %>% 
           subset(no2_colour %in% c("first", "fourth")) %>%
           group_by(cpg, no2_colour) %>%
           summarize(mean_dnam = mean(dnam)), 
         aes(x=as.numeric(cpg), y=mean_dnam, col = no2_colour)) +
  scale_color_manual(values = c("#254A90","red"), 
                     labels = c("First", "Third"),
                     name = "Prenatal NO2 quantile") +
  geom_line() + 
  geom_point(longdf_dmr11 %>% 
               subset(no2_colour %in% c("first", "fourth")), 
             mapping = aes(x=as.numeric(cpg), y=dnam, col = no2_colour),
             size = 0.25, alpha = 0.8) +
  theme_bw() +
  scale_x_continuous(name = "Genomic position (Chr10)") +
  scale_y_continuous(name = "DNA methylation (%)") +
  theme(axis.text = element_text(size = 9, family = "sans"),
        axis.title = element_text(size = 9, family = "sans"),
        panel.grid = element_blank(),
        legend.position = "none",
        panel.background = element_rect(fill = '#D3D3D3'))

ggsave(plot = dmr11_charm,
       filename = here("figures",
                       "linear_regression",
                       "prenatal",
                       "2023-01-03_dmr11_charm.png"),
       height = 6, width = 12, units = "cm")


# create genomic region visualization 
dmr11_from <- combp_anno_df_es_sub_escutoff %>%
  subset(dmr == 11) %>%
  pull(pos) %>% 
  min()
dmr11_to <- combp_anno_df_es_sub_escutoff %>%
  subset(dmr == 11) %>%
  pull(pos) %>% 
  max()

dmr11_refgenes <- UcscTrack(genome = "hg19", chromosome = "chr10", 
                            track = "NCBI RefSeq", 
                            table = "refGene",
                            from = dmr11_from, to = dmr11_to,
                            trackType = "GeneRegionTrack", 
                            rstarts = "exonStarts", rends = "exonEnds", 
                            gene = "name", symbol = "name", 
                            transcript = "name", strand = "strand", 
                            fill = "#254A90", name = "UCSC refGene")

# add names
dmr11_ranges <- ranges(dmr11_refgenes)

# gene refseq gene symbiks abd add to annotation 
mcols(dmr11_ranges)$symbol <- mapIds(org.Hs.eg.db, 
                                     gsub("\\.[1-9]$", "", mcols(dmr11_ranges)$symbol), 
                                     "SYMBOL","REFSEQ")
ranges(dmr11_refgenes) <- dmr11_ranges

# get regulatory info from ucsc
dmr11_chromHmmGm12878 <- UcscTrack(genome = "hg19", chromosome = "chr10", 
                                   track = "Broad ChromHMM",
                                   table = "wgEncodeBroadHmmGm12878HMM",
                                   trackType = "AnnotationTrack", 
                                   from = dmr11_from,
                                   to = dmr11_to,
                                   start = "chromStart", end = "chromEnd", 
                                   id = "name", feature = "score", shape = "box", 
                                   stacking = "dense", fill = "itemRgb",
                                   name = "GM12878")

# colour according to hmm table 
dmr11_chromHmmGm12878@dp@pars$fill <- recode(dmr11_chromHmmGm12878@dp@pars$fill, 
                                             "245,245,245" = "#f5f5f5",
                                             "255,105,105" = "#ff6969",
                                             "153,255,102" = "#99ff66",
                                             "255,252,4" = "#fffc04",
                                             "127,127,127" = "#7f7f7f",
                                             "10,190,254" = "#0abefe",
                                             "207,11,198" = "#cf0bc6",
                                             "0,176,80" = "#00b050",
                                             "255,0,0" = "#ff0000",
                                             "250,202,0" = "#faca00")

dmr11_chromHmmGmNhlf <- UcscTrack(genome = "hg19", chromosome = "chr10",
                                  track = "Broad ChromHMM",
                                  table = "wgEncodeBroadHmmNhlfHMM",
                                  trackType = "AnnotationTrack",
                                  from = 134834613,
                                  to = 134954910,
                                  start = "chromStart", end = "chromEnd",
                                  id = "name", feature = "score", shape = "box",
                                  stacking = "dense", fill = "itemRgb",
                                  name = "NHLF")

dmr11_chromHmmGmNhlf@dp@pars$fill <- recode(dmr11_chromHmmGmNhlf@dp@pars$fill, 
                                            "250,202,0" = "#faca00",
                                            "255,0,0" = "#ff0000",
                                            "255,105,105" = "#ff6969",
                                            "245,245,245" = "#f5f5f5",
                                            "255,252,4" = "#fffc04",
                                            "10,190,254"  = "#0abefe",
                                            "127,127,127" = "#7f7f7f",
                                            "153,255,102" = "#99ff66",
                                            "0,176,80" = "#00b050",
                                            "207,11,198" = "#cf0bc6",
                                            "10,190,254"  = "#0abefe")

dmr11_chromHmmH1hesc <- UcscTrack(genome = "hg19", chromosome = "chr10", 
                                  track = "Broad ChromHMM",
                                  table = "wgEncodeBroadHmmH1hescHMM",
                                  trackType = "AnnotationTrack", 
                                  from = 134834613,
                                  to = 134954910,
                                  start = "chromStart", end = "chromEnd", 
                                  id = "name", feature = "score", shape = "box", 
                                  stacking = "dense", fill = "itemRgb",
                                  name = "hesc")

dmr11_chromHmmH1hesc@dp@pars$fill <- recode(dmr11_chromHmmH1hesc@dp@pars$fill,
                                            "127,127,127" = "#7f7f7f",
                                            "245,245,245" = "#f5f5f5",
                                            "10,190,254"  = "#0abefe",
                                            "207,11,198" = "#cf0bc6",
                                            "250,202,0" = "#faca00",
                                            "0,176,80" = "#00b050",
                                            "255,0,0" = "#ff0000",
                                            "153,255,102" = "#99ff66",
                                            "255,252,4" = "#fffc04",
                                            "255,105,105" = "#ff6969",)

# highlight track for DMR
dmr11_ht <- HighlightTrack(trackList = list(dmr11_refgenes, 
                                            dmr11_chromHmmGm12878, 
                                            dmr11_chromHmmH1hesc,
                                            dmr11_chromHmmGmNhlf,
                                            axTrack),
                           start = dmr11_from,
                           end = dmr11_to, 
                           chromosome = 7, fill = "lightgrey", col = "lightgrey")

# check colours to be included
unique(c(dmr11_chromHmmGm12878@dp@pars$fill, 
         dmr11_chromHmmGmNhlf@dp@pars$fill, 
         dmr11_chromHmmH1hesc@dp@pars$fill))

png(here("figures",
         "linear_regression",
         "prenatal",
         "2023-01-04_dmr11_gviz.png"),
    height = 6, width = 10.5, units = "cm", res = 300)
plotTracks(list(dmr11_ht),  
           transcriptAnnotation = "symbol",
           geneAnnotation = "gene",
           showTitle = F)
dev.off()


# DMR 12
covariates_geno_ctpc_tech_cc_dmr_cpgs <- 
  cbind(covariates_geno_ctpc_tech_cc, 
        t(cb_betas_geno_cc_clean[combp_anno_df_es_sub_escutoff %>%
                                   subset(dmr == 12) %>%
                                   pull(Name),]))

# rename columns with numbers
colnames(covariates_geno_ctpc_tech_cc_dmr_cpgs)[197:205] <-
  combp_anno_df_es_sub_escutoff %>%
  subset(dmr == 12) %>%
  pull(pos)

# pivot to long
longdf_dmr12 <- 
  pivot_longer(covariates_geno_ctpc_tech_cc_dmr_cpgs %>% 
                 dplyr::select("54087200", "54087008", "54087173", "54087178", 
                               "54087209", "54087189", "54087028", "54087184", 
                               "54087066",
                               sample_id, 
                               no2_prenatal_avg_2019v),
               cols = -c(sample_id, no2_prenatal_avg_2019v), 
               names_to = "cpg", 
               values_to = "dnam") %>%
  mutate(no2_colour = ifelse(no2_prenatal_avg_2019v < 7.32, "first",
                             ifelse(no2_prenatal_avg_2019v >=7.32 & 
                                      no2_prenatal_avg_2019v < 12.01 , "second",
                                    ifelse(no2_prenatal_avg_2019v >= 12.01  & 
                                             no2_prenatal_avg_2019v < 16.25, "third", "fourth")))) %>%
  mutate(no2_colour = factor(no2_colour, levels = c("first", "second",  "third", "fourth")))

# create charm-like visualization
dmr12_charm <- 
  ggplot(longdf_dmr12 %>% 
           subset(no2_colour %in% c("first", "fourth")) %>%
           group_by(cpg, no2_colour) %>%
           summarize(mean_dnam = mean(dnam)), 
         aes(x=as.numeric(cpg), y=mean_dnam, col = no2_colour)) +
  scale_color_manual(values = c("#254A90","red"), 
                     labels = c("First", "Third"),
                     name = "Prenatal NO2 quantile") +
  geom_line() + 
  geom_point(longdf_dmr12 %>% 
               subset(no2_colour %in% c("first", "fourth")), 
             mapping = aes(x=as.numeric(cpg), y=dnam, col = no2_colour),
             size = 0.25, alpha = 0.8) +
  theme_bw() +
  scale_x_continuous(name = "Genomic position (Chr2)") +
  scale_y_continuous(name = "DNA methylation (%)") +
  theme(axis.text = element_text(size = 9, family = "sans"),
        axis.title = element_text(size = 9, family = "sans"),
        panel.grid = element_blank(),
        legend.position = "none",
        panel.background = element_rect(fill = '#D3D3D3'))

ggsave(plot = dmr12_charm,
       filename = here("figures",
                       "linear_regression",
                       "prenatal",
                       "2023-01-03_dmr112_charm.png"),
       height = 6, width = 12, units = "cm")

# create genomic region visualization 
dmr12_from <- combp_anno_df_es_sub_escutoff %>%
  subset(dmr == 12) %>%
  pull(pos) %>% 
  min()
dmr12_to <- combp_anno_df_es_sub_escutoff %>%
  subset(dmr == 12) %>%
  pull(pos) %>% 
  max()

dmr12_refgenes <- UcscTrack(genome = "hg19", chromosome = "chr2", 
                            track = "NCBI RefSeq", 
                            table = "refGene",
                            from = dmr12_from, to = dmr12_to,
                            trackType = "GeneRegionTrack", 
                            rstarts = "exonStarts", rends = "exonEnds", 
                            gene = "name", symbol = "name", 
                            transcript = "name", strand = "strand", 
                            fill = "#254A90", name = "UCSC refGene")

# add names
dmr12_ranges <- ranges(dmr12_refgenes)

# gene refseq gene symbiks abd add to annotation 
mcols(dmr12_ranges)$symbol <- mapIds(org.Hs.eg.db, 
                                     gsub("\\.[1-9]$", "", mcols(dmr12_ranges)$symbol), 
                                     "SYMBOL","REFSEQ")
ranges(dmr12_refgenes) <- dmr12_ranges

# get regulatory info from ucsc
dmr12_chromHmmGm12878 <- UcscTrack(genome = "hg19", chromosome = "chr2", 
                                   track = "Broad ChromHMM",
                                   table = "wgEncodeBroadHmmGm12878HMM",
                                   trackType = "AnnotationTrack", 
                                   from = 53900000,
                                   to = dmr12_to,
                                   start = "chromStart", end = "chromEnd", 
                                   id = "name", feature = "score", shape = "box", 
                                   stacking = "dense", fill = "itemRgb",
                                   name = "GM12878")

# colour according to hmm table 
dmr12_chromHmmGm12878@dp@pars$fill <- recode(dmr12_chromHmmGm12878@dp@pars$fill, 
                                             "245,245,245" = "#f5f5f5",
                                             "255,105,105" = "#ff6969",
                                             "153,255,102" = "#99ff66",
                                             "255,252,4" = "#fffc04",
                                             "127,127,127" = "#7f7f7f",
                                             "10,190,254" = "#0abefe",
                                             "207,11,198" = "#cf0bc6",
                                             "0,176,80" = "#00b050",
                                             "255,0,0" = "#ff0000",
                                             "250,202,0" = "#faca00")

dmr12_chromHmmGmNhlf <- UcscTrack(genome = "hg19", chromosome = "chr2",
                                  track = "Broad ChromHMM",
                                  table = "wgEncodeBroadHmmNhlfHMM",
                                  trackType = "AnnotationTrack",
                                  from = 53900000,
                                  to = 54088709,
                                  start = "chromStart", end = "chromEnd",
                                  id = "name", feature = "score", shape = "box",
                                  stacking = "dense", fill = "itemRgb",
                                  name = "NHLF")

dmr12_chromHmmGmNhlf@dp@pars$fill <- recode(dmr12_chromHmmGmNhlf@dp@pars$fill, 
                                            "250,202,0" = "#faca00",
                                            "255,0,0" = "#ff0000",
                                            "255,105,105" = "#ff6969",
                                            "245,245,245" = "#f5f5f5",
                                            "255,252,4" = "#fffc04",
                                            "10,190,254"  = "#0abefe",
                                            "127,127,127" = "#7f7f7f",
                                            "153,255,102" = "#99ff66",
                                            "0,176,80" = "#00b050",
                                            "207,11,198" = "#cf0bc6",
                                            "10,190,254"  = "#0abefe")

dmr12_chromHmmH1hesc <- UcscTrack(genome = "hg19", chromosome = "chr2", 
                                  track = "Broad ChromHMM",
                                  table = "wgEncodeBroadHmmH1hescHMM",
                                  trackType = "AnnotationTrack", 
                                  from = 53900000,
                                  to = 54088709,
                                  start = "chromStart", end = "chromEnd", 
                                  id = "name", feature = "score", shape = "box", 
                                  stacking = "dense", fill = "itemRgb",
                                  name = "hesc")

dmr12_chromHmmH1hesc@dp@pars$fill <- recode(dmr12_chromHmmH1hesc@dp@pars$fill,
                                            "127,127,127" = "#7f7f7f",
                                            "245,245,245" = "#f5f5f5",
                                            "10,190,254"  = "#0abefe",
                                            "207,11,198" = "#cf0bc6",
                                            "250,202,0" = "#faca00",
                                            "0,176,80" = "#00b050",
                                            "255,0,0" = "#ff0000",
                                            "153,255,102" = "#99ff66",
                                            "255,252,4" = "#fffc04",
                                            "255,105,105" = "#ff6969",)

# highlight track for DMR
dmr12_ht <- HighlightTrack(trackList = list(dmr12_refgenes, 
                                            dmr12_chromHmmGm12878, 
                                            dmr12_chromHmmH1hesc,
                                            dmr12_chromHmmGmNhlf,
                                            axTrack),
                           start = dmr12_from,
                           end = dmr12_to, 
                           chromosome = 7, fill = "lightgrey", col = "lightgrey")

# check colours to be included
unique(c(dmr12_chromHmmGm12878@dp@pars$fill, 
         dmr12_chromHmmGmNhlf@dp@pars$fill, 
         dmr12_chromHmmH1hesc@dp@pars$fill))

png(here("figures",
         "linear_regression",
         "prenatal",
         "2023-01-04_dmr12_gviz.png"),
    height = 6, width = 10.5, units = "cm", res = 300)
plotTracks(list(dmr12_ht),  
           transcriptAnnotation = "symbol",
           geneAnnotation = "gene",
           showTitle = F)
dev.off()


# DMR 13
covariates_geno_ctpc_tech_cc_dmr_cpgs <- 
  cbind(covariates_geno_ctpc_tech_cc, 
        t(cb_betas_geno_cc_clean[combp_anno_df_es_sub_escutoff %>%
                                   subset(dmr == 13) %>%
                                   pull(Name),]))

# rename columns with numbers
colnames(covariates_geno_ctpc_tech_cc_dmr_cpgs)[197:199] <-
  combp_anno_df_es_sub_escutoff %>%
  subset(dmr == 13) %>%
  pull(pos)

# pivot to long
longdf_dmr13 <- 
  pivot_longer(covariates_geno_ctpc_tech_cc_dmr_cpgs %>% 
                 dplyr::select("58879056", "58879022", "58879059",
                               sample_id, 
                               no2_prenatal_avg_2019v),
               cols = -c(sample_id, no2_prenatal_avg_2019v), 
               names_to = "cpg", 
               values_to = "dnam") %>%
  mutate(no2_colour = ifelse(no2_prenatal_avg_2019v < 7.32, "first",
                             ifelse(no2_prenatal_avg_2019v >=7.32 & 
                                      no2_prenatal_avg_2019v < 12.01 , "second",
                                    ifelse(no2_prenatal_avg_2019v >= 12.01  & 
                                             no2_prenatal_avg_2019v < 16.25, "third", "fourth")))) %>%
  mutate(no2_colour = factor(no2_colour, levels = c("first", "second",  "third", "fourth")))

# create charm-like visualization
dmr13_charm <- 
  ggplot(longdf_dmr13 %>% 
           subset(no2_colour %in% c("first", "fourth")) %>%
           group_by(cpg, no2_colour) %>%
           summarize(mean_dnam = mean(dnam)), 
         aes(x=as.numeric(cpg), y=mean_dnam, col = no2_colour)) +
  scale_color_manual(values = c("#254A90","red"), 
                     labels = c("First", "Third"),
                     name = "Prenatal NO2 quantile") +
  geom_line() + 
  geom_point(longdf_dmr13 %>% 
               subset(no2_colour %in% c("first", "fourth")), 
             mapping = aes(x=as.numeric(cpg), y=dnam, col = no2_colour),
             size = 0.25, alpha = 0.8) +
  theme_bw() +
  scale_x_continuous(name = "Genomic position (Chr19)", 
                     breaks = seq(58879025, 58879055, by=10)) +
  scale_y_continuous(name = "DNA methylation (%)") +
  theme(axis.text = element_text(size = 9, family = "sans"),
        axis.title = element_text(size = 9, family = "sans"),
        panel.grid = element_blank(),
        legend.position = "none",
        panel.background = element_rect(fill = '#D3D3D3'))

ggsave(plot = dmr13_charm,
       filename = here("figures",
                       "linear_regression",
                       "prenatal",
                       "2023-01-03_dmr13_charm.png"),
       height = 6, width = 12, units = "cm")

# create genomic region visualization 
dmr13_from <- combp_anno_df_es_sub_escutoff %>%
  subset(dmr == 13) %>%
  pull(pos) %>% 
  min()
dmr13_to <- combp_anno_df_es_sub_escutoff %>%
  subset(dmr == 13) %>%
  pull(pos) %>% 
  max()

dmr13_refgenes <- UcscTrack(genome = "hg19", chromosome = "chr19", 
                            track = "NCBI RefSeq", 
                            table = "refGene",
                            from = dmr13_from, to = dmr13_to,
                            trackType = "GeneRegionTrack", 
                            rstarts = "exonStarts", rends = "exonEnds", 
                            gene = "name", symbol = "name", 
                            transcript = "name", strand = "strand", 
                            fill = "#254A90", name = "UCSC refGene")

# add names
dmr13_ranges <- ranges(dmr13_refgenes)

# gene refseq gene symbiks abd add to annotation 
mcols(dmr13_ranges)$symbol <- mapIds(org.Hs.eg.db, 
                                     gsub("\\.[1-9]$", "", mcols(dmr13_ranges)$symbol), 
                                     "SYMBOL","REFSEQ")
ranges(dmr13_refgenes) <- dmr13_ranges

# get regulatory info from ucsc
dmr13_chromHmmGm12878 <- UcscTrack(genome = "hg19", chromosome = "chr19", 
                                   track = "Broad ChromHMM",
                                   table = "wgEncodeBroadHmmGm12878HMM",
                                   trackType = "AnnotationTrack", 
                                   from = dmr13_from,
                                   to = 58892500,
                                   start = "chromStart", end = "chromEnd", 
                                   id = "name", feature = "score", shape = "box", 
                                   stacking = "dense", fill = "itemRgb",
                                   name = "GM12878")

# colour according to hmm table 
dmr13_chromHmmGm12878@dp@pars$fill <- recode(dmr13_chromHmmGm12878@dp@pars$fill, 
                                             "245,245,245" = "#f5f5f5",
                                             "255,105,105" = "#ff6969",
                                             "153,255,102" = "#99ff66",
                                             "255,252,4" = "#fffc04",
                                             "127,127,127" = "#7f7f7f",
                                             "10,190,254" = "#0abefe",
                                             "207,11,198" = "#cf0bc6",
                                             "0,176,80" = "#00b050",
                                             "255,0,0" = "#ff0000",
                                             "250,202,0" = "#faca00")

dmr13_chromHmmGmNhlf <- UcscTrack(genome = "hg19", chromosome = "chr19",
                                  track = "Broad ChromHMM",
                                  table = "wgEncodeBroadHmmNhlfHMM",
                                  trackType = "AnnotationTrack",
                                  from = dmr13_from,
                                  to = 58892500,
                                  start = "chromStart", end = "chromEnd",
                                  id = "name", feature = "score", shape = "box",
                                  stacking = "dense", fill = "itemRgb",
                                  name = "NHLF")

dmr13_chromHmmGmNhlf@dp@pars$fill <- recode(dmr13_chromHmmGmNhlf@dp@pars$fill, 
                                            "250,202,0" = "#faca00",
                                            "255,0,0" = "#ff0000",
                                            "255,105,105" = "#ff6969",
                                            "245,245,245" = "#f5f5f5",
                                            "255,252,4" = "#fffc04",
                                            "10,190,254"  = "#0abefe",
                                            "127,127,127" = "#7f7f7f",
                                            "153,255,102" = "#99ff66",
                                            "0,176,80" = "#00b050",
                                            "207,11,198" = "#cf0bc6",
                                            "10,190,254"  = "#0abefe")

dmr13_chromHmmH1hesc <- UcscTrack(genome = "hg19", chromosome = "chr19", 
                                  track = "Broad ChromHMM",
                                  table = "wgEncodeBroadHmmH1hescHMM",
                                  trackType = "AnnotationTrack", 
                                  from = dmr13_from,
                                  to = 58892500,
                                  start = "chromStart", end = "chromEnd", 
                                  id = "name", feature = "score", shape = "box", 
                                  stacking = "dense", fill = "itemRgb",
                                  name = "hesc")

dmr13_chromHmmH1hesc@dp@pars$fill <- recode(dmr13_chromHmmH1hesc@dp@pars$fill,
                                            "127,127,127" = "#7f7f7f",
                                            "245,245,245" = "#f5f5f5",
                                            "10,190,254"  = "#0abefe",
                                            "207,11,198" = "#cf0bc6",
                                            "250,202,0" = "#faca00",
                                            "0,176,80" = "#00b050",
                                            "255,0,0" = "#ff0000",
                                            "153,255,102" = "#99ff66",
                                            "255,252,4" = "#fffc04",
                                            "255,105,105" = "#ff6969",)

# highlight track for DMR
dmr13_ht <- HighlightTrack(trackList = list(dmr13_refgenes, 
                                            dmr13_chromHmmGm12878, 
                                            dmr13_chromHmmH1hesc,
                                            dmr13_chromHmmGmNhlf,
                                            axTrack),
                           start = dmr13_from,
                           end = dmr13_to, 
                           chromosome = 19, fill = "lightgrey", col = "lightgrey")

unique(c(dmr13_chromHmmGm12878@dp@pars$fill, 
         dmr13_chromHmmGmNhlf@dp@pars$fill, 
         dmr13_chromHmmH1hesc@dp@pars$fill))

png(here("figures",
         "linear_regression",
         "prenatal",
         "2023-01-04_dmr13_gviz.png"),
    height = 6, width = 10.5, units = "cm", res = 300)
plotTracks(list(dmr13_ht),  
           transcriptAnnotation = "symbol",
           geneAnnotation = "gene",
           showTitle = F)
dev.off()


# DMR 14
covariates_geno_ctpc_tech_cc_dmr_cpgs <- 
  cbind(covariates_geno_ctpc_tech_cc, 
        t(cb_betas_geno_cc_clean[combp_anno_df_es_sub_escutoff %>%
                                   subset(dmr == 14) %>%
                                   pull(Name),]))

# rename columns with numbers
colnames(covariates_geno_ctpc_tech_cc_dmr_cpgs)[197:199] <-
  combp_anno_df_es_sub_escutoff %>%
  subset(dmr == 14) %>%
  pull(pos)

# pivot to long
longdf_dmr14 <- 
  pivot_longer(covariates_geno_ctpc_tech_cc_dmr_cpgs %>% 
                 dplyr::select("75139680", "75139544", "75139390",
                               sample_id, 
                               no2_prenatal_avg_2019v),
               cols = -c(sample_id, no2_prenatal_avg_2019v), 
               names_to = "cpg", 
               values_to = "dnam") %>%
  mutate(no2_colour = ifelse(no2_prenatal_avg_2019v < 7.32, "first",
                             ifelse(no2_prenatal_avg_2019v >=7.32 & 
                                      no2_prenatal_avg_2019v < 12.01 , "second",
                                    ifelse(no2_prenatal_avg_2019v >= 12.01  & 
                                             no2_prenatal_avg_2019v < 16.25, "third", "fourth")))) %>%
  mutate(no2_colour = factor(no2_colour, levels = c("first", "second",  "third", "fourth")))

# create charm-like visualization
dmr14_charm <- 
  ggplot(longdf_dmr14 %>% 
           subset(no2_colour %in% c("first", "fourth")) %>%
           group_by(cpg, no2_colour) %>%
           summarize(mean_dnam = mean(dnam)), 
         aes(x=as.numeric(cpg), y=mean_dnam, col = no2_colour)) +
  scale_color_manual(values = c("#254A90","red"), 
                     labels = c("First", "Third"),
                     name = "Prenatal NO2 quantile") +
  geom_line() + 
  geom_point(longdf_dmr14 %>% 
               subset(no2_colour %in% c("first", "fourth")), 
             mapping = aes(x=as.numeric(cpg), y=dnam, col = no2_colour),
             size = 0.25, alpha = 0.8) +
  theme_bw() +
  scale_x_continuous(name = "Genomic position (Chr11)") +
  scale_y_continuous(name = "DNA methylation (%)") +
  theme(axis.text = element_text(size = 9, family = "sans"),
        axis.title = element_text(size = 9, family = "sans"),
        panel.grid = element_blank(),
        legend.position = "none",
        panel.background = element_rect(fill = '#D3D3D3'))

ggsave(plot = dmr14_charm,
       filename = here("figures",
                       "linear_regression",
                       "prenatal",
                       "2023-01-03_dmr14_charm.png"),
       height = 6, width = 12, units = "cm")


# create genomic region visualization 
dmr14_from <- combp_anno_df_es_sub_escutoff %>%
  subset(dmr == 14) %>%
  pull(pos) %>% 
  min()
dmr14_to <- combp_anno_df_es_sub_escutoff %>%
  subset(dmr == 14) %>%
  pull(pos) %>% 
  max()

dmr14_refgenes <- UcscTrack(genome = "hg19", chromosome = "chr11", 
                            track = "NCBI RefSeq", 
                            table = "refGene",
                            from = dmr14_from, to = dmr14_to,
                            trackType = "GeneRegionTrack", 
                            rstarts = "exonStarts", rends = "exonEnds", 
                            gene = "name", symbol = "name", 
                            transcript = "name", strand = "strand", 
                            fill = "#254A90", name = "UCSC refGene")

# add names
dmr14_ranges <- ranges(dmr14_refgenes)

# gene refseq gene symbiks abd add to annotation 
mcols(dmr14_ranges)$symbol <- mapIds(org.Hs.eg.db, 
                                     gsub("\\.[1-9]$", "", mcols(dmr14_ranges)$symbol), 
                                     "SYMBOL","REFSEQ")
ranges(dmr14_refgenes) <- dmr14_ranges

# get regulatory info from ucsc
dmr14_chromHmmGm12878 <- UcscTrack(genome = "hg19", chromosome = "chr11", 
                                   track = "Broad ChromHMM",
                                   table = "wgEncodeBroadHmmGm12878HMM",
                                   trackType = "AnnotationTrack", 
                                   from = 75134000,
                                   to = 75142580,
                                   start = "chromStart", end = "chromEnd", 
                                   id = "name", feature = "score", shape = "box", 
                                   stacking = "dense", fill = "itemRgb",
                                   name = "GM12878")

# colour according to hmm table 
dmr14_chromHmmGm12878@dp@pars$fill <- recode(dmr14_chromHmmGm12878@dp@pars$fill, 
                                             "245,245,245" = "#f5f5f5",
                                             "255,105,105" = "#ff6969",
                                             "153,255,102" = "#99ff66",
                                             "255,252,4" = "#fffc04",
                                             "127,127,127" = "#7f7f7f",
                                             "10,190,254" = "#0abefe",
                                             "207,11,198" = "#cf0bc6",
                                             "0,176,80" = "#00b050",
                                             "255,0,0" = "#ff0000",
                                             "250,202,0" = "#faca00")

dmr14_chromHmmGmNhlf <- UcscTrack(genome = "hg19", chromosome = "chr11",
                                  track = "Broad ChromHMM",
                                  table = "wgEncodeBroadHmmNhlfHMM",
                                  trackType = "AnnotationTrack",
                                  from = 75133000,
                                  to = 75142580,
                                  start = "chromStart", end = "chromEnd",
                                  id = "name", feature = "score", shape = "box",
                                  stacking = "dense", fill = "itemRgb",
                                  name = "NHLF")

dmr14_chromHmmGmNhlf@dp@pars$fill <- recode(dmr14_chromHmmGmNhlf@dp@pars$fill, 
                                            "250,202,0" = "#faca00",
                                            "255,0,0" = "#ff0000",
                                            "255,105,105" = "#ff6969",
                                            "245,245,245" = "#f5f5f5",
                                            "255,252,4" = "#fffc04",
                                            "10,190,254"  = "#0abefe",
                                            "127,127,127" = "#7f7f7f",
                                            "153,255,102" = "#99ff66",
                                            "0,176,80" = "#00b050",
                                            "207,11,198" = "#cf0bc6",
                                            "10,190,254"  = "#0abefe")

dmr14_chromHmmH1hesc <- UcscTrack(genome = "hg19", chromosome = "chr11", 
                                  track = "Broad ChromHMM",
                                  table = "wgEncodeBroadHmmH1hescHMM",
                                  trackType = "AnnotationTrack", 
                                  from = 75134000,
                                  to = 75142580,
                                  start = "chromStart", end = "chromEnd", 
                                  id = "name", feature = "score", shape = "box", 
                                  stacking = "dense", fill = "itemRgb",
                                  name = "hesc")

dmr14_chromHmmH1hesc@dp@pars$fill <- recode(dmr14_chromHmmH1hesc@dp@pars$fill,
                                            "127,127,127" = "#7f7f7f",
                                            "245,245,245" = "#f5f5f5",
                                            "10,190,254"  = "#0abefe",
                                            "207,11,198" = "#cf0bc6",
                                            "250,202,0" = "#faca00",
                                            "0,176,80" = "#00b050",
                                            "255,0,0" = "#ff0000",
                                            "153,255,102" = "#99ff66",
                                            "255,252,4" = "#fffc04",
                                            "255,105,105" = "#ff6969",)

# highlight track for DMR
dmr14_ht <- HighlightTrack(trackList = list(dmr14_refgenes, 
                                            dmr14_chromHmmGm12878, 
                                            dmr14_chromHmmH1hesc,
                                            dmr14_chromHmmGmNhlf,
                                            axTrack),
                           start = dmr14_from,
                           end = dmr14_to, 
                           chromosome = 11, fill = "lightgrey", col = "lightgrey")

unique(c(dmr14_chromHmmGm12878@dp@pars$fill, 
         dmr14_chromHmmGmNhlf@dp@pars$fill, 
         dmr14_chromHmmH1hesc@dp@pars$fill))

png(here("figures",
         "linear_regression",
         "prenatal",
         "2023-01-04_dmr14_gviz.png"),
    height = 6, width = 10.5, units = "cm", res = 300)
plotTracks(list(dmr14_ht),  
           transcriptAnnotation = "symbol",
           geneAnnotation = "gene",
           showTitle = F)
dev.off()


# DMR 15
covariates_geno_ctpc_tech_cc_dmr_cpgs <- 
  cbind(covariates_geno_ctpc_tech_cc, 
        t(cb_betas_geno_cc_clean[combp_anno_df_es_sub_escutoff %>%
                                   subset(dmr == 15) %>%
                                   pull(Name),]))

# rename columns with numbers
colnames(covariates_geno_ctpc_tech_cc_dmr_cpgs)[197:199] <-
  combp_anno_df_es_sub_escutoff %>%
  subset(dmr == 15) %>%
  pull(pos)

# pivot to long
longdf_dmr15 <- 
  pivot_longer(covariates_geno_ctpc_tech_cc_dmr_cpgs %>% 
                 dplyr::select("217306763", "217306700", "217306590",
                               sample_id, 
                               no2_prenatal_avg_2019v),
               cols = -c(sample_id, no2_prenatal_avg_2019v), 
               names_to = "cpg", 
               values_to = "dnam") %>%
  mutate(no2_colour = ifelse(no2_prenatal_avg_2019v < 7.32, "first",
                             ifelse(no2_prenatal_avg_2019v >=7.32 & 
                                      no2_prenatal_avg_2019v < 12.01 , "second",
                                    ifelse(no2_prenatal_avg_2019v >= 12.01  & 
                                             no2_prenatal_avg_2019v < 16.25, "third", "fourth")))) %>%
  mutate(no2_colour = factor(no2_colour, levels = c("first", "second",  "third", "fourth")))

# create charm-like visualization
dmr15_charm <- 
  ggplot(longdf_dmr15 %>% 
           subset(no2_colour %in% c("first", "fourth")) %>%
           group_by(cpg, no2_colour) %>%
           summarize(mean_dnam = mean(dnam)), 
         aes(x=as.numeric(cpg), y=mean_dnam, col = no2_colour)) +
  scale_color_manual(values = c("#254A90","red"), 
                     labels = c("First", "Third"),
                     name = "Prenatal NO2 quantile") +
  geom_line() + 
  geom_point(longdf_dmr15 %>% 
               subset(no2_colour %in% c("first", "fourth")), 
             mapping = aes(x=as.numeric(cpg), y=dnam, col = no2_colour),
             size = 0.25, alpha = 0.8) +
  theme_bw() +
  scale_x_continuous(name = "Genomic position (Chr1)") +
  scale_y_continuous(name = "DNA methylation (%)") +
  theme(axis.text = element_text(size = 9, family = "sans"),
        axis.title = element_text(size = 9, family = "sans"),
        panel.grid = element_blank(),
        legend.position = "none",
        panel.background = element_rect(fill = '#D3D3D3'))

ggsave(plot = dmr15_charm,
       filename = here("figures",
                       "linear_regression",
                       "prenatal",
                       "2023-01-03_dmr15_charm.png"),
       height = 6, width = 12, units = "cm")


# create genomic region visualization 
dmr15_from <- combp_anno_df_es_sub_escutoff %>%
  subset(dmr == 15) %>%
  pull(pos) %>% 
  min()
dmr15_to <- combp_anno_df_es_sub_escutoff %>%
  subset(dmr == 15) %>%
  pull(pos) %>% 
  max()

dmr15_refgenes <- UcscTrack(genome = "hg19", chromosome = "chr1", 
                            track = "NCBI RefSeq", 
                            table = "refGene",
                            from = dmr15_from, to = dmr15_to,
                            trackType = "GeneRegionTrack", 
                            rstarts = "exonStarts", rends = "exonEnds", 
                            gene = "name", symbol = "name", 
                            transcript = "name", strand = "strand", 
                            fill = "#254A90", name = "UCSC refGene")

# add names
dmr15_ranges <- ranges(dmr15_refgenes)

# gene refseq gene symbiks abd add to annotation 
mcols(dmr15_ranges)$symbol <- mapIds(org.Hs.eg.db, 
                                     gsub("\\.[1-9]$", "", mcols(dmr15_ranges)$symbol), 
                                     "SYMBOL","REFSEQ")
ranges(dmr15_refgenes) <- dmr15_ranges

# get regulatory info from ucsc
dmr15_chromHmmGm12878 <- UcscTrack(genome = "hg19", chromosome = "chr1", 
                                   track = "Broad ChromHMM",
                                   table = "wgEncodeBroadHmmGm12878HMM",
                                   trackType = "AnnotationTrack", 
                                   from = 216700000,
                                   to = dmr15_to,
                                   start = "chromStart", end = "chromEnd", 
                                   id = "name", feature = "score", shape = "box", 
                                   stacking = "dense", fill = "itemRgb",
                                   name = "GM12878")

# colour according to hmm table 
dmr15_chromHmmGm12878@dp@pars$fill <- recode(dmr15_chromHmmGm12878@dp@pars$fill, 
                                             "245,245,245" = "#f5f5f5",
                                             "255,105,105" = "#ff6969",
                                             "153,255,102" = "#99ff66",
                                             "255,252,4" = "#fffc04",
                                             "127,127,127" = "#7f7f7f",
                                             "10,190,254" = "#0abefe",
                                             "207,11,198" = "#cf0bc6",
                                             "0,176,80" = "#00b050",
                                             "255,0,0" = "#ff0000",
                                             "250,202,0" = "#faca00")

dmr15_chromHmmGmNhlf <- UcscTrack(genome = "hg19", chromosome = "chr1",
                                  track = "Broad ChromHMM",
                                  table = "wgEncodeBroadHmmNhlfHMM",
                                  trackType = "AnnotationTrack",
                                  from = 216700000,
                                  to = dmr15_to,
                                  start = "chromStart", end = "chromEnd",
                                  id = "name", feature = "score", shape = "box",
                                  stacking = "dense", fill = "itemRgb",
                                  name = "NHLF")

dmr15_chromHmmGmNhlf@dp@pars$fill <- recode(dmr15_chromHmmGmNhlf@dp@pars$fill, 
                                            "250,202,0" = "#faca00",
                                            "255,0,0" = "#ff0000",
                                            "255,105,105" = "#ff6969",
                                            "245,245,245" = "#f5f5f5",
                                            "255,252,4" = "#fffc04",
                                            "10,190,254"  = "#0abefe",
                                            "127,127,127" = "#7f7f7f",
                                            "153,255,102" = "#99ff66",
                                            "0,176,80" = "#00b050",
                                            "207,11,198" = "#cf0bc6",
                                            "10,190,254"  = "#0abefe")

dmr15_chromHmmH1hesc <- UcscTrack(genome = "hg19", chromosome = "chr1", 
                                  track = "Broad ChromHMM",
                                  table = "wgEncodeBroadHmmH1hescHMM",
                                  trackType = "AnnotationTrack", 
                                  from = 216700000,
                                  to = dmr15_to,
                                  start = "chromStart", end = "chromEnd", 
                                  id = "name", feature = "score", shape = "box", 
                                  stacking = "dense", fill = "itemRgb",
                                  name = "hesc")

dmr15_chromHmmH1hesc@dp@pars$fill <- recode(dmr15_chromHmmH1hesc@dp@pars$fill,
                                            "127,127,127" = "#7f7f7f",
                                            "245,245,245" = "#f5f5f5",
                                            "10,190,254"  = "#0abefe",
                                            "207,11,198" = "#cf0bc6",
                                            "250,202,0" = "#faca00",
                                            "0,176,80" = "#00b050",
                                            "255,0,0" = "#ff0000",
                                            "153,255,102" = "#99ff66",
                                            "255,252,4" = "#fffc04",
                                            "255,105,105" = "#ff6969",)

# highlight track for DMR
dmr15_ht <- HighlightTrack(trackList = list(dmr15_refgenes, 
                                            dmr15_chromHmmGm12878, 
                                            dmr15_chromHmmH1hesc,
                                            dmr15_chromHmmGmNhlf,
                                            axTrack),
                           start = dmr15_from,
                           end = dmr15_to, 
                           chromosome = 1, fill = "lightgrey", col = "lightgrey")

unique(c(dmr15_chromHmmGm12878@dp@pars$fill, 
         dmr15_chromHmmGmNhlf@dp@pars$fill, 
         dmr15_chromHmmH1hesc@dp@pars$fill))

png(here("figures",
         "linear_regression",
         "prenatal",
         "2023-01-04_dmr15_gviz.png"),
    height = 6, width = 10.5, units = "cm", res = 300)
plotTracks(list(dmr15_ht),  
           transcriptAnnotation = "symbol",
           geneAnnotation = "gene",
           showTitle = F)
dev.off()


# DMR 16
covariates_geno_ctpc_tech_cc_dmr_cpgs <- 
  cbind(covariates_geno_ctpc_tech_cc, 
        t(cb_betas_geno_cc_clean[combp_anno_df_es_sub_escutoff %>%
                                   subset(dmr == 16) %>%
                                   pull(Name),]))

# rename columns with numbers
colnames(covariates_geno_ctpc_tech_cc_dmr_cpgs)[197:199] <-
  combp_anno_df_es_sub_escutoff %>%
  subset(dmr == 16) %>%
  pull(pos)

# pivot to long
longdf_dmr16 <- 
  pivot_longer(covariates_geno_ctpc_tech_cc_dmr_cpgs %>% 
                 dplyr::select("3374767", "3374830", "3374909",
                               sample_id, 
                               no2_prenatal_avg_2019v),
               cols = -c(sample_id, no2_prenatal_avg_2019v), 
               names_to = "cpg", 
               values_to = "dnam") %>%
  mutate(no2_colour = ifelse(no2_prenatal_avg_2019v < 7.32, "first",
                             ifelse(no2_prenatal_avg_2019v >=7.32 & 
                                      no2_prenatal_avg_2019v < 12.01 , "second",
                                    ifelse(no2_prenatal_avg_2019v >= 12.01  & 
                                             no2_prenatal_avg_2019v < 16.25, "third", "fourth")))) %>%
  mutate(no2_colour = factor(no2_colour, levels = c("first", "second",  "third", "fourth")))

# create charm-like visualization
dmr16_charm <- 
  ggplot(longdf_dmr16 %>% 
           subset(no2_colour %in% c("first", "fourth")) %>%
           group_by(cpg, no2_colour) %>%
           summarize(mean_dnam = mean(dnam)), 
         aes(x=as.numeric(cpg), y=mean_dnam, col = no2_colour)) +
  scale_color_manual(values = c("#254A90","red"), 
                     labels = c("First", "Third"),
                     name = "Prenatal NO2 quantile") +
  geom_line() + 
  geom_point(longdf_dmr16 %>% 
               subset(no2_colour %in% c("first", "fourth")), 
             mapping = aes(x=as.numeric(cpg), y=dnam, col = no2_colour),
             size = 0.25, alpha = 0.8) +
  theme_bw() +
  scale_x_continuous(name = "Genomic position (Chr4)",
                     breaks = seq(3374780, 3374900, by =40)) +
  scale_y_continuous(name = "DNA methylation (%)") +
  theme(axis.text = element_text(size = 9, family = "sans"),
        axis.title = element_text(size = 9, family = "sans"),
        panel.grid = element_blank(),
        legend.position = "none",
        panel.background = element_rect(fill = '#D3D3D3'))

ggsave(plot = dmr16_charm,
       filename = here("figures",
                       "linear_regression",
                       "prenatal",
                       "2023-01-03_dmr16_charm.png"),
       height = 6, width = 12, units = "cm")

# create genomic region visualization 
dmr16_from <- combp_anno_df_es_sub_escutoff %>%
  subset(dmr == 16) %>%
  pull(pos) %>% 
  min()
dmr16_to <- combp_anno_df_es_sub_escutoff %>%
  subset(dmr == 16) %>%
  pull(pos) %>% 
  max()

dmr16_refgenes <- UcscTrack(genome = "hg19", chromosome = "chr4", 
                            track = "NCBI RefSeq", 
                            table = "refGene",
                            from = dmr16_from, to = dmr16_to,
                            trackType = "GeneRegionTrack", 
                            rstarts = "exonStarts", rends = "exonEnds", 
                            gene = "name", symbol = "name", 
                            transcript = "name", strand = "strand", 
                            fill = "#254A90", name = "UCSC refGene")

# add names
dmr16_ranges <- ranges(dmr16_refgenes)

# gene refseq gene symbiks abd add to annotation 
mcols(dmr16_ranges)$symbol <- mapIds(org.Hs.eg.db, 
                                     gsub("\\.[1-9]$", "", mcols(dmr16_ranges)$symbol), 
                                     "SYMBOL","REFSEQ")
ranges(dmr16_refgenes) <- dmr16_ranges

# get regulatory info from ucsc
dmr16_chromHmmGm12878 <- UcscTrack(genome = "hg19", chromosome = "chr4", 
                                   track = "Broad ChromHMM",
                                   table = "wgEncodeBroadHmmGm12878HMM",
                                   trackType = "AnnotationTrack", 
                                   from = 3320000,
                                   to =   3434900,
                                   start = "chromStart", end = "chromEnd", 
                                   id = "name", feature = "score", shape = "box", 
                                   stacking = "dense", fill = "itemRgb",
                                   name = "GM12878")

# colour according to hmm table 
dmr16_chromHmmGm12878@dp@pars$fill <- recode(dmr16_chromHmmGm12878@dp@pars$fill, 
                                             "245,245,245" = "#f5f5f5",
                                             "255,105,105" = "#ff6969",
                                             "153,255,102" = "#99ff66",
                                             "255,252,4" = "#fffc04",
                                             "127,127,127" = "#7f7f7f",
                                             "10,190,254" = "#0abefe",
                                             "207,11,198" = "#cf0bc6",
                                             "0,176,80" = "#00b050",
                                             "255,0,0" = "#ff0000",
                                             "250,202,0" = "#faca00")

dmr16_chromHmmGmNhlf <- UcscTrack(genome = "hg19", chromosome = "chr4",
                                  track = "Broad ChromHMM",
                                  table = "wgEncodeBroadHmmNhlfHMM",
                                  trackType = "AnnotationTrack",
                                  from = 3320000,
                                  to =   3434900,
                                  start = "chromStart", end = "chromEnd",
                                  id = "name", feature = "score", shape = "box",
                                  stacking = "dense", fill = "itemRgb",
                                  name = "NHLF")

dmr16_chromHmmGmNhlf@dp@pars$fill <- recode(dmr16_chromHmmGmNhlf@dp@pars$fill, 
                                            "250,202,0" = "#faca00",
                                            "255,0,0" = "#ff0000",
                                            "255,105,105" = "#ff6969",
                                            "245,245,245" = "#f5f5f5",
                                            "255,252,4" = "#fffc04",
                                            "10,190,254"  = "#0abefe",
                                            "127,127,127" = "#7f7f7f",
                                            "153,255,102" = "#99ff66",
                                            "0,176,80" = "#00b050",
                                            "207,11,198" = "#cf0bc6",
                                            "10,190,254"  = "#0abefe")

dmr16_chromHmmH1hesc <- UcscTrack(genome = "hg19", chromosome = "chr4", 
                                  track = "Broad ChromHMM",
                                  table = "wgEncodeBroadHmmH1hescHMM",
                                  trackType = "AnnotationTrack", 
                                  from = 3320000,
                                  to =   3434900,
                                  start = "chromStart", end = "chromEnd", 
                                  id = "name", feature = "score", shape = "box", 
                                  stacking = "dense", fill = "itemRgb",
                                  name = "hesc")

dmr16_chromHmmH1hesc@dp@pars$fill <- recode(dmr16_chromHmmH1hesc@dp@pars$fill,
                                            "127,127,127" = "#7f7f7f",
                                            "245,245,245" = "#f5f5f5",
                                            "10,190,254"  = "#0abefe",
                                            "207,11,198" = "#cf0bc6",
                                            "250,202,0" = "#faca00",
                                            "0,176,80" = "#00b050",
                                            "255,0,0" = "#ff0000",
                                            "153,255,102" = "#99ff66",
                                            "255,252,4" = "#fffc04",
                                            "255,105,105" = "#ff6969",)

# highlight track for DMR
dmr16_ht <- HighlightTrack(trackList = list(dmr16_refgenes, 
                                            dmr16_chromHmmGm12878, 
                                            dmr16_chromHmmH1hesc,
                                            dmr16_chromHmmGmNhlf,
                                            axTrack),
                           start = dmr16_from,
                           end = dmr16_to, 
                           chromosome = 4, fill = "lightgrey", col = "lightgrey")


unique(c(dmr16_chromHmmGm12878@dp@pars$fill, 
         dmr16_chromHmmGmNhlf@dp@pars$fill, 
         dmr16_chromHmmH1hesc@dp@pars$fill))

png(here("figures",
         "linear_regression",
         "prenatal",
         "2023-01-04_dmr16_gviz.png"),
    height = 6, width = 10.5, units = "cm", res = 300)
plotTracks(list(dmr16_ht),  
           transcriptAnnotation = "symbol",
           geneAnnotation = "gene",
           showTitle = F)
dev.off()


# DMR 18
covariates_geno_ctpc_tech_cc_dmr_cpgs <- 
  cbind(covariates_geno_ctpc_tech_cc, 
        t(cb_betas_geno_cc_clean[combp_anno_df_es_sub_escutoff %>%
                                   subset(dmr == 18) %>%
                                   pull(Name),]))

# rename columns with numbers
colnames(covariates_geno_ctpc_tech_cc_dmr_cpgs)[197:198] <-
  combp_anno_df_es_sub_escutoff %>%
  subset(dmr == 18) %>%
  pull(pos)

# pivot to long
longdf_dmr18 <- 
  pivot_longer(covariates_geno_ctpc_tech_cc_dmr_cpgs %>% 
                 dplyr::select("113787113", "113787273",
                               sample_id, 
                               no2_prenatal_avg_2019v),
               cols = -c(sample_id, no2_prenatal_avg_2019v), 
               names_to = "cpg", 
               values_to = "dnam") %>%
  mutate(no2_colour = ifelse(no2_prenatal_avg_2019v < 7.32, "first",
                             ifelse(no2_prenatal_avg_2019v >=7.32 & 
                                      no2_prenatal_avg_2019v < 12.01 , "second",
                                    ifelse(no2_prenatal_avg_2019v >= 12.01  & 
                                             no2_prenatal_avg_2019v < 16.25, "third", "fourth")))) %>%
  mutate(no2_colour = factor(no2_colour, levels = c("first", "second",  "third", "fourth")))

# create charm-like visualization
dmr18_charm <- 
  ggplot(longdf_dmr18 %>% 
           subset(no2_colour %in% c("first", "fourth")) %>%
           group_by(cpg, no2_colour) %>%
           summarize(mean_dnam = mean(dnam)), 
         aes(x=as.numeric(cpg), y=mean_dnam, col = no2_colour)) +
  scale_color_manual(values = c("#254A90","red"), 
                     labels = c("First", "Third"),
                     name = "Prenatal NO2 quantile") +
  geom_line() + 
  geom_point(longdf_dmr18 %>% 
               subset(no2_colour %in% c("first", "fourth")), 
             mapping = aes(x=as.numeric(cpg), y=dnam, col = no2_colour),
             size = 0.25, alpha = 0.8) +
  theme_bw() +
  scale_x_continuous(name = "Genomic position (Chr12)") +
  scale_y_continuous(name = "DNA methylation (%)") +
  theme(axis.text = element_text(size = 9, family = "sans"),
        axis.title = element_text(size = 9, family = "sans"),
        panel.grid = element_blank(),
        legend.position = "none",
        panel.background = element_rect(fill = '#D3D3D3'))

ggsave(plot = dmr18_charm,
       filename = here("figures",
                       "linear_regression",
                       "prenatal",
                       "2023-01-03_dmr18_charm.png"),
       height = 6, width = 12, units = "cm")

# create genomic region visualization 
dmr18_from <- combp_anno_df_es_sub_escutoff %>%
  subset(dmr == 18) %>%
  pull(pos) %>% 
  min()
dmr18_to <- combp_anno_df_es_sub_escutoff %>%
  subset(dmr == 18) %>%
  pull(pos) %>% 
  max()

dmr18_refgenes <- UcscTrack(genome = "hg19", chromosome = "chr12", 
                            track = "NCBI RefSeq", 
                            table = "refGene",
                            from = dmr18_from, to = dmr18_to,
                            trackType = "GeneRegionTrack", 
                            rstarts = "exonStarts", rends = "exonEnds", 
                            gene = "name", symbol = "name", 
                            transcript = "name", strand = "strand", 
                            fill = "#254A90", name = "UCSC refGene")

# # add names
# dmr18_ranges <- ranges(dmr18_refgenes)
# 
# # gene refseq gene symbiks abd add to annotation 
# mcols(dmr18_ranges)$symbol <- mapIds(org.Hs.eg.db, 
#                                      gsub("\\.[1-9]$", "", mcols(dmr18_ranges)$symbol), 
#                                      "SYMBOL","REFSEQ")
# ranges(dmr18_refgenes) <- dmr18_ranges

# get regulatory info from ucsc
dmr18_chromHmmGm12878 <- UcscTrack(genome = "hg19", chromosome = "chr12", 
                                   track = "Broad ChromHMM",
                                   table = "wgEncodeBroadHmmGm12878HMM",
                                   trackType = "AnnotationTrack", 
                                   from = dmr18_from,
                                   to =   dmr18_to,
                                   start = "chromStart", end = "chromEnd", 
                                   id = "name", feature = "score", shape = "box", 
                                   stacking = "dense", fill = "itemRgb",
                                   name = "GM12878")

# colour according to hmm table 
dmr18_chromHmmGm12878@dp@pars$fill <- recode(dmr18_chromHmmGm12878@dp@pars$fill, 
                                             "245,245,245" = "#f5f5f5",
                                             "255,105,105" = "#ff6969",
                                             "153,255,102" = "#99ff66",
                                             "255,252,4" = "#fffc04",
                                             "127,127,127" = "#7f7f7f",
                                             "10,190,254" = "#0abefe",
                                             "207,11,198" = "#cf0bc6",
                                             "0,176,80" = "#00b050",
                                             "255,0,0" = "#ff0000",
                                             "250,202,0" = "#faca00")

dmr18_chromHmmGmNhlf <- UcscTrack(genome = "hg19", chromosome = "chr12",
                                  track = "Broad ChromHMM",
                                  table = "wgEncodeBroadHmmNhlfHMM",
                                  trackType = "AnnotationTrack",
                                  from = 113775000,
                                  to =   113795000,
                                  start = "chromStart", end = "chromEnd",
                                  id = "name", feature = "score", shape = "box",
                                  stacking = "dense", fill = "itemRgb",
                                  name = "NHLF")

dmr18_chromHmmGmNhlf@dp@pars$fill <- recode(dmr18_chromHmmGmNhlf@dp@pars$fill, 
                                            "250,202,0" = "#faca00",
                                            "255,0,0" = "#ff0000",
                                            "255,105,105" = "#ff6969",
                                            "245,245,245" = "#f5f5f5",
                                            "255,252,4" = "#fffc04",
                                            "10,190,254"  = "#0abefe",
                                            "127,127,127" = "#7f7f7f",
                                            "153,255,102" = "#99ff66",
                                            "0,176,80" = "#00b050",
                                            "207,11,198" = "#cf0bc6",
                                            "10,190,254"  = "#0abefe")

dmr18_chromHmmH1hesc <- UcscTrack(genome = "hg19", chromosome = "chr12", 
                                  track = "Broad ChromHMM",
                                  table = "wgEncodeBroadHmmH1hescHMM",
                                  trackType = "AnnotationTrack", 
                                  from = 113775000,
                                  to =   113795000,
                                  start = "chromStart", end = "chromEnd", 
                                  id = "name", feature = "score", shape = "box", 
                                  stacking = "dense", fill = "itemRgb",
                                  name = "hesc")

dmr18_chromHmmH1hesc@dp@pars$fill <- recode(dmr18_chromHmmH1hesc@dp@pars$fill,
                                            "127,127,127" = "#7f7f7f",
                                            "245,245,245" = "#f5f5f5",
                                            "10,190,254"  = "#0abefe",
                                            "207,11,198" = "#cf0bc6",
                                            "250,202,0" = "#faca00",
                                            "0,176,80" = "#00b050",
                                            "255,0,0" = "#ff0000",
                                            "153,255,102" = "#99ff66",
                                            "255,252,4" = "#fffc04",
                                            "255,105,105" = "#ff6969",)

# highlight track for DMR
dmr18_ht <- HighlightTrack(trackList = list(dmr18_refgenes, 
                                            dmr18_chromHmmGm12878, 
                                            dmr18_chromHmmH1hesc,
                                            dmr18_chromHmmGmNhlf,
                                            axTrack),
                           start = dmr18_from,
                           end = dmr18_to, 
                           chromosome = 12, fill = "lightgrey", col = "lightgrey")

unique(c(dmr18_chromHmmGm12878@dp@pars$fill, 
         dmr18_chromHmmGmNhlf@dp@pars$fill, 
         dmr18_chromHmmH1hesc@dp@pars$fill))

png(here("figures",
         "linear_regression",
         "prenatal",
         "2023-01-04_dmr18_gviz.png"),
    height = 6, width = 10.5, units = "cm", res = 300)
plotTracks(list(dmr18_ht),  
           transcriptAnnotation = "symbol",
           geneAnnotation = "gene",
           showTitle = F)
dev.off()


# DMR 19
covariates_geno_ctpc_tech_cc_dmr_cpgs <- 
  cbind(covariates_geno_ctpc_tech_cc, 
        t(cb_betas_geno_cc_clean[combp_anno_df_es_sub_escutoff %>%
                                   subset(dmr == 19) %>%
                                   pull(Name),]))

# rename columns with numbers
colnames(covariates_geno_ctpc_tech_cc_dmr_cpgs)[197:198] <-
  combp_anno_df_es_sub_escutoff %>%
  subset(dmr == 19) %>%
  pull(pos)

# pivot to long
longdf_dmr19 <- 
  pivot_longer(covariates_geno_ctpc_tech_cc_dmr_cpgs %>% 
                 dplyr::select("103780468", "103780364",
                               sample_id, 
                               no2_prenatal_avg_2019v),
               cols = -c(sample_id, no2_prenatal_avg_2019v), 
               names_to = "cpg", 
               values_to = "dnam") %>%
  mutate(no2_colour = ifelse(no2_prenatal_avg_2019v < 7.32, "first",
                             ifelse(no2_prenatal_avg_2019v >=7.32 & 
                                      no2_prenatal_avg_2019v < 12.01 , "second",
                                    ifelse(no2_prenatal_avg_2019v >= 12.01  & 
                                             no2_prenatal_avg_2019v < 16.25, "third", "fourth")))) %>%
  mutate(no2_colour = factor(no2_colour, levels = c("first", "second",  "third", "fourth")))

# create charm-like visualization
dmr19_charm <- 
  ggplot(longdf_dmr19 %>% 
           subset(no2_colour %in% c("first", "fourth")) %>%
           group_by(cpg, no2_colour) %>%
           summarize(mean_dnam = mean(dnam)), 
         aes(x=as.numeric(cpg), y=mean_dnam, col = no2_colour)) +
  scale_color_manual(values = c("#254A90","red"), 
                     labels = c("First", "Third"),
                     name = "Prenatal NO2 quantile") +
  geom_line() + 
  geom_point(longdf_dmr19 %>% 
               subset(no2_colour %in% c("first", "fourth")), 
             mapping = aes(x=as.numeric(cpg), y=dnam, col = no2_colour),
             size = 0.25, alpha = 0.8) +
  theme_bw() +
  scale_x_continuous(name = "Genomic position (Chr6)",
                     breaks = seq(103780380, 103780460,  by =40)) +
  scale_y_continuous(name = "DNA methylation (%)") +
  theme(axis.text = element_text(size = 9, family = "sans"),
        axis.title = element_text(size = 9, family = "sans"),
        panel.grid = element_blank(),
        legend.position = "none",
        panel.background = element_rect(fill = '#D3D3D3'))

ggsave(plot = dmr19_charm,
       filename = here("figures",
                       "linear_regression",
                       "prenatal",
                       "2023-01-03_dmr19_charm.png"),
       height = 6, width = 12, units = "cm")

# create genomic region visualization 
dmr19_from <- combp_anno_df_es_sub_escutoff %>%
  subset(dmr == 19) %>%
  pull(pos) %>% 
  min()
dmr19_to <- combp_anno_df_es_sub_escutoff %>%
  subset(dmr == 19) %>%
  pull(pos) %>% 
  max()

dmr19_refgenes <- UcscTrack(genome = "hg19", chromosome = "chr6", 
                            track = "NCBI RefSeq", 
                            table = "refGene",
                            from = dmr19_from, to = dmr19_to,
                            trackType = "GeneRegionTrack", 
                            rstarts = "exonStarts", rends = "exonEnds", 
                            gene = "name", symbol = "name", 
                            transcript = "name", strand = "strand", 
                            fill = "#254A90", name = "UCSC refGene")

# add names
# dmr19_ranges <- ranges(dmr19_refgenes)
# 
# # gene refseq gene symbiks abd add to annotation 
# mcols(dmr19_ranges)$symbol <- mapIds(org.Hs.eg.db, 
#                                      gsub("\\.[1-9]$", "", mcols(dmr19_ranges)$symbol), 
#                                      "SYMBOL","REFSEQ")
# ranges(dmr19_refgenes) <- dmr19_ranges

# get regulatory info from ucsc
dmr19_chromHmmGm12878 <- UcscTrack(genome = "hg19", chromosome = "chr6", 
                                   track = "Broad ChromHMM",
                                   table = "wgEncodeBroadHmmGm12878HMM",
                                   trackType = "AnnotationTrack", 
                                   from = dmr19_from,
                                   to =   dmr19_to,
                                   start = "chromStart", end = "chromEnd", 
                                   id = "name", feature = "score", shape = "box", 
                                   stacking = "dense", fill = "itemRgb",
                                   name = "GM12878")

# colour according to hmm table 
dmr19_chromHmmGm12878@dp@pars$fill <- recode(dmr19_chromHmmGm12878@dp@pars$fill, 
                                             "245,245,245" = "#f5f5f5",
                                             "255,105,105" = "#ff6969",
                                             "153,255,102" = "#99ff66",
                                             "255,252,4" = "#fffc04",
                                             "127,127,127" = "#7f7f7f",
                                             "10,190,254" = "#0abefe",
                                             "207,11,198" = "#cf0bc6",
                                             "0,176,80" = "#00b050",
                                             "255,0,0" = "#ff0000",
                                             "250,202,0" = "#faca00")

dmr19_chromHmmGmNhlf <- UcscTrack(genome = "hg19", chromosome = "chr6",
                                  track = "Broad ChromHMM",
                                  table = "wgEncodeBroadHmmNhlfHMM",
                                  trackType = "AnnotationTrack",
                                  from = dmr19_from,
                                  to = dmr19_to,
                                  start = "chromStart", end = "chromEnd",
                                  id = "name", feature = "score", shape = "box",
                                  stacking = "dense", fill = "itemRgb",
                                  name = "NHLF")

dmr19_chromHmmGmNhlf@dp@pars$fill <- recode(dmr19_chromHmmGmNhlf@dp@pars$fill, 
                                            "250,202,0" = "#faca00",
                                            "255,0,0" = "#ff0000",
                                            "255,105,105" = "#ff6969",
                                            "245,245,245" = "#f5f5f5",
                                            "255,252,4" = "#fffc04",
                                            "10,190,254"  = "#0abefe",
                                            "127,127,127" = "#7f7f7f",
                                            "153,255,102" = "#99ff66",
                                            "0,176,80" = "#00b050",
                                            "207,11,198" = "#cf0bc6",
                                            "10,190,254"  = "#0abefe")

dmr19_chromHmmH1hesc <- UcscTrack(genome = "hg19", chromosome = "chr6", 
                                  track = "Broad ChromHMM",
                                  table = "wgEncodeBroadHmmH1hescHMM",
                                  trackType = "AnnotationTrack", 
                                  from = dmr19_from,
                                  to =   dmr19_to,
                                  start = "chromStart", end = "chromEnd", 
                                  id = "name", feature = "score", shape = "box", 
                                  stacking = "dense", fill = "itemRgb",
                                  name = "hesc")

dmr19_chromHmmH1hesc@dp@pars$fill <- recode(dmr19_chromHmmH1hesc@dp@pars$fill,
                                            "127,127,127" = "#7f7f7f",
                                            "245,245,245" = "#f5f5f5",
                                            "10,190,254"  = "#0abefe",
                                            "207,11,198" = "#cf0bc6",
                                            "250,202,0" = "#faca00",
                                            "0,176,80" = "#00b050",
                                            "255,0,0" = "#ff0000",
                                            "153,255,102" = "#99ff66",
                                            "255,252,4" = "#fffc04",
                                            "255,105,105" = "#ff6969",)

# highlight track for DMR
dmr19_ht <- HighlightTrack(trackList = list(dmr19_refgenes, 
                                            dmr19_chromHmmGm12878, 
                                            dmr19_chromHmmH1hesc,
                                            dmr19_chromHmmGmNhlf,
                                            axTrack),
                           start = dmr19_from,
                           end = dmr19_to, 
                           chromosome = 6, fill = "lightgrey", col = "lightgrey")

unique(c(dmr19_chromHmmGm12878@dp@pars$fill, 
         dmr19_chromHmmGmNhlf@dp@pars$fill, 
         dmr19_chromHmmH1hesc@dp@pars$fill))

png(here("figures",
         "linear_regression",
         "prenatal",
         "2023-01-04_dmr19_gviz.png"),
    height = 6, width = 10.5, units = "cm", res = 300)
plotTracks(list(dmr19_ht),  
           transcriptAnnotation = "symbol",
           geneAnnotation = "gene",
           showTitle = F)
dev.off()



# DMR 20
covariates_geno_ctpc_tech_cc_dmr_cpgs <- 
  cbind(covariates_geno_ctpc_tech_cc, 
        t(cb_betas_geno_cc_clean[combp_anno_df_es_sub_escutoff %>%
                                   subset(dmr == 20) %>%
                                   pull(Name),]))

# rename columns with numbers
colnames(covariates_geno_ctpc_tech_cc_dmr_cpgs)[197:200] <-
  combp_anno_df_es_sub_escutoff %>%
  subset(dmr == 20) %>%
  pull(pos)

# pivot to long
longdf_dmr20 <- 
  pivot_longer(covariates_geno_ctpc_tech_cc_dmr_cpgs %>% 
                 dplyr::select("93653048", "93652766", "93653073", "93652950",
                               sample_id, 
                               no2_prenatal_avg_2019v),
               cols = -c(sample_id, no2_prenatal_avg_2019v), 
               names_to = "cpg", 
               values_to = "dnam") %>%
  mutate(no2_colour = ifelse(no2_prenatal_avg_2019v < 7.32, "first",
                             ifelse(no2_prenatal_avg_2019v >=7.32 & 
                                      no2_prenatal_avg_2019v < 12.01 , "second",
                                    ifelse(no2_prenatal_avg_2019v >= 12.01  & 
                                             no2_prenatal_avg_2019v < 16.25, "third", "fourth")))) %>%
  mutate(no2_colour = factor(no2_colour, levels = c("first", "second",  "third", "fourth")))

# create charm-like visualization
dmr20_charm <- 
  ggplot(longdf_dmr20 %>% 
           subset(no2_colour %in% c("first", "fourth")) %>%
           group_by(cpg, no2_colour) %>%
           summarize(mean_dnam = mean(dnam)), 
         aes(x=as.numeric(cpg), y=mean_dnam, col = no2_colour)) +
  scale_color_manual(values = c("#254A90","red"), 
                     labels = c("First", "Third"),
                     name = "Prenatal NO2 quantile") +
  geom_line() + 
  geom_point(longdf_dmr20 %>% 
               subset(no2_colour %in% c("first", "fourth")), 
             mapping = aes(x=as.numeric(cpg), y=dnam, col = no2_colour),
             size = 0.25, alpha = 0.8) +
  theme_bw() +
  scale_x_continuous(name = "Genomic position (Chr15)") +
  scale_y_continuous(name = "DNA methylation (%)") +
  theme(axis.text = element_text(size = 9, family = "sans"),
        axis.title = element_text(size = 9, family = "sans"),
        panel.grid = element_blank(),
        legend.position = "none",
        panel.background = element_rect(fill = '#D3D3D3'))

ggsave(plot = dmr20_charm,
       filename = here("figures",
                       "linear_regression",
                       "prenatal",
                       "2023-01-03_dmr20_charm.png"),
       height = 6, width = 12, units = "cm")


# create genomic region visualization 
dmr20_from <- combp_anno_df_es_sub_escutoff %>%
  subset(dmr == 20) %>%
  pull(pos) %>% 
  min()
dmr20_to <- combp_anno_df_es_sub_escutoff %>%
  subset(dmr == 20) %>%
  pull(pos) %>% 
  max()

dmr20_refgenes <- UcscTrack(genome = "hg19", chromosome = "chr15", 
                            track = "NCBI RefSeq", 
                            table = "refGene",
                            from = dmr20_from, to = dmr20_to,
                            trackType = "GeneRegionTrack", 
                            rstarts = "exonStarts", rends = "exonEnds", 
                            gene = "name", symbol = "name", 
                            transcript = "name", strand = "strand", 
                            fill = "#254A90", name = "UCSC refGene")

# # add names
# dmr20_ranges <- ranges(dmr20_refgenes)
# 
# # gene refseq gene symbiks abd add to annotation 
# mcols(dmr20_ranges)$symbol <- mapIds(org.Hs.eg.db, 
#                                      gsub("\\.[1-9]$", "", mcols(dmr20_ranges)$symbol), 
#                                      "SYMBOL","REFSEQ")
# ranges(dmr20_refgenes) <- dmr20_ranges

# get regulatory info from ucsc
dmr20_chromHmmGm12878 <- UcscTrack(genome = "hg19", chromosome = "chr15", 
                                   track = "Broad ChromHMM",
                                   table = "wgEncodeBroadHmmGm12878HMM",
                                   trackType = "AnnotationTrack", 
                                   from = 93650000,
                                  to = 93743073,
                                   start = "chromStart", end = "chromEnd", 
                                   id = "name", feature = "score", shape = "box", 
                                   stacking = "dense", fill = "itemRgb",
                                   name = "GM12878")

# colour according to hmm table 
dmr20_chromHmmGm12878@dp@pars$fill <- recode(dmr20_chromHmmGm12878@dp@pars$fill, 
                                             "245,245,245" = "#f5f5f5",
                                             "255,105,105" = "#ff6969",
                                             "153,255,102" = "#99ff66",
                                             "255,252,4" = "#fffc04",
                                             "127,127,127" = "#7f7f7f",
                                             "10,190,254" = "#0abefe",
                                             "207,11,198" = "#cf0bc6",
                                             "0,176,80" = "#00b050",
                                             "255,0,0" = "#ff0000",
                                             "250,202,0" = "#faca00")

dmr20_chromHmmGmNhlf <- UcscTrack(genome = "hg19", chromosome = "chr15",
                                  track = "Broad ChromHMM",
                                  table = "wgEncodeBroadHmmNhlfHMM",
                                  trackType = "AnnotationTrack",
                                  from = dmr20_from,
                                  to = dmr20_to,
                                  start = "chromStart", end = "chromEnd",
                                  id = "name", feature = "score", shape = "box",
                                  stacking = "dense", fill = "itemRgb",
                                  name = "NHLF")

dmr20_chromHmmGmNhlf@dp@pars$fill <- recode(dmr20_chromHmmGmNhlf@dp@pars$fill, 
                                            "250,202,0" = "#faca00",
                                            "255,0,0" = "#ff0000",
                                            "255,105,105" = "#ff6969",
                                            "245,245,245" = "#f5f5f5",
                                            "255,252,4" = "#fffc04",
                                            "10,190,254"  = "#0abefe",
                                            "127,127,127" = "#7f7f7f",
                                            "153,255,102" = "#99ff66",
                                            "0,176,80" = "#00b050",
                                            "207,11,198" = "#cf0bc6",
                                            "10,190,254"  = "#0abefe")

dmr20_chromHmmH1hesc <- UcscTrack(genome = "hg19", chromosome = "chr15", 
                                  track = "Broad ChromHMM",
                                  table = "wgEncodeBroadHmmH1hescHMM",
                                  trackType = "AnnotationTrack", 
                                  from = 93650000,
                                  to = 93743073,
                                  start = "chromStart", end = "chromEnd", 
                                  id = "name", feature = "score", shape = "box", 
                                  stacking = "dense", fill = "itemRgb",
                                  name = "hesc")


dmr20_chromHmmH1hesc@dp@pars$fill <- recode(dmr20_chromHmmH1hesc@dp@pars$fill,
                                            "127,127,127" = "#7f7f7f",
                                            "245,245,245" = "#f5f5f5",
                                            "10,190,254"  = "#0abefe",
                                            "207,11,198" = "#cf0bc6",
                                            "250,202,0" = "#faca00",
                                            "0,176,80" = "#00b050",
                                            "255,0,0" = "#ff0000",
                                            "153,255,102" = "#99ff66",
                                            "255,252,4" = "#fffc04",
                                            "255,105,105" = "#ff6969",)

# highlight track for DMR
dmr20_ht <- HighlightTrack(trackList = list(dmr20_refgenes, 
                                            dmr20_chromHmmGm12878, 
                                             dmr20_chromHmmH1hesc,
                                            dmr20_chromHmmGmNhlf,
                                            axTrack),
                           start = dmr20_from,
                           end = dmr20_to, 
                           chromosome = 15, fill = "lightgrey", col = "lightgrey")

unique(c(dmr20_chromHmmGm12878@dp@pars$fill, 
         dmr20_chromHmmGmNhlf@dp@pars$fill, 
         dmr20_chromHmmH1hesc@dp@pars$fill))

png(here("figures",
         "linear_regression",
         "prenatal",
         "2023-01-04_dmr20_gviz.png"),
    height = 6, width = 10.5, units = "cm", res = 300)
plotTracks(list(dmr20_ht),  
           transcriptAnnotation = "symbol",
           geneAnnotation = "gene",
           showTitle = F)
dev.off()



# DMR 21
covariates_geno_ctpc_tech_cc_dmr_cpgs <- 
  cbind(covariates_geno_ctpc_tech_cc, 
        t(cb_betas_geno_cc_clean[combp_anno_df_es_sub_escutoff %>%
                                   subset(dmr == 21) %>%
                                   pull(Name),]))

# rename columns with numbers
colnames(covariates_geno_ctpc_tech_cc_dmr_cpgs)[197:200] <-
  combp_anno_df_es_sub_escutoff %>%
  subset(dmr == 21) %>%
  pull(pos)

# pivot to long
longdf_dmr21 <- 
  pivot_longer(covariates_geno_ctpc_tech_cc_dmr_cpgs %>% 
                 dplyr::select("164393434", "164393586", "164393643", "164393351",
                               sample_id, 
                               no2_prenatal_avg_2019v),
               cols = -c(sample_id, no2_prenatal_avg_2019v), 
               names_to = "cpg", 
               values_to = "dnam") %>%
  mutate(no2_colour = ifelse(no2_prenatal_avg_2019v < 7.32, "first",
                             ifelse(no2_prenatal_avg_2019v >=7.32 & 
                                      no2_prenatal_avg_2019v < 12.01 , "second",
                                    ifelse(no2_prenatal_avg_2019v >= 12.01  & 
                                             no2_prenatal_avg_2019v < 16.25, "third", "fourth")))) %>%
  mutate(no2_colour = factor(no2_colour, levels = c("first", "second",  "third", "fourth")))

# create charm-like visualization
dmr21_charm <- 
  ggplot(longdf_dmr21 %>% 
           subset(no2_colour %in% c("first", "fourth")) %>%
           group_by(cpg, no2_colour) %>%
           summarize(mean_dnam = mean(dnam)), 
         aes(x=as.numeric(cpg), y=mean_dnam, col = no2_colour)) +
  scale_color_manual(values = c("#254A90","red"), 
                     labels = c("First", "Third"),
                     name = "Prenatal NO2 quantile") +
  geom_line() + 
  geom_point(longdf_dmr21 %>% 
               subset(no2_colour %in% c("first", "fourth")), 
             mapping = aes(x=as.numeric(cpg), y=dnam, col = no2_colour),
             size = 0.25, alpha = 0.8) +
  theme_bw() +
  scale_x_continuous(name = "Genomic position (Chr6)") +
  scale_y_continuous(name = "DNA methylation (%)") +
  theme(axis.text = element_text(size = 9, family = "sans"),
        axis.title = element_text(size = 9, family = "sans"),
        panel.grid = element_blank(),
        legend.position = "none",
        panel.background = element_rect(fill = '#D3D3D3'))

ggsave(plot = dmr21_charm,
       filename = here("figures",
                       "linear_regression",
                       "prenatal",
                       "2023-01-03_dmr21_charm.png"),
       height = 6, width = 12, units = "cm")


# create genomic region visualization 
dmr21_from <- combp_anno_df_es_sub_escutoff %>%
  subset(dmr == 21) %>%
  pull(pos) %>% 
  min()
dmr21_to <- combp_anno_df_es_sub_escutoff %>%
  subset(dmr == 21) %>%
  pull(pos) %>% 
  max()

dmr21_refgenes <- UcscTrack(genome = "hg19", chromosome = "chr6", 
                            track = "NCBI RefSeq", 
                            table = "refGene",
                            from = dmr21_from, to = dmr21_to,
                            trackType = "GeneRegionTrack", 
                            rstarts = "exonStarts", rends = "exonEnds", 
                            gene = "name", symbol = "name", 
                            transcript = "name", strand = "strand", 
                            fill = "#254A90", name = "UCSC refGene")

# add names
# dmr21_ranges <- ranges(dmr21_refgenes)
# 
# # gene refseq gene symbiks abd add to annotation 
# mcols(dmr21_ranges)$symbol <- mapIds(org.Hs.eg.db, 
#                                      gsub("\\.[1-9]$", "", mcols(dmr21_ranges)$symbol), 
#                                      "SYMBOL","REFSEQ")
# ranges(dmr21_refgenes) <- dmr21_ranges

# get regulatory info from ucsc
dmr21_chromHmmGm12878 <- UcscTrack(genome = "hg19", chromosome = "chr6", 
                                   track = "Broad ChromHMM",
                                   table = "wgEncodeBroadHmmGm12878HMM",
                                   trackType = "AnnotationTrack", 
                                   from = dmr21_from,
                                   to =   164490000,
                                   start = "chromStart", end = "chromEnd", 
                                   id = "name", feature = "score", shape = "box", 
                                   stacking = "dense", fill = "itemRgb",
                                   name = "GM12878")

# colour according to hmm table 
dmr21_chromHmmGm12878@dp@pars$fill <- recode(dmr21_chromHmmGm12878@dp@pars$fill, 
                                             "245,245,245" = "#f5f5f5",
                                             "255,105,105" = "#ff6969",
                                             "153,255,102" = "#99ff66",
                                             "255,252,4" = "#fffc04",
                                             "127,127,127" = "#7f7f7f",
                                             "10,190,254" = "#0abefe",
                                             "207,11,198" = "#cf0bc6",
                                             "0,176,80" = "#00b050",
                                             "255,0,0" = "#ff0000",
                                             "250,202,0" = "#faca00")

dmr21_chromHmmGmNhlf <- UcscTrack(genome = "hg19", chromosome = "chr6",
                                  track = "Broad ChromHMM",
                                  table = "wgEncodeBroadHmmNhlfHMM",
                                  trackType = "AnnotationTrack",
                                  from = dmr21_from,
                                  to = dmr21_to,
                                  start = "chromStart", end = "chromEnd",
                                  id = "name", feature = "score", shape = "box",
                                  stacking = "dense", fill = "itemRgb",
                                  name = "NHLF")

dmr21_chromHmmGmNhlf@dp@pars$fill <- recode(dmr21_chromHmmGmNhlf@dp@pars$fill, 
                                            "250,202,0" = "#faca00",
                                            "255,0,0" = "#ff0000",
                                            "255,105,105" = "#ff6969",
                                            "245,245,245" = "#f5f5f5",
                                            "255,252,4" = "#fffc04",
                                            "10,190,254"  = "#0abefe",
                                            "127,127,127" = "#7f7f7f",
                                            "153,255,102" = "#99ff66",
                                            "0,176,80" = "#00b050",
                                            "207,11,198" = "#cf0bc6",
                                            "10,190,254"  = "#0abefe")

dmr21_chromHmmH1hesc <- UcscTrack(genome = "hg19", chromosome = "chr6", 
                                  track = "Broad ChromHMM",
                                  table = "wgEncodeBroadHmmH1hescHMM",
                                  trackType = "AnnotationTrack", 
                                  from = dmr21_from,
                                  to =   164490000,
                                  start = "chromStart", end = "chromEnd", 
                                  id = "name", feature = "score", shape = "box", 
                                  stacking = "dense", fill = "itemRgb",
                                  name = "hesc")


dmr21_chromHmmH1hesc@dp@pars$fill <- recode(dmr21_chromHmmH1hesc@dp@pars$fill,
                                            "127,127,127" = "#7f7f7f",
                                            "245,245,245" = "#f5f5f5",
                                            "10,190,254"  = "#0abefe",
                                            "207,11,198" = "#cf0bc6",
                                            "250,202,0" = "#faca00",
                                            "0,176,80" = "#00b050",
                                            "255,0,0" = "#ff0000",
                                            "153,255,102" = "#99ff66",
                                            "255,252,4" = "#fffc04",
                                            "255,105,105" = "#ff6969",)

# highlight track for DMR
dmr21_ht <- HighlightTrack(trackList = list(dmr21_refgenes, 
                                            dmr21_chromHmmGm12878, 
                                            dmr21_chromHmmH1hesc,
                                            dmr21_chromHmmGmNhlf,
                                            axTrack),
                           start = dmr21_from,
                           end = dmr21_to, 
                           chromosome = 6, fill = "lightgrey", col = "lightgrey")


unique(c(dmr21_chromHmmGm12878@dp@pars$fill, 
         dmr21_chromHmmGmNhlf@dp@pars$fill, 
         dmr21_chromHmmH1hesc@dp@pars$fill))

png(here("figures",
         "linear_regression",
         "prenatal",
         "2023-01-04_dmr21_gviz.png"),
    height = 6, width = 10.5, units = "cm", res = 300)
plotTracks(list(dmr21_ht),  
           transcriptAnnotation = "symbol",
           geneAnnotation = "gene",
           showTitle = F)
dev.off()



# DMR 23
covariates_geno_ctpc_tech_cc_dmr_cpgs <- 
  cbind(covariates_geno_ctpc_tech_cc, 
        t(cb_betas_geno_cc_clean[combp_anno_df_es_sub_escutoff %>%
                                   subset(dmr == 23) %>%
                                   pull(Name),]))

# rename columns with numbers
colnames(covariates_geno_ctpc_tech_cc_dmr_cpgs)[197:199] <-
  combp_anno_df_es_sub_escutoff %>%
  subset(dmr == 23) %>%
  pull(pos)

# pivot to long
longdf_dmr23 <- 
  pivot_longer(covariates_geno_ctpc_tech_cc_dmr_cpgs %>% 
                 dplyr::select("7486615", "7486562", "7486551",
                               sample_id, 
                               no2_prenatal_avg_2019v),
               cols = -c(sample_id, no2_prenatal_avg_2019v), 
               names_to = "cpg", 
               values_to = "dnam") %>%
  mutate(no2_colour = ifelse(no2_prenatal_avg_2019v < 7.32, "first",
                             ifelse(no2_prenatal_avg_2019v >=7.32 & 
                                      no2_prenatal_avg_2019v < 12.01 , "second",
                                    ifelse(no2_prenatal_avg_2019v >= 12.01  & 
                                             no2_prenatal_avg_2019v < 16.25, "third", "fourth")))) %>%
  mutate(no2_colour = factor(no2_colour, levels = c("first", "second",  "third", "fourth")))

# create charm-like visualization
dmr23_charm <- 
  ggplot(longdf_dmr23 %>% 
           subset(no2_colour %in% c("first", "fourth")) %>%
           group_by(cpg, no2_colour) %>%
           summarize(mean_dnam = mean(dnam)), 
         aes(x=as.numeric(cpg), y=mean_dnam, col = no2_colour)) +
  scale_color_manual(values = c("#254A90","red"), 
                     labels = c("First", "Third"),
                     name = "Prenatal NO2 quantile") +
  geom_line() + 
  geom_point(longdf_dmr23 %>% 
               subset(no2_colour %in% c("first", "fourth")), 
             mapping = aes(x=as.numeric(cpg), y=dnam, col = no2_colour),
             size = 0.25, alpha = 0.8) +
  theme_bw() +
  scale_x_continuous(name = "Genomic position (Chr17)") +
  scale_y_continuous(name = "DNA methylation (%)") +
  theme(axis.text = element_text(size = 9, family = "sans"),
        axis.title = element_text(size = 9, family = "sans"),
        panel.grid = element_blank(),
        legend.position = "none",
        panel.background = element_rect(fill = '#D3D3D3'))

ggsave(plot = dmr23_charm,
       filename = here("figures",
                       "linear_regression",
                       "prenatal",
                       "2023-01-03_dmr23_charm.png"),
       height = 6, width = 12, units = "cm")


# create genomic region visualization 
dmr23_from <- combp_anno_df_es_sub_escutoff %>%
  subset(dmr == 23) %>%
  pull(pos) %>% 
  min()
dmr23_to <- combp_anno_df_es_sub_escutoff %>%
  subset(dmr == 23) %>%
  pull(pos) %>% 
  max()

dmr23_refgenes <- UcscTrack(genome = "hg19", chromosome = "chr17", 
                            track = "NCBI RefSeq", 
                            table = "refGene",
                            from = dmr23_from, to = 7491000,
                            trackType = "GeneRegionTrack", 
                            rstarts = "exonStarts", rends = "exonEnds", 
                            gene = "name", symbol = "name", 
                            transcript = "name", strand = "strand", 
                            fill = "#254A90", name = "UCSC refGene")

# add names
dmr23_ranges <- ranges(dmr23_refgenes)

# gene refseq gene symbiks abd add to annotation 
mcols(dmr23_ranges)$symbol <- mapIds(org.Hs.eg.db, 
                                     gsub("\\.[1-9]$", "", mcols(dmr23_ranges)$symbol), 
                                     "SYMBOL","REFSEQ")
ranges(dmr23_refgenes) <- dmr23_ranges

# get regulatory info from ucsc
dmr23_chromHmmGm12878 <- UcscTrack(genome = "hg19", chromosome = "chr17", 
                                   track = "Broad ChromHMM",
                                   table = "wgEncodeBroadHmmGm12878HMM",
                                   trackType = "AnnotationTrack", 
                                   from = dmr23_from,
                                   to =   7491000,
                                   start = "chromStart", end = "chromEnd", 
                                   id = "name", feature = "score", shape = "box", 
                                   stacking = "dense", fill = "itemRgb",
                                   name = "GM12878")

# colour according to hmm table 
dmr23_chromHmmGm12878@dp@pars$fill <- recode(dmr23_chromHmmGm12878@dp@pars$fill, 
                                             "245,245,245" = "#f5f5f5",
                                             "255,105,105" = "#ff6969",
                                             "153,255,102" = "#99ff66",
                                             "255,252,4" = "#fffc04",
                                             "127,127,127" = "#7f7f7f",
                                             "10,190,254" = "#0abefe",
                                             "207,11,198" = "#cf0bc6",
                                             "0,176,80" = "#00b050",
                                             "255,0,0" = "#ff0000",
                                             "250,202,0" = "#faca00")

dmr23_chromHmmGmNhlf <- UcscTrack(genome = "hg19", chromosome = "chr17",
                                  track = "Broad ChromHMM",
                                  table = "wgEncodeBroadHmmNhlfHMM",
                                  trackType = "AnnotationTrack",
                                  from = 7485500,
                                  to = 7491000,
                                  start = "chromStart", end = "chromEnd",
                                  id = "name", feature = "score", shape = "box",
                                  stacking = "dense", fill = "itemRgb",
                                  name = "NHLF")

dmr23_chromHmmGmNhlf@dp@pars$fill <- recode(dmr23_chromHmmGmNhlf@dp@pars$fill, 
                                            "250,202,0" = "#faca00",
                                            "255,0,0" = "#ff0000",
                                            "255,105,105" = "#ff6969",
                                            "245,245,245" = "#f5f5f5",
                                            "255,252,4" = "#fffc04",
                                            "10,190,254"  = "#0abefe",
                                            "127,127,127" = "#7f7f7f",
                                            "153,255,102" = "#99ff66",
                                            "0,176,80" = "#00b050",
                                            "207,11,198" = "#cf0bc6",
                                            "10,190,254"  = "#0abefe")

dmr23_chromHmmH1hesc <- UcscTrack(genome = "hg19", chromosome = "chr17", 
                                  track = "Broad ChromHMM",
                                  table = "wgEncodeBroadHmmH1hescHMM",
                                  trackType = "AnnotationTrack", 
                                  from = 7485500,
                                  to =   7491000,
                                  start = "chromStart", end = "chromEnd", 
                                  id = "name", feature = "score", shape = "box", 
                                  stacking = "dense", fill = "itemRgb",
                                  name = "hesc")

dmr23_chromHmmH1hesc@dp@pars$fill <- recode(dmr23_chromHmmH1hesc@dp@pars$fill,
                                            "127,127,127" = "#7f7f7f",
                                            "245,245,245" = "#f5f5f5",
                                            "10,190,254"  = "#0abefe",
                                            "207,11,198" = "#cf0bc6",
                                            "250,202,0" = "#faca00",
                                            "0,176,80" = "#00b050",
                                            "255,0,0" = "#ff0000",
                                            "153,255,102" = "#99ff66",
                                            "255,252,4" = "#fffc04",
                                            "255,105,105" = "#ff6969",)

# highlight track for DMR
dmr23_ht <- HighlightTrack(trackList = list(dmr23_refgenes, 
                                            dmr23_chromHmmGm12878, 
                                            dmr23_chromHmmH1hesc,
                                            dmr23_chromHmmGmNhlf,
                                            axTrack),
                           start = dmr23_from,
                           end = dmr23_to, 
                           chromosome = 17, fill = "lightgrey", col = "lightgrey")

unique(c(dmr23_chromHmmGm12878@dp@pars$fill, 
         dmr23_chromHmmGmNhlf@dp@pars$fill, 
         dmr23_chromHmmH1hesc@dp@pars$fill))

png(here("figures",
         "linear_regression",
         "prenatal",
         "2023-01-04_dmr23_gviz.png"),
    height = 6, width = 10.5, units = "cm", res = 300)
plotTracks(list(dmr23_ht),  
           transcriptAnnotation = "symbol",
           geneAnnotation = "gene",
           showTitle = F)
dev.off()


# DMR 24
covariates_geno_ctpc_tech_cc_dmr_cpgs <- 
  cbind(covariates_geno_ctpc_tech_cc, 
        t(cb_betas_geno_cc_clean[combp_anno_df_es_sub_escutoff %>%
                                   subset(dmr == 24) %>%
                                   pull(Name),]))

# rename columns with numbers
colnames(covariates_geno_ctpc_tech_cc_dmr_cpgs)[197:198] <-
  combp_anno_df_es_sub_escutoff %>%
  subset(dmr == 24) %>%
  pull(pos)

# pivot to long
longdf_dmr24 <- 
  pivot_longer(covariates_geno_ctpc_tech_cc_dmr_cpgs %>% 
                 dplyr::select("27225865", "27225855",
                               sample_id, 
                               no2_prenatal_avg_2019v),
               cols = -c(sample_id, no2_prenatal_avg_2019v), 
               names_to = "cpg", 
               values_to = "dnam") %>%
  mutate(no2_colour = ifelse(no2_prenatal_avg_2019v < 7.32, "first",
                             ifelse(no2_prenatal_avg_2019v >=7.32 & 
                                      no2_prenatal_avg_2019v < 12.01 , "second",
                                    ifelse(no2_prenatal_avg_2019v >= 12.01  & 
                                             no2_prenatal_avg_2019v < 16.25, "third", "fourth")))) %>%
  mutate(no2_colour = factor(no2_colour, levels = c("first", "second",  "third", "fourth")))

# create charm-like visualization
dmr24_charm <- 
  ggplot(longdf_dmr24 %>% 
           subset(no2_colour %in% c("first", "fourth")) %>%
           group_by(cpg, no2_colour) %>%
           summarize(mean_dnam = mean(dnam)), 
         aes(x=as.numeric(cpg), y=mean_dnam, col = no2_colour)) +
  scale_color_manual(values = c("#254A90","red"), 
                     labels = c("First", "Third"),
                     name = "Prenatal NO2 quantile") +
  geom_line() + 
  geom_point(longdf_dmr24 %>% 
               subset(no2_colour %in% c("first", "fourth")), 
             mapping = aes(x=as.numeric(cpg), y=dnam, col = no2_colour),
             size = 0.25, alpha = 0.8) +
  theme_bw() +
  scale_x_continuous(name = "Genomic position (Chr7)",
                     breaks = seq(27225856, 27225864, by = 4)) +
  scale_y_continuous(name = "DNA methylation (%)") +
  theme(axis.text = element_text(size = 9, family = "sans"),
        axis.title = element_text(size = 9, family = "sans"),
        panel.grid = element_blank(),
        legend.position = "none",
        panel.background = element_rect(fill = '#D3D3D3'))

ggsave(plot = dmr24_charm,
       filename = here("figures",
                       "linear_regression",
                       "prenatal",
                       "2023-01-03_dmr24_charm.png"),
       height = 6, width = 12, units = "cm")


# create genomic region visualization 
dmr24_from <- combp_anno_df_es_sub_escutoff %>%
  subset(dmr == 24) %>%
  pull(pos) %>% 
  min()
dmr24_to <- combp_anno_df_es_sub_escutoff %>%
  subset(dmr == 24) %>%
  pull(pos) %>% 
  max()

dmr24_refgenes <- UcscTrack(genome = "hg19", chromosome = "chr7", 
                            track = "NCBI RefSeq", 
                            table = "refGene",
                            from = 27220700, to = dmr24_to,
                            trackType = "GeneRegionTrack", 
                            rstarts = "exonStarts", rends = "exonEnds", 
                            gene = "name", symbol = "name", 
                            transcript = "name", strand = "strand", 
                            fill = "#254A90", name = "UCSC refGene")

# add names
dmr24_ranges <- ranges(dmr24_refgenes)

# gene refseq gene symbiks abd add to annotation 
mcols(dmr24_ranges)$symbol <- mapIds(org.Hs.eg.db, 
                                     gsub("\\.[1-9]$", "", mcols(dmr24_ranges)$symbol), 
                                     "SYMBOL","REFSEQ")
ranges(dmr24_refgenes) <- dmr24_ranges

# get regulatory info from ucsc
dmr24_chromHmmGm12878 <- UcscTrack(genome = "hg19", chromosome = "chr7", 
                                   track = "Broad ChromHMM",
                                   table = "wgEncodeBroadHmmGm12878HMM",
                                   trackType = "AnnotationTrack", 
                                   from = 27220700,
                                   to =   dmr24_to,
                                   start = "chromStart", end = "chromEnd", 
                                   id = "name", feature = "score", shape = "box", 
                                   stacking = "dense", fill = "itemRgb",
                                   name = "GM12878")

# colour according to hmm table 
dmr24_chromHmmGm12878@dp@pars$fill <- recode(dmr24_chromHmmGm12878@dp@pars$fill, 
                                             "245,245,245" = "#f5f5f5",
                                             "255,105,105" = "#ff6969",
                                             "153,255,102" = "#99ff66",
                                             "255,252,4" = "#fffc04",
                                             "127,127,127" = "#7f7f7f",
                                             "10,190,254" = "#0abefe",
                                             "207,11,198" = "#cf0bc6",
                                             "0,176,80" = "#00b050",
                                             "255,0,0" = "#ff0000",
                                             "250,202,0" = "#faca00")

dmr24_chromHmmGmNhlf <- UcscTrack(genome = "hg19", chromosome = "chr7",
                                  track = "Broad ChromHMM",
                                  table = "wgEncodeBroadHmmNhlfHMM",
                                  trackType = "AnnotationTrack",
                                  from = 27220700,
                                  to = 27235865,
                                  start = "chromStart", end = "chromEnd",
                                  id = "name", feature = "score", shape = "box",
                                  stacking = "dense", fill = "itemRgb",
                                  name = "NHLF")

dmr24_chromHmmGmNhlf@dp@pars$fill <- recode(dmr24_chromHmmGmNhlf@dp@pars$fill, 
                                            "250,202,0" = "#faca00",
                                            "255,0,0" = "#ff0000",
                                            "255,105,105" = "#ff6969",
                                            "245,245,245" = "#f5f5f5",
                                            "255,252,4" = "#fffc04",
                                            "10,190,254"  = "#0abefe",
                                            "127,127,127" = "#7f7f7f",
                                            "153,255,102" = "#99ff66",
                                            "0,176,80" = "#00b050",
                                            "207,11,198" = "#cf0bc6",
                                            "10,190,254"  = "#0abefe")

dmr24_chromHmmH1hesc <- UcscTrack(genome = "hg19", chromosome = "chr7", 
                                  track = "Broad ChromHMM",
                                  table = "wgEncodeBroadHmmH1hescHMM",
                                  trackType = "AnnotationTrack", 
                                  from = 27220700,
                                  to =   27235865,
                                  start = "chromStart", end = "chromEnd", 
                                  id = "name", feature = "score", shape = "box", 
                                  stacking = "dense", fill = "itemRgb",
                                  name = "hesc")

dmr24_chromHmmH1hesc@dp@pars$fill <- recode(dmr24_chromHmmH1hesc@dp@pars$fill,
                                            "127,127,127" = "#7f7f7f",
                                            "245,245,245" = "#f5f5f5",
                                            "10,190,254"  = "#0abefe",
                                            "207,11,198" = "#cf0bc6",
                                            "250,202,0" = "#faca00",
                                            "0,176,80" = "#00b050",
                                            "255,0,0" = "#ff0000",
                                            "153,255,102" = "#99ff66",
                                            "255,252,4" = "#fffc04",
                                            "255,105,105" = "#ff6969",)

# highlight track for DMR
dmr24_ht <- HighlightTrack(trackList = list(dmr24_refgenes, 
                                            dmr24_chromHmmGm12878, 
                                            dmr24_chromHmmH1hesc,
                                            dmr24_chromHmmGmNhlf,
                                            axTrack),
                           start = dmr24_from,
                           end = dmr24_to, 
                           chromosome = 7, fill = "lightgrey", col = "lightgrey")

unique(c(dmr24_chromHmmGm12878@dp@pars$fill, 
         dmr24_chromHmmGmNhlf@dp@pars$fill, 
         dmr24_chromHmmH1hesc@dp@pars$fill))

png(here("figures",
         "linear_regression",
         "prenatal",
         "2023-01-04_dmr24_gviz.png"),
    height = 6, width = 10.5, units = "cm", res = 300)
plotTracks(list(dmr24_ht),  
           transcriptAnnotation = "symbol",
           geneAnnotation = "gene",
           showTitle = F)
dev.off()


# DMR 25
covariates_geno_ctpc_tech_cc_dmr_cpgs <- 
  cbind(covariates_geno_ctpc_tech_cc, 
        t(cb_betas_geno_cc_clean[combp_anno_df_es_sub_escutoff %>%
                                   subset(dmr == 25) %>%
                                   pull(Name),]))

# rename columns with numbers
colnames(covariates_geno_ctpc_tech_cc_dmr_cpgs)[197:198] <-
  combp_anno_df_es_sub_escutoff %>%
  subset(dmr == 25) %>%
  pull(pos)

# pivot to long
longdf_dmr25 <- 
  pivot_longer(covariates_geno_ctpc_tech_cc_dmr_cpgs %>% 
                 dplyr::select("180646754", "180646880",
                               sample_id, 
                               no2_prenatal_avg_2019v),
               cols = -c(sample_id, no2_prenatal_avg_2019v), 
               names_to = "cpg", 
               values_to = "dnam") %>%
  mutate(no2_colour = ifelse(no2_prenatal_avg_2019v < 7.32, "first",
                             ifelse(no2_prenatal_avg_2019v >=7.32 & 
                                      no2_prenatal_avg_2019v < 12.01 , "second",
                                    ifelse(no2_prenatal_avg_2019v >= 12.01  & 
                                             no2_prenatal_avg_2019v < 16.25, "third", "fourth")))) %>%
  mutate(no2_colour = factor(no2_colour, levels = c("first", "second",  "third", "fourth")))

# create charm-like visualization
dmr25_charm <- 
  ggplot(longdf_dmr25 %>% 
           subset(no2_colour %in% c("first", "fourth")) %>%
           group_by(cpg, no2_colour) %>%
           summarize(mean_dnam = mean(dnam)), 
         aes(x=as.numeric(cpg), y=mean_dnam, col = no2_colour)) +
  scale_color_manual(values = c("#254A90","red"), 
                     labels = c("First", "Third"),
                     name = "Prenatal NO2 quantile") +
  geom_line() + 
  geom_point(longdf_dmr25 %>% 
               subset(no2_colour %in% c("first", "fourth")), 
             mapping = aes(x=as.numeric(cpg), y=dnam, col = no2_colour),
             size = 0.25, alpha = 0.8) +
  theme_bw() +
  scale_x_continuous(name = "Genomic position (Chr5)",
                     breaks = seq(180646775, 180646875, by = 50)) +
  scale_y_continuous(name = "DNA methylation (%)") +
  theme(axis.text = element_text(size = 9, family = "sans"),
        axis.title = element_text(size = 9, family = "sans"),
        panel.grid = element_blank(),
        legend.position = "none",
        panel.background = element_rect(fill = '#D3D3D3'))

ggsave(plot = dmr25_charm,
       filename = here("figures",
                       "linear_regression",
                       "prenatal",
                       "2023-01-03_dmr25_charm.png"),
       height = 6, width = 12, units = "cm")

# create genomic region visualization 
dmr25_from <- combp_anno_df_es_sub_escutoff %>%
  subset(dmr == 25) %>%
  pull(pos) %>% 
  min()
dmr25_to <- combp_anno_df_es_sub_escutoff %>%
  subset(dmr == 25) %>%
  pull(pos) %>% 
  max()

dmr25_refgenes <- UcscTrack(genome = "hg19", chromosome = "chr5", 
                            track = "NCBI RefSeq", 
                            table = "refGene",
                            from = dmr25_from, to = dmr25_to,
                            trackType = "GeneRegionTrack", 
                            rstarts = "exonStarts", rends = "exonEnds", 
                            gene = "name", symbol = "name", 
                            transcript = "name", strand = "strand", 
                            fill = "#254A90", name = "UCSC refGene")

# add names
# dmr25_ranges <- ranges(dmr25_refgenes)
# 
# # gene refseq gene symbiks abd add to annotation 
# mcols(dmr25_ranges)$symbol <- mapIds(org.Hs.eg.db, 
#                                      gsub("\\.[1-9]$", "", mcols(dmr25_ranges)$symbol), 
#                                      "SYMBOL","REFSEQ")
# ranges(dmr25_refgenes) <- dmr25_ranges

# get regulatory info from ucsc
dmr25_chromHmmGm12878 <- UcscTrack(genome = "hg19", chromosome = "chr5", 
                                   track = "Broad ChromHMM",
                                   table = "wgEncodeBroadHmmGm12878HMM",
                                   trackType = "AnnotationTrack", 
                                   from = dmr25_from,
                                   to =   dmr25_to,
                                   start = "chromStart", end = "chromEnd", 
                                   id = "name", feature = "score", shape = "box", 
                                   stacking = "dense", fill = "itemRgb",
                                   name = "GM12878")

# colour according to hmm table 
dmr25_chromHmmGm12878@dp@pars$fill <- recode(dmr25_chromHmmGm12878@dp@pars$fill, 
                                             "245,245,245" = "#f5f5f5",
                                             "255,105,105" = "#ff6969",
                                             "153,255,102" = "#99ff66",
                                             "255,252,4" = "#fffc04",
                                             "127,127,127" = "#7f7f7f",
                                             "10,190,254" = "#0abefe",
                                             "207,11,198" = "#cf0bc6",
                                             "0,176,80" = "#00b050",
                                             "255,0,0" = "#ff0000",
                                             "250,202,0" = "#faca00")

dmr25_chromHmmGmNhlf <- UcscTrack(genome = "hg19", chromosome = "chr5",
                                  track = "Broad ChromHMM",
                                  table = "wgEncodeBroadHmmNhlfHMM",
                                  trackType = "AnnotationTrack",
                                  from = dmr25_from,
                                  to = dmr25_to,
                                  start = "chromStart", end = "chromEnd",
                                  id = "name", feature = "score", shape = "box",
                                  stacking = "dense", fill = "itemRgb",
                                  name = "NHLF")

dmr25_chromHmmGmNhlf@dp@pars$fill <- recode(dmr25_chromHmmGmNhlf@dp@pars$fill, 
                                            "250,202,0" = "#faca00",
                                            "255,0,0" = "#ff0000",
                                            "255,105,105" = "#ff6969",
                                            "245,245,245" = "#f5f5f5",
                                            "255,252,4" = "#fffc04",
                                            "10,190,254"  = "#0abefe",
                                            "127,127,127" = "#7f7f7f",
                                            "153,255,102" = "#99ff66",
                                            "0,176,80" = "#00b050",
                                            "207,11,198" = "#cf0bc6",
                                            "10,190,254"  = "#0abefe")

dmr25_chromHmmH1hesc <- UcscTrack(genome = "hg19", chromosome = "chr5", 
                                  track = "Broad ChromHMM",
                                  table = "wgEncodeBroadHmmH1hescHMM",
                                  trackType = "AnnotationTrack", 
                                  from = dmr25_from,
                                  to =   dmr25_to,
                                  start = "chromStart", end = "chromEnd", 
                                  id = "name", feature = "score", shape = "box", 
                                  stacking = "dense", fill = "itemRgb",
                                  name = "hesc")

dmr25_chromHmmH1hesc@dp@pars$fill <- recode(dmr25_chromHmmH1hesc@dp@pars$fill,
                                            "127,127,127" = "#7f7f7f",
                                            "245,245,245" = "#f5f5f5",
                                            "10,190,254"  = "#0abefe",
                                            "207,11,198" = "#cf0bc6",
                                            "250,202,0" = "#faca00",
                                            "0,176,80" = "#00b050",
                                            "255,0,0" = "#ff0000",
                                            "153,255,102" = "#99ff66",
                                            "255,252,4" = "#fffc04",
                                            "255,105,105" = "#ff6969",)

# highlight track for DMR
dmr25_ht <- HighlightTrack(trackList = list(dmr25_refgenes, 
                                            dmr25_chromHmmGm12878, 
                                            dmr25_chromHmmH1hesc,
                                            dmr25_chromHmmGmNhlf,
                                            axTrack),
                           start = dmr25_from,
                           end = dmr25_to, 
                           chromosome = 5, fill = "lightgrey", col = "lightgrey")

unique(c(dmr25_chromHmmGm12878@dp@pars$fill, 
         dmr25_chromHmmGmNhlf@dp@pars$fill, 
         dmr25_chromHmmH1hesc@dp@pars$fill))

png(here("figures",
         "linear_regression",
         "prenatal",
         "2023-01-04_dmr25_gviz.png"),
    height = 6, width = 10.5, units = "cm", res = 300)
plotTracks(list(dmr25_ht),  
           transcriptAnnotation = "symbol",
           geneAnnotation = "gene",
           showTitle = F)
dev.off()


# DMR 27
covariates_geno_ctpc_tech_cc_dmr_cpgs <- 
  cbind(covariates_geno_ctpc_tech_cc, 
        t(cb_betas_geno_cc_clean[combp_anno_df_es_sub_escutoff %>%
                                   subset(dmr == 27) %>%
                                   pull(Name),]))

# rename columns with numbers
colnames(covariates_geno_ctpc_tech_cc_dmr_cpgs)[197:198] <-
  combp_anno_df_es_sub_escutoff %>%
  subset(dmr == 27) %>%
  pull(pos)

# pivot to long
longdf_dmr27 <- 
  pivot_longer(covariates_geno_ctpc_tech_cc_dmr_cpgs %>% 
                 dplyr::select("126409007", "126409061",
                               sample_id, 
                               no2_prenatal_avg_2019v),
               cols = -c(sample_id, no2_prenatal_avg_2019v), 
               names_to = "cpg", 
               values_to = "dnam") %>%
  mutate(no2_colour = ifelse(no2_prenatal_avg_2019v < 7.32, "first",
                             ifelse(no2_prenatal_avg_2019v >=7.32 & 
                                      no2_prenatal_avg_2019v < 12.01 , "second",
                                    ifelse(no2_prenatal_avg_2019v >= 12.01  & 
                                             no2_prenatal_avg_2019v < 16.25, "third", "fourth")))) %>%
  mutate(no2_colour = factor(no2_colour, levels = c("first", "second",  "third", "fourth")))

# create charm-like visualization
dmr27_charm <- 
  ggplot(longdf_dmr27 %>% 
           subset(no2_colour %in% c("first", "fourth")) %>%
           group_by(cpg, no2_colour) %>%
           summarize(mean_dnam = mean(dnam)), 
         aes(x=as.numeric(cpg), y=mean_dnam, col = no2_colour)) +
  scale_color_manual(values = c("#254A90","red"), 
                     labels = c("First", "Third"),
                     name = "Prenatal NO2 quantile") +
  geom_line() + 
  geom_point(longdf_dmr27 %>% 
               subset(no2_colour %in% c("first", "fourth")), 
             mapping = aes(x=as.numeric(cpg), y=dnam, col = no2_colour),
             size = 0.25, alpha = 0.8) +
  theme_bw() +
  scale_x_continuous(name = "Genomic position (Chr5)",
                     breaks = seq(126409015, 126409055, by = 20)) +
  scale_y_continuous(name = "DNA methylation (%)") +
  theme(axis.text = element_text(size = 9, family = "sans"),
        axis.title = element_text(size = 9, family = "sans"),
        panel.grid = element_blank(),
        legend.position = "none",
        panel.background = element_rect(fill = '#D3D3D3'))

ggsave(plot = dmr27_charm,
       filename = here("figures",
                       "linear_regression",
                       "prenatal",
                       "2023-01-03_dmr27_charm.png"),
       height = 6, width = 12, units = "cm")


# create genomic region visualization 
dmr27_from <- combp_anno_df_es_sub_escutoff %>%
  subset(dmr == 27) %>%
  pull(pos) %>% 
  min()
dmr27_to <- combp_anno_df_es_sub_escutoff %>%
  subset(dmr == 27) %>%
  pull(pos) %>% 
  max()

dmr27_refgenes <- UcscTrack(genome = "hg19", chromosome = "chr5", 
                            track = "NCBI RefSeq", 
                            table = "refGene",
                            from = dmr27_from, to = dmr27_to,
                            trackType = "GeneRegionTrack", 
                            rstarts = "exonStarts", rends = "exonEnds", 
                            gene = "name", symbol = "name", 
                            transcript = "name", strand = "strand", 
                            fill = "#254A90", name = "UCSC refGene")

# add names
dmr27_ranges <- ranges(dmr27_refgenes)

# gene refseq gene symbiks abd add to annotation 
mcols(dmr27_ranges)$symbol <- mapIds(org.Hs.eg.db, 
                                     gsub("\\.[1-9]$", "", mcols(dmr27_ranges)$symbol), 
                                     "SYMBOL","REFSEQ")
ranges(dmr27_refgenes) <- dmr27_ranges

# get regulatory info from ucsc
dmr27_chromHmmGm12878 <- UcscTrack(genome = "hg19", chromosome = "chr5", 
                                   track = "Broad ChromHMM",
                                   table = "wgEncodeBroadHmmGm12878HMM",
                                   trackType = "AnnotationTrack", 
                                   from = 126380000,
                                   to =   126410061,
                                   start = "chromStart", end = "chromEnd", 
                                   id = "name", feature = "score", shape = "box", 
                                   stacking = "dense", fill = "itemRgb",
                                   name = "GM12878")

# colour according to hmm table 
dmr27_chromHmmGm12878@dp@pars$fill <- recode(dmr27_chromHmmGm12878@dp@pars$fill, 
                                             "245,245,245" = "#f5f5f5",
                                             "255,105,105" = "#ff6969",
                                             "153,255,102" = "#99ff66",
                                             "255,252,4" = "#fffc04",
                                             "127,127,127" = "#7f7f7f",
                                             "10,190,254" = "#0abefe",
                                             "207,11,198" = "#cf0bc6",
                                             "0,176,80" = "#00b050",
                                             "255,0,0" = "#ff0000",
                                             "250,202,0" = "#faca00")

dmr27_chromHmmGmNhlf <- UcscTrack(genome = "hg19", chromosome = "chr5",
                                  track = "Broad ChromHMM",
                                  table = "wgEncodeBroadHmmNhlfHMM",
                                  trackType = "AnnotationTrack",
                                  from = 126380000,
                                  to = 126410061,
                                  start = "chromStart", end = "chromEnd",
                                  id = "name", feature = "score", shape = "box",
                                  stacking = "dense", fill = "itemRgb",
                                  name = "NHLF")

dmr27_chromHmmGmNhlf@dp@pars$fill <- recode(dmr27_chromHmmGmNhlf@dp@pars$fill, 
                                            "250,202,0" = "#faca00",
                                            "255,0,0" = "#ff0000",
                                            "255,105,105" = "#ff6969",
                                            "245,245,245" = "#f5f5f5",
                                            "255,252,4" = "#fffc04",
                                            "10,190,254"  = "#0abefe",
                                            "127,127,127" = "#7f7f7f",
                                            "153,255,102" = "#99ff66",
                                            "0,176,80" = "#00b050",
                                            "207,11,198" = "#cf0bc6",
                                            "10,190,254"  = "#0abefe")

dmr27_chromHmmH1hesc <- UcscTrack(genome = "hg19", chromosome = "chr5", 
                                  track = "Broad ChromHMM",
                                  table = "wgEncodeBroadHmmH1hescHMM",
                                  trackType = "AnnotationTrack", 
                                  from = 126380000,
                                  to =   126410061,
                                  start = "chromStart", end = "chromEnd", 
                                  id = "name", feature = "score", shape = "box", 
                                  stacking = "dense", fill = "itemRgb",
                                  name = "hesc")

dmr27_chromHmmH1hesc@dp@pars$fill <- recode(dmr27_chromHmmH1hesc@dp@pars$fill,
                                            "127,127,127" = "#7f7f7f",
                                            "245,245,245" = "#f5f5f5",
                                            "10,190,254"  = "#0abefe",
                                            "207,11,198" = "#cf0bc6",
                                            "250,202,0" = "#faca00",
                                            "0,176,80" = "#00b050",
                                            "255,0,0" = "#ff0000",
                                            "153,255,102" = "#99ff66",
                                            "255,252,4" = "#fffc04",
                                            "255,105,105" = "#ff6969",)

# highlight track for DMR
dmr27_ht <- HighlightTrack(trackList = list(dmr27_refgenes, 
                                            dmr27_chromHmmGm12878, 
                                            dmr27_chromHmmH1hesc,
                                            dmr27_chromHmmGmNhlf,
                                            axTrack),
                           start = dmr27_from,
                           end = dmr27_to, 
                           chromosome = 5, fill = "lightgrey", col = "lightgrey")

unique(c(dmr27_chromHmmGm12878@dp@pars$fill, 
         dmr27_chromHmmGmNhlf@dp@pars$fill, 
         dmr27_chromHmmH1hesc@dp@pars$fill))

png(here("figures",
         "linear_regression",
         "prenatal",
         "2023-01-04_dmr27_gviz.png"),
    height = 6, width = 10.5, units = "cm", res = 300)
plotTracks(list(dmr27_ht),  
           transcriptAnnotation = "symbol",
           geneAnnotation = "gene",
           showTitle = F)
dev.off()

```




### Genome-wide DNA methylation changes 

Mean array-wide DNAm chanages
```{r mean_array_wide_dnam}
# convert betas to df
cb_betas_geno_cc_clean_df <- as.data.frame(cb_betas_geno_cc_clean)

methmeans <- colMeans(cb_betas_geno_cc_clean_df)

covariates_geno_ctpc_tech_cc <- cbind(covariates_geno_ctpc_tech_cc, methmeans)

#colmeans
meanmeth_lm <- 
  lm(methmeans ~ no2_prenatal_avg_2019v + sex + gestational_age  + 
       prenatal_maternal_smoke + maternal_education_length + 
       Comp.1 + Comp.2 + Comp.3 + Comp.4 +
       genotyping.PC1 + genotyping.PC2 + genotyping.PC3 + 
       sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + sv7 + sv8 + sv9 + sv10 +
       sv11 + sv12 + sv13 + sv14 + sv15 + sv16 + sv17, 
     data=covariates_geno_ctpc_tech_cc)

#get summary
summary(meanmeth_lm) #no2 not sig

# estimate marginal effects of prenatal NO2 exposure on DNAm
globaldna_no2_me <- ggpredict(meanmeth_lm, terms = "no2_prenatal_avg_2019v") %>%
  as.data.frame() %>% 
  dplyr::rename("methmeans" = predicted,
                "no2_prenatal_avg_2019v" = x)

# plot 
global_dnam_plot <- ggplot(covariates_geno_ctpc_tech_cc,
                           aes(x = no2_prenatal_avg_2019v, 
                               y= methmeans)) + 
  geom_line(data = globaldna_no2_me, 
            aes(x=no2_prenatal_avg_2019v, y = methmeans),
            col="red", size=0.5, linetype="solid") +
  geom_ribbon(data = globaldna_no2_me, 
              aes(x = no2_prenatal_avg_2019v, 
                  ymin = conf.low, ymax = conf.high), 
              alpha = .2) + 
  geom_point(alpha=0.6, col = "#254A90", size=1) + 
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text = element_text(size=9),
        panel.border = element_blank(),
        axis.line = element_line(color ="black"),
        axis.title = element_blank()) +
  lims(y=c(0.48,0.54))

ggsave(plot = global_dnam_plot, 
       filename = here("figures", 
                       "linear_regression", 
                       "prenatal",
                       "2022-11-18_cb_global_dnam.png"),
       width = 4.0, height = 3.2, units = "cm")

# correlation 
cor(covariates_geno_ctpc_tech_cc$methmeans, 
    covariates_geno_ctpc_tech_cc$no2_prenatal_avg_2019v,
    method="pearson") # 0.0489746

# effect size
range_cb = max(covariates_geno_ctpc_tech_cc$no2_prenatal_avg_2019v) -
  min(covariates_geno_ctpc_tech_cc$no2_prenatal_avg_2019v)

summary(meanmeth_lm)$coefficients["no2_prenatal_avg_2019v", "Estimate"]*range_cb # -1.476332e-05
```

LINE-1 specific DNAm
```{r mean_line1_dnam}
# read in line annotation from UCSC and repeat masker 
repeats_450k <- read.delim(file = gzfile(here("input_data", 
                                              "ucsc_rmsk_lines", 
                                              "ucsc_repeatmasker_enc_methyl450_gm12878.gz")),
                           header = T, skip = 1, sep = "\t")

# subset repeats for L1 LINE elements that are not in sex chromosomes
lines_450k  <- repeats_450k %>% 
  subset(rmsk.repClass == "LINE") %>%
  subset(rmsk.repFamily == "L1") %>%
  subset(!wgEncodeHaibMethyl450Gm12878SitesRep1.chrom %in% c("chrX", "chrY")) %>%
  subset(!is.na(wgEncodeHaibMethyl450Gm12878SitesRep1.chromStart))

# subset betas for those that overlap with line elements
cb_betas_geno_cc_clean_df_lines <- cb_betas_geno_cc_clean_df %>% 
  subset(rownames(.) %in% lines_450k$wgEncodeHaibMethyl450Gm12878SitesRep1.name)

# num of cpgs annotated to lines 
nrow(cb_betas_geno_cc_clean_df_lines) # 7302 

# get mean of line meth 
line_meth <- colMeans(cb_betas_geno_cc_clean_df_lines)

# cbind line methylation to covariate data frame
covariates_geno_ctpc_tech_cc <- cbind(covariates_geno_ctpc_tech_cc, line_meth)

#colmeans
line_meth_lm <- lm(line_meth ~ no2_prenatal_avg_2019v + sex + gestational_age  + 
                     prenatal_maternal_smoke + maternal_education_length + 
                     Comp.1 + Comp.2 + Comp.3 + Comp.4 +
                     genotyping.PC1 + genotyping.PC2 + genotyping.PC3 + 
                     sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + sv7 + sv8 + sv9 + sv10 +
                     sv11 + sv12 + sv13 + sv14 + sv15 + sv16 + sv17, 
                   data=covariates_geno_ctpc_tech_cc)

# summary of line regression
summary(line_meth_lm) #no2 not sig

# estimate marginal effects of prenatal NO2 exposure on DNAm
line_meth_no2_me <- ggpredict(line_meth_lm, terms = "no2_prenatal_avg_2019v") %>%
  as.data.frame() %>% 
  dplyr::rename("line_meth" = predicted,
                "no2_prenatal_avg_2019v" = x)

# plot 
line_dnam_plot <- ggplot(covariates_geno_ctpc_tech_cc,
                         aes(x = no2_prenatal_avg_2019v, 
                             y= line_meth)) + 
  geom_line(data = line_meth_no2_me, 
            aes(x=no2_prenatal_avg_2019v, y = line_meth),
            col="red", size=0.5, linetype="solid") +
  geom_ribbon(data = line_meth_no2_me, 
              aes(x = no2_prenatal_avg_2019v, 
                  ymin = conf.low, ymax = conf.high), 
              alpha = .2) + 
  geom_point(alpha=0.6, col = "#254A90", size=1) + 
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text = element_text(size=9),
        panel.border = element_blank(),
        axis.line = element_line(color ="black"),
        axis.title = element_blank()) +
  lims(y=c(0.80, 0.86))

ggsave(plot = line_dnam_plot, 
       filename = here("figures", 
                       "linear_regression", 
                       "prenatal",
                       "2022-11-18_cb_line_dnam.png"),
       width = 4.0, height = 3.2, units = "cm")

# correlation 
cor(covariates_geno_ctpc_tech_cc$line_meth, 
    covariates_geno_ctpc_tech_cc$no2_prenatal_avg_2019v,
    method="pearson") # 0.03949858

# effect size
summary(line_meth_lm)$coefficients["no2_prenatal_avg_2019v", "Estimate"]*range_cb # -4.694871e-05
```

### Interaction effect with birth month in prenatal model 

Try re-running limma with birth month/ interaction between birth month and air pollution.
```{r interaction_terms_to_assess_birthmonth}
#want to use anova to compare models usign anova
#anova only accepts models from lm
#use lm to compare how birth month affects cpgs above 10^-3 sig 

#You should be able to ask for confidence intervals for the slope coefficients for each month.  #even in a tabular display, you may see that smoothly varying pattern we were discussing.
#Then, you could use those to plot a sort of heres how the slope varies by month picture.Sort #of like forest plots for meta analysis results, if that makes sense.

#Also, before we decide it doesnt matter, the individual slopes might look fairly similar, but the appropriate overall test would be to check the anova(fit_with_interaction) and check the p-value on the interaction term.

#start by investigating cpgs identified as nominally significant in volcano plot

#  get names of top 10 cpgs based on effect size and pvalue from ewas
cb_pvals_tech %>%
  subset(effect_size > 0.025 | effect_size < -0.025) %>%
  arrange(pval_no2_prenatal_avg_2019v) %>%
  slice_head(n=10) %>%
  rownames()

#############
#cg03508112 #             
#############

# add to covariate data frame
covariates_geno_ctpc_tech_cc$cb_cg03508112 <- 
  cb_betas_geno_cc_clean[rownames(cb_betas_geno_cc_clean)=="cg03508112", ] 

# fit wiht lm
cg03508112_lm_bm <- lm(cb_cg03508112 ~ no2_prenatal_avg_2019v*birth_month + 
                         sex + gestational_age  + prenatal_maternal_smoke + 
                         maternal_education_length + Comp.1 + Comp.2 + Comp.3 + 
                         Comp.4 + genotyping.PC1 + genotyping.PC2 + 
                         genotyping.PC3 + sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + 
                         sv7 + sv8 + sv9 + sv10 + sv11 + sv12 + sv13 + sv14 + 
                         sv15 + sv16 + sv17,
                       data=covariates_geno_ctpc_tech_cc)

cg03508112_lm <- lm(cb_cg03508112 ~  no2_prenatal_avg_2019v + 
                      sex + gestational_age  + prenatal_maternal_smoke + 
                      maternal_education_length + Comp.1 + Comp.2 + Comp.3 + 
                      Comp.4 + genotyping.PC1 + genotyping.PC2 + 
                      genotyping.PC3 + sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + 
                      sv7 + sv8 + sv9 + sv10 + sv11 + sv12 + sv13 + sv14 + 
                      sv15 + sv16 + sv17,
                    data=covariates_geno_ctpc_tech_cc)


# anova
anova(cg03508112_lm, cg03508112_lm_bm, test = "LRT") # p =0.3891
summary(cg03508112_lm_bm) # feb (0.0317)

# get plot of birth month effect with 95% CI
cg03508112_lm_bm_plot <- tidy(cg03508112_lm_bm, conf.int = 0.95) %>% 
  filter(term %>% str_detect(":")) %>% 
  mutate(term = factor(term, levels=c("no2_prenatal_avg_2019v:birth_monthfebruary",
                                      "no2_prenatal_avg_2019v:birth_monthmarch",
                                      "no2_prenatal_avg_2019v:birth_monthapril",
                                      "no2_prenatal_avg_2019v:birth_monthmay",
                                      "no2_prenatal_avg_2019v:birth_monthjune",
                                      "no2_prenatal_avg_2019v:birth_monthjuly",
                                      "no2_prenatal_avg_2019v:birth_monthaugust",
                                      "no2_prenatal_avg_2019v:birth_monthseptember",
                                      "no2_prenatal_avg_2019v:birth_monthoctober",
                                      "no2_prenatal_avg_2019v:birth_monthnovember",
                                      "no2_prenatal_avg_2019v:birth_monthdecember"))) %>% 
  ggplot(aes(y = estimate*100, x = as.factor(term))) + 
  geom_point() +
  geom_errorbar(aes(ymin = conf.low*100 , ymax = conf.high*100)) +
  scale_x_discrete(labels=c("February","March", "April", "May",
                            "June","July", "August", "September",
                            "October", "November","December")) +
  ylim(-30, 30) +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle=90),
        axis.text = element_text(size=9, hjust=0.9),
        axis.title = element_blank()) 

ggsave(filename="2022-10-07_CHILD_prenatal_no2_cg03508112_bm.png",
       path =  here("figures", "linear_regression", "prenatal"),
       width = 4.8, height = 4, units = "cm")


#############
#cg08568767 #             
#############

# add to covariate data frame
covariates_geno_ctpc_tech_cc$cb_cg08568767 <- 
  cb_betas_geno_cc_clean[rownames(cb_betas_geno_cc_clean)=="cg08568767", ] 

# fit wiht lm
cg08568767_lm_bm <- lm(cb_cg08568767 ~ no2_prenatal_avg_2019v*birth_month + 
                         sex + gestational_age  + prenatal_maternal_smoke + 
                         maternal_education_length + Comp.1 + Comp.2 + Comp.3 + 
                         Comp.4 + genotyping.PC1 + genotyping.PC2 + 
                         genotyping.PC3 + sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + 
                         sv7 + sv8 + sv9 + sv10 + sv11 + sv12 + sv13 + sv14 + 
                         sv15 + sv16 + sv17,
                       data=covariates_geno_ctpc_tech_cc)

cg08568767_lm <- lm(cb_cg08568767 ~ no2_prenatal_avg_2019v + 
                      sex + gestational_age  + prenatal_maternal_smoke + 
                      maternal_education_length + Comp.1 + Comp.2 + Comp.3 + 
                      Comp.4 + genotyping.PC1 + genotyping.PC2 + 
                      genotyping.PC3 + sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + 
                      sv7 + sv8 + sv9 + sv10 + sv11 + sv12 + sv13 + sv14 + 
                      sv15 + sv16 + sv17,
                    data=covariates_geno_ctpc_tech_cc)


# anova
anova(cg08568767_lm, cg08568767_lm_bm, test = "LRT") # p = 0.9724
summary(cg08568767_lm_bm) 

# get plot of birth month effect with 95% CI
cg08568767_lm_bm_plot <- tidy(cg08568767_lm_bm, conf.int = 0.95) %>% 
  filter(term %>% str_detect(":")) %>% 
  mutate(term = factor(term, levels=c("no2_prenatal_avg_2019v:birth_monthfebruary",
                                      "no2_prenatal_avg_2019v:birth_monthmarch",
                                      "no2_prenatal_avg_2019v:birth_monthapril",
                                      "no2_prenatal_avg_2019v:birth_monthmay",
                                      "no2_prenatal_avg_2019v:birth_monthjune",
                                      "no2_prenatal_avg_2019v:birth_monthjuly",
                                      "no2_prenatal_avg_2019v:birth_monthaugust",
                                      "no2_prenatal_avg_2019v:birth_monthseptember",
                                      "no2_prenatal_avg_2019v:birth_monthoctober",
                                      "no2_prenatal_avg_2019v:birth_monthnovember",
                                      "no2_prenatal_avg_2019v:birth_monthdecember"))) %>% 
  ggplot(aes(y = estimate*100, x = as.factor(term))) + 
  geom_point() +
  geom_errorbar(aes(ymin = conf.low*100 , ymax = conf.high*100)) +
  scale_x_discrete(labels=c("February","March", "April", "May",
                            "June","July", "August", "September",
                            "October", "November","December")) +
  ylim(-35, 35) +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle=90),
        axis.text = element_text(size=9, hjust=0.9),
        axis.title = element_blank()) 

ggsave(plot = cg08568767_lm_bm_plot,
       filename="2022-10-07_CHILD_prenatal_no2_cg08568767_bm.png",
       path =  here("figures", 
                    "linear_regression", 
                    "prenatal"),
       width = 4.8, height = 4, units = "cm")


#############
#cg12228123 #             
#############

# add to covariate data frame
covariates_geno_ctpc_tech_cc$cb_cg12228123 <- 
  cb_betas_geno_cc_clean[rownames(cb_betas_geno_cc_clean)=="cg12228123", ] 

# fit wiht lm
cg12228123_lm_bm <- lm(cb_cg12228123 ~ no2_prenatal_avg_2019v*birth_month + 
                         sex + gestational_age  + prenatal_maternal_smoke + 
                         maternal_education_length + Comp.1 + Comp.2 + Comp.3 + 
                         Comp.4 + genotyping.PC1 + genotyping.PC2 + 
                         genotyping.PC3 + sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + 
                         sv7 + sv8 + sv9 + sv10 + sv11 + sv12 + sv13 + sv14 + 
                         sv15 + sv16 + sv17,
                       data=covariates_geno_ctpc_tech_cc)

cg12228123_lm <- lm(cb_cg12228123 ~ no2_prenatal_avg_2019v + 
                      sex + gestational_age  + prenatal_maternal_smoke + 
                      maternal_education_length + Comp.1 + Comp.2 + Comp.3 + 
                      Comp.4 + genotyping.PC1 + genotyping.PC2 + 
                      genotyping.PC3 + sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + 
                      sv7 + sv8 + sv9 + sv10 + sv11 + sv12 + sv13 + sv14 + 
                      sv15 + sv16 + sv17,
                    data=covariates_geno_ctpc_tech_cc)


# anova
anova(cg12228123_lm, cg12228123_lm_bm, test = "LRT") # p = 0.444
summary(cg12228123_lm_bm) # dec (0.032987)

# get plot of birth month effect with 95% CI
cg12228123_lm_bm_plot <- tidy(cg12228123_lm_bm, conf.int = 0.95) %>% 
  filter(term %>% str_detect(":")) %>% 
  mutate(term = factor(term, levels=c("no2_prenatal_avg_2019v:birth_monthfebruary",
                                      "no2_prenatal_avg_2019v:birth_monthmarch",
                                      "no2_prenatal_avg_2019v:birth_monthapril",
                                      "no2_prenatal_avg_2019v:birth_monthmay",
                                      "no2_prenatal_avg_2019v:birth_monthjune",
                                      "no2_prenatal_avg_2019v:birth_monthjuly",
                                      "no2_prenatal_avg_2019v:birth_monthaugust",
                                      "no2_prenatal_avg_2019v:birth_monthseptember",
                                      "no2_prenatal_avg_2019v:birth_monthoctober",
                                      "no2_prenatal_avg_2019v:birth_monthnovember",
                                      "no2_prenatal_avg_2019v:birth_monthdecember"))) %>% 
  ggplot(aes(y = estimate*100, x = as.factor(term))) + 
  geom_point() +
  geom_errorbar(aes(ymin = conf.low*100 , ymax = conf.high*100)) +
  scale_x_discrete(labels=c("February","March", "April", "May",
                            "June","July", "August", "September",
                            "October", "November","December")) +
  ylim(-80, 80) +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle=90),
        axis.text = element_text(size=9, hjust=0.9),
        axis.title = element_blank()) 

ggsave(plot = cg12228123_lm_bm_plot,
       filename="2022-10-07_CHILD_prenatal_no2_cg12228123_bm.png",
       path =  here("figures", 
                    "linear_regression", 
                    "prenatal"),
       width = 4.8, height = 4, units = "cm")


#############
#cg14491284 #             
#############

# add to covariate data frame
covariates_geno_ctpc_tech_cc$cb_cg14491284 <- 
  cb_betas_geno_cc_clean[rownames(cb_betas_geno_cc_clean)=="cg14491284", ] 

# fit wiht lm
cg14491284_lm_bm <- lm(cb_cg14491284 ~ no2_prenatal_avg_2019v*birth_month + 
                         sex + gestational_age  + prenatal_maternal_smoke + 
                         maternal_education_length + Comp.1 + Comp.2 + Comp.3 + 
                         Comp.4 + genotyping.PC1 + genotyping.PC2 + 
                         genotyping.PC3 + sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + 
                         sv7 + sv8 + sv9 + sv10 + sv11 + sv12 + sv13 + sv14 + 
                         sv15 + sv16 + sv17,
                       data=covariates_geno_ctpc_tech_cc)

cg14491284_lm <- lm(cb_cg14491284 ~ no2_prenatal_avg_2019v + 
                      sex + gestational_age  + prenatal_maternal_smoke + 
                      maternal_education_length + Comp.1 + Comp.2 + Comp.3 + 
                      Comp.4 + genotyping.PC1 + genotyping.PC2 + 
                      genotyping.PC3 + sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + 
                      sv7 + sv8 + sv9 + sv10 + sv11 + sv12 + sv13 + sv14 + 
                      sv15 + sv16 + sv17,
                    data=covariates_geno_ctpc_tech_cc)


# anova
anova(cg14491284_lm, cg14491284_lm_bm, test = "LRT") # p = 0.7233
summary(cg14491284_lm_bm) 

# get plot of birth month effect with 95% CI
cg14491284_lm_bm_plot <- tidy(cg14491284_lm_bm, conf.int = 0.95) %>% 
  filter(term %>% str_detect(":")) %>% 
  mutate(term = factor(term, levels=c("no2_prenatal_avg_2019v:birth_monthfebruary",
                                      "no2_prenatal_avg_2019v:birth_monthmarch",
                                      "no2_prenatal_avg_2019v:birth_monthapril",
                                      "no2_prenatal_avg_2019v:birth_monthmay",
                                      "no2_prenatal_avg_2019v:birth_monthjune",
                                      "no2_prenatal_avg_2019v:birth_monthjuly",
                                      "no2_prenatal_avg_2019v:birth_monthaugust",
                                      "no2_prenatal_avg_2019v:birth_monthseptember",
                                      "no2_prenatal_avg_2019v:birth_monthoctober",
                                      "no2_prenatal_avg_2019v:birth_monthnovember",
                                      "no2_prenatal_avg_2019v:birth_monthdecember"))) %>% 
  ggplot(aes(y = estimate*100, x = as.factor(term))) + 
  geom_point() +
  geom_errorbar(aes(ymin = conf.low*100 , ymax = conf.high*100)) +
  scale_x_discrete(labels=c("February","March", "April", "May",
                            "June","July", "August", "September",
                            "October", "November","December")) +
  ylim(-30, 30) +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle=90),
        axis.text = element_text(size=9, hjust=0.9),
        axis.title = element_blank()) 

ggsave(plot = cg14491284_lm_bm_plot,
       filename="2022-10-07_CHILD_prenatal_no2_cg14491284_bm.png",
       path =  here("figures", 
                    "linear_regression", 
                    "prenatal"),
       width = 4.8, height = 4, units = "cm")


#############
#cg02074714 #             
#############

# add to covariate data frame
covariates_geno_ctpc_tech_cc$cb_cg02074714 <- 
  cb_betas_geno_cc_clean[rownames(cb_betas_geno_cc_clean)=="cg02074714", ] 

# fit wiht lm
cg02074714_lm_bm <- lm(cb_cg02074714 ~ no2_prenatal_avg_2019v*birth_month + 
                         sex + gestational_age  + prenatal_maternal_smoke + 
                         maternal_education_length + Comp.1 + Comp.2 + Comp.3 + 
                         Comp.4 + genotyping.PC1 + genotyping.PC2 + 
                         genotyping.PC3 + sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + 
                         sv7 + sv8 + sv9 + sv10 + sv11 + sv12 + sv13 + sv14 + 
                         sv15 + sv16 + sv17,
                       data=covariates_geno_ctpc_tech_cc)

cg02074714_lm <- lm(cb_cg02074714 ~ no2_prenatal_avg_2019v + 
                      sex + gestational_age  + prenatal_maternal_smoke + 
                      maternal_education_length + Comp.1 + Comp.2 + Comp.3 + 
                      Comp.4 + genotyping.PC1 + genotyping.PC2 + 
                      genotyping.PC3 + sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + 
                      sv7 + sv8 + sv9 + sv10 + sv11 + sv12 + sv13 + sv14 + 
                      sv15 + sv16 + sv17,
                    data=covariates_geno_ctpc_tech_cc)


# anova
anova(cg02074714_lm, cg02074714_lm_bm, test = "LRT") # p = 0.958
summary(cg02074714_lm_bm) 

# get plot of birth month effect with 95% CI
cg02074714_lm_bm_plot <- tidy(cg02074714_lm_bm, conf.int = 0.95) %>% 
  filter(term %>% str_detect(":")) %>% 
  mutate(term = factor(term, levels=c("no2_prenatal_avg_2019v:birth_monthfebruary",
                                      "no2_prenatal_avg_2019v:birth_monthmarch",
                                      "no2_prenatal_avg_2019v:birth_monthapril",
                                      "no2_prenatal_avg_2019v:birth_monthmay",
                                      "no2_prenatal_avg_2019v:birth_monthjune",
                                      "no2_prenatal_avg_2019v:birth_monthjuly",
                                      "no2_prenatal_avg_2019v:birth_monthaugust",
                                      "no2_prenatal_avg_2019v:birth_monthseptember",
                                      "no2_prenatal_avg_2019v:birth_monthoctober",
                                      "no2_prenatal_avg_2019v:birth_monthnovember",
                                      "no2_prenatal_avg_2019v:birth_monthdecember"))) %>% 
  ggplot(aes(y = estimate*100, x = as.factor(term))) + 
  geom_point() +
  geom_errorbar(aes(ymin = conf.low*100 , ymax = conf.high*100)) +
  scale_x_discrete(labels=c("February","March", "April", "May",
                            "June","July", "August", "September",
                            "October", "November","December")) +
  ylim(-50, 50) +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle=90),
        axis.text = element_text(size=9, hjust=0.9),
        axis.title = element_blank()) 

ggsave(plot = cg02074714_lm_bm_plot,
       filename="2022-10-07_CHILD_prenatal_no2_cg02074714_bm.png",
       path =  here("figures", 
                    "linear_regression", 
                    "prenatal"),
       width = 4.8, height = 4, units = "cm")


#############
#cg14658149 #             
#############

# add to covariate data frame
covariates_geno_ctpc_tech_cc$cb_cg14658149 <- 
  cb_betas_geno_cc_clean[rownames(cb_betas_geno_cc_clean)=="cg14658149", ] 

# fit wiht lm
cg14658149_lm_bm <- lm(cb_cg14658149 ~ no2_prenatal_avg_2019v*birth_month + 
                         sex + gestational_age  + prenatal_maternal_smoke + 
                         maternal_education_length + Comp.1 + Comp.2 + Comp.3 + 
                         Comp.4 + genotyping.PC1 + genotyping.PC2 + 
                         genotyping.PC3 + sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + 
                         sv7 + sv8 + sv9 + sv10 + sv11 + sv12 + sv13 + sv14 + 
                         sv15 + sv16 + sv17,
                       data=covariates_geno_ctpc_tech_cc)

cg14658149_lm <- lm(cb_cg14658149 ~ no2_prenatal_avg_2019v + 
                      sex + gestational_age  + prenatal_maternal_smoke + 
                      maternal_education_length + Comp.1 + Comp.2 + Comp.3 + 
                      Comp.4 + genotyping.PC1 + genotyping.PC2 + 
                      genotyping.PC3 + sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + 
                      sv7 + sv8 + sv9 + sv10 + sv11 + sv12 + sv13 + sv14 + 
                      sv15 + sv16 + sv17,
                    data=covariates_geno_ctpc_tech_cc)


# anova
anova(cg14658149_lm, cg14658149_lm_bm) # p = 0.159
summary(cg14658149_lm_bm) # nov (0.044061)

# get plot of birth month effect with 95% CI
cg14658149_lm_bm_plot <- tidy(cg14658149_lm_bm, conf.int = 0.95) %>% 
  filter(term %>% str_detect(":")) %>% 
  mutate(term = factor(term, levels=c("no2_prenatal_avg_2019v:birth_monthfebruary",
                                      "no2_prenatal_avg_2019v:birth_monthmarch",
                                      "no2_prenatal_avg_2019v:birth_monthapril",
                                      "no2_prenatal_avg_2019v:birth_monthmay",
                                      "no2_prenatal_avg_2019v:birth_monthjune",
                                      "no2_prenatal_avg_2019v:birth_monthjuly",
                                      "no2_prenatal_avg_2019v:birth_monthaugust",
                                      "no2_prenatal_avg_2019v:birth_monthseptember",
                                      "no2_prenatal_avg_2019v:birth_monthoctober",
                                      "no2_prenatal_avg_2019v:birth_monthnovember",
                                      "no2_prenatal_avg_2019v:birth_monthdecember"))) %>% 
  ggplot(aes(y = estimate*100, x = as.factor(term))) + 
  geom_point() +
  geom_errorbar(aes(ymin = conf.low*100 , ymax = conf.high*100)) +
  scale_x_discrete(labels=c("February","March", "April", "May",
                            "June","July", "August", "September",
                            "October", "November","December")) +
  ylim(-20, 20) +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle=90),
        axis.text = element_text(size=9, hjust=0.9),
        axis.title = element_blank()) 

ggsave(plot = cg14658149_lm_bm_plot,
       filename="2022-10-07_CHILD_prenatal_no2_cg14658149_bm.png",
       path =  here("figures", 
                    "linear_regression", 
                    "prenatal"),
       width = 4.8, height = 4, units = "cm")


#############
#cg25472862 #             
#############

# add to covariate data frame
covariates_geno_ctpc_tech_cc$cb_cg25472862 <- 
  cb_betas_geno_cc_clean[rownames(cb_betas_geno_cc_clean)=="cg25472862", ] 

# fit wiht lm
cg25472862_lm_bm <- lm(cb_cg25472862 ~ no2_prenatal_avg_2019v*birth_month + 
                         sex + gestational_age  + prenatal_maternal_smoke + 
                         maternal_education_length + Comp.1 + Comp.2 + Comp.3 + 
                         Comp.4 + genotyping.PC1 + genotyping.PC2 + 
                         genotyping.PC3 + sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + 
                         sv7 + sv8 + sv9 + sv10 + sv11 + sv12 + sv13 + sv14 + 
                         sv15 + sv16 + sv17,
                       data=covariates_geno_ctpc_tech_cc)

cg25472862_lm <- lm(cb_cg25472862 ~ no2_prenatal_avg_2019v + 
                      sex + gestational_age  + prenatal_maternal_smoke + 
                      maternal_education_length + Comp.1 + Comp.2 + Comp.3 + 
                      Comp.4 + genotyping.PC1 + genotyping.PC2 + 
                      genotyping.PC3 + sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + 
                      sv7 + sv8 + sv9 + sv10 + sv11 + sv12 + sv13 + sv14 + 
                      sv15 + sv16 + sv17,
                    data=covariates_geno_ctpc_tech_cc)


# anova
anova(cg25472862_lm, cg25472862_lm_bm, test = "LRT") # p = 0.5835
summary(cg25472862_lm_bm) 

# get plot of birth month effect with 95% CI
cg25472862_lm_bm_plot <- tidy(cg25472862_lm_bm, conf.int = 0.95) %>% 
  filter(term %>% str_detect(":")) %>% 
  mutate(term = factor(term, levels=c("no2_prenatal_avg_2019v:birth_monthfebruary",
                                      "no2_prenatal_avg_2019v:birth_monthmarch",
                                      "no2_prenatal_avg_2019v:birth_monthapril",
                                      "no2_prenatal_avg_2019v:birth_monthmay",
                                      "no2_prenatal_avg_2019v:birth_monthjune",
                                      "no2_prenatal_avg_2019v:birth_monthjuly",
                                      "no2_prenatal_avg_2019v:birth_monthaugust",
                                      "no2_prenatal_avg_2019v:birth_monthseptember",
                                      "no2_prenatal_avg_2019v:birth_monthoctober",
                                      "no2_prenatal_avg_2019v:birth_monthnovember",
                                      "no2_prenatal_avg_2019v:birth_monthdecember"))) %>% 
  ggplot(aes(y = estimate*100, x = as.factor(term))) + 
  geom_point() +
  geom_errorbar(aes(ymin = conf.low*100 , ymax = conf.high*100)) +
  scale_x_discrete(labels=c("February","March", "April", "May",
                            "June","July", "August", "September",
                            "October", "November","December")) +
  ylim(-30, 30) +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle=90),
        axis.text = element_text(size=9, hjust=0.9),
        axis.title = element_blank()) 

ggsave(plot = cg25472862_lm_bm_plot,
       filename="2022-10-07_CHILD_prenatal_no2_cg25472862_bm.png",
       path =  here("figures", 
                    "linear_regression", 
                    "prenatal"),
       width = 4.8, height = 4, units = "cm")


#############
#cg11642106 #             
#############

# add to covariate data frame
covariates_geno_ctpc_tech_cc$cb_cg11642106 <- 
  cb_betas_geno_cc_clean[rownames(cb_betas_geno_cc_clean)=="cg11642106", ] 

# fit wiht lm
cg11642106_lm_bm <- lm(cb_cg11642106 ~ no2_prenatal_avg_2019v*birth_month + 
                         sex + gestational_age  + prenatal_maternal_smoke + 
                         maternal_education_length + Comp.1 + Comp.2 + Comp.3 + 
                         Comp.4 + genotyping.PC1 + genotyping.PC2 + 
                         genotyping.PC3 + sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + 
                         sv7 + sv8 + sv9 + sv10 + sv11 + sv12 + sv13 + sv14 + 
                         sv15 + sv16 + sv17,
                       data=covariates_geno_ctpc_tech_cc)

cg11642106_lm <- lm(cb_cg11642106 ~ no2_prenatal_avg_2019v + 
                      sex + gestational_age  + prenatal_maternal_smoke + 
                      maternal_education_length + Comp.1 + Comp.2 + Comp.3 + 
                      Comp.4 + genotyping.PC1 + genotyping.PC2 + 
                      genotyping.PC3 + sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + 
                      sv7 + sv8 + sv9 + sv10 + sv11 + sv12 + sv13 + sv14 + 
                      sv15 + sv16 + sv17,
                    data=covariates_geno_ctpc_tech_cc)


# anova
anova(cg11642106_lm, cg11642106_lm_bm, test = "LRT") # p = 0.6545
summary(cg11642106_lm_bm) 

# get plot of birth month effect with 95% CI
cg11642106_lm_bm_plot <- tidy(cg11642106_lm_bm, conf.int = 0.95) %>% 
  filter(term %>% str_detect(":")) %>% 
  mutate(term = factor(term, levels=c("no2_prenatal_avg_2019v:birth_monthfebruary",
                                      "no2_prenatal_avg_2019v:birth_monthmarch",
                                      "no2_prenatal_avg_2019v:birth_monthapril",
                                      "no2_prenatal_avg_2019v:birth_monthmay",
                                      "no2_prenatal_avg_2019v:birth_monthjune",
                                      "no2_prenatal_avg_2019v:birth_monthjuly",
                                      "no2_prenatal_avg_2019v:birth_monthaugust",
                                      "no2_prenatal_avg_2019v:birth_monthseptember",
                                      "no2_prenatal_avg_2019v:birth_monthoctober",
                                      "no2_prenatal_avg_2019v:birth_monthnovember",
                                      "no2_prenatal_avg_2019v:birth_monthdecember"))) %>% 
  ggplot(aes(y = estimate*100, x = as.factor(term))) + 
  geom_point() +
  geom_errorbar(aes(ymin = conf.low*100 , ymax = conf.high*100)) +
  scale_x_discrete(labels=c("February","March", "April", "May",
                            "June","July", "August", "September",
                            "October", "November","December")) +
  ylim(-20, 20) +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle=90),
        axis.text = element_text(size=9, hjust=0.9),
        axis.title = element_blank()) 

ggsave(plot = cg11642106_lm_bm_plot,
       filename="2022-10-07_CHILD_prenatal_no2_cg11642106_bm.png",
       path =  here("figures", 
                    "linear_regression", 
                    "prenatal"),
       width = 4.8, height = 4, units = "cm")


#############
#cg09936824 #             
#############

# add to covariate data frame
covariates_geno_ctpc_tech_cc$cb_cg09936824 <- 
  cb_betas_geno_cc_clean[rownames(cb_betas_geno_cc_clean)=="cg09936824", ] 

# fit wiht lm
cg09936824_lm_bm <- lm(cb_cg09936824 ~ no2_prenatal_avg_2019v*birth_month + 
                         sex + gestational_age  + prenatal_maternal_smoke + 
                         maternal_education_length + Comp.1 + Comp.2 + Comp.3 + 
                         Comp.4 + genotyping.PC1 + genotyping.PC2 + 
                         genotyping.PC3 + sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + 
                         sv7 + sv8 + sv9 + sv10 + sv11 + sv12 + sv13 + sv14 + 
                         sv15 + sv16 + sv17,
                       data=covariates_geno_ctpc_tech_cc)

cg09936824_lm <- lm(cb_cg09936824 ~ no2_prenatal_avg_2019v + 
                      sex + gestational_age  + prenatal_maternal_smoke + 
                      maternal_education_length + Comp.1 + Comp.2 + Comp.3 + 
                      Comp.4 + genotyping.PC1 + genotyping.PC2 + 
                      genotyping.PC3 + sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + 
                      sv7 + sv8 + sv9 + sv10 + sv11 + sv12 + sv13 + sv14 + 
                      sv15 + sv16 + sv17,
                    data=covariates_geno_ctpc_tech_cc)


# anova
anova(cg09936824_lm, cg09936824_lm_bm, test = "LRT") # p = 0.6164
summary(cg09936824_lm_bm) 

# get plot of birth month effect with 95% CI
cg09936824_lm_bm_plot <- tidy(cg09936824_lm_bm, conf.int = 0.95) %>% 
  filter(term %>% str_detect(":")) %>% 
  mutate(term = factor(term, levels=c("no2_prenatal_avg_2019v:birth_monthfebruary",
                                      "no2_prenatal_avg_2019v:birth_monthmarch",
                                      "no2_prenatal_avg_2019v:birth_monthapril",
                                      "no2_prenatal_avg_2019v:birth_monthmay",
                                      "no2_prenatal_avg_2019v:birth_monthjune",
                                      "no2_prenatal_avg_2019v:birth_monthjuly",
                                      "no2_prenatal_avg_2019v:birth_monthaugust",
                                      "no2_prenatal_avg_2019v:birth_monthseptember",
                                      "no2_prenatal_avg_2019v:birth_monthoctober",
                                      "no2_prenatal_avg_2019v:birth_monthnovember",
                                      "no2_prenatal_avg_2019v:birth_monthdecember"))) %>% 
  ggplot(aes(y = estimate*100, x = as.factor(term))) + 
  geom_point() +
  geom_errorbar(aes(ymin = conf.low*100 , ymax = conf.high*100)) +
  scale_x_discrete(labels=c("February","March", "April", "May",
                            "June","July", "August", "September",
                            "October", "November","December")) +
  ylim(-30, 30) +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle=90),
        axis.text = element_text(size=9, hjust=0.9),
        axis.title = element_blank()) 

ggsave(plot = cg09936824_lm_bm_plot,
       filename="2022-10-07_CHILD_prenatal_no2_cg09936824_bm.png",
       path =  here("figures", 
                    "linear_regression", 
                    "prenatal"),
       width = 4.8, height = 4, units = "cm")


#############
#cg08033031 #             
#############

# add to covariate data frame
covariates_geno_ctpc_tech_cc$cb_cg08033031 <- 
  cb_betas_geno_cc_clean[rownames(cb_betas_geno_cc_clean)=="cg08033031", ] 

# fit wiht lm
cg08033031_lm_bm <- lm(cb_cg08033031 ~ no2_prenatal_avg_2019v*birth_month + 
                         sex + gestational_age  + prenatal_maternal_smoke + 
                         maternal_education_length + Comp.1 + Comp.2 + Comp.3 + 
                         Comp.4 + genotyping.PC1 + genotyping.PC2 + 
                         genotyping.PC3 + sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + 
                         sv7 + sv8 + sv9 + sv10 + sv11 + sv12 + sv13 + sv14 + 
                         sv15 + sv16 + sv17,
                       data=covariates_geno_ctpc_tech_cc)

cg08033031_lm <- lm(cb_cg08033031 ~ no2_prenatal_avg_2019v + 
                      sex + gestational_age  + prenatal_maternal_smoke + 
                      maternal_education_length + Comp.1 + Comp.2 + Comp.3 + 
                      Comp.4 + genotyping.PC1 + genotyping.PC2 + 
                      genotyping.PC3 + sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + 
                      sv7 + sv8 + sv9 + sv10 + sv11 + sv12 + sv13 + sv14 + 
                      sv15 + sv16 + sv17,
                    data=covariates_geno_ctpc_tech_cc)


# anova
anova(cg08033031_lm, cg08033031_lm_bm, test = "LRT") # p = 0.7881
summary(cg08033031_lm_bm) 

# get plot of birth month effect with 95% CI
cg08033031_lm_bm_plot <- tidy(cg08033031_lm_bm, conf.int = 0.95) %>% 
  filter(term %>% str_detect(":")) %>% 
  mutate(term = factor(term, levels=c("no2_prenatal_avg_2019v:birth_monthfebruary",
                                      "no2_prenatal_avg_2019v:birth_monthmarch",
                                      "no2_prenatal_avg_2019v:birth_monthapril",
                                      "no2_prenatal_avg_2019v:birth_monthmay",
                                      "no2_prenatal_avg_2019v:birth_monthjune",
                                      "no2_prenatal_avg_2019v:birth_monthjuly",
                                      "no2_prenatal_avg_2019v:birth_monthaugust",
                                      "no2_prenatal_avg_2019v:birth_monthseptember",
                                      "no2_prenatal_avg_2019v:birth_monthoctober",
                                      "no2_prenatal_avg_2019v:birth_monthnovember",
                                      "no2_prenatal_avg_2019v:birth_monthdecember"))) %>% 
  ggplot(aes(y = estimate*100, x = as.factor(term))) + 
  geom_point() +
  geom_errorbar(aes(ymin = conf.low*100 , ymax = conf.high*100)) +
  scale_x_discrete(labels=c("February","March", "April", "May",
                            "June","July", "August", "September",
                            "October", "November","December")) +
  ylim(-20, 20) +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle=90),
        axis.text = element_text(size=9, hjust=0.9),
        axis.title = element_blank()) 

ggsave(plot = cg08033031_lm_bm_plot,
       filename="2022-10-07_CHILD_prenatal_no2_cg08033031_bm.png",
       path =  here("figures", 
                    "linear_regression", 
                    "prenatal"),
       width = 4.8, height = 4, units = "cm")
```

### mQTLdb cross check

Check whether CpGs that compose DMRs are annotated as potential mQTLs in mQTLdb.com. I copied the list of CpGs contained in DMRs into mQTLdb then saved the outputted data to compare whether the CpGs appear in hits here. 
```{r mqtl_check}
# load mQTL data
mqtls <- read.csv(here("input_data",
                       "mQTLdb_lists", 
                       "CHILD_cordblood_dmr_cpgs_mqtldb.csv"))

# subset mqtls for pval and effect size according to guant (2016; PMID: 27036880)
mqtls_sub <- mqtls %>%  
  subset(p.value< 1.0e-14 & Effect.Size > 0.02)

# annotate individual cpgs within DMRs as a potential mqtl or not
combp_anno_df_es_sub_escutoff_mqtls <- combp_anno_df_es_sub_escutoff %>%
  mutate(mqtl = ifelse(Name %in% (mqtls_sub %>% 
                                    distinct(CpG) %>% 
                                    pull(CpG)), TRUE, FALSE))

# get names of cpgs that are potential mqtls 
child_mqtls <- combp_anno_df_es_sub_escutoff_mqtls %>% subset(mqtl) %>% pull(Name) 

# get effect size min and  max
mqtls_sub %>% subset(CpG %in% child_mqtls) %>% pull(Effect.Size) %>% min()
mqtls_sub %>% subset(CpG %in% child_mqtls) %>% pull(Effect.Size) %>% max()

child_mqtls <- combp_anno_df_es_sub_escutoff_mqtls %>% subset(mqtl) %>% pull(Name) 

# write out annotation for dmrs
write.csv(combp_anno_df_es_sub_escutoff_mqtls,
          here("tables",
               "prenatal",
               "2022-11-23_prenatal_no2_cord_blood_mqtldb_birth_cpgs_sub.csv"))


# write out annotation for dmrs
write.csv(mqtls_sub,
          here("tables",
               "prenatal",
               "2022-11-22_prenatal_no2_combp_annotation_sigDMRs_mQTL_annotation.csv"))


dmr_cpg_mqtls <- combp_anno_df_es_sub_escutoff_mqtls %>%
  group_by(dmr) %>%
  summarise(percent_mqtl = sum(mqtl)/length(mqtl)*100) %>%
  mutate(dmr = as.factor(dmr)) %>%
  mutate(dmr = recode(dmr, 
                      `1` = "Chr7:27183133-27184854",
                      `2` = "Chr7:27187102-27187692",
                      `3` = "Chr8:22132665-22133077",
                      `4` = "Chr17:36666953-36667485",
                      `5` = "Chr5:150325954-150326498",
                      `6` = "Chr2:237702390-237702581",
                      `7` = "Chr7:26897182-26897254",
                      `8` = "Chr1:248100345-248100615",
                      `9` = "Chr17:46682308-46682414",
                      `10` = "Chr7:27170552-27171052",
                      `11` = "Chr10:134914613-134914911",
                      `12` = "Chr2:54087008-54087210",
                      `13` = "Chr19:58879022-58879060",
                      `14` = "Chr11:75139390-75139681",
                      `15` = "Chr1:217306590-217306764",
                      `16` = "Chr4:3374767-3374910",
                      `18` = "Chr12:113787113-113787274",
                      `19` = "Chr6:103780364-103780469",
                      `20` = "Chr15:93652766-93653074",
                      `21` = "Chr6:164393351-164393644",
                      `23` = "Chr17:7486551-7486616",
                      `24` = "Chr7:27225855-27225866",
                      `25` = "Chr5:180646754-180646881",
                      `27` = "Chr5:126409007-126409062")) %>%
  ggplot(aes(x = dmr, y=percent_mqtl)) +
  geom_col(fill = "#254A90") +
  scale_y_continuous(name = "% CpGs as mQTLs") + 
  scale_x_discrete(name = "Cord blood DMRs") +
  theme_bw() +
  theme(panel.grid.major.x = element_blank(),
        axis.text.x = element_text(angle =  -45,  hjust= -0.0, size = 7),
        plot.margin = margin(t = 1,  # Top margin
                             r = 2,  # Right margin
                             b = 1,  # Bottom margin
                             l = 1,  # Left margin
                             unit = "cm"),
        axis.text.y = element_text(size=9))

ggsave(plot = dmr_cpg_mqtls,
       filename = here("figures",
                       "linear_regression",
                       "prenatal",
                       "2022-11-22_cord_blood_dmr_cpg_mqtl_percent.png"),
       height = 7, width = 15, units = "cm")
```


### Table 1 of prenatal model

"Table 1" of prenatal model
```{r prenatal_table1}
library(table1)

# get cell type estimates (not pcs)
cb_cell_estimates <- child_fscbc_ecc2_cb$prop
dim(cb_cell_estimates)

# subset out duplicates
cb_cell_estimates_sub <- cb_cell_estimates %>% 
  subset(rownames(.) %in% paste(cb_pdata$Sentrix_ID, cb_pdata$Sentrix_Position, sep = "_"))
dim(cb_cell_estimates_sub)

# rename rows
identical(rownames(cb_cell_estimates_sub),
          paste(cb_pdata$Sentrix_ID, cb_pdata$Sentrix_Position, sep = "_")) # TRUE
rownames(cb_cell_estimates_sub) <- cb_pdata$Sample_Label

# subset for participants with complete data
cb_cell_estimates_sub_cc <- cb_cell_estimates_sub %>%
  subset(rownames(.) %in% covariates_geno_ctpc_tech_cc$sample_id)
dim(cb_cell_estimates_sub_cc) # 128 6

# check order

identical(rownames(cb_cell_estimates_sub_cc), 
          as.character(covariates_geno_ctpc_tech_cc$sample_id)) # TRUE


# bind cell type estimates with covariate info
covariates_geno_ctpc_tech_cc_cbmc <- cbind(covariates_geno_ctpc_tech_cc, 
                                           cb_cell_estimates_sub_cc)

# table 1
table1(~sex + gestational_age + no2_prenatal_avg_2019v + 
         maternal_education_length +  maternal_race + 
         prenatal_maternal_smoke + CD4T + CD8T + nRBC + Bcell + Mono + NK,
       data = covariates_geno_ctpc_tech_cc_cbmc)

# prenatal no2 quartiles
quantile(covariates_geno_ctpc_tech_cc_cbmc$no2_prenatal_avg_2019v)
```






## Persistence of prenatal DNAm changes at age one

First we need to prepare the age one data for the linear model. Then we need to calculate the number of SVs needed for this model. 

### Load and clean age one data 

Get age one pdata
```{r y1_pdata}
#subset out age one pdata
y1_pdata <- subset(pdata_nodups, Tissue == "P")

#check size
dim(y1_pdata) # 145 17
```


Get age one betas
```{r y1_betas}
#subset out PBMC betas 
y1_betas <- betas[ ,colnames(betas) %in% rownames(y1_pdata)]

#check if age one betas and pdata are in same order
identical(colnames(y1_betas), rownames(y1_pdata)) # TRUE

#rename colums with sample label (5 dig num)
colnames(y1_betas) <- y1_pdata$Sample_Label

dim(y1_betas) # 145
```


Load age one cell type PCs
```{r y1_celltypePCs}
#load age one PBMC estimates
load(here("output_data", 
          "deconvolution", 
          "2022-09-28_PBMC_PCs.RData"))

# load deconvolution for later use - remove probes 
load(here("output_data",
          "deconvolution", 
          "2022-09-28_cbmc_pbmc_deconvolution.Rdata"))

y1_pcs <- y1_ilr$scores

#rename columns of PBMCs for clarity
colnames(y1_pcs) <- paste("pbmc", colnames(y1_pcs), sep=".")

#rename row of cell type PCs to sample label (5 digit num)
identical(rownames(y1_pcs), rownames(y1_pdata)) #true
rownames(y1_pcs) <- y1_pdata$Sample_Label

#subset cell type PCs for complete cases
y1_pcs_sub <- y1_pcs[rownames(y1_pcs) %in% covariates_geno_ctpc_tech_cc$sample_id,]
dim(y1_pcs_sub) # 128

# add age one PBMCs to covariate data frame
covariates_geno_ctpc_tech_cc_y1 <- cbind(covariates_geno_ctpc_tech_cc, y1_pcs_sub)
```


Add age one batch variables to covariate data frame
```{r y1_data_prep}
#add age one batch variables to covariate matrix
y1_pdata$y1_run <- as.factor(y1_pdata$Run) 
y1_pdata$y1_row  <- as.factor(substr(y1_pdata$Sentrix_Position,1,3)) 
y1_pdata$y1_row <- as.numeric(y1_pdata$y1_row)
y1_pdata$y1_chip <- as.factor(y1_pdata$Sentrix_ID)

covariates_geno_ctpc_tech_cc_y1 <- cbind(covariates_geno_ctpc_tech_cc_y1, 
                                         y1_pdata[y1_pdata$Sample_Label %in% covariates_geno_ctpc_tech_cc_y1$sample_id, c("y1_run", "y1_row", "y1_chip")])
```


Subset for complete cases in age one data
```{r y1_complete_cases}
#subset covariates with age one cell type PCs for linear regression
covariates_geno_ctpc_tech_cc_y1_sub <- covariates_geno_ctpc_tech_cc_y1 %>%
  subset(complete.cases(no2_prenatal_avg_2019v, sex, maternal_smoking_y1,
                        maternal_education_length,
                        pbmc.Comp.1 , pbmc.Comp.2, pbmc.Comp.3,
                        genotyping.PC1, genotyping.PC2, genotyping.PC3))

#check size
dim(covariates_geno_ctpc_tech_cc_y1_sub) # 124

#subset age one betas for samples in the complete case cord blood betas 
y1_betas_cc <- y1_betas[,colnames(y1_betas) %in%
                          as.character(covariates_geno_ctpc_tech_cc_y1_sub$sample_id)]

#check size
dim(y1_betas_cc) # 424644    124

#remove probes that were used for PBMC cell type predict from age one betas
y1_betas_cc_sub <- 
  y1_betas_cc[!rownames(y1_betas_cc) %in%
                rownames(child_fscbc_ecc2_y1$probelist_deconvo_coeffEsts), ]

#check size
dim(y1_betas_cc_sub) # 424079    124
# 565 probes removed

#check that covariates and betas in same order
identical(colnames(y1_betas_cc_sub), 
          as.character(covariates_geno_ctpc_tech_cc_y1_sub$sample_id)) # TRUE
```

Add sample name (sentrix id and row) to y1 data
```{r add_sentrix_info_y1}
# check if any y1 one samples duplicated
y1_pdata$Sample_Label %>% duplicated() %>% sum()

# subset for covariate data
y1_pdata_sub <- y1_pdata %>%
  subset(Sample_Label %in% covariates_geno_ctpc_tech_cc_y1_sub$sample_id)

# check order
identical(as.numeric(y1_pdata_sub$Sample_Label), 
          as.numeric(covariates_geno_ctpc_tech_cc_y1_sub$sample_id)) # TRUE
# check order
covariates_geno_ctpc_tech_cc_y1_sub$y1_sample_name <- rownames(y1_pdata_sub)

```

### Combined cell type PCs across two timepoint

```{r combined_cellpcs}
# load cord blood and age one blood cell type estimates
load(here("output_data",
          "deconvolution",
          "2022-09-28_cbmc_pbmc_deconvolution.Rdata"))

# pull out cell type proportion estimates'
y1_counts <- as.data.frame(child_fscbc_ecc2_y1$prop)
cb_counts <- as.data.frame(child_fscbc_ecc2_cb$prop)

# create new row in age one blood for nRBCs - set to 0
y1_counts$nRBC <- 0
# relocate nRBC column to match structure of cb data
y1_counts <- y1_counts %>% 
  relocate(nRBC, .after = NK)

# create columns for study ID in cord blood data
# check order of pdata and cell counts
identical(rownames(cb_counts), rownames(cb_pdata)) # FALSE
# remove samples in cell counts not present in pdata
cb_counts_sub <- cb_counts %>%
  subset(rownames(.) %in% rownames(cb_pdata))
# check order of pdata and cell counts
identical(rownames(cb_counts_sub), rownames(cb_pdata)) # TRUE
cb_counts_sub$Sample_Label <- cb_pdata$Sample_Label

# create columns for study ID in age one blood data
# check order of pdata and cell counts
identical(rownames(y1_counts), rownames(y1_pdata))
y1_counts$Sample_Label <- y1_pdata$Sample_Label


# subset age one cell counts for samples with cord blood cell counts
y1_counts_sub <- y1_counts %>%
  subset(Sample_Label %in% cb_counts_sub$Sample_Label)

dim(cb_counts_sub)
dim(y1_counts_sub)
identical(cb_counts_sub$Sample_Label, y1_counts_sub$Sample_Label) # TRUE

# combine cord blood and year one blood cell types into one data frame
comb_counts <- rbind(cb_counts_sub, y1_counts_sub)

# run isometric log transformation and robust PCA
comb_counts_ilr <- suppressWarnings(princomp(comb_counts[,c(1:6)], 
                                             covmat = MASS::cov.rob(comb_counts[,c(1:6)]), 
                                             cor = FALSE))

# scree plot of variance
var_explained = comb_counts_ilr$sdev^2 /sum(comb_counts_ilr$sdev^2)
ggplot(var_explained %>% as.data.frame(), aes(y=., x=(c(1:6)))) + geom_col()
cumsum(var_explained) 
# use first 3 PCs in linear mixed models
#    Comp.1    Comp.2    Comp.3    Comp.4    Comp.5    Comp.6 
# 0.6419671 0.7946265 0.9135715 0.9588014 0.9993992 1.0000000

comb_counts_pcs <- as.data.frame(comb_counts_ilr$scores)
dim(comb_counts_pcs) # 288
dim(covariates_geno_ctpc_tech_cc_y1_sub) #124

# subset combined cell counts for participants that have both birth and age one data
identical(rownames(comb_counts), rownames(comb_counts_pcs)) # TRUE
comb_counts_pcs$Sample_Label <- comb_counts$Sample_Label

comb_counts_pcs_cc <- comb_counts_pcs %>%
  subset(Sample_Label %in% covariates_geno_ctpc_tech_cc_y1_sub$sample_id)
dim(comb_counts_pcs_cc) # 248
```





### Surrogate variable analysis to account for technical variables in combined cord blood and age one blood DNAm data


```{r combined_dnam_data}
# subset for samples with data at both time points
cb_betas_geno_cc_sub <- cb_betas_geno_cc[, c(colnames(cb_betas_geno_cc) %in%
                                               colnames(y1_betas_cc_sub))]

# check columns are in the same order 
identical(colnames(cb_betas_geno_cc_sub), 
          colnames(y1_betas_cc_sub)) # TRUE

dim(cb_betas_geno_cc_sub)
dim(y1_betas_cc_sub)

# subset for cpgs shared between data
cb_betas_geno_cc_sub_cpgs <- cb_betas_geno_cc_sub[rownames(y1_betas_cc_sub), ]

dim(cb_betas_geno_cc_sub_cpgs)
dim(y1_betas_cc_sub)

# rename columns
colnames(cb_betas_geno_cc_sub_cpgs) <-
  paste("cb_", colnames(cb_betas_geno_cc_sub_cpgs), sep ="")

colnames(y1_betas_cc_sub) <-
  paste("y1_", colnames(y1_betas_cc_sub), sep ="")

comb_betas <- cbind(cb_betas_geno_cc_sub_cpgs,y1_betas_cc_sub)
dim(comb_betas) # 424079    248
```


Add combined cell type pcs to covariate data
```{r add_comb_pcs_to_y1_covariate}

cg_df <- rbind(cbind(covariates_geno_ctpc_tech_cc_y1_sub %>%
                       select(no2_prenatal_avg_2019v,
                              gestational_age,
                              prenatal_maternal_smoke, sex, 
                              maternal_education_length, 
                              genotyping.PC1, genotyping.PC2, genotyping.PC3, 
                              sample_id, cb_sample_name,
                              chip, run, row) %>%
                       dplyr::rename("no2" = no2_prenatal_avg_2019v,
                                     "smoking" = prenatal_maternal_smoke,
                                     "sample_name" = cb_sample_name),
                     timepoint = "birth"),
               cbind(covariates_geno_ctpc_tech_cc_y1_sub %>%
                       dplyr::select(no2_prenatal_avg_2019v, 
                                     gestational_age,
                                     maternal_smoking_y1, sex, 
                                     maternal_education_length,
                                     genotyping.PC1, genotyping.PC2, genotyping.PC3, 
                                     sample_id, y1_sample_name, 
                                     y1_chip, y1_row, y1_run)  %>%
                       dplyr::rename("no2" = no2_prenatal_avg_2019v,
                                     "smoking" = maternal_smoking_y1,
                                     "sample_name" = y1_sample_name,
                                     "chip" = y1_chip, "run" = y1_run,
                                     "row" = y1_row), 
                     timepoint = "ageone")) %>%
  mutate(timepoint = factor(timepoint, levels =c("birth", "ageone"))) %>%
  merge(x = ., y = comb_counts_pcs_cc, by.x = "sample_name", by.y = "row.names")

# reorder data frame to match order of betas  
cg_df_order <- cg_df %>%
  arrange(timepoint, sample_id)

# check that the order is the same
# 124 samples repeated over 2 time points
identical(as.numeric(cg_df_order$sample_id[1:124]), 
          str_sub(colnames(comb_betas)[1:124], start = 4, end = 8) %>% as.numeric())
```

Create model matrix for combined betas
```{r model_matrix}

# create model matrix
comb_mod <- model.matrix(~ timepoint*(no2 + gestational_age) + 
                           sex + maternal_education_length + smoking +
                           genotyping.PC1 + genotyping.PC2 + genotyping.PC3 +
                           Comp.1 + Comp.2 + Comp.3, 
                         data=cg_df_order)

# check size
dim(comb_mod) # 248 15
```

Calculate the number of SVs needed for age one model.
```{r comb_sv_analysis}

# create null matrix
# this matrix does not include any of our covariates 
# this means that our covariates are "protected" and SVs will not capture them
comb_mod0 <- model.matrix(~ timepoint*(gestational_age) + 
                            sex + maternal_education_length + smoking +
                            genotyping.PC1 + genotyping.PC2 + genotyping.PC3 +
                            Comp.1 + Comp.2 + Comp.3, 
                          data=cg_df_order)


################
# sva analysis #
################

##################################
# numsv function internal to sva #
##################################

#determine the number of required SVs
#this is numsv function code pulled out

set.seed(1234)

#this is what is fed into this function from the sva function
dat = as.matrix(comb_betas)
mod = comb_mod
mod0 = comb_mod0
#method="be" # this is the default and what is called by numsv
#vfilter=NULL # we dont apply a filter and its not used for be method
B=20


# initialize some stuff
# get the residual matrix (the remaining variance)
n <- ncol(dat)
m <- nrow(dat)
H <- mod %*% solve(t(mod) %*% mod) %*% t(mod)
res <- dat - t(H %*% t(dat))

# run svd and get some eigenvalues
uu <- svd(res)
# get the num of "sig" eigenvalues
ndf <- min(m, n) - ceiling(sum(diag(H)))
# get percent variance explained by each eigenvalue
dstat <- uu$d[1:ndf]^2/sum(uu$d[1:ndf]^2)
# initialize null distribution matrix
dstat0 <- matrix(0, nrow = B, ncol = ndf)

# set seed here since we are calling sample
# create the null distribution
for (i in 1:B) {
  # this part of the code removes all relationships in the 
  res0 <- t(apply(res, 1, sample, replace = FALSE))
  res0 <- res0 - t(H %*% t(res0))
  # calculate svs on this
  uu0 <- svd(res0)
  # bind their explained variance in null matrix
  dstat0[i, ] <- uu0$d[1:ndf]^2/sum(uu0$d[1:ndf]^2)
  print(i) # print out the iteration we are on
}

# determine the number of svs required here based on pvalues
psv <- rep(1, n)
for (i in 1:ndf) {
  psv[i] <- mean(dstat0[, i] >= dstat[i])
}
for (i in 2:ndf) {
  psv[i] <- max(psv[(i - 1)], psv[i])
}

# this is the variable holding the number of SVs required 
# number is each to all the svs with a pval less than/equal to 0.1
nsv <- sum(psv <= 0.1)


####################################
# code from the main SVA function  #
####################################

n.sv = nsv # from code above (run internally when sva called)
B = 5 # number of iterations

# dat =  betas # already initialized
# mod = mod  # already initialized
# mod0 = mod0  # already initialized 
# controls = NULL # we dont include controls - only for supervised method
# method = "irw" # this isnt actually used but would be called by sva
# vfilter = NULL # we dont set this when running sva
# numSVmethod = "be" # this is the default called by sva (code above)


###################################
# irwsva function internal to sva #
###################################

# this code is really want does all the work in sva
# we use the irw method so this is the code for that method
# there are also supervised and two step methods (not used by us)

# irw function takes input from sva, so we have already defined below vars
# dat = dat 
# mod = mod
# mod0 = mod0
# n.sv = n.sv
# B = B

# intialize variables again
n <- ncol(dat)
m <- nrow(dat)
Id <- diag(n)
resid <- dat %*% (Id - mod %*% solve(t(mod) %*% mod) %*% t(mod))
uu <- eigen(t(resid) %*% resid)
vv <- uu$vectors
ndf <- n - dim(mod)[2]
pprob <- rep(1, m)
one <- rep(1, n)
Id <- diag(n)
df1 <- dim(mod)[2] + n.sv
df0 <- dim(mod0)[2] + n.sv
rm(resid)

cat(paste("Iteration (out of", B, "):"))
for (i in 1:B) {
  mod.b <- cbind(mod, uu$vectors[, 1:n.sv])
  mod0.b <- cbind(mod0, uu$vectors[, 1:n.sv])
  ptmp <- f.pvalue(dat, mod.b, mod0.b)
  pprob.b <- (1 - edge.lfdr(ptmp))
  mod.gam <- cbind(mod0, uu$vectors[, 1:n.sv])
  mod0.gam <- cbind(mod0)
  ptmp <- f.pvalue(dat, mod.gam, mod0.gam)
  pprob.gam <- (1 - edge.lfdr(ptmp))
  pprob <- pprob.gam * (1 - pprob.b)
  dats <- dat * pprob
  dats <- dats - rowMeans(dats)
  uu <- eigen(t(dats) %*% dats)
  cat(paste(i, " "))
}

# this is what is normally returned by sva
# problem is that it doesnt include the diagonal matrix we want
sv_comb = svd(dats)$v[, 1:n.sv, drop = FALSE] 
svobj_comb <- list(sv = sv_comb, pprob.gam = pprob.gam, pprob.b = pprob.b, 
                   n.sv = n.sv)

# to get all info (including diagonal)
svobj_all_comb <- svd(dats)

# populate rownames with sample ids
colnames(svobj_all_comb$v) <- covariates_geno_ctpc_tech_cc_y1_sub$sampleid


# save 
save(sv_comb, file = here("output_data", 
                          "linear_regression", 
                          "2022-11-16_combined_cb_y1_svs_with_interaction.RData"))

###############
#scree of SVs #
###############

# from elodie portales-casamar

# heat scree prepartion
vars <- svobj_all_comb[['d']]^2
vars <- vars/sum(vars)
names(vars) <- paste0('SV', 1:length(vars))
xp <- 1:svobj_comb$n.sv
varsdf <- as.data.frame(vars)
varsdf$svnum <- rep(1:length(vars)) 
# use 16

# heat scree ggplot!! 
comb_sv_scree <- ggplot(varsdf[1:20,], aes(x=svnum, y=vars*100)) +
  geom_col() +
  theme_bw() +
  labs(x="Surrogate Variables", y = "Variance (%)")

comb_sv_scree

ggsave(plot = comb_sv_scree, 
       filename = here("figures", 
                       "linear_regression", 
                       "prenatal", 
                       "2022-11-17_cb_y1_comb_sv_heat_scree.png"),
       height = 5, width = 15, units = "cm")


######################
# correlation matrix #
######################

# add svs to covariates
cg_df_order_svs <- cbind(cg_df_order, sv_comb)

# rename columns with svs
colnames(cg_df_order_svs)[22:117] <-
  paste("comb_sv",colnames(cg_df_order_svs)[22:117], sep="")

source(here("scripts", "2021-08-30_corr_mat_funs.R"))

# early exp and pn_18 are the same thing. 
# exclude early_exp from correlation matrices
corr_comb <- corr.mat(cg_df_order_svs %>% 
                        dplyr::select(no2, gestational_age, sex, 
                                      maternal_education_length, smoking,
                                      genotyping.PC1, genotyping.PC2,
                                      genotyping.PC3, Comp.1, Comp.2, Comp.3,
                                      chip, run, row, 
                                      comb_sv1:comb_sv16) %>% 
                        dplyr::rename("NO2 exposure" = no2,
                                      "Sex" = sex, 
                                      "Gestational age (days)" = gestational_age,
                                      "Maternal education (years)" = maternal_education_length,
                                      "Maternal smoking" =  smoking,
                                      "Genetic ancestry PC1" = genotyping.PC1,
                                      "Genetic ancestry PC2" = genotyping.PC2,
                                      "Genetic ancestry PC3" = genotyping.PC3,
                                      "Cell type PC1" = Comp.1,
                                      "Cell type PC2" = Comp.2,
                                      "Cell type PC3" = Comp.3,
                                      "Chip" = chip, 
                                      "Run" = run, 
                                      "Row" = row,
                                      "SV1" = comb_sv1, "SV2" = comb_sv2,
                                      "SV3" = comb_sv3, "SV4" = comb_sv4,
                                      "SV5" = comb_sv5, "SV6" = comb_sv6,
                                      "SV7" = comb_sv7, "SV8" = comb_sv8,
                                      "SV9" = comb_sv9, "SV10" = comb_sv10,
                                      "SV11" = comb_sv11, "SV12" = comb_sv12,
                                      "SV13" = comb_sv13, "SV14" = comb_sv14,
                                      "SV15" = comb_sv15, "SV16" = comb_sv16)) 

pval_comb <- pval.mat(cg_df_order_svs %>% 
                        dplyr::select(no2, gestational_age, sex, 
                                      maternal_education_length, smoking,
                                      genotyping.PC1, genotyping.PC2,
                                      genotyping.PC3, Comp.1, Comp.2, Comp.3,
                                      chip, run, row, 
                                      comb_sv1:comb_sv16)%>% 
                        dplyr::rename("NO2 exposure" = no2,
                                      "Sex" = sex, 
                                      "Gestational age (days)" = gestational_age,
                                      "Maternal education (years)" = maternal_education_length,
                                      "Maternal smoking" =  smoking,
                                      "Genetic ancestry PC1" = genotyping.PC1,
                                      "Genetic ancestry PC2" = genotyping.PC2,
                                      "Genetic ancestry PC3" = genotyping.PC3,
                                      "Cell type PC1" = Comp.1,
                                      "Cell type PC2" = Comp.2,
                                      "Cell type PC3" = Comp.3,
                                      "Chip" = chip, 
                                      "Run" = run, 
                                      "Row" = row,
                                      "SV1" = comb_sv1, "SV2" = comb_sv2,
                                      "SV3" = comb_sv3, "SV4" = comb_sv4,
                                      "SV5" = comb_sv5, "SV6" = comb_sv6,
                                      "SV7" = comb_sv7, "SV8" = comb_sv8,
                                      "SV9" = comb_sv9, "SV10" = comb_sv10,
                                      "SV11" = comb_sv11, "SV12" = comb_sv12,
                                      "SV13" = comb_sv13, "SV14" = comb_sv14,
                                      "SV15" = comb_sv15, "SV16" = comb_sv16)) 


svcorr_comb <- corr.plot(pval = pval_comb, 
                         corr = corr_comb, 
                         label.sig = T, 
                         shape = 8,shape.size = 1,
                         axis.text.size = 8, x.axis.text.angle = 90) +
  scale_y_discrete(position = "right") +
  theme(legend.position = "none",
        panel.grid = element_blank())
svcorr_comb

ggsave(plot = svcorr_comb,
       filename = here("figures", 
                       "linear_regression", 
                       "prenatal",
                       "2022-11-17_comb_cb_y1_sv_correlations.png"),
       height = 15,
       width = 15, 
       units = "cm")
```


### Linear mixed models regressions examining persistence at significant CpGs/DMRs

Examine persistence of of DMR prenatal changes at age one.
```{r dmr_persistence}

# check order of data and dnam
identical(as.numeric(str_sub(colnames(comb_betas), 4, 8)), 
          as.numeric(cg_df_order_svs$sample_id)) # true

cg_df_order_svs_cpgs <- 
  cbind(cg_df_order_svs, 
        t(comb_betas[combp_anno_df_es_sub_escutoff_mqtls %>% pull(Name), ]))

lmer_results <- NULL
lmer_pvals <- NULL
lmer_coeffs <- NULL

for(i in 118:268){
  
  cg_df_order_svs_cpgs$dnam <- cg_df_order_svs_cpgs[,i] 
  cg_lmer <- lmer(dnam ~  timepoint*(no2 + gestational_age)  + sex +  
                    maternal_education_length + smoking +
                    genotyping.PC1 + genotyping.PC2 + genotyping.PC3 + 
                    Comp.1 + Comp.2 + Comp.3 + comb_sv1 + comb_sv2 +
                    comb_sv3 + comb_sv4 + comb_sv5 + comb_sv6 + comb_sv7 +
                    comb_sv8 + comb_sv9 + comb_sv10 + comb_sv11 + comb_sv12 +
                    comb_sv13 + comb_sv14 + comb_sv15 + comb_sv16 +
                    (1 |sample_id), 
                  data = cg_df_order_svs_cpgs)
  
  lmer_results <- c(lmer_results, cg_lmer)
  lmer_pvals <- cbind(lmer_pvals, summary(cg_lmer)$coefficients[c(1,2,3,30),5])
  lmer_coeffs <- cbind(lmer_coeffs, summary(cg_lmer)$coefficients[c(1,2,3,30),1])
  
}

names(lmer_results) <- combp_anno_df_es_sub_escutoff_mqtls %>% pull(Name)

lmer_pvals <- lmer_pvals %>% 
  t() %>% 
  as.data.frame() %>% 
  rename_with(., ~ paste("pval", .x, sep="_"))

lmer_coeffs <- lmer_coeffs %>% 
  t() %>% 
  as.data.frame() %>% 
  rename_with(., ~ paste("coef", .x, sep="_"))

lmer_pvals_dmrs <- lmer_pvals %>% 
  cbind(., lmer_coeffs) %>%
  as.data.frame() %>%
  #rename("pval" = 1) %>%
  mutate(dmr = combp_anno_df_es_sub_escutoff_mqtls$dmr,
         cpg = combp_anno_df_es_sub_escutoff_mqtls$Name,
         singular = lapply(lmer_results, isSingular) %>% do.call(rbind,.),
         pval_no2_adj = p.adjust(pval_no2, method = "bonferroni"),
         pval_timepointageone_adj = p.adjust(pval_timepointageone, method = "bonferroni"),
         `pval_timepointageone:no2_adj` = p.adjust(`pval_timepointageone:no2`, method = "bonferroni"),
         coef_no2_age_one = coef_no2 + `coef_timepointageone:no2`) %>%
  mutate( change = ifelse(abs(coef_no2_age_one) > abs(coef_no2), "larger", "smaller"),
          birth_effect_size = coef_no2 * range,
          y1_effect_size = coef_no2_age_one * range) 

# combine persistence info with info from ewas
colnames(lmer_pvals_dmrs) <- paste("lme", colnames(lmer_pvals_dmrs), sep="_")
colnames(combp_anno_df_es_sub_escutoff_mqtls)[c(37,38)] <- 
  paste("lm", colnames(combp_anno_df_es_sub_escutoff_mqtls)[c(37,38)], sep="_")
dmrs_lm_lme <- merge(x=combp_anno_df_es_sub_escutoff_mqtls, y=lmer_pvals_dmrs, by.x = 5, by.y = 10)
dmrs_lm_lme_sub <- dmrs_lm_lme %>% select(-c(lme_dmr, Row.names, analysis))


write.csv(dmrs_lm_lme_sub, file = here ("tables",
                                        "prenatal",
                                        "2022-11-23_prenatal_no2_dmr_cpg_persistence.csv"))

# examine effect sizes from lme models vs those from ewas
lmer_effect_sizes <- lmer_pvals_dmrs %>%
  group_by(dmr) %>%
  summarise(mean_birth_es = mean(birth_effect_size),
            mean_y1_es = mean(y1_effect_size)) %>%
  cbind(., combp_anno_df_es_sub_escutoff %>% 
          group_by(dmr) %>%
          summarise(ewas_birth_es = mean(effect_size)))



write.csv(lmer_effect_sizes, file = here ("tables",
                                          "prenatal",
                                          "2022-11-22_prenatal_no2_dmr_cpg_persistence_effect_size_by_dmr.csv"))

# visualize
dmr_persistence <- lmer_pvals_dmrs %>% 
  mutate(sig = ifelse(`pval_timepointageone:no2_adj` < 0.05, T, F),
         start = ifelse(coef_no2 < 0, "lower", "higher")) %>%
  mutate(start = factor(start, levels =c("lower", "higher"))) %>%
  select(birth_effect_size, y1_effect_size, cpg, sig, start, change) %>%
  pivot_longer(cols = -c(cpg, sig, start, change)) %>%
  ggplot(aes(x=name, y = value, group=cpg, shape = change)) +
  geom_point(alpha = 0.7, color = "#254A90") + 
  geom_line(alpha = 0.7, color = "#254A90") + 
  facet_wrap(~start) + 
  scale_shape_manual(values = c(17,16), 
                     labels = c("Larger", "Smaller"), 
                     name = " Coefficient\nmagnitude") + 
  scale_x_discrete(labels = c("Birth", "Age one"), name = element_blank()) +
  scale_y_continuous(name = "Prenatal NO2 effect size (% DNAm)") +
  theme_bw() +
  theme(panel.grid.major.x = element_blank(),
        axis.text.x = element_text(size=9),
        axis.text.y = element_text(size=9),
        strip.background = element_blank(),
        legend.text = element_text(size=9),
        legend.title = element_blank(),
        legend.position = "none") 
#legend.margin = margin(t = 0, r = 0, l = 0, b=0, unit='cm'),
#legend.box.margin = margin(t = 0, r = 0, l = 0, b=0, unit='cm'))

ggsave(plot = dmr_persistence,
       filename = here("figures",
                       "linear_regression",
                       "prenatal",
                       "2022-11-20_dmr_persistence.png"),
       height = 6, width = 6.5, units="cm")
# 
# # test with cg10906729
# covariates_geno_ctpc_tech_cc_y1_sub$y1_cg12764003 <- y1_betas_cc_sub["cg12764003",] 
# 
# # linear regression
# y1_cg12764003_lm <- lm(y1_cg12764003 ~  
#                          no2_prenatal_avg_2019v + sex + maternal_smoking_y1 +
#                          maternal_education_length +
#                          pbmc.Comp.1 + pbmc.Comp.2 + pbmc.Comp.3 +
#                          genotyping.PC1 + genotyping.PC2 + genotyping.PC3 +
#                          y1sv1 + y1sv2 + y1sv3 + y1sv4 + y1sv5 + y1sv6 + y1sv7 + y1sv8 + y1sv9 +
#                          y1sv10 + y1sv11 + y1sv12 + y1sv13 + y1sv14 + y1sv15 + y1sv16 + y1sv17 + 
#                          y1sv18 + y1sv19, 
#                        data=covariates_geno_ctpc_tech_cc_y1_sub)
# 
# # summary of lm
# summary(y1_cg12764003_lm) # pvalue = 0.063860
# # no2_prenatal_avg_2019v    -0.0030214  0.0007943  -3.804 0.000253 ***
# 
# # pval_(Intercept) pval_no2_prenatal_avg_2019v
# # 9.134913e-05                0.0001500842
# # 
# #  coeff_(Intercept)      coeff_no2_prenatal_avg_2019v 
# #  0.8596572               -0.003790429
# 
# # test with cg02574073
# 
# # ggplot(data=NULL) +
# # +     geom_point(aes(y=covariates_geno_ctpc_tech_cc_y1_sub_cpgs$birth_cg02649248,
# # +                    x=covariates_geno_ctpc_tech_cc_y1_sub_cpgs$no2_prenatal_avg_2019v)) +
# # +     geom_point(aes(y=covariates_geno_ctpc_tech_cc_y1_sub_cpgs$age_one_cg02649248,
# # +                    x=covariates_geno_ctpc_tech_cc_y1_sub_cpgs$no2_prenatal_avg_2019v, col = "red"))
# 
# covariates_geno_ctpc_tech_cc_y1_sub$y1_cg02574073 <- y1_betas_cc_sub["cg02574073",] 
# 
# # linear regression
# y1_cg02574073_lm <- lm(y1_cg02574073 ~  
#                          no2_prenatal_avg_2019v + sex + maternal_smoking_y1 +
#                          maternal_education_length +
#                          pbmc.Comp.1 + pbmc.Comp.2 + pbmc.Comp.3 +
#                          genotyping.PC1 + genotyping.PC2 + genotyping.PC3 +
#                          y1sv1 + y1sv2 + y1sv3 + y1sv4 + y1sv5 + y1sv6 + y1sv7 + y1sv8 + y1sv9 +
#                          y1sv10 + y1sv11 + y1sv12 + y1sv13 + y1sv14 + y1sv15 + y1sv16 + y1sv17 + 
#                          y1sv18 + y1sv19, 
#                        data=covariates_geno_ctpc_tech_cc_y1_sub)
# 
# # summary of lm
# summary(y1_cg02574073_lm) # pvalue = 0.063860
# 
# 
# # test with cg05888755
# 
# covariates_geno_ctpc_tech_cc_y1_sub$y1_cg05888755 <- y1_betas_cc_sub["cg05888755",] 
# 
# # linear regression
# y1_cg05888755_lm <- lm(y1_cg05888755 ~  
#                          no2_prenatal_avg_2019v + sex + maternal_smoking_y1 +
#                          maternal_education_length +
#                          pbmc.Comp.1 + pbmc.Comp.2 + pbmc.Comp.3 +
#                          genotyping.PC1 + genotyping.PC2 + genotyping.PC3 +
#                          y1sv1 + y1sv2 + y1sv3 + y1sv4 + y1sv5 + y1sv6 + y1sv7 + y1sv8 + y1sv9 +
#                          y1sv10 + y1sv11 + y1sv12 + y1sv13 + y1sv14 + y1sv15 + y1sv16 + y1sv17 + 
#                          y1sv18 + y1sv19, 
#                        data=covariates_geno_ctpc_tech_cc_y1_sub)
# 
# # summary of lm
# summary(y1_cg05888755_lm) # pvalue = 0.063860
# 
# # test with cg01564268
# 
# covariates_geno_ctpc_tech_cc_y1_sub$y1_cg01564268 <- y1_betas_cc_sub["cg01564268",] 
# 
# # linear regression
# y1_cg01564268_lm <- lm(y1_cg01564268 ~  
#                          no2_prenatal_avg_2019v + sex + maternal_smoking_y1 +
#                          maternal_education_length +
#                          pbmc.Comp.1 + pbmc.Comp.2 + pbmc.Comp.3 +
#                          genotyping.PC1 + genotyping.PC2 + genotyping.PC3 +
#                          y1sv1 + y1sv2 + y1sv3 + y1sv4 + y1sv5 + y1sv6 + y1sv7 + y1sv8 + y1sv9 +
#                          y1sv10 + y1sv11 + y1sv12 + y1sv13 + y1sv14 + y1sv15 + y1sv16 + y1sv17 + 
#                          y1sv18 + y1sv19, 
#                        data=covariates_geno_ctpc_tech_cc_y1_sub)
# 
# # summary of lm
# summary(y1_cg01564268_lm) # pvalue = 0.063860
# 
# # test with cg04645039
# 
# covariates_geno_ctpc_tech_cc_y1_sub$y1_cg04645039 <- y1_betas_cc_sub["cg04645039",] 
# 
# # linear regression
# y1_cg04645039_lm <- lm(y1_cg04645039 ~  
#                          no2_prenatal_avg_2019v + sex + maternal_smoking_y1 +
#                          maternal_education_length +
#                          pbmc.Comp.1 + pbmc.Comp.2 + pbmc.Comp.3 +
#                          genotyping.PC1 + genotyping.PC2 + genotyping.PC3 +
#                          y1sv1 + y1sv2 + y1sv3 + y1sv4 + y1sv5 + y1sv6 + y1sv7 + y1sv8 + y1sv9 +
#                          y1sv10 + y1sv11 + y1sv12 + y1sv13 + y1sv14 + y1sv15 + y1sv16 + y1sv17 + 
#                          y1sv18 + y1sv19, 
#                        data=covariates_geno_ctpc_tech_cc_y1_sub)
# 
# # summary of lm
# summary(y1_cg04645039_lm) # pvalue = 0.063860
# 
# 
# # test with cg24534926
# 
# covariates_geno_ctpc_tech_cc_y1_sub$y1_cg24534926 <- y1_betas_cc_sub["cg24534926",] 
# 
# # linear regression
# y1_cg24534926_lm <- lm(y1_cg24534926 ~  
#                          no2_prenatal_avg_2019v + sex + maternal_smoking_y1 +
#                          maternal_education_length +
#                          pbmc.Comp.1 + pbmc.Comp.2 + pbmc.Comp.3 +
#                          genotyping.PC1 + genotyping.PC2 + genotyping.PC3 +
#                          y1sv1 + y1sv2 + y1sv3 + y1sv4 + y1sv5 + y1sv6 + y1sv7 + y1sv8 + y1sv9 +
#                          y1sv10 + y1sv11 + y1sv12 + y1sv13 + y1sv14 + y1sv15 + y1sv16 + y1sv17 + 
#                          y1sv18 + y1sv19, 
#                        data=covariates_geno_ctpc_tech_cc_y1_sub)
# 
# # summary of lm
# summary(y1_cg24534926_lm) # pvalue = 0.063860
# 
# # test with cg24534926
# 
# covariates_geno_ctpc_tech_cc_y1_sub$y1_cg05579037 <- y1_betas_cc_sub["cg05579037",] 
# 
# # linear regression
# y1_cg05579037_lm <- lm(y1_cg05579037 ~  
#                          no2_prenatal_avg_2019v + sex + maternal_smoking_y1 +
#                          maternal_education_length +
#                          pbmc.Comp.1 + pbmc.Comp.2 + pbmc.Comp.3 +
#                          genotyping.PC1 + genotyping.PC2 + genotyping.PC3 +
#                          y1sv1 + y1sv2 + y1sv3 + y1sv4 + y1sv5 + y1sv6 + y1sv7 + y1sv8 + y1sv9 +
#                          y1sv10 + y1sv11 + y1sv12 + y1sv13 + y1sv14 + y1sv15 + y1sv16 + y1sv17 + 
#                          y1sv18 + y1sv19, 
#                        data=covariates_geno_ctpc_tech_cc_y1_sub)
# 
# # summary of lm
# summary(y1_cg05579037_lm) # pvalue = 0.063860
# 
# # test with cg05774699
# 
# covariates_geno_ctpc_tech_cc_y1_sub$y1_cg05774699 <- y1_betas_cc_sub["cg05774699",] 
# 
# # linear regression
# y1_cg05774699_lm <- lm(y1_cg05774699 ~  
#                          no2_prenatal_avg_2019v + sex + maternal_smoking_y1 +
#                          maternal_education_length +
#                          pbmc.Comp.1 + pbmc.Comp.2 + pbmc.Comp.3 +
#                          genotyping.PC1 + genotyping.PC2 + genotyping.PC3 +
#                          y1sv1 + y1sv2 + y1sv3 + y1sv4 + y1sv5 + y1sv6 + y1sv7 + y1sv8 + y1sv9 +
#                          y1sv10 + y1sv11 + y1sv12 + y1sv13 + y1sv14 + y1sv15 + y1sv16 + y1sv17 + 
#                          y1sv18 + y1sv19, 
#                        data=covariates_geno_ctpc_tech_cc_y1_sub)
# 
# # summary of lm
# summary(y1_cg05774699_lm) # pvalue = 0.063860
# 
# 
# # test with cg07049592
# 
# covariates_geno_ctpc_tech_cc_y1_sub$y1_cg07049592 <- y1_betas_cc_sub["cg07049592",] 
# 
# # linear regression
# y1_cg07049592_lm <- lm(y1_cg07049592 ~  
#                          no2_prenatal_avg_2019v + sex + maternal_smoking_y1 +
#                          maternal_education_length +
#                          pbmc.Comp.1 + pbmc.Comp.2 + pbmc.Comp.3 +
#                          genotyping.PC1 + genotyping.PC2 + genotyping.PC3 +
#                          y1sv1 + y1sv2 + y1sv3 + y1sv4 + y1sv5 + y1sv6 + y1sv7 + y1sv8 + y1sv9 +
#                          y1sv10 + y1sv11 + y1sv12 + y1sv13 + y1sv14 + y1sv15 + y1sv16 + y1sv17 + 
#                          y1sv18 + y1sv19, 
#                        data=covariates_geno_ctpc_tech_cc_y1_sub)
# 
# # summary of lm
# summary(y1_cg07049592_lm) # pvalue = 0.063860
```



### Examine changes in effect size at top 100 CpGs from EWAS over the first year of life 

```{r top100_effect_size_persistence}

# get top 100 cord blood cpgs 
cb100 <- cb_pvals_tech %>% 
  subset(effect_size > 0.025 | effect_size < -0.025) %>%
  arrange(pval_no2_prenatal_avg_2019v) %>%
  slice_head(n=100)


# get birth and age one dnam for top 100 cord blood cpgs
cb_top100_betas <- 
  cb_betas_geno_cc_clean_df[rownames(cb100), 
                            str_sub(colnames(y1_betas_cc_sub[rownames(cb100), ] ),4,8)] %>%
  t() %>%
  as.data.frame() 
# rename_with(., ~ paste("cb", .x, sep="_"))

y1_top100_betas <- 
  y1_betas_cc_sub[rownames(cb100), ] %>%
  t() %>%
  as.data.frame()
# rename_with(., ~ paste("y1", .x, sep="_"))


# check order
identical(rownames(cb_top100_betas), 
          str_sub(rownames(y1_top100_betas), 4, 8)) # TRUE

identical(rownames(cb_top100_betas), 
          cg_df_order_svs_cpgs %>%
            subset(timepoint=="birth") %>% 
            pull(sample_id) %>% 
            as.character())

top100_betas <- rbind(cb_top100_betas, 
                      y1_top100_betas)

colnames(top100_betas) <- paste("top100_",
                                colnames(top100_betas),
                                sep="")

cg_df_order_svs_cpgs_top100cpgs <- 
  cbind(cg_df_order_svs_cpgs, top100_betas)



lmer_results_cpgs <- NULL
lmer_pvals_cpgs <- NULL
lmer_coeffs_cpgs <- NULL

for(i in 270:369){
  
  cg_df_order_svs_cpgs_top100cpgs$dnam <- cg_df_order_svs_cpgs_top100cpgs[,i] 
  
  cg_lmer_cpgs <- lmer(dnam ~  timepoint*(no2 + gestational_age)  + sex +  
                         maternal_education_length + smoking +
                         genotyping.PC1 + genotyping.PC2 + genotyping.PC3 + 
                         Comp.1 + Comp.2 + Comp.3 + comb_sv1 + comb_sv2 +
                         comb_sv3 + comb_sv4 + comb_sv5 + comb_sv6 + comb_sv7 +
                         comb_sv8 + comb_sv9 + comb_sv10 + comb_sv11 + comb_sv12 +
                         comb_sv13 + comb_sv14 + comb_sv15 + comb_sv16 + (1 |sample_id), 
                       data = cg_df_order_svs_cpgs_top100cpgs)
  
  lmer_results_cpgs <- c(lmer_results_cpgs, cg_lmer_cpgs)
  lmer_pvals_cpgs <- cbind(lmer_pvals_cpgs, summary(cg_lmer_cpgs)$coefficients[c(1,2,3,30),5])
  lmer_coeffs_cpgs <- cbind(lmer_coeffs_cpgs, summary(cg_lmer_cpgs)$coefficients[c(1,2,3,30),1])
}

names(lmer_results_cpgs) <- colnames(top100_betas)


lmer_pvals_cpgs <- lmer_pvals_cpgs %>% 
  t() %>% 
  as.data.frame() %>% 
  rename_with(., ~ paste("pval", .x, sep="_"))

lmer_coeffs_cpgs <- lmer_coeffs_cpgs %>% 
  t() %>% 
  as.data.frame() %>% 
  rename_with(., ~ paste("coef", .x, sep="_"))

lmer_pvals_cpgs_results <- lmer_pvals_cpgs %>% 
  cbind(., lmer_coeffs_cpgs) %>%
  as.data.frame() %>%
  mutate(cpg = cb_pvals_tech %>% 
           subset(effect_size > 0.025 | effect_size < -0.025) %>%
           arrange(pval_no2_prenatal_avg_2019v) %>%
           slice_head(n=100) %>% 
           pull(Name),
         singular = as.vector(lapply(lmer_results_cpgs, isSingular) %>% do.call(rbind,.))) %>%
  #subset(singular != TRUE) %>%
  mutate(pval_no2_adj = p.adjust(pval_no2, "bonferroni"),
         pval_timepointageone_adj = p.adjust(pval_timepointageone, "bonferroni"),
         `pval_timepointageone:no2_adj` = p.adjust(`pval_timepointageone:no2`, "bonferroni"),
         coef_no2_age_one = coef_no2 + `coef_timepointageone:no2`) %>%
  mutate( change = ifelse(abs(coef_no2_age_one) > abs(coef_no2), "larger", "smaller"),
          y1_effect_size = coef_no2_age_one*range,
          birth_effect_size = coef_no2*range) 


write.csv(lmer_pvals_cpgs_results, file = here ("tables",
                                                "prenatal",
                                                "2022-11-20_prenatal_no2_top100_persistence.csv"))

# combine persistence info with info from ewas
colnames(lmer_pvals_cpgs_results) <- paste("lme", colnames(lmer_pvals_cpgs_results), sep="_")

top100_lm_lme <- merge(x=cb_pvals_tech[,c(61:93,95)], y=lmer_pvals_cpgs_results, by.x = 1, by.y = 9)
colnames(top100_lm_lme)[34] <- paste("lm", colnames(top100_lm_lme)[34], sep="_")

write.csv(top100_lm_lme, file = here ("tables",
                                      "prenatal",
                                      "2022-11-23_prenatal_no2_top100_persistence_lm_lme.csv"))

# visualize
top100_persistence <- lmer_pvals_cpgs_results %>% 
  mutate(sig = ifelse(`pval_timepointageone:no2_adj` < 0.05, T, F),
         start = ifelse(coef_no2 < 0, "Smaller", "Larger")) %>%
  mutate(start = factor(start, levels =c("Smaller", "Larger"))) %>%
  select(birth_effect_size, y1_effect_size, cpg, sig, start, change) %>%
  pivot_longer(cols = -c(cpg, sig, start, change)) %>%
  ggplot(aes(x=name, y = value, group=cpg, color = sig, shape = change)) +
  geom_point(alpha = 0.7) + 
  geom_line(alpha = 0.7) + 
  facet_wrap(~start) + 
  theme_bw() +
  scale_shape_manual(values = c(17,16), labels = c("Larger", "Smaller")) + 
  scale_x_discrete(labels = c("Birth", "Age one"), name = element_blank()) +
  scale_y_continuous(name = "Prenatal NO2 effect size (% DNAm)") +
  scale_color_manual(values = c("#254A90", "red2"), name = "Adjusted p", labels = c(">=0.05", "<0.05")) +
  theme(panel.grid.major.x = element_blank(),
        axis.text.x = element_text(size=9),
        axis.text.y = element_text(size=9),
        strip.background = element_blank(),
        legend.text = element_text(size=9),
        legend.title = element_blank(),
        legend.position = "none")


ggsave(plot = top100_persistence,
       filename = here("figures",
                       "linear_regression",
                       "prenatal",
                       "2022-11-20_top100_persistence.png"),
       height = 6, width = 6.5, units="cm")
```



### Table 1 for persistence model

```{r age_one_persistence_table1}
library(table1)

# get cell type estimates (not pcs)
y1_cell_estimates <- child_fscbc_ecc2_y1$prop
dim(y1_cell_estimates) # 145

# rename rows
identical(rownames(y1_cell_estimates_sub),
          paste(y1_pdata$Sentrix_ID, y1_pdata$Sentrix_Position, sep = "_")) # TRUE
rownames(y1_cell_estimates_sub) <- y1_pdata$Sample_Label

# subset for participants with complete data
y1_cell_estimates_sub_cc <- y1_cell_estimates_sub %>%
  subset(rownames(.) %in% covariates_geno_ctpc_tech_cc_y1_sub$sample_id)
dim(y1_cell_estimates_sub_cc) # 124 6

# check order
identical(rownames(y1_cell_estimates_sub_cc), 
          as.character(covariates_geno_ctpc_tech_cc_y1_sub$sample_id)) # TRUE

# bind cell type estimates with covariate info
covariates_geno_ctpc_tech_cc_y1_sub_pbmc <- cbind(covariates_geno_ctpc_tech_cc_y1_sub, 
                                                  y1_cell_estimates_sub_cc)

# table 1
table1(~sex + no2_prenatal_avg_2019v + 
         maternal_education_length +  maternal_race + 
         maternal_smoking_y1 + CD4T + CD8T  + Bcell + Mono + NK,
       data = covariates_geno_ctpc_tech_cc_y1_sub_pbmc)

# prenatal no2 quartiles
quantile(covariates_geno_ctpc_tech_cc_y1_sub_pbmc$no2_prenatal_avg_2019v)

```


## Prenatal and postnatal air pollution exposure boxplots

```{r airpollution_boxplots}

# prenatal no2
ggplot(covariates_geno_ctpc_tech_cc, aes(y=no2_preg_entire, x=studycentre, fill=studycentre)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(height=0, width=0.25, alpha=0.8) +
  theme_bw() +
  scale_fill_manual(values=c("#254A90", "#508FC2", "#92C5EB", "white")) +
  labs(x="Study Centre", y=bquote("Prenatal" ~NO[2]~ "(ppb)")) +
  theme(panel.grid = element_blank(),
        legend.position = "none",
        axis.text = element_text(size=14),
        axis.title = element_text(size=16))

# year one no2
ggplot(covariates_geno_ctpc_tech_cc_y1_sub, aes(y=no2_y1_entire, x=studycentre,fill=studycentre)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(height=0, width=0.25, alpha=0.8) +
  scale_fill_manual(values=c("#254A90", "#508FC2", "#92C5EB", "white")) +
  labs(x="Study Centre", y=bquote("Year one" ~NO[2]~ "(ppb)")) +
  theme_bw() +
  theme(panel.grid = element_blank(),
        legend.position = "none",
        axis.text = element_text(size=14),
        axis.title = element_text(size=16))

# Pm2.5 B
ggplot(covariates_geno_ctpc_tech, aes(y=PM25DALbYY_01, x=studycentre, fill=studycentre)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(height=0, width=0.25, alpha=0.8) +
  scale_fill_manual(values=c("#254A90", "#508FC2", "#92C5EB", "white")) +
  labs(x="Study Centre", y=bquote(~PM[2.5]~ "(ppb)")) +
  theme_bw() +
  theme(panel.grid = element_blank(),
        legend.position = "none",
        axis.text = element_text(size=14),
        axis.title = element_text(size=16))
```


Prenatal air pollution exposure vs asthma in cord blood 
```{r no2_vs_asthma_cordblood}
wheeze_no2 <- covariates_geno_ctpc_tech_cc %>%
  subset(!is.na(any_wheeze_y1)) %>%
  select(any_wheeze_y1, prenatal_maternal_smoke,
         no2_prenatal_avg_2019v, no2_y1_2019v,
         sex, 
         gestational_age, 
         maternal_race,
         maternal_education_length,
         genotyping.PC1, genotyping.PC2, genotyping.PC3,
         Comp.1, Comp.2, Comp.3, Comp.4)

test <- glm(any_wheeze_y1 ~ no2_prenatal_avg_2019v + sex + 
              gestational_age + prenatal_maternal_smoke + maternal_education_length +
              genotyping.PC1 + genotyping.PC2 + genotyping.PC3 + 
              Comp.1 + Comp.2 + Comp.3 + Comp.4, 
            data = wheeze_no2, family = "binomial")

t.test(wheeze_no2$any_wheeze_y1, wheeze_no2$no2_prenatal_avg_2019v)

ggplot(wheeze_no2, aes(x=as.factor(any_wheeze_y1), y = no2_prenatal_avg_2019v)) +
  geom_boxplot() +
  facet_grid(~sex)

plot_summs(test, exp = 1)


atopy_no2 <- covariates_geno_ctpc_tech_cc %>%
  subset(!is.na(clinician_atopy_dx_y1)) %>%
  select(clinician_atopy_dx_y1, prenatal_maternal_smoke,
         no2_prenatal_avg_2019v, no2_y1_2019v,
         sex, 
         gestational_age, maternal_race,
         maternal_education_length, 
         genotyping.PC1, genotyping.PC2, genotyping.PC3,
         Comp.1, Comp.2, Comp.3, Comp.4)

test <- glm(clinician_atopy_dx_y1 ~ no2_prenatal_avg_2019v + sex + 
              gestational_age + prenatal_maternal_smoke + maternal_education_length +
              genotyping.PC1 + genotyping.PC2 + genotyping.PC3,
            data = atopy_no2, family = "binomial")


plot_summs(test, exp = 1)

t.test(as.numeric(as.character(atopy_no2$clinician_atopy_dx_y1)), 
       atopy_no2$no2_prenatal_avg_2019v)

ggplot(atopy_no2, aes(x=as.factor(clinician_atopy_dx_y1), y = no2_prenatal_avg_2019v)) +
  geom_boxplot() +
  facet_grid(~sex)

test <- merge(x=covariates_geno_ctpc_tech_cc, y=child_fscbc_ecc2_cb$prop, by.x = "cb_sample_name", by.y = "row.names", all.x=T)
testlong <- test %>% 
  select(sample_id, CD4T, NK, CD8T, Mono, Bcell, nRBC, any_wheeze_y1) %>%
  pivot_longer(cols=-c(sample_id, any_wheeze_y1))
```


