---
title: "CHILD cord blood linear regression using limma with covariate missing values filled in with means"
author: "SL"
date: "12/09/2020"
output: html_document
---

*Purpose*: The purpose of this script is to examine DNAm changes in cord blood associated with prenatal air pollution exposure (proxied by no2).


Set global chunk options. 
```{r setup, include=FALSE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Load required libraries.
```{r libraries}
library(tidyverse)
library(limma)
library(here)
library(pbapply) #for running lm for each cpg
library(piecewiseSEM) #for getting partial residuals
library(broom) #for tidy function for lm
```


Load betas
```{r betas}
load(file=here("output_data", "preprocessed_data",
               "2020-11_19_CHILD_preprocessed_betas_pdata_annotation.Rdata"))
```


Subset out cord blood betas
```{r nocombat_betas}
# check ranges to confirm DNAm data is in beta value format
dim(betas)
max(betas)
min(betas)

# subset pData into CBMCs (cord blood)
# these children have data at both time points
cb_pdata <- subset(pdata_nodups, Tissue == "C")
dim(cb_pdata)

# subset cordblood DNAM samples
cb_betas <- betas[ ,colnames(betas) %in% rownames(cb_pdata)]

# check size for correct sample num
dim(cb_betas) #144

# check that CBMC betas and pdata are in same order
identical(colnames(cb_betas), rownames(cb_pdata)) # true

# relabel CBMC beta columns with sample label (5 digit identifier)
colnames(cb_betas) <- cb_pdata$Sample_Label
```


Load covariate data. Missing values in covariates of interest have been filled in mean means. 
```{r covariates}
load(file=here("output_data", "covariates", "2020-11-12_CHILD_covariates_na_with_means.Rdata"))
```


Subset covariates for individuals with CBMC DNAm.
```{r sub_covariates}
#subset covariates based on samples with DNAm data
covariates_sub <- 
  covariates_nameans[as.character(covariates_nameans$sampleid) %in% colnames(cb_betas), ]

#check if subset of covariates and CBMC betas are in the same order 
identical(as.character(covariates_sub$sampleid), colnames(cb_betas)) #true
```


Load CBMC PCs.
```{r load_PC_correctedbetas}
load(here("output_data", "deconvolution", "2020-11-10_CBMC_PCs.Rdata"))

dim(cb_pcs) #144 6

#rename columns for clarity
colnames(cb_pcs) <- paste("cbmc.", colnames(cb_pcs), sep="")
```

Load list of probes used in deconvolution. This will be used later to remove these probes before linear regression
```{r deconvo_probe_list}
load("R:/Jones/People/Samantha Lee/Projects/CHILD/CHILD_air_pollution/output_data/deconvolution/2021-01-07_CBMC_PBMC_deconvolution.Rdata")

#remove age one specific probe info, and all deconvolution cell counts
rm(y1_allprobes, y1_deconvolutionprobes,
   child_fscbc_ecc2_y1, child_fscbc_ecc2_cb)
```


Load genotyping PCs and subset out REEGLE PCs (genotyping data contains PCs for a few thousand participants).
```{r genotyping_PCS}
genotyping <- read.csv("R:/Jones/People/Samantha Lee/Computational/CHILD/input_data/CHILD_subjects_Qced_first10PCS_Duan.csv")

#make rownames sample names then rmove this row
rownames(genotyping) <- genotyping$FID
genotyping <- subset(genotyping, select=-c(FID, IID))

genosub <- genotyping[rownames(genotyping) %in% cb_pdata$Sample_Label,]
#missing genotyping data for 14 REEGLE children?

#rename columns of genotyping data for clarity
colnames(genosub) <- paste("genotyping.", colnames(genosub), sep="")
```


Check that betas, pdata, covariates, cell type PCs are in same order.
```{r cb_batchcorr_order}
#check that pdata and betas are in correct order
identical(as.character(cb_pdata$Sample_Label), colnames(cb_betas)) #true

#check that pdata and covariates are in the same order
identical(as.character(cb_pdata$Sample_Label), as.character(covariates_sub$sampleid)) #true

#check that pdata and cell type pcs are in same order
identical(rownames(cb_pdata), rownames(cb_pcs)) #true
```


Add cell type PCs to previously subset covariate data.
```{r combine_cell_pcs_covariates}
covariates_ctpcs <- cbind(covariates_sub, cb_pcs)
```


Subset covariates, pdata, and betas for individuals that have genotyping data. Add genotyping pcs to covariates
```{r sub_on_geno}
#subset covariates
covariates_ctpcs_sub <- covariates_ctpcs[covariates_ctpcs$sampleid %in% rownames(genosub), ]
dim(covariates_ctpcs_sub) #131

#check that covariates and geno are in same order
identical(as.character(covariates_ctpcs_sub$sampleid), rownames(genosub)) #false

#put genosub rows in numerical order
genosub_order <- genosub[order(rownames(genosub)), ]

#check that covariates and geno are in same order
identical(as.character(covariates_ctpcs_sub$sampleid), rownames(genosub_order)) #true

#combine genosub with covariates
covariates_ctpcs_geno <- cbind(covariates_ctpcs_sub, genosub_order)

#subet betas for genotyping data
cb_betas_geno <- cb_betas[,colnames(cb_betas) %in% rownames(genosub_order)] 
dim(cb_betas_geno) #131

#check that this is in the same order as covariates
identical(as.character(covariates_ctpcs_geno$sampleid), colnames(cb_betas_geno)) #true

#subset pdata
cb_pdata_geno <- cb_pdata[as.character(cb_pdata$Sample_Label) %in% rownames(genosub_order), ]
dim(cb_pdata_geno) #131 16

#check that covariates and dpata are in same order
identical(as.character(cb_pdata_geno$Sample_Label), as.character(covariates_ctpcs_geno$sampleid)) #true

#create new column for row in pdata
cb_pdata_geno$row <- as.numeric(as.factor(substr(cb_pdata_geno$Sentrix_Position, 1, 3)))
#examine
head(cb_pdata_geno$row)

#rename pdata sentrix Id column to chip
colnames(cb_pdata_geno)[8] <- "chip"

#rename pdata sentrix Id column to chip
colnames(cb_pdata_geno)[11] <- "run"

#add technical columns of pdata to covariates data
covariates_ctpcs_geno_tech <- cbind(covariates_ctpcs_geno, cb_pdata_geno[,c("run", "row", "chip")])

#check class of technical factors
#should all be character as order doesnt matter
class(covariates_ctpcs_geno_tech$run)
class(covariates_ctpcs_geno_tech$row)
class(covariates_ctpcs_geno_tech$chip)

covariates_ctpcs_geno_tech$run <- factor(covariates_ctpcs_geno_tech$run, ordered=F)
covariates_ctpcs_geno_tech$chip <- factor(covariates_ctpcs_geno_tech$chip, ordered=F)
```


Linear regression with limma.
```{r limma}
#####################
#Data prep for limma#
#####################

# check how many complete cases available for analysis
sum(complete.cases(covariates_ctpcs_geno_tech %>% 
                     dplyr::select(no2_preg_entire, sex,gestational_days,
                                   pss_18wk, csed_18wk,
                                   prenatal_maternal_smoking,
                                   cbmc.PC1, cbmc.PC2, 
                                   cbmc.PC3, cbmc.PC4, cbmc.PC5,
                                   genotyping.PC1, genotyping.PC2,
                                   genotyping.PC3,
                                   run,row))) #101


# create model matrix
cb_design <- 
  model.matrix(~no2_preg_entire + sex + gestational_days +
                 pss_18wk + csed_18wk + prenatal_maternal_smoking +
                 cbmc.PC1 + cbmc.PC2 + cbmc.PC3 + 
                 cbmc.PC4 + cbmc.PC5 +
                 genotyping.PC1 + genotyping.PC2 + 
                 genotyping.PC3 + run + row,
               data=covariates_ctpcs_geno_tech)

# check size
dim(cb_design) # 101 18

# subset covariates for complete cases 
covariates_ctpcs_geno_tech_cc <- 
  covariates_ctpcs_geno_tech[
    complete.cases(covariates_ctpcs_geno_tech %>%
                     dplyr::select(no2_preg_entire, sex,gestational_days, 
                                   prenatal_maternal_smoking, 
                                   pss_18wk, csed_18wk,
                                   cbmc.PC1, cbmc.PC2, cbmc.PC3,
                                   cbmc.PC4, cbmc.PC5,
                                   genotyping.PC1,genotyping.PC2,
                                   genotyping.PC3, run, row)), ] 

# check size complete case covariates - should be 101
dim(covariates_ctpcs_geno_tech_cc) # 101 132

# subset beta values for complete cases
cb_betas_geno_cc <- cb_betas_geno[,colnames(cb_betas_geno) %in% 
                                    covariates_ctpcs_geno_tech_cc$sampleid]

# check size of complete case betas
dim(cb_betas_geno_cc) # 424644 101

# remove probes from beta that were used to predict cell type
cb_betas_geno_cc_sub <- cb_betas_geno_cc[!rownames(cb_betas_geno_cc) %in% 
                                           rownames(cb_deconvolutionprobes$coefEsts), ]
# check size
dim(cb_betas_geno_cc_sub) # 424079    101
# 565 probes removed


#######
#LIMMA#
#######

# fit methylation to no2
cb_fit <-  lmFit(cb_betas_geno_cc_sub, cb_design)
cb_ebayes <- eBayes(cb_fit)

# subset annotation file for cpgs used in limma
annotation_cpgs <- annotation[rownames(annotation) %in% rownames(cb_ebayes),]

# check that annotation file and limma cpgs are in the same order
identical(rownames(annotation_cpgs), rownames(cb_ebayes)) # false

# reorder annotation file to match limma output
annotation_cpgs_order <- annotation_cpgs[rownames(cb_ebayes), ]

# recheck order of annotation file against limma cpgs
identical(rownames(annotation_cpgs_order), rownames(cb_ebayes)) #true

#pull out pval, coefficients from limma and combine with annotation
cb_pvals_tech <- cbind(as.data.frame(cb_ebayes$p.value), 
                  as.data.frame(cb_ebayes$coefficients),
                  as.data.frame(annotation_cpgs_order))

#rename columns to indicate pvalues vs coeffcients 
colnames(cb_pvals_tech) <- c(paste("pval", colnames(cb_pvals_tech)[1:19], sep = "_"), 
                         paste("coeff", colnames(cb_pvals_tech)[20:38], sep = "_"),
                         colnames(cb_pvals_tech)[39:71])

cb_pvals_tech$pval_no2_preg_entire_adj <- p.adjust(cb_pvals_tech$pval_no2_preg_entire, method="BH")
```


Examine qqplot and pvalue histogram.
```{r qqplot_pval_histo}
library(car)

########
#qqplot#
########

#estimate parameters for normal distribution
params <- as.list(MASS::fitdistr(-log10(cb_pvals_tech$pval_no2_preg_entire), "normal")$estimate)

#normal qqplot
ggplot(aes(sample = -log10(pval_no2_preg_entire)), data = cb_pvals_tech) + 
  stat_qq(col = "#75A2D9", distribution = qnorm, dparams = params) +
  stat_qq_line(distribution = qnorm, dparams = params) +
  theme_bw() +
  labs(x="Expected -log10(p)", y="Observed -log10(p)") + 
  theme(panel.border = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        axis.text=element_text(size=16),
        axis.title=element_text(size=20))


#estimate gamma params
params <- as.list(MASS::fitdistr(-log10(cb_pvals_tech$pval_no2_preg_entire), "gamma")$estimate)

#gamma qqplot
ggplot(aes(sample = -log10(pval_no2_preg_entire)), data = cb_pvals_tech) + 
  stat_qq(col = "#75A2D9", distribution = qgamma, dparams = params) +
  stat_qq_line(distribution = qgamma, dparams = params) +
  theme_bw() +
  labs(x="Expected -log10(p)", y="Observed -log10(p)") + 
  theme(panel.border = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        axis.text=element_text(size=16),
        axis.title=element_text(size=20))


###########
#histogram#
###########

ggplot( data = cb_pvals_tech, aes(x=pval_no2_preg_entire)) +
  geom_histogram(bins=100, fill = "#75A2D9") +
  labs(y="Count", x="Unadjusted p-value") +
  theme_bw() +
  theme(panel.border = element_blank(),
        axis.text=element_text(size=18),
        axis.title=element_text(size=20)) 
```


Delta beta
```{r db}
range = max(covariates_ctpcs_geno_tech_cc$no2_preg_entire) -
    min(covariates_ctpcs_geno_tech_cc$no2_preg_entire)

cb_pvals_tech$db <- cb_pvals_tech$coeff_no2_preg_entire * range
```


Volcano plot
```{r volcano_db_tech}
# 10% effect size cutoff
ggplot(cb_pvals_tech, aes(x=as.numeric(db)*100 , y=-log10(as.numeric(pval_no2_preg_entire)))) +
  geom_point(alpha=0.4, col = "#75A2D9", size=2) +
  geom_point(data=subset(cb_pvals_tech, 
                         (pval_no2_preg_entire < 0.00001 & db > 0.1) | 
                          (pval_no2_preg_entire < 0.00001 & db < -0.1)), 
    alpha=0.4, col = "red", size=2) + 
  geom_vline(xintercept = c(10, -10), linetype = "dashed") +
  geom_hline(yintercept = -log10(0.00001), linetype="dashed") + 
  theme_bw() +
    theme(panel.border = element_blank(),
        axis.text=element_text(size=18),
        axis.title=element_text(size=20)) +
  labs(y="-log10(unadjusted p-value)", x = "Effect size")

# 5% effect size cutoff
ggplot(cb_pvals_tech, aes(x=as.numeric(db)*100 , y=-log10(as.numeric(pval_no2_preg_entire)))) +
  geom_point(alpha=0.4, col = "#75A2D9", size=2) +
  geom_point(data=subset(cb_pvals_tech, 
                         (pval_no2_preg_entire < 0.00001 & db > 0.05) | 
                          (pval_no2_preg_entire < 0.00001 & db < -0.05)), 
    alpha=0.4, col = "red", size=2) + 
  geom_vline(xintercept = c(5, -5), linetype = "dashed") +
  geom_hline(yintercept = -log10(0.00001), linetype="dashed") + 
  theme_bw() +
    theme(panel.border = element_blank(),
        axis.text=element_text(size=18),
        axis.title=element_text(size=20)) +
  labs(y="-log10(unadjusted p-value)", x = "Effect size")


# 2.5% effect size cutoff
ggplot(cb_pvals_tech, aes(x=as.numeric(db)*100 , y=-log10(as.numeric(pval_no2_preg_entire)))) +
  geom_point(alpha=0.4, col = "#75A2D9", size=2) +
  geom_point(data=subset(cb_pvals_tech, 
                         (pval_no2_preg_entire < 0.00001 & db > 0.025) | 
                          (pval_no2_preg_entire < 0.00001 & db < -0.025)), 
    alpha=0.4, col = "red", size=2) + 
  geom_vline(xintercept = c(2.5, -2.5), linetype = "dashed") +
  geom_hline(yintercept = -log10(0.00001), linetype="dashed") + 
  theme_bw() +
    theme(panel.border = element_blank(),
        axis.text=element_text(size=18),
        axis.title=element_text(size=20)) +
  labs(y="-log10(unadjusted p-value)", x = "Effect size")

```





Try re-running limma with birth month/ interaction between birth month and air pollution.
```{r interaction_terms_to_assess_birthmonth}
#want to use anova to compare models usign anova
#anova only accepts models from lm
#use lm to compare how birth month affects cpgs above 10^-3 sig 

#You should be able to ask for confidence intervals for the slope coefficients for each month.  #even in a tabular display, you may see that “smoothly varying” pattern we were discussing.
#Then, you could use those to plot a sort of “here’s how the slope varies by month” picture.Sort #of like forest plots for meta analysis results, if that makes sense.

#Also, before we decide it doesn’t matter, the individual slopes might look fairly similar, but the appropriate overall test would be to check the anova(fit_with_interaction) and check the p-value on the interaction term.

test_cpgs <- subset(cb_pvals_tech, 
                    (pval_no2_preg_entire < 0.001 & db > 0.1) | 
                      (pval_no2_preg_entire < 0.001 & db < -0.1))

################################################
#most significant hypermethylated cpg cg23755933

covariates_ctpcs_geno_tech_cc$cpgmeth <- 
  cb_betas_geno_cc[rownames(cb_betas_geno_cc)=="cg07376282", ] 

cg07376282_fit_bm <- lm(cpgmeth ~ -1 + no2_preg_entire + 
              sex + gestational_days +
              prenatal_maternal_smoking + 
              pss_18wk + 
              csed_18wk + 
              cbmc.PC1 + cbmc.PC2 + cbmc.PC3 + 
              cbmc.PC4 + cbmc.PC5 +
              genotyping.PC1 +
              genotyping.PC2 +
              genotyping.PC3 +
              run + row + birth_month + no2_preg_entire*birth_month, data=covariates_ctpcs_geno_tech_cc)


tidy(cg07376282_fit_bm, conf.int = 0.95) %>% filter(term %>% str_detect(":")) %>% 
  mutate(term = factor(term, levels=c("no2_preg_entire:birth_monthfebruary",
                                      "no2_preg_entire:birth_monthmarch",
                                      "no2_preg_entire:birth_monthapril",
                                      "no2_preg_entire:birth_monthmay",
                                      "no2_preg_entire:birth_monthjune",
                                      "no2_preg_entire:birth_monthjuly",
                                      "no2_preg_entire:birth_monthaugust",
                                      "no2_preg_entire:birth_monthseptember",
                                      "no2_preg_entire:birth_monthoctober",
                                      "no2_preg_entire:birth_monthnovember",
                                      "no2_preg_entire:birth_monthdecember"))) %>%
  ggplot(aes(y = estimate, x = as.factor(term))) + 
  geom_point() +
  geom_errorbar(aes(ymin = conf.low , ymax = conf.high)) +
  theme_bw() +
  ggtitle("cg07376282") +
  scale_x_discrete(labels=c("NO2:February","NO2:March", "NO2:April", "NO2:May",
                            "NO2:June","NO2:July", "NO2:August", "NO2:September",
                            "NO2:October", "NO2:November","NO2:December")) +
  labs(x="Interaction term", y="Estimate") +
  theme(panel.border=element_blank(),
        axis.text.x = element_text(angle=90),
        axis.text = element_text(size=12),
        axis.title = element_text(size=14),
        title = element_text(size=16)) 

anova(cg07376282_fit_bm)
  


################################################
#most significant hypomethylated cpg cg12228123

covariates_ctpcs_geno_tech_cc$cpgmeth <- 
  cb_betas_geno_cc[rownames(cb_betas_geno_cc)=="cg04936619", ] 

  
cg04936619_fit_bm <- lm(cpgmeth ~ -1 + no2_preg_entire + 
              sex + gestational_days +
              maternal_education_length +
              prenatal_maternal_smoking + 
              pss_18wk + 
              csed_18wk + 
              cbmc.PC1 + cbmc.PC2 + cbmc.PC3 + 
              cbmc.PC4 + cbmc.PC5 +
              genotyping.PC1 +
              genotyping.PC2 +
              genotyping.PC3 +
              run + row + birth_month + no2_preg_entire*birth_month, data=covariates_ctpcs_geno_tech_cc)



#most significant hypomethylated cpg cg12228123
tidy(cg04936619_fit_bm, conf.int = 0.95) %>% filter(term %>% str_detect(":")) %>% 
  mutate(term = factor(term, levels=c("no2_preg_entire:birth_monthfebruary",
                                      "no2_preg_entire:birth_monthmarch",
                                      "no2_preg_entire:birth_monthapril",
                                      "no2_preg_entire:birth_monthmay",
                                      "no2_preg_entire:birth_monthjune",
                                      "no2_preg_entire:birth_monthjuly",
                                      "no2_preg_entire:birth_monthaugust",
                                      "no2_preg_entire:birth_monthseptember",
                                      "no2_preg_entire:birth_monthoctober",
                                      "no2_preg_entire:birth_monthnovember",
                                      "no2_preg_entire:birth_monthdecember"))) %>% 
  ggplot(aes(y = estimate, x = as.factor(term))) + 
  geom_point() +
  geom_errorbar(aes(ymin = conf.low , ymax = conf.high)) +
  scale_x_discrete(labels=c("NO2:February","NO2:March", "NO2:April", "NO2:May",
                            "NO2:June","NO2:July", "NO2:August", "NO2:September",
                            "NO2:October", "NO2:November","NO2:December")) +
  theme_bw() +
  theme(panel.border=element_blank(),
        axis.text.x = element_text(angle=90),
        axis.text = element_text(size=12),
        axis.title = element_text(size=14),
        title = element_text(size=16)) +
  ggtitle("cg04936619") +
    labs(x="Interaction term", y="Estimate") 

anova(cg04936619_fit_bm)
```




### Examine genome wide methylation changes vs no2 exposure


Examine mean methylation vs no2
```{r mean_meth}
#convert betas to df
cb_betas_geno_cc_df <- as.data.frame(cb_betas_geno_cc)

methmeans <- colMeans(cb_betas_geno_cc_df)

covariates_ctpcs_geno_tech_cc <- cbind(covariates_ctpcs_geno_tech_cc, methmeans)

#colmeans
meanmeth_lm <- lm(methmeans ~ no2_preg_entire +
              sex + gestational_days +
              prenatal_maternal_smoking + 
              pss_18wk + 
              csed_18wk + 
              cbmc.PC1 + cbmc.PC2 + cbmc.PC3 + 
              cbmc.PC4 + cbmc.PC5 +
              genotyping.PC1 +
              genotyping.PC2 +
              genotyping.PC3 +
              run + row, 
              data=covariates_ctpcs_geno_tech_cc)

#get summary
summary(meanmeth_lm) #no2 not sig

#get partial residuals for no2 and dnam 
methmean_res <- partialResid( methmeans ~ no2_preg_entire, meanmeth_lm, 
              data=covariates_ctpcs_geno_tech_cc)

#fit again to get r2
methmean_res_fit <- lm(methmean_res$yresid ~ methmean_res$xresid)

summary(methmean_res)

ggplot(methmean_res, aes(x=xresid, y=yresid)) + 
  geom_point(alpha=0.8, col = "#75A2D9", size=2) + 
  stat_smooth(method="lm", se=F, col="black") +
  theme_bw() +
  labs(x="Prenatal NO2 (ppb)", y="Genome wide DNA methyaltion (%)") +
  ggtitle("Partial residual plot") +
  theme(panel.border=element_blank(),
        axis.text = element_text(size=12),
        axis.title = element_text(size=14),
        title = element_text(size=14)) 
```


### Examine LINE methylation vs NO2

Examine methylation of LINE1 elements
Based off of analysis by Andrea baccareli
https://link-springer-com.uml.idm.oclc.org/article/10.1186/s12989-014-0071-3
```{r line_annotation}

#load repeat element UCSC track
rmsk <- read.delim(file=here("raw_data", "repeat_element_anno", "rmsk.txt"), 
                   sep="\t",
                   header = F)

#populate colnames
colnames(rmsk) <- c("bin", "swscore", "milli_div", "milli_del",
                    "milli_ins", "genoname", "genostart", "genoend",
                    "genoleft", "strand", "repname", "repclass", "repfamily",
                    "repstart", "repend", "repleft", "id")

#get just LINE elements
rmsk_lines <- rmsk %>% filter(repclass=="LINE")

#add column to annotation indicating whether probe has at least 15 basepairs in LINE element

anno_lines <- pbapply(annotation, 1, function(x){
  
  probe_line <- rmsk_lines %>% 
  filter(genoname==x["chr"]) %>% 
  filter(genostart >= x["pos"] & genoend <= x["pos"])

  if(nrow(probe_line)!=0){
    return(TRUE)
  } else {return(FALSE)}
  
  
})

annotation$LINEs <- anno_lines

write.csv(annotation, file=here("output_data", "2020-11-29_annotation_LINEs.csv"))
```


```{r get_lineannotation}
#read in line annotation
annotationlines <- read.csv(here("output_data", "linear_regression", "2020-11-29_annotation_LINEs.csv"))

#subset 
annotationlines <- annotationlines[annotationlines$LINEs==T, ]

#subset betas
cb_betas_geno_cc_lines <- 
  cb_betas_geno_cc[rownames(cb_betas_geno_cc) %in%
                     annotationlines$X, ]

dim(cb_betas_geno_cc_lines)


#convert betas to df
cb_betas_geno_cc_lines_df <- as.data.frame(cb_betas_geno_cc_lines)

linemeth <- colMeans(cb_betas_geno_cc_lines)

covariates_ctpcs_geno_tech_cc <- cbind(covariates_ctpcs_geno_tech_cc, linemeth)

#colmeans
linemeth_lm <- lm(linemeth ~ no2_preg_entire + 
              sex + gestational_days +
              prenatal_maternal_smoking + 
              pss_18wk + 
              csed_18wk + 
              cbmc.PC1 + cbmc.PC2 + cbmc.PC3 + 
              cbmc.PC4 + cbmc.PC5 +
              genotyping.PC1 +
              genotyping.PC2 +
              genotyping.PC3 +
              run + row, 
              data=covariates_ctpcs_geno_tech_cc)

summary(linemeth_lm) #no2 not sig




#get partial residuals for no2 and dnam 
linemeth_res <- partialResid( linemeth ~ no2_preg_entire, linemeth_lm, 
              data=covariates_ctpcs_geno_tech_cc)

#fit again to get r2
linemeth_res_fit <- lm(linemeth_res$yresid ~ linemeth_res$xresid)

summary(linemeth_res_fit)

ggplot(linemeth_res, aes(x=xresid, y=yresid)) + 
  geom_point(alpha=0.8, col = "#75A2D9", size=2) + 
  stat_smooth(method="lm", se=F, col="black") +
  theme_bw() +
  labs(x="Prenatal NO2 (ppb)", y="LINE DNA methyaltion (%)") +
  ggtitle("Partial residual plot") +
  theme(panel.border=element_blank(),
        axis.text = element_text(size=12),
        axis.title = element_text(size=14),
        title = element_text(size=14)) 

```


### Examine methylation changes from PMID 27448387
Dont run this since these changes are included in the list below
```{r validation, eval=FALSE}

covariates_ctpcs_geno_tech_cc$cg12283362 <- 
  cb_betas_geno_cc[rownames(cb_betas_geno_cc)=="cg12283362", ] 

lm_cg12283362 <- lm(cg12283362 ~ no2_preg_entire + 
              sex + gestational_days +
              maternal_education_length +
              prenatal_maternal_smoking + 
              pss_18wk + 
              csed_18wk + 
              cbmc.PC1 + cbmc.PC2 + cbmc.PC3 + 
              cbmc.PC4 + cbmc.PC5 +
              genotyping.PC1 +
              genotyping.PC2 +
              genotyping.PC3 +
              run + row, data=covariates_ctpcs_geno_tech_cc)

summary(lm_cg12283362)

ggplot(covariates_ctpcs_geno_tech_cc, aes(x=no2_preg_entire, y=cg12283362*100)) +
  geom_point(alpha=0.8, col = "#75A2D9", size=2) +
  stat_smooth(method="lm", se=F, col="black") +
  #geom_abline(slope= 0.0005028644, intercept=0.5418461)+
  labs(y="Methylation %", x="Prenatal NO2 exposure (ppb)") +
  ggtitle("cg12283362") +
  theme_bw() +
  theme(panel.border=element_blank(),
        axis.text = element_text(size=14),
        axis.title = element_text(size=16),
        title = element_text(size=16)) 


##################
### cg24172570 ###
##################

covariates_ctpcs_geno_tech_cc$cg24172570 <- 
  cb_betas_geno_cc[rownames(cb_betas_geno_cc)=="cg24172570", ] 

lm_cg24172570 <- lm(cg24172570 ~ no2_preg_entire + 
              sex + gestational_days +
              maternal_education_length +
              prenatal_maternal_smoking + 
              pss_18wk + 
              csed_18wk + 
              cbmc.PC1 + cbmc.PC2 + cbmc.PC3 + 
              cbmc.PC4 + cbmc.PC5 +
              genotyping.PC1 +
              genotyping.PC2 +
              genotyping.PC3 +
              run + row, data=covariates_ctpcs_geno_tech_cc)

summary(lm_cg24172570)

ggplot(covariates_ctpcs_geno_tech_cc, aes(x=no2_preg_entire, y=cg24172570*100)) +
  geom_point(alpha=0.8, col = "#75A2D9", size=2) +
  stat_smooth(method="lm", se=F, col="black") +
  labs(y="Methylation %", x="Prenatal NO2 exposure (ppb)") +
  ggtitle("cg24172570") +
  theme_bw() +
  theme(panel.border=element_blank(),
        axis.text = element_text(size=14),
        axis.title = element_text(size=16),
        title = element_text(size=16)) 

##################
### cg08973675 ###
##################

covariates_ctpcs_geno_tech_cc$cg08973675 <- 
  cb_betas_geno_cc[rownames(cb_betas_geno_cc)=="cg08973675", ] 

lm_cg08973675 <- lm(cg08973675 ~ no2_preg_entire + 
              sex + gestational_days +
              maternal_education_length +
              prenatal_maternal_smoking + 
              pss_18wk + 
              csed_18wk + 
              cbmc.PC1 + cbmc.PC2 + cbmc.PC3 + 
              cbmc.PC4 + cbmc.PC5 +
              genotyping.PC1 +
              genotyping.PC2 +
              genotyping.PC3 +
              run + row, data=covariates_ctpcs_geno_tech_cc)

summary(lm_cg08973675)


ggplot(covariates_ctpcs_geno_tech_cc, aes(x=no2_preg_entire, y=cg08973675*100)) +
  geom_point(alpha=0.8, col = "#75A2D9", size=2) +
  stat_smooth(method="lm", se=F, col="black") +
  labs(y="Methylation %", x="Prenatal NO2 exposure (ppb)") +
  ggtitle("cg08973675") +
  theme_bw() +
  theme(panel.border=element_blank(),
        axis.text = element_text(size=14),
        axis.title = element_text(size=16),
        title = element_text(size=16)) 

```



### Gene specific changes

These genes are related to the proposed pathway of air pollution action or have previously been shown to exhibit DNA methylation changes associated with prenatal air pollution exposure. 

```{r gene_specific}
#FHC is FTH1 (ferritin heavy chain 1)
#nothing maps to FOXP3
#TNFA is TNF
goi <- annotation[grep("RNF39|CYP2E1|LONP1|HIBADH|SLC25A28|PLVAP|GPR55|^CAT$|TPO|NFKB1|^NOX2|SOD1|TRX1|TRX2|GSTP1|^MT3|NQO1|HMOX1|GPX1|DDH1|^NOS2|CYP2C11|CYP7B|ALOX12$|ALOX5|^NRF2$|KEAP1|AHR$|^ARNT;|GCLC|GCLM|GSR1|SLC7A11|GPC2|GSTA1|GSTA2|GSTA3|GSTA5|GSTM1|GSTM2|GSTM3|TXN$|TXNRD1$|SRXN1|G6PD|CYP1A1|IL1A|^IL2$|^IL3$|^IL4.*IL4$|^IL5$|^IL6$|IL9$|IL10$|IL12A|IL13|IL15$|IL17A|IL18$|IL19|IL21$|IL22$|IL23A$|IL25$|IL27$|IL31$|IL33$|IFNG$|^TNF$|TGFB1$|FOXP3|FTH1", annotation$UCSC_RefGene_Name), ]

#transpose betas
cb_betas_geno_cc_t <- t(cb_betas_geno_cc)

#apply function for calculating significance of associations using mice and imputed covariate data
prenatal_goi_list <- 
  pbapply(cb_betas_geno_cc_t [,colnames(cb_betas_geno_cc_t ) %in% rownames(goi)], 2, function(x) {
  
  combined <- cbind(covariates_ctpcs_geno_tech_cc, x)
  
  #run the linear regression on this cpg using all 5 imputed covariate data sets
  fit <- lm(x ~no2_preg_entire + 
              sex + 
              maternal_education_length +
              prenatal_maternal_smoking + 
              pss_18wk + 
              csed_18wk + 
              cbmc.PC1 + cbmc.PC2 + cbmc.PC3 + 
              cbmc.PC4 + cbmc.PC5 +
              genotyping.PC1 +
              genotyping.PC2 +
              genotyping.PC3 +
              run + row, data=combined)
  
  #get summary of lm fit
  #this includes coefficients and pvalues
  #coerce into df for manipulation
  #add in terms (rownames) as column for annotation
  fit_sum <- summary(fit)
  fit_sum_coeff <- as.data.frame(fit_sum$coefficients)
  fit_sum_coeff$term <- rownames(fit_sum_coeff)
  
  #this data frame has rows for each linear regression variable, and columns for statistics
  #want a dataframe of 1 row and many columns (one for each variable with each statistic type)
  #do this by using the spread function for each statistic
  #add cpg id onto dataframe for pvalues (to keep track of information)
  #then cbind dataframes together
  
  #coefficient
  estimate <- spread(fit_sum_coeff[,c("term", "Estimate")], term, Estimate)
  colnames(estimate) <- paste("estimate", colnames(estimate), sep=".")
  
  #std error
  std.error <- spread(fit_sum_coeff[,c("term", "Std. Error")], term, 'Std. Error')
  colnames(std.error) <- paste("std.error", colnames(std.error), sep=".")
  
  #t statistics
  statistic <- spread(fit_sum_coeff[,c("term", "t value")], term, 't value')
  colnames(statistic) <- paste("t.val", colnames(statistic), sep=".")

  #pvalue
  p.value <- spread(fit_sum_coeff[,c("term", "Pr(>|t|)")], term, 'Pr(>|t|)')
  colnames(p.value) <- paste("p.value", colnames(p.value), sep=".")
  
  #add in cpgid for annotation 
  p.value$cpg <- colnames(x)
  
  #cbind into wide dataframe
  widepool <- cbind(estimate, std.error, statistic, p.value)
  
  #return the wide dataframe
  #these will be do.call(rbind()) together after
  return(widepool)
  
})


prenatal_goi <- do.call(rbind, prenatal_goi_list)

prenatal_goi$p.value.no2_preg_entire_adjusted <- p.adjust(prenatal_goi$p.value.no2_preg_entire, method="bonferroni")

#reorder according ot unadjusted no2 pvalue
prenatal_goi_order <- prenatal_goi[order(prenatal_goi$p.value.no2_preg_entire),]

#reorder goi annotation to be in same order as goi stats
goi_order <- goi[rownames(prenatal_goi_order),]

#check identical
identical(rownames(goi_order), rownames(prenatal_goi_order)) #true

#bind
goi_df <- cbind(prenatal_goi_order, goi_order)

#write as .csv
write.csv(goi_df, file=here("output_data", "2020-12-03_prenatal_goi.csv"))




covariates_ctpcs_geno_tech_cc$cg26227465_cb <- 
        cb_betas_geno_cc[rownames(cb_betas_geno_cc)=="cg26227465", ]

#colmeans
cg26227465_lm <- lm(cg26227465 ~ no2_preg_entire + 
              sex + gestational_days +
              prenatal_maternal_smoking + 
              pss_18wk + 
              csed_18wk + 
              cbmc.PC1 + cbmc.PC2 + cbmc.PC3 + 
              cbmc.PC4 + cbmc.PC5 +
              genotyping.PC1 +
              genotyping.PC2 +
              genotyping.PC3 +
              run + row, 
              data=covariates_ctpcs_geno_tech_cc)


#get partial residuals for no2 and dnam 
cg26227465_res <- partialResid(cg26227465 ~ no2_preg_entire, cg26227465_lm, 
              data=covariates_ctpcs_geno_tech_cc)

#fit again to get r2
cg26227465_res_fit <- lm(cg26227465_res$yresid ~ cg26227465_res$xresid)

summary(cg26227465_res_fit)

ggplot(cg26227465_res, aes(x=xresid, y=yresid)) + 
  geom_point(alpha=0.8, col = "#75A2D9", size=2) + 
  stat_smooth(method="lm", se=F, col="black") +
  theme_bw() +
  labs(x="Prenatal NO2 (ppb)", 
       y=str_wrap("Interferon gamma (INFG) cg26227465 DNA methyaltion (%)",width=35)) +
  ggtitle("Partial residual plot") +
  theme(panel.border=element_blank(),
        axis.text = element_text(size=12),
        axis.title = element_text(size=14),
        title = element_text(size=14)) 





### cpg from gruzieva
covariates_ctpcs_geno_tech_cc$cg12283362 <- 
  cb_betas_geno_cc[rownames(cb_betas_geno_cc)=="cg12283362", ] 


cg12283362_lm <- lm(cg12283362  ~ no2_preg_entire + 
              sex + gestational_days +
              prenatal_maternal_smoking + 
              pss_18wk + 
              csed_18wk + 
              cbmc.PC1 + cbmc.PC2 + cbmc.PC3 + 
              cbmc.PC4 + cbmc.PC5 +
              genotyping.PC1 +
              genotyping.PC2 +
              genotyping.PC3 +
              run + row, 
              data=covariates_ctpcs_geno_tech_cc)


#get partial residuals for no2 and dnam 
cg12283362_res <- partialResid(cg12283362 ~ no2_preg_entire, cg12283362_lm, 
              data=covariates_ctpcs_geno_tech_cc)

#fit again to get r2
cg12283362_res_fit <- lm(cg12283362_res$yresid ~ cg12283362_res$xresid)

summary(cg12283362_res_fit)

ggplot(cg12283362_res, aes(x=xresid, y=yresid)) + 
  geom_point(alpha=0.8, col = "#75A2D9", size=2) + 
  stat_smooth(method="lm", se=F, col="black") +
  theme_bw() +
  labs(x="Prenatal NO2 (ppb)", 
       y=str_wrap("Lon protease homolog (LONP1) cg12283362 DNA methyaltion (%)",width=35)) +
  ggtitle("Partial residual plot") +
  theme(panel.border=element_blank(),
        axis.text = element_text(size=12),
        axis.title = element_text(size=14),
        title = element_text(size=14)) 





#3rd cpg from gruzieve
covariates_ctpcs_geno_tech_cc$cg08973675 <- 
  cb_betas_geno_cc[rownames(cb_betas_geno_cc)=="cg08973675", ] 



cg08973675_lm <- lm(cg08973675  ~ no2_preg_entire + 
              sex + gestational_days +
              prenatal_maternal_smoking + 
              pss_18wk + 
              csed_18wk + 
              cbmc.PC1 + cbmc.PC2 + cbmc.PC3 + 
              cbmc.PC4 + cbmc.PC5 +
              genotyping.PC1 +
              genotyping.PC2 +
              genotyping.PC3 +
              run + row, 
              data=covariates_ctpcs_geno_tech_cc)


#get partial residuals for no2 and dnam 
cg08973675_res <- partialResid(cg08973675 ~ no2_preg_entire, cg08973675_lm, 
              data=covariates_ctpcs_geno_tech_cc)

#fit again to get r2
cg08973675_res_fit <- lm(cg08973675_res$yresid ~ cg08973675_res$xresid)

summary(cg08973675_res_fit)

ggplot(cg08973675_res, aes(x=xresid, y=yresid)) + 
  geom_point(alpha=0.8, col = "#75A2D9", size=2) + 
  stat_smooth(method="lm", se=F, col="black") +
  theme_bw() +
  labs(x="Prenatal NO2 (ppb)", 
       y=str_wrap("Solute Carrier Family 25 Member 28 (SLC25A28) cg08973675 DNA methyaltion (%)",width=35)) +
  ggtitle("Partial residual plot") +
  theme(panel.border=element_blank(),
        axis.text = element_text(size=12),
        axis.title = element_text(size=14),
        title = element_text(size=14)) 


```




Looking at interferon gamma at age one.
```{r ifng_ageone}
#load cell counts
load(here("output_data", "deconvolution", "2020-12-10_PBMC_PCs.RData"))

#these children have data at both time points
y1_pdata <- subset(pdata_nodups, Tissue == "P")
dim(y1_pdata)

#subset cordblood DNAM samples
y1_betas <- betas[ ,colnames(betas) %in% rownames(y1_pdata)]

#rename colums with sample label (5 dig num)
identical(colnames(y1_betas), rownames(y1_pdata))#true
colnames(y1_betas) <- y1_pdata$Sample_Label

#subset y1 betas for samples in the complete case cord blood betas
y1_betas_cc <- y1_betas[,colnames(y1_betas) %in% colnames(cb_betas_geno_cc)]
dim(y1_betas_cc) #424644    101

#convert cell types to dataframe
#rename cols
colnames(y1_pcs) <- paste("pbmc", colnames(y1_pcs), sep=".")

#rename rwos of cell types
identical(rownames(y1_pcs), rownames(y1_pdata)) #true
rownames(y1_pcs) <- y1_pdata$Sample_Label

#subset for complete cases
y1_pcs_sub <- y1_pcs[rownames(y1_pcs) %in% covariates_ctpcs_geno_tech_cc$sampleid,]
dim(y1_pcs_sub) #101

#add to covariate df
covariates_ctpcs_geno_tech_cc <- cbind(covariates_ctpcs_geno_tech_cc, y1_pcs_sub)

covariates_ctpcs_geno_tech_cc$y1_cg26227465 <- 
        y1_betas_cc[rownames(y1_betas_cc)=="cg26227465", ]



sum(complete.cases(covariates_ctpcs_geno_tech_cc %>% dplyr::select(no2_preg_entire, 
                                                                sex,  
                                                                  maternal_smoking_y1,
                                                                  pss_6mos,
                                                                  csed_6mos, 
                                                                  pbmc.PC1, pbmc.PC2,
                                                                  pbmc.PC3, pbmc.PC4, 
                                                                  genotyping.PC1,
                                                                  genotyping.PC2,
                                                                  genotyping.PC3,
                                                                  run, row))) #97


#subset covariates
covariates_ctpcs_geno_tech_cc_y1 <- 
  covariates_ctpcs_geno_tech_cc[complete.cases(covariates_ctpcs_geno_tech_cc %>% 
                                              dplyr::select(no2_preg_entire, 
                                                                sex,  
                                                                  maternal_smoking_y1,
                                                                  pss_6mos,
                                                                  csed_6mos, 
                                                                  pbmc.PC1, pbmc.PC2,
                                                                  pbmc.PC3, pbmc.PC4, 
                                                                  genotyping.PC1,
                                                                  genotyping.PC2,
                                                                  genotyping.PC3,
                                                                  run, row)), ] 
#check size


#colmeans
yearone_cg26227465_lm <- lm(y1_cg26227465 ~ no2_preg_entire + 
              sex + 
              maternal_smoking_y1 + 
              pss_6mos + 
              csed_6mos + 
              pbmc.PC1 + pbmc.PC2 +
              pbmc.PC3 + pbmc.PC4 + 
              genotyping.PC1 +
              genotyping.PC2 +
              genotyping.PC3 +
              run + row, 
              data=covariates_ctpcs_geno_tech_cc_y1)


#get partial residuals for no2 and dnam 
yearone_cg26227465_res <- partialResid(y1_cg26227465 ~ no2_preg_entire, yearone_cg26227465_lm, 
              data=covariates_ctpcs_geno_tech_cc)

#fit again to get r2
yearone_cg26227465_res_fit <- lm(yearone_cg26227465_res$yresid ~ yearone_cg26227465_res$xresid)

summary(yearone_cg26227465_res_fit)

ggplot(yearone_cg26227465_res, aes(x=xresid, y=yresid)) + 
  geom_point(alpha=0.8, col = "#75A2D9", size=2) + 
  stat_smooth(method="lm", se=F, col="black") +
  theme_bw() +
  labs(x="Prenatal NO2 (ppb)", 
       y=str_wrap("Interferon gamma (IFNG) cg26227465 DNA methyaltion at age one(%)",width=35)) +
  ggtitle("Partial residual plot") +
  theme(panel.border=element_blank(),
        axis.text = element_text(size=12),
        axis.title = element_text(size=14),
        title = element_text(size=14)) 





#colmeans
yearone_cg26227465_y1_lm <- lm(yearone_cg26227465 ~ no2_y1_entire + 
              sex + 
              maternal_smoking_y1 + 
              pss_6mos + 
              csed_6mos + 
              pbmc.PC1 + pbmc.PC2 +
              pbmc.PC3 + pbmc.PC4 + 
              genotyping.PC1 +
              genotyping.PC2 +
              genotyping.PC3 +
              run + row, 
              data=covariates_ctpcs_geno_tech_cc_y1)


#get partial residuals for no2 and dnam 
yearone_cg26227465_y1_res <- partialResid(yearone_cg26227465 ~ no2_y1_entire, yearone_cg26227465_y1_lm, 
              data=covariates_ctpcs_geno_tech_cc)

#fit again to get r2
yearone_cg26227465_y1_res_fit <- lm(yearone_cg26227465_y1_res$yresid ~ yearone_cg26227465_y1_res$xresid)

summary(yearone_cg26227465_y1_res_fit)

ggplot(yearone_cg26227465_y1_res, aes(x=xresid, y=yresid)) + 
  geom_point(alpha=0.8, col = "#75A2D9", size=2) + 
  stat_smooth(method="lm", se=F, col="black") +
  theme_bw() +
  labs(x="Prenatal NO2 (ppb)", 
       y=str_wrap("Interferon gamma (IFNG) cg26227465 DNA methyaltion at age one(%)",width=35)) +
  ggtitle("Partial residual plot") +
  theme(panel.border=element_blank(),
        axis.text = element_text(size=12),
        axis.title = element_text(size=14),
        title = element_text(size=14)) 



#boxplot
ggplot(covariates_ctpcs_geno_tech_cc_y1[cg])

```

























### PC analysis of covariates 

Heat scree plot
```{r heatscree}
#initialize the heatplot function 
#outputs heatmap of PCs
#initialize the heatplot function 
#outputs heatmap of PCs
heat_scree_plot<-function(Loadings, Importance, Num, Order){

  ######### adjust according to importance of first PC #########
  adjust <- 1-Importance[1]
  pca_adjusted <- Importance[2:length(Importance)]/adjust
  pca_df <- data.frame(adjusted_variance = pca_adjusted, 
                      PC = seq(1:length(pca_adjusted)))
  
  ######### Scree plot #########
  
  #plot variance that each adjusted PC accounts for 
  scree <- ggplot(pca_df[which(pca_df$PC<=Num),],aes(PC,adjusted_variance)) + 
    geom_bar(stat = "identity",color="black",fill="grey") +
    theme_bw()+
    theme(axis.text = element_text(size =12),
          axis.title = element_text(size =15),
          plot.margin=unit(c(1,1.5,0.2,2.25),"cm"))+ylab("Variance") +
    scale_x_continuous(breaks = seq(1,Num,1))
  
  ######### Heat map of variance in each variable explained by PCs ######### 
  
  #correlate metadata (variables) with PCS
  #Run anova of each PC on each meta data variable
  
  ### Categorical variables ###
  
  #Run ANOVA on each PC
  aov_PC_meta <- lapply(1:ncol(meta_categorical), 
                        function(covar) sapply(1:ncol(Loadings), 
                        function(PC) summary(aov(Loadings[,PC]~
                                                 meta_categorical[,covar]))[[1]]$"Pr(>F)"[1]))
  
  #set names according to names of categorical variables
  names(aov_PC_meta) <- colnames(meta_categorical)
  #create matrix from list
  aov_PC_meta <- do.call(rbind, aov_PC_meta)
  
  
  ### Continuous variables ### 
  
  #Conduct spearman correlation 
  cor_PC_meta <- lapply(1:ncol(meta_continuous), 
                        function(covar) sapply(1:ncol(Loadings), 
                        function(PC) (cor.test(Loadings[,PC],
                                               as.numeric(meta_continuous[,covar]),
                                               alternative = "two.sided", method="spearman",
                                               na.action=na.omit, exact=FALSE)$p.value)))
  
  #rename according to names of continuous variables
  names(cor_PC_meta)<-colnames(meta_continuous)
  #create matrix from list
  cor_PC_meta<-do.call(rbind, cor_PC_meta)
  
  
  ### Prepare continous and categorical data for heat map ###
  
  #combine as df
  allvar_PC <- as.data.frame(rbind(aov_PC_meta, cor_PC_meta))
  
  #omit first pc to adjust
  allvar_PC_adjust <- allvar_PC[,2:ncol(allvar_PC)]
  
  ### Clean all variable PCs for plotting ###
  
  #plot number of PCs specified by user 
  #reduces number of columns to be equal to "num"
  plotting_PCs <- allvar_PC_adjust[,1:Num]
  
  #convert plotting PCs to numeric
  plotting_PCs_num <- apply(plotting_PCs,2, as.numeric)
  
  #convert plotting PCs to dataframe
  plotting_PCs_num <- as.data.frame(plotting_PCs_num)
  
  #Rename columna to PC 1, 2, 3, etc...
  colnames(plotting_PCs_num) <- sapply(1:Num, function(x) paste("PC",x, sep=""))
  
  #Create column to name rows accordiong to variable names (metadata)
  plotting_PCs_num$meta <- rownames(plotting_PCs[1:nrow(plotting_PCs),])
  
  #Melt dataframe to long format for plotting
  plotting_PCs_melt <- reshape2::melt(plotting_PCs_num, id.vars="meta")
  
  #Cluster metadata according to order specified by user
  ord <- Order
  plotting_PCs_order <- unique(plotting_PCs_melt$meta)[rev(ord)]
  plotting_PCs_melt$meta <- factor(plotting_PCs_melt$meta, levels = plotting_PCs_order)
  
  #hard code colours for heat map into dataframe according to PC significance
  plotting_PCs_melt$Pvalue<-sapply(1:nrow(plotting_PCs_melt), function(x)
    if(plotting_PCs_melt$value[x]<=0.001){"<=0.001"}else{
      if(plotting_PCs_melt$value[x]<=0.01){"<=0.01"}else{
        if(plotting_PCs_melt$value[x]<=0.05){"<=0.05"}else{">0.05"}}})
  
  heat <- ggplot(plotting_PCs_melt, aes(variable, meta, fill = Pvalue)) +
    geom_tile(color = "black",size=0.5) +
    theme_gray(8) + 
    scale_fill_manual(breaks = c("<=0.001", "<=0.01", "<=0.05", ">0.05"),
                        values=c("#084594","#4292c6","#9ecae1","#ffffff")) + 
    theme(axis.text = element_text(size =10, color="black"),
          axis.text.x = element_text(),
          axis.title = element_text(size =15),
          legend.text = element_text(size =14),
          legend.title = element_text(size =12),
          legend.position = "bottom",
          plot.margin=unit(c(0,2.25,1,1),"cm"))+
    xlab("Principal Component")+ylab(NULL)
  
  cowplot::plot_grid(scree, heat, ncol=1)
}



```

PC analysis
```{r pc_covariates}
#load cell type predictions
load("R:/Jones/People/Samantha Lee/Projects/CHILD/CHILD_air_pollution/output_data/deconvolution/2020-11-10_CBMC_PBMC_deconvolution.Rdata")

#convert cell counts to dataframe
child_fscbc_ecc2_cb_df <- as.data.frame(child_fscbc_ecc2_cb)

#subset cell counts for participants in pdata
child_fscbc_ecc2_cb_df_sub <-  child_fscbc_ecc2_cb_df[rownames(child_fscbc_ecc2_cb_df) %in%
                                                        rownames(cb_pdata), ]

#check size
dim(child_fscbc_ecc2_cb_df_sub) #144

#check order
identical(rownames(child_fscbc_ecc2_cb_df_sub), rownames(cb_pdata)) #true

#rename rownames to participant id (5 digit num)
rownames(child_fscbc_ecc2_cb_df_sub) <- cb_pdata$Sample_Label

#susbet cell counts for complete cases
child_fscbc_ecc2_cb_df_cc <- 
  child_fscbc_ecc2_cb_df_sub[rownames(child_fscbc_ecc2_cb_df_sub) %in%
                               as.character(covariates_ctpcs_geno_tech_cc$sampleid), ]

#check size
dim(child_fscbc_ecc2_cb_df_cc) #102

#check order
identical(rownames(child_fscbc_ecc2_cb_df_cc), 
          as.character(covariates_ctpcs_geno_tech_cc$sampleid)) #true

#combine
covariates_ctpcs_geno_tech_cc <- cbind(covariates_ctpcs_geno_tech_cc,
                                       child_fscbc_ecc2_cb_df_cc)


#convert betas to mvalues
cb_mvals_geno_cc <- lumi::beta2m(cb_betas_geno_cc)


#PCA
uncor.dat <- t(scale(t(cb_mvals_geno_cc)))
PCA_full<-princomp(na.omit(uncor.dat))
Loadings<-as.data.frame(unclass(PCA_full$loadings))
vars <- PCA_full$sdev^2
Importance<-vars/sum(vars)

# Specify the number of PCs you want shown 
# pick enough to view most of the variance
Num<-20

# Designate what order you want the variables to appear (continuous variables rbinded to categorical variables in function)
Order<-c(1:20)


#Apply function on PCA results of uncorrected data, pulls in the meta data and beta values from above
meta_categorical <- covariates_ctpcs_geno_tech_cc[,c("sex", "prenatal_maternal_smoking", "run", "chip")]

meta_continuous <- covariates_ctpcs_geno_tech_cc[,c("no2_preg_entire", "gestational_days",
                                                    "maternal_education_length", 
                                                    "pss_18wk", "csed_18wk", 
                                                    "counts.CD4T", "counts.CD8T",
                                                    "counts.NK", "counts.Bcell",
                                                    "counts.Mono", "counts.nRBC",
                                                    "row")]

heat_scree_plot(Loadings, Importance, Num, Order)


covariates_ctpcs_geno_tech_cc_num <- as.data.frame(covariates_ctpcs_geno_tech_cc)
covariates_ctpcs_geno_tech_cc_num$sex <- as.factor(covariates_ctpcs_geno_tech_cc_num$sex )
covariates_ctpcs_geno_tech_cc_num$sex <- as.numeric(covariates_ctpcs_geno_tech_cc_num$sex)
covariates_ctpcs_geno_tech_cc_num$prenatal_maternal_smoking <- as.numeric(covariates_ctpcs_geno_tech_cc_num$prenatal_maternal_smoking)
covariates_ctpcs_geno_tech_cc_num$run <- as.numeric(covariates_ctpcs_geno_tech_cc_num$run)

test <- covariates_ctpcs_geno_tech_cc_num[,c("sex", "prenatal_maternal_smoking",
                                              "gestational_days",
                                             "maternal_education_length", 
                                             "pss_18wk", "csed_18wk")]


#variance in data
#prcomp using singular value decomposition (svd)m which examines the covariances / correlations between individuals
all_pca <- prcomp(test, 
                  scale. = TRUE)

#scree plot to visualize how many PCs we need
factoextra::fviz_eig(all_pca, ncp=20) #correct on first 9 pcs

#convert to dataframe
all_pcs <- as.data.frame(all_pca$x)

#examine grouping of pcs
ggpairs(all_pcs, columns=1:10, progress=FALSE)  


#add first two pcs to covariates
covariates_ctpcs_geno_tech_cc_num <- cbind(covariates_ctpcs_geno_tech_cc_num,
                                           all_pca$x[,c("PC1", "PC2", "PC3")])


#create model matrix
cb_design <- model.matrix(~no2_preg_entire + 
                            PC1 +
                            cbmc.PC1 + cbmc.PC2+
                            cbmc.PC3 + cbmc.PC4 + cbmc.PC5 +
                            genotyping.PC1 +
                            genotyping.PC2 +
                            genotyping.PC3 + row + run,
                          data=covariates_ctpcs_geno_tech_cc_num)

#check size
dim(cb_design) #101


#subset betas
cb_betas_geno_cc <- 
  cb_betas_geno[,colnames(cb_betas_geno) %in% covariates_ctpcs_geno_tech_cc_num$sampleid]
#check size
dim(cb_betas_geno_cc) #101

#fit methylation to no2
cb_fit <-  lmFit(cb_betas_geno_cc, cb_design)
cb_ebayes <- eBayes(cb_fit)

#add annotation to cb_ebayes
cb_ebayes$annotation <- annotation[rownames(annotation) %in% rownames(cb_ebayes),]

#pull out pval, coefficients and annotation
cb_pvals_tech <- cbind(as.data.frame(cb_ebayes$p.value), 
                  as.data.frame(cb_ebayes$coefficients),
                  as.data.frame(cb_ebayes$annotation))

#rename columns to indicate pvalues vs coeffcients 
colnames(cb_pvals_tech) <- c(paste("pval", colnames(cb_pvals_tech)[1:13], sep = "_"), 
                         paste("coeff", colnames(cb_pvals_tech)[14:26], sep = "_"),
                         colnames(cb_pvals_tech)[27:59])

ggplot( data = cb_pvals_tech, aes(x=pval_no2_preg_entire)) +
  geom_histogram(bins=100, fill = "#75A2D9") +
  labs(y="Count", x="Unadjusted p-value") +
  theme_bw() +
  theme(panel.border = element_blank(),
        axis.text=element_text(size=18),
        axis.title=element_text(size=20)) 
```





## Why dont lm and stat_smooth produce the same result

Investigate using dummy variables for NO2 and DNAm that are correlated and run with lm.
```{r dummy_test}
# y, given x2
mod1 <- lm(y ~ x2 )
resid.1 <- resid(mod1)

mod1 <- lm(methmeans ~ 
              sex + gestational_days +
              maternal_education_length +
              prenatal_maternal_smoking + 
              pss_18wk + 
              csed_18wk + 
              cbmc.PC1 + cbmc.PC2 + cbmc.PC3 + 
              cbmc.PC4 + cbmc.PC5 +
              genotyping.PC1 +
              genotyping.PC2 +
              genotyping.PC3 +
              run + row, 
              data=covariates_ctpcs_geno_tech_cc)

resid.1 <- resid(mod1)

# x1, given x2
mod2 <- lm(x1 ~ x2)
resid.2 <- resid(mod2)

mod2 <- lm(no2_preg_entire ~
              , 
              data=covariates_ctpcs_geno_tech_cc)

resid.2 <- resid(mod2)




# y, given x1
mod3 <- lm(y ~ x1 )
resid.3 <- resid(mod3)

mod3 <- lm(methmeans ~ no2_preg_entire, 
              data=covariates_ctpcs_geno_tech_cc)

resid.3 <- resid(mod2)



plot(resid.1 )
plot(covariates_ctpcs_geno_tech_cc$no2_preg_entire, 
     covariates_ctpcs_geno_tech_cc$methmeans, 
     main='covariates_ctpcs_geno_tech_cc$no2_preg_entire ~
     covariates_ctpcs_geno_tech_cc$methmeans')

plot(x1, y, main='y ~ x1')
plot(x2, y, main='y ~ x2')

# x2, given x1
mod4 <- lm(sex + gestational_days +
              maternal_education_length +
              prenatal_maternal_smoking + 
              pss_18wk + 
              csed_18wk + 
              cbmc.PC1 + cbmc.PC2 + cbmc.PC3 + 
              cbmc.PC4 + cbmc.PC5 +
              genotyping.PC1 +
              genotyping.PC2 +
              genotyping.PC3 +
              run + row ~ methmeans, data=covariates_ctpcs_geno_tech_cc)

resid.4 <- resid(mod4)


mod5 <- lm(methmeans ~ no2_preg_entire + sex + gestational_days +
              maternal_education_length +
              prenatal_maternal_smoking + 
              pss_18wk + 
              csed_18wk + 
              cbmc.PC1 + cbmc.PC2 + cbmc.PC3 + 
              cbmc.PC4 + cbmc.PC5 +
              genotyping.PC1 +
              genotyping.PC2 +
              genotyping.PC3 +
              run + row , data=covariates_ctpcs_geno_tech_cc)

resid.4 <- resid(mod4)


library(effects)
effx1 <- effect("no2_preg_entire", mod5, partial.residuals=T)
plot(effx1, smooth.residuals=F)


avPlot(mod5, variable="no2_preg_entire", marginal.scale = T)


test <- piecewiseSEM::partialResid( methmeans ~ no2_preg_entire, mod5, 
              data=covariates_ctpcs_geno_tech_cc)

test2 <- lm(test$yresid ~ test$xresid)

ggplot(test, aes(x=xresid, y=yresid)) + 
  geom_point() + 
  stat_smooth(method="lm", se=F) +
  theme_bw() +
  theme(panel.border = element_blank())
```




Compare no edu and no ga to just no ga
```{r compare_vars}

db <- as.data.frame(cbind("noedu"= cb_pvals_tech_noedu$db, 
               "noedu.noga" = cb_pvals_tech_noedu_noga$db))

ggplot(db, aes(x=noedu, y=noedu.noga)) +
  geom_point() + 
  geom_abline(slope=1, intercept=0, col="red", linetype="dashed") +
  ggtitle("NO2 delta beta of regressions") +
      labs(x=str_wrap("DNAm ~ sex + GA + smoking + stress + depression cell types + genetic ancestry + batch effects", width=70),
       y=str_wrap("DNAm ~ sex + smoking + stress + depression cell types + genetic ancestry + batch effects", width=50)) +
  theme_bw() +
  theme(panel.border = element_blank())




pvals <- as.data.frame(cbind("noedu"= cb_pvals_tech_noedu$pval_no2_preg_entire, 
               "noedu.noga" = cb_pvals_tech_noedu_noga$pval_no2_preg_entire))

ggplot(pvals, aes(x=noedu, y=noedu.noga)) + 
  geom_point() + 
  geom_abline(slope=1, intercept=0, col="red", linetype="dashed") +
  ggtitle("NO2 pvalues of regressions") +
    labs(x=str_wrap("DNAm ~ sex + GA + smoking + stress + depression cell types + genetic ancestry + batch effects", width=70),
       y=str_wrap("DNAm ~ sex + smoking + stress + depression cell types + genetic ancestry + batch effects", width=50)) +
  theme_bw() +
  theme(panel.border = element_blank())


```


Investigate interferon lambda (IL29) for meaghan
```{r ifn_lamda}
ifnl1_cpgs<- annotation[grep("IL29", annotation$UCSC_RefGene_Name), ]

#transpose betas
cb_betas_geno_cc_t <- t(cb_betas_geno_cc)


#apply function for calculating significance of associations using mice and imputed covariate data
ifnl1_list <- 
  pbapply(cb_betas_geno_cc_t [,colnames(cb_betas_geno_cc_t ) %in% rownames(ifnl1_cpgs)], 2, function(x) {
  
  combined <- cbind(covariates_ctpcs_geno_tech_cc, x)
  
  #run the linear regression on this cpg using all 5 imputed covariate data sets
  fit <- lm(x ~no2_preg_entire + 
              sex + 
              maternal_education_length +
              prenatal_maternal_smoking + 
              pss_18wk + 
              csed_18wk + 
              cbmc.PC1 + cbmc.PC2 + cbmc.PC3 + 
              cbmc.PC4 + cbmc.PC5 +
              genotyping.PC1 +
              genotyping.PC2 +
              genotyping.PC3 +
              run + row, data=combined)
  
  #get summary of lm fit
  #this includes coefficients and pvalues
  #coerce into df for manipulation
  #add in terms (rownames) as column for annotation
  fit_sum <- summary(fit)
  fit_sum_coeff <- as.data.frame(fit_sum$coefficients)
  fit_sum_coeff$term <- rownames(fit_sum_coeff)
  
  #this data frame has rows for each linear regression variable, and columns for statistics
  #want a dataframe of 1 row and many columns (one for each variable with each statistic type)
  #do this by using the spread function for each statistic
  #add cpg id onto dataframe for pvalues (to keep track of information)
  #then cbind dataframes together
  
  #coefficient
  estimate <- spread(fit_sum_coeff[,c("term", "Estimate")], term, Estimate)
  colnames(estimate) <- paste("estimate", colnames(estimate), sep=".")
  
  #std error
  std.error <- spread(fit_sum_coeff[,c("term", "Std. Error")], term, 'Std. Error')
  colnames(std.error) <- paste("std.error", colnames(std.error), sep=".")
  
  #t statistics
  statistic <- spread(fit_sum_coeff[,c("term", "t value")], term, 't value')
  colnames(statistic) <- paste("t.val", colnames(statistic), sep=".")

  #pvalue
  p.value <- spread(fit_sum_coeff[,c("term", "Pr(>|t|)")], term, 'Pr(>|t|)')
  colnames(p.value) <- paste("p.value", colnames(p.value), sep=".")
  
  #add in cpgid for annotation 
  p.value$cpg <- colnames(x)
  
  #cbind into wide dataframe
  widepool <- cbind(estimate, std.error, statistic, p.value)
  
  #return the wide dataframe
  #these will be do.call(rbind()) together after
  return(widepool)
  
})


ifnl1_meth <- do.call(rbind, ifnl1_list)

prenatal_goi$p.value.no2_preg_entire_adjusted <- p.adjust(prenatal_goi$p.value.no2_preg_entire, method="bonferroni")

#reorder according ot unadjusted no2 pvalue
prenatal_goi_order <- prenatal_goi[order(prenatal_goi$p.value.no2_preg_entire),]

#reorder goi annotation to be in same order as goi stats
goi_order <- goi[rownames(prenatal_goi_order),]

#check identical
identical(rownames(goi_order), rownames(prenatal_goi_order)) #true

#bind
goi_df <- cbind(prenatal_goi_order, goi_order)


```