---
title: "Year one postnatal regression using limma with complete cases"
author: "SL"
date: "March 04, 2021"
output: html_document
---

*Purpose*: The purpose of this script is to DNAm changes in year one PBMCs associated with year one air pollution exposure (proxied by no2). This script uses a subtraction method to "cancel" out effects of prenatal exposure, allowing the investigation of year one specific changes. 


Set global chunk options. 
```{r setup, include=FALSE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


Load required libraries.
```{r libraries}
library(tidyverse) # be tidy
library(limma) # for DNAm differences
library(here) # file calling
library(pbapply) # for running lm for each cpg
library(ggeffects) # for estimating marginal effects
library(broom) # tidy function for summarizing lm
library(sva) # for calculating SVs
library(ggcorrplot) # correlation matrix
library(bacon) # pvalue correction
library(ggsignif) # for significance comparison bars
```


Load  betas data
```{r covariates}
load(file=here("output_data", "preprocessed_data",
               "2021-10_07_CHILD_preprocessed_betas_pdata_annotation.Rdata"))
```


Load covariate data
```{r covariates}
# load covariate file
load(file=here("output_data", "covariates", "2021-09-24_CHILD_covariates_na_with_means.Rdata"))

#######################################################
# subset out cord blood and year one pdata separately #
#######################################################

# cord blood pdata
cb_pdata <- subset(pdata_nodups, Tissue == "C")
# check size of cord blood pdata
dim(cb_pdata) # 144  17

# year one pdata
y1_pdata <- subset(pdata_nodups, Tissue == "P")
# check size of year one pdata
dim(y1_pdata) # 145  17

# year one data has one individual that is missing birth data
# remove this individual
y1_pdata_sub <- y1_pdata[y1_pdata$Sample_Label %in% cb_pdata$Sample_Label, ]
# recheck size of year one pdata
dim(y1_pdata_sub) # 144  17
```


Subset out cord blood and age one betas
```{r sub_betas}
####################
# cord blood betas #
####################

# subset cord blood betas based on pdata
# all children with cord blood betas also have year one DNAm data
cb_betas <- betas[,colnames(betas) %in% rownames(cb_pdata)]

#check size of cord blood data
dim(cb_betas) # 424644    144
min(cb_betas) # 0.002973941
max(cb_betas) # 0.9980669

# check if cord blood DNAm samples are in same order in cord blood pdata
identical(colnames(cb_betas), rownames(cb_pdata)) # TRUE

# rename columns of cb_betas to sample label (5 digit identifier)
colnames(cb_betas) <- cb_pdata$Sample_Label

##################
# year one betas #
##################

# subset out year one DNAm samples from beta matrix
y1_betas <- betas[,colnames(betas) %in% rownames(y1_pdata_sub)]

# check size of year one data
dim(y1_betas) # 424644    144
min(y1_betas) # 0.002650193
max(y1_betas) # 0.9983506

# check if year one DNAm samples are in same order in year one pdata
identical(colnames(y1_betas), rownames(y1_pdata_sub)) # TRUE

# rename columns of cb_betas to sample label (5 digit identifier)
colnames(y1_betas) <- y1_pdata_sub$Sample_Label

# check if cord blood samples and year one samples are in same order
identical(colnames(cb_betas), colnames(y1_betas)) # TRUE
```


Subtract cord blood DNAm data from year one DNAm data to isolate postnatal DNAm changes. 
```{r diff_betas}
# call postnatal DNAm data "diff betas"
diff_betas <- y1_betas - cb_betas

# check size of difference betas
dim(diff_betas) # 424644    144
min(diff_betas) # -0.9793121 
max(diff_betas) # 0.9797916
```


Load combined cell type PCs (CBMC and PBMC together).
```{r load_celltype_PCs}
# load cell type PCs for diff betas
load(here("output_data", "deconvolution", 
          "2021-09-24_CHILD_CBMC_PBMC_PCs.Rdata"))

# check size
dim(ccc_pcs) # 144 11

# rename columns for clarity
colnames(ccc_pcs) <- paste("celltype.", colnames(ccc_pcs), sep="")
```


Load genotyping PCs. There are PCs for all CHILD participants that were genotyped. Therefore we have to subset the REEGLE participants used in this study out.
```{r genotypingPCS}
# load genotyping data
genotyping <- read.csv(here("input_data", "genotyping", "CHILD_subjects_Qced_first10PCS_Duan.csv"))

# make rownames the sample label (5 digit identifier)
rownames(genotyping) <- genotyping$FID

# remove columns that contain naming info since this is now in rownames
genotyping <- subset(genotyping, select=-c(FID, IID))

# subset REEGLE genotyping PCs
genosub <- genotyping[rownames(genotyping) %in% cb_pdata$Sample_Label,]

# check size
dim(genosub) # 131 10

# rename columns of genotyping data for clarity
colnames(genosub) <- paste("genotyping.", colnames(genosub), sep="")

# put rows in numerical order according to sample id
genosub_order <- genosub[order(rownames(genosub)), ]
```


Subset covariates, betas, pdata, and cell type PCs for samples that also have genotyping.
```{r sub_on_geno}
############
# cb pdata #
############

# subset cb_pdata
cb_pdata_geno <- cb_pdata[as.character(cb_pdata$Sample_Label) %in%
                            rownames(genosub_order), ]
# check size
dim(cb_pdata_geno) # 131

# check order
identical(as.character(cb_pdata_geno$Sample_Label), 
          rownames(genosub_order)) # TRUE

############
# y1 pdata #
############

# subset y1_pdata
y1_pdata_geno <- y1_pdata_sub[as.character(y1_pdata_sub$Sample_Label) %in%
                                rownames(genosub_order), ]
# check size
dim(y1_pdata_geno) # 131 14

# check order
identical(as.character(y1_pdata_geno$Sample_Label), 
          rownames(genosub_order)) # TRUE

##############
# covariates #
##############

# subset covariates
covariates_geno <- 
  covariates_nameans[as.character(covariates_nameans$sampleid) %in%
                       rownames(genosub_order), ]

# check size
dim(covariates_geno) #131

# check order
identical(as.character(covariates_geno$sampleid), 
          rownames(genosub_order)) # TRUE

##############
# diff betas #
##############

# subset betas
diff_betas_geno <- diff_betas[,colnames(diff_betas) %in% 
                                rownames(genosub_order)]

# check size
dim(diff_betas_geno) # 131

# check order
identical(colnames(diff_betas_geno), rownames(genosub_order)) # TRUE

#################
# cell type PCs #
#################

# subset celltype pcs
ccc_pcs_geno <- ccc_pcs[rownames(ccc_pcs) %in% rownames(genosub_order), ]

# check size
dim(ccc_pcs_geno) # 131 11

# check order
identical(rownames(ccc_pcs_geno), rownames(genosub_order)) # TRUE
```


Combine covariates with genotyping data, cell type PCs, and batch variables from pdata. 
```{r combine_data}

################################
# clean pdata before combining #
################################

# refactor and label new columns for cord blood batch vars
cb_pdata_geno$cb_chip <- as.factor(cb_pdata_geno$Sentrix_ID)
cb_pdata_geno$cb_run <- as.factor(cb_pdata_geno$Run)
cb_pdata_geno$cb_row <-
  as.numeric(as.factor(substr(cb_pdata_geno$Sentrix_Position, 1, 3)))

# refactor and label  new columns for year one batch vars
y1_pdata_geno$y1_chip <- as.factor(y1_pdata_geno$Sentrix_ID)
y1_pdata_geno$y1_run <- as.factor(y1_pdata_geno$Run)
y1_pdata_geno$y1_row <-
  as.numeric(as.factor(substr(y1_pdata_geno$Sentrix_Position, 1, 3)))

#######################
# combine data frames #
#######################

covariates_geno_ctpcs_tech <- cbind(covariates_geno,
                                    ccc_pcs_geno,
                                    genosub_order,
                                    cb_pdata_geno[,c("cb_run", 
                                                     "cb_row",
                                                     "cb_chip")],
                                    y1_pdata_geno[,c("y1_run", 
                                                     "y1_row",
                                                     "y1_chip")])

# check classes
lapply(covariates_geno_ctpcs_tech, class)

# reclass sex
covariates_geno_ctpcs_tech$sex <- as.factor(covariates_geno_ctpcs_tech$sex)
``` 



Subset covariates and betas for complete cases 
```{r complete_cases}
##############
# covariates #
##############

# covariate complete cases
covariates_geno_ctpcs_tech_cc <- 
  covariates_geno_ctpcs_tech[covariates_geno_ctpcs_tech %>% 
                               dplyr::select(no2_y1_entire, sex,  
                                             maternal_smoking_y1,  
                                             maternal_education_length, 
                                             pss_6mos,
                                             genotyping.PC1, 
                                             genotyping.PC2,
                                             genotyping.PC3,
                                             celltype.PC1, celltype.PC2,
                                             celltype.PC3, celltype.PC4,
                                             celltype.PC5, celltype.PC6, 
                                             celltype.PC7) %>% 
                               complete.cases,] 

# check size of complete case covariates
dim(covariates_geno_ctpcs_tech_cc) # 125 140

```


Remove rows where air pollution is 0.
```{r no_zeroes_in_no2}
covariates_geno_ctpcs_tech_cc_not0 <- covariates_geno_ctpcs_tech_cc[!covariates_geno_ctpcs_tech_cc$no2_y1_entire==0, ]

dim(covariates_geno_ctpcs_tech_cc) # 125 140
dim(covariates_geno_ctpcs_tech_cc_not0) # 125 140
```


```{r subset betas}

#########
# betas #
#########

#subset betas
diff_betas_geno_cc <- 
  diff_betas_geno[,colnames(diff_betas_geno) %in%
                    covariates_geno_ctpcs_tech_cc_not0$sampleid]
# check size
dim(diff_betas_geno_cc) # 424644    125

# remove betas that were used for cell type prediction
diff_betas_geno_cc_cpr <- 
  diff_betas_geno_cc[!rownames(diff_betas_geno_cc) %in%
                       rownames(child_fscbc_ecc2_cb_probelist_deconvo) &
                       !rownames(diff_betas_geno_cc) %in%
                       rownames(child_fscbc_ecc2_y1_probelist_deconvo), ]

# check size
dim(diff_betas_geno_cc_cpr) # 424045 125; 599 probes removed
```


Create model matrix for investigating postnatal DNAm changes. 
```{r model_matrix}
# create model matrix
mod <- model.matrix(~ no2_y1_entire + 
                      sex +
                      maternal_smoking_y1 + 
                      maternal_education_length +
                      pss_6mos + 
                      genotyping.PC1 + genotyping.PC2 + genotyping.PC3 + 
                      celltype.PC1 + celltype.PC2 + celltype.PC3 + 
                      celltype.PC4 + celltype.PC5 + celltype.PC6 + celltype.PC7, 
                    data=covariates_geno_ctpcs_tech_cc_not0)

# check size
dim(mod) # 125 19
```


Surrogate variable analysis using the sva packages. This will allow us to capture variance due to batch effects, as well as variance due to unkown biological variables. 
```{r sva}
#################
# calculate svs #
#################

# create null matrix
# this matrix does not include any of our covariates 
# this means that our covariates are "protected" and SVs will not capture them
mod0 <- model.matrix(~ sex + maternal_smoking_y1 + maternal_education_length +
                       pss_6mos + 
                       genotyping.PC1 + genotyping.PC2 + genotyping.PC3 + 
                       celltype.PC1 + celltype.PC2 + celltype.PC3 + 
                       celltype.PC4 + celltype.PC5 + celltype.PC6 + celltype.PC7, 
                     data=covariates_geno_ctpcs_tech_cc_not0)


################
# sva analysis #
################

# to get SVs in a way that allows calculation of their variance
# we need to pull the code out of sva and run it line-by-line
# we are using the "Be" method for calculating SVs

######################################
# irwsva required internal functions #
######################################

# edge.lfdr function is internal to irwsva function below
# mono function is internal to edge.lfdr
# they have to be initialized before we can run the rest of the code

mono <- function(lfdr){
  .Call("monotone", as.numeric(lfdr), PACKAGE="sva")
}

edge.lfdr <- function(p, trunc=TRUE, monotone=TRUE, transf=c("probit", "logit"), adj=1.5, eps=10^-8, lambda=0.8, ...) {
  pi0 <- mean(p >= lambda)/(1 - lambda)
  pi0 <- min(pi0, 1)
  n <- length(p)
  transf <- match.arg(transf)
  if(transf=="probit") {
    p <- pmax(p, eps)
    p <- pmin(p, 1-eps)
    x <- qnorm(p)
    myd <- density(x, adjust=adj)
    mys <- smooth.spline(x=myd$x, y=myd$y)
    y <- predict(mys, x)$y
    lfdr <- pi0*dnorm(x)/y
  }
  if(transf=="logit") {
    x <- log((p+eps)/(1-p+eps))
    myd <- density(x, adjust=adj)
    mys <- smooth.spline(x=myd$x, y=myd$y)
    y <- predict(mys, x)$y
    dx <- exp(x) / (1+exp(x))^2
    lfdr <- pi0 * dx/y
  }
  if(trunc) {
    lfdr[lfdr > 1] <- 1
  }
  if(monotone) {	
    lfdr <- lfdr[order(p)]
    lfdr <- mono(lfdr)
    lfdr <- lfdr[rank(p)]
  }
  return(lfdr)
}



##################################
# numsv function internal to sva #
##################################

#determine the number of required SVs
#this is numsv function code pulled out

#this is what is fed into this function from the sva function
dat = diff_betas_geno_cc_cpr
mod = mod
#method="be" # this is the default and what is called by numsv
#vfilter=NULL # we dont apply a filter and its not used for be method
B=20
set.seed(1234)

# initialize some stuff
# get the residual matrix (the remaining variance)
n <- ncol(dat)
m <- nrow(dat)
H <- mod %*% solve(t(mod) %*% mod) %*% t(mod)
res <- dat - t(H %*% t(dat))

# run svd and get some eigenvalues
uu <- svd(res)
# get the num of "sig" eigenvalues
ndf <- min(m, n) - ceiling(sum(diag(H)))
# get percent variance explained by each eigenvalue
dstat <- uu$d[1:ndf]^2/sum(uu$d[1:ndf]^2)
# initialize null distribution matrix
dstat0 <- matrix(0, nrow = B, ncol = ndf)

# set seed here since we are calling sample
# create the null distribution
for (i in 1:B) {
  # this part of the code removes all relationships in the 
  res0 <- t(apply(res, 1, sample, replace = FALSE))
  res0 <- res0 - t(H %*% t(res0))
  # calculate svs on this
  uu0 <- svd(res0)
  # bind their explained variance in null matrix
  dstat0[i, ] <- uu0$d[1:ndf]^2/sum(uu0$d[1:ndf]^2)
  print(i) # print out the iteration we are on
}

# determine the number of svs required here based on pvalues
psv <- rep(1, n)
for (i in 1:ndf) {
  psv[i] <- mean(dstat0[, i] >= dstat[i])
}
for (i in 2:ndf) {
  psv[i] <- max(psv[(i - 1)], psv[i])
}

# this is the variable holding the number of SVs required 
# number is each to all the svs with a pval less than/equal to 0.1
nsv <- sum(psv <= 0.1)


####################################
# code from the main SVA function  #
####################################

n.sv = nsv # from code above (run internally when sva called)
B = 5 # number of iterations

# dat =  betas # already initialized
# mod = mod  # already initialized
# mod0 = mod0  # already initialized 
# controls = NULL # we dont include controls - only for supervised method
# method = "irw" # this isnt actually used but would be called by sva
# vfilter = NULL # we dont set this when running sva
# numSVmethod = "be" # this is the default called by sva (code above)


###################################
# irwsva function internal to sva #
###################################

# this code is really want does all the work in sva
# we use the irw method so this is the code for that method
# there are also supervised and two step methods (not used by us)

# irw function takes input from sva, so we have already defined below vars
# dat = dat 
# mod = mod
# mod0 = mod0
# n.sv = n.sv
# B = B

# intialize variables again
n <- ncol(dat)
m <- nrow(dat)
Id <- diag(n)
resid <- dat %*% (Id - mod %*% solve(t(mod) %*% mod) %*% t(mod))
uu <- eigen(t(resid) %*% resid)
vv <- uu$vectors
ndf <- n - dim(mod)[2]
pprob <- rep(1, m)
one <- rep(1, n)
Id <- diag(n)
df1 <- dim(mod)[2] + n.sv
df0 <- dim(mod0)[2] + n.sv
rm(resid)

cat(paste("Iteration (out of", B, "):"))
for (i in 1:B) {
  mod.b <- cbind(mod, uu$vectors[, 1:n.sv])
  mod0.b <- cbind(mod0, uu$vectors[, 1:n.sv])
  ptmp <- f.pvalue(dat, mod.b, mod0.b)
  pprob.b <- (1 - edge.lfdr(ptmp))
  mod.gam <- cbind(mod0, uu$vectors[, 1:n.sv])
  mod0.gam <- cbind(mod0)
  ptmp <- f.pvalue(dat, mod.gam, mod0.gam)
  pprob.gam <- (1 - edge.lfdr(ptmp))
  pprob <- pprob.gam * (1 - pprob.b)
  dats <- dat * pprob
  dats <- dats - rowMeans(dats)
  uu <- eigen(t(dats) %*% dats)
  cat(paste(i, " "))
}

# this is what is normally returned by sva
# problem is that it doesnt include the diagonal matrix we want
sv_y1 = svd(dats)$v[, 1:n.sv, drop = FALSE] 
svobj <- list(sv = sv_y1, pprob.gam = pprob.gam, pprob.b = pprob.b, 
              n.sv = n.sv)

# to get all info (including diagonal)
svobj_all <- svd(dats)

save(sv_y1, file = here("output_data", "linear_regression", "2022-05-06_postnatal_svs.RData"))

#####################
# heat scree of SVs #
#####################

# from elodie portales-casamar

# heat scree prepartion
vars <- svobj_all[['d']]^2
vars <- vars/sum(vars)
names(vars) <- paste0('SV', 1:length(vars))
xp <- 1:svobj$n.sv
varsdf <- as.data.frame(vars)
varsdf$svnum <- rep(1:length(vars))

# heat scree ggplot
pn_sv_scree <- ggplot(varsdf[1:20,], aes(x=svnum, y=vars*100)) +
  geom_col() +
  theme_bw() +
  labs(x="Surrogate variables", y = "Variance (%)")

ggsave(plot = pn_sv_scree, 
       filename = here("figures", 
                       "linear_regression", 
                       "postnatal", 
                       "2022-05-06_pn_sv_heat_scree.png"),
       height = 5, width = 15, units = "cm")


######################
# correlation matrix #
######################

# add svs to covariates
covariates_geno_ctpcs_tech_cc_not0 <- cbind(covariates_geno_ctpcs_tech_cc_not0, sv_y1)

# rename columns with svs
colnames(covariates_geno_ctpcs_tech_cc_not0)[141:155] <-
  paste("sv",colnames(covariates_geno_ctpcs_tech_cc_not0)[141:155], sep="")

source(here("scripts", "2021-08-30_corr_mat_funs.R"))

corr <- corr.mat(covariates_geno_ctpcs_tech_cc_not0 %>% 
                   dplyr::select(no2_y1_entire, sex, maternal_smoking_y1, 
                                 maternal_education_length, pss_6mos,
                                 genotyping.PC1, genotyping.PC2, genotyping.PC3,
                                 celltype.PC1, celltype.PC2, celltype.PC3, 
                                 celltype.PC4, celltype.PC5, celltype.PC6,
                                 celltype.PC7,
                                 cb_chip, cb_run, cb_row,
                                 y1_chip, y1_run, y1_row, sv1:sv15) %>%
                   rename("Postnatal NO2" = no2_y1_entire, 
                          Sex = sex,
                          "Postnatal maternal cigarette smoking" = maternal_smoking_y1,
                          "Maternal education (years)" = maternal_education_length,
                          "Maternal perceived stress 6 months" = pss_6mos,
                          "Genotyping PC1" = genotyping.PC1,
                          "Genotyping PC2" = genotyping.PC2,
                          "Genotyping PC3" = genotyping.PC3,
                          "Cord blood chip" = cb_chip,
                          "Cord blood run" = cb_run,
                          "Cord blood row" = cb_row,
                          "Peripheral blood chip" = y1_chip,
                          "Peripheral blood run" = y1_run,
                          "Peripheral blood row" = y1_row,
                          "Celltype PC1" = celltype.PC1, 
                          "Celltype PC2" = celltype.PC2,
                          "Celltype PC3" = celltype.PC3,
                          "Celltype PC4" = celltype.PC4,
                          "Celltype PC5" = celltype.PC5,
                          "Celltype PC6" = celltype.PC6,
                          "Celltype PC7" = celltype.PC7,
                          SV1 = sv1, SV2 = sv2, SV3 = sv3, SV4 = sv4, SV5 = sv5,
                          SV6 = sv6, SV7 = sv7, SV8 = sv8, SV9 = sv9, 
                          SV10 = sv10, SV11 = sv11, SV12 = sv12, SV13 = sv13, 
                          SV14 = sv14, SV15 = sv15))

pval <- pval.mat(covariates_geno_ctpcs_tech_cc_not0 %>% 
                   dplyr::select(no2_y1_entire, sex, maternal_smoking_y1, 
                                 maternal_education_length, pss_6mos,
                                 genotyping.PC1, genotyping.PC2, genotyping.PC3,
                                 celltype.PC1, celltype.PC2, celltype.PC3, 
                                 celltype.PC4, celltype.PC5, celltype.PC6,
                                 celltype.PC7,
                                 cb_chip, cb_run, cb_row,
                                 y1_chip, y1_run, y1_row, sv1:sv15) %>%
                   rename("Postnatal NO2" = no2_y1_entire, 
                          Sex = sex,
                          "Postnatal maternal cigarette smoking" = maternal_smoking_y1,
                          "Maternal education (years)" = maternal_education_length,
                          "Maternal perceived stress 6 months" = pss_6mos,
                          "Genotyping PC1" = genotyping.PC1,
                          "Genotyping PC2" = genotyping.PC2,
                          "Genotyping PC3" = genotyping.PC3,
                          "Cord blood chip" = cb_chip,
                          "Cord blood run" = cb_run,
                          "Cord blood row" = cb_row,
                          "Peripheral blood chip" = y1_chip,
                          "Peripheral blood run" = y1_run,
                          "Peripheral blood row" = y1_row,
                          "Celltype PC1" = celltype.PC1, 
                          "Celltype PC2" = celltype.PC2,
                          "Celltype PC3" = celltype.PC3,
                          "Celltype PC4" = celltype.PC4,
                          "Celltype PC5" = celltype.PC5,
                          "Celltype PC6" = celltype.PC6,
                          "Celltype PC7" = celltype.PC7,
                          SV1 = sv1, SV2 = sv2, SV3 = sv3, SV4 = sv4, SV5 = sv5,
                          SV6 = sv6, SV7 = sv7, SV8 = sv8, SV9 = sv9, 
                          SV10 = sv10, SV11 = sv11, SV12 = sv12, SV13 = sv13, 
                          SV14 = sv14, SV15 = sv15))


svcorr <- corr.plot(pval = pval, 
                    corr = corr, 
                    label.sig = T,
                    shape = 8,shape.size = 1,
                    axis.text.size = 8, x.axis.text.angle = 90) +
  scale_y_discrete(position = "right") +
  theme(legend.position = "none",
        panel.grid = element_blank())
svcorr

ggsave(plot = svcorr,
       filename = here("figures", 
                       "linear_regression", 
                       "postnatal",
                       "2022-05-06_pn_sv_correlations.png"),
       height = 15,
       width = 15, 
       units = "cm")



######################################
# heat scree plot of svs against pcs #
######################################

# have to use betas for this as diff betas contain negative values
# cant convert negative beta to m-value

#pca 
uncor.dat <- t(scale(t(diff_betas_geno_cc_cpr)))
PCA_full<-princomp(na.omit(uncor.dat))
Loadings<-as.data.frame(unclass(PCA_full$loadings))
vars <- PCA_full$sdev^2
Importance <-vars/sum(vars)

source(here("scripts", "2021-09-14_heat_scree_plot.R"))

#Specify which covariates are categorical and/or continuous
meta_categorical <- 
  covariates_geno_ctpcs_tech_cc[,c("sex", "maternal_smoking_y1",
                                   "cb_run", "cb_chip", "y1_run", "y1_chip")] 
meta_continuous <- 
  covariates_geno_ctpcs_tech_cc[,c("no2_y1_entire",
                                   "maternal_education_length", 
                                   "pss_6mos", "csed_6mos",
                                   "cb_row", "y1_row", 
                                   "celltype.PC1", "celltype.PC2",
                                   "celltype.PC3", "celltype.PC4",
                                   "celltype.PC5", "celltype.PC6",
                                   "celltype.PC7", "celltype.PC8",
                                   "celltype.PC9", 
                                   "genotyping.PC1", "genotyping.PC2",
                                   "genotyping.PC3", "sv1", "sv2", "sv3",
                                   "sv4", "sv5", "sv6", "sv7", "sv8",
                                   "sv9", "sv10", "sv11", "sv12", "sv13",
                                   "sv14", "sv15")]

# Specify the number of PCs you want shown 
# pick enough to view most of the variance
Num<-10

# Designate what order you want the variables to appear (continuous variables rbinded to categorical variables in function)
Order<-c(1:40)

#Apply function on PCA results of uncorrected data, pulls in the meta data and beta values from above
heat_scree_plot(Loadings = Loadings, 
                Importance = Importance, 
                Num = Num, 
                Order = Order,
                Categorical = meta_categorical,
                Continuous = meta_continuous)


############################################################
# point plots to see how well SVs separate batch variables #
############################################################

# cord blood row
ggpairs(covariates_geno_ctpcs_tech_cc, columns=141:155,
        mapping = ggplot2::aes(color = as.factor(cb_row)),
        upper = "blank",
        lower = list(continuous = wrap("points", alpha = 0.5, size=1)), 
        diag = NULL) +
  theme_bw()  +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()) 

# cord blood run
ggpairs(covariates_geno_ctpcs_tech_cc, columns=141:155,
        mapping = ggplot2::aes(color = as.factor(cb_run)),
        upper = "blank",
        lower = list(continuous = wrap("points", alpha = 0.5, size=1)), 
        diag = NULL) +
  theme_bw()  +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())


#cord blood chip
ggpairs(covariates_geno_ctpcs_tech_cc, columns=141:155,
        mapping = ggplot2::aes(color = cb_chip),
        upper = "blank",
        lower = list(continuous = wrap("points", alpha = 0.5, size=1)), 
        diag = NULL) +
  theme_bw()  +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()) +
  scale_colour_manual(values=c("deeppink1", "green1", "blue1", "purple1",
                               "cyan1", "firebrick1", "seagreen3", "tomato1",
                               "black", "dimgrey", "yellow1", "hotpink1",
                               "aquamarine1", "goldenrod", "darkorange1", "mediumorchid3",
                               "coral2", "deepskyblue", "dodgerblue", "springgreen",
                               "royalblue", "palevioletred", "red", "orange", "maroon"))



# year one row
ggpairs(covariates_geno_ctpcs_tech_cc, columns=141:155,
        mapping = ggplot2::aes(color = as.factor(y1_row)),
        upper = "blank",
        lower = list(continuous = wrap("points", alpha = 0.5, size=1)), 
        diag = NULL) +
  theme_bw()  +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()) 


# year one run
ggpairs(covariates_geno_ctpcs_tech_cc, columns=141:155,
        mapping = ggplot2::aes(color = as.factor(y1_run)),
        upper = "blank",
        lower = list(continuous = wrap("points", alpha = 0.5, size=1)), 
        diag = NULL) +
  theme_bw()  +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()) 

#y1 chip
ggpairs(covariates_geno_ctpcs_tech_cc, columns=141:155,
        mapping = ggplot2::aes(color = as.factor(y1_chip)),
        upper = "blank",
        lower = list(continuous = wrap("points", alpha = 0.5, size=1)), 
        diag = NULL) +
  theme_bw()  +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()) +
  scale_colour_manual(values=c("deeppink1", "green1", "blue1", "purple1",
                               "cyan1", "firebrick1", "seagreen3", "tomato1",
                               "black", "dimgrey", "yellow1", "hotpink1",
                               "aquamarine1", "goldenrod", "darkorange1", "mediumorchid3",
                               "coral2", "deepskyblue", "dodgerblue", "springgreen",
                               "royalblue", "palevioletred", "red", "orange", "maroon"))




###########################
# add SVs to model matrix #
###########################

#Design matrix for limma with surrogate variables
modSv = cbind(mod,sv_y1)
```


```{r limma}

###############
#### LIMMA ####
###############
set.seed(1234)

#fit methylation to no2
diff_fit <-  lmFit(diff_betas_geno_cc_cpr, modSv)
diff_ebayes <- eBayes(diff_fit)

#add annotation to cb_ebayes
#pull annotation for cpgs contained in diff_betas
annotation_cpgs <- annotation[rownames(annotation) %in% rownames(diff_ebayes),]
#check order
identical(rownames(annotation_cpgs), rownames(diff_ebayes)) #false
#match
annotation_cpgs_order <- annotation_cpgs[rownames(diff_ebayes), ]
identical(rownames(annotation_cpgs_order), rownames(diff_ebayes)) #true

diff_ebayes$annotation <- annotation_cpgs_order

#pull out pval, coefficients and annotation
diff_pvals_tech <- cbind(as.data.frame(diff_ebayes$p.value), 
                         as.data.frame(diff_ebayes$coefficients),
                         as.data.frame(diff_ebayes$annotation))

#rename columns to indicate pvalues vs coefficients 
colnames(diff_pvals_tech) <- c(paste("pval", colnames(diff_pvals_tech)[1:31],
                                     sep = "_"), 
                               paste("coeff", colnames(diff_pvals_tech)[32:62], 
                                     sep = "_"),
                               colnames(diff_pvals_tech)[63:95])

diff_pvals_tech$adj_pval_no2_y1_entire <- 
  p.adjust(diff_pvals_tech$pval_no2_y1_entire, method="BH")
```


Bacon pvalue adjustment
```{r bacon}
# t stats in bacon
set.seed(1234)
bc <- bacon(diff_ebayes$t[,"no2_y1_entire"])

# get bacon pvals
diff_pvals_tech$pval_no2_y1_entire_bacon <- pval(bc)

# bh adjusted bacon pvals
diff_pvals_tech$pval_no2_y1_entire_bacon_adj  <-
  p.adjust(diff_pvals_tech$pval_no2_y1_entire_bacon , method="BH")

bacon_before_after <- plot(bc, type="qq") +
  scale_color_manual(values = c("#254A90")) +
  theme_bw() + 
  theme(legend.position = "none")


ggsave(plot = bacon_before_after, 
       filename= here("figures", 
                      "linear_regression", 
                      "postnatal", 
                      "2022-05-06_pn_bacon_before_after.png"),
       width = 12, height = 6, units = "cm")
```



Examine qqplot and pvalue histogram.
```{r qqplot_pval_histo}
s
# use code from qqman::qq function 
# plot with ggplot to make it more aesthetically appealing 

################
# raw p-values #
################

pvector <- diff_pvals_tech$pval_no2_y1_entire

pvector2 <- pvector[!is.na(pvector) & !is.nan(pvector) & !is.null(pvector) & 
                      is.finite(pvector) & pvector < 1 & pvector > 0]

pval_qq <- as.data.frame(cbind(o = -log10(sort(pvector2, decreasing = FALSE)),
                               e = -log10(ppoints(length(pvector2)))))

# inflation and bias
inflation <- inflation(bc)
bias <-  bias(bc)

before_qqplot <- ggplot(pval_qq, aes(x=e, y=o)) + 
  geom_point(col="#254A90", size=1) + 
  geom_abline(slope = 1, intercept = 0, 
              col = "red", size=0.25, linetype="dashed") +
  labs(x = "Expected -log10(p-value)",
       y = "Observed -log10(p-value)") +
  annotate("text", x=3, y=1.5, 
           label = paste("Inflation = ", signif(inflation, 2), 
                         "\nBias = ", signif(bias, 2)), 
           size=3, hjust=0) +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(size=9),
        axis.text.y = element_text(size=9),
        axis.title = element_blank()) +
  facet_grid(.~"Uncorrected") +
  lims(y = c(0, 6.25))

ggsave(plot = before_qqplot, 
       filename= here("figures", 
                      "linear_regression", 
                      "postnatal", 
                      "2022-05-06_pn_uncorrected_qqplot.png"),
       width = 6, height = 5, units = "cm")

############################
# bacon corrected p-values #
############################

pvector <- diff_pvals_tech$pval_no2_y1_entire_bacon

pvector2 <- pvector[!is.na(pvector) & !is.nan(pvector) & !is.null(pvector) & 
                      is.finite(pvector) & pvector < 1 & pvector > 0]

pval_qq <- as.data.frame(cbind(o = -log10(sort(pvector2, decreasing = FALSE)),
                               e = -log10(ppoints(length(pvector2)))))


# inflation and bias after bacon correction
set.seed(1234)
inflation_after <- inflation(bacon(tstat(bc)))
bias_after <- bias(bacon(tstat(bc)))

after_qqplot <- ggplot(pval_qq, aes(x=e, y=o)) + 
  geom_point(col="#254A90", size=1) + 
  geom_abline(slope = 1, intercept = 0, 
              col = "red", size=0.25, linetype="dashed") +
  labs(x = "Expected -log10(p-value)",
       y = "Observed -log10(p-value)") +
  annotate("text", x=3, y=1.5, 
           label = paste("Inflation = ", signif(inflation_after, 2), 
                         "\nBias = ", signif(bias_after, 2)), 
           size=3, hjust=0) +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(size=9),
        axis.text.y = element_text(size=9),
        axis.title = element_blank()) +
  facet_grid(.~"Bacon corrected") +
  lims(y = c(0, 6.25))

ggsave(plot = after_qqplot, 
       filename= here("figures", 
                      "linear_regression", 
                      "postnatal", 
                      "2022-05-06_pn_bacon_corrected_qqplot.png"),
       width = 6, height = 5, units = "cm")
```


Delta beta
```{r db}
range = max(covariates_geno_ctpcs_tech_cc$no2_y1_entire) -
  min(covariates_geno_ctpcs_tech_cc$no2_y1_entire)

diff_pvals_tech$db <- diff_pvals_tech$coeff_no2_y1_entire * range
```



Volcano plot
```{r volcano_db_tech}
#make new column to label sig points with cpgid
diff_pvals_tech$cpgid <- rownames(diff_pvals_tech)

#volcano plot
volcano_plot <- ggplot(diff_pvals_tech, 
                       aes(x=as.numeric(db), 
                           y=-log10(as.numeric(pval_no2_y1_entire_bacon)))) +
  geom_point(alpha=0.4, col = "#254A90", size=1) +
  # 2.5% effect size cut off
  geom_point(data=subset(diff_pvals_tech, 
                         (pval_no2_y1_entire_bacon_adj < 0.25 & db > 0.025) | 
                           (pval_no2_y1_entire_bacon_adj < 0.25 & db < -0.025)), 
             alpha=0.4, col = "red", size=1) + 
  scale_x_continuous(limits = c(-0.20, 0.20), 
                     breaks = seq(-0.20, 0.20, by = 0.1)) +
  labs(y="-log10(unadjusted p-value)", x = "Effect size (%)") +
  theme_bw() +
  theme(panel.grid = element_blank(),
        panel.border = element_blank(),
        axis.line = element_line(color ="black"),
        axis.text.x = element_text(size=9),
        axis.text.y = element_text(size=9),
        axis.title = element_blank()) 
volcano_plot

ggsave(plot = volcano_plot,
       filename = here("figures", 
                       "linear_regression", 
                       "postnatal", 
                       "2022-07-05_pn_volcanoplot.png"),
       width = 7.5, height = 6, units = "cm")
```


Subset out important cpgs
```{r sig_cpgs_tables}
# add db to e bayes
diff_ebayes$db <- diff_pvals_tech$db

# subset based on delta beta
diff_ebayes_sig <- diff_ebayes[diff_ebayes$db > 0.025 | diff_ebayes$db < -0.025, ]

# get top ten significant genes with coefficients and write csv
write.csv(limma::topTable(diff_ebayes_sig, number=10, 
                          coef ="no2_y1_entire", sort.by = "P", confint = T),
          here("tables", "yearone", "2022-05-06_toptable_yearone_10cpgs.csv"))

# get top 10 cpgs with manifest annotation
write.csv(subset(diff_pvals_tech, 
                 (pval_no2_y1_entire_bacon < 0.00002 & db > 0.025) | 
                   (pval_no2_y1_entire_bacon < 0.00002 & db < -0.025)), 
          here("tables", "yearone", 
               "2022-05-06_top10_postnatal_cpgs.csv"))

# write out all prenatal findings
write.csv(diff_pvals_tech, here("tables", "yearone", 
                                "2022-05-06_ALL_postnatal_cpgs.csv"))
```


Plot FDR significant CpGs
```{r sig_cpg_plot}

###################
# cg07472943 SHC2 #
###################

#add dnam to covariates for linear regression
covariates_geno_ctpcs_tech_cc_not0$cg07472943 <- 
  diff_betas_geno_cc_cpr[rownames(diff_betas_geno_cc_cpr)=="cg07472943", ]

#linear regression
cg07472943_lm <- lm(cg07472943 ~ no2_y1_entire + sex + pss_6mos +
                      maternal_smoking_y1 + maternal_education_length +
                      celltype.PC1 + celltype.PC2 + celltype.PC3 + 
                      celltype.PC4 + celltype.PC5 + celltype.PC6 + 
                      celltype.PC7 + 
                      genotyping.PC1 + genotyping.PC2 + genotyping.PC3 +
                      sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + sv7 + sv8 + sv9 + 
                      sv10 + sv11 + sv12 + sv13 + sv14 + sv15,
                    data = covariates_geno_ctpcs_tech_cc_not0)

# get summary of  linear regression
summary(cg07472943_lm)

# estimate marginal effects of prenatal NO2 exposure on DNAm
cg07472943_no2_me <- ggpredict(cg07472943_lm, terms = "no2_y1_entire") %>%
  as.data.frame() %>% 
  rename("cg07472943" = predicted,
         "no2_y1_entire" = x)

# plot
cg07472943_plot <- ggplot(covariates_geno_ctpcs_tech_cc_not0,
                          aes(x = no2_y1_entire, 
                              y= cg07472943*100)) + 
  geom_line(data = cg07472943_no2_me, 
            aes(x=no2_y1_entire, y = cg07472943*100),
            col="red", size=0.5, linetype="solid") +
  geom_ribbon(data = cg07472943_no2_me, 
              aes(x = no2_y1_entire, 
                  ymin = conf.low*100, ymax = conf.high*100), 
              alpha = .2) + 
  geom_point(alpha=0.6, col = "#254A90", size=1) + 
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text = element_text(size=9),
        panel.border = element_blank(),
        axis.line = element_line(color ="black"),
        axis.title = element_blank()) 


ggsave(plot = cg07472943_plot, 
       filename = here("figures", 
                       "linear_regression", 
                       "postnatal", 
                       "2022-05-06_cg07472943_SHC2.png"),
       width = 3.7, height = 3.2, units = "cm")

# correlation 
cor(covariates_geno_ctpcs_tech_cc_not0$cg07472943, 
    covariates_geno_ctpcs_tech_cc_not0$no2_y1_entire,
    method="pearson") # -0.1948573

lm(cg07472943_no2_me$cg07472943 ~cg07472943_no2_me$no2_y1_entire)

##############
# cg19263548 #
##############

#add dnam to covariates for linear regression
covariates_geno_ctpcs_tech_cc_not0$cg19263548 <- 
  diff_betas_geno_cc_cpr[rownames(diff_betas_geno_cc_cpr)=="cg19263548", ]

#linear regression
cg19263548_lm <- lm(cg19263548 ~ no2_y1_entire + sex + pss_6mos +
                      maternal_smoking_y1 + maternal_education_length +
                      celltype.PC1 + celltype.PC2 + celltype.PC3 + 
                      celltype.PC4 + celltype.PC5 + celltype.PC6 + 
                      celltype.PC7 + 
                      genotyping.PC1 + genotyping.PC2 + genotyping.PC3 +
                      sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + sv7 + sv8 + sv9 + 
                      sv10 + sv11 + sv12 + sv13 + sv14 + sv15,
                    data = covariates_geno_ctpcs_tech_cc_not0)

# get summary of  linear regression
summary(cg19263548_lm)

# estimate marginal effects of prenatal NO2 exposure on DNAm
cg19263548_no2_me <- ggpredict(cg19263548_lm, terms = "no2_y1_entire") %>%
  as.data.frame() %>% 
  rename("cg19263548" = predicted,
         "no2_y1_entire" = x)

# plot
cg19263548_plot <- ggplot(covariates_geno_ctpcs_tech_cc_not0,
                          aes(x = no2_y1_entire, 
                              y= cg19263548*100)) + 
  geom_line(data = cg19263548_no2_me, 
            aes(x=no2_y1_entire, y = cg19263548*100),
            col="red", size=0.5, linetype="solid") +
  geom_ribbon(data = cg19263548_no2_me, 
              aes(x = no2_y1_entire, 
                  ymin = conf.low*100, ymax = conf.high*100), 
              alpha = .2) + 
  geom_point(alpha=0.6, col = "#254A90", size=1) + 
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text = element_text(size=9),
        panel.border = element_blank(),
        axis.line = element_line(color ="black"),
        axis.title = element_blank()) 

ggsave(plot = cg19263548_plot, 
       filename = here("figures", 
                       "linear_regression", 
                       "postnatal", 
                       "2022-05-06_cg19263548.png"),
       width = 3.7, height = 3.2, units = "cm")

# correlation 
cor(covariates_geno_ctpcs_tech_cc_not0$cg19263548, 
    covariates_geno_ctpcs_tech_cc_not0$no2_y1_entire,
    method="pearson") # -0.2254198

# check slope of marginal effect
lm(cg07472943_no2_me$cg07472943 ~ cg07472943_no2_me$no2_y1_entire)


####################
# cg26989646 FOSL2 #
####################

#add dnam to covariates for linear regression
covariates_geno_ctpcs_tech_cc_not0$cg26989646 <- 
  diff_betas_geno_cc_cpr[rownames(diff_betas_geno_cc_cpr)=="cg26989646", ]

#linear regression
cg26989646_lm <- lm(cg26989646 ~ no2_y1_entire + sex + pss_6mos +
                      maternal_smoking_y1 + maternal_education_length +
                      celltype.PC1 + celltype.PC2 + celltype.PC3 + 
                      celltype.PC4 + celltype.PC5 + celltype.PC6 + 
                      celltype.PC7 + 
                      genotyping.PC1 + genotyping.PC2 + genotyping.PC3 +
                      sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + sv7 + sv8 + sv9 + 
                      sv10 + sv11 + sv12 + sv13 + sv14 + sv15,
                    data = covariates_geno_ctpcs_tech_cc_not0)

# get summary of  linear regression
summary(cg26989646_lm)

# estimate marginal effects of prenatal NO2 exposure on DNAm
cg26989646_no2_me <- ggpredict(cg26989646_lm, terms = "no2_y1_entire") %>%
  as.data.frame() %>% 
  rename("cg26989646" = predicted,
         "no2_y1_entire" = x)

# plot
cg26989646_plot <- ggplot(covariates_geno_ctpcs_tech_cc_not0,
                          aes(x = no2_y1_entire, 
                              y= cg26989646*100)) + 
  geom_line(data = cg26989646_no2_me, 
            aes(x=no2_y1_entire, y = cg26989646*100),
            col="red", size=0.5, linetype="solid") +
  geom_ribbon(data = cg26989646_no2_me, 
              aes(x = no2_y1_entire, 
                  ymin = conf.low*100, ymax = conf.high*100), 
              alpha = .2) + 
  geom_point(alpha=0.6, col = "#254A90", size=1) + 
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text = element_text(size=9),
        panel.border = element_blank(),
        axis.line = element_line(color ="black"),
        axis.title = element_blank()) 

ggsave(plot = cg26989646_plot, 
       filename = here("figures", 
                       "linear_regression", 
                       "postnatal", 
                       "2022-05-06_cg26989646_FOSL2.png"),
       width = 3.7, height = 3.2, units = "cm")

# correlation 
cor(covariates_geno_ctpcs_tech_cc_not0$cg26989646, 
    covariates_geno_ctpcs_tech_cc_not0$no2_y1_entire,
    method="pearson") # -0.211321


# check slope of marginal effect
lm(cg26989646_no2_me$cg26989646 ~ cg26989646_no2_me$no2_y1_entire)



#######################
# cg04823720 SLC25A13 #
#######################

#add dnam to covariates for linear regression
covariates_geno_ctpcs_tech_cc_not0$cg04823720 <- 
  diff_betas_geno_cc_cpr[rownames(diff_betas_geno_cc_cpr)=="cg04823720", ]

#linear regression
cg04823720_lm <- lm(cg04823720 ~ no2_y1_entire + sex + pss_6mos +
                      maternal_smoking_y1 + maternal_education_length +
                      celltype.PC1 + celltype.PC2 + celltype.PC3 + 
                      celltype.PC4 + celltype.PC5 + celltype.PC6 + 
                      celltype.PC7 +
                      genotyping.PC1 + genotyping.PC2 + genotyping.PC3 +
                      sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + sv7 + sv8 + sv9 + 
                      sv10 + sv11 + sv12 + sv13 + sv14 + sv15,
                    data = covariates_geno_ctpcs_tech_cc_not0)

# get summary of  linear regression
summary(cg04823720_lm)

# estimate marginal effects of prenatal NO2 exposure on DNAm
cg04823720_no2_me <- ggpredict(cg04823720_lm, terms = "no2_y1_entire") %>%
  as.data.frame() %>% 
  rename("cg04823720" = predicted,
         "no2_y1_entire" = x)

# plot
cg04823720_plot <- ggplot(covariates_geno_ctpcs_tech_cc_not0,
                          aes(x = no2_y1_entire, 
                              y= cg04823720*100)) + 
  geom_line(data = cg04823720_no2_me, 
            aes(x=no2_y1_entire, y = cg04823720*100),
            col="red", size=0.5, linetype="solid") +
  geom_ribbon(data = cg04823720_no2_me, 
              aes(x = no2_y1_entire, 
                  ymin = conf.low*100, ymax = conf.high*100), 
              alpha = .2) + 
  geom_point(alpha=0.6, col = "#254A90", size=1) + 
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text = element_text(size=9),
        panel.border = element_blank(),
        axis.line = element_line(color ="black"),
        axis.title = element_blank()) 

ggsave(plot = cg04823720_plot, 
       filename = here("figures", 
                       "linear_regression", 
                       "postnatal", 
                       "2022-05-06_cg04823720_SLC25A13.png"),
       width = 3.7, height = 3.2, units = "cm")

# correlation 
cor(covariates_geno_ctpcs_tech_cc_not0$cg04823720, 
    covariates_geno_ctpcs_tech_cc_not0$no2_y1_entire,
    method="pearson") # -0.2732582


#####################
# cg15212210 C2CD2L #
#####################

#add dnam to covariates for linear regression
covariates_geno_ctpcs_tech_cc_not0$cg15212210 <- 
  diff_betas_geno_cc_cpr[rownames(diff_betas_geno_cc_cpr)=="cg15212210", ]

#linear regression
cg15212210_lm <- lm(cg15212210 ~ no2_y1_entire + sex + pss_6mos +
                      maternal_smoking_y1 + maternal_education_length +
                      celltype.PC1 + celltype.PC2 + celltype.PC3 + 
                      celltype.PC4 + celltype.PC5 + celltype.PC6 + 
                      celltype.PC7 + 
                      genotyping.PC1 + genotyping.PC2 + genotyping.PC3 +
                      sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + sv7 + sv8 + sv9 + 
                      sv10 + sv11 + sv12 + sv13 + sv14 + sv15,
                    data = covariates_geno_ctpcs_tech_cc_not0)

# get summary of  linear regression
summary(cg15212210_lm)

# estimate marginal effects of prenatal NO2 exposure on DNAm
cg15212210_no2_me <- ggpredict(cg15212210_lm, terms = "no2_y1_entire") %>%
  as.data.frame() %>% 
  rename("cg15212210" = predicted,
         "no2_y1_entire" = x)

# plot
cg15212210_plot <- ggplot(covariates_geno_ctpcs_tech_cc_not0,
                          aes(x = no2_y1_entire, 
                              y= cg15212210*100)) + 
  geom_line(data = cg15212210_no2_me, 
            aes(x=no2_y1_entire, y = cg15212210*100),
            col="red", size=0.5, linetype="solid") +
  geom_ribbon(data = cg15212210_no2_me, 
              aes(x = no2_y1_entire, 
                  ymin = conf.low*100, ymax = conf.high*100), 
              alpha = .2) + 
  geom_point(alpha=0.6, col = "#254A90", size=1) + 
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text = element_text(size=9),
        panel.border = element_blank(),
        axis.line = element_line(color ="black"),
        axis.title = element_blank()) 

ggsave(plot = cg15212210_plot, 
       filename = here("figures", 
                       "linear_regression", 
                       "postnatal", 
                       "2022-05-06_cg15212210_C2CD2L.png"),
       width = 3.7, height = 3.2, units = "cm")

# correlation 
cor(covariates_geno_ctpcs_tech_cc_not0$cg15212210, 
    covariates_geno_ctpcs_tech_cc_not0$no2_y1_entire,
    method="pearson") # 0.003708507


##############
# cg08906030 #
##############

#add dnam to covariates for linear regression
covariates_geno_ctpcs_tech_cc_not0$cg08906030 <- 
  diff_betas_geno_cc_cpr[rownames(diff_betas_geno_cc_cpr)=="cg08906030", ]

#linear regression
cg08906030_lm <- lm(cg08906030 ~ no2_y1_entire + sex + pss_6mos +
                      maternal_smoking_y1 + maternal_education_length +
                      celltype.PC1 + celltype.PC2 + celltype.PC3 + 
                      celltype.PC4 + celltype.PC5 + celltype.PC6 + 
                      celltype.PC7 + 
                      genotyping.PC1 + genotyping.PC2 + genotyping.PC3 +
                      sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + sv7 + sv8 + sv9 + 
                      sv10 + sv11 + sv12 + sv13 + sv14 + sv15,
                    data = covariates_geno_ctpcs_tech_cc_not0)

# get summary of  linear regression
summary(cg08906030_lm)

# estimate marginal effects of prenatal NO2 exposure on DNAm
cg08906030_no2_me <- ggpredict(cg08906030_lm, terms = "no2_y1_entire") %>%
  as.data.frame() %>% 
  rename("cg08906030" = predicted,
         "no2_y1_entire" = x)

# plot
cg08906030_plot <- ggplot(covariates_geno_ctpcs_tech_cc_not0,
                          aes(x = no2_y1_entire, 
                              y= cg08906030*100)) + 
  geom_line(data = cg08906030_no2_me, 
            aes(x=no2_y1_entire, y = cg08906030*100),
            col="red", size=0.5, linetype="solid") +
  geom_ribbon(data = cg08906030_no2_me, 
              aes(x = no2_y1_entire, 
                  ymin = conf.low*100, ymax = conf.high*100), 
              alpha = .2) + 
  geom_point(alpha=0.6, col = "#254A90", size=1) + 
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text = element_text(size=9),
        panel.border = element_blank(),
        axis.line = element_line(color ="black"),
        axis.title = element_blank()) 

ggsave(plot = cg08906030_plot, 
       filename = here("figures", 
                       "linear_regression", 
                       "postnatal", 
                       "2022-05-06_cg08906030.png"),
       width = 3.7, height = 3.2, units = "cm")

# correlation 
cor(covariates_geno_ctpcs_tech_cc_not0$cg08906030, 
    covariates_geno_ctpcs_tech_cc_not0$no2_y1_entire,
    method="pearson") # -0.2407318


####################
# cg24353392 CRHR1 #
####################

#add dnam to covariates for linear regression
covariates_geno_ctpcs_tech_cc_not0$cg24353392 <- 
  diff_betas_geno_cc_cpr[rownames(diff_betas_geno_cc_cpr)=="cg24353392", ]

#linear regression
cg24353392_lm <- lm(cg24353392 ~ no2_y1_entire + sex + pss_6mos +
                      maternal_smoking_y1 + maternal_education_length +
                      celltype.PC1 + celltype.PC2 + celltype.PC3 + 
                      celltype.PC4 + celltype.PC5 + celltype.PC6 + 
                      celltype.PC7 +  
                      genotyping.PC1 + genotyping.PC2 + genotyping.PC3 +
                      sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + sv7 + sv8 + sv9 + 
                      sv10 + sv11 + sv12 + sv13 + sv14 + sv15,
                    data = covariates_geno_ctpcs_tech_cc_not0)

# get summary of  linear regression
summary(cg24353392_lm)

# estimate marginal effects of prenatal NO2 exposure on DNAm
cg24353392_no2_me <- ggpredict(cg24353392_lm, terms = "no2_y1_entire") %>%
  as.data.frame() %>% 
  rename("cg24353392" = predicted,
         "no2_y1_entire" = x)

# plot
cg24353392_plot <- ggplot(covariates_geno_ctpcs_tech_cc_not0,
                          aes(x = no2_y1_entire, 
                              y= cg24353392*100)) + 
  geom_line(data = cg24353392_no2_me, 
            aes(x=no2_y1_entire, y = cg24353392*100),
            col="red", size=0.5, linetype="solid") +
  geom_ribbon(data = cg24353392_no2_me, 
              aes(x = no2_y1_entire, 
                  ymin = conf.low*100, ymax = conf.high*100), 
              alpha = .2) + 
  geom_point(alpha=0.6, col = "#254A90", size=1) + 
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text = element_text(size=9),
        panel.border = element_blank(),
        axis.line = element_line(color ="black"),
        axis.title = element_blank()) 

ggsave(plot = cg24353392_plot, 
       filename = here("figures", 
                       "linear_regression", 
                       "postnatal", 
                       "2022-05-06_cg24353392_CRHR1.png"),
       width = 3.7, height = 3.2, units = "cm")

# correlation 
cor(covariates_geno_ctpcs_tech_cc_not0$cg24353392, 
    covariates_geno_ctpcs_tech_cc_not0$no2_y1_entire,
    method="pearson") # -0.1218661


####################
# cg06655349 S1PR2 #
####################

#add dnam to covariates for linear regression
covariates_geno_ctpcs_tech_cc_not0$cg06655349 <- 
  diff_betas_geno_cc_cpr[rownames(diff_betas_geno_cc_cpr)=="cg06655349", ]

#linear regression
cg06655349_lm <- lm(cg06655349 ~ no2_y1_entire + sex + pss_6mos +
                      maternal_smoking_y1 + maternal_education_length +
                      celltype.PC1 + celltype.PC2 + celltype.PC3 + 
                      celltype.PC4 + celltype.PC5 + celltype.PC6 + 
                      celltype.PC7 + 
                      genotyping.PC1 + genotyping.PC2 + genotyping.PC3 +
                      sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + sv7 + sv8 + sv9 + 
                      sv10 + sv11 + sv12 + sv13 + sv14 + sv15,
                    data = covariates_geno_ctpcs_tech_cc_not0)

# get summary of  linear regression
summary(cg06655349_lm)

# estimate marginal effects of prenatal NO2 exposure on DNAm
cg06655349_no2_me <- ggpredict(cg06655349_lm, terms = "no2_y1_entire") %>%
  as.data.frame() %>% 
  rename("cg06655349" = predicted,
         "no2_y1_entire" = x)

# plot
cg06655349_plot <- ggplot(covariates_geno_ctpcs_tech_cc_not0,
                          aes(x = no2_y1_entire, 
                              y= cg06655349*100)) + 
  geom_line(data = cg06655349_no2_me, 
            aes(x=no2_y1_entire, y = cg06655349*100),
            col="red", size=0.5, linetype="solid") +
  geom_ribbon(data = cg06655349_no2_me, 
              aes(x = no2_y1_entire, 
                  ymin = conf.low*100, ymax = conf.high*100), 
              alpha = .2) + 
  geom_point(alpha=0.6, col = "#254A90", size=1) + 
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text = element_text(size=9),
        panel.border = element_blank(),
        axis.line = element_line(color ="black"),
        axis.title = element_blank()) 

ggsave(plot = cg06655349_plot, 
       filename = here("figures", 
                       "linear_regression", 
                       "postnatal", 
                       "2022-05-06_cg06655349_S1PR2.png"),
       width = 3.7, height = 3.2, units = "cm")

# correlation 
cor(covariates_geno_ctpcs_tech_cc_not0$cg06655349, 
    covariates_geno_ctpcs_tech_cc_not0$no2_y1_entire,
    method="pearson") # -0.1564472
```


### Gene specific changes

These genes are related to the proposed pathway of air pollution action or have previously been shown to exhibit DNA methylation changes associated with prenatal air pollution exposure. 

```{r gene_specific}
#FHC is FTH1 (ferritin heavy chain 1)
#nothing maps to FOXP3
#TNFA is TNF

goi <- annotation[grep("^RNF39|^CYP2E1|^LONP1|^SLC25A28|^PLVAP|^CAT$|^CAT;|^TPO|^NFKB1|^NOX2|^SOD1|^SOD2|^TRX1|^TRX2|^GSTP1|^MT3|^NQO1|^HMOX1|^TGPX1|^DDH1|^NOS2|^CYP2C11|^CYP7B|^ALOX12$|^ALOX5;|^ALOX5$|^NRF2$|^NRF2;|^KEAP1|^AHR$|^AHR;|^ARNT;|^ARNT$|^GCLC|^GCLM|^GSR1|^SLC7A11|^GSTA1|^GSTA2|^GSTA3|^GSTA5|^GSTM1|^GSTM2|^GSTM3|^TXN$|^TXN;|^TXNRD1$|^TXNRD1;|^SRXN1|^G6PD|^CYP1A1|^IL1A|^IL2$|^IL2;|^IL3$|^IL3;|^IL4;|^IL4$|^IL5$|^IL5;|^IL6$|^IL6;|^IL9$|^IL9;|^IL10$|^IL10;|^IL12A|^IL13|^IL15$|^IL15;|^IL17A|^IL18$|^IL18;|^IL19|^IL21$|^IL21;|^IL22$|^IL22;|^IL23A$|^IL23A;|^IL25$|^IL25;|^IL27$|^IL27;|^IL31$|^IL31;|^IL33$|^IL33;|^IFNG$|^IFNG;|^TNF$|^TNF;|^TGFB1$|^TGFB1;|^FOXP3|^FTH1", annotation$UCSC_RefGene_Name), ] %>% as.data.frame()

unique(goi$UCSC_RefGene_Name)
unique(gsub(";.*$", "", unique(goi$UCSC_RefGene_Name))) # 59

#transpose betas
diff_betas_geno_cc_cpr_t <- t(diff_betas_geno_cc_cpr)

#apply function for calculating significance of associations using mice and imputed covariate data
yearone_goi_list <- 
  pbapply(diff_betas_geno_cc_cpr_t [,colnames(diff_betas_geno_cc_cpr_t ) %in% rownames(goi)], 2, function(x) {
    
    combined <- cbind(covariates_geno_ctpcs_tech_cc_not0, x)
    
    #run the linear regression on this cpg using all 5 imputed covariate data sets
    fit <- lm(x ~ no2_y1_entire + sex + pss_6mos +
                maternal_smoking_y1 + maternal_education_length +
                celltype.PC1 + celltype.PC2 + celltype.PC3 + celltype.PC4 + 
                celltype.PC5 + celltype.PC6 + celltype.PC7 +
                genotyping.PC1 + genotyping.PC2 + genotyping.PC3 +
                sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + sv7 + sv8 + sv9 + sv10 + 
                sv11 + sv12 + sv13 + sv14 + sv15, data=combined)
    
    #get summary of lm fit
    #this includes coefficients and pvalues
    #coerce into df for manipulation
    #add in terms (rownames) as column for annotation
    fit_sum <- summary(fit)
    fit_sum_coeff <- as.data.frame(fit_sum$coefficients)
    fit_sum_coeff$term <- rownames(fit_sum_coeff)
    
    #this data frame has rows for each linear regression variable, and columns for statistics
    #want a dataframe of 1 row and many columns (one for each variable with each statistic type)
    #do this by using the spread function for each statistics
    #add cpg id onto dataframe for pvalues (to keep track of information)
    #then cbind dataframes together
    
    #coefficient
    estimate <- spread(fit_sum_coeff[,c("term", "Estimate")], term, Estimate)
    colnames(estimate) <- paste("estimate", colnames(estimate), sep=".")
    
    #std error
    std.error <- spread(fit_sum_coeff[,c("term", "Std. Error")], term, 'Std. Error')
    colnames(std.error) <- paste("std.error", colnames(std.error), sep=".")
    
    #t statistics
    statistic <- spread(fit_sum_coeff[,c("term", "t value")], term, 't value')
    colnames(statistic) <- paste("t.val", colnames(statistic), sep=".")
    
    #pvalue
    p.value <- spread(fit_sum_coeff[,c("term", "Pr(>|t|)")], term, 'Pr(>|t|)')
    colnames(p.value) <- paste("p.value", colnames(p.value), sep=".")
    
    #add in cpgid for annotation 
    p.value$cpg <- colnames(x)
    
    #cbind into wide dataframe
    widepool <- cbind(estimate, std.error, statistic, p.value)
    
    #return the wide dataframe
    #these will be do.call(rbind()) together after
    return(widepool)
    
  })


yearone_goi <- do.call(rbind, yearone_goi_list)

yearone_goi$p.value.no2_y1_entire_adjusted <- p.adjust(yearone_goi$p.value.no2_y1_entire, method="BH")

#reorder according ot unadjusted no2 pvalue
yearone_goi_order <- yearone_goi[order(yearone_goi$p.value.no2_y1_entire),]

#reorder goi annotation to be in same order as goi stats
goi_order <- goi[rownames(yearone_goi_order),]

#check identical
identical(rownames(goi_order), rownames(yearone_goi_order)) #true

#bind
yearone_goi_df <- cbind(yearone_goi_order, goi_order)

# order according to pvalue
yearone_goi_df_pval <- yearone_goi_df  %>% arrange(p.value.no2_y1_entire)

# add delta beta
yearone_goi_df_pval_db <- merge(yearone_goi_df_pval, diff_pvals_tech, by="row.names", all.x=T) 

# write out table for all GOIs
write.csv(yearone_goi_df_pval_db, file=here("tables", "yearone",
                                            "2022-05-06_goi_postnatal_cpgs.csv"))

# write table of top ten 
write.csv(yearone_goi_df_pval_db %>% 
            subset(db > 0.025 | db < -0.025) %>% 
            subset(-log10(p.value.no2_y1_entire) > 1.7),
          here("tables", "yearone", "2022-05-06_top10goi_yearone_cpgs.csv"))

# use top table to get 95% CI
goi_df_pval_db_sig <- yearone_goi_df_pval_db %>% 
  subset(db > 0.025 | db < -0.025) %>% 
  subset(-log10(p.value.no2_y1_entire) > 1.7)

#write as .csv
write.csv(goi_df_pval_db_sig, 
          here("tables", "yearone", "2022-05-06_toptable_yearone_goi.csv"))


################
# gruzieva cps #
################

##################
#LONP1 cg12283362#
##################

covariates_geno_ctpcs_tech_cc_not0$cg12283362 <- 
  diff_betas_geno_cc_cpr[rownames(diff_betas_geno_cc_cpr)=="cg12283362", ] 

cg12283362_lm <- lm(cg12283362 ~ 
                      no2_y1_entire + sex + pss_6mos +
                      maternal_smoking_y1 + maternal_education_length +
                      celltype.PC1 + celltype.PC2 + celltype.PC3 + 
                      celltype.PC4 +celltype.PC5 + celltype.PC6 + 
                      celltype.PC7 +
                      genotyping.PC1 + genotyping.PC2 + genotyping.PC3 +
                      sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + sv7 + sv8 + 
                      sv9 + sv10 + sv11 + sv12 + sv13 + sv14 + sv15, 
                    data=covariates_geno_ctpcs_tech_cc_not0)

# get lm info
summary(cg12283362_lm)

# estimate marginal effects of prenatal NO2 exposure on DNAm
cg12283362_no2_me <- ggpredict(cg12283362_lm, terms = "no2_y1_entire") %>%
  as.data.frame() %>% 
  rename("cg12283362" = predicted,
         "no2_y1_entire" = x)

# plot
cg12283362_plot <- ggplot(covariates_geno_ctpcs_tech_cc_not0,
                          aes(x = no2_y1_entire, 
                              y= cg12283362)) + 
  geom_line(data = cg12283362_no2_me, 
            aes(x=no2_y1_entire, y = cg12283362),
            col="red", size=0.5, linetype="solid") +
  geom_ribbon(data = cg12283362_no2_me, 
              aes(x = no2_y1_entire, 
                  ymin = conf.low, ymax = conf.high), 
              alpha = .2) + 
  geom_point(alpha=0.6, col = "#254A90", size=1) + 
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text = element_text(size=9),
        panel.border = element_blank(),
        axis.line = element_line(color ="black"),
        axis.title = element_blank()) 

ggsave(plot = cg12283362_plot, 
       filename = here("figures", 
                       "linear_regression", 
                       "postnatal", 
                       "2022-05-09_cg12283362_LONP1.png"),
       width = 4, height = 3.2, units = "cm")

# effect size
range_no2 = max(covariates_geno_ctpcs_tech_cc_not0$no2_y1_entire) -
  min(covariates_geno_ctpcs_tech_cc_not0$no2_y1_entire)

summary(cg12283362_lm)$coefficients["no2_y1_entire", "Estimate"]*range_no2 # -0.1103026

# correlation 
cor(covariates_geno_ctpcs_tech_cc_not0$cg12283362, 
    covariates_geno_ctpcs_tech_cc_not0$no2_y1_entire,
    method="pearson") # -0.003466747

# check slope of marginal effect
lm(cg26989646_no2_me$cg26989646 ~ cg26989646_no2_me$no2_y1_entire)




#####################
#SLC25A28 cg08973675#
#####################

covariates_geno_ctpcs_tech_cc_not0$cg08973675 <- 
  diff_betas_geno_cc_cpr[rownames(diff_betas_geno_cc_cpr)=="cg08973675", ] 

cg08973675_lm <- lm(cg08973675 ~ 
                      no2_y1_entire + sex + pss_6mos +
                      maternal_smoking_y1 + maternal_education_length +
                      celltype.PC1 + celltype.PC2 + celltype.PC3 + celltype.PC4 + 
                      celltype.PC5 + celltype.PC6 + celltype.PC7  +
                      genotyping.PC1 + genotyping.PC2 + genotyping.PC3 +
                      sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + sv7 + sv8 + sv9 + sv10 + 
                      sv11 + sv12 + sv13 + sv14 + sv15, 
                    data=covariates_geno_ctpcs_tech_cc_not0)

# get lm info
summary(cg08973675_lm)

# estimate marginal effects of prenatal NO2 exposure on DNAm
cg08973675_no2_me <- ggpredict(cg08973675_lm, terms = "no2_y1_entire") %>%
  as.data.frame() %>% 
  rename("cg08973675" = predicted,
         "no2_y1_entire" = x)

# plot
cg08973675_plot <- ggplot(covariates_geno_ctpcs_tech_cc_not0,
                          aes(x = no2_y1_entire, 
                              y= cg08973675)) + 
  geom_line(data = cg08973675_no2_me, 
            aes(x=no2_y1_entire, y = cg08973675),
            col="red", size=0.5, linetype="solid") +
  geom_ribbon(data = cg08973675_no2_me, 
              aes(x = no2_y1_entire, 
                  ymin = conf.low, ymax = conf.high), 
              alpha = .2) + 
  geom_point(alpha=0.6, col = "#254A90", size=1) + 
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text = element_text(size=9),
        panel.border = element_blank(),
        axis.line = element_line(color ="black"),
        axis.title = element_blank()) +
  scale_y_continuous(breaks = seq(-0.08, 0.08, by=0.04), limits=c(-0.08, 0.08))

ggsave(plot = cg08973675_plot, 
       filename = here("figures", 
                       "linear_regression", 
                       "postnatal", 
                       "2022-05-09_cg08973675_SLC25A28.png"),
       width = 4, height = 3.2, units = "cm")

# effect size
range_no2 = max(covariates_geno_ctpcs_tech_cc_not0$no2_y1_entire) -
  min(covariates_geno_ctpcs_tech_cc_not0$no2_y1_entire)

summary(cg08973675_lm)$coefficients["no2_y1_entire", "Estimate"]*range_no2 # -0.1103026


# correlation 
cor(covariates_geno_ctpcs_tech_cc_not0$cg08973675, 
    covariates_geno_ctpcs_tech_cc_not0$no2_y1_entire,
    method="pearson") # -0.03784814


####################
# cg18668679 LONP1 #
####################

# add dnam to covariate data frame
covariates_geno_ctpcs_tech_cc_not0$cg18668679 <- 
  diff_betas_geno_cc_cpr[rownames(diff_betas_geno_cc_cpr)=="cg18668679", ]

# linear regression for partial resids
cg18668679_lm <- lm(cg18668679 ~ no2_y1_entire + sex + pss_6mos +   
                      maternal_smoking_y1 + maternal_education_length +
                      celltype.PC1 + celltype.PC2 + celltype.PC3 + celltype.PC4 + 
                      celltype.PC5 + celltype.PC6 + celltype.PC7 + 
                      genotyping.PC1 + genotyping.PC2 + 
                      genotyping.PC3 + sv1 + sv2 + sv3 + sv4 + sv5 + sv6 +
                      sv7 + sv8 + sv9 + sv10 + sv11 + sv12 + sv13 + sv14 + 
                      sv15, 
                    data=covariates_geno_ctpcs_tech_cc_not0)

# summary for slope and unadj p
summary(cg18668679_lm)

# estimate marginal effects of prenatal NO2 exposure on DNAm
cg18668679_no2_me <- ggpredict(cg18668679_lm, terms = "no2_y1_entire") %>%
  as.data.frame() %>% 
  rename("cg18668679" = predicted,
         "no2_y1_entire" = x)

# plot
cg18668679_plot <- ggplot(covariates_geno_ctpcs_tech_cc_not0,
                          aes(x = no2_y1_entire, 
                              y= cg18668679)) + 
  geom_line(data = cg18668679_no2_me, 
            aes(x=no2_y1_entire, y = cg18668679),
            col="red", size=0.5, linetype="solid") +
  geom_ribbon(data = cg18668679_no2_me, 
              aes(x = no2_y1_entire, 
                  ymin = conf.low, ymax = conf.high), 
              alpha = .2) + 
  geom_point(alpha=0.6, col = "#254A90", size=1) + 
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text = element_text(size=9),
        panel.border = element_blank(),
        axis.line = element_line(color ="black"),
        axis.title = element_blank()) 

ggsave(plot = cg18668679_plot, 
       filename = here("figures", 
                       "linear_regression", 
                       "postnatal", 
                       "2022-05-09_cg18668679_LONP1.png"),
       width = 4, height = 3.2, units = "cm")

# correlation 
cor(covariates_geno_ctpcs_tech_cc_not0$cg18668679, 
    covariates_geno_ctpcs_tech_cc_not0$no2_y1_entire,
    method="pearson") # -0.3433974

summary(cg18668679_lm)$coefficients["no2_y1_entire", "Estimate"]*range_no2 # -0.1103026
```



Examine whether DNAm at significant cpgs is associated with reported wheeze at age one. In previous CHILD paper [(PMID: 26424567)](https://www.science.org/doi/10.1126/scitranslmed.aab2271) wheeze was defined using wheeze questionnaires. If the child had wheezed with or without a cold during the first year of life (recorded via questionnaires answered by parents at 3, 6, and 12 months), the child was included in the wheezing group. Children were also included in the wheezing group if the CHILD clinician recorded a wheeze during the 1-year clinical assessment.

Need to multiple DNAm at each locus by 100 to put into percent to get an interpretable estimate and confidence interval.
```{r wheezing_atopy_assoc}

covariates_geno_ctpcs_tech_cc_not0$any_wheeze_y1 <- 
  ifelse(covariates_geno_ctpcs_tech_cc_not0$reported_wheezing_y1 ==1 | 
           covariates_geno_ctpcs_tech_cc_not0$clinician_wheeze_dx_y1 ==1, 1, 0)

###################
# cg07472943 SHC2 #
###################

covariates_geno_ctpcs_tech_cc_not0$cg07472943_100 <-
  covariates_geno_ctpcs_tech_cc_not0$cg07472943*100

# reported wheeze
cg07472943_wheeze <- ggplot(covariates_geno_ctpcs_tech_cc_not0 %>% 
                              dplyr::select(any_wheeze_y1, cg07472943, no2_y1_entire) %>%
                              na.omit(), 
                            aes(x=as.factor(any_wheeze_y1), y=cg07472943, color = no2_y1_entire)) +
  geom_boxplot(alpha=0.6, outlier.shape = NA) +
  geom_jitter(height=0, width=0.25, alpha=0.8, size=1) +
  scale_color_continuous() +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.title = element_blank(), 
        legend.position = "none") +
  scale_y_continuous(limits=c(-0.06, 0.09)) +
  scale_x_discrete(labels = c("No", "Yes")) +
  ggsignif::geom_signif(comparisons = list(c("0", "1")),
                        annotations = "adj.p=0.09", 
                        textsize = 3,vjust = -0.25)


ggsave(plot = cg07472943_wheeze, 
       filename = here("figures", 
                       "linear_regression", 
                       "postnatal", 
                       "2022-07-05_cg07472943_wheeze_nolegend.png"),
       width = 5, height = 5, units = "cm")


# wheeze logistic model
cg07472943_wheeze_log <- glm(any_wheeze_y1 ~ cg07472943_100  +
                               sex + pss_6mos +
                               maternal_smoking_y1 + maternal_education_length +
                               celltype.PC1 + celltype.PC2 + celltype.PC3 + 
                               celltype.PC4 + celltype.PC5 + celltype.PC6 + 
                               celltype.PC7 +  
                               genotyping.PC1 + genotyping.PC2 + genotyping.PC3 +
                               sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + sv7 + sv8 + 
                               sv9 + sv10 + sv11 + sv12 + sv13 + sv14 + sv15,    
                             data=covariates_geno_ctpcs_tech_cc_not0[!is.na(covariates_geno_ctpcs_tech_cc_not0$any_wheeze_y1),],
                             family = "binomial")

summary(cg07472943_wheeze_log)
cg07472943_wheeze_log_tidy <- tidy(cg07472943_wheeze_log, exponentiate = T, conf.int = T) 
cg07472943_wheeze_log_tidy # dnam pvalue = 0.00551  



# atopy SPT
ggplot(covariates_geno_ctpcs_tech_cc_not0 %>% 
         select(clinician_atopy_dx_y1, cg07472943) %>%
         na.omit(), 
       aes(x=as.factor(clinician_atopy_dx_y1), y=cg07472943)) +
  geom_boxplot() +
  geom_jitter(height=0) +
  theme_bw()

# atopy logistic model
cg07472943_atopy_log <- glm(clinician_atopy_dx_y1 ~ cg07472943_100 +
                              sex + pss_6mos +
                              maternal_smoking_y1 + maternal_education_length +
                              celltype.PC1 + celltype.PC2 + celltype.PC3 + 
                              celltype.PC4 + celltype.PC5 + celltype.PC6 + 
                              celltype.PC7 + 
                              genotyping.PC1 + genotyping.PC2 + genotyping.PC3 +
                              sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + sv7 + sv8 + 
                              sv9 + sv10 + sv11 + sv12 + sv13 + sv14 + sv15,                          data=covariates_geno_ctpcs_tech_cc_not0[!is.na(covariates_geno_ctpcs_tech_cc_not0$clinician_atopy_dx_y1),],
                            family = "binomial")

summary(cg07472943_atopy_log)
cg07472943_atopy_log_tidy <- tidy(cg07472943_atopy_log, exponentiate = T, conf.int = T) 
cg07472943_atopy_log_tidy # p = 0.219


##############
# cg19263548 #
##############

covariates_geno_ctpcs_tech_cc_not0$cg19263548_100 <-
  covariates_geno_ctpcs_tech_cc_not0$cg19263548*100

# reported wheeze
ggplot(covariates_geno_ctpcs_tech_cc_not0 %>% 
         select(any_wheeze_y1, cg19263548) %>%
         na.omit(), 
       aes(x=any_wheeze_y1, y=cg19263548)) +
  geom_boxplot() +
  geom_jitter(height=0) +
  theme_bw()

# wheeze logistic model 
cg19263548_wheeze_log <- glm(any_wheeze_y1 ~ cg19263548_100 +
                               sex + pss_6mos +
                               maternal_smoking_y1 + maternal_education_length +
                               celltype.PC1 + celltype.PC2 + celltype.PC3 + 
                               celltype.PC4 + celltype.PC5 + celltype.PC6 + 
                               celltype.PC7 + 
                               genotyping.PC1 + genotyping.PC2 + genotyping.PC3 +
                               sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + sv7 + sv8 + 
                               sv9 + sv10 + sv11 + sv12 + sv13 + sv14 + sv15,                          data=covariates_geno_ctpcs_tech_cc_not0[!is.na(covariates_geno_ctpcs_tech_cc_not0$any_wheeze_y1),],
                             family = "binomial")

summary(cg19263548_wheeze_log)
cg19263548_wheeze_log_tidy <- tidy(cg19263548_wheeze_log, exponentiate = T, conf.int = T) 
cg19263548_wheeze_log_tidy

# reported atopy
ggplot(covariates_geno_ctpcs_tech_cc_not0 %>% 
         dplyr::select(clinician_atopy_dx_y1, cg19263548) %>%
         na.omit(), 
       aes(x=clinician_atopy_dx_y1, y=cg19263548)) +
  geom_boxplot() +
  geom_jitter(height=0) +
  theme_bw()

# atopy logistic model 
cg19263548_atopy_log <- glm(clinician_atopy_dx_y1 ~ cg19263548_100 +
                              sex + pss_6mos +
                              maternal_smoking_y1 + maternal_education_length +
                              celltype.PC1 + celltype.PC2 + celltype.PC3 + 
                              celltype.PC4 + celltype.PC5 + celltype.PC6 + 
                              celltype.PC7 + 
                              genotyping.PC1 + genotyping.PC2 + genotyping.PC3 +
                              sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + sv7 + sv8 + 
                              sv9 + sv10 + sv11 + sv12 + sv13 + sv14 + sv15,                          data=covariates_geno_ctpcs_tech_cc_not0[!is.na(covariates_geno_ctpcs_tech_cc_not0$any_wheeze_y1),],
                            family = "binomial")
summary(cg19263548_atopy_log)
cg19263548_atopy_log_tidy <- tidy(cg19263548_atopy_log, exponentiate = T, conf.int = T) 
cg19263548_atopy_log_tidy


####################
# cg26989646 FOSL2 #
####################


covariates_geno_ctpcs_tech_cc_not0$cg26989646_100 <-
  covariates_geno_ctpcs_tech_cc_not0$cg26989646*100

# reported wheeze
ggplot(covariates_geno_ctpcs_tech_cc_not0 %>% 
         select(any_wheeze_y1, cg26989646) %>%
         na.omit(), 
       aes(x=as.factor(any_wheeze_y1), y=cg26989646)) +
  geom_boxplot() +
  geom_jitter(height=0) +
  theme_bw()

# wheeze logistic
cg26989646_wheeze_log <- glm(any_wheeze_y1 ~ cg26989646_100 +
                               sex + pss_6mos +
                               maternal_smoking_y1 + maternal_education_length +
                               celltype.PC1 + celltype.PC2 + celltype.PC3 + 
                               celltype.PC4 + celltype.PC5 + celltype.PC6 + 
                               celltype.PC7 +
                               genotyping.PC1 + genotyping.PC2 + genotyping.PC3 +
                               sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + sv7 + sv8 + 
                               sv9 + sv10 + sv11 + sv12 + sv13 + sv14 + sv15,                          data=covariates_geno_ctpcs_tech_cc_not0[!is.na(covariates_geno_ctpcs_tech_cc_not0$any_wheeze_y1),],
                             family = "binomial")

summary(cg26989646_wheeze_log)
cg26989646_wheeze_log_tidy <- tidy(cg26989646_wheeze_log, exponentiate = T, conf.int = T) 
cg26989646_wheeze_log_tidy

# logistic plot
cg26989646_wheeze_log_plot <- ggplot(test, aes(x=cg07472943, y=any_wheeze_y1)) +
    geom_point(alpha = 0.55) +
    stat_smooth(method="glm",  se=T,
                method.args = list(family=binomial)) +
    theme_bw()


# reported atopy
ggplot(covariates_geno_ctpcs_tech_cc_not0 %>% 
         select(clinician_atopy_dx_y1, cg26989646) %>%
         na.omit(), 
       aes(x=as.factor(clinician_atopy_dx_y1), y=cg26989646)) +
  geom_boxplot() +
  geom_jitter(height=0) +
  theme_bw()

# atopy logistic
cg26989646_atopy_log <- glm(clinician_atopy_dx_y1 ~ cg26989646_100 +
                              sex + pss_6mos +
                              maternal_smoking_y1 + maternal_education_length +
                              celltype.PC1 + celltype.PC2 + celltype.PC3 + 
                              celltype.PC4 + celltype.PC5 + celltype.PC6 + 
                              celltype.PC7 +
                              genotyping.PC1 + genotyping.PC2 + genotyping.PC3 +
                              sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + sv7 + sv8 + 
                              sv9 + sv10 + sv11 + sv12 + sv13 + sv14 + sv15,                          data=covariates_geno_ctpcs_tech_cc_not0[!is.na(covariates_geno_ctpcs_tech_cc_not0$clinician_atopy_dx_y1),],
                            family = "binomial")

summary(cg26989646_atopy_log)
cg26989646_atopy_log_tidy <- tidy(cg26989646_atopy_log, exponentiate = T, conf.int = T) 
cg26989646_atopy_log_tidy # dnam pvalue = 0.0965 


#######################
# cg04823720 SLC25A13 #
#######################

covariates_geno_ctpcs_tech_cc_not0$cg04823720_100 <-
  covariates_geno_ctpcs_tech_cc_not0$cg04823720*100

# reported wheeze
ggplot(covariates_geno_ctpcs_tech_cc_not0 %>% 
         select(any_wheeze_y1, cg04823720) %>%
         na.omit(), 
       aes(x=any_wheeze_y1, y=cg04823720)) +
  geom_boxplot() +
  geom_jitter(height=0) +
  theme_bw()

# wheeze logistic
cg04823720_wheeze_log <- glm(any_wheeze_y1 ~ cg04823720_100 +
                               sex + pss_6mos +
                               maternal_smoking_y1 + maternal_education_length +
                               celltype.PC1 + celltype.PC2 + celltype.PC3 + 
                               celltype.PC4 + celltype.PC5 + celltype.PC6 + 
                               celltype.PC7 +
                               genotyping.PC1 + genotyping.PC2 + genotyping.PC3 +
                               sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + sv7 + sv8 + 
                               sv9 + sv10 + sv11 + sv12 + sv13 + sv14 + sv15,                          data=covariates_geno_ctpcs_tech_cc_not0[!is.na(covariates_geno_ctpcs_tech_cc_not0$any_wheeze_y1),], family = "binomial")

summary(cg04823720_wheeze_log)
cg04823720_wheeze_log_tidy <- tidy(cg04823720_wheeze_log, exponentiate = T, conf.int = T) 
cg04823720_wheeze_log_tidy

# clinician atopy
ggplot(covariates_geno_ctpcs_tech_cc_not0 %>% 
         select(clinician_atopy_dx_y1, cg04823720) %>%
         na.omit(), 
       aes(x=as.factor(clinician_atopy_dx_y1), y=cg04823720)) +
  geom_boxplot() +
  geom_jitter(height=0) +
  theme_bw()

# atopy logistic
cg04823720_atopy_log <- glm(clinician_atopy_dx_y1 ~ cg04823720_100 +
                              sex + pss_6mos +
                              maternal_smoking_y1 + maternal_education_length +
                              celltype.PC1 + celltype.PC2 + celltype.PC3 + 
                              celltype.PC4 + celltype.PC5 + celltype.PC6 + 
                              celltype.PC7 +
                              genotyping.PC1 + genotyping.PC2 + genotyping.PC3 +
                              sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + sv7 + sv8 + 
                              sv9 + sv10 + sv11 + sv12 + sv13 + sv14 + sv15,                          data=covariates_geno_ctpcs_tech_cc_not0[!is.na(covariates_geno_ctpcs_tech_cc_not0$clinician_atopy_dx_y1),], family = "binomial")

summary(cg04823720_atopy_log)
cg04823720_atopy_log_tidy <- tidy(cg04823720_atopy_log, exponentiate = T, conf.int = T) 
cg04823720_atopy_log_tidy


#####################
# cg15212210 C2CD2L #
#####################

covariates_geno_ctpcs_tech_cc_not0$cg15212210_100 <-
  covariates_geno_ctpcs_tech_cc_not0$cg15212210*100

# reported wheeze
ggplot(covariates_geno_ctpcs_tech_cc_not0 %>% 
         select(any_wheeze_y1, cg15212210) %>%
         na.omit(), 
       aes(x=any_wheeze_y1, y=cg15212210)) +
  geom_boxplot() +
  geom_jitter(height=0) +
  theme_bw()

# wheeze logistic
cg15212210_wheeze_log <- glm(any_wheeze_y1 ~ cg15212210_100 +
                               sex + pss_6mos +
                               maternal_smoking_y1 + maternal_education_length +
                               celltype.PC1 + celltype.PC2 + celltype.PC3 + 
                               celltype.PC4 + celltype.PC5 + celltype.PC6 + 
                               celltype.PC7 + 
                               genotyping.PC1 + genotyping.PC2 + genotyping.PC3 +
                               sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + sv7 + sv8 + 
                               sv9 + sv10 + sv11 + sv12 + sv13 + sv14 + sv15,                          data=covariates_geno_ctpcs_tech_cc_not0[!is.na(covariates_geno_ctpcs_tech_cc_not0$any_wheeze_y1),],
                             family = "binomial")

summary(cg15212210_wheeze_log)
cg15212210_wheeze_log_tidy <- tidy(cg15212210_wheeze_log, exponentiate = T, conf.int = T) 
cg15212210_wheeze_log_tidy

# clincian atopy
ggplot(covariates_geno_ctpcs_tech_cc_not0 %>% 
         select(clinician_atopy_dx_y1, cg15212210) %>%
         na.omit(), 
       aes(x=clinician_atopy_dx_y1, y=cg15212210)) +
  geom_boxplot() +
  geom_jitter(height=0) +
  theme_bw()

# atopy logistic
cg15212210_atopy_log <- glm(clinician_atopy_dx_y1 ~ cg15212210_100 +
                              sex + pss_6mos +
                              maternal_smoking_y1 + maternal_education_length +
                              celltype.PC1 + celltype.PC2 + celltype.PC3 + 
                              celltype.PC4 + celltype.PC5 + celltype.PC6 + 
                              celltype.PC7 + 
                              genotyping.PC1 + genotyping.PC2 + genotyping.PC3 +
                              sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + sv7 + sv8 + 
                              sv9 + sv10 + sv11 + sv12 + sv13 + sv14 + sv15,                          data=covariates_geno_ctpcs_tech_cc_not0[!is.na(covariates_geno_ctpcs_tech_cc_not0$clinician_atopy_dx_y1),],
                            family = "binomial")

summary(cg15212210_atopy_log)
cg15212210_atopy_log_tidy <- tidy(cg15212210_atopy_log, exponentiate = T, conf.int = T) 
cg15212210_atopy_log_tidy # 0.0822  


##############
# cg08906030 #
##############

covariates_geno_ctpcs_tech_cc_not0$cg08906030_100 <-
  covariates_geno_ctpcs_tech_cc_not0$cg08906030*100

# reported wheeze
ggplot(covariates_geno_ctpcs_tech_cc_not0 %>% 
         select(any_wheeze_y1, cg08906030) %>%
         na.omit(), 
       aes(x=any_wheeze_y1, y=cg08906030)) +
  geom_boxplot() +
  geom_jitter(height=0) +
  theme_bw()

# wheeze logistic 
cg08906030_wheeze_log <- glm(any_wheeze_y1 ~ cg08906030_100 +
                               sex + pss_6mos +
                               maternal_smoking_y1 + maternal_education_length +
                               celltype.PC1 + celltype.PC2 + celltype.PC3 + 
                               celltype.PC4 + celltype.PC5 + celltype.PC6 + 
                               celltype.PC7 + 
                               genotyping.PC1 + genotyping.PC2 + genotyping.PC3 +
                               sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + sv7 + sv8 + 
                               sv9 + sv10 + sv11 + sv12 + sv13 + sv14 + sv15,                          data=covariates_geno_ctpcs_tech_cc_not0[!is.na(covariates_geno_ctpcs_tech_cc_not0$any_wheeze_y1),],
                             family = "binomial")

summary(cg08906030_wheeze_log)
cg08906030_wheeze_log_tidy <- tidy(cg08906030_wheeze_log, exponentiate = T, conf.int = T) 
cg08906030_wheeze_log_tidy

# clinician atopy
ggplot(covariates_geno_ctpcs_tech_cc_not0 %>% 
         select(clinician_atopy_dx_y1, cg08906030) %>%
         na.omit(), 
       aes(x=as.factor(clinician_atopy_dx_y1), y=cg08906030)) +
  geom_boxplot() +
  geom_jitter(height=0) +
  theme_bw()

# atopy logistic 
cg08906030_atopy_log <- glm(clinician_atopy_dx_y1 ~ cg08906030_100 +
                              sex + pss_6mos +
                              maternal_smoking_y1 + maternal_education_length +
                              celltype.PC1 + celltype.PC2 + celltype.PC3 + 
                              celltype.PC4 + celltype.PC5 + celltype.PC6 + 
                              celltype.PC7 +
                              genotyping.PC1 + genotyping.PC2 + genotyping.PC3 +
                              sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + sv7 + sv8 + 
                              sv9 + sv10 + sv11 + sv12 + sv13 + sv14 + sv15,                          data=covariates_geno_ctpcs_tech_cc_not0[!is.na(covariates_geno_ctpcs_tech_cc_not0$clinician_atopy_dx_y1),],
                            family = "binomial")

summary(cg08906030_atopy_log)
cg08906030_atopy_log_tidy <- tidy(cg08906030_atopy_log, exponentiate = T, conf.int = T) 
cg08906030_atopy_log_tidy


####################
# cg24353392 CRHR1 #
####################

covariates_geno_ctpcs_tech_cc_not0$cg24353392_100 <-
  covariates_geno_ctpcs_tech_cc_not0$cg24353392*100

# reported wheeze
ggplot(covariates_geno_ctpcs_tech_cc_not0 %>% 
         select(any_wheeze_y1, cg24353392) %>%
         na.omit(), 
       aes(x=any_wheeze_y1, y=cg24353392)) +
  geom_boxplot() +
  geom_jitter(height=0) +
  theme_bw()

# wheeze logistic 
cg24353392_wheeze_log <- glm(any_wheeze_y1 ~ cg24353392_100 +
                               sex + pss_6mos +
                               maternal_smoking_y1 + maternal_education_length +
                               celltype.PC1 + celltype.PC2 + celltype.PC3 + 
                               celltype.PC4 + celltype.PC5 + celltype.PC6 + 
                               celltype.PC7 + 
                               genotyping.PC1 + genotyping.PC2 + genotyping.PC3 +
                               sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + sv7 + sv8 + 
                               sv9 + sv10 + sv11 + sv12 + sv13 + sv14 + sv15,                          data=covariates_geno_ctpcs_tech_cc_not0[!is.na(covariates_geno_ctpcs_tech_cc_not0$any_wheeze_y1),],
                             family = "binomial")

summary(cg24353392_wheeze_log)
cg24353392_wheeze_log_tidy <- tidy(cg24353392_wheeze_log, exponentiate = T, conf.int = T) 
cg24353392_wheeze_log_tidy # dnam pvalue = 0.117   


# clinician atopy 
ggplot(covariates_geno_ctpcs_tech_cc_not0 %>% 
         select(clinician_atopy_dx_y1, cg24353392) %>%
         na.omit(), 
       aes(x=as.factor(clinician_atopy_dx_y1), y=cg24353392)) +
  geom_boxplot() +
  geom_jitter(height=0) +
  theme_bw()

# atopy logistic 
cg24353392_atopy_log <- glm(clinician_atopy_dx_y1 ~ cg24353392_100 +
                              sex + pss_6mos +
                              maternal_smoking_y1 + maternal_education_length +
                              celltype.PC1 + celltype.PC2 + celltype.PC3 + 
                              celltype.PC4 + celltype.PC5 + celltype.PC6 + 
                              celltype.PC7 + 
                              genotyping.PC1 + genotyping.PC2 + genotyping.PC3 +
                              sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + sv7 + sv8 + 
                              sv9 + sv10 + sv11 + sv12 + sv13 + sv14 + sv15,                          data=covariates_geno_ctpcs_tech_cc_not0[!is.na(covariates_geno_ctpcs_tech_cc_not0$clinician_atopy_dx_y1),],
                            family = "binomial")

summary(cg24353392_atopy_log)
cg24353392_atopy_log_tidy <- tidy(cg24353392_atopy_log, exponentiate = T, conf.int = T) 
cg24353392_atopy_log_tidy


####################
# cg06655349 S1PR2 #
####################

covariates_geno_ctpcs_tech_cc_not0$cg06655349_100 <-
  covariates_geno_ctpcs_tech_cc_not0$cg06655349*100

# reported wheeze
ggplot(covariates_geno_ctpcs_tech_cc_not0 %>% 
         select(any_wheeze_y1, cg06655349) %>%
         na.omit(), 
       aes(x=as.factor(any_wheeze_y1), y=cg06655349)) +
  geom_boxplot() +
  geom_jitter(height=0) +
  theme_bw()

# wheeze logistic 
cg06655349_wheeze_log <- glm(any_wheeze_y1 ~ cg06655349_100 +
                               sex + pss_6mos +
                               maternal_smoking_y1 + maternal_education_length +
                               celltype.PC1 + celltype.PC2 + celltype.PC3 + 
                               celltype.PC4 + celltype.PC5 + celltype.PC6 + 
                               celltype.PC7 + 
                               genotyping.PC1 + genotyping.PC2 + genotyping.PC3 +
                               sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + sv7 + sv8 + 
                               sv9 + sv10 + sv11 + sv12 + sv13 + sv14 + sv15,                          data=covariates_geno_ctpcs_tech_cc_not0[!is.na(covariates_geno_ctpcs_tech_cc_not0$any_wheeze_y1),],
                             family = "binomial")

summary(cg06655349_wheeze_log)
cg06655349_wheeze_log_tidy <- tidy(cg06655349_wheeze_log, exponentiate = T, conf.int = T) 
cg06655349_wheeze_log_tidy # 0.122 

# clinician atopy
ggplot(covariates_geno_ctpcs_tech_cc_not0 %>% 
         select(clinician_atopy_dx_y1, cg06655349) %>%
         na.omit(), 
       aes(x=as.factor(clinician_atopy_dx_y1), y=cg06655349)) +
  geom_boxplot() +
  geom_jitter(height=0) +
  theme_bw()

# atopy logistic 
cg06655349_atopy_log <- glm(clinician_atopy_dx_y1 ~ cg06655349_100 +
                              sex + pss_6mos +
                              maternal_smoking_y1 + maternal_education_length +
                              celltype.PC1 + celltype.PC2 + celltype.PC3 + 
                              celltype.PC4 + celltype.PC5 + celltype.PC6 + 
                              celltype.PC7 +
                              genotyping.PC1 + genotyping.PC2 + genotyping.PC3 +
                              sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + sv7 + sv8 + 
                              sv9 + sv10 + sv11 + sv12 + sv13 + sv14 + sv15,                          data=covariates_geno_ctpcs_tech_cc_not0[!is.na(covariates_geno_ctpcs_tech_cc_not0$clinician_atopy_dx_y1),],
                            family = "binomial")

summary(cg06655349_atopy_log)
cg06655349_atopy_log_tidy <- tidy(cg06655349_atopy_log, exponentiate = T, conf.int = T) 
cg06655349_atopy_log_tidy
```


Examine mean methylation vs no2
```{r mean_meth}
#convert betas to df
diff_betas_geno_cc_cpr_df <- as.data.frame(diff_betas_geno_cc_cpr)

methmeans <- colMeans(diff_betas_geno_cc_cpr_df)

covariates_geno_ctpcs_tech_cc_not0 <- cbind(covariates_geno_ctpcs_tech_cc_not0, methmeans)

#colmeans
meanmeth_lm <- lm(methmeans ~ no2_y1_entire + sex + pss_6mos + 
                    maternal_smoking_y1 + maternal_education_length +
                    celltype.PC1 + celltype.PC2 + celltype.PC3 + celltype.PC4 + 
                    celltype.PC5 + celltype.PC6 + celltype.PC7 + 
                    genotyping.PC1 + genotyping.PC2 + 
                    genotyping.PC3 + sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + sv7 + 
                    sv8 + sv9 +  sv10 + sv11 + sv12 + sv13 + sv14 + sv15,
                  data=covariates_geno_ctpcs_tech_cc_not0)

#get summary
summary(meanmeth_lm) #no2 not sig

# estimate marginal effects of prenatal NO2 exposure on DNAm
methmean_no2_me <- ggpredict(meanmeth_lm, terms = "no2_y1_entire") %>%
  as.data.frame() %>% 
  rename("methmeans" = predicted,
         "no2_y1_entire" = x)

# plot
methmean_plot <- ggplot(covariates_geno_ctpcs_tech_cc_not0,
                        aes(x = no2_y1_entire, 
                            y= methmeans)) + 
  geom_line(data = methmean_no2_me, 
            aes(x=no2_y1_entire, y = methmeans),
            col="red", size=0.5, linetype="solid") +
  geom_ribbon(data = methmean_no2_me, 
              aes(x = no2_y1_entire, 
                  ymin = conf.low, ymax = conf.high), 
              alpha = .2) + 
  geom_point(alpha=0.6, col = "#254A90", size=1) + 
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text = element_text(size=9),
        panel.border = element_blank(),
        axis.line = element_line(color ="black"),
        axis.title = element_blank()) +
  scale_y_continuous(breaks = seq(-0.02, 0.06, by = 0.02), limits = c(-0.02,0.06))

ggsave(plot = methmean_plot, 
       filename = here("figures", 
                       "linear_regression", 
                       "postnatal", 
                       "2022-05-10_pn_global_dnam.png"),
       width = 4.0, height = 3.2, units = "cm")

# correlation 
cor(covariates_geno_ctpcs_tech_cc_not0$methmeans, 
    covariates_geno_ctpcs_tech_cc_not0$no2_y1_entire,
    method="pearson") # -0.06389888

# effect size
summary(meanmeth_lm)$coefficients["no2_y1_entire", "Estimate"]*range_no2 # -0.1103026
```


```{r postnatal_line_dnam}

# read in line annotation from UCSC and repeat masker 
repeats_450k   <- read.delim(file = gzfile(here("input_data", 
                                                "ucsc_rmsk_lines", 
                                                "ucsc_repeatmasker_enc_methyl450_gm12878.gz")),
                             header = T, skip = 1, sep = "\t")

# subset repeats for L1 LINE elements that are not in sex chromosomes
lines_450k  <- repeats_450k %>% 
  subset(rmsk.repClass == "LINE") %>%
  subset(rmsk.repFamily == "L1") %>%
  subset(!wgEncodeHaibMethyl450Gm12878SitesRep1.chrom %in% c("chrX", "chrY")) %>%
  subset(!is.na(wgEncodeHaibMethyl450Gm12878SitesRep1.chromStart))


# subset betas for those that overlap with line elements
diff_betas_geno_cc_cpr_lines <- diff_betas_geno_cc_cpr %>% 
  subset(rownames(.) %in% lines_450k$wgEncodeHaibMethyl450Gm12878SitesRep1.name)

# num of cpgs annotated to lines 
nrow(diff_betas_geno_cc_cpr_lines) # 7301

# get mean of line meth 
line_meth <- colMeans(diff_betas_geno_cc_cpr_lines)

# cbind line methylation to covariate data frame
covariates_geno_ctpcs_tech_cc_not0 <- cbind(covariates_geno_ctpcs_tech_cc_not0, line_meth)

#colmeans
line_meth_lm <- lm(line_meth ~ no2_y1_entire + sex + pss_6mos + 
                     maternal_smoking_y1 + maternal_education_length +
                     celltype.PC1 + celltype.PC2 + celltype.PC3 + celltype.PC4 + 
                     celltype.PC5 + celltype.PC6 + celltype.PC7 + 
                     genotyping.PC1 + genotyping.PC2 + 
                     genotyping.PC3 + sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + sv7 + 
                     sv8 + sv9 +  sv10 + sv11 + sv12 + sv13 + sv14 + sv15, 
                   data=covariates_geno_ctpcs_tech_cc_not0)

# summary of line regression
summary(line_meth_lm) 

# estimate marginal effects of prenatal NO2 exposure on DNAm
line_meth_no2_me <- ggpredict(line_meth_lm, terms = "no2_y1_entire") %>%
  as.data.frame() %>% 
  rename("line_meth" = predicted,
         "no2_y1_entire" = x)

# plot 
line_dnam_plot <- ggplot(covariates_geno_ctpcs_tech_cc_not0,
                         aes(x = no2_y1_entire, 
                             y= line_meth)) + 
  geom_line(data = line_meth_no2_me, 
            aes(x=no2_y1_entire, y = line_meth),
            col="red", size=0.5, linetype="solid") +
  geom_ribbon(data = line_meth_no2_me, 
              aes(x = no2_y1_entire, 
                  ymin = conf.low, ymax = conf.high), 
              alpha = .2) + 
  geom_point(alpha=0.6, col = "#254A90", size=1) + 
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text = element_text(size=9),
        panel.border = element_blank(),
        axis.line = element_line(color ="black"),
        axis.title = element_blank()) +
  scale_y_continuous(breaks = seq(-0.02, 0.06, by = 0.02), limits = c(-0.02,0.06))

ggsave(plot = line_dnam_plot, 
       filename = here("figures", 
                       "linear_regression", 
                       "postnatal",
                       "2022-05-10_postnatal_line_dnam.png"),
       width = 4.0, height = 3.2, units = "cm")

# correlation 
cor(covariates_geno_ctpcs_tech_cc_not0$line_meth, 
    covariates_geno_ctpcs_tech_cc_not0$no2_y1_entire,
    method="pearson") # -0.1191814


# effect size
summary(line_meth_lm)$coefficients["no2_y1_entire", "Estimate"]*range_no2 # -0.1103026
```


Try re-running limma with birth month/ interaction between birth month and air pollution.
```{r interaction_terms_to_assess_birthmonth}
#want to use anova to compare models usign anova
#anova only accepts models from lm
#use lm to compare how birth month affects cpgs above 10^-3 sig 

#You should be able to ask for confidence intervals for the slope coefficients for each month.  #even in a tabular display, you may see that smoothly varying pattern we were discussing.
#Then, you could use those to plot a sort of heres how the slope varies by month picture.Sort #of like forest plots for meta analysis results, if that makes sense.

#Also, before we decide it doesnt matter, the individual slopes might look fairly similar, but the appropriate overall test would be to check the anova(fit_with_interaction) and check the p-value on the interaction term.


################################################
library(broom)

# "cg07472943" "cg19263548" "cg26989646" "cg04823720" "cg15212210" "cg08906030" "cg24353392" "cg06655349"
# cg18792689      cg25530908                    

###################
# cg07472943 SHC2 #
###################

# add dnam to covariates for linear regression
covariates_geno_ctpcs_tech_cc_not0$cg07472943 <- 
  diff_betas_geno_cc_cpr[rownames(diff_betas_geno_cc_cpr)=="cg07472943", ]

# linear regression
cg07472943_lm <- lm(cg07472943 ~  no2_y1_entire + sex + pss_6mos + 
                      maternal_smoking_y1 + maternal_education_length +
                      celltype.PC1 + celltype.PC2 + celltype.PC3 + celltype.PC4 + 
                      celltype.PC5 + celltype.PC6 + celltype.PC7 +
                      genotyping.PC1 + genotyping.PC2 + 
                      genotyping.PC3 + sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + sv7 + 
                      sv8 + sv9 +  sv10 + sv11 + sv12 + sv13 + sv14 + sv15 +
                      birth_month + no2_y1_entire*birth_month,
                    data=covariates_geno_ctpcs_tech_cc_not0)

# anova to assess significance of interaction term
anova(cg07472943_lm)

# plot 
cg07472943_bm <- tidy(cg07472943_lm, conf.int = 0.95) %>% filter(term %>% str_detect(":")) %>% 
  mutate(term = factor(term, levels=c("no2_y1_entire:birth_monthfebruary",
                                      "no2_y1_entire:birth_monthmarch",
                                      "no2_y1_entire:birth_monthapril",
                                      "no2_y1_entire:birth_monthmay",
                                      "no2_y1_entire:birth_monthjune",
                                      "no2_y1_entire:birth_monthjuly",
                                      "no2_y1_entire:birth_monthaugust",
                                      "no2_y1_entire:birth_monthseptember",
                                      "no2_y1_entire:birth_monthoctober",
                                      "no2_y1_entire:birth_monthnovember",
                                      "no2_y1_entire:birth_monthdecember"))) %>%
  ggplot(aes(y = estimate*100, x = as.factor(term))) + 
  geom_point() +
  geom_errorbar(aes(ymin = conf.low*100 , ymax = conf.high*100)) +
  scale_x_discrete(labels=c("February","March", "April", "May",
                            "June","July", "August", "September",
                            "October", "November","December")) +
  theme_bw() +
  ylim(-3,6) + 
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle=90),
        axis.text = element_text(size=9, hjust=0.9),
        axis.title = element_blank()) 

ggsave(plot = cg07472943_bm,
       filename =  here("figures", 
                        "linear_regression",
                        "postnatal",
                        "2022-05-06_pn_cg0747294_SHC2_birthmonth.png"),
       width = 4.8, height = 4, units = "cm")


##############
# cg19263548 #
##############

# add dnam to covariates for linear regression
covariates_geno_ctpcs_tech_cc_not0$cg19263548 <- 
  diff_betas_geno_cc_cpr[rownames(diff_betas_geno_cc_cpr)=="cg19263548", ]

# linear regression
cg19263548_lm <- lm(cg19263548 ~  no2_y1_entire + sex + pss_6mos + 
                      maternal_smoking_y1 + maternal_education_length +
                      celltype.PC1 + celltype.PC2 + celltype.PC3 + celltype.PC4 + 
                      celltype.PC5 + celltype.PC6 + celltype.PC7 + 
                      genotyping.PC1 + genotyping.PC2 + 
                      genotyping.PC3 + sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + sv7 + 
                      sv8 + sv9 +  sv10 + sv11 + sv12 + sv13 + sv14 + sv15 +
                      birth_month + no2_y1_entire*birth_month,
                    data=covariates_geno_ctpcs_tech_cc_not0)

# anova to assess significance of interaction term
anova(cg19263548_lm)

# plot 
cg19263548_bm <- tidy(cg19263548_lm, conf.int = 0.95) %>% filter(term %>% str_detect(":")) %>% 
  mutate(term = factor(term, levels=c("no2_y1_entire:birth_monthfebruary",
                                      "no2_y1_entire:birth_monthmarch",
                                      "no2_y1_entire:birth_monthapril",
                                      "no2_y1_entire:birth_monthmay",
                                      "no2_y1_entire:birth_monthjune",
                                      "no2_y1_entire:birth_monthjuly",
                                      "no2_y1_entire:birth_monthaugust",
                                      "no2_y1_entire:birth_monthseptember",
                                      "no2_y1_entire:birth_monthoctober",
                                      "no2_y1_entire:birth_monthnovember",
                                      "no2_y1_entire:birth_monthdecember"))) %>%
  ggplot(aes(y = estimate*100, x = as.factor(term))) + 
  geom_point() +
  geom_errorbar(aes(ymin = conf.low*100 , ymax = conf.high*100)) +
  scale_x_discrete(labels=c("February","March", "April", "May",
                            "June","July", "August", "September",
                            "October", "November","December")) +
  theme_bw() +
  ylim(-3,6) + 
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle=90),
        axis.text = element_text(size=9, hjust=0.9),
        axis.title = element_blank()) 

ggsave(plot = cg19263548_bm,
       filename =  here("figures", 
                        "linear_regression",
                        "postnatal",
                        "2022-05-06_pn_cg19263548_birthmonth.png"),
       width = 4.8, height = 4, units = "cm")


####################
# cg26989646 FOSL2 #
####################

# add dnam to covariates for linear regression
covariates_geno_ctpcs_tech_cc_not0$cg26989646 <- 
  diff_betas_geno_cc_cpr[rownames(diff_betas_geno_cc_cpr)=="cg26989646", ]

# linear regression
cg26989646_lm <- lm(cg26989646 ~  no2_y1_entire + sex + pss_6mos + 
                      maternal_smoking_y1 + maternal_education_length +
                      celltype.PC1 + celltype.PC2 + celltype.PC3 + celltype.PC4 + 
                      celltype.PC5 + celltype.PC6 + celltype.PC7 + 
                      genotyping.PC1 + genotyping.PC2 + 
                      genotyping.PC3 + sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + sv7 + 
                      sv8 + sv9 +  sv10 + sv11 + sv12 + sv13 + sv14 + sv15 +
                      birth_month + no2_y1_entire*birth_month,
                    data=covariates_geno_ctpcs_tech_cc_not0)

# anova to assess significance of interaction term
anova(cg26989646_lm)

# plot 
cg26989646_bm <- tidy(cg26989646_lm, conf.int = 0.95) %>% filter(term %>% str_detect(":")) %>% 
  mutate(term = factor(term, levels=c("no2_y1_entire:birth_monthfebruary",
                                      "no2_y1_entire:birth_monthmarch",
                                      "no2_y1_entire:birth_monthapril",
                                      "no2_y1_entire:birth_monthmay",
                                      "no2_y1_entire:birth_monthjune",
                                      "no2_y1_entire:birth_monthjuly",
                                      "no2_y1_entire:birth_monthaugust",
                                      "no2_y1_entire:birth_monthseptember",
                                      "no2_y1_entire:birth_monthoctober",
                                      "no2_y1_entire:birth_monthnovember",
                                      "no2_y1_entire:birth_monthdecember"))) %>%
  ggplot(aes(y = estimate*100, x = as.factor(term))) + 
  geom_point() +
  geom_errorbar(aes(ymin = conf.low*100 , ymax = conf.high*100)) +
  scale_x_discrete(labels=c("February","March", "April", "May",
                            "June","July", "August", "September",
                            "October", "November","December")) +
  theme_bw() +
  ylim(-3,6) + 
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle=90),
        axis.text = element_text(size=9, hjust=0.9),
        axis.title = element_blank()) 

ggsave(plot = cg26989646_bm,
       filename =  here("figures", 
                        "linear_regression",
                        "postnatal",
                        "2022-05-06_pn_cg26989646_FOSL2_birthmonth.png"),
       width = 4.8, height = 4, units = "cm")


#######################
# cg04823720 SLC25A13 #
#######################

# add dnam to covariates for linear regression
covariates_geno_ctpcs_tech_cc_not0$cg04823720 <- 
  diff_betas_geno_cc_cpr[rownames(diff_betas_geno_cc_cpr)=="cg04823720", ]

# linear regression
cg04823720_lm <- lm(cg04823720 ~  no2_y1_entire + sex + pss_6mos + 
                      maternal_smoking_y1 + maternal_education_length +
                      celltype.PC1 + celltype.PC2 + celltype.PC3 + celltype.PC4 + 
                      celltype.PC5 + celltype.PC6 + celltype.PC7 + 
                      genotyping.PC1 + genotyping.PC2 + 
                      genotyping.PC3 + sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + sv7 + 
                      sv8 + sv9 +  sv10 + sv11 + sv12 + sv13 + sv14 + sv15 +
                      birth_month + no2_y1_entire*birth_month,
                    data=covariates_geno_ctpcs_tech_cc_not0)

# anova to assess significance of interaction term
anova(cg04823720_lm)

# plot 
cg04823720_bm <- tidy(cg04823720_lm, conf.int = 0.95) %>% filter(term %>% str_detect(":")) %>% 
  mutate(term = factor(term, levels=c("no2_y1_entire:birth_monthfebruary",
                                      "no2_y1_entire:birth_monthmarch",
                                      "no2_y1_entire:birth_monthapril",
                                      "no2_y1_entire:birth_monthmay",
                                      "no2_y1_entire:birth_monthjune",
                                      "no2_y1_entire:birth_monthjuly",
                                      "no2_y1_entire:birth_monthaugust",
                                      "no2_y1_entire:birth_monthseptember",
                                      "no2_y1_entire:birth_monthoctober",
                                      "no2_y1_entire:birth_monthnovember",
                                      "no2_y1_entire:birth_monthdecember"))) %>%
  ggplot(aes(y = estimate*100, x = as.factor(term))) + 
  geom_point() +
  geom_errorbar(aes(ymin = conf.low*100 , ymax = conf.high*100)) +
  scale_x_discrete(labels=c("February","March", "April", "May",
                            "June","July", "August", "September",
                            "October", "November","December")) +
  ylim(-3,6) + 
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle=90),
        axis.text = element_text(size=9, hjust=0.9),
        axis.title = element_blank()) 

ggsave(plot = cg04823720_bm,
       filename =  here("figures", 
                        "linear_regression",
                        "postnatal",
                        "2022-05-06_pn_cg04823720_SLC25A13_birthmonth.png"),
       width = 4.8, height = 4, units = "cm")


#####################
# cg15212210 C2CD2L #
#####################

# add dnam to covariates for linear regression
covariates_geno_ctpcs_tech_cc_not0$cg15212210 <- 
  diff_betas_geno_cc_cpr[rownames(diff_betas_geno_cc_cpr)=="cg15212210", ]

# linear regression
cg15212210_lm <- lm(cg15212210 ~  no2_y1_entire + sex + pss_6mos + 
                      maternal_smoking_y1 + maternal_education_length +
                      celltype.PC1 + celltype.PC2 + celltype.PC3 + celltype.PC4 + 
                      celltype.PC5 + celltype.PC6 + celltype.PC7 +
                      genotyping.PC1 + genotyping.PC2 + 
                      genotyping.PC3 + sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + sv7 + 
                      sv8 + sv9 +  sv10 + sv11 + sv12 + sv13 + sv14 + sv15 +
                      birth_month + no2_y1_entire*birth_month,
                    data=covariates_geno_ctpcs_tech_cc_not0)

# anova to assess significance of interaction term
anova(cg15212210_lm)

# plot 
cg15212210_bm <- tidy(cg15212210_lm, conf.int = 0.95) %>% filter(term %>% str_detect(":")) %>% 
  mutate(term = factor(term, levels=c("no2_y1_entire:birth_monthfebruary",
                                      "no2_y1_entire:birth_monthmarch",
                                      "no2_y1_entire:birth_monthapril",
                                      "no2_y1_entire:birth_monthmay",
                                      "no2_y1_entire:birth_monthjune",
                                      "no2_y1_entire:birth_monthjuly",
                                      "no2_y1_entire:birth_monthaugust",
                                      "no2_y1_entire:birth_monthseptember",
                                      "no2_y1_entire:birth_monthoctober",
                                      "no2_y1_entire:birth_monthnovember",
                                      "no2_y1_entire:birth_monthdecember"))) %>%
  ggplot(aes(y = estimate*100, x = as.factor(term))) + 
  geom_point() +
  geom_errorbar(aes(ymin = conf.low*100 , ymax = conf.high*100)) +
  scale_x_discrete(labels=c("February","March", "April", "May",
                            "June","July", "August", "September",
                            "October", "November","December")) +
  ylim(-3,6) + 
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle=90),
        axis.text = element_text(size=9, hjust=0.9),
        axis.title = element_blank()) 

ggsave(plot = cg15212210_bm,
       filename =  here("figures", 
                        "linear_regression",
                        "postnatal",
                        "2022-05-06_pn_cg15212210_C2CD2L_birthmonth.png"),
       width = 4.8, height = 4, units = "cm")


##############
# cg08906030 #
##############

# add dnam to covariates for linear regression
covariates_geno_ctpcs_tech_cc_not0$cg08906030 <- 
  diff_betas_geno_cc_cpr[rownames(diff_betas_geno_cc_cpr)=="cg08906030", ]

# linear regression
cg08906030_lm <- lm(cg08906030 ~  no2_y1_entire + sex + pss_6mos + 
                      maternal_smoking_y1 + maternal_education_length +
                      celltype.PC1 + celltype.PC2 + celltype.PC3 + celltype.PC4 + 
                      celltype.PC5 + celltype.PC6 + celltype.PC7 + 
                      genotyping.PC1 + genotyping.PC2 + 
                      genotyping.PC3 + sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + sv7 + 
                      sv8 + sv9 +  sv10 + sv11 + sv12 + sv13 + sv14 + sv15 +
                      birth_month + no2_y1_entire*birth_month,
                    data=covariates_geno_ctpcs_tech_cc_not0)

# anova to assess significance of interaction term
anova(cg08906030_lm)

# plot 
cg08906030_bm <- tidy(cg08906030_lm, conf.int = 0.95) %>% filter(term %>% str_detect(":")) %>% 
  mutate(term = factor(term, levels=c("no2_y1_entire:birth_monthfebruary",
                                      "no2_y1_entire:birth_monthmarch",
                                      "no2_y1_entire:birth_monthapril",
                                      "no2_y1_entire:birth_monthmay",
                                      "no2_y1_entire:birth_monthjune",
                                      "no2_y1_entire:birth_monthjuly",
                                      "no2_y1_entire:birth_monthaugust",
                                      "no2_y1_entire:birth_monthseptember",
                                      "no2_y1_entire:birth_monthoctober",
                                      "no2_y1_entire:birth_monthnovember",
                                      "no2_y1_entire:birth_monthdecember"))) %>%
  ggplot(aes(y = estimate*100, x = as.factor(term))) + 
  geom_point() +
  geom_errorbar(aes(ymin = conf.low*100 , ymax = conf.high*100)) +
  scale_x_discrete(labels=c("February","March", "April", "May",
                            "June","July", "August", "September",
                            "October", "November","December")) +
  ylim(-3,6) + 
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle=90),
        axis.text = element_text(size=9, hjust=0.9),
        axis.title = element_blank()) 

ggsave(plot = cg08906030_bm,
       filename =  here("figures", 
                        "linear_regression",
                        "postnatal",
                        "2022-05-06_pn_cg08906030_birthmonth.png"),
       width = 4.8, height = 4, units = "cm")


####################
# cg24353392 CRHR1 #
####################

# add dnam to covariates for linear regression
covariates_geno_ctpcs_tech_cc_not0$cg24353392 <- 
  diff_betas_geno_cc_cpr[rownames(diff_betas_geno_cc_cpr)=="cg24353392", ]

# linear regression
cg24353392_lm <- lm(cg24353392 ~  no2_y1_entire + sex + pss_6mos + 
                      maternal_smoking_y1 + maternal_education_length +
                      celltype.PC1 + celltype.PC2 + celltype.PC3 + celltype.PC4 + 
                      celltype.PC5 + celltype.PC6 + celltype.PC7 + genotyping.PC1 + genotyping.PC2 + 
                      genotyping.PC3 + sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + sv7 + 
                      sv8 + sv9 +  sv10 + sv11 + sv12 + sv13 + sv14 + sv15 +
                      birth_month + no2_y1_entire*birth_month,
                    data=covariates_geno_ctpcs_tech_cc_not0)

# anova to assess significance of interaction term
anova(cg24353392_lm)

# plot 
cg24353392_bm <- tidy(cg24353392_lm, conf.int = 0.95) %>% filter(term %>% str_detect(":")) %>% 
  mutate(term = factor(term, levels=c("no2_y1_entire:birth_monthfebruary",
                                      "no2_y1_entire:birth_monthmarch",
                                      "no2_y1_entire:birth_monthapril",
                                      "no2_y1_entire:birth_monthmay",
                                      "no2_y1_entire:birth_monthjune",
                                      "no2_y1_entire:birth_monthjuly",
                                      "no2_y1_entire:birth_monthaugust",
                                      "no2_y1_entire:birth_monthseptember",
                                      "no2_y1_entire:birth_monthoctober",
                                      "no2_y1_entire:birth_monthnovember",
                                      "no2_y1_entire:birth_monthdecember"))) %>%
  ggplot(aes(y = estimate*100, x = as.factor(term))) + 
  geom_point() +
  geom_errorbar(aes(ymin = conf.low*100 , ymax = conf.high*100)) +
  scale_x_discrete(labels=c("February","March", "April", "May",
                            "June","July", "August", "September",
                            "October", "November","December")) +
  ylim(-3,6) + 
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle=90),
        axis.text = element_text(size=9, hjust=0.9),
        axis.title = element_blank()) 

ggsave(plot = cg24353392_bm,
       filename =  here("figures", 
                        "linear_regression",
                        "postnatal",
                        "2022-05-06_pn_cg24353392_CRHR1_birthmonth.png"),
       width = 4.8, height = 4, units = "cm")


####################
# cg06655349 S1PR2 #
####################

# add dnam to covariates for linear regression
covariates_geno_ctpcs_tech_cc_not0$cg06655349 <- 
  diff_betas_geno_cc_cpr[rownames(diff_betas_geno_cc_cpr)=="cg06655349", ]

# linear regression
cg06655349_lm <- lm(cg06655349 ~  no2_y1_entire + sex + pss_6mos + 
                      maternal_smoking_y1 + maternal_education_length +
                      celltype.PC1 + celltype.PC2 + celltype.PC3 + celltype.PC4 + 
                      celltype.PC5 + celltype.PC6 + celltype.PC7 + 
                      genotyping.PC1 + genotyping.PC2 + 
                      genotyping.PC3 + sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + sv7 + 
                      sv8 + sv9 +  sv10 + sv11 + sv12 + sv13 + sv14 + sv15 +
                      birth_month + no2_y1_entire*birth_month,
                    data=covariates_geno_ctpcs_tech_cc_not0)

# anova to assess significance of interaction term
anova(cg06655349_lm)

# plot 
cg06655349_bm <- tidy(cg06655349_lm, conf.int = 0.95) %>% filter(term %>% str_detect(":")) %>% 
  mutate(term = factor(term, levels=c("no2_y1_entire:birth_monthfebruary",
                                      "no2_y1_entire:birth_monthmarch",
                                      "no2_y1_entire:birth_monthapril",
                                      "no2_y1_entire:birth_monthmay",
                                      "no2_y1_entire:birth_monthjune",
                                      "no2_y1_entire:birth_monthjuly",
                                      "no2_y1_entire:birth_monthaugust",
                                      "no2_y1_entire:birth_monthseptember",
                                      "no2_y1_entire:birth_monthoctober",
                                      "no2_y1_entire:birth_monthnovember",
                                      "no2_y1_entire:birth_monthdecember"))) %>%
  ggplot(aes(y = estimate*100, x = as.factor(term))) + 
  geom_point() +
  geom_errorbar(aes(ymin = conf.low*100 , ymax = conf.high*100)) +
  scale_x_discrete(labels=c("February","March", "April", "May",
                            "June","July", "August", "September",
                            "October", "November","December")) +
  ylim(-3,6) + 
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle=90),
        axis.text = element_text(size=9, hjust=0.9),
        axis.title = element_blank()) 

ggsave(plot = cg06655349_bm,
       filename =  here("figures", 
                        "linear_regression",
                        "postnatal",
                        "2022-05-06_pn_cg06655349_S1PR2_birthmonth.png"),
       width = 4.8, height = 4, units = "cm")


####################
# cg18792689 FNDC7 #
####################

# add dnam to covariates for linear regression
covariates_geno_ctpcs_tech_cc_not0$cg18792689 <- 
  diff_betas_geno_cc_cpr[rownames(diff_betas_geno_cc_cpr)=="cg18792689", ]

# linear regression
cg18792689_lm <- lm(cg18792689 ~  no2_y1_entire + sex + pss_6mos + 
                      maternal_smoking_y1 + maternal_education_length +
                      celltype.PC1 + celltype.PC2 + celltype.PC3 + celltype.PC4 + 
                      celltype.PC5 + celltype.PC6 + celltype.PC7 + 
                      genotyping.PC1 + genotyping.PC2 + 
                      genotyping.PC3 + sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + sv7 + 
                      sv8 + sv9 +  sv10 + sv11 + sv12 + sv13 + sv14 + sv15 +
                      birth_month + no2_y1_entire*birth_month,
                    data=covariates_geno_ctpcs_tech_cc_not0)

# anova to assess significance of interaction term
anova(cg18792689_lm)

# plot 
cg18792689_bm <- tidy(cg18792689_lm, conf.int = 0.95) %>% filter(term %>% str_detect(":")) %>% 
  mutate(term = factor(term, levels=c("no2_y1_entire:birth_monthfebruary",
                                      "no2_y1_entire:birth_monthmarch",
                                      "no2_y1_entire:birth_monthapril",
                                      "no2_y1_entire:birth_monthmay",
                                      "no2_y1_entire:birth_monthjune",
                                      "no2_y1_entire:birth_monthjuly",
                                      "no2_y1_entire:birth_monthaugust",
                                      "no2_y1_entire:birth_monthseptember",
                                      "no2_y1_entire:birth_monthoctober",
                                      "no2_y1_entire:birth_monthnovember",
                                      "no2_y1_entire:birth_monthdecember"))) %>%
  ggplot(aes(y = estimate*100, x = as.factor(term))) + 
  geom_point() +
  geom_errorbar(aes(ymin = conf.low*100 , ymax = conf.high*100)) +
  scale_x_discrete(labels=c("February","March", "April", "May",
                            "June","July", "August", "September",
                            "October", "November","December")) +
  ylim(-3,6) + 
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle=90),
        axis.text = element_text(size=9, hjust=0.9),
        axis.title = element_blank()) 

ggsave(plot = cg18792689_bm,
       filename =  here("figures", 
                        "linear_regression",
                        "postnatal",
                        "2022-05-06_pn_cg18792689_FNDC7_birthmonth.png"),
       width = 4.8, height = 4, units = "cm")


##############
# cg25530908 #
##############

# add dnam to covariates for linear regression
covariates_geno_ctpcs_tech_cc_not0$cg25530908 <- 
  diff_betas_geno_cc_cpr[rownames(diff_betas_geno_cc_cpr)=="cg25530908", ]

# linear regression
cg25530908_lm <- lm(cg25530908 ~  no2_y1_entire + sex + pss_6mos + 
                      maternal_smoking_y1 + maternal_education_length +
                      celltype.PC1 + celltype.PC2 + celltype.PC3 + celltype.PC4 + 
                      celltype.PC5 + celltype.PC6 + celltype.PC7 + 
                      genotyping.PC1 + genotyping.PC2 + 
                      genotyping.PC3 + sv1 + sv2 + sv3 + sv4 + sv5 + sv6 + sv7 + 
                      sv8 + sv9 +  sv10 + sv11 + sv12 + sv13 + sv14 + sv15 +
                      birth_month + no2_y1_entire*birth_month,
                    data=covariates_geno_ctpcs_tech_cc_not0)

# anova to assess significance of interaction term
anova(cg25530908_lm)

# plot 
cg25530908_bm <- tidy(cg25530908_lm, conf.int = 0.95) %>% filter(term %>% str_detect(":")) %>% 
  mutate(term = factor(term, levels=c("no2_y1_entire:birth_monthfebruary",
                                      "no2_y1_entire:birth_monthmarch",
                                      "no2_y1_entire:birth_monthapril",
                                      "no2_y1_entire:birth_monthmay",
                                      "no2_y1_entire:birth_monthjune",
                                      "no2_y1_entire:birth_monthjuly",
                                      "no2_y1_entire:birth_monthaugust",
                                      "no2_y1_entire:birth_monthseptember",
                                      "no2_y1_entire:birth_monthoctober",
                                      "no2_y1_entire:birth_monthnovember",
                                      "no2_y1_entire:birth_monthdecember"))) %>%
  ggplot(aes(y = estimate*100, x = as.factor(term))) + 
  geom_point() +
  geom_errorbar(aes(ymin = conf.low*100 , ymax = conf.high*100)) +
  scale_x_discrete(labels=c("February","March", "April", "May",
                            "June","July", "August", "September",
                            "October", "November","December")) +
  ylim(-3,6) + 
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle=90),
        axis.text = element_text(size=9, hjust=0.9),
        axis.title = element_blank()) 

ggsave(plot = cg25530908_bm,
       filename =  here("figures", 
                        "linear_regression",
                        "postnatal",
                        "2022-05-06_pn_cg25530908_birthmonth.png"),
       width = 4.8, height = 4, units = "cm")

```




Boxplots of NO2, PM2.5
```{r airpollution_boxplots}

# prenatal no2
ggplot(covariates_geno_ctpcs_tech_cc, aes(y=no2_y1_entire, x=studycentre, fill=studycentre)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(height=0, width=0.25, alpha=0.8) +
  theme_bw() +
  scale_fill_manual(values=c("#254A90", "#508FC2", "#92C5EB", "white")) +
  labs(x="Study Centre", y=bquote("Year one" ~NO[2]~ "(ppb)")) +
  theme(panel.grid = element_blank(),
        legend.position = "none",
        axis.text = element_text(size=14),
        axis.title = element_text(size=16))

# year one no2
ggplot(covariates_geno_ctpc_tech_cc_y1_sub, aes(y=no2_y1_entire, x=studycentre,fill=studycentre)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(height=0, width=0.25, alpha=0.8) +
  scale_fill_manual(values=c("#254A90", "#508FC2", "#92C5EB", "white")) +
  labs(x="Study Centre", y=bquote("Year one" ~NO[2]~ "(ppb)")) +
  theme_bw() +
  theme(panel.grid = element_blank(),
        legend.position = "none",
        axis.text = element_text(size=14),
        axis.title = element_text(size=16))

# Pm2.5 B
ggplot(covariates_geno_ctpc_tech, aes(y=PM25DALbYY_01, x=studycentre, fill=studycentre)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(height=0, width=0.25, alpha=0.8) +
  scale_fill_manual(values=c("#254A90", "#508FC2", "#92C5EB", "white")) +
  labs(x="Study Centre", y=bquote(~PM[2.5]~ "(ppb)")) +
  theme_bw() +
  theme(panel.grid = element_blank(),
        legend.position = "none",
        axis.text = element_text(size=14),
        axis.title = element_text(size=16))
```



"Table 1" of postnatal model
```{r postnatal_table1}
library(table1)

# table 1
table1(~no2_y1_entire + sex + pss_6mos + 
         maternal_smoking_y1 + maternal_education_length + maternal_ethnicity,
       data = covariates_geno_ctpcs_tech_cc_not0)

# prenatal no2 quartiles
quantile(covariates_geno_ctpcs_tech_cc_not0$no2_y1_entire)
```
