---
title: "Year one cell type PC generation"
author: "SL"
date: "January 5, 2021"
output: html_document
---

*IMPORTANT*: This code is for cell type correction before linear models for EWAS. The other option is to include cell type proportions in EWAS linear models. As CHILD is a relatively small cohort (and we lose many participants to missing data), correcting for cell type before linear models can improve power to detect DNAm changes. When cohorts are larger (and better powered), it is more correct to include cell types (or cell type PCs) in final linear model. 


```{r setup, include=FALSE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r libraries}
library(tidyverse)
library(minfi)
library(here)
library(pbapply)
```

Load preprocessed CHILD data.  
```{r load_CHILD_data, message=FALSE, warning=FALSE}
load(here("output_data", "preprocessed_data", "2021-11_19_CHILD_preprocessed_betas_pdata_annotation.Rdata"))
```

Load deconvolution data.
```{r load_CHILD_data, message=FALSE, warning=FALSE}
load("R:/Jones/People/Samantha Lee/Projects/CHILD/CHILD_air_pollution/output_data/deconvolution/2021-01-07_CBMC_PBMC_deconvolution.Rdata")
```


Subset out age one and cord blood pData. Then subset for samples that have data available at both time points. 
```{r sub_pdata}
cb_pdata <- subset(pdata_nodups, Tissue == "C")
dim(cb_pdata) # 144  17

#subset out age one pdata
y1_pdata <- subset(pdata_nodups, Tissue == "P")
dim(y1_pdata) #145  17

#year one data has one individual that is missing birth data
#remove this individual
y1_pdata_sub <- y1_pdata[y1_pdata$Sample_Label %in% cb_pdata$Sample_Label, ]
dim(y1_pdata_sub) # 144  17
```


## Principle component (PC) generation 

Remove duplicates from cord blood deconvolution data then rename rows with pdata sample label.
```{r remove_dups_cb_cellcounts}
#convert deconvolution data to dataframe
child_fscbc_ecc2_cb_df <- as.data.frame(child_fscbc_ecc2_cb$counts)
#check size
dim(child_fscbc_ecc2_cb_df) # 153 6

#make list of samples to remove from beta and pData
dups_rm <-c("9298768102_R06C01", "9341679111_R05C02", "9298768023_R03C02",
            "9341679076_R06C02", "9297962089_R06C02", "9298768023_R02C02",
            "9341679097_R02C02", "9341679114_R01C02", "9298768023_R06C01")

#remove replicates from cell type estimates                      
child_fscbc_ecc2_cb_df_nodups <-
  child_fscbc_ecc2_cb_df[!rownames(child_fscbc_ecc2_cb_df) %in% dups_rm, ]

#check that 9 samples were removed
dim(child_fscbc_ecc2_cb_df_nodups) # 144   6


#check if cord blood cell counts are in the same order as pdata
identical(rownames(child_fscbc_ecc2_cb_df_nodups), rownames(cb_pdata)) #true
#rename rows of cord blood cell counts to sample label
rownames(child_fscbc_ecc2_cb_df_nodups) <- cb_pdata$Sample_Label


#rename cord blood cell counts columns
colnames(child_fscbc_ecc2_cb_df_nodups) <- paste("cb", colnames(child_fscbc_ecc2_cb_df_nodups), sep=".")
```


Convert age one cell counts to data frame and rename rows to pdata sample label.
```{r ageone_cellcounts}
#convert to dataframe
child_fscbc_ecc2_y1_df <- as.data.frame(child_fscbc_ecc2_y1)
#check size
dim(child_fscbc_ecc2_y1_df) # 145 5

#subset for samples that have data at both time points
child_fscbc_ecc2_y1_df_sub <- 
  child_fscbc_ecc2_y1_df[rownames(child_fscbc_ecc2_y1_df) %in% rownames(y1_pdata_sub), ]
#check size
dim(child_fscbc_ecc2_y1_df_sub) # 144 5


#check if year one cell counts are in the same order as pdata
identical(rownames(child_fscbc_ecc2_y1_df_sub), rownames(y1_pdata_sub)) #true
#rename rows of cord blood cell counts to sample label
rownames(child_fscbc_ecc2_y1_df_sub) <- y1_pdata_sub$Sample_Label


#rename year one cell counts columns
colnames(child_fscbc_ecc2_y1_df_sub) <- paste("y1", 
                                              substr(colnames(child_fscbc_ecc2_y1_df_sub), 8, 13), 
                                              sep=".")
```


Make combined cell counts data frame. Perform CLR on CBMCs and PBMC before combining and doing PCA.
```{r combined_cellcounts_pca}
#check that cord blood and year one cell counts are in the same order
identical(rownames(child_fscbc_ecc2_cb_df_nodups), rownames(child_fscbc_ecc2_y1_df_sub)) #true

#check how many negatives in cord blood
sum(child_fscbc_ecc2_cb_df_nodups <= 0) #0

#clr
cb_celltypes_clr <- clr(as.matrix(child_fscbc_ecc2_cb_df_nodups))

#check for NAs or inf
#these will occur if zeroes or negatives existed in cell tyoe estimates
sum(is.na(cb_celltypes_clr)) #0
sum(is.infinite(cb_celltypes_clr)) #0

#check how many negatives
sum(child_fscbc_ecc2_y1_df <= 0) #0

#clr
y1_celltypes_clr <- clr(as.matrix(child_fscbc_ecc2_y1_df_sub))

#check for NAs or inf
#these will occur if zeroes or negatives existed in cell tyoe estimates
sum(is.na(y1_celltypes_clr)) #0
sum(is.infinite(y1_celltypes_clr)) #0

#combine cell counts (ccc_pca)
ccc <- cbind(cb_celltypes_clr, y1_celltypes_clr)
dim(ccc) # 144 11
head(ccc)
```



Principle component analysis of combined cell counts.
```{r pca}
#pca
ccc_pca <- prcomp(ccc, scale. = TRUE)

#scree plot
factoextra::fviz_eig(ccc_pca, ncp=15) # take first 9 PCs

#convert to dataframe
ccc_pcs <- as.data.frame(ccc_pca$x)

#examine grouping of pcs
GGally::ggpairs(ccc_pcs, columns=1:11, progress=FALSE) 
```



Save PCs
```{r save_PCs}
save(ccc_pcs,
     cb_allprobes, cb_deconvolutionprobes,
     y1_allprobes, y1_deconvolutionprobes,
     child_fscbc_ecc2_cb_df_nodups,
     child_fscbc_ecc2_y1_df_sub,
     file = here("output_data", "deconvolution",
                 "2021-02-04_CHILD_CBMC_PBMC_PCs.Rdata"))
```
 







